DROP PROCEDURE BANINST1.P_CALC_ALL_JOBS_AMTS;

CREATE OR REPLACE PROCEDURE BANINST1.p_calc_all_jobs_amts
   (par_nbrjobs_factor         IN number,
    par_nbrjobs_pays           IN number,
    par_ntrsala_amount         IN number,
    par_ntrsalb_ind            IN varchar2,
    par_nbrjobs_sal_step       IN number,
    par_nbrjobs_appt_pct       IN number,
    par_old_appt_pct           IN number,
    par_internal_ft_pt_ind     IN varchar2,
    par_nbrjobs_hrs_pay    IN OUT number,
    par_nbrjobs_hrs_day    IN OUT number,
    par_ann_salary         IN OUT number,
    par_assgn_salary       IN OUT number,
    par_per_pay_salary     IN OUT number,
    par_reg_rate           IN OUT number,
    par_per_pay_defer      IN OUT number)
IS
--
-- FILE NAME..: nopjclc.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_CALC_ALL_JOBS_AMT
-- PRODUCT....: POSNCTL
-- USAGE......: Calculate salary/rate amount fields.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure calculates all salary/rate amount fields. It is used in
-- Electronic Approvals PAF Submit and Mass Apply Default Procedure.
--
-- DESCRIPTION END
--
BEGIN
  IF TO_NUMBER(par_nbrjobs_sal_step) <> 0 AND
               par_nbrjobs_sal_step IS NOT NULL THEN
   IF par_ntrsalb_ind = 'S' THEN
      par_ann_salary     := ROUND(par_ntrsala_amount *
                                 (par_nbrjobs_appt_pct/100),2);
      par_reg_rate       := f_calc_rate_from_annl(
                               par_ann_salary,
                               par_nbrjobs_factor,
                               par_nbrjobs_hrs_pay);
      par_assgn_salary   := f_calc_assign(
                               par_reg_rate,
                               par_nbrjobs_hrs_pay);
      par_per_pay_salary := f_calc_ppsal(
                               par_nbrjobs_pays,
                               par_nbrjobs_factor,
                               par_assgn_salary,
                               par_ann_salary);
      par_per_pay_defer  := f_calc_defer( par_assgn_salary,
                                          par_per_pay_salary);
   ELSIF par_ntrsalb_ind = 'H' THEN
      IF NVL( par_internal_ft_pt_ind,'P') = 'F' THEN
              par_nbrjobs_hrs_pay :=
                  ROUND(par_nbrjobs_appt_pct * (par_nbrjobs_hrs_pay /
                        par_old_appt_pct),2);
               par_nbrjobs_hrs_day :=
                  ROUND(par_nbrjobs_appt_pct * (par_nbrjobs_hrs_day /
                        par_old_appt_pct),2);
      END IF;
      par_reg_rate       := par_ntrsala_amount;
      par_assgn_salary   := f_calc_assign(
                               par_reg_rate,
                               par_nbrjobs_hrs_pay);
      par_ann_salary     := f_calc_annual(
                               par_assgn_salary,
                               par_nbrjobs_factor);
      par_per_pay_salary := f_calc_ppsal(
                               par_nbrjobs_pays,
                               par_nbrjobs_factor,
                               par_assgn_salary,
                               par_ann_salary);
      par_per_pay_defer  := f_calc_defer( par_assgn_salary,
                                          par_per_pay_salary);
   END IF;
  END IF;
END;
/


DROP PUBLIC SYNONYM P_CALC_ALL_JOBS_AMTS;

CREATE PUBLIC SYNONYM P_CALC_ALL_JOBS_AMTS FOR BANINST1.P_CALC_ALL_JOBS_AMTS;


GRANT EXECUTE ON BANINST1.P_CALC_ALL_JOBS_AMTS TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_ALL_JOBS_AMTS TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_ALL_JOBS_AMTS TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_CALC_ALL_JOBS_AMTS TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_CALC_ALL_JOBS_AMTS TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_ALL_JOBS_AMTS TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_CALC_ALL_JOBS_AMTS TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_CALC_ALL_JOBS_AMTS TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_CALC_ALL_JOBS_AMTS TO GENERAL;

GRANT EXECUTE ON BANINST1.P_CALC_ALL_JOBS_AMTS TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_ALL_JOBS_AMTS TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_ALL_JOBS_AMTS TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_CALC_ALL_JOBS_AMTS TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_ALL_JOBS_AMTS TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_ALL_JOBS_AMTS TO SATURN;

GRANT EXECUTE ON BANINST1.P_CALC_ALL_JOBS_AMTS TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_ALL_JOBS_AMTS TO WTAILOR;
DROP PROCEDURE BANINST1.P_CALC_ENCD_NUM;

CREATE OR REPLACE PROCEDURE BANINST1.p_calc_encd_num
  (p_coas_code        IN NBRPLBD.NBRPLBD_COAS_CODE%TYPE,
   p_acci_code        IN NBRPLBD.NBRPLBD_ACCI_CODE%TYPE,
   p_fund_code        IN NBRPLBD.NBRPLBD_FUND_CODE%TYPE,
   p_orgn_code        IN NBRPLBD.NBRPLBD_ORGN_CODE%TYPE,
   p_acct_code        IN NBRPLBD.NBRPLBD_ACCT_CODE%TYPE,
   p_prog_code        IN NBRPLBD.NBRPLBD_PROG_CODE%TYPE,
   p_actv_code        IN NBRPLBD.NBRPLBD_ACTV_CODE%TYPE,
   p_locn_code        IN NBRPLBD.NBRPLBD_LOCN_CODE%TYPE,
   p_eff_date         IN NBRJLBD.NBRJLBD_EFFECTIVE_DATE%TYPE,
   p_fy_jobs          IN NBBFISC.NBBFISC_CODE%TYPE,
   p_encd_num     IN OUT NBRJLBD.NBRJLBD_ENCD_NUM%TYPE,
   p_encd_seq_num IN OUT NBRJLBD.NBRJLBD_ENCD_SEQ_NUM%TYPE,
   p_msg             OUT VARCHAR2)
IS
--
-- FILE NAME..: nopenum.sql
-- RELEASE....: 7.0
-- OBJECT NAME: P_CALC_ENCD_NUM
-- PRODUCT....: POSNCTL
-- USAGE......: Procedure returns the encumbrance number and sequence for a job
--              labor distribution record.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure returns the encumbrance number and sequence for a job labor
-- distribution record.
--
-- DESCRIPTION END
--
--
  -- Constant
  CONST_ENCD_FUNCTION   VARCHAR2(6) := 'HRENCD';
  CONST_INVALID_SEQ_NUM INTEGER     := -1;

  -- Local variables
  exception_required_field EXCEPTION;
  exception_nbbfisc        EXCEPTION;
  lv_year                  VARCHAR2(4) := NULL;
  lv_fisc_year             VARCHAR2(2) := NULL;
  lv_encd_num              NBRJLBD.NBRJLBD_ENCD_NUM%TYPE := NULL;
  lv_encd_seq_num          NBRJLBD.NBRJLBD_ENCD_SEQ_NUM%TYPE := NULL;
  lv_function              SOBSEQN.SOBSEQN_FUNCTION%TYPE := NULL;
  lv_next_doc_num          VARCHAR2(8) := NULL;

  -- Local procedures/functions
  -- Select the fiscal year of the given effective date and coas.
  FUNCTION f_fisc_year_not_found(p_fisc_year IN OUT VARCHAR2)
  RETURN BOOLEAN IS
      -- Local variables
    lv_not_found BOOLEAN := TRUE;

    CURSOR get_fy_year IS
      SELECT NBBFISC_CODE
      FROM   NBBFISC
      WHERE  TO_DATE(TO_CHAR(NBBFISC_BEGIN_DATE,'DD-MON-YYYY'),'DD-MON-YYYY')
               <= TO_DATE(TO_CHAR(p_eff_date,'DD-MON-YYYY'),'DD-MON-YYYY')
        AND  TO_DATE(TO_CHAR(NBBFISC_END_DATE,'DD-MON-YYYY'),'DD-MON-YYYY')
               >= TO_DATE(TO_CHAR(p_eff_date,'DD-MON-YYYY'),'DD-MON-YYYY')
        AND  NVL(NBBFISC_COAS_CODE,'@') = NVL(p_coas_code,'@');
  BEGIN
    OPEN get_fy_year;
    FETCH get_fy_year INTO p_fisc_year;
    lv_not_found := get_fy_year%NOTFOUND;
    CLOSE get_fy_year;

    RETURN lv_not_found;
  END f_fisc_year_not_found;

  -- Select encd_num and encd_seq_num of the given CFOAPAL and fiscal year.
  -- Example: (encd_num, encd_seq_num) = (PR040002,508)
  FUNCTION f_encd_num_not_found(p_fisc_year VARCHAR2)
  RETURN BOOLEAN IS
    -- Local variables
    lv_not_found BOOLEAN := TRUE;

    CURSOR sel_encd_doc IS
      SELECT NBRJLBD_ENCD_NUM,
             NBRJLBD_ENCD_SEQ_NUM
      FROM   NBRJLBD
      WHERE  NVL(NBRJLBD_COAS_CODE,'@') = NVL(p_coas_code,'@')
      AND    NVL(NBRJLBD_FUND_CODE,'@') = NVL(p_fund_code,'@')
      AND    NVL(NBRJLBD_ORGN_CODE,'@') = NVL(p_orgn_code,'@')
      AND    NVL(NBRJLBD_ACCT_CODE,'@') = NVL(p_acct_code,'@')
      AND    NVL(NBRJLBD_PROG_CODE,'@') = NVL(p_prog_code,'@')
      AND    NVL(NBRJLBD_ACTV_CODE,'@') = NVL(p_actv_code,'@')
      AND    NVL(NBRJLBD_LOCN_CODE,'@') = NVL(p_locn_code,'@')
      AND    NBRJLBD_ENCD_NUM     IS NOT NULL
      AND    NBRJLBD_ENCD_SEQ_NUM IS NOT NULL
      AND    SUBSTR(NBRJLBD_ENCD_NUM,3,2) = p_fisc_year
      AND    ROWNUM = 1;
  BEGIN
    OPEN   sel_encd_doc;
    FETCH  sel_encd_doc
    INTO   lv_encd_num, lv_encd_seq_num;
    lv_not_found := sel_encd_doc%NOTFOUND;
    CLOSE  sel_encd_doc;

    RETURN lv_not_found;
  END f_encd_num_not_found;

  -- Check for a given sobseqn function existence
  FUNCTION f_function_not_found(p_function SOBSEQN.SOBSEQN_FUNCTION%TYPE)
  RETURN BOOLEAN IS
    -- Local variables
    lv_not_found BOOLEAN := TRUE;
    lv_value     VARCHAR2(1) := NULL;

    CURSOR get_function IS
      SELECT 'X'
      FROM   SOBSEQN
      WHERE  SOBSEQN_FUNCTION = p_function;
  BEGIN
    OPEN get_function;
    FETCH get_function INTO lv_value;
    lv_not_found := get_function%NOTFOUND;
    CLOSE get_function;

    RETURN lv_not_found;
  END f_function_not_found;

  -- Get the current max pair encd num and encd seq num in nbrjlbd.
  FUNCTION f_get_max_pair_found(p_max_pair IN OUT NUMBER) RETURN BOOLEAN IS
    -- Get max pair of encd number and encd sequence number
    -- Example: given max (encd_num, encd_seq_num) = (PR040002,508)
    --          result = 00020508
    CURSOR get_max_encd_seq_num IS
      SELECT NVL(MAX(TO_NUMBER(SUBSTR(NBRJLBD_ENCD_NUM,5,6)||
                               LTRIM(LPAD(TO_CHAR(NBRJLBD_ENCD_SEQ_NUM),4,'0'))
                     )
                 )
             , CONST_INVALID_SEQ_NUM)
      FROM   NBRJLBD
      WHERE  NBRJLBD_ENCD_NUM     IS NOT NULL
        AND  NBRJLBD_ENCD_SEQ_NUM IS NOT NULL
        AND  SUBSTR(NBRJLBD_ENCD_NUM,3,2) = lv_fisc_year;
  BEGIN
    OPEN get_max_encd_seq_num;
    FETCH get_max_encd_seq_num INTO p_max_pair;
    CLOSE get_max_encd_seq_num;

    IF p_max_pair = CONST_INVALID_SEQ_NUM THEN
      RETURN FALSE;
    ELSE
      RETURN TRUE;
    END IF;
  END f_get_max_pair_found;

  -- Create a new function for the given fiscal year.
  PROCEDURE p_start_new_function(p_function IN SOBSEQN.SOBSEQN_FUNCTION%TYPE) IS
    -- Local variables
    lv_max_pair NUMBER := NULL;
  BEGIN
    INSERT INTO SOBSEQN(SOBSEQN_FUNCTION,
                        SOBSEQN_SEQNO_PREFIX,
                        SOBSEQN_MAXSEQNO,
                        SOBSEQN_ACTIVITY_DATE)
                 VALUES(p_function, NULL, 10001, SYSDATE);

    IF SQL%NOTFOUND THEN
      RAISE_APPLICATION_ERROR(-20100,
        G$_NLS.Get('x','SQL','*ERROR* Could not insert a new record into '||
        'SOBSEQN table.'));
    END IF;

    -- Check if a max pair nbrjlbd exists
    IF f_get_max_pair_found(lv_max_pair) THEN
      -- Initialize the function with the existing max pair nbrjlbd + 1.
      UPDATE SOBSEQN
      SET    SOBSEQN_MAXSEQNO = lv_max_pair + 1,
             SOBSEQN_ACTIVITY_DATE = SYSDATE
      WHERE  SOBSEQN_FUNCTION = lv_function;

      IF SQL%NOTFOUND THEN
        RAISE_APPLICATION_ERROR(-20100,
          G$_NLS.Get('x','SQL','*ERROR* Could not update SOBSEQN table for '||
          'initializing function '||CONST_ENCD_FUNCTION||'.'));
      END IF;
    END IF;
  END p_start_new_function;

  -- Generate next doc number
  PROCEDURE p_gen_next_doc_num(p_function IN SOBSEQN.SOBSEQN_FUNCTION%TYPE) IS

    -- Local variable
    lv_not_found    BOOLEAN := FALSE;
    lv_rec_count    INTEGER := 0;
    lv_pair_str     VARCHAR2(8) := NULL;

    -- Get next sequence number
    CURSOR get_next_seq_num(c_function SOBSEQN.SOBSEQN_FUNCTION%TYPE) IS
      SELECT SOBSEQN_MAXSEQNO
      FROM   SOBSEQN
      WHERE  SOBSEQN_FUNCTION = c_function;

  BEGIN
    IF f_function_not_found(p_function) THEN
      -- Function does not exists in sobseqn,
      -- start a new function with maxseqno value at 10001 (doc_num||seq_num).
      p_start_new_function(p_function);
    ELSE
      -- Function exists, update max sequence number will lock the row.
      UPDATE SOBSEQN
      SET    SOBSEQN_MAXSEQNO = SOBSEQN_MAXSEQNO + 1,
             SOBSEQN_ACTIVITY_DATE = SYSDATE
      WHERE  SOBSEQN_FUNCTION = p_function;

      IF SQL%NOTFOUND THEN
        RAISE_APPLICATION_ERROR(-20100,
          G$_NLS.Get('x','SQL','*ERROR* Could not update SOBSEQN table for '||
          'generating next document number.'));
      END IF;
    END IF;

    -- Get the next sequence number.
    OPEN get_next_seq_num(p_function);
    FETCH get_next_seq_num INTO lv_next_doc_num;
    lv_not_found := get_next_seq_num%NOTFOUND;
    CLOSE get_next_seq_num;

    IF lv_not_found THEN
      RAISE_APPLICATION_ERROR(-20100,
        G$_NLS.Get('x','SQL','*ERROR* Could not fetch new document from '||
        'SOBSEQN.'));
    END IF;

    -- The valid encd seqn num value set is [1, 9999]
    IF MOD(lv_next_doc_num, 10000) = 0 THEN
      -- the encd seqn num is 0000, gen the next number.
      p_gen_next_doc_num(p_function);
    END IF;

    -- Build the encd num and encd seq num from the maxseqno
    lv_pair_str := LPAD(TO_CHAR(lv_next_doc_num), 8, '0');
    lv_encd_num := 'PR'||lv_fisc_year||SUBSTR(lv_pair_str, 1, 4);
    lv_encd_seq_num := TO_NUMBER(RTRIM(LTRIM(SUBSTR(lv_pair_str, 5, 4))));
  END p_gen_next_doc_num;
/******************************************************************************/
BEGIN
  -- Reset the output formal parameters
  p_encd_num := NULL;
  p_encd_seq_num := NULL;
  p_msg := '';

  -- Get the fiscal year
  lv_year := p_fy_jobs;
  IF lv_year IS NULL THEN
    IF p_eff_date IS NULL THEN
      -- Both fiscal year and effective date are null.
      RAISE exception_required_field;
    ELSIF f_fisc_year_not_found(lv_year) THEN
      -- Fiscal year is null and Year/COA is not found for effective date..
      RAISE exception_nbbfisc;
    END IF;
  END IF;

  -- Fiscal year is given OR determined from the given effective date.
  lv_fisc_year := SUBSTR(lv_year, 3, 2);
  lv_function  := CONST_ENCD_FUNCTION||lv_fisc_year;

  -- Find the encd num and end seq num of the given CFOAPAL and fiscal year
  IF f_encd_num_not_found(lv_fisc_year) THEN
    -- encd_num does not exist for the given CFOAPAL and fiscal year,
    -- generate new encd_num and encd_seq_num.
    p_gen_next_doc_num(lv_function);
  END IF;

  -- Copy the encd num and encd seq num to the output formal parameters.
  p_encd_num := lv_encd_num;
  p_encd_seq_num := lv_encd_seq_num;
EXCEPTION
  WHEN exception_required_field THEN
    p_msg := G$_NLS.Get('x','SQL','*ERROR* Cannot assign encumbrance number; '||
             'Year/Effective date is required.');
  WHEN exception_nbbfisc THEN
    p_msg := G$_NLS.Get('x','SQL','*ERROR* Cannot assign encumbrance number; '||
             'Year/COA not found for effective date.');
END p_calc_encd_num;
/


DROP PUBLIC SYNONYM P_CALC_ENCD_NUM;

CREATE PUBLIC SYNONYM P_CALC_ENCD_NUM FOR BANINST1.P_CALC_ENCD_NUM;


GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO GENERAL;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO PAYROLL;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO SATURN;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_ENCD_NUM TO WTAILOR;
DROP PROCEDURE BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC;

CREATE OR REPLACE PROCEDURE BANINST1.p_calc_nbrjobs_ann_salary_pc
   (par_nbrjobs_factor         IN number,
    par_nbrjobs_ann_salary     IN number,
    par_nbrjobs_pays           IN number,
    par_ntrsalb_ind            IN varchar2,
    par_nbrjobs_reg_rate   IN OUT number,
    par_nbrjobs_hrs_pay    IN OUT number,
    par_assgn_salary       IN OUT number,
    par_per_pay_salary     IN OUT number,
    par_per_pay_defer         OUT number)
AS
--
-- FILE NAME..: nopannl.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_CALC_NBRJOBS_ANN_SALARY_PC
-- PRODUCT....: POSNCTL
-- USAGE......: Performs defaults/recalculation as annual salary changes.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure performs defaults/recalculation as the result of a change
-- to an assignment's annual salary.
--
-- DESCRIPTION END
--
BEGIN
   IF par_ntrsalb_ind = 'H' THEN
      IF par_nbrjobs_reg_rate IS NULL THEN
         par_nbrjobs_reg_rate       := f_calc_rate_from_annl(
                                          par_nbrjobs_ann_salary,
                                          par_nbrjobs_factor,
                                          par_nbrjobs_hrs_pay);
         par_assgn_salary   := f_calc_assign(
                                  par_nbrjobs_reg_rate,
                                  par_nbrjobs_hrs_pay);
         par_per_pay_salary := f_calc_ppsal(
                                  par_nbrjobs_pays,
                                  par_nbrjobs_factor,
                                  par_assgn_salary,
                                  par_nbrjobs_ann_salary);
         par_per_pay_defer  := f_calc_defer( par_assgn_salary,
                                             par_per_pay_salary);
      ELSE
         par_assgn_salary   := f_calc_assign_from_annl(
                                  par_nbrjobs_ann_salary,
                                  par_nbrjobs_factor);
         par_per_pay_salary := f_calc_ppsal(
                                  par_nbrjobs_pays,
                                  par_nbrjobs_factor,
                                  par_assgn_salary,
                                  par_nbrjobs_ann_salary);
         par_per_pay_defer   := f_calc_defer( par_assgn_salary,
                                             par_per_pay_salary);
         par_nbrjobs_hrs_pay := f_calc_hrs_pay( par_assgn_salary,
                                               par_nbrjobs_reg_rate);
      END IF;
   ELSIF par_ntrsalb_ind = 'S' THEN
      par_nbrjobs_reg_rate   := f_calc_rate_from_annl(
                                  par_nbrjobs_ann_salary,
                                  par_nbrjobs_factor,
                                  par_nbrjobs_hrs_pay);
      par_assgn_salary   := f_calc_assign(
                               par_nbrjobs_reg_rate,
                               par_nbrjobs_hrs_pay);
      par_per_pay_salary := f_calc_ppsal(
                               par_nbrjobs_pays,
                               par_nbrjobs_factor,
                               par_assgn_salary,
                               par_nbrjobs_ann_salary);
      par_per_pay_defer  := f_calc_defer( par_assgn_salary,
                                          par_per_pay_salary);
   END IF;
END;
/


DROP PUBLIC SYNONYM P_CALC_NBRJOBS_ANN_SALARY_PC;

CREATE PUBLIC SYNONYM P_CALC_NBRJOBS_ANN_SALARY_PC FOR BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC;


GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC TO GENERAL;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC TO SATURN;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ANN_SALARY_PC TO WTAILOR;
DROP PROCEDURE BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC;

CREATE OR REPLACE PROCEDURE BANINST1.p_calc_nbrjobs_appt_pct_pc
   (par_nbrjobs_sal_step           IN number,
    par_nbrjobs_appt_pct           IN number,
    par_nbrjobs_pays               IN number,
    par_nbrjobs_factor             IN number,
    par_ntrsala_amount             IN number,
    par_ntrsalb_salb_ind           IN varchar2,
    par_old_appt_pct               IN number,
    par_internal_ft_pt_ind         IN varchar2,
    par_nbrjobs_hrs_pay        IN OUT number,
    par_nbrjobs_hrs_day        IN OUT number,
    par_nbrjobs_reg_rate       IN OUT number,
    par_nbrjobs_ann_salary     IN OUT number,
    par_nbrjobs_assgn_salary   IN OUT number,
    par_nbrjobs_per_pay_salary IN OUT number,
    par_per_pay_defer          IN OUT number)
IS
--
-- FILE NAME..: nopapct.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_CALC_NBRJOBS_APPT_PCT_PC
-- PRODUCT....: POSNCTL
-- USAGE......: Performs defaults/recalculation as appointment percent changes.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure performs defaults/recalculation as the result of a change to
-- an assignment's appointment percent.
--
-- DESCRIPTION END
--
   var_hrs_pay     nbrjobs.nbrjobs_hrs_pay%TYPE := par_nbrjobs_hrs_pay;
   var_internal_ft_pt_ind varchar2(1) := par_internal_ft_pt_ind;
   var_factor      nbrjobs.nbrjobs_factor%TYPE := par_nbrjobs_factor;
   var_pays        nbrjobs.nbrjobs_pays%TYPE := par_nbrjobs_pays;
   var_ntrsala_amt ntrsala.ntrsala_amount%TYPE := par_ntrsala_amount;
   var_ntrsalb_ind ntrsalb.ntrsalb_ind%TYPE := par_ntrsalb_salb_ind;
   var_sal_step    nbrjobs.nbrjobs_sal_step%TYPE := par_nbrjobs_sal_step;
   var_nbrjobs_appt_pct nbrjobs.nbrjobs_appt_pct%TYPE := par_nbrjobs_appt_pct;
   var_old_appt_pct nbrjobs.nbrjobs_appt_pct%TYPE := par_old_appt_pct;
--
BEGIN
   IF par_nbrjobs_sal_step = 0 OR
      par_nbrjobs_sal_step IS NULL THEN
      IF par_nbrjobs_reg_rate IS NOT NULL THEN
         IF par_ntrsalb_salb_ind = 'S' THEN
            par_nbrjobs_reg_rate       := f_calc_rate_from_appt_pct(
                                             par_nbrjobs_reg_rate,
                                             par_nbrjobs_appt_pct,
                                             par_old_appt_pct);
         ELSE
            IF NVL( par_internal_ft_pt_ind,'P') = 'F' THEN
               par_nbrjobs_hrs_pay :=
                  ROUND(par_nbrjobs_appt_pct * (par_nbrjobs_hrs_pay /
                        par_old_appt_pct),2);
               par_nbrjobs_hrs_day :=
                  ROUND(par_nbrjobs_appt_pct * (par_nbrjobs_hrs_day /
                        par_old_appt_pct),2);
            END IF;
         END IF;
         par_nbrjobs_assgn_salary   := f_calc_assign(
                                          par_nbrjobs_reg_rate,
                                          par_nbrjobs_hrs_pay);
         par_nbrjobs_ann_salary     := f_calc_hourly_sal(
                                          par_nbrjobs_hrs_pay,
                                          par_nbrjobs_factor,
                                          par_nbrjobs_reg_rate);
         par_nbrjobs_per_pay_salary := f_calc_ppsal(
                                          par_nbrjobs_pays,
                                          par_nbrjobs_factor,
                                          par_nbrjobs_assgn_salary,
                                          par_nbrjobs_ann_salary);
        par_per_pay_defer  := f_calc_defer( par_nbrjobs_assgn_salary,
                                            par_nbrjobs_per_pay_salary);

      END IF;
   ELSE   -- Step <> 0
      p_calc_all_jobs_amts(
         var_factor,
         var_pays,
         var_ntrsala_amt,
         var_ntrsalb_ind,
         var_sal_step,
         var_nbrjobs_appt_pct,
         var_old_appt_pct,
         var_internal_ft_pt_ind,
         par_nbrjobs_hrs_pay,
         par_nbrjobs_hrs_day,
         par_nbrjobs_ann_salary,
         par_nbrjobs_assgn_salary,
         par_nbrjobs_per_pay_salary,
         par_nbrjobs_reg_rate,
         par_per_pay_defer);
   END IF;
END;
/


DROP PUBLIC SYNONYM P_CALC_NBRJOBS_APPT_PCT_PC;

CREATE PUBLIC SYNONYM P_CALC_NBRJOBS_APPT_PCT_PC FOR BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC;


GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC TO GENERAL;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC TO SATURN;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_APPT_PCT_PC TO WTAILOR;
DROP PROCEDURE BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC;

CREATE OR REPLACE PROCEDURE BANINST1.p_calc_nbrjobs_assgn_salary_pc
   (par_ntrsalb_ind                IN varchar2,
    par_nbrjobs_assgn_salary       IN number,
    par_nbrjobs_factor             IN number,
    par_nbrjobs_pays               IN number,
    par_nbrjobs_sal_step           IN number,
    par_nbrjobs_reg_rate       IN OUT number,
    par_nbrjobs_hrs_pay        IN OUT number,
    par_nbrjobs_ann_salary     IN OUT number,
    par_nbrjobs_per_pay_salary IN OUT number,
    par_per_pay_defer          IN OUT number)
IS
--
-- FILE NAME..: nopasgn.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_CALC_NBRJOBS_ASSGN_SALARY_PC
-- PRODUCT....: POSNCTL
-- USAGE......: Performs defaults/recalculation as assignment salary changes.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure performs defaults/recalculation as the result of a change to
-- an assignment's assignment salary.
--
-- DESCRIPTION END
--
BEGIN
   IF par_nbrjobs_sal_step = 0 THEN
      IF par_ntrsalb_ind = 'H' THEN
         IF par_nbrjobs_reg_rate IS NULL THEN
            par_nbrjobs_reg_rate := f_calc_rate( par_nbrjobs_assgn_salary,
                                                 par_nbrjobs_hrs_pay);
         ELSE
            par_nbrjobs_hrs_pay  := f_calc_hrs_pay( par_nbrjobs_assgn_salary,
                                                    par_nbrjobs_reg_rate);
         END IF;
      ELSIF par_ntrsalb_ind = 'S' THEN
            par_nbrjobs_reg_rate := f_calc_rate( par_nbrjobs_assgn_salary,
                                                 par_nbrjobs_hrs_pay);
      END IF;
      par_nbrjobs_ann_salary     := f_calc_annual(
                                       par_nbrjobs_assgn_salary,
                                       par_nbrjobs_factor);
      par_nbrjobs_per_pay_salary := f_calc_ppsal(
                                       par_nbrjobs_pays,
                                       par_nbrjobs_factor,
                                       par_nbrjobs_assgn_salary,
                                       par_nbrjobs_ann_salary);
      par_per_pay_defer  := f_calc_defer( par_nbrjobs_assgn_salary,
                                          par_nbrjobs_per_pay_salary);
   END IF;
END;
/


DROP PUBLIC SYNONYM P_CALC_NBRJOBS_ASSGN_SALARY_PC;

CREATE PUBLIC SYNONYM P_CALC_NBRJOBS_ASSGN_SALARY_PC FOR BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC;


GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC TO GENERAL;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC TO SATURN;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ASSGN_SALARY_PC TO WTAILOR;
DROP PROCEDURE BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR;

CREATE OR REPLACE PROCEDURE BANINST1.p_calc_nbrjobs_encumbrance_hr
       (par_pidm                   IN  number,
        par_posn                   IN  varchar2,
        par_suff                   IN  varchar2,
        par_effective_date         IN  date,
        par_encumbrance_hrs        IN  number,
        par_total_encumbrance_hrs  IN  number,
        par_fisc_bdate             IN  date,
        par_fisc_edate             IN  date,
        par_old_enc_hrs         IN OUT number,
        par_encum_hrs_change    IN OUT number,
        par_eff_date_change     IN OUT date,
        msg                        OUT varchar2,
        msg_type                   OUT varchar2)
IS
--
-- FILE NAME..: nopbenc.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_CALC_NBRJOBS_ENCUBRANCE_HR
-- PRODUCT....: POSNCTL
-- USAGE......: Balance the NBRJOBS_ENCUMBRANCE_HRS field for a job.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure balances the NBRJOBS_ENCUMBRANC_HR field for a job within
-- the current fiscal year when a change is made to the jobs encumbrance hours.
--
-- DESCRIPTION END
--
   ENCUM_HRS               NUMBER(6,2) := 0;
   TOTAL_ENCUM_HRS         NUMBER(6,2) := 0;
   EFF_DATE                DATE:= '';
   HRS_INCREASE            VARCHAR(1):= 'N';
--
   CURSOR GET_ENCUM_HRS IS
   SELECT NVL(nbrjobs_encumbrance_hrs,0), NBRJOBS_EFFECTIVE_DATE
     FROM NBRJOBS
    WHERE NBRJOBS_PIDM = par_pidm
      AND NBRJOBS_POSN = par_posn
      AND NBRJOBS_SUFF = par_suff
      AND NBRJOBS_EFFECTIVE_DATE BETWEEN par_fisc_bdate AND par_fisc_edate
    ORDER BY NBRJOBS_EFFECTIVE_DATE DESC;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
   par_eff_date_change := '';
   par_encum_hrs_change := '';
--
dbms_output.put_line('par_effective_date' || to_char(par_effective_date) );
dbms_output.put_line('par_fisc_bdate' || to_char(par_fisc_bdate) );
dbms_output.put_line('par_fisc_edate' || to_char(par_fisc_edate) );
   IF par_encumbrance_hrs <> par_old_enc_hrs OR
      (par_old_enc_hrs IS NULL AND par_encumbrance_hrs IS NOT NULL) THEN
       par_old_enc_hrs := par_encumbrance_hrs;
      IF par_effective_date NOT BETWEEN par_fisc_bdate AND par_fisc_edate THEN
         RETURN;
      END  IF;
      OPEN GET_ENCUM_HRS;
      FETCH GET_ENCUM_HRS INTO ENCUM_HRS, EFF_DATE;
      IF get_encum_hrs%NOTFOUND THEN
         encum_hrs := 0;
         eff_date := NULL;
      END IF;
dbms_output.put_line('after get_encum_hrs');
      IF par_effective_date >= EFF_DATE THEN
         IF (par_effective_date = EFF_DATE AND par_encumbrance_hrs
            > ENCUM_HRS) OR (par_effective_date <> EFF_DATE) THEN
            HRS_INCREASE := 'Y';
         END IF;
         IF par_effective_date = EFF_DATE THEN
            FETCH GET_ENCUM_HRS INTO ENCUM_HRS, EFF_DATE;
         END IF;
         IF GET_ENCUM_HRS%NOTFOUND THEN
dbms_output.put_line('after get_encum_hrs%NOTFOUND');
            IF par_encumbrance_hrs <> par_total_encumbrance_hrs THEN
               msg :=  G$_NLS.Get('NOPBENC-0005', 'SQL','*ERROR* Encumbrance hours for fiscal year will not balance.')
                      ;
               msg_type := 'E';
               par_old_enc_hrs := par_old_enc_hrs;
               RETURN;
            END IF;
         ELSE
            WHILE GET_ENCUM_HRS%FOUND LOOP
               IF par_eff_date_change IS NULL AND ((ENCUM_HRS > 0 AND
                  HRS_INCREASE = 'Y') OR HRS_INCREASE = 'N') THEN
                  par_eff_date_change := EFF_DATE;
               ELSE
                  TOTAL_ENCUM_HRS := TOTAL_ENCUM_HRS + ENCUM_HRS;
               END IF;
               FETCH GET_ENCUM_HRS INTO ENCUM_HRS, EFF_DATE;
            END LOOP;
            par_encum_hrs_change := par_total_encumbrance_hrs -
                      (TOTAL_ENCUM_HRS + par_encumbrance_hrs);
         END IF;
      END IF;
      CLOSE GET_ENCUM_HRS;
      IF par_encum_hrs_change < 0 OR par_encum_hrs_change IS NULL THEN
         msg :=  G$_NLS.Get('NOPBENC-0006', 'SQL','*WARNING* Encumbrance hrs for fiscal year will not be balanced w/total.')
                ;
         msg_type := 'W';
         par_encum_hrs_change := '';
         par_eff_date_change := '';
      END IF;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_CALC_NBRJOBS_ENCUMBRANCE_HR;

CREATE PUBLIC SYNONYM P_CALC_NBRJOBS_ENCUMBRANCE_HR FOR BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR;


GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR TO GENERAL;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR TO SATURN;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_ENCUMBRANCE_HR TO WTAILOR;
DROP PROCEDURE BANINST1.P_CALC_NBRJOBS_FACTOR_PC;

CREATE OR REPLACE PROCEDURE BANINST1.p_calc_nbrjobs_factor_pc
   (par_ntrsalb_ind                IN varchar2,
    par_nbrjobs_factor             IN number,
    par_nbrjobs_pays               IN number,
    par_nbrjobs_hrs_pay            IN number,
    par_nbrjobs_ann_salary     IN OUT number,
    par_nbrjobs_reg_rate       IN OUT number,
    par_nbrjobs_assgn_salary   IN OUT number,
    par_nbrjobs_per_pay_salary IN OUT number,
    par_per_pay_defer             OUT number)
IS
--
-- FILE NAME..: nopdfac.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_CALC_NBRJOBS_FACTOR_PC
-- PRODUCT....: POSNCTL
-- USAGE......: Perform defaults/recalculation for different salary types.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure performs defaults/recalculation for different types of
-- salaries as the result of a change to an assignment's factor.
--
-- DESCRIPTION END
--
BEGIN
   IF par_ntrsalb_ind = 'S' THEN
      par_nbrjobs_assgn_salary := f_calc_assign_from_annl(
                                     par_nbrjobs_ann_salary,
                                     par_nbrjobs_factor);
      par_nbrjobs_reg_rate     := f_calc_rate( par_nbrjobs_assgn_salary,
                                               par_nbrjobs_hrs_pay);
      par_per_pay_defer := f_calc_defer( par_nbrjobs_assgn_salary,
                                         par_nbrjobs_per_pay_salary);
   ELSIF par_ntrsalb_ind = 'H' THEN
      par_nbrjobs_ann_salary     := f_calc_hourly_sal(
                                       par_nbrjobs_hrs_pay,
                                       par_nbrjobs_factor,
                                       par_nbrjobs_reg_rate);
      par_nbrjobs_per_pay_salary := f_calc_ppsal(
                                       par_nbrjobs_pays,
                                       par_nbrjobs_factor,
                                       par_nbrjobs_assgn_salary,
                                       par_nbrjobs_ann_salary);
      par_per_pay_defer  := f_calc_defer( par_nbrjobs_assgn_salary,
                                          par_nbrjobs_per_pay_salary);
   END IF;
END;
/


DROP PUBLIC SYNONYM P_CALC_NBRJOBS_FACTOR_PC;

CREATE PUBLIC SYNONYM P_CALC_NBRJOBS_FACTOR_PC FOR BANINST1.P_CALC_NBRJOBS_FACTOR_PC;


GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_FACTOR_PC TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_FACTOR_PC TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_FACTOR_PC TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_FACTOR_PC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_FACTOR_PC TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_FACTOR_PC TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_FACTOR_PC TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_FACTOR_PC TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_FACTOR_PC TO GENERAL;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_FACTOR_PC TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_FACTOR_PC TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_FACTOR_PC TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_FACTOR_PC TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_FACTOR_PC TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_FACTOR_PC TO SATURN;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_FACTOR_PC TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_FACTOR_PC TO WTAILOR;
DROP PROCEDURE BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC;

CREATE OR REPLACE PROCEDURE BANINST1.p_calc_nbrjobs_hrs_pay_pc
   (par_nbrjobs_hrs_pay            IN number,
    par_nbrjobs_factor             IN number,
    par_nbrjobs_pays               IN number,
    par_ntrsalb_ind                IN varchar2,
    par_nbrjobs_reg_rate       IN OUT number,
    par_nbrjobs_ann_salary     IN OUT number,
    par_nbrjobs_assgn_salary   IN OUT number,
    par_per_pay_salary         IN OUT number,
    par_per_pay_defer          IN OUT number)
IS
--
-- FILE NAME..: nophrpp.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_CALC_NBRJOBS_HRS_PAY_PC
-- PRODUCT....: POSNCTL
-- USAGE......: Electronic Approvals PAF Submit and Mass Apply Default Procedure
--
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- Electronic Approvals PAF Submit and Mass Apply Default Procedure
-- Set salary fields based on change to nbrjobs_hrs_pay.
--
-- DESCRIPTION END
--
BEGIN
   IF par_ntrsalb_ind = 'H' THEN
      par_nbrjobs_ann_salary     := f_calc_hourly_sal(
                                       par_nbrjobs_hrs_pay,
                                       par_nbrjobs_factor,
                                       par_nbrjobs_reg_rate);
      par_nbrjobs_assgn_salary   := f_calc_assign(
                                       par_nbrjobs_reg_rate,
                                       par_nbrjobs_hrs_pay);
      par_per_pay_salary         := f_calc_ppsal(
                                       par_nbrjobs_pays,
                                       par_nbrjobs_factor,
                                       par_nbrjobs_assgn_salary,
                                       par_nbrjobs_ann_salary);
      par_per_pay_defer          := f_calc_defer( par_nbrjobs_assgn_salary,
                                                  par_per_pay_salary);
   ELSIF par_ntrsalb_ind = 'S' THEN
      par_nbrjobs_reg_rate       := f_calc_rate( par_nbrjobs_assgn_salary,
                                                 par_nbrjobs_hrs_pay);
   END IF;
END;
/


DROP PUBLIC SYNONYM P_CALC_NBRJOBS_HRS_PAY_PC;

CREATE PUBLIC SYNONYM P_CALC_NBRJOBS_HRS_PAY_PC FOR BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC;


GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC TO GENERAL;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC TO SATURN;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_HRS_PAY_PC TO WTAILOR;
DROP PROCEDURE BANINST1.P_CALC_NBRJOBS_PAYS_PC;

CREATE OR REPLACE PROCEDURE BANINST1.p_calc_nbrjobs_pays_pc
   (par_nbrjobs_factor             IN number,
    par_nbrjobs_assgn_salary       IN number,
    par_nbrjobs_ann_salary         IN number,
    par_nbrjobs_pays               IN number,
    par_per_pay_salary         IN OUT number,
    par_per_pay_defer             OUT number)
AS
--
-- FILE NAME..: noppays.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_CALC_NBRJOBS_PAYS_PC
-- PRODUCT....: POSNCTL
-- USAGE......: Set the per pay defer amount and per pay salary amount.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure sets the per pay defer amount and per pay salary amount
-- with a change to the pays field.
--
-- DESCRIPTION END
--
BEGIN
      par_per_pay_salary := f_calc_ppsal(
                               par_nbrjobs_pays,
                               par_nbrjobs_factor,
                               par_nbrjobs_assgn_salary,
                               par_nbrjobs_ann_salary);
      par_per_pay_defer   := f_calc_defer( par_nbrjobs_assgn_salary,
                                           par_per_pay_salary);
END;
/


DROP PUBLIC SYNONYM P_CALC_NBRJOBS_PAYS_PC;

CREATE PUBLIC SYNONYM P_CALC_NBRJOBS_PAYS_PC FOR BANINST1.P_CALC_NBRJOBS_PAYS_PC;


GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_PAYS_PC TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_PAYS_PC TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_PAYS_PC TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_PAYS_PC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_PAYS_PC TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_PAYS_PC TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_PAYS_PC TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_PAYS_PC TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_PAYS_PC TO GENERAL;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_PAYS_PC TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_PAYS_PC TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_PAYS_PC TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_PAYS_PC TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_PAYS_PC TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_PAYS_PC TO SATURN;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_PAYS_PC TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_PAYS_PC TO WTAILOR;
DROP PROCEDURE BANINST1.P_CALC_NBRJOBS_REG_RATE_PC;

CREATE OR REPLACE PROCEDURE BANINST1.p_calc_nbrjobs_reg_rate_pc
   (par_nbrjobs_sal_step           IN number,
    par_nbrjobs_hrs_pay            IN number,
    par_nbrjobs_reg_rate           IN number,
    par_nbrjobs_factor             IN number,
    par_nbrjobs_pays               IN number,
    par_nbrjobs_assgn_salary   IN OUT number,
    par_nbrjobs_ann_salary     IN OUT number,
    par_nbrjobs_per_pay_salary IN OUT number,
    par_per_pay_defer          IN OUT number)
IS
--
-- FILE NAME..: noprate.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_CALC_NBRJOBS_REG_RATE_PC
-- PRODUCT....: POSNCTL
-- USAGE......: Calculate compensation for changed regular rate.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure calculates compensation when regular rate is changed.
--
-- DESCRIPTION END
--
BEGIN
   IF par_nbrjobs_sal_step = '0' THEN
      par_nbrjobs_ann_salary     := f_calc_hourly_sal(
                                       par_nbrjobs_hrs_pay,
                                       par_nbrjobs_factor,
                                       par_nbrjobs_reg_rate);
      par_nbrjobs_assgn_salary   := f_calc_assign(
                                       par_nbrjobs_reg_rate,
                                       par_nbrjobs_hrs_pay);
      par_nbrjobs_per_pay_salary := f_calc_ppsal(
                                       par_nbrjobs_pays,
                                       par_nbrjobs_factor,
                                       par_nbrjobs_assgn_salary,
                                       par_nbrjobs_ann_salary);
      par_per_pay_defer  := f_calc_defer( par_nbrjobs_assgn_salary,
                                          par_nbrjobs_per_pay_salary);
   END IF;
END;
/


DROP PUBLIC SYNONYM P_CALC_NBRJOBS_REG_RATE_PC;

CREATE PUBLIC SYNONYM P_CALC_NBRJOBS_REG_RATE_PC FOR BANINST1.P_CALC_NBRJOBS_REG_RATE_PC;


GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_REG_RATE_PC TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_REG_RATE_PC TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_REG_RATE_PC TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_REG_RATE_PC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_REG_RATE_PC TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_REG_RATE_PC TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_REG_RATE_PC TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_REG_RATE_PC TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_REG_RATE_PC TO GENERAL;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_REG_RATE_PC TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_REG_RATE_PC TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_REG_RATE_PC TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_REG_RATE_PC TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_REG_RATE_PC TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_REG_RATE_PC TO SATURN;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_REG_RATE_PC TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_NBRJOBS_REG_RATE_PC TO WTAILOR;
DROP PROCEDURE BANINST1.P_CALC_RESET_NBRJLBD_AMTS;

CREATE OR REPLACE PROCEDURE BANINST1.p_calc_reset_nbrjlbd_amts
     (par_nbrjlbd_pidm           IN nbrjlbd.nbrjlbd_pidm%TYPE,
      par_nbrjlbd_posn           IN nbrjlbd.nbrjlbd_posn%TYPE,
      par_nbrjlbd_suff           IN nbrjlbd.nbrjlbd_suff%TYPE,
      par_nbrjlbd_effective_date IN nbrjlbd.nbrjlbd_effective_date%TYPE,
      par_msg                IN OUT VARCHAR2)
IS
--
-- FILE NAME..: nopbkld.sql
-- RELEASE....: 5.0
-- OBJECT NAME: P_CALC_RESET_NBRJLBD_AMTS
-- PRODUCT....: POSNCTL
-- USAGE......: Resets encubrance amounts at JLBD level.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- Procedure resets encumbrance amounts at JLBD level when the JLBD is
-- changed or deleted. Inserts "backout" JLBDs to reverse posted
-- amounts when necessary. (Replaces DUPLICATE_JLBD in NBAJOBS).
--
-- DESCRIPTION END
--
-- Any posted amounts present requiring backout processing?
--
   PTI_INTO_TEMP          VARCHAR2(255);
   CURSOR PTI_CURSOR IS
      SELECT 'X'
      FROM   NBRJLBD
      WHERE  NBRJLBD_PIDM = par_nbrjlbd_pidm
      AND    NBRJLBD_POSN = par_nbrjlbd_posn
      AND    NBRJLBD_SUFF = par_nbrjlbd_suff
      AND    NBRJLBD_EFFECTIVE_DATE = par_nbrjlbd_effective_date
      AND    NBRJLBD_CHANGE_IND = 'A'
      AND    ((NVL(NBRJLBD_SALARY_ENCUMBRANCE,0) <>
             NBRJLBD_SALARY_ENC_TO_POST ) OR
             (NVL(NBRJLBD_FRINGE_ENCUMBRANCE,0) <>
             NBRJLBD_FRINGE_ENC_TO_POST ) OR
             (NVL(NBRJLBD_FRINGE_RESIDUAL,0) <>
             NBRJLBD_FRINGE_RES_TO_POST) );
--
   CURSOR PTI_CURSOR_2 IS
      SELECT 'X'
      FROM   NBRJLBD
      WHERE  NBRJLBD_PIDM = par_nbrjlbd_pidm
      AND    NBRJLBD_POSN = par_nbrjlbd_posn
      AND    NBRJLBD_SUFF = par_nbrjlbd_suff
      AND    NBRJLBD_EFFECTIVE_DATE = par_nbrjlbd_effective_date
      AND    NBRJLBD_CHANGE_IND = 'D';
--
BEGIN
   par_msg := NULL;
--
   OPEN PTI_CURSOR ;
   FETCH PTI_CURSOR INTO PTI_INTO_TEMP ;
   IF PTI_CURSOR%NOTFOUND THEN
      CLOSE PTI_CURSOR;
      RETURN ;
   END IF ;
   CLOSE PTI_CURSOR;
           /* IF Yes, is backout record set already present?*/
   OPEN PTI_CURSOR_2 ;
   FETCH PTI_CURSOR_2 INTO PTI_INTO_TEMP ;
      IF PTI_CURSOR_2%NOTFOUND THEN
         p_ins_nbrjlbd_backout_rec (par_nbrjlbd_pidm,
                                    par_nbrjlbd_posn,
                                    par_nbrjlbd_suff,
                                    par_nbrjlbd_effective_date,
                                    par_msg) ;
         IF par_msg IS NOT NULL THEN
            CLOSE PTI_CURSOR_2;
            RETURN;
         END IF;
      END IF ;
   CLOSE PTI_CURSOR_2;
          /* Reset amounts for all other records in set to null and 0, to
          || allow nbpbudm to recalc values in order to retain proper +/-
          || balance between actives and backouts.
          */
   UPDATE NBRJLBD
   SET    NBRJLBD_SALARY_ENCUMBRANCE = '',
          NBRJLBD_FRINGE_ENCUMBRANCE = '',
          NBRJLBD_FRINGE_RESIDUAL = '',
          NBRJLBD_SALARY_ENC_TO_POST = 0,
          NBRJLBD_FRINGE_ENC_TO_POST = 0,
          NBRJLBD_FRINGE_RES_TO_POST = 0
   WHERE  NBRJLBD_PIDM = par_nbrjlbd_pidm
   AND    NBRJLBD_POSN = par_nbrjlbd_posn
   AND    NBRJLBD_SUFF = par_nbrjlbd_suff
   AND    NBRJLBD_EFFECTIVE_DATE = par_nbrjlbd_effective_date
   AND    NBRJLBD_CHANGE_IND = 'A';
EXCEPTION
   WHEN OTHERS THEN
      par_msg :=  G$_NLS.Get('NOPBKLD-0000', 'SQL',
	'*ERROR* Unable to update NBRJLBD record (Oracle Error %01%).'
	,  TO_CHAR(SQLCODE) );
END;
/


DROP PUBLIC SYNONYM P_CALC_RESET_NBRJLBD_AMTS;

CREATE PUBLIC SYNONYM P_CALC_RESET_NBRJLBD_AMTS FOR BANINST1.P_CALC_RESET_NBRJLBD_AMTS;


GRANT EXECUTE ON BANINST1.P_CALC_RESET_NBRJLBD_AMTS TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_RESET_NBRJLBD_AMTS TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_RESET_NBRJLBD_AMTS TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_CALC_RESET_NBRJLBD_AMTS TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_CALC_RESET_NBRJLBD_AMTS TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_RESET_NBRJLBD_AMTS TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_CALC_RESET_NBRJLBD_AMTS TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_CALC_RESET_NBRJLBD_AMTS TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_CALC_RESET_NBRJLBD_AMTS TO GENERAL;

GRANT EXECUTE ON BANINST1.P_CALC_RESET_NBRJLBD_AMTS TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_RESET_NBRJLBD_AMTS TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_RESET_NBRJLBD_AMTS TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_CALC_RESET_NBRJLBD_AMTS TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_CALC_RESET_NBRJLBD_AMTS TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_CALC_RESET_NBRJLBD_AMTS TO SATURN;

GRANT EXECUTE ON BANINST1.P_CALC_RESET_NBRJLBD_AMTS TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_CALC_RESET_NBRJLBD_AMTS TO WTAILOR;
DROP PROCEDURE BANINST1.P_CHECK_NBRJOBS_CHANGES;

CREATE OR REPLACE PROCEDURE BANINST1.p_check_nbrjobs_changes
     (par_pidm              IN        number,
      par_posn              IN        varchar2,
      par_suff              IN        varchar2,
      par_effective_date    IN        date,
      par_field_name        IN        varchar2,
      par_field_value       IN        varchar2,
      msg                   IN OUT    varchar2,
      msg_type              IN OUT    varchar2)
IS
--
-- FILE NAME..: nopjobs.sql
-- RELEASE....: 4.2
-- OBJECT NAME: P_CHECK_NBRJOBS_CHANGES
-- PRODUCT....: POSNCTL
-- USAGE......: Checks if jobs fields changed.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure checks if changes are made either to 'Time entry method',
-- 'Time entry type', 'Time In and Out'  or
-- 'Employee Class'field .
--  Par_field_name parameter that holds the field name that was changed.
--  This parameter may be one of the follow : 'ecls_code', 'time_entry_method',
--  'time_entry_type', 'time_in_out_ind'.
--  Par_field_value parameter that holds the value entered by the user for one
--  of the fields ( 'Time entry method', 'Time entry type', 'Time In and Out'
--  or 'Employee Class').
--
-- DESCRIPTION END
--
    var_date         varchar2(11);
    var_select        varchar2(2000):=null;
    var_x             varchar2(1);
    cur_handle        integer:= dbms_sql.open_cursor;
    execute_feedback  integer;
BEGIN
   msg := NULL;
   msg_type := NULL;
   var_date := to_char(trunc(par_effective_date),G$_DATE.GET_NLS_DATE_FORMAT);
   var_select := 'Select ''X'' from nbrjobs where nbrjobs_pidm = '||
                  par_pidm||' and nbrjobs_posn = '''||par_posn||
                  ''' and nbrjobs_suff = '''||par_suff||
                  ''' and nbrjobs_effective_date = to_date('''||
                 var_date||''','''||G$_DATE.GET_NLS_DATE_FORMAT||''') and nbrjobs_'||par_field_name||
                 ' = '''||par_field_value||'''';
 -- dbms_output.put_line(var_select);
  dbms_sql.parse(cur_handle,var_select,DBMS_SQL.V7);
  dbms_sql.define_column(cur_handle,1,var_x,1);
  execute_feedback := dbms_sql.execute(cur_handle);
  execute_feedback := dbms_sql.fetch_rows(cur_handle);
  IF execute_feedback = 0 THEN
    msg_type := 'W';
    msg :=  G$_NLS.Get('NOPJOBS-0001', 'SQL','*WARNING* Changes that occur during the pay period may impact the payroll.') ;
  END IF;
  dbms_sql.close_cursor(cur_handle);
--
EXCEPTION
   WHEN OTHERS THEN
     msg :=  G$_NLS.Get('NOPJOBS-0002', 'SQL','*ERROR* Invalid column name; Check spelling') ;
     msg_type := 'E';
END p_check_nbrjobs_changes;
/


DROP PUBLIC SYNONYM P_CHECK_NBRJOBS_CHANGES;

CREATE PUBLIC SYNONYM P_CHECK_NBRJOBS_CHANGES FOR BANINST1.P_CHECK_NBRJOBS_CHANGES;


GRANT EXECUTE ON BANINST1.P_CHECK_NBRJOBS_CHANGES TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_CHECK_NBRJOBS_CHANGES TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_CHECK_NBRJOBS_CHANGES TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_CHECK_NBRJOBS_CHANGES TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_CHECK_NBRJOBS_CHANGES TO GENERAL;

GRANT EXECUTE ON BANINST1.P_CHECK_NBRJOBS_CHANGES TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_CHECK_NBRJOBS_CHANGES TO SATURN;

GRANT EXECUTE ON BANINST1.P_CHECK_NBRJOBS_CHANGES TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_CHECK_NBRJOBS_CHANGES TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_ANN_SALARY_ENC;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_ann_salary_enc
     ( par_salary_enc_ind   IN  varchar2,
       msg                 OUT  varchar2,
       msg_type            OUT  varchar2)
IS
--
-- FILE NAME..: nopencw.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_ANN_SALARY_ENC
-- PRODUCT....: POSNCTL
-- USAGE......: Issue warning message based on encumbrance method.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure issues warning message when the encumbrance calculation
-- method for the job is 'Value Input'.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_salary_enc_ind = 'V' THEN
      msg :=   G$_NLS.Get('NOPENCW-0000', 'SQL','*WARNING* Encumbrance Method is Value Input and salary has changed.')
              ;
      msg_type := 'W';
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_ANN_SALARY_ENC;

CREATE PUBLIC SYNONYM P_EDIT_ANN_SALARY_ENC FOR BANINST1.P_EDIT_ANN_SALARY_ENC;


GRANT EXECUTE ON BANINST1.P_EDIT_ANN_SALARY_ENC TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_ANN_SALARY_ENC TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_ANN_SALARY_ENC TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_ANN_SALARY_ENC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_ANN_SALARY_ENC TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_ANN_SALARY_ENC TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_ANN_SALARY_ENC TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_ANN_SALARY_ENC TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_ANN_SALARY_ENC TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_ANN_SALARY_ENC TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_ANN_SALARY_ENC TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_ANN_SALARY_ENC TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_ANN_SALARY_ENC TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_ANN_SALARY_ENC TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_ANN_SALARY_ENC TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_ANN_SALARY_ENC TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_ANN_SALARY_ENC TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_CALC_PTOT_AVAIL;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_calc_ptot_avail
       (par_posn      IN varchar2,
        par_fisc_code IN nbrptot.nbrptot_fisc_code%TYPE,
        par_avail     OUT  number,
        par_fte       OUT number,
        par_budget    OUT number,
        msg           OUT noreaer.noreaer_error_msg%TYPE,
        msg_type      OUT noreaer.noreaer_msg_type%TYPE)
IS
--
-- FILE NAME..: nopactv.sql
-- RELEASE....: 7.0
-- OBJECT NAME: P_EDIT_CALC_PTOT_AVAIL
-- PRODUCT....: POSNCTL
-- USAGE......: Determine active budget for a given position.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure determines the available budget for a given position.
-- If the position budget is not active for a given fiscal year, an error is
-- generated.
--
-- DESCRIPTION END
--
     CURSOR c1 IS
         SELECT NVL(NBRPTOT_BUDGET, 0) - NVL(NBRPTOT_EXPEND,0)
                - NVL(NBRPTOT_ENCUMB, 0), NBRPTOT_FTE, NVL(NBRPTOT_BUDGET,0)
         FROM   NBRPTOT
         WHERE  NBRPTOT_POSN = par_posn
           AND  NBRPTOT_FISC_CODE = par_fisc_code
           AND  NBRPTOT_STATUS = 'A';
BEGIN
   msg := NULL;
   msg_type := NULL;
--
     OPEN c1;
     FETCH c1 INTO par_avail,
                   par_fte,
                   par_budget;
      IF c1%NOTFOUND
      THEN
          msg := '*ERROR* No active position '||
                    'budget found for active fiscal year.';
          msg_type := 'E';
      END IF;
     CLOSE c1;
END;
/


DROP PUBLIC SYNONYM P_EDIT_CALC_PTOT_AVAIL;

CREATE PUBLIC SYNONYM P_EDIT_CALC_PTOT_AVAIL FOR BANINST1.P_EDIT_CALC_PTOT_AVAIL;


GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO BANIMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO PAYROLL;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_CALC_PTOT_AVAIL TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_COAS_REQ;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_coas_req
         (par_fin_installed  IN     varchar2,
          par_coas_code_home IN     varchar2,
          msg                OUT    varchar2,
          msg_type           OUT    varchar2)
--
IS
--
-- FILE NAME..: nopcoas.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_COAS_REQ
-- PRODUCT....: POSNCTL
-- USAGE......: Verify existence of Chart of Accounts Code.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure verifies the existence of the Chart of Accounts Code when
-- Banner Finance is installed.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_fin_installed = 'Y' THEN
      IF par_coas_code_home IS NULL
      THEN
        msg :=  G$_NLS.Get('NOPCOAS-0000', 'SQL','*ERROR* The Chart of Accounts Code is required ifBanner Finance is installed.')
               ;
           msg_type := 'E';
      END IF;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_COAS_REQ;

CREATE PUBLIC SYNONYM P_EDIT_COAS_REQ FOR BANINST1.P_EDIT_COAS_REQ;


GRANT EXECUTE ON BANINST1.P_EDIT_COAS_REQ TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_COAS_REQ TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_COAS_REQ TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_COAS_REQ TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_COAS_REQ TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_COAS_REQ TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_COAS_REQ TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_COAS_REQ TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_COAS_REQ TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_COAS_REQ TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_COAS_REQ TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_COAS_REQ TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_COAS_REQ TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_COAS_REQ TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_COAS_REQ TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_COAS_REQ TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_COAS_REQ TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_CONTRACT_DATES_DEF;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_contract_dates_def
      (par_dfpr_code      IN  nbrjobs.nbrjobs_dfpr_code%TYPE,
       par_begin_date     IN  nbrbjob.nbrbjob_contract_begin_date%TYPE,
       par_end_date       IN  nbrbjob.nbrbjob_contract_end_date%TYPE,
       par_enc_method     IN  VARCHAR2,
       msg               OUT  VARCHAR2,
       msg_type          OUT  VARCHAR2)
IS
--
-- FILE NAME..: nopcdrq.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_CONTRACT_DATES_DEF
-- PRODUCT....: POSNCTL
-- USAGE......: Check if contract dates are entered on deferred assignments
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure generates warning that contract dates must be entered
-- on deferred assignments.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_dfpr_code IS NOT NULL AND (par_begin_date IS NULL OR
      par_end_date IS NULL) AND par_enc_method IN ('S','H') THEN
         msg :=   G$_NLS.Get('NOPCDRQ-0000', 'SQL','*WARNING* Contract dates required for encumbrance calc w/deferred pay.')
                 ;
         msg_type := 'W';
   END IF;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_CONTRACT_DATES_DEF;

CREATE PUBLIC SYNONYM P_EDIT_CONTRACT_DATES_DEF FOR BANINST1.P_EDIT_CONTRACT_DATES_DEF;


GRANT EXECUTE ON BANINST1.P_EDIT_CONTRACT_DATES_DEF TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_CONTRACT_DATES_DEF TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_CONTRACT_DATES_DEF TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_CONTRACT_DATES_DEF TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_CONTRACT_DATES_DEF TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_CONTRACT_DATES_DEF TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_CONTRACT_DATES_DEF TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_CONTRACT_DATES_DEF TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_CONTRACT_DATES_DEF TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_CONTRACT_DATES_DEF TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_CONTRACT_DATES_DEF TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_CONTRACT_DATES_DEF TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_CONTRACT_DATES_DEF TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_CONTRACT_DATES_DEF TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_CONTRACT_DATES_DEF TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_CONTRACT_DATES_DEF TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_CONTRACT_DATES_DEF TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_CURRENT_FISCAL_YEAR;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_current_fiscal_year
     (par_posn            IN    nbrbjob.nbrbjob_posn%TYPE,
      par_coas_code       IN    nbrbjob.nbrbjob_coas_code%TYPE,
      par_cur_fisc        OUT   nbbfisc.nbbfisc_code%TYPE,
      par_fisc_begin      OUT   nbbfisc.nbbfisc_begin_date%TYPE,
      par_fisc_end        OUT   nbbfisc.nbbfisc_end_date%TYPE,
      msg                 OUT   noreaer.noreaer_error_msg%TYPE,
      msg_type            OUT   noreaer.noreaer_msg_type%TYPE)
IS
--
-- FILE NAME..: nopcfsc.sql
-- RELEASE....: 5.0
-- OBJECT NAME: P_EDIT_CURRENT_FISCAL_YEAR
-- PRODUCT....: POSNCTL
-- USAGE......: Retrieves the current fiscal year code from NBBFISC table.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure retrieves the current fiscal year code from NBBFISC
-- table based on the assignment's position and COAS code.
--
-- DESCRIPTION END
--
CURSOR PTI_CURSOR IS

   SELECT NBBFISC_CODE, NBBFISC_BEGIN_DATE, NBBFISC_END_DATE
   FROM   nbbfisc
   WHERE  nbbfisc_code =  (
   SELECT MAX(nbrptot_fisc_code)
   FROM   nbrptot
   WHERE  nbrptot_status = 'A'
   AND  nbrptot_posn = par_posn
   AND  NVL(nbrptot_coas_code, '@') = NVL(par_coas_code, '@'))
   AND  NVL(nbbfisc_coas_code, '@') = NVL(par_coas_code, '@');
--

BEGIN

   msg := NULL;
   msg_type := NULL;
--
   OPEN PTI_CURSOR ;
   FETCH PTI_CURSOR INTO par_cur_fisc, par_fisc_begin, par_fisc_end;
   IF PTI_CURSOR%NOTFOUND THEN
      msg :=  G$_NLS.Get('NOPCFSC-0000', 'SQL','*ERROR* Unable to select currently active fiscal year for this position.')
              ;
      msg_type := 'E';
   END IF;
   CLOSE PTI_CURSOR;

END;
/


DROP PUBLIC SYNONYM P_EDIT_CURRENT_FISCAL_YEAR;

CREATE PUBLIC SYNONYM P_EDIT_CURRENT_FISCAL_YEAR FOR BANINST1.P_EDIT_CURRENT_FISCAL_YEAR;


GRANT EXECUTE ON BANINST1.P_EDIT_CURRENT_FISCAL_YEAR TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_CURRENT_FISCAL_YEAR TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_CURRENT_FISCAL_YEAR TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_CURRENT_FISCAL_YEAR TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_CURRENT_FISCAL_YEAR TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_CURRENT_FISCAL_YEAR TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_CURRENT_FISCAL_YEAR TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_CURRENT_FISCAL_YEAR TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_CURRENT_FISCAL_YEAR TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_CURRENT_FISCAL_YEAR TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_CURRENT_FISCAL_YEAR TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_CURRENT_FISCAL_YEAR TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_CURRENT_FISCAL_YEAR TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_CURRENT_FISCAL_YEAR TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_CURRENT_FISCAL_YEAR TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_CURRENT_FISCAL_YEAR TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_CURRENT_FISCAL_YEAR TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_ECLS_VS_ESKL;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_ecls_vs_eskl
     (par_location_ind      IN   VARCHAR2,
      par_empr_ind          IN   VARCHAR2,
      par_full_part_ind     IN   VARCHAR2,
      par_eskl_code         IN   VARCHAR2,
      msg                   OUT  VARCHAR2,
      msg_type              OUT  VARCHAR2)
IS
--
-- FILE NAME..: nopeces.sql
-- RELEASE....: 5.1.2
-- OBJECT NAME: P_EDIT_ECLS_VS_ESKL
-- PRODUCT....: POSNCTL
-- USAGE......: Validate position skill code.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates the position skill code against the employee
-- class code entered.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF NVL(par_location_ind,'*') <> 'U' THEN
      RETURN;
   END IF;
--
   IF par_empr_ind = 'H' THEN
      IF par_full_part_ind IN ( '1', '2', '5' ) THEN
         IF NVL(par_eskl_code,'*') <> '2' THEN
            msg := 'Position Class Skill Code is invalid for this' ||
                   ' Employee Class.' ;
            msg_type := 'E';
         END IF ;
      ELSIF par_full_part_ind = '3' THEN
         IF NVL(par_eskl_code,'*') NOT IN ( '1', '3', '4', '5', '6', '7', 'A')
          THEN
            msg := 'Position Class Skill Code is invalid for' ||
                   ' this Employee Class.';
            msg_type := 'E';
         END IF ;
      ELSIF par_full_part_ind = '4' THEN
         IF NVL(par_eskl_code,'*') NOT IN ('1','2','3','4','5','6','7','8','A')
          THEN
            msg := 'Position Class Skill Code is invalid for' ||
                   ' this Employee Class.';
            msg_type := 'E';
         END IF ;
      END IF ;
   ELSIF par_empr_ind = 'G' THEN
      IF par_full_part_ind IN ( 'F', 'O' ) THEN
         IF NVL(par_eskl_code,'*') NOT IN ('1','2','3','4','5','6','7','8') THEN
            msg := 'Position Class Skill Code is invalid for' ||
                   ' this Employee Class.';
            msg_type := 'E';
         END IF ;
      END IF ;
   ELSIF par_empr_ind = 'K' THEN
      IF par_full_part_ind IN ( 'F', 'P', 'FP' ) THEN
         IF par_eskl_code IN ( 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H' ) THEN
            NULL ;
         ELSIF par_eskl_code IN ('I','J','K','L','M','N','O','P','Q','R') THEN
            NULL ;
         ELSE
            msg := 'Position Class Skill Code is invalid for' ||
                   ' this Employee Class.';
            msg_type := 'E';
         END IF ;
      END IF ;
   ELSIF par_empr_ind = 'C' THEN
      IF par_full_part_ind IN ( 'F', 'P' ) THEN
         IF NVL(par_eskl_code,'*') NOT IN ('1','2','3','4','5','6','7','8','9')
          THEN
            msg := 'Position Class Skill Code is invalid for' ||
                   ' this Employee Class.';
            msg_type := 'E';
         END IF ;
      END IF ;
   END IF ;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_ECLS_VS_ESKL;

CREATE PUBLIC SYNONYM P_EDIT_ECLS_VS_ESKL FOR BANINST1.P_EDIT_ECLS_VS_ESKL;


GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO BANIMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_ECLS_VS_ESKL TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_EMP_MIN_REQ;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_emp_min_req
         (par_fin_installed  IN  varchar2,
          par_ecls_code      IN  varchar2,
          par_coas_code_home IN  varchar2,
          par_orgn_code_home IN  varchar2,
          msg                OUT varchar2,
          msg_type           OUT varchar2)
--
IS
--
-- FILE NAME..: nopemin.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_EMP_MIN_REQ
-- PRODUCT....: POSNCTL
-- USAGE......: Verify entry of the required fields to create a new employee.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure verifies that Employee Class, Chart of Accounts and
-- Organization codes, which are required to create a new employee
-- record, have been entered.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_fin_installed = 'Y' THEN
      IF par_ecls_code IS NULL OR
         par_coas_code_home  IS NULL OR
         par_orgn_code_home IS NULL
      THEN
        msg :=  G$_NLS.Get('NOPEMIN-0000', 'SQL','*ERROR* The Employee Class Code, Home COAS and Organization must exist.')
               ;
           msg_type := 'E';
      END IF;
   ELSE
      IF par_ecls_code IS NULL OR
         par_orgn_code_home IS NULL
      THEN
         msg :=  G$_NLS.Get('NOPEMIN-0001', 'SQL','*ERROR* The Employee Class Code and Home Organization must be entered.')
                ;
         msg_type := 'E';
      END IF;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_EMP_MIN_REQ;

CREATE PUBLIC SYNONYM P_EDIT_EMP_MIN_REQ FOR BANINST1.P_EDIT_EMP_MIN_REQ;


GRANT EXECUTE ON BANINST1.P_EDIT_EMP_MIN_REQ TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_EMP_MIN_REQ TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_EMP_MIN_REQ TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_EMP_MIN_REQ TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_EMP_MIN_REQ TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_EMP_MIN_REQ TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_EMP_MIN_REQ TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_EMP_MIN_REQ TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_EMP_MIN_REQ TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_EMP_MIN_REQ TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_EMP_MIN_REQ TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_EMP_MIN_REQ TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_EMP_MIN_REQ TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_EMP_MIN_REQ TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_EMP_MIN_REQ TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_EMP_MIN_REQ TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_EMP_MIN_REQ TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_FACTOR_VS_PAYS;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_factor_vs_pays
     (par_factor    IN   nbrjobs.nbrjobs_factor%TYPE,
      par_pays      IN   nbrjobs.nbrjobs_pays%TYPE,
      msg           OUT  VARCHAR2,
      msg_type      OUT  VARCHAR2)
IS
--
-- FILE NAME..: nopfanp.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_FACTOR_VS_PAYS
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edit on jobs factor within a given range.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure makes sure the jobs factor is between 1 and the jobs number
-- of pays.
--
-- DESCRIPTION END
--
BEGIN
--
   IF NVL(par_factor,0) < 1
    OR NVL(par_factor,0) > NVL(par_pays,0) THEN
      msg :=  G$_NLS.Get('NOPFANP-0000', 'SQL','*ERROR* Factor must be between 1 and the value of Pays field.') ;
      msg_type := 'E';
      RETURN;
   END IF ;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_FACTOR_VS_PAYS;

CREATE PUBLIC SYNONYM P_EDIT_FACTOR_VS_PAYS FOR BANINST1.P_EDIT_FACTOR_VS_PAYS;


GRANT EXECUTE ON BANINST1.P_EDIT_FACTOR_VS_PAYS TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_FACTOR_VS_PAYS TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_FACTOR_VS_PAYS TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_FACTOR_VS_PAYS TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_FACTOR_VS_PAYS TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_FACTOR_VS_PAYS TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_FACTOR_VS_PAYS TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_FACTOR_VS_PAYS TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_FACTOR_VS_PAYS TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_FACTOR_VS_PAYS TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_FACTOR_VS_PAYS TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_FACTOR_VS_PAYS TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_FACTOR_VS_PAYS TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_FACTOR_VS_PAYS TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_FACTOR_VS_PAYS TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_FACTOR_VS_PAYS TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_FACTOR_VS_PAYS TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_ID;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_id
    (par_empr_ind       IN  varchar2,
     par_location_ind   IN  varchar2,
     par_pidm           IN  number,
     msg               OUT  varchar2,
     msg_type          OUT  varchar2,
     edit_num       IN OUT  number)
IS
--
-- FILE NAME..: nopnssn.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_ID
-- PRODUCT....: POSNCTL
-- USAGE......: Ensures that SPBPERS record exists.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure ensures that SPBPERS record exists for the given PIDM,ssn,
-- birth-date, ethn-code, citizenship and sex infomation is complete and
-- also the name is entered.
--
-- DESCRIPTION END
--
CURSOR PTI_CURSOR IS
   SELECT SPRIDEN_FIRST_NAME
   FROM   SPRIDEN
   WHERE  SPRIDEN_PIDM = par_pidm
     AND  SPRIDEN_CHANGE_IND IS NULL
     AND  SPRIDEN_ENTITY_IND = 'P' ;
--
CURSOR PTI_CURSOR_2 IS
   SELECT 'X'
   FROM   SPBPERS
   WHERE  SPBPERS_DEAD_IND IS NOT NULL
     AND  SPBPERS_PIDM = par_pidm;
--
CURSOR PTI_CURSOR_3 IS
   SELECT 'X'
   FROM   SPBPERS
   WHERE  SPBPERS_PIDM = par_pidm
     AND  SPBPERS_SSN IS NOT NULL
     AND  SPBPERS_BIRTH_DATE IS NOT NULL
     AND  SPBPERS_ETHN_CODE IS NOT NULL
     AND  SPBPERS_SEX IN ('M', 'F') ;
--
CURSOR PTI_CURSOR_4 IS
         SELECT 'X'
         FROM   SPBPERS
         WHERE  SPBPERS_PIDM = par_pidm
           AND  SPBPERS_CITZ_CODE IS NOT NULL;
--
CURSOR PTI_CURSOR_5 IS
         SELECT 'X'
         FROM   SPRADDR
         WHERE  SPRADDR_PIDM = par_pidm;
--
   var_dummy        VARCHAR2(1);
   var_first_name   spriden.spriden_first_name%TYPE;
   end_edit         NUMBER := 99;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
      OPEN PTI_CURSOR ;
      FETCH PTI_CURSOR INTO var_first_name ;
      IF pti_cursor%NOTFOUND THEN
         var_first_name := NULL;
      END IF;
--
   IF edit_num = 1 THEN
      edit_num := edit_num + 1;
      IF var_first_name IS NULL THEN
         msg :=  G$_NLS.Get('NOPNSSN-0000', 'SQL','*ERROR* ID does not exist.') ;
         msg_type := 'E';
         edit_num := end_edit;
         RETURN;
      END IF;
   END IF;
--
   IF edit_num = 2 THEN
      edit_num := edit_num + 1;
      OPEN PTI_CURSOR_2 ;
      FETCH PTI_CURSOR_2 into var_dummy;
      IF PTI_CURSOR_2%FOUND THEN
         msg :=  G$_NLS.Get('NOPNSSN-0001', 'SQL','*WARNING* Person is deceased!') ;
         msg_type := 'W';
         RETURN;
      END IF ;
   END IF;
--
   IF edit_num = 3 THEN
      edit_num := edit_num + 1;
      OPEN PTI_CURSOR_3 ;
      FETCH PTI_CURSOR_3 INTO var_dummy;
      IF (PTI_CURSOR_3%NOTFOUND) OR (var_first_name IS NULL) THEN
         msg :=  G$_NLS.Get('NOPNSSN-0002', 'SQL','*ERROR* First Name, SSN, Birth Date, Sex Code or Ethnic Code incomplete.')

                ;
         msg_type := 'E';
         RETURN;
      END IF ;
   END IF;
--
   IF edit_num = 4 THEN
      edit_num := edit_num + 1;
      IF par_location_ind <> 'C' AND par_empr_ind = 'H' THEN
         OPEN PTI_CURSOR_4 ;
         FETCH PTI_CURSOR_4 INTO var_dummy;
         IF (PTI_CURSOR_4%NOTFOUND)  THEN
            msg :=  G$_NLS.Get('NOPNSSN-0003', 'SQL','*ERROR* Citizen Code must be entered on PPAIDEN') ;
            msg_type := 'E';
            RETURN;
         END IF ;
      END IF;
   END IF;
--
   IF edit_num = 5 THEN
      edit_num := end_edit;
      OPEN PTI_CURSOR_5 ;
      FETCH PTI_CURSOR_5 INTO var_dummy;
      IF PTI_CURSOR_5%NOTFOUND THEN
         msg :=  G$_NLS.Get('NOPNSSN-0004', 'SQL','*ERROR* No address information exists.') ;
         msg_type := 'E';
         RETURN;
      END IF ;
   END IF;
END ;
/


DROP PUBLIC SYNONYM P_EDIT_ID;

CREATE PUBLIC SYNONYM P_EDIT_ID FOR BANINST1.P_EDIT_ID;


GRANT EXECUTE ON BANINST1.P_EDIT_ID TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_ID TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_ID TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_ID TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_ID TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_ID TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_ID TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_ID TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_ID TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_ID TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_ID TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_ID TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_ID TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_ID TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_ID TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_ID TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_ID TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_IN_BALANCE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_in_balance
   (par_nbrjobs_hrs_pay        IN number,
    par_nbrjobs_factor         IN number,
    par_ntrsalb_ind            IN varchar2,
    par_ann_salary             IN number,
    par_assgn_salary           IN number,
    par_reg_rate               IN number,
    par_apt_pct                IN number,
    par_ann_sal_entered        IN varchar2,
    par_assgn_sal_entered      IN varchar2,
    par_reg_rate_entered       IN varchar2,
    msg                       OUT varchar2,
    msg_type                  OUT varchar2)
IS
--
-- FILE NAME..: nopfbal.sql
-- RELEASE....: 7.0
-- OBJECT NAME: P_EDIT_IN_BALANCE
-- PRODUCT....: POSNCTL
-- USAGE......: To verify that the compensation amounts entered for an
--              electronic approvals transaction will "balance".
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure verifies that the compensation amounts entered for an
-- electronic approvals transaction will "balance". For example, if the job
-- is salaried, the annual salary must equal the assignment salary times factor.
--
-- DESCRIPTION END
--
   calc_assign_diff Number := 0.0;
BEGIN
/* dbms_output.put_line('par_nbrjobs hrs pay: ' || TO_CHAR(par_nbrjobs_hrs_pay));
dbms_output.put_line('par_nbrjobs factor: ' || TO_CHAR(par_nbrjobs_factor));
dbms_output.put_line('par_ntrsalb ind: ' || par_ntrsalb_ind);
dbms_output.put_line('par_ann_salary: ' || TO_CHAR(par_ann_salary));
dbms_output.put_line('par_assgn salary: ' || TO_CHAR(par_assgn_salary));
dbms_output.put_line('par_reg_rate: ' || to_char(par_reg_rate));
dbms_output.put_line('par_ann_sal_entered: ' || par_ann_sal_entered);
dbms_output.put_line('par_assgn_sal_entered: ' || par_assgn_sal_entered);
dbms_output.put_line('par_reg_rate_entered: ' || par_reg_rate_entered);
*/

   IF par_ntrsalb_ind = 'S' THEN
      IF (par_ann_salary =0 AND par_reg_rate =0) THEN
         Null;
      ELSE
         IF par_nbrjobs_hrs_pay <> ROUND(((par_ann_salary/par_nbrjobs_factor)
                                    /par_reg_rate), 2) THEN
            msg := '*ERROR* Assignment Salary divided by rate does not ' ||
                'equal hrs per pay.';
            msg_type := 'E';
            RETURN;
         END IF;
      END IF;
   ELSE
      IF (par_ann_salary =0 AND par_reg_rate =0) THEN
         Null;
      ELSE
         IF par_nbrjobs_hrs_pay <> ROUND(((par_ann_salary/par_nbrjobs_factor)
                                    /par_reg_rate), 2)  AND
            par_nbrjobs_hrs_pay <> ROUND((par_assgn_salary/par_reg_rate),2) THEN
            msg := '*ERROR* Assignment Salary divided by rate does not ' ||
                'equal hrs per pay.';
            msg_type := 'E';
            RETURN;
         END IF;
      END IF;
   END IF;

--   IF par_nbrjobs_hrs_pay <> ROUND( f_calc_hrs_pay(par_assgn_salary,
--                                            par_reg_rate),2) THEN
--      msg := '*ERROR* Assignment Salary divided by rate does not ' ||
--             'equal hrs per pay.';
--      msg_type := 'E';
--      RETURN;
--   END IF;

   IF par_assgn_sal_entered = 'Y' OR
      par_ann_sal_entered = 'Y' THEN
      calc_assign_diff := f_calc_assign_from_annl(par_ann_salary,
                          par_nbrjobs_factor) - par_assgn_salary;
      IF  calc_assign_diff > 0.01
      THEN
         msg := '*ERROR* Annual salary divided by the job factor does ' ||
                'not equal the assgn salary.';
         msg_type := 'E';
         RETURN;
      END IF;
   END IF;
--
   IF par_reg_rate_entered = 'Y' THEN
      IF par_ann_salary <> f_calc_hourly_sal(par_nbrjobs_hrs_pay,
                                             par_nbrjobs_factor,
                                             par_reg_rate) THEN
         msg := '*ERROR* Rate times factor times hours per pay does not ' ||
                'equal annual salary.';
         msg_type := 'E';
         RETURN;
      END IF;
   END IF;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_IN_BALANCE;

CREATE PUBLIC SYNONYM P_EDIT_IN_BALANCE FOR BANINST1.P_EDIT_IN_BALANCE;


GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO BANIMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO PAYROLL;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_IN_BALANCE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_IPEDS_REPORTABLE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_ipeds_reportable
    (par_pidm               IN  number,
     par_posn               IN  varchar2,
     par_suff               IN  varchar2,
     par_begin_date         IN  date,
     par_end_date           IN  date,
     par_ecls_eskl          IN  varchar2,
     par_ecls_eeog_code     IN  varchar2,
     par_ipeds_rept         IN  varchar2,
     par_trans_no           IN  number,
     par_effective_date     IN  date,
     par_exe_source         IN  varchar2,
     par_msg_ind            IN  varchar2,
     par_ipeds_ind         OUT  varchar2,
     msg                   OUT  varchar2,
     msg_type              OUT  varchar2)
IS
--
-- FILE NAME..: nopiped.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_IPEDS_REPORTABLE
-- PRODUCT....: POSNCTL
-- USAGE......: Validate the IPEDs reportable indicator for a job.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates the IPEDs reportable indicator for a job. Mutliple
-- assignments cannot be reportable unless the employee skill codes on all
-- assignments are identical.
--
-- DESCRIPTION END
--
  PTI_INTO_TEMP        CHAR(255);
  var_posn        varchar2(6) := NULL;
  var_suff        varchar2(2) := NULL;
  var_term        varchar2(1) := NULL;
--
   CURSOR check_for_term
   IS
   SELECT 'X'
   FROM   nortran N
   WHERE  N.nortran_transaction_no = par_trans_no
     AND  N.nortran_posn = var_posn
     AND  N.nortran_suff = var_suff
     AND  N.nortran_aufd_code = 'NBRJOBS_STATUS'
     AND  N.nortran_value = 'T'
     AND EXISTS
         (SELECT 'X'
          FROM   nortran D
          WHERE  D.nortran_transaction_no = par_trans_no
          AND  D.nortran_posn = var_posn
          AND  D.nortran_suff = var_suff
          AND  D.nortran_aufd_code = 'NBRJOBS_EFFECTIVE_DATE'
          AND  to_date(D.nortran_value,G$_DATE.GET_NLS_DATE_FORMAT) <= par_effective_date);
--
  CURSOR PTI_CURSOR IS
  SELECT NBRBJOB_POSN, NBRBJOB_SUFF
  FROM   NBBPOSN, PTRECLS, NTRPCLS, NBRBJOB
  WHERE  NBRBJOB_PIDM = par_pidm
  AND  NBRBJOB_IPEDS_REPT_IND = 'Y'
  AND  (NBRBJOB_POSN <> par_posn
        OR  (NBRBJOB_POSN = par_posn
             AND  NBRBJOB_SUFF <> par_suff))
  AND  (NBRBJOB_END_DATE >= par_begin_date
        OR  NBRBJOB_END_DATE IS NULL)
  AND  (NBRBJOB_BEGIN_DATE <= par_end_date
        OR  par_end_date IS NULL)
  AND  NBBPOSN_POSN = NBRBJOB_POSN
  AND  NTRPCLS_CODE = NBBPOSN_PCLS_CODE
  AND  PTRECLS_CODE = NBBPOSN_ECLS_CODE
  AND  (NVL(PTRECLS_EEOG_CODE,'*') <> NVL(par_ecls_eeog_code,'*')
        OR SUBSTR(NTRPCLS_ESKL_CODE, 1, 1) <> par_ecls_eskl) ;
--
BEGIN
dbms_output.put_line( G$_NLS.Get('NOPIPED-0001', 'SQL','in p_edit_ipeds_reportable...') );
   msg := NULL;
   msg_type := NULL;
--
--  IF par_ipeds_rept = 'Y' THEN
     OPEN PTI_CURSOR ;
     LOOP
        FETCH PTI_CURSOR INTO var_posn, var_suff;
--        EXIT WHEN PTI_CURSOR%NOTFOUND;
        IF PTI_CURSOR%FOUND THEN
           IF par_exe_source IN ('PAF','MASS') THEN
              OPEN check_for_term;
              FETCH check_for_term INTO var_term;
--              IF var_term = 'X' THEN
--                 NULL;
--              ELSE
              IF check_for_term%NOTFOUND THEN
/*                 msg := '*ERROR* Multiple jobs cannot be ' ||
                        'IPEDS reportable if Skill Codes do not match.';
                 msg_type := 'E';
*/
                 IF par_msg_ind = 'Y' THEN
                    msg :=  G$_NLS.Get('NOPIPED-0004', 'SQL','*WARNING* Conflicting job factors found.  Job will not be reported on IPEDS.')
                           ;
                    msg_type := 'W';
                 END IF;
                 par_ipeds_ind := 'N';
                 CLOSE PTI_CURSOR;
                 CLOSE check_for_term;
                 RETURN;
              END IF;
           END IF;
        ELSE
--           msg := '*ERROR* Multiple jobs cannot be ' ||
--                  'IPEDS reportable if Skill Codes do not match.';
--           msg_type := 'E';
           par_ipeds_ind := 'Y';
           CLOSE PTI_CURSOR;
           RETURN;
        END IF;
     END LOOP;
  CLOSE PTI_CURSOR;
--  END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_IPEDS_REPORTABLE;

CREATE PUBLIC SYNONYM P_EDIT_IPEDS_REPORTABLE FOR BANINST1.P_EDIT_IPEDS_REPORTABLE;


GRANT EXECUTE ON BANINST1.P_EDIT_IPEDS_REPORTABLE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_IPEDS_REPORTABLE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_IPEDS_REPORTABLE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_IPEDS_REPORTABLE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_IPEDS_REPORTABLE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_IPEDS_REPORTABLE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_IPEDS_REPORTABLE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_IPEDS_REPORTABLE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_IPEDS_REPORTABLE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_IPEDS_REPORTABLE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_IPEDS_REPORTABLE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_IPEDS_REPORTABLE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_IPEDS_REPORTABLE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_IPEDS_REPORTABLE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_IPEDS_REPORTABLE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_IPEDS_REPORTABLE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_IPEDS_REPORTABLE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_JOB_MIN_REQ;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_job_min_req
    (par_bdate          IN date,
     par_rate           IN number,
     par_salary         IN number,
     par_step           IN number,
     msg                OUT varchar2,
     msg_type           OUT varchar2)
AS
--
-- FILE NAME..: nopjmin.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_JOB_MIN_REQ
-- PRODUCT....: POSNCTL
-- USAGE......: Verify the entry of the required fields
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure verifies that the fields required to create a new assignment
-- or job have been entered.
--
-- DESCRIPTION END
--
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_bdate IS NULL OR
      par_step  IS NULL
   THEN
      msg :=  G$_NLS.Get('NOPJMIN-0000', 'SQL','*ERROR* The Begin Date and Step must be entered for a new job.')
             ;
      msg_type := 'E';
   ELSE
      IF (par_step = 0 and
         (par_rate IS NULL and
          par_salary IS NULL))
      THEN
         msg :=  G$_NLS.Get('NOPJMIN-0001', 'SQL','*ERROR* The rate or ann sal must be entered for a new job when step = 0.')
                ;
         msg_type := 'E';
      END IF;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_JOB_MIN_REQ;

CREATE PUBLIC SYNONYM P_EDIT_JOB_MIN_REQ FOR BANINST1.P_EDIT_JOB_MIN_REQ;


GRANT EXECUTE ON BANINST1.P_EDIT_JOB_MIN_REQ TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_MIN_REQ TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_MIN_REQ TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_MIN_REQ TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_MIN_REQ TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_MIN_REQ TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_MIN_REQ TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_MIN_REQ TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_MIN_REQ TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_MIN_REQ TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_MIN_REQ TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_MIN_REQ TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_MIN_REQ TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_MIN_REQ TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_MIN_REQ TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_MIN_REQ TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_MIN_REQ TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_JOB_SUPERVISOR;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_job_supervisor
     (par_pidm             IN   spriden.spriden_pidm%TYPE,
      par_posn             IN   nbrbjob.nbrbjob_posn%TYPE,
      par_suff             IN   nbrbjob.nbrbjob_suff%TYPE,
      par_effective_date   IN   nbrjobs.nbrjobs_effective_date%TYPE,
      par_status           IN   nbrjobs.nbrjobs_status%TYPE,
      par_title            OUT  VARCHAR2,
      exe_source           IN   VARCHAR2,
      msg                  OUT  noreaer.noreaer_error_msg%TYPE,
      msg_type             OUT  noreaer.noreaer_msg_type%TYPE)
IS
--
-- FILE NAME..: nopsupv.sql
-- RELEASE....: 7.0
-- OBJECT NAME: P_EDIT_JOB_SUPERVISOR
-- PRODUCT....: POSNCTL
-- USAGE......: Retrieve a job title for the supervisor.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates a job supervisor and retrieves a job title
-- for the supervisor.
--
-- DESCRIPTION END
--
   CURSOR supv_cursor IS
      SELECT nbrjobs_desc
      FROM   nbrbjob, nbrjobs
      WHERE  nbrjobs_pidm  =  par_pidm
        AND  nbrjobs_posn  =  par_posn
        AND  nbrjobs_suff  =  par_suff
        AND  nbrjobs_effective_date =
             (SELECT MAX(nbrjobs_effective_date)
              FROM   nbrjobs
              WHERE  nbrjobs_pidm  =  par_pidm
                AND  nbrjobs_posn  =  par_posn
                AND  nbrjobs_suff  =  par_suff
                AND  nbrjobs_effective_date <= par_effective_date)
        AND  nbrbjob_pidm  =  par_pidm
        AND  nbrbjob_posn  =  par_posn
        AND  nbrbjob_suff  =  par_suff
        AND  nbrbjob_begin_date <= par_effective_date
        AND  (nbrbjob_end_date IS NULL
                OR ( nbrbjob_end_date > par_effective_date
                     AND par_status  <> 'T')
                OR ( nbrbjob_end_date >= par_effective_date
                     AND par_status = 'T'));
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
IF par_pidm IS NOT NULL THEN
   OPEN supv_cursor;
   FETCH supv_cursor INTO par_title ;
--
   IF supv_cursor%NOTFOUND THEN
      IF exe_source = 'FORM' THEN
         msg := '*ERROR* Invalid Supervisor Posn and Suffix; ' ||
                'Press list for Positions.';
      ELSE
         msg := '*ERROR* Invalid Supervisor Position and Suffix.';
      END IF;
      msg_type := 'E';
      RETURN;
   END IF ;
END IF;
--
END ;
/


DROP PUBLIC SYNONYM P_EDIT_JOB_SUPERVISOR;

CREATE PUBLIC SYNONYM P_EDIT_JOB_SUPERVISOR FOR BANINST1.P_EDIT_JOB_SUPERVISOR;


GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO PAYROLL;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_JOB_SUPERVISOR TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_LCAT_ECLS_CODE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_lcat_ecls_code
     (par_lcat_code    IN  varchar2,
      par_ecls_code    IN  varchar2,
      par_desc     IN OUT  varchar2,
      exe_source       IN  varchar2,
      msg             OUT  varchar2,
      msg_type        OUT  varchar2)
IS
--
-- FILE NAME..: noplcat.sql
-- RELEASE....: 6.0
-- OBJECT NAME: P_EDIT_LCAT_ECLS_CODE
-- PRODUCT....: POSNCTL
-- USAGE......: Validation of the Leave Category Code entered.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates the Leave Category Code entered.
--
-- DESCRIPTION END
--
    ptreclc_rec  nokrecs.ptreclc_rectype;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
IF par_lcat_code is null
THEN
   msg := '*ERROR* Leave Category Code must be entered.';
   msg_type := 'E';
ELSE
    ptreclc_rec := nokrecs.f_ptreclc_rec (par_ecls_code, par_lcat_code);
    IF ptreclc_rec.attr.notfound  THEN
        msg := '*ERROR* Invalid Leave Category Code for this employee ' ||
               'class.';
        msg_type := 'E';
   ELSE
     nokp3lb.p_edit_lcat_code(par_lcat_code,exe_source,par_desc,
                              msg,msg_type);
   END IF;
END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_LCAT_ECLS_CODE;

CREATE PUBLIC SYNONYM P_EDIT_LCAT_ECLS_CODE FOR BANINST1.P_EDIT_LCAT_ECLS_CODE;


GRANT EXECUTE ON BANINST1.P_EDIT_LCAT_ECLS_CODE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_LCAT_ECLS_CODE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_LCAT_ECLS_CODE TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_EDIT_LCAT_ECLS_CODE TO BANIMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_LCAT_ECLS_CODE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_LCAT_ECLS_CODE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_LCAT_ECLS_CODE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_LCAT_ECLS_CODE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_LCAT_ECLS_CODE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_LCAT_ECLS_CODE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_LCAT_ECLS_CODE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_LOA;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_loa
     (par_pebempl_loa_beg_date IN  date,
      par_pebempl_loa_end_date IN  date,
      par_pebempl_lrea_code    IN  varchar2,
      par_pebempl_status  IN  varchar2,
      par_pidm                 IN  number,
      par_trans_no             IN  number,
      par_exe_source           IN  varchar2,
      msg                      OUT varchar2,
      msg_type                 OUT varchar2)
IS
--
-- FILE NAME..: noplvbd.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_LOA
-- PRODUCT....: POSNCTL
-- USAGE......: Perform various leave of absence information edits after all
--              leave fields have been entered on PEAEMPL.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure performs various leave of absence information edits after all
-- leave fields have been entered on PEAEMPL.
--
-- DESCRIPTION END
--
   var_dummy      varchar2(1) := NULL;
   var_posn       varchar2(6) := NULL;
   var_suff       varchar2(2) := NULL;
--
     CURSOR PTI_CURSOR IS
        SELECT  nbrbjob_posn, nbrbjob_suff
        FROM  nbrbjob,
        NBRJOBS X
        WHERE   NBRJOBS_PIDM = par_pidm
        AND    NBRBJOB_PIDM = NBRJOBS_PIDM
        AND    NBRBJOB_POSN = NBRJOBS_POSN
        AND    NBRBJOB_SUFF = NBRJOBS_SUFF
        AND    (nbrbjob_end_date >= par_pebempl_loa_beg_date
                OR nbrbjob_end_date IS NULL)
        AND    (
                nbrjobs_pers_chg_date =
                   (SELECT MAX(nbrjobs_pers_chg_date)
                    FROM   nbrjobs
                    WHERE  nbrjobs_pidm = X.nbrjobs_pidm
                    AND    nbrjobs_posn = X.nbrjobs_posn
                    AND    nbrjobs_suff = X.nbrjobs_suff
                    AND    nbrjobs_pers_chg_date <= par_pebempl_loa_beg_date)
                           OR   (nbrjobs_pers_chg_date > par_pebempl_loa_beg_date
                    AND    nbrjobs_pers_chg_date <=  NVL(
                           par_pebempl_loa_end_date, TO_DATE(G$_DATE.NORMALISE_GREG_DATE('31-12-4712', 'DD-MM-YYYY'),
                           G$_DATE.GET_NLS_DATE_FORMAT)) ) )
                    AND    NBRJOBS_STATUS = 'A' ;
--
     CURSOR check_paf_leave
     IS
     SELECT 'X'
     FROM nortran F
     WHERE F.nortran_transaction_no = par_trans_no
       AND F.nortran_aufd_code = 'NBRJOBS_STATUS'
       AND F.nortran_value IN ('B','L','F','P')
       AND F.nortran_posn = var_posn
       AND F.nortran_suff = var_suff
       AND EXISTS
         (SELECT 'X'
          FROM   nortran D
          WHERE  D.nortran_transaction_no = par_trans_no
          AND  D.nortran_posn = var_posn
          AND  D.nortran_suff = var_suff
          AND  ((D.nortran_aufd_code = 'NBRJOBS_EFFECTIVE_DATE'
                 AND to_date(D.nortran_value,G$_DATE.GET_NLS_DATE_FORMAT)
                     <= par_pebempl_loa_beg_date)
               OR (D.nortran_aufd_code = 'NBRJOBS_PERS_CHG_DATE'
                 AND to_date(D.nortran_value,G$_DATE.GET_NLS_DATE_FORMAT)
                     <= par_pebempl_loa_beg_date)));
--
     CURSOR check_for_active_leave_reason
     IS
     SELECT 'X'
     FROM ptrlrea
     where ptrlrea_status = 'A'
     and   ptrlrea_code =
           (SELECT nortran_value
            FROM   nortran
            WHERE  nortran_transaction_no = par_trans_no
            AND    nortran_aufd_code = 'PEBEMPL_LREA_CODE');
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF (par_pebempl_lrea_code IS NOT NULL AND
       par_pebempl_loa_beg_date IS NULL)  OR
      (par_pebempl_lrea_code IS NULL AND
       par_pebempl_loa_beg_date IS NOT NULL) THEN
      msg :=  G$_NLS.Get('NOPLVBD-0004', 'SQL','*ERROR* Leave of Absence information is incomplete.') ;
      msg_type := 'E';
      RETURN;
   END IF;
--
   IF par_pebempl_status in ('L','B','F','P') THEN
      IF par_pebempl_loa_beg_date IS NULL THEN
         msg :=  G$_NLS.Get('NOPLVBD-0005', 'SQL','*ERROR* Leave Begin Date Must Be Entered When the Status is L,B,F, or P.')
                ;
         msg_type := 'E';
         RETURN;
      END IF;
   END IF;
--
   IF par_pebempl_loa_end_date IS NOT NULL
      AND (par_pebempl_loa_beg_date > par_pebempl_loa_end_date) THEN
        msg :=  G$_NLS.Get('NOPLVBD-0006', 'SQL','*ERROR* Leave of Absence End Date must be >= to the Begin Date.')
               ;
        msg_type := 'E';
      RETURN;
   END IF;
--
   IF par_pebempl_lrea_code IS NOT NULL
      AND par_pebempl_loa_beg_date IS NOT NULL THEN
      OPEN check_for_active_leave_reason;
      FETCH check_for_active_leave_reason INTO var_dummy;
      IF check_for_active_leave_reason%NOTFOUND THEN
         OPEN PTI_CURSOR;
--       OPEN check_paf_leave;
         LOOP
         FETCH PTI_CURSOR INTO var_posn, var_suff;
         EXIT WHEN PTI_CURSOR%NOTFOUND;
         IF PTI_CURSOR%FOUND THEN
            IF par_exe_source IN ('PAF','MASS') THEN
               OPEN check_paf_leave;
               FETCH check_paf_leave INTO var_dummy;
               IF check_paf_leave%NOTFOUND THEN
                  msg :=  G$_NLS.Get('NOPLVBD-0009', 'SQL','*ERROR* Update Job(s) Status before entering leave information.')
                         ;
                  msg_type := 'E';
                  CLOSE check_paf_leave;
                  CLOSE PTI_CURSOR;
                  CLOSE check_for_active_leave_reason;
                  RETURN;
               ELSE
                  CLOSE check_paf_leave;
               END IF;
            ELSE
               msg :=  G$_NLS.Get('NOPLVBD-0010', 'SQL','*ERROR* Update Job(s) Status before entering leave information.')
                      ;
               msg_type := 'E';
--               CLOSE check_paf_leave;
               CLOSE PTI_CURSOR;
               CLOSE check_for_active_leave_reason;
               RETURN;
            END IF;
         END IF;
         END LOOP;
--         CLOSE check_paf_leave;
         CLOSE PTI_CURSOR;
      END IF; /* check_for_active_leave_reason */
      CLOSE check_for_active_leave_reason;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_LOA;

CREATE PUBLIC SYNONYM P_EDIT_LOA FOR BANINST1.P_EDIT_LOA;


GRANT EXECUTE ON BANINST1.P_EDIT_LOA TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_LOA TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_LOA TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_LOA TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_LOA TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_LOA TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_LOA TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_LOA TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_LOA TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_LOA TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_LOA TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_LOA TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_LOA TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_LOA TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_LOA TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_LOA TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_LOA TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrbjob_begin_date
     (par_job_begin_date        IN      date,
      par_job_end_date          IN      date,
      par_jobs_effective_date   IN      date,
      par_min_jobs_eff_date     IN      date,
      par_posn_begin_date       IN      date,
      par_posn_end_date         IN      date,
      par_empl_term_date        IN      date,
      msg                       OUT     VARCHAR2,
      msg_type                  OUT     VARCHAR2,
      edit_num                  IN OUT  NUMBER)
IS
--
-- FILE NAME..: nopejbd.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRBJOB_BEGIN_DATE
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edits on job begin date.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure performs edits on the job begin date against job effective
-- date, job end date, position date, and employee termination date.
--
-- DESCRIPTION END
--
--
      end_edit   NUMBER := 99;
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_job_begin_date IS NULL THEN
      edit_num := end_edit;
      msg :=  G$_NLS.Get('NOPEJBD-0000', 'SQL','*ERROR* Base Job Begin Date must be entered.') ;
      msg_type := 'E';
      RETURN;
   END IF;
--
   IF edit_num = 1 THEN
      edit_num := edit_num + 1;
      IF par_jobs_effective_date IS NOT NULL THEN
         IF par_job_begin_date > par_jobs_effective_date THEN
            msg :=   G$_NLS.Get('NOPEJBD-0001', 'SQL','*ERROR* Begin Date cannot be later than Jobs Effective Date.')
                    ;
            msg_type := 'E';
            RETURN;
         END IF ;
      END IF ;
   END IF ;
--
   IF edit_num = 2 THEN
      edit_num := edit_num + 1;
      IF par_job_end_date IS NOT NULL THEN
         IF par_job_begin_date > par_job_end_date THEN
            msg :=  G$_NLS.Get('NOPEJBD-0002', 'SQL','*ERROR* End Date must be later than Begin Date.') ;
            msg_type := 'E';
            RETURN;
         END IF ;
      END IF ;
   END IF ;
--
   IF edit_num = 3 THEN
      edit_num := edit_num + 1;
      IF par_posn_begin_date IS NOT NULL THEN
         IF par_job_begin_date < par_posn_begin_date THEN
            msg :=  G$_NLS.Get('NOPEJBD-0003', 'SQL','*ERROR* Base Job cannot begin before the position. Check position dates.')
                   ;
            msg_type := 'E';
            RETURN;
         END IF ;
      END IF ;
   END IF ;
--
   IF edit_num = 4 THEN
      edit_num := edit_num + 1;
      IF par_posn_end_date IS NOT NULL THEN
         IF par_job_begin_date > par_posn_end_date THEN
            msg :=  G$_NLS.Get('NOPEJBD-0004', 'SQL','*ERROR* Base Job Begin Date cannot be after position end date.')
                   ;
            msg_type := 'E';
            RETURN;
         END IF ;
      END IF ;
   END IF ;
--
   IF edit_num = 5 THEN
      edit_num := edit_num + 1;
      IF par_empl_term_date IS NOT NULL THEN
         IF par_empl_term_date < par_job_begin_date THEN
            msg :=  G$_NLS.Get('NOPEJBD-0005', 'SQL','*ERROR* Job Begin Date cannot be after Employee''s Termination Date.')
                   ;
            msg_type := 'E';
            RETURN;
         END IF;
      END IF;
   END IF;
--
   IF edit_num = 6 THEN
      edit_num := end_edit;
      IF par_min_jobs_eff_date IS NOT NULL THEN
         IF par_job_begin_date  <>  par_min_jobs_eff_date THEN
            msg :=  G$_NLS.Get('NOPEJBD-0006', 'SQL','*ERROR* Begin Date must equal the first Jobs Detail Effective Date.')
                   ;
            msg_type := 'E';
            RETURN;
         END IF ;
      END IF ;
   END IF ;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRBJOB_BEGIN_DATE;

CREATE PUBLIC SYNONYM P_EDIT_NBRBJOB_BEGIN_DATE FOR BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_BEGIN_DATE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrbjob_contract_dates
  (par_contract_begin_date  IN      nbrbjob.nbrbjob_contract_begin_date%TYPE,
   par_contract_end_date    IN      nbrbjob.nbrbjob_contract_end_date%TYPE,
   par_base_job_begin_date  IN      nbrbjob.nbrbjob_begin_date%TYPE,
   par_base_job_end_date    IN      nbrbjob.nbrbjob_end_date%TYPE,
   msg                      OUT     VARCHAR2,
   msg_type                 OUT     VARCHAR2,
   edit_num                 IN OUT  NUMBER)
IS
--
-- FILE NAME..: nopctdt.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRBJOB_CONTRACT_DATES
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edits on job contract dates.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure perform edits on the job contract dates against the
-- base job begin and end dates in the Assignment Repeating Base table
-- (NBRBJOB).
--
-- DESCRIPTION END
--
--
      end_edit   NUMBER := 99;
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_contract_begin_date IS NULL AND par_contract_end_date IS NULL THEN
      edit_num := end_edit;
      RETURN;
   END IF;
--
   IF par_contract_begin_date IS NULL THEN
      IF par_contract_end_date IS NOT NULL THEN
         edit_num := end_edit;
         msg :=  G$_NLS.Get('NOPCTDT-0000', 'SQL','*ERROR* Contract Start and End Dates must both exist.') ;
         msg_type := 'E';
         RETURN;
      END IF ;
   ELSE
      IF par_contract_end_date IS NULL THEN
         edit_num := end_edit;
         msg :=  G$_NLS.Get('NOPCTDT-0001', 'SQL','*ERROR* Contract Start and End Dates must both exist.') ;
         msg_type := 'E';
         RETURN;
      END IF ;
   END IF ;
--
   IF edit_num = 1 THEN
      edit_num := edit_num + 1;
      IF par_contract_end_date IS NOT NULL THEN
         IF par_contract_begin_date > par_contract_end_date THEN
            msg :=  G$_NLS.Get('NOPCTDT-0002', 'SQL','*ERROR* Contract Start Date must be earlier than Contract End Date.')
                   ;
            msg_type := 'E';
            RETURN;
         END IF;
      END IF;
   END IF;
--
   IF edit_num = 2 THEN
      edit_num := edit_num + 1;
      IF par_base_job_end_date IS NOT NULL
       AND par_contract_end_date IS NOT NULL THEN
         IF par_contract_end_date > par_base_job_end_date THEN
            msg :=  G$_NLS.Get('NOPCTDT-0003', 'SQL','*ERROR* Contract End Date must not be later than Base Job End Date.')
                   ;
            msg_type := 'E';
            RETURN;
         END IF;
      END IF;
   END IF;
--
   IF edit_num = 3 THEN
      edit_num := end_edit;
      IF par_contract_begin_date IS NOT NULL THEN
         IF par_contract_begin_date < par_base_job_begin_date THEN
            msg :=  G$_NLS.Get('NOPCTDT-0004', 'SQL','*ERROR* Contract Begin Date must not be prior to the Base Job Begin Date.')
                   ;
            msg_type := 'E';
            RETURN;
         END IF;
      END IF;
   END IF;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRBJOB_CONTRACT_DATES;

CREATE PUBLIC SYNONYM P_EDIT_NBRBJOB_CONTRACT_DATES FOR BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_DATES TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRBJOB_CONTRACT_END;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrbjob_contract_end
 (par_contract_end_date    IN      nbrbjob.nbrbjob_contract_end_date%TYPE,
  par_posn_end_date        IN      nbbposn.nbbposn_end_date%TYPE,
  msg                      OUT     noreaer.noreaer_error_msg%TYPE,
  msg_type                 OUT     noreaer.noreaer_msg_type%TYPE)
--
IS
--
-- FILE NAME..: nopeced.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRBJOB_CONTRACT_END
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edit on job contract end date.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure performs edit on job contract end date.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_contract_end_date IS NULL THEN
      RETURN;
   END IF;
--
   IF par_posn_end_date IS NOT NULL THEN
      IF par_contract_end_date > par_posn_end_date THEN
         msg :=  G$_NLS.Get('NOPECED-0000', 'SQL','*ERROR* Contract End Date cannot be after Position End Date.')
                ;
         msg_type := 'E';
      END IF ;
   END IF ;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRBJOB_CONTRACT_END;

CREATE PUBLIC SYNONYM P_EDIT_NBRBJOB_CONTRACT_END FOR BANINST1.P_EDIT_NBRBJOB_CONTRACT_END;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_END TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_END TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_END TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_END TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_END TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_END TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_END TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_END TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_END TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_END TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_END TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_END TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_END TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_END TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_END TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_END TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_END TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRBJOB_CONTRACT_START;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrbjob_contract_start
     (par_contract_begin_date  IN      nbrbjob.nbrbjob_contract_begin_date%TYPE,
      par_posn_begin_date      IN      nbbposn.nbbposn_begin_date%TYPE,
      par_posn_end_date        IN      nbbposn.nbbposn_end_date%TYPE,
      edit_num                 IN OUT  NUMBER,
      msg                      OUT     noreaer.noreaer_error_msg%TYPE,
      msg_type                 OUT     noreaer.noreaer_msg_type%TYPE)
IS
--
-- FILE NAME..: nopecbd.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRBJOB_CONTRACT_START
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edit on job contract begin date.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure peform edit on job contract begin date.
--
-- DESCRIPTION END
--
      end_edit   NUMBER := 99;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_contract_begin_date IS NULL THEN
      edit_num := end_edit;
      RETURN;
   END IF;
--
   IF edit_num = 1 THEN
      edit_num := edit_num + 1;
      IF par_posn_begin_date IS NOT NULL THEN
         IF par_contract_begin_date < par_posn_begin_date THEN
            msg :=  G$_NLS.Get('NOPECBD-0000', 'SQL','*ERROR* Contract Start Date cannot be prior to Position Begin Date.')
                   ;
            msg_type := 'E';
            RETURN;
         END IF ;
      END IF ;
   END IF ;
--
   IF edit_num = 2 THEN
      edit_num := end_edit;
      IF par_posn_end_date IS NOT NULL THEN
         IF par_contract_begin_date > par_posn_end_date THEN
            msg :=  G$_NLS.Get('NOPECBD-0001', 'SQL','*ERROR* Contract Start Date cannot be after Position End Date.')
                   ;
            msg_type := 'E';
            RETURN;
         END IF ;
      END IF ;
   END IF ;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRBJOB_CONTRACT_START;

CREATE PUBLIC SYNONYM P_EDIT_NBRBJOB_CONTRACT_START FOR BANINST1.P_EDIT_NBRBJOB_CONTRACT_START;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_START TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_START TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_START TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_START TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_START TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_START TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_START TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_START TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_START TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_START TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_START TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_START TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_START TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_START TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_START TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_START TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_CONTRACT_START TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRBJOB_ELIGIBLE_DATE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrbjob_eligible_date
       (par_eligible_date     IN nbrbjob.nbrbjob_eligible_date%TYPE,
        par_begin_date        IN nbrbjob.nbrbjob_begin_date%TYPE,
        msg                   OUT  varchar2,
        msg_type              OUT  varchar2 )
IS
--
-- FILE NAME..: nopeeld.sql
-- RELEASE....: 6.0
-- OBJECT NAME: P_EDIT_NBRBJOB_ELIGIBLE_DATE
-- PRODUCT....: POSNCTL
-- USAGE......: Contains edit(s) for the nbrjobs_eligible_date field.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- Contains edit(s) for the nbrbjob_eligible_date field.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_eligible_date IS NULL THEN
      RETURN;
   END IF;
--
   IF par_eligible_date < par_begin_date THEN
         msg := '*ERROR* Eligible Date must be later than Begin Date.';
         msg_type := 'E';
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRBJOB_ELIGIBLE_DATE;

CREATE PUBLIC SYNONYM P_EDIT_NBRBJOB_ELIGIBLE_DATE FOR BANINST1.P_EDIT_NBRBJOB_ELIGIBLE_DATE;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_ELIGIBLE_DATE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_ELIGIBLE_DATE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_ELIGIBLE_DATE TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_ELIGIBLE_DATE TO BANIMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_ELIGIBLE_DATE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_ELIGIBLE_DATE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_ELIGIBLE_DATE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_ELIGIBLE_DATE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_ELIGIBLE_DATE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_ELIGIBLE_DATE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_ELIGIBLE_DATE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRBJOB_END_DATE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrbjob_end_date
     (par_job_begin_date        IN      date,
      par_job_end_date          IN      date,
      par_pidm                  IN      number,
      par_posn                  IN      varchar2,
      par_suff                  IN      varchar2,
      par_posn_end_date         IN      date,
      par_empl_term_date        IN      date,
      par_last_paid_date        IN      date,
      par_jobs_eff_date         IN      date,
      par_jobs_status           IN      varchar2,
      par_react_flag            IN      varchar2,
      edit_num                  IN OUT  number,
      msg                       OUT     varchar2,
      msg_type                  OUT     varchar2)
IS
--
-- FILE NAME..: nopejed.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRBJOB_END_DATE
-- PRODUCT....: POSNCTL
-- USAGE......: Edit base job end date.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure edits base job end date.
--
-- DESCRIPTION END
--
      end_edit   NUMBER := 99;
--
   FUNCTION f_check_db(
      par_pidm       IN number,
      par_posn       IN varchar2,
      par_suff       IN varchar2,
      par_eff_date   IN date)
      RETURN BOOLEAN
   IS
      CURSOR check_db
      IS
      SELECT 'X'
      FROM nbrjobs
      WHERE nbrjobs_pidm = par_pidm
        AND nbrjobs_posn = par_posn
        AND nbrjobs_suff = par_suff
        AND nbrjobs_effective_date = par_jobs_eff_date
        AND nbrjobs_status = 'T';
   BEGIN
      OPEN check_db;
      IF check_db%FOUND THEN
         CLOSE check_db;
         RETURN TRUE;
      ELSE
         CLOSE check_db;
         RETURN FALSE;
      END IF;
   END;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
 IF par_job_end_date IS NOT NULL THEN
   IF edit_num = 1 THEN
      edit_num := edit_num + 1;
      IF par_posn_end_date IS NOT NULL THEN
         IF par_job_end_date > par_posn_end_date THEN
          msg :=  G$_NLS.Get('NOPEJED-0000', 'SQL','*ERROR* Base Job End Date cannot be after Position End Date.') ;
            msg_type := 'E';
            RETURN;
         ELSIF par_react_flag = 'Y' THEN
            msg :=  G$_NLS.Get('NOPEJED-0001', 'SQL','*WARNING* Position End Date from Position Budget Form was redefaulted.')
                   ;
            msg_type := 'W';
            RETURN;
         END IF ;
      END IF ;
   END IF ;
--
   IF edit_num = 2 THEN
      edit_num := edit_num + 1;
         IF f_edit_jobs_dates (par_pidm, par_posn, par_suff, par_job_end_date)
            THEN
         msg :=  G$_NLS.Get('NOPEJED-0002', 'SQL','*ERROR* The future dated Job record must be deleted before ending Job.')
                   ;
            msg_type := 'E';
            RETURN;
         END IF ;
   END IF ;
--
   IF edit_num = 3 THEN
      edit_num := edit_num + 1;
      IF par_job_begin_date IS NOT NULL THEN
         IF par_job_begin_date > par_job_end_date THEN
            msg :=  G$_NLS.Get('NOPEJED-0003', 'SQL','*ERROR* End Date must be later than Begin Date.') ;
            msg_type := 'E';
            RETURN;
         END IF ;
      END IF;
   END IF ;
--
   IF edit_num = 4 THEN
      edit_num := end_edit;
      IF par_posn_end_date IS NULL THEN
         IF NOT ((par_jobs_eff_date = par_job_end_date AND
             par_jobs_status = 'T') OR
             f_check_db(par_pidm,par_posn,par_suff,par_job_end_date)) THEN
            msg :=  G$_NLS.Get('NOPEJED-0004', 'SQL','*ERROR* Job detail record must be terminated with effective date = end date.')
                   ;
            msg_type := 'E';
            RETURN;
         END IF;
      END IF;
   END IF;
 ELSE
     /*
     || If the end date is removed, check term info on PEAEMPL. Following
     || logic will force both messages to be displayed if the empl term
     || date is not null.
     */
   IF par_empl_term_date IS NOT NULL THEN
      IF edit_num = 1 THEN
         edit_num := edit_num + 1;
         msg :=  G$_NLS.Get('NOPEJED-0005', 'SQL','*WARNING* This employee is terminated on the Employee Form.') ;
         msg_type := 'W';
         RETURN;
      END IF;
   --
      IF edit_num = 2 THEN
         edit_num := end_edit;
         msg :=  G$_NLS.Get('NOPEJED-0006', 'SQL','*WARNING* The Employee''s Term Date and Reason should be removed from PEAEMPL.')
                ;
         msg_type := 'W';
         RETURN;
      END IF;
   ELSE
      edit_num := end_edit;
   END IF;
 END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRBJOB_END_DATE;

CREATE PUBLIC SYNONYM P_EDIT_NBRBJOB_END_DATE FOR BANINST1.P_EDIT_NBRBJOB_END_DATE;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_END_DATE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_END_DATE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_END_DATE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_END_DATE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_END_DATE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_END_DATE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_END_DATE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_END_DATE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_END_DATE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_END_DATE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_END_DATE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_END_DATE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_END_DATE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_END_DATE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_END_DATE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_END_DATE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_END_DATE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrbjob_ipeds_rept_ind
     (par_eeog_code            IN      VARCHAR2,
      par_ipeds_rept_ind       IN      nbrbjob.nbrbjob_ipeds_rept_ind%TYPE,
      par_job_type             IN      nbrbjob.nbrbjob_contract_type%TYPE,
      par_location             IN      ntrinst.ntrinst_location_ind%TYPE,
      par_empr_ind             IN      gubinst.gubinst_highed_govt_ind%TYPE,
      msg                      OUT     noreaer.noreaer_error_msg%TYPE,
      msg_type                 IN OUT     noreaer.noreaer_msg_type%TYPE)
IS
--
-- FILE NAME..: nopipex.sql
-- RELEASE....: 4.2.1
-- OBJECT NAME: P_EDIT_NBRBJOB_IPEDS_REPT_IND
-- PRODUCT....: POSNCTL
-- USAGE......: Validate the existence of the NBRBJOB IPEDS Report Indicator.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This Procedure to validates the existence of the NBRBJOB IPEDS Report
-- Indicator. Indicator must be 'Y' when job type is primary.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_ipeds_rept_ind IS NULL THEN
      msg :=  G$_NLS.Get('NOPIPEX-0000', 'SQL','*ERROR* IPEDS Reporting Indicator must be entered.') ;
      msg_type := 'E';
      RETURN;
   END IF;
--
  IF par_location = 'U' AND par_job_type = 'P'
     AND NVL(par_ipeds_rept_ind, 'N') <> 'Y'
     AND par_empr_ind = 'H'
     AND par_eeog_code IN ('1','2','3','4','5') THEN
     msg :=  G$_NLS.Get('NOPIPEX-0001', 'SQL','*ERROR* IPEDS Reporting Ind must be ''Y''es when Job Type is primary.')
            ;
     msg_type := 'E';
  END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRBJOB_IPEDS_REPT_IND;

CREATE PUBLIC SYNONYM P_EDIT_NBRBJOB_IPEDS_REPT_IND FOR BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_IPEDS_REPT_IND TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRBJOB_PROBATION_INFO;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrbjob_probation_info
  (par_probation_begin_date IN      nbrbjob.nbrbjob_probation_begin_date%TYPE,
   par_probation_units      IN      nbrbjob.nbrbjob_probation_units%TYPE,
   par_probation_end_date   IN      nbrbjob.nbrbjob_probation_end_date%TYPE,
   par_ntrinst_unit_ind     IN      ntrinst.ntrinst_probation_unit_ind%TYPE,
   msg                      OUT     VARCHAR2,
   msg_type                 OUT     VARCHAR2,
   edit_num                 IN OUT  NUMBER)
IS
--
-- FILE NAME..: nopprob.sql
-- RELEASE....: 5.3
-- OBJECT NAME: P_EDIT_NBRBJOB_PROBATION_INFO
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edits on probation dates and units.
-- COPYRIGHT..: Copyright (C) SCT Corporation 2001.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure perform edits on the probation dates and units on base job
-- information.
--
-- DESCRIPTION END
--
   end_edit   NUMBER := 99;

BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_probation_begin_date IS NULL
      AND par_probation_units IS NULL
      AND par_probation_end_date IS NULL THEN
      edit_num := end_edit;
      RETURN;
   END IF;
--
   IF edit_num = 1 THEN
      edit_num := edit_num + 1;
      IF (par_probation_units IS NULL
            AND (par_probation_begin_date IS NOT NULL
                 OR par_probation_end_date IS NOT NULL))
         OR (par_probation_begin_date IS NULL
	    AND (par_probation_units IS NOT NULL
                 OR par_probation_end_date IS NOT NULL))
         OR (par_probation_end_date IS NULL
      	    AND (par_probation_units IS NOT NULL
                 OR par_probation_begin_date IS NOT NULL)) THEN
         edit_num := end_edit;
         msg := '*ERROR* Probation period, begin date, end date must all be valued or null.';
         msg_type := 'E';
         RETURN;
      END IF;
   END IF ;
--
   IF edit_num = 2 THEN
      edit_num := edit_num + 1;
      IF par_probation_units IS NOT NULL THEN
         IF par_ntrinst_unit_ind = 'D' THEN
            IF par_probation_units <=0 OR par_probation_units >999 THEN
               edit_num := end_edit;
               msg := '*ERROR* Probationary Period is set to Days on NTRINST, value can be 1-999.';
               msg_type := 'E';
               RETURN;
            END IF;
         ELSE
            IF par_probation_units <= 0 OR par_probation_units >99 THEN
               edit_num := end_edit;
               msg := '*ERROR* Probationary Period is set to Months on NTRINST, value can be 1-99.';
               msg_type := 'E';
               RETURN;
            END IF;
         END IF;
      END IF;
   END IF;

   IF edit_num = 3 THEN
      edit_num := end_edit;
      IF par_probation_end_date IS NOT NULL AND
         par_probation_begin_date IS NOT NULL AND
         par_probation_begin_date > par_probation_end_date THEN
         msg := '*ERROR* Probation End Date must be greater than ' ||
                   'Probation Begin Date.';
         msg_type := 'E';
         RETURN;
      END IF;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRBJOB_PROBATION_INFO;

CREATE PUBLIC SYNONYM P_EDIT_NBRBJOB_PROBATION_INFO FOR BANINST1.P_EDIT_NBRBJOB_PROBATION_INFO;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_PROBATION_INFO TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_PROBATION_INFO TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_PROBATION_INFO TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_PROBATION_INFO TO BANIMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_PROBATION_INFO TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_PROBATION_INFO TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_PROBATION_INFO TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_PROBATION_INFO TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_PROBATION_INFO TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_PROBATION_INFO TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_PROBATION_INFO TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrbjob_salary_encum
     (par_enc_method   IN  varchar2,
      msg             OUT  VARCHAR2,
      msg_type        OUT  VARCHAR2)
IS
--
-- FILE NAME..: nopseex.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRBJOB_SALARY_ENCUM
-- PRODUCT....: POSNCTL
-- USAGE......: Issue error message based on salary encumbrance method.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure issues an error message when salary encumbrance method is
-- not 'Value Input'.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_enc_method <> 'V' THEN
      msg :=   G$_NLS.Get('NOPSEEX-0000', 'SQL','*ERROR* Salary Encumbrance cannot be entered.') ;
      msg_type := 'E';
      RETURN;
   END IF;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRBJOB_SALARY_ENCUM;

CREATE PUBLIC SYNONYM P_EDIT_NBRBJOB_SALARY_ENCUM FOR BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_SALARY_ENCUM TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrbjob_step_incr_day
     (par_step_incr_mon  IN      nbrbjob.nbrbjob_step_incr_mon%TYPE,
      par_step_incr_day  IN      nbrbjob.nbrbjob_step_incr_day%TYPE,
      edit_num           IN OUT  NUMBER,
      msg                OUT     noreaer.noreaer_error_msg%TYPE,
      msg_type           OUT     noreaer.noreaer_msg_type%TYPE)
IS
--
-- FILE NAME..:  nopesid.sql
-- RELEASE....:  4.1
-- OBJECT NAME:  P_EDIT_NBRBJOB_STEP_INCR_DAY
-- PRODUCT....:  POSNCTL
-- USAGE......:  Procedure to edit step increase day.
--
-- COPYRIGHT..:  Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- Edit - Procedure to edit step increase day.
--
-- DESCRIPTION END
--
--
      end_edit   NUMBER := 99;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_step_incr_day IS NULL THEN
      edit_num := end_edit;
      RETURN;
   END IF;
--
   IF edit_num = 1 THEN
      edit_num := edit_num + 1;
      IF par_step_incr_mon IS NULL THEN
         msg :=  G$_NLS.Get('NOPESID-0000', 'SQL','*ERROR* Step Increase Month cannot be null if  Step Increase Day is valued.')
                ;
         msg_type := 'E';
         RETURN;
      END IF;
   END IF;
--
   IF edit_num = 2 THEN
      edit_num := edit_num + 1;
      IF TO_NUMBER(par_step_incr_day) < 1
       OR TO_NUMBER(par_step_incr_day) > 31 THEN
         msg :=  G$_NLS.Get('NOPESID-0001', 'SQL','*ERROR* Step Increase Day; Valid Values are 1 to 31.') ;
         msg_type := 'E';
         RETURN;
      END IF;
   END IF;
--
   IF edit_num = 3 THEN
      edit_num := edit_num + 1;
      IF par_step_incr_mon IN ( '2', '02', ' 2' ) THEN
         IF par_step_incr_day = '29' THEN
            msg :=  G$_NLS.Get('NOPESID-0005', 'SQL','*ERROR* Day limit for February is ''28''.')  ;
            msg_type := 'E';
            RETURN;
         ELSIF par_step_incr_day = '30' THEN
            msg :=  G$_NLS.Get('NOPESID-0007', 'SQL','*ERROR* Day limit for February is ''28''.')  ;
            msg_type := 'E';
            RETURN;
         ELSIF par_step_incr_day = '31' THEN
            msg :=  G$_NLS.Get('NOPESID-0009', 'SQL','*ERROR* Day limit for February is ''28''.')  ;
            msg_type := 'E';
            RETURN;
         END IF ;
      END IF ;
   END IF ;
--
   IF edit_num = 4 THEN
      edit_num := end_edit;
      IF par_step_incr_mon IN ( '04', '06', '09', '4', '6', '9',
                                '11', ' 4', ' 6', ' 9' ) THEN
         IF par_step_incr_day = '31' THEN
            msg :=  G$_NLS.Get('NOPESID-0018', 'SQL','*ERROR* Day is not valid for month specified.') ;
            msg_type := 'E';
            RETURN;
         END IF ;
      END IF ;
   END IF ;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRBJOB_STEP_INCR_DAY;

CREATE PUBLIC SYNONYM P_EDIT_NBRBJOB_STEP_INCR_DAY FOR BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_DAY TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrbjob_step_incr_mon
     (par_step_incr_mon  IN      varchar2,
      msg                OUT     varchar2,
      msg_type           OUT     varchar2)
IS
--
-- FILE NAME..:  nopesim.sql
-- RELEASE....:  4.1
-- OBJECT NAME:  P_EDIT_NBRBJOB_STEP_INCR_MON
-- PRODUCT....:  POSNCTL
-- USAGE......:  Procedure to edit step increase month.
--
-- COPYRIGHT..:  Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- Edit - Procedure to edit step increase month.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_step_incr_mon IS NULL THEN
      RETURN;
   END IF;
--
   IF TO_NUMBER(par_step_incr_mon) < 1
      OR TO_NUMBER(par_step_incr_mon) > 12 THEN
      msg :=  G$_NLS.Get('NOPESIM-0000', 'SQL','*ERROR* Step Increase Month; Valid Values are 1 to 12.') ;
      msg_type := 'E';
   END IF;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRBJOB_STEP_INCR_MON;

CREATE PUBLIC SYNONYM P_EDIT_NBRBJOB_STEP_INCR_MON FOR BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRBJOB_STEP_INCR_MON TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBREARN_CANCEL_DATE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrearn_cancel_date
     (par_hr_installed_ind   IN      gubinst.gubinst_humanre_installed%TYPE,
      par_pidm               IN      nbrbjob.nbrbjob_pidm%TYPE,
      par_posn               IN      nbrbjob.nbrbjob_posn%TYPE,
      par_suff               IN      nbrbjob.nbrbjob_suff%TYPE,
      par_earn_code          IN      nbrearn.nbrearn_earn_code%TYPE,
      par_base_earn_code     IN      nbrearn.nbrearn_earn_code%TYPE,
      par_earn_eff_date      IN      nbrearn.nbrearn_effective_date%TYPE,
      par_cancel_date        IN      nbrearn.nbrearn_effective_date%TYPE,
      par_hold_earn_date     IN      nbrearn.nbrearn_effective_date%TYPE,
      par_earn_query_date    IN      nbrearn.nbrearn_effective_date%TYPE,
      par_last_paid_date     IN      nbrearn.nbrearn_effective_date%TYPE,
      msg                    OUT     noreaer.noreaer_error_msg%TYPE,
      msg_type               OUT     noreaer.noreaer_msg_type%TYPE,
      edit_num               IN OUT  NUMBER)
IS
--
-- FILE NAME..: nopcndt.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBREARN_CANCEL_DATE
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edits on end dates.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure performs edits on end dates based on edit number specified
-- by user.
--
-- DESCRIPTION END
--
--
      end_edit   NUMBER := 99;
      temp       VARCHAR2(1);
--
      CURSOR earn_cursor IS
         SELECT 'X'
         FROM   nbrearn
         WHERE  nbrearn_pidm        =  par_pidm
           AND  nbrearn_posn        =  par_posn
           AND  nbrearn_suff        =  par_suff
           AND  nbrearn_earn_code   =  par_earn_code
           AND  nbrearn_active_ind  =  'Y'
           AND  nbrearn_effective_date  >
                   NVL(par_earn_eff_date, par_earn_query_date)
           AND  nbrearn_effective_date  <  par_cancel_date;
--
   CURSOR check_work_sch IS
      SELECT 'X'
      FROM nbbwksh
      WHERE nbbwksh_pidm      = par_pidm
      AND   nbbwksh_posn      = par_posn
      AND   nbbwksh_suff      = par_suff
      AND   nbbwksh_effective_date < par_cancel_date
      AND   ((nbbwksh_schedule_end_date > par_cancel_date)
              OR nbbwksh_schedule_end_date IS NULL);
--
BEGIN
   msg := NULL;
   msg_type := NULL;
dbms_output.put_line('par_cancel_date: ' || to_date(par_cancel_date));
dbms_output.put_line('par_earn_eff_date: ' || to_date(par_earn_eff_date));
--
   IF edit_num = 1 THEN
      edit_num := edit_num + 1;
      IF NOT ((par_cancel_date > NVL(par_earn_eff_date, par_earn_query_date))
       OR par_cancel_date IS NULL) THEN
         msg :=  G$_NLS.Get('NOPCNDT-0002', 'SQL','*ERROR* The earnings Ending Date must be greater than the effective date.')
                ;
         msg_type := 'E';
         RETURN;
      END IF;
   END IF;
--
   IF edit_num = 2 THEN
      edit_num := edit_num + 1;
      OPEN earn_cursor ;
      FETCH earn_cursor INTO temp ;
      IF earn_cursor%FOUND THEN
         msg :=  G$_NLS.Get('NOPCNDT-0003', 'SQL','*ERROR* Cannot inactivate due to active record w/same Earn Code in future.')
                ;
         msg_type := 'E';
         RETURN;
      END IF ;
   END IF ;
--
   IF edit_num = 3 THEN
      edit_num := edit_num + 1;
      IF NVL(par_hr_installed_ind,'N') = 'Y' THEN
         IF NOT (par_hold_earn_date >= par_last_paid_date
          OR par_last_paid_date IS NULL
          OR par_hold_earn_date IS NULL) THEN
            msg :=  G$_NLS.Get('NOPCNDT-0004', 'SQL','*ERROR* End Date may not be updated since it is prior to the Last Paid Date.')
                   ;
            msg_type := 'E';
            RETURN;
         END IF ;
      END IF ;
   END IF ;
--
   IF edit_num = 4 THEN
      edit_num := edit_num + 1;
      IF NVL(par_hr_installed_ind,'N') = 'Y' THEN
         IF NOT (par_cancel_date > par_last_paid_date
          OR par_last_paid_date IS NULL
          OR par_cancel_date IS NULL) THEN
            msg :=  G$_NLS.Get('NOPCNDT-0005', 'SQL','*ERROR* The earnings Ending Date must be greater than Last Paid Date.')
                   ;
            msg_type := 'E';
            RETURN;
         END IF ;
      END IF ;
   END IF ;
--
   IF edit_num = 5 THEN
      edit_num := end_edit;
      IF NVL(par_earn_code,'@') = NVL(par_base_earn_code,'@') THEN
         OPEN check_work_sch;
         FETCH check_work_sch INTO temp;
         IF check_work_sch%FOUND THEN
            msg :=  G$_NLS.Get('NOPCNDT-0006', 'SQL','*ERROR* Active work schedule exists as of End Date. Change the End Date.')
                   ;
            msg_type := 'E';
            CLOSE check_work_sch;
            RETURN;
         END IF;
      END IF;
   END IF;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBREARN_CANCEL_DATE;

CREATE PUBLIC SYNONYM P_EDIT_NBREARN_CANCEL_DATE FOR BANINST1.P_EDIT_NBREARN_CANCEL_DATE;


GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_CANCEL_DATE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_CANCEL_DATE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_CANCEL_DATE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_CANCEL_DATE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_CANCEL_DATE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_CANCEL_DATE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_CANCEL_DATE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_CANCEL_DATE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_CANCEL_DATE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_CANCEL_DATE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_CANCEL_DATE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_CANCEL_DATE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_CANCEL_DATE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_CANCEL_DATE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_CANCEL_DATE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_CANCEL_DATE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_CANCEL_DATE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBREARN_EARN_CODE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrearn_earn_code
     (par_pidm               IN      number,
      par_posn               IN      varchar2,
      par_suff               IN      varchar2,
      par_earn_code          IN      varchar2,
      par_earn_eff_date      IN      date,
      par_ecls_code          IN      varchar2,
      par_hr_installed_ind   IN      varchar2,
      par_earn_query_date    IN      date,
      par_exe_source         IN      varchar2,
      par_rate_ind           OUT     varchar2,
      msg                    OUT     varchar2,
      msg_type               OUT     varchar2)
IS
--
-- FILE NAME..:  nopeecd.sql
-- RELEASE....:  4.1
-- OBJECT NAME:  P_EDIT_NBREARN_EARN_CODE
-- PRODUCT....:  POSNCTL
-- USAGE......:  Performs all edits on POST-CHANGE to the NBREARN_EARN_CODE.
--
-- COPYRIGHT..:  Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- Edit - Procedure performs all edits fired on the POST-CHANGE to
--        the NBREARN_EARN_CODE.
--
-- DESCRIPTION END
--
   temp            varchar2(1) := NULL;
   var_base_earn   varchar2(1) := NULL;
   var_earn_desc   varchar2(30) := NULL;
   var_earn_type   varchar2(2) := NULL;
   var_spec_rate   varchar2(1) := NULL;
   var_msg         noreaer.noreaer_error_msg%TYPE := NULL;
   var_msg_type    noreaer.noreaer_msg_type%TYPE := NULL;
--
   CURSOR earn_cursor IS
   SELECT 'X'
   FROM   nbrearn
   WHERE  nbrearn_pidm        =  par_pidm
     AND  nbrearn_posn        =  par_posn
     AND  nbrearn_suff        =  par_suff
     AND  nbrearn_earn_code   =  par_earn_code
     AND  nbrearn_active_ind  =  'Y'
     AND  nbrearn_effective_date > par_earn_query_date;
--
BEGIN
--
   msg := NULL;
   msg_type := NULL;
dbms_output.put_line('par_earn_code: ' || par_earn_code);
--
   /*
   || First edit is always done. Remaining edits only apply if HR is
   || installed.
   */
   OPEN earn_cursor ;
   FETCH earn_cursor INTO temp ;
   IF earn_cursor%FOUND THEN
      msg :=  G$_NLS.Get('NOPEECD-0001', 'SQL','*ERROR* Earn Code already exists; View later effective date and remove code.')
             ;
      msg_type := 'E';
   ELSE
      IF par_hr_installed_ind = 'Y' THEN
         IF par_earn_code IS NOT NULL THEN
            nokplib.p_edit_earn(par_earn_code,
                                par_exe_source,
                                var_earn_desc,
                                var_base_earn,
                                var_spec_rate,
                                var_earn_type,
                                var_msg,
                                var_msg_type);
            IF var_msg IS NOT NULL THEN
               msg := var_msg;
               msg_type := var_msg_type;
            ELSE
dbms_output.put_line('var_spec_rate: ' || var_spec_rate);
               par_rate_ind := var_spec_rate;
               IF var_earn_type NOT IN ( 'RP' , 'AP' , 'OT' ) AND
                  var_earn_type IS NOT NULL THEN
                  msg :=  G$_NLS.Get('NOPEECD-0006', 'SQL','*ERROR* Only Earn Codes with Types RP, AP, OT or NULL allowed as defaults.')
                         ;
                  msg_type := 'E';
               ELSE
dbms_output.put_line('par_ecls_code: ' || par_ecls_code);
                  nokplib.p_edit_ecls_earn(par_ecls_code,
                                           par_earn_code,
                                           var_msg,
                                           var_msg_type);
                  IF var_msg IS NOT NULL THEN
                     msg := var_msg;
                     msg_type := 'E';
                  ELSE
                     IF var_base_earn = 'Y' THEN
                        nokplib.p_edit_earn_base(par_pidm,
                                                 par_posn,
                                                 par_suff,
                                                 par_earn_code,
                                                 par_earn_eff_date,
                                                 par_earn_query_date,
                                                 var_msg,
                                                 var_msg_type);
                        IF var_msg IS NOT NULL THEN
                           msg := var_msg;
                           msg_type := 'E';
                        END IF;
                     END IF;
                  END IF;
               END IF ;
            END IF;
         END IF;
      END IF;
   END IF;
   CLOSE earn_cursor;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBREARN_EARN_CODE;

CREATE PUBLIC SYNONYM P_EDIT_NBREARN_EARN_CODE FOR BANINST1.P_EDIT_NBREARN_EARN_CODE;


GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EARN_CODE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EARN_CODE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EARN_CODE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EARN_CODE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EARN_CODE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EARN_CODE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EARN_CODE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EARN_CODE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EARN_CODE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EARN_CODE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EARN_CODE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EARN_CODE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EARN_CODE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EARN_CODE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EARN_CODE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EARN_CODE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EARN_CODE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrearn_effective_date
     (par_hr_installed_ind  IN     gubinst.gubinst_humanre_installed%TYPE,
      par_begin_date        IN     nbrbjob.nbrbjob_begin_date%TYPE,
      par_end_date          IN     nbrbjob.nbrbjob_end_date%TYPE,
      par_pidm              IN     nbrearn.nbrearn_pidm%TYPE,
      par_posn              IN     nbrearn.nbrearn_posn%TYPE,
      par_suff              IN     nbrearn.nbrearn_suff%TYPE,
      par_earn_eff_date     IN     nbrearn.nbrearn_effective_date%TYPE,
      par_earn_code         IN     nbrearn.nbrearn_earn_code%TYPE,
      par_hrs               IN     nbrearn.nbrearn_hrs%TYPE,
      par_special_rate      IN     nbrearn.nbrearn_special_rate%TYPE,
      par_shift             IN     nbrearn.nbrearn_shift%TYPE,
      par_deemed_hrs        IN     nbrearn.nbrearn_deemed_hrs%TYPE,
      par_cancel_date       IN     DATE,
      par_term_date         IN     DATE,
      par_last_paid_date    IN     DATE,
      exe_source            IN     VARCHAR2,
      par_last_earn_code    OUT    nbrearn.nbrearn_earn_code%TYPE,
      par_last_earn_date    IN OUT nbrearn.nbrearn_effective_date%TYPE,
      par_base_earn_code    IN OUT nbrearn.nbrearn_earn_code%TYPE,
      msg                   IN OUT VARCHAR2,
      msg_type              OUT    VARCHAR2,
      edit_num              IN OUT NUMBER)
IS
--
-- FILE NAME..: nopjeed.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBREARN_EFFECTIVE_DATE
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edit on the NBREARN effective date.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure performs edit on the effective date, when changes are
-- made to NBREARN records.
--
-- DESCRIPTION END
--
   var_dummy                    VARCHAR2(1) := NULL;
   end_edit                     NUMBER := 99;
--
CURSOR GET_LAST_EARN_DATE IS
   SELECT MAX(NBREARN_EFFECTIVE_DATE), NBREARN_EARN_CODE
   FROM NBREARN M
   WHERE NBREARN_PIDM = par_pidm
   AND NBREARN_POSN = par_posn
   AND NBREARN_SUFF = par_suff
   AND NBREARN_ACTIVE_IND = 'Y'
   AND  NOT EXISTS  (
         SELECT 'X'
         FROM   NBREARN S
         WHERE  S.NBREARN_PIDM = par_pidm
           AND  S.NBREARN_POSN = par_posn
           AND  S.NBREARN_SUFF = par_suff
           AND  S.NBREARN_ACTIVE_IND = 'N'
           AND  S.NBREARN_EFFECTIVE_DATE >= M.NBREARN_EFFECTIVE_DATE
           AND  S.NBREARN_EARN_CODE = M.NBREARN_EARN_CODE )
AND  NOT EXISTS  (
         SELECT 'X'
         FROM   NBBWKSH
         WHERE  NBBWKSH_PIDM = par_pidm
           AND  NBBWKSH_POSN = par_posn
           AND  NBBWKSH_SUFF = par_suff
           AND  NBBWKSH_EFFECTIVE_DATE <= par_earn_eff_date
           AND  (NBBWKSH_SCHEDULE_END_DATE >= par_earn_eff_date
                 OR  NBBWKSH_SCHEDULE_END_DATE IS NULL)
           AND  M.NBREARN_EARN_CODE = par_base_earn_code )
GROUP BY NBREARN_EARN_CODE;
--
CURSOR CHECK_DATE_EXISTS IS
  SELECT 'X'
  FROM   NBREARN
  WHERE  NBREARN_PIDM = par_pidm
    AND  NBREARN_POSN = par_posn
    AND  NBREARN_SUFF = par_suff
    AND  NBREARN_ACTIVE_IND = 'Y'
    AND  NBREARN_EFFECTIVE_DATE = par_earn_eff_date;
--
CURSOR WKSH_CURSOR IS
   SELECT 'X'
   FROM   NBBWKSH
   WHERE  NBBWKSH_PIDM = par_pidm
   AND  NBBWKSH_POSN = par_posn
   AND  NBBWKSH_SUFF = par_suff
   AND  NBBWKSH_EFFECTIVE_DATE <= par_earn_eff_date
   AND  (NBBWKSH_SCHEDULE_END_DATE >= par_earn_eff_date
   OR  NBBWKSH_SCHEDULE_END_DATE IS NULL) ;
--
CURSOR check_record_exists IS
   SELECT 'X'
   FROM NBREARN
   WHERE NBREARN_PIDM = par_pidm
   AND   NBREARN_POSN = par_posn
   AND   NBREARN_SUFF = par_suff
   AND   NBREARN_EFFECTIVE_DATE = par_earn_eff_date
   AND   NBREARN_EARN_CODE = par_earn_code
   AND   NVL(NBREARN_HRS,0) = NVL(par_hrs,0)
   AND   NVL(NBREARN_SPECIAL_RATE,0) = NVL(par_special_rate,0)
   AND   NBREARN_SHIFT = par_shift
   AND   NVL(NBREARN_DEEMED_HRS,0) = NVL(par_deemed_hrs,0);
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_earn_eff_date IS NULL THEN
      msg :=  G$_NLS.Get('NOPJEED-0000', 'SQL','*ERROR*  Earn Effective Date must be entered.') ;
      msg_type := 'E';
      edit_num := end_edit;
      RETURN;
   END IF ;
--
   IF edit_num = 1 THEN
      edit_num := edit_num + 1;
      IF exe_source = 'FORM' THEN
         OPEN check_date_exists;
         FETCH check_date_exists INTO var_dummy;
         IF check_date_exists%FOUND THEN
            msg :=  G$_NLS.Get('NOPJEED-0002', 'SQL','*ERROR* Earnings records with this effective date exist. Press View to query.')
                   ;
            msg_type := 'E';
            CLOSE check_date_exists;
            RETURN;
         ELSE
            msg := NULL;
            msg_type := NULL;
         END IF;
         CLOSE check_date_exists;
      END IF;
   END IF;
--
   IF edit_num = 2 THEN
      edit_num := edit_num + 1;
      OPEN check_date_exists;
      FETCH check_date_exists INTO var_dummy;
      IF check_date_exists%NOTFOUND THEN
         OPEN GET_LAST_EARN_DATE;
         FETCH GET_LAST_EARN_DATE INTO par_last_earn_date, par_last_earn_code;
         IF par_last_earn_date IS NOT NULL THEN
            IF par_last_earn_date > par_earn_eff_date THEN
               msg :=  G$_NLS.Get('NOPJEED-0003', 'SQL',
	'*ERROR* New Effective Date must be greater than last date of %01%.'

	,
                      TO_CHAR(par_last_earn_date,G$_DATE.GET_NLS_DATE_FORMAT) );
               msg_type := 'E';
               CLOSE get_last_earn_date;
               CLOSE check_date_exists;
               RETURN;
            END IF;
         END IF;
         CLOSE get_last_earn_date;
      END IF;
      CLOSE check_date_exists;
   END IF;
--
        /*
        || The check_record_exists cursor determines if a record
        || already exists in the database with identical information
        || for the effective date entered. If so, the user may only
        || change the end date field if the effective date is before
        || the last paid date or another future dated record exists.
        */
--
   IF edit_num = 3 THEN
      edit_num := edit_num + 1;
      OPEN check_record_exists;
      FETCH check_record_exists INTO var_dummy;
      IF NOT(check_record_exists%FOUND AND par_cancel_date IS NOT NULL) THEN
         IF NVL(par_hr_installed_ind,'N') = 'Y' THEN
            IF par_last_paid_date IS NOT NULL THEN
               IF par_last_paid_date > par_earn_eff_date THEN
                  msg :=   G$_NLS.Get('NOPJEED-0004', 'SQL',
	'*ERROR* Eff Date must be greater than Last Paid Date of %01%.'

	,
                          TO_CHAR(par_last_paid_date,G$_DATE.GET_NLS_DATE_FORMAT) );
                  msg_type := 'E';
                  CLOSE check_record_exists;
                  RETURN;
               END IF;
            END IF;
         END IF;
      END IF;
      CLOSE check_record_exists;
   END IF ;
--
   IF edit_num = 4 THEN
      edit_num := edit_num + 1;
         IF NVL(par_hr_installed_ind,'N') = 'Y' THEN
            IF par_term_date IS NOT NULL THEN
               IF par_term_date < par_earn_eff_date THEN
             msg :=  G$_NLS.Get('NOPJEED-0005', 'SQL','*ERROR* New Effective Date cannot be after Employee''s Termination Date.')
                 ;
               msg_type := 'E';
               RETURN;
               END IF;
            END IF;
         END IF;
   END IF;
--
   IF edit_num = 5 THEN
      edit_num := edit_num + 1;
      IF par_end_date IS NOT NULL THEN
         IF par_earn_eff_date > par_end_date THEN
            msg :=  G$_NLS.Get('NOPJEED-0006', 'SQL',
	'*ERROR*  Date cannot be after the Base Job End Date of %01%.'

	,  to_char(par_end_date,G$_DATE.GET_NLS_DATE_FORMAT));
            msg_type := 'E';
            RETURN;
         END IF;
      END IF;
   END IF;
--
   IF edit_num = 6 THEN
      edit_num := edit_num + 1;
      IF par_begin_date IS NOT NULL THEN
         IF par_earn_eff_date < par_begin_date THEN
             msg :=  G$_NLS.Get('NOPJEED-0007', 'SQL',
	'*ERROR* Date cannot be prior to the Base Job Begin Date of %01%.'

	,
                 to_char(par_begin_date,G$_DATE.GET_NLS_DATE_FORMAT));
             msg_type := 'E';
             RETURN;
         END IF;
      END IF;
   END IF;
--
   IF edit_num = 7 THEN
      edit_num := edit_num + 1;
      IF f_edit_future_change_for_fisc(par_earn_eff_date) IS NULL THEN
         msg :=  G$_NLS.Get('NOPJEED-0008', 'SQL','*ERROR* Earn Effective Date is not within a defined fiscal year.')
                ;
         msg_type := 'E';
         RETURN;
      END IF;
   END IF;
--
   IF edit_num = 8 THEN
      edit_num := end_edit;
      IF NVL(par_earn_code,'@') = NVL(par_base_earn_code,'@') THEN
         OPEN wksh_cursor;
         FETCH wksh_cursor INTO var_dummy;
         IF wksh_cursor%FOUND THEN
            msg :=  G$_NLS.Get('NOPJEED-0009', 'SQL','*ERROR* Active work schedule exists as of new effective date.')
                   ;
            msg_type := 'E';
            CLOSE wksh_cursor;
            RETURN;
         ELSE
            msg := NULL;
            msg_type := NULL;
         END IF;
         CLOSE wksh_cursor;
      END IF;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBREARN_EFFECTIVE_DATE;

CREATE PUBLIC SYNONYM P_EDIT_NBREARN_EFFECTIVE_DATE FOR BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE;


GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_EFFECTIVE_DATE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBREARN_SPECIAL_RATE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrearn_special_rate
     (par_hr_installed_ind  IN   varchar2,
      par_rate_ind          IN   varchar2,
      par_special_rate      IN   number,
      msg                   OUT  varchar2,
      msg_type              OUT  varchar2)
IS
--
-- FILE NAME..: nopespr.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBREARN_SPECIAL_RATE
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edit on the earn code special rate.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure peforms edit on the earn code special rate when Human
-- Resouces is installed.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF NVL(par_hr_installed_ind,'N') = 'Y'
    AND par_special_rate IS NOT NULL
    AND par_rate_ind IS NOT NULL THEN
      IF par_rate_ind <> 'S' THEN
         msg :=  G$_NLS.Get('NOPESPR-0000', 'SQL','*ERROR* Earning Code Rate Indicator does not allow rate to be entered.')
                ;
         msg_type := 'E';
      END IF;
   END IF;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBREARN_SPECIAL_RATE;

CREATE PUBLIC SYNONYM P_EDIT_NBREARN_SPECIAL_RATE FOR BANINST1.P_EDIT_NBREARN_SPECIAL_RATE;


GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_SPECIAL_RATE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_SPECIAL_RATE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_SPECIAL_RATE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_SPECIAL_RATE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_SPECIAL_RATE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_SPECIAL_RATE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_SPECIAL_RATE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_SPECIAL_RATE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_SPECIAL_RATE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_SPECIAL_RATE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_SPECIAL_RATE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_SPECIAL_RATE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_SPECIAL_RATE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_SPECIAL_RATE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_SPECIAL_RATE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_SPECIAL_RATE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBREARN_SPECIAL_RATE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrjlbd_effective_date
     (par_hr_installed_ind    IN   gubinst.gubinst_humanre_installed%TYPE,
      par_begin_date          IN   nbrbjob.nbrbjob_begin_date%TYPE,
      par_end_date            IN   nbrbjob.nbrbjob_end_date%TYPE,
      par_effective_date      IN   nbrjobs.nbrjobs_effective_date%TYPE,
      par_pidm                IN   nbrjobs.nbrjobs_pidm%TYPE,
      par_posn                IN   nbrjobs.nbrjobs_posn%TYPE,
      par_suff                IN   nbrjobs.nbrjobs_suff%TYPE,
      par_term_date           IN   date,
      par_last_paid_date      IN   date,
      par_last_jlbd_date  IN OUT   date,
      msg                    OUT   varchar2,
      msg_type               OUT   varchar2,
      edit_num            IN OUT   number)
IS
--
-- FILE NAME..: nopjled.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRJLBD_EFFECTIVE_DATE
-- PRODUCT....: POSNCTL
-- USAGE......: Perform all edits on the effective date.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- Procedure performs all edits on the effective date for JLBD changes.
--
-- DESCRIPTION END
--
--
   CURSOR GET_LAST_JLBD_DATE IS
   SELECT MAX(NBRJLBD_EFFECTIVE_DATE)
   FROM NBRJLBD
   WHERE  NBRJLBD_PIDM = par_pidm
     AND  NBRJLBD_POSN = par_posn
     AND  NBRJLBD_SUFF = par_suff
     AND  NBRJLBD_CHANGE_IND = 'A' ;
--
   end_edit NUMBER := 99;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_effective_date IS NULL THEN
      msg :=  G$_NLS.Get('NOPJLED-0000', 'SQL','*ERROR* Job Labor Distribution Effective Date must be entered.') ;
      msg_type := 'E';
      edit_num := end_edit;
      RETURN;
   END IF ;
--
   IF edit_num = 1 THEN
      edit_num := edit_num + 1;
      OPEN GET_LAST_JLBD_DATE;
      FETCH GET_LAST_JLBD_DATE INTO par_last_jlbd_date;
      IF par_last_jlbd_date IS NOT NULL THEN
         IF par_last_jlbd_date > par_effective_date THEN
         msg :=  G$_NLS.Get('NOPJLED-0001', 'SQL',
	'*ERROR* New effective date must be greater than last date of %01%.'

	,   TO_CHAR (par_last_jlbd_date,G$_DATE.GET_NLS_DATE_FORMAT) );
         msg_type := 'E';
         RETURN;
         END IF;
      END IF;
   END IF;
--
   IF edit_num = 2 THEN
      edit_num := edit_num + 1;
         IF NVL(par_hr_installed_ind,'N') = 'Y' THEN
            IF par_last_paid_date IS NOT NULL THEN
               IF par_last_paid_date > par_effective_date THEN
         msg :=   G$_NLS.Get('NOPJLED-0002', 'SQL',
	'*ERROR* Effective must be greater than Last Paid Date of %01%.'
	,
                  TO_CHAR(par_last_paid_date,G$_DATE.GET_NLS_DATE_FORMAT) );
               msg_type := 'E';
               RETURN;
               END IF;
            END IF;
         END IF;
   END IF ;
--
   IF edit_num = 3 THEN
      edit_num := edit_num + 1;
         IF NVL(par_hr_installed_ind,'N') = 'Y' THEN
            IF par_term_date IS NOT NULL THEN
               IF par_term_date < par_effective_date THEN
             msg :=  G$_NLS.Get('NOPJLED-0003', 'SQL','*ERROR* New Effective Date cannot be after Employee''s Termination Date.')
                 ;
               msg_type := 'E';
               RETURN;
               END IF;
            END IF;
         END IF;
   END IF;
--
   IF edit_num = 4 THEN
      edit_num := edit_num + 1;
      IF par_end_date IS NOT NULL THEN
         IF par_effective_date > par_end_date THEN
            msg :=  G$_NLS.Get('NOPJLED-0004', 'SQL',
	'*ERROR*  Date cannot be after the Base Job End Date of %01%.'

	,  to_char(par_end_date,G$_DATE.GET_NLS_DATE_FORMAT));
            msg_type := 'E';
            RETURN;
         END IF;
      END IF;
   END IF;
--
   IF edit_num = 5 THEN
      edit_num := edit_num + 1;
      IF par_begin_date IS NOT NULL THEN
         IF par_effective_date < par_begin_date THEN
             msg :=  G$_NLS.Get('NOPJLED-0005', 'SQL',
	'*ERROR* Date cannot be prior to the Base Job Begin Date of %01%.'

	,
                 to_char(par_begin_date,G$_DATE.GET_NLS_DATE_FORMAT));
             msg_type := 'E';
             RETURN;
         END IF;
      END IF;
   END IF;
--
   IF edit_num = 6 THEN
      edit_num := end_edit;
      IF f_edit_future_change_for_fisc(par_effective_date) IS NULL THEN
         msg :=  G$_NLS.Get('NOPJLED-0006', 'SQL','*ERROR* Labor Dist Effective Date is not within a defined fiscal year.')
                ;
         msg_type := 'E';
         RETURN;
      END IF;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRJLBD_EFFECTIVE_DATE;

CREATE PUBLIC SYNONYM P_EDIT_NBRJLBD_EFFECTIVE_DATE FOR BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_EFFECTIVE_DATE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRJLBD_PERCENT;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrjlbd_percent
     (par_percent              IN      nbrjlbd.nbrjlbd_percent%TYPE,
      msg                      OUT     noreaer.noreaer_error_msg%TYPE,
      msg_type                 OUT     noreaer.noreaer_msg_type%TYPE)
IS
--
-- FILE NAME..: noplpct.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRJLBD_PERCENT
-- PRODUCT....: POSNCTL
-- USAGE......: Validation of the NBRJLBD percent.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- Procedure to validate the existence of the NBRJLBD percent.
--
-- DESCRIPTION END
--
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_percent IS NULL THEN
      msg :=  G$_NLS.Get('NOPLPCT-0000', 'SQL','*ERROR* Labor Distribution Percentage is required.') ;
      msg_type := 'E';
      RETURN;
   END IF;
--
   IF par_percent > 100 OR par_percent < .01 THEN
      msg :=  G$_NLS.Get('NOPLPCT-0001', 'SQL','*ERROR* Labor Distribution Percentage must be between .01 and 100.')
             ;
      msg_type := 'E';
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRJLBD_PERCENT;

CREATE PUBLIC SYNONYM P_EDIT_NBRJLBD_PERCENT FOR BANINST1.P_EDIT_NBRJLBD_PERCENT;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_PERCENT TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_PERCENT TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_PERCENT TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_PERCENT TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_PERCENT TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_PERCENT TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_PERCENT TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_PERCENT TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_PERCENT TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_PERCENT TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_PERCENT TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_PERCENT TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_PERCENT TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_PERCENT TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_PERCENT TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_PERCENT TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJLBD_PERCENT TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRJOBS_ANN_SALARY;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrjobs_ann_salary
     (par_old_ann_salary          IN  number,
      par_ann_salary          IN OUT  number,
      msg                        OUT  varchar2,
      msg_type                   OUT  varchar2)
IS
--
-- FILE NAME..: nopcann.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRJOBS_ANN_SALARY
-- PRODUCT....: POSNCTL
-- USAGE......: Validate the annual salary changes.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates that the annual salary has not been enterd
-- when the step is <> 0 and is executed conditionally based on the step.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_ann_salary = par_old_ann_salary OR
      (par_ann_salary IS NULL AND par_old_ann_salary IS NULL) THEN
      NULL;
   ELSE
      par_ann_salary := par_old_ann_salary;
      msg :=  G$_NLS.Get('NOPCANN-0000', 'SQL','*ERROR* Annual Salary cannot change unless the step is zero.') ;
      msg_type := 'E';
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRJOBS_ANN_SALARY;

CREATE PUBLIC SYNONYM P_EDIT_NBRJOBS_ANN_SALARY FOR BANINST1.P_EDIT_NBRJOBS_ANN_SALARY;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ANN_SALARY TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ANN_SALARY TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ANN_SALARY TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ANN_SALARY TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ANN_SALARY TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ANN_SALARY TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ANN_SALARY TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ANN_SALARY TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ANN_SALARY TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ANN_SALARY TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ANN_SALARY TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ANN_SALARY TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ANN_SALARY TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ANN_SALARY TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ANN_SALARY TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ANN_SALARY TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ANN_SALARY TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRJOBS_APPT_PCT;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrjobs_appt_pct
     (par_appt_pct             IN      nbrjobs.nbrjobs_appt_pct%TYPE,
      msg                      OUT     VARCHAR2,
      msg_type                 OUT     VARCHAR2)
IS
--
-- FILE NAME..: nopappt.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRJOBS_APPT_PCT
-- PRODUCT....: POSNCTL
-- USAGE......: Validates the existence and value of NBRJOBS appointment perc.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates the existence of the NBRJOBS appointment
-- percent and it's value must be less or equal to 100.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_appt_pct IS NULL THEN
      msg :=  G$_NLS.Get('NOPAPPT-0000', 'SQL','*ERROR* Appointment Percent is required.') ;
      msg_type := 'E';
      RETURN;
   END IF;
--
   IF par_appt_pct > 100 THEN
      msg :=  G$_NLS.Get('NOPAPPT-0001', 'SQL','*ERROR* Appointment Percent cannot be greater than 100%.') ;
      msg_type := 'E';
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRJOBS_APPT_PCT;

CREATE PUBLIC SYNONYM P_EDIT_NBRJOBS_APPT_PCT FOR BANINST1.P_EDIT_NBRJOBS_APPT_PCT;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_APPT_PCT TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_APPT_PCT TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_APPT_PCT TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_APPT_PCT TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_APPT_PCT TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_APPT_PCT TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_APPT_PCT TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_APPT_PCT TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_APPT_PCT TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_APPT_PCT TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_APPT_PCT TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_APPT_PCT TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_APPT_PCT TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_APPT_PCT TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_APPT_PCT TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_APPT_PCT TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_APPT_PCT TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrjobs_assgn_salary
     (par_old_assgn_salary        IN  number,
      par_assgn_salary        IN OUT  number,
      msg                        OUT  varchar2,
      msg_type                   OUT  varchar2)
IS
--
-- FILE NAME..: nopcasn.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRJOBS_ASSGN_SALARY
-- PRODUCT....: POSNCTL
-- USAGE......: Validate the assignment salary change.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates that the assignment salary has not been enterd
-- when the step is <> 0 and is executed conditionally based on the step.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_assgn_salary = par_old_assgn_salary OR
      (par_assgn_salary IS NULL AND par_old_assgn_salary IS NULL) THEN
      NULL;
   ELSE
      par_assgn_salary := par_old_assgn_salary;
      msg :=  G$_NLS.Get('NOPCASN-0000', 'SQL','*ERROR* Assignment Salary cannot change unless the step is zero.') ;
      msg_type := 'E';
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRJOBS_ASSGN_SALARY;

CREATE PUBLIC SYNONYM P_EDIT_NBRJOBS_ASSGN_SALARY FOR BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ASSGN_SALARY TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRJOBS_ECLS_WA;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrjobs_ecls_wa
     (par_fy_jobs                 IN  varchar2,
      par_coas_code               IN  varchar2,
      msg                        OUT  varchar2,
      msg_type                   OUT  varchar2)
IS
--
-- FILE NAME..: nopecl1.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRJOBS_ECLS_WA
-- PRODUCT....: POSNCTL
-- USAGE......: Issue warning message to change job labor distribution.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure issues a warning message to change the job labor
-- distribution when the employee class code changes and the method
-- for fringes is chargeback.
--
-- DESCRIPTION END
--
   TEMP varchar2(1);
--
   CURSOR SEL_FINI IS
   SELECT 'X'
     FROM NTRFINI
    WHERE NTRFINI_FISC_CODE = par_fy_jobs
      AND NTRFINI_FRNG_ENCUMB_IND = 'Y'
      AND NTRFINI_COAS_CODE = par_coas_code;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   OPEN SEL_FINI;
   FETCH SEL_FINI INTO TEMP;
   IF SEL_FINI%FOUND THEN
      msg :=  G$_NLS.Get('NOPECL1-0000', 'SQL','*WARNING* If Empl Class changed; Labor Dist with this date should be entered.')
             ;
      msg_type := 'W';
   END IF;
   CLOSE sel_fini;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRJOBS_ECLS_WA;

CREATE PUBLIC SYNONYM P_EDIT_NBRJOBS_ECLS_WA FOR BANINST1.P_EDIT_NBRJOBS_ECLS_WA;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ECLS_WA TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ECLS_WA TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ECLS_WA TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ECLS_WA TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ECLS_WA TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ECLS_WA TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ECLS_WA TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ECLS_WA TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ECLS_WA TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ECLS_WA TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ECLS_WA TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ECLS_WA TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ECLS_WA TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ECLS_WA TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ECLS_WA TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ECLS_WA TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ECLS_WA TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrjobs_effective_date
     (par_hr_installed_ind   IN   varchar2,
      par_begin_date         IN   date,
      par_end_date           IN   date,
      par_min_jobs_eff_date  IN   date,
      par_future_chg_ind     IN   varchar2,
      par_term_date          IN   date,
      par_last_paid_date     IN   date,
      par_pidm               IN  number,
      par_posn               IN  varchar2,
      par_suff               IN  varchar2,
      par_effective_date     IN  date,
      par_just_enc_pers_date IN varchar2,
      par_job_status         IN varchar2,
      par_old_status         IN varchar2,
      msg                   OUT  varchar2,
      msg_type              OUT  varchar2,
      edit_num           IN OUT  number)
IS
--
-- FILE NAME..: nopjelp.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRJOBS_EFFECTIVE_DATE
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edit on the NBRJOBS effective date.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure performs edit on the effective date, when changes are
-- made to NBRJOBS record.
--
-- DESCRIPTION END
--
--
CURSOR CHECK_DATE IS
   SELECT MIN(NBRJOBS_EFFECTIVE_DATE)
   FROM NBRJOBS
   WHERE NBRJOBS_PIDM = par_pidm
   AND NBRJOBS_POSN = par_posn
   AND NBRJOBS_SUFF = par_suff
   AND NBRJOBS_EFFECTIVE_DATE > par_effective_date;
--
CURSOR check_date_exists IS
   SELECT 'X'
   FROM NBRJOBS
   WHERE NBRJOBS_PIDM = par_pidm
   AND NBRJOBS_POSN = par_posn
   AND NBRJOBS_SUFF = par_suff
   AND NBRJOBS_EFFECTIVE_DATE = par_effective_date;
--
   var_last_eff_date        date := NULL;
   var_dummy                varchar2(1) := NULL;
--
   end_edit NUMBER := 99;
--
BEGIN
--
   IF par_effective_date IS NULL THEN
      msg :=  G$_NLS.Get('NOPJELP-0000', 'SQL','*ERROR* Job Effective Date must be entered.') ;
      msg_type := 'E';
      edit_num := end_edit;
      RETURN;
   END IF ;
--
     /*
     || First edit is only performed when future changes exist with
     || effective dates greater than effective date of change.
     */
   IF edit_num = 1 THEN
      edit_num := edit_num + 1;
      OPEN CHECK_DATE;
      FETCH CHECK_DATE INTO var_last_eff_date;
      IF var_last_eff_date IS NOT NULL THEN --not new job
         IF var_last_eff_date > par_effective_date THEN --if =< no edits
            OPEN check_date_exists;
            FETCH check_date_exists INTO var_dummy;
            IF check_date_exists%FOUND THEN
               CLOSE check_date_exists;
               IF par_future_chg_ind = 'E' THEN
                  IF par_just_enc_pers_date = 'Y' THEN
                     RETURN;
                  ELSE
                     msg :=  G$_NLS.Get('NOPJELP-0001', 'SQL','*ERROR* Only Personnel Date and Encum Hrs may be changed on this eff date.')

                            ;
                     msg_type := 'E';
                     RETURN;
                  END IF;
               ELSE
                  msg :=  G$_NLS.Get('NOPJELP-0002', 'SQL',
	'*WARNING* Future changes exist - starting on %01%.'
	,
                         to_char (var_last_eff_date,G$_DATE.GET_NLS_DATE_FORMAT));
                  msg_type := 'W';
                  RETURN;
               END IF;
            ELSE
               CLOSE check_date_exists;
               IF par_last_paid_date IS NULL OR
                  var_last_eff_date >= par_last_paid_date THEN
                  IF par_future_chg_ind = 'E' THEN
                     msg :=  G$_NLS.Get('NOPJELP-0003', 'SQL',
	'*ERROR* New Effective Date must be after %01%.'
	,
                            to_char (var_last_eff_date,G$_DATE.GET_NLS_DATE_FORMAT));
                     msg_type := 'E';
                     RETURN;
                  ELSE
                     msg :=  G$_NLS.Get('NOPJELP-0004', 'SQL',
	'*WARNING* Future changes exist - starting on %01%.'
	,
                            to_char (var_last_eff_date,G$_DATE.GET_NLS_DATE_FORMAT));
                     msg_type := 'W';
                     RETURN;
                  END IF;
              END IF;
            END IF;
         END IF;
      END IF;
   END IF;
--
   IF edit_num = 2 THEN
      edit_num := edit_num + 1;
      IF NVL(par_hr_installed_ind,'N') = 'Y' THEN
         IF par_last_paid_date IS NOT NULL THEN
            IF par_last_paid_date = par_effective_date
                AND (par_just_enc_pers_date = 'N' OR
                    (par_just_enc_pers_date = 'Y' AND
                     par_job_status <> par_old_status AND
                     par_job_status <> 'T')) THEN
         msg :=   G$_NLS.Get('NOPJELP-0005', 'SQL','*ERROR* Only the job status field may be changed to ''T'' on this eff date.')
                 ;
                  msg_type := 'E';
                  RETURN;
            ELSIF par_last_paid_date > par_effective_date THEN
               OPEN check_date_exists;
               FETCH check_date_exists INTO var_dummy;
               IF check_date_exists%FOUND AND
                  par_just_enc_pers_date = 'Y' AND
                  par_job_status = par_old_status THEN
                     CLOSE check_date_exists;
                     RETURN;
               ELSE
                  CLOSE check_date_exists;
         msg :=   G$_NLS.Get('NOPJELP-0006', 'SQL',
	'*ERROR* Eff Date must be greater than Last Paid Date of %01%.'
	,
                  TO_CHAR(par_last_paid_date,G$_DATE.GET_NLS_DATE_FORMAT) );
                  msg_type := 'E';
                  RETURN;
               END IF;
            END IF;
         END IF;
      END IF;
   END IF ;
--
   IF edit_num = 3 THEN
      edit_num := edit_num + 1;
         IF NVL(par_hr_installed_ind,'N') = 'Y' THEN
            IF par_term_date IS NOT NULL THEN
               IF par_term_date < par_effective_date THEN
             msg :=  G$_NLS.Get('NOPJELP-0007', 'SQL','*ERROR* New Effective Date cannot be after Employee''s Termination Date.')
                 ;
               msg_type := 'E';
               RETURN;
               END IF;
            END IF;
         END IF;
   END IF;
--
   IF edit_num = 4 THEN
      edit_num := edit_num + 1;
      IF par_end_date IS NOT NULL THEN
         IF par_effective_date > par_end_date THEN
            msg :=  G$_NLS.Get('NOPJELP-0008', 'SQL',
	'*ERROR*  Date cannot be after the Base Job End Date of %01%.'

	,  to_char(par_end_date,G$_DATE.GET_NLS_DATE_FORMAT));
            msg_type := 'E';
            RETURN;
         END IF;
      END IF;
   END IF;
--
   IF edit_num = 5 THEN
      edit_num := edit_num + 1;
      IF par_begin_date IS NOT NULL THEN
         IF par_effective_date < par_begin_date THEN
             msg :=  G$_NLS.Get('NOPJELP-0009', 'SQL',
	'*ERROR* Date cannot be prior to the Base Job Begin Date of %01%.'

	,
                 to_char(par_begin_date,G$_DATE.GET_NLS_DATE_FORMAT));
             msg_type := 'E';
             RETURN;
         END IF;
      END IF;
   END IF;
--
   IF edit_num = 6 THEN
      edit_num := edit_num + 1;
      IF f_edit_future_change_for_fisc(par_effective_date) IS NULL THEN
         msg :=  G$_NLS.Get('NOPJELP-0010', 'SQL','*ERROR* Job Effective Date is not within a defined fiscal year.')
                ;
         msg_type := 'E';
         RETURN;
      END IF;
   END IF;
--
   IF edit_num = 7 THEN
      edit_num := end_edit;
      IF par_min_jobs_eff_date IS NOT NULL THEN
         IF par_begin_date  <>  par_min_jobs_eff_date THEN
            msg :=  G$_NLS.Get('NOPJELP-0011', 'SQL','*ERROR* Begin Date must equal the first Jobs Detail Effective Date.')
                   ;
            msg_type := 'E';
            RETURN;
         END IF ;
      END IF ;
   END IF ;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRJOBS_EFFECTIVE_DATE;

CREATE PUBLIC SYNONYM P_EDIT_NBRJOBS_EFFECTIVE_DATE FOR BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_EFFECTIVE_DATE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrjobs_encumbrance_hr
       (par_encumbrance_hrs    IN  number,
        par_enc_method         IN  varchar2,
        msg                   OUT  varchar2,
        msg_type              OUT  varchar2 )
IS
--
-- FILE NAME..: nopehrs.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRJOBS_ENCUMBRANCE_HR
-- PRODUCT....: POSNCTL
-- USAGE......: Issue warning or error message for encumbrance hrs and method.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure issues warning or error message based on job encumbrance hours-- and encumbrance method.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_enc_method = 'H' THEN
      IF par_encumbrance_hrs IS NULL THEN
         msg :=  G$_NLS.Get('NOPEHRS-0000', 'SQL','*WARNING* Encumbrance Hrs should not be blank when method is Hours Input.')
                ;
         msg_type := 'W';
      END IF;
   ELSE
      IF par_encumbrance_hrs IS NOT NULL THEN
         msg :=  G$_NLS.Get('NOPEHRS-0001', 'SQL','*ERROR* Encumbrance Hrs must be blank if method is not Hours Input.')
                ;
         msg_type := 'E';
      END IF;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRJOBS_ENCUMBRANCE_HR;

CREATE PUBLIC SYNONYM P_EDIT_NBRJOBS_ENCUMBRANCE_HR FOR BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_ENCUMBRANCE_HR TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRJOBS_FACTOR;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrjobs_factor
     (par_factor               IN      number,
      par_pays_per_year        IN      number,
      msg                      OUT     varchar2,
      msg_type                 OUT     varchar2)
IS
--
-- FILE NAME..: nopfact.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRJOBS_FACTOR
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edit on job factor.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates the existence of the NBRJOBS Factor and the factor
-- must be less than the pay ID's number of pays per year.
--
-- DESCRIPTION END
--
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_factor IS NULL THEN
      msg :=  G$_NLS.Get('NOPFACT-0000', 'SQL','*ERROR* Factor must be entered.') ;
      msg_type := 'E';
      RETURN;
   END IF;
--
   IF par_pays_per_year IS NOT NULL THEN
      IF par_factor > par_pays_per_year THEN
         msg :=  G$_NLS.Get('NOPFACT-0001', 'SQL','*ERROR* Factor cannot be greater than the payroll ID''s number of pays per year.')
                ;
         msg_type := 'E';
      END IF;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRJOBS_FACTOR;

CREATE PUBLIC SYNONYM P_EDIT_NBRJOBS_FACTOR FOR BANINST1.P_EDIT_NBRJOBS_FACTOR;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FACTOR TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FACTOR TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FACTOR TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FACTOR TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FACTOR TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FACTOR TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FACTOR TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FACTOR TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FACTOR TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FACTOR TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FACTOR TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FACTOR TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FACTOR TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FACTOR TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FACTOR TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FACTOR TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FACTOR TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRJOBS_FTE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrjobs_fte
     (par_pidm            IN  number,
      par_posn            IN  varchar2,
      par_suff            IN  varchar2,
      par_effective_date  IN  date,
      par_fte             IN  number,
      par_ptot_fte        IN  number,
      msg                OUT  varchar2,
      msg_type           OUT  varchar2,
      edit_num        IN OUT  number)
IS
--
-- FILE NAME..: nopcfte.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRJOBS_FTE
-- PRODUCT....: POSNCTL
-- USAGE......: Issue warnings for changes in full time equivalency percentage.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure generates warnings for changes to NBRJOBS FTE when:
--           1) Employee's Total FTE exceeds 1.
--           2) Position's Total FTE exceeds 1.
--           3) Value entered for FTE exceeds 1.
--           NOTE: This object was spefically written for mass apply. It
--                 excludes the current position and suffix from the
--                 FTE calculation (cursors) and adds the par_fte value
--                 to the result. This is necessary because the current
--                 FTE value is held in an array and not in the database.
--                 The cursors in NBAJOBS include the current position/
--                 suffix.
--
-- DESCRIPTION END
--
   end_edit    number := 99;
   total_fte   number := NULL;
--
   CURSOR check_pidm_fte IS
      SELECT NVL(SUM(NVL(NBRJOBS_FTE, 0)), 0)
      FROM   NBRJOBS, NBRBJOB X
      WHERE  NBRBJOB_PIDM = par_pidm
      AND    (NBRBJOB_POSN <> par_posn
      AND     NBRBJOB_SUFF <> par_suff)
      AND  NBRJOBS_EFFECTIVE_DATE =
      (SELECT MAX(Y.NBRJOBS_EFFECTIVE_DATE)
      FROM   NBRJOBS Y
      WHERE  Y.NBRJOBS_PIDM = X.NBRBJOB_PIDM
      AND  Y.NBRJOBS_EFFECTIVE_DATE <=
           par_effective_date
      AND Y.NBRJOBS_POSN = X.NBRBJOB_POSN
      AND Y.NBRJOBS_SUFF = X.NBRBJOB_SUFF)
      AND  NBRBJOB_PIDM = NBRJOBS_PIDM
      AND  NBRBJOB_POSN = NBRJOBS_POSN
      AND  NBRBJOB_SUFF = NBRJOBS_SUFF
      AND  NBRBJOB_BEGIN_DATE <= par_effective_date
      AND  (NBRBJOB_END_DATE >= par_effective_date
      OR  NBRBJOB_END_DATE IS NULL);
--
  CURSOR check_posn_fte IS
     SELECT NVL(SUM(Y.NBRJOBS_FTE), 0)
       FROM   NBRJOBS Y
      WHERE  Y.NBRJOBS_POSN = par_posn
      AND    (NBRJOBS_PIDM <> par_pidm
      AND     NBRJOBS_POSN <> par_posn
      AND     NBRJOBS_SUFF <> par_suff)
      AND    Y.NBRJOBS_EFFECTIVE_DATE =
             ( SELECT MAX(X.NBRJOBS_EFFECTIVE_DATE)
               FROM   NBRJOBS X
               WHERE  X.NBRJOBS_POSN = Y.NBRJOBS_POSN
                 AND  X.NBRJOBS_SUFF = Y.NBRJOBS_SUFF
                 AND  X.NBRJOBS_EFFECTIVE_DATE < par_effective_date
                 AND  X.NBRJOBS_PIDM = Y.NBRJOBS_PIDM);
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_fte IS NULL THEN
      edit_num := end_edit;
      msg :=  G$_NLS.Get('NOPCFTE-0000', 'SQL','*ERROR* Job FTE must be entered.') ;
      msg_type := 'E';
      RETURN;
   END IF;
--
   IF edit_num = 1 THEN
      edit_num := edit_num + 1;
      OPEN check_pidm_fte;
      FETCH check_pidm_fte INTO total_fte;
      total_fte := total_fte + NVL(par_fte,0);
      IF total_fte > 1 THEN
         msg :=   G$_NLS.Get('NOPCFTE-0001', 'SQL','*WARNING* Total FTE for this employee exceeds one as of the eff date.')
                 ;
         msg_type := 'W';
         CLOSE check_pidm_fte;
         RETURN;
      END IF;
      CLOSE check_pidm_fte;
  END IF;
--
   IF edit_num = 2 THEN
      total_fte := NULL;
      edit_num := edit_num + 1;
      OPEN check_posn_fte;
      FETCH check_posn_fte INTO total_fte;
      total_fte := total_fte + NVL(par_fte,0);
      IF total_fte > par_ptot_fte THEN
         msg :=   G$_NLS.Get('NOPCFTE-0002', 'SQL','*WARNING* Total FTE for this position is greater than budgeted FTE.')
                 ;
         msg_type := 'W';
         CLOSE check_posn_fte;
         RETURN;
      END IF;
      CLOSE check_posn_fte;
   END IF;
--
   IF edit_num = 3 THEN
      edit_num := end_edit;
      IF par_fte > 1 THEN
         msg :=   G$_NLS.Get('NOPCFTE-0003', 'SQL','*WARNING* FTE for this assignment is greater than one.')  ;
         msg_type := 'W';
         RETURN;
      END IF;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRJOBS_FTE;

CREATE PUBLIC SYNONYM P_EDIT_NBRJOBS_FTE FOR BANINST1.P_EDIT_NBRJOBS_FTE;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FTE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FTE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FTE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FTE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FTE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FTE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FTE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FTE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FTE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FTE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FTE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FTE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FTE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FTE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FTE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FTE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_FTE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRJOBS_HRS_DAY;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrjobs_hrs_day
     ( par_hrs_day    IN  number,
       msg           OUT  varchar2,
       msg_type      OUT  varchar2)
IS
--
-- FILE NAME..: nophour.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRJOBS_HRS_DAY
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edit on Hours Per Day.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure verifies that NBRJOBS hours per day exists and is between
-- 1 and 24.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_hrs_day IS NULL THEN
      msg :=  G$_NLS.Get('NOPHOUR-0000', 'SQL','*ERROR* Standard Hours Per Day must be entered.') ;
      msg_type := 'E';
      RETURN;
   END IF;
--
   IF par_hrs_day < 1 OR par_hrs_day > 24 THEN
      msg :=  G$_NLS.Get('NOPHOUR-0001', 'SQL','*ERROR* Hours Per Day must be between 1 and 24.') ;
      msg_type := 'E';
  END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRJOBS_HRS_DAY;

CREATE PUBLIC SYNONYM P_EDIT_NBRJOBS_HRS_DAY FOR BANINST1.P_EDIT_NBRJOBS_HRS_DAY;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_DAY TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_DAY TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_DAY TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_DAY TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_DAY TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_DAY TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_DAY TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_DAY TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_DAY TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_DAY TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_DAY TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_DAY TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_DAY TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_DAY TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_DAY TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_DAY TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_DAY TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRJOBS_HRS_PAY;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrjobs_hrs_pay
     ( par_hrs_pay    IN  number,
       msg           OUT  varchar2,
       msg_type      OUT  varchar2)
IS
--
-- FILE NAME..:  nophrpy.sql
-- RELEASE....:  4.1
-- OBJECT NAME:  P_EDIT_NBRJOBS_HRS_PAY
-- PRODUCT....:  POSNCTL
-- USAGE......:  Validates NBRJOBS hours per pay.
--
-- COPYRIGHT..:  Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- Edit - Procedure validates that NBRJOBS hours per pay exists and
--        is greater than zero.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_hrs_pay IS NULL THEN
      msg :=  G$_NLS.Get('NOPHRPY-0000', 'SQL','*ERROR* Standard Hours Per Pay must be entered.') ;
      msg_type := 'E';
      RETURN;
   END IF;
--
   IF NVL(par_hrs_pay,0) <= 0 THEN
      msg :=  G$_NLS.Get('NOPHRPY-0001', 'SQL','*ERROR* Standard Hours Per Pay must be greater than zero.') ;
      msg_type := 'E';
  END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRJOBS_HRS_PAY;

CREATE PUBLIC SYNONYM P_EDIT_NBRJOBS_HRS_PAY FOR BANINST1.P_EDIT_NBRJOBS_HRS_PAY;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_PAY TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_PAY TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_PAY TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_PAY TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_PAY TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_PAY TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_PAY TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_PAY TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_PAY TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_PAY TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_PAY TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_PAY TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_PAY TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_PAY TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_PAY TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_PAY TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_HRS_PAY TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRJOBS_PAYS;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrjobs_pays
     (par_pays                 IN      number,
      par_pays_per_year        IN      number,
      msg                      OUT     varchar2,
      msg_type                 OUT     varchar2)
IS
--
-- FILE NAME..: noppay1.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRJOBS_PAYS
-- PRODUCT....: POSNCTL
-- USAGE......: Validate the existence of the Number of Pays (NBRJOBS).
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates the existence of the Number of Pays (NBRJOBS).
-- The number of pays must be less than the pay ID's number of pays per year and
-- greater than zero.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_pays IS NULL THEN
      msg :=  G$_NLS.Get('NOPPAY1-0000', 'SQL','*ERROR* Number of pays must be entered.') ;
      msg_type := 'E';
      RETURN;
   END IF;
--
   IF par_pays <= 0 THEN
      msg :=  G$_NLS.Get('NOPPAY1-0001', 'SQL','*ERROR* Pays must be greater than zero.') ;
      msg_type := 'E';
   ELSE
      IF par_pays_per_year IS NOT NULL THEN
         IF par_pays > par_pays_per_year THEN
            msg :=  G$_NLS.Get('NOPPAY1-0002', 'SQL','*ERROR* Pays cannot be greater than the payroll ID''s number of pays per year.')
                   ;
            msg_type := 'E';
         END IF;
      END IF;
   END IF;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRJOBS_PAYS;

CREATE PUBLIC SYNONYM P_EDIT_NBRJOBS_PAYS FOR BANINST1.P_EDIT_NBRJOBS_PAYS;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PAYS TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PAYS TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PAYS TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PAYS TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PAYS TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PAYS TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PAYS TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PAYS TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PAYS TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PAYS TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PAYS TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PAYS TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PAYS TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PAYS TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PAYS TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PAYS TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PAYS TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRJOBS_PICT_CODE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrjobs_pict_code
     (par_pict_code          IN      varchar2,
      par_ecls_code          IN      varchar2,
      par_dfpr_code          IN      varchar2,
      par_exe_source         IN      varchar2,
      par_eff_date           IN      date,
      par_hrsys_ind          IN      varchar2,
      msg                   OUT      varchar2,
      msg_type              OUT      varchar2)
IS
--
-- FILE NAME..: nopepid.sql
-- RELEASE....: 6.0
-- OBJECT NAME: P_EDIT_NBRJOBS_PICT_CODE
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edits on Pay ID Code.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure performs edits on the Pay ID Code that has been entered
-- or modified for a particular job.
--
-- DESCRIPTION END
--
--
   var_msg           noreaer.noreaer_error_msg%TYPE := NULL;
   var_msg_type      noreaer.noreaer_msg_type%TYPE  := NULL;
   var_pays_per_year number(3,1) := NULL;
   var_pict_desc     varchar2(30) := NULL;
   var_year          varchar2(4) := NULL;
   var_payno         number(3) := NULL;
--
BEGIN
--
   msg := NULL;
   msg_type := NULL;
--
   IF par_pict_code IS NULL THEN
      msg := '*ERROR* Pay ID Code must be entered.';
      msg_type := 'E';
   ELSE
      IF par_hrsys_ind <> 'Y' THEN
         nokflib.p_edit_pict_fin(
            par_ecls_code,
            par_pict_code,
            var_msg,
            var_msg_type);
      ELSE
         nokplib.p_edit_pict(
            par_pict_code,
            par_exe_source,
            var_pays_per_year,
            var_pict_desc,
            var_msg,
            var_msg_type);
         IF var_msg IS NOT NULL THEN
            msg := var_msg;
            msg_type := var_msg_type;
         ELSE
            nokplib.p_edit_pict_dfpr(
               par_pict_code,
               par_dfpr_code,
               var_msg,
               var_msg_type);
            IF var_msg IS NOT NULL THEN
               msg := var_msg;
               msg_type := var_msg_type;
            ELSE
               nokplib.p_edit_pict_caln(
                  par_pict_code,
                  par_eff_date,
                  var_year,
                  var_payno,
                  var_msg,
                  var_msg_type);
               IF var_msg IS NOT NULL THEN
                  msg := var_msg;
                  msg_type := var_msg_type;
               END IF;
            END IF;
         END IF;
      END IF;
   END IF;
--

END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRJOBS_PICT_CODE;

CREATE PUBLIC SYNONYM P_EDIT_NBRJOBS_PICT_CODE FOR BANINST1.P_EDIT_NBRJOBS_PICT_CODE;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO BANIMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRJOBS_PICT_CODE_LEAV;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrjobs_pict_code_leav
     (par_pict_code_leav_rept          IN      varchar2,
      par_ecls_code                    IN      varchar2,
      par_exe_source                   IN      varchar2,
      par_eff_date                     IN      date,
      par_hrsys_ind                    IN      varchar2,
      msg                              OUT     varchar2,
      msg_type                         OUT     varchar2)
IS
--
-- FILE NAME..: nopelrp.sql
-- RELEASE....: 6.0
-- OBJECT NAME: P_EDIT_NBRJOBS_PICT_CODE_LEAV
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edits on Leave Report Pay ID Code.
-- COPYRIGHT..: Copyright (c) SCT Corporation 2002.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure performs edits on the Leave Report Pay ID Code that has been
-- entered or modified for a particular job.
--
-- DESCRIPTION END
--
--
   var_msg           noreaer.noreaer_error_msg%TYPE := NULL;
   var_msg_type      noreaer.noreaer_msg_type%TYPE  := NULL;
   var_pays_per_year number(3,1) := NULL;
   var_pict_desc     varchar2(30) := NULL;
   var_year          varchar2(4) := NULL;
   var_payno         number(3) := NULL;
--
BEGIN
--
   msg := NULL;
   msg_type := NULL;
--
   IF par_pict_code_leav_rept IS NULL THEN
      msg := '*ERROR* Leave Report Pay ID Code must be entered.';
      msg_type := 'E';
   ELSE
      IF par_hrsys_ind <> 'Y' THEN
         nokflib.p_edit_pict_fin(
            par_ecls_code,
            par_pict_code_leav_rept,
            var_msg,
            var_msg_type);
      ELSE
         nokplib.p_edit_pict(
            par_pict_code_leav_rept,
            par_exe_source,
            var_pays_per_year,
            var_pict_desc,
            var_msg,
            var_msg_type);
         IF var_msg IS NOT NULL THEN
            msg := var_msg;
            msg_type := var_msg_type;
         ELSE
            nokplib.p_edit_pict_caln(
               par_pict_code_leav_rept,
               par_eff_date,
               var_year,
               var_payno,
               var_msg,
               var_msg_type);
            IF var_msg IS NOT NULL THEN
               msg := var_msg;
               msg_type := var_msg_type;
            END IF;
         END IF;
      END IF;
   END IF;
--

END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRJOBS_PICT_CODE_LEAV;

CREATE PUBLIC SYNONYM P_EDIT_NBRJOBS_PICT_CODE_LEAV FOR BANINST1.P_EDIT_NBRJOBS_PICT_CODE_LEAV;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE_LEAV TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE_LEAV TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE_LEAV TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE_LEAV TO BANIMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE_LEAV TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE_LEAV TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE_LEAV TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE_LEAV TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE_LEAV TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE_LEAV TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_PICT_CODE_LEAV TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRJOBS_REG_RATE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrjobs_reg_rate
     (par_rate       IN  nbrjobs.nbrjobs_reg_rate%TYPE,
      par_step       IN  nbrjobs.nbrjobs_sal_step%TYPE,
      msg           OUT  noreaer.noreaer_msg_type%TYPE,
      msg_type      OUT  noreaer.noreaer_error_msg%TYPE)
IS
--
-- FILE NAME..: nopcrte.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRJOBS_REG_RATE
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edits on the regular rate.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure performs edit when modifying the job regular hourly rate
-- for an existing salary step.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF NVL(par_step,0) <> 0 and par_rate IS NOT NULL THEN
      msg :=  G$_NLS.Get('NOPCRTE-0000', 'SQL','*ERROR* Cannot change the rate when the step is not zero.') ;
      msg_type := 'E';
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRJOBS_REG_RATE;

CREATE PUBLIC SYNONYM P_EDIT_NBRJOBS_REG_RATE FOR BANINST1.P_EDIT_NBRJOBS_REG_RATE;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_REG_RATE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_REG_RATE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_REG_RATE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_REG_RATE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_REG_RATE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_REG_RATE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_REG_RATE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_REG_RATE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_REG_RATE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_REG_RATE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_REG_RATE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_REG_RATE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_REG_RATE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_REG_RATE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_REG_RATE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_REG_RATE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_REG_RATE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NBRJOBS_STATUS;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_nbrjobs_status
     (par_status             IN  varchar2,
      par_last_paid_date     IN  date,
      par_effective_date     IN  date,
      par_pidm               IN  number,
      par_posn               IN  varchar2,
      par_suff               IN  varchar2,
      par_source             IN  varchar2,
      par_hrsys_ind          IN  varchar2,
      par_base_end_date  IN OUT  date,
      msg                   OUT  varchar2,
      msg_type              OUT  varchar2)
IS
--
-- FILE NAME..: nopstat.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NBRJOBS_STATUS
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edits and defaults when the job status is changed.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure performs edits and defaults when the job status
-- (NBRJOBS_STATUS) is changed.
--
-- DESCRIPTION END
--
   var_effective_date    nbrjobs.nbrjobs_effective_date%TYPE :=
                            par_effective_date;
   var_msg               varchar2(80) := NULL;
   var_msg_type          varchar2(1)  := NULL;
   var_pidm              nbrjobs.nbrjobs_pidm%TYPE := par_pidm;
   var_source            varchar2(4) := par_source;
   var_status            nbrjobs.nbrjobs_status%TYPE := par_status;
   var_x                 varchar2(1) := NULL;
--
   CURSOR check_supervisor IS
      SELECT 'X'
      FROM   DUAL
      WHERE  EXISTS  (
             SELECT 'Y'
             FROM   NBRBJOB, NBRJOBS N
             WHERE  N.NBRJOBS_SUPERVISOR_PIDM = par_pidm
               AND  N.NBRJOBS_SUPERVISOR_POSN = par_posn
               AND  N.NBRJOBS_SUPERVISOR_SUFF = par_suff
               AND  N.NBRJOBS_EFFECTIVE_DATE =  (
               SELECT MAX(J.NBRJOBS_EFFECTIVE_DATE)
               FROM   NBRJOBS J
               WHERE  J.NBRJOBS_PIDM = N.NBRJOBS_PIDM
                 AND  J.NBRJOBS_POSN = N.NBRJOBS_POSN
                 AND  J.NBRJOBS_SUFF = N.NBRJOBS_SUFF
                 AND  J.NBRJOBS_EFFECTIVE_DATE <= (
                      par_base_end_date + 1) )
                 AND  NBRBJOB_PIDM = N.NBRJOBS_PIDM
                 AND  NBRBJOB_POSN = N.NBRJOBS_POSN
                 AND  NBRBJOB_SUFF = N.NBRJOBS_SUFF
                 AND  (NBRBJOB_END_DATE IS NULL
                  OR  NBRBJOB_END_DATE > par_base_end_date));
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_status IS NULL THEN
      msg :=   G$_NLS.Get('NOPSTAT-0000', 'SQL','*ERROR* Job Status must be entered.') ;
      msg_type := 'E';
      RETURN;
   END IF;
--
   IF par_effective_date = par_last_paid_date OR (
      par_effective_date IS NULL AND par_last_paid_date IS NULL) THEN
      IF par_status = 'T' THEN
         IF par_base_end_date = par_effective_date OR
            (par_base_end_date IS NULL AND par_effective_date IS NULL) THEN
             NULL;
         ELSE
            par_base_end_date := par_effective_date;
         END IF;
         OPEN check_supervisor;
         FETCH check_supervisor INTO var_x;
         IF check_supervisor%FOUND THEN
            msg :=  G$_NLS.Get('NOPSTAT-0001', 'SQL','*WARNING* The employee in this position is a supervisor.') ;
            msg_type := 'W';
            CLOSE check_supervisor;
            RETURN;
         END IF;
         CLOSE check_supervisor;
      ELSE
         msg :=  G$_NLS.Get('NOPSTAT-0002', 'SQL','*ERROR* When Eff Date = Last Paid Date; Status may only be changed to term''d.')
                ;
         msg_type := 'E';
      END IF;
   ELSE
      IF par_status IN ('A','L','P','F','B') THEN
         IF par_hrsys_ind = 'Y' THEN
            nokplib.p_edit_lv_dates(var_pidm,
                                    var_effective_date,
                                    var_status,
                                    var_source,
                                    var_msg,
                                    var_msg_type);
            IF var_msg IS NOT NULL THEN
               msg := var_msg;
               msg_type := var_msg_type;
            END IF;
         END IF;
      ELSIF par_status = 'T' THEN
         IF par_base_end_date = par_effective_date OR
            (par_base_end_date IS NULL AND par_effective_date IS NULL) THEN
             NULL;
         ELSE
            par_base_end_date := par_effective_date;
         END IF;
         OPEN check_supervisor;
         FETCH check_supervisor INTO var_x;
         IF check_supervisor%FOUND THEN
            msg :=  G$_NLS.Get('NOPSTAT-0003', 'SQL','*WARNING* The employee in this position is a supervisor.') ;
            msg_type := 'W';
            CLOSE check_supervisor;
            RETURN;
         END IF;
         CLOSE check_supervisor;
      END IF;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_NBRJOBS_STATUS;

CREATE PUBLIC SYNONYM P_EDIT_NBRJOBS_STATUS FOR BANINST1.P_EDIT_NBRJOBS_STATUS;


GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_STATUS TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_STATUS TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_STATUS TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_STATUS TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_STATUS TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_STATUS TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_STATUS TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_STATUS TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_STATUS TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_STATUS TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_STATUS TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_STATUS TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_STATUS TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_STATUS TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_STATUS TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_STATUS TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NBRJOBS_STATUS TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NO_ENTRY;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_no_entry
     (par_field        IN  varchar2,
      msg             OUT  varchar2,
      msg_type        OUT  varchar2)
IS
--
-- FILE NAME..: nopnupd.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_NO_ENTRY
-- PRODUCT....: POSNCTL
-- USAGE......: Construct an error message for non-enterable fields.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure constructs an error message for non-enterable fields.
--
-- DESCRIPTION END
--
--
BEGIN
      msg :=  G$_NLS.Get('NOPNUPD-0000', 'SQL',
	'*ERROR* %01% cannot be entered.'
	,  par_field );
      msg_type := 'E';
END;
/


DROP PUBLIC SYNONYM P_EDIT_NO_ENTRY;

CREATE PUBLIC SYNONYM P_EDIT_NO_ENTRY FOR BANINST1.P_EDIT_NO_ENTRY;


GRANT EXECUTE ON BANINST1.P_EDIT_NO_ENTRY TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_ENTRY TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_ENTRY TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_ENTRY TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_ENTRY TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_ENTRY TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_ENTRY TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_ENTRY TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_ENTRY TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_ENTRY TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_ENTRY TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_ENTRY TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_ENTRY TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_ENTRY TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_ENTRY TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_ENTRY TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_ENTRY TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_NO_HR;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_no_hr
     (par_field        IN  varchar2,
      msg             OUT  varchar2,
      msg_type        OUT  varchar2)
IS
--
-- FILE NAME..: nopnohr.sql
-- RELEASE....: 4.1
-- OBJECT NAME: p_edit_no_hr
-- PRODUCT....: POSNCTL
-- USAGE......: Edit on any not null value passed.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure returns error for any not null value passed, indicating that
-- Banner HR must be installed for field to be valued. Field type must be
-- character.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_field IS NOT NULL THEN
      msg :=   G$_NLS.Get('NOPNOHR-0000', 'SQL','*ERROR* Field/Function is valid only when Banner HR installed.') ;
      msg_type := 'E';
   END IF;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_NO_HR;

CREATE PUBLIC SYNONYM P_EDIT_NO_HR FOR BANINST1.P_EDIT_NO_HR;


GRANT EXECUTE ON BANINST1.P_EDIT_NO_HR TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_HR TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_HR TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_HR TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_HR TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_HR TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_HR TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_HR TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_HR TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_HR TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_HR TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_HR TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_HR TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_HR TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_HR TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_HR TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_NO_HR TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PAYS_FACTOR_DFPR;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_pays_factor_dfpr
      (par_jobs_dfpr_code IN  varchar2,
       par_jobs_factor    IN  number,
       par_jobs_pays      IN  number,
       par_dfpr_factor    IN  number,
       par_dfpr_pays      IN  number,
       msg               OUT  varchar2,
       msg_type          OUT  varchar2)
IS
--
-- FILE NAME..:  nopedfp.sql
-- RELEASE....:  4.1
-- OBJECT NAME:  P_EDIT_PAYS_FACTOR_DFPR
-- PRODUCT....:  POSNCTL
-- USAGE......:  Validates the factor and pays entered against PTRDFPR.
--
-- COPYRIGHT..:  Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- Edit - Procedure validates the factor and pays entered against
--        the PTRDFPR factor and pays when the defer pay code is not
--        null.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_jobs_dfpr_code IS NOT NULL THEN
      IF par_dfpr_pays <> par_jobs_pays THEN
         msg :=   G$_NLS.Get('NOPEDFP-0000', 'SQL','*ERROR* Number of pays must equal the Pays on the Defer Pay Rule Form.')
                 ;
         msg_type := 'E';
         RETURN;
      END IF;
      IF par_dfpr_factor <> par_jobs_factor THEN
         msg :=   G$_NLS.Get('NOPEDFP-0001', 'SQL','*ERROR* The Factor must equal the Factor on the Defer Pay Rule Form.')
                 ;
         msg_type := 'E';
         RETURN;
      END IF;
   END IF;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_PAYS_FACTOR_DFPR;

CREATE PUBLIC SYNONYM P_EDIT_PAYS_FACTOR_DFPR FOR BANINST1.P_EDIT_PAYS_FACTOR_DFPR;


GRANT EXECUTE ON BANINST1.P_EDIT_PAYS_FACTOR_DFPR TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PAYS_FACTOR_DFPR TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PAYS_FACTOR_DFPR TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PAYS_FACTOR_DFPR TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PAYS_FACTOR_DFPR TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PAYS_FACTOR_DFPR TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PAYS_FACTOR_DFPR TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PAYS_FACTOR_DFPR TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PAYS_FACTOR_DFPR TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PAYS_FACTOR_DFPR TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PAYS_FACTOR_DFPR TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PAYS_FACTOR_DFPR TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PAYS_FACTOR_DFPR TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PAYS_FACTOR_DFPR TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PAYS_FACTOR_DFPR TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PAYS_FACTOR_DFPR TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PAYS_FACTOR_DFPR TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_pebempl_cur_hire_date
     (par_current_hire_date    IN      date,
      par_first_hire_date      IN      date,
      msg                      OUT     varchar2,
      msg_type                 OUT     varchar2)
IS
--
-- FILE NAME..: nopchir.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_PEBEMPL_CUR_HIRE_DATE
-- PRODUCT....: POSNCTL
-- USAGE......: Validate the current hire date for an employee.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates the current hire date for an employee in the
-- Employee Base Table (PEBEMPL).
--
-- DESCRIPTION END
--
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_current_hire_date IS NULL THEN
      msg :=  G$_NLS.Get('NOPCHIR-0000', 'SQL','*ERROR* Current Hire Date is required.') ;
      msg_type := 'E';
   ELSE
     IF par_first_hire_date IS NOT NULL THEN
       IF par_current_hire_date < par_first_hire_date
       THEN
          msg :=  G$_NLS.Get('NOPCHIR-0001', 'SQL','*ERROR*  Current hire date must be later than original hire date.')
                 ;
          msg_type := 'E';
       END IF;
     END IF;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_PEBEMPL_CUR_HIRE_DATE;

CREATE PUBLIC SYNONYM P_EDIT_PEBEMPL_CUR_HIRE_DATE FOR BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE;


GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_CUR_HIRE_DATE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PEBEMPL_DICD_CODE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_pebempl_dicd_code
     (par_dicd_code  IN varchar2,
      par_desc   IN OUT varchar2,
      exe_source     IN varchar2,
      msg           OUT varchar2,
      msg_type      OUT varchar2)
IS
--
-- FILE NAME..: nopdicd.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_PEBEMPL_DICD_CODE
-- PRODUCT....: POSNCTL
-- USAGE......: Verify district/division code.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure verifies a valid district/division code was entered.
--
-- DESCRIPTION END
--
   CURSOR c1  IS
         SELECT gtvdicd_desc
           FROM gtvdicd
          WHERE gtvdicd_code = par_dicd_code ;
    var_string    varchar2(50)   := null;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_dicd_code IS NOT NULL THEN
      OPEN c1 ;
      FETCH c1 INTO par_desc;
      IF c1%NOTFOUND THEN
         par_desc := NULL;
         IF exe_source <> 'MASS' THEN
            var_string :=  G$_NLS.Get('NOPDICD-0001', 'SQL','Press LIST for valid codes.') ;
         END IF;
         msg :=  G$_NLS.Get('NOPDICD-0002', 'SQL',
	'*ERROR* Invalid District/Division Code. %01%'
	, var_string);
         msg_type := 'E';
      END IF;
   CLOSE c1;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_PEBEMPL_DICD_CODE;

CREATE PUBLIC SYNONYM P_EDIT_PEBEMPL_DICD_CODE FOR BANINST1.P_EDIT_PEBEMPL_DICD_CODE;


GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_DICD_CODE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_DICD_CODE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_DICD_CODE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_DICD_CODE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_DICD_CODE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_DICD_CODE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_DICD_CODE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_DICD_CODE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_DICD_CODE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_DICD_CODE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_DICD_CODE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_DICD_CODE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_DICD_CODE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_DICD_CODE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_DICD_CODE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_DICD_CODE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_DICD_CODE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PEBEMPL_EGRP_CODE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_pebempl_egrp_code
            (par_egrp_code  IN varchar2,
             par_desc   IN OUT varchar2,
             exe_source     IN varchar2,
             msg           OUT varchar2,
             msg_type      OUT varchar2)
 IS
--
-- FILE NAME..: nopegrp.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_PEBEMPL_EGRP_CODE
-- PRODUCT....: POSNCTL
-- USAGE......: Validate Employee Group Code.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates the Employee Group Code based on the values
-- in the Employee Group Code table (PTVEGRP).
--
-- DESCRIPTION END
--
     var_string   varchar2(48)  := null;
     ptvegrp_rec  nokplib.ptvegrpc%ROWTYPE;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_egrp_code IS NOT NULL THEN
      OPEN nokplib.ptvegrpc(par_egrp_code) ;
      FETCH nokplib.ptvegrpc INTO ptvegrp_rec;
      IF nokplib.ptvegrpc%NOTFOUND THEN
         par_desc := NULL;
         IF exe_source <> 'MASS' THEN
            var_string :=  G$_NLS.Get('NOPEGRP-0001', 'SQL','Press LIST for valid codes.') ;
         END IF;
         msg :=  G$_NLS.Get('NOPEGRP-0002', 'SQL',
	'*ERROR* Invalid Employee Group Code. %01%'
	, var_string);
         msg_type := 'E';
      ELSE
         par_desc := ptvegrp_rec.ptvegrp_desc;
      END IF;
      CLOSE nokplib.ptvegrpc;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_PEBEMPL_EGRP_CODE;

CREATE PUBLIC SYNONYM P_EDIT_PEBEMPL_EGRP_CODE FOR BANINST1.P_EDIT_PEBEMPL_EGRP_CODE;


GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_EGRP_CODE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_EGRP_CODE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_EGRP_CODE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_EGRP_CODE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_EGRP_CODE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_EGRP_CODE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_EGRP_CODE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_EGRP_CODE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_EGRP_CODE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_EGRP_CODE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_EGRP_CODE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_EGRP_CODE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_EGRP_CODE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_EGRP_CODE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_EGRP_CODE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_EGRP_CODE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_EGRP_CODE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_pebempl_first_hire_dat
       (par_first_hire_date   IN date,
        par_current_hire_date IN date,
        msg                  OUT varchar2,
        msg_type             OUT varchar2)
IS
--
-- FILE NAME..: nophire.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_PEBEMPL_FIRST_HIRE_DAT
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edit on the First Hire Date.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This Procedure verifies existence of the First Hire Date for inserts/updates
-- to PEBEMPL. It also validates First Hire Date is less than Current Hire
-- Date.
--
-- DESCRIPTION END
--
  BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_first_hire_date IS NULL
   THEN
       msg :=  G$_NLS.Get('NOPHIRE-0000', 'SQL','*ERROR* First Hire Date must be entered.') ;
       msg_type := 'E';
   ELSE
     IF par_current_hire_date IS NOT NULL THEN
       IF par_current_hire_date < par_first_hire_date
       THEN
          msg :=  G$_NLS.Get('NOPHIRE-0001', 'SQL','*ERROR*  Current hire date must be later than original hire date.')
                 ;
          msg_type := 'E';
       END IF;
     END IF;
   END IF;
  END;
/


DROP PUBLIC SYNONYM P_EDIT_PEBEMPL_FIRST_HIRE_DAT;

CREATE PUBLIC SYNONYM P_EDIT_PEBEMPL_FIRST_HIRE_DAT FOR BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT;


GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_HIRE_DAT TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_pebempl_first_work_d
     (par_first_work_date   IN date,
      par_last_work_date    IN date,
      msg                  OUT varchar2,
      msg_type             OUT varchar2)
IS
--
-- FILE NAME..: nopwork.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_PEBEMPL_FIRST_WORK_D
-- PRODUCT....: POSNCTL
-- USAGE......: Verifies the Last Work Date against the First Work Date.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure verifies that the Last Work Date is later or same dated
-- than the First Work Date.
--
-- DESCRIPTION END
--
  BEGIN
     msg := NULL;
     msg_type := NULL;
--
     IF par_first_work_date IS NOT NULL and
        par_last_work_date  IS NOT NULL
     THEN
       IF par_first_work_date > par_last_work_date
       THEN
          msg :=  G$_NLS.Get('NOPWORK-0000', 'SQL','*ERROR* First Work Date must be less than or equal to Last Work Date.')
                  ;
          msg_type := 'E';
       END IF;
     END IF;
  END;
/


DROP PUBLIC SYNONYM P_EDIT_PEBEMPL_FIRST_WORK_D;

CREATE PUBLIC SYNONYM P_EDIT_PEBEMPL_FIRST_WORK_D FOR BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D;


GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_FIRST_WORK_D TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PEBEMPL_I9_DATE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_pebempl_i9_date
    (par_location_ind        IN varchar2,
     par_i9_date             IN date,
     par_i9_expire_date      IN date,
     msg                    OUT varchar2,
     msg_type               OUT varchar2)
IS
--
-- FILE NAME..:  nopi9da.sql
-- RELEASE....:  4.1
-- OBJECT NAME:  P_EDIT_PEBEMPL_I9_DATE
-- PRODUCT....:  POSNCTL
-- USAGE......:  Verifies I9 date against I9 Expiration date.
--
-- COPYRIGHT..:  Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- Edit - Procedure verifies that the entered I9 Date is not greater
--        than the I9 Expiration Date.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_location_ind = 'U' THEN
      IF par_i9_expire_date IS NOT NULL AND
         (par_i9_expire_date <= par_i9_date)
      THEN
         msg :=  G$_NLS.Get('NOPI9DA-0000', 'SQL','*ERROR*  I9 Date must be prior to I9 Expire Date.') ;
         msg_type := 'E';
      END IF;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_PEBEMPL_I9_DATE;

CREATE PUBLIC SYNONYM P_EDIT_PEBEMPL_I9_DATE FOR BANINST1.P_EDIT_PEBEMPL_I9_DATE;


GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_DATE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_DATE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_DATE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_DATE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_DATE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_DATE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_DATE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_DATE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_DATE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_DATE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_DATE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_DATE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_DATE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_DATE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_DATE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_DATE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_DATE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_pebempl_i9_expire_date
     (par_location_ind     IN varchar2,
      par_i9_date          IN date,
      par_i9_expire_date   IN date,
      msg                 OUT varchar2,
      msg_type            OUT varchar2)
IS
--
-- FILE NAME..:  nopi9ex.sql
-- RELEASE....:  4.1
-- OBJECT NAME:  P_EDIT_PEBEMPL_I9_EXPIRE_DATE
-- PRODUCT....:  POSNCTL
-- USAGE......:  Verifies I9 expiration date against I9 date.
--
-- COPYRIGHT..:  Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- Edit - Procedure verifies that the I9 Expiration Date is not less
--        than the I9 Date.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_location_ind = 'U' THEN
       IF par_i9_date > par_i9_expire_date
       THEN
          msg :=  G$_NLS.Get('NOPI9EX-0000', 'SQL','*ERROR*  I9 Expiration Date must be later than or equal to I9 Date.')
                  ;
          msg_type := 'E';
       END IF;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_PEBEMPL_I9_EXPIRE_DATE;

CREATE PUBLIC SYNONYM P_EDIT_PEBEMPL_I9_EXPIRE_DATE FOR BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE;


GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_EXPIRE_DATE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PEBEMPL_I9_INFO;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_pebempl_i9_info
      ( par_location_ind     IN varchar2,
        par_i9_form_ind      IN varchar2,
        par_i9_date          IN date,
        par_i9_expire_date   IN date,
        msg              IN OUT varchar2,
        msg_type         IN OUT varchar2)
IS
--
-- FILE NAME..:  nopi9in.sql
-- RELEASE....:  4.1
-- OBJECT NAME:  P_EDIT_PEBEMPL_I9_INFO
-- PRODUCT....:  POSNCTL
-- USAGE......:  Procedure performs all edits on i9 empl changes.
--
-- COPYRIGHT..:  Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
--  Edit - Procedure performs all edits on i9 empl changes.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_location_ind <> 'U' THEN
      RETURN;
   END IF;
--
   IF par_i9_form_ind IS NULL THEN
      IF par_i9_date IS NULL THEN
         IF par_i9_expire_date IS NOT NULL THEN
            msg :=   G$_NLS.Get('NOPI9IN-0000', 'SQL','*ERROR*  I9 Form Indicator and I9 Date must be entered.') ;
            msg_type := 'E';
         END IF ;
      ELSE
           msg :=   G$_NLS.Get('NOPI9IN-0001', 'SQL','*ERROR*  I9 Form Indicator must be entered if I9 Date is entered.')
                   ;
           msg_type := 'E';
      END IF ;
   ELSIF par_i9_form_ind = 'T' THEN
      IF par_i9_date IS NULL THEN
         msg :=  G$_NLS.Get('NOPI9IN-0002', 'SQL','*ERROR*  I9 Date must be entered.') ;
         msg_type := 'E';
      ELSE
         IF par_i9_expire_date IS NULL THEN
            msg :=  G$_NLS.Get('NOPI9IN-0003', 'SQL','*ERROR*  I9 Date and I9 Expiration Date must be entered.') ;
            msg_type := 'E';
         END IF ;
      END IF ;
   ELSIF par_i9_form_ind = 'E' THEN
      IF par_i9_expire_date IS NOT NULL THEN
         msg :=  G$_NLS.Get('NOPI9IN-0004', 'SQL','*ERROR* I9 Expiration Date not allowed when I9 Form Indicator = Exempt.')
                 ;
         msg_type := 'E';
      END IF ;
   ELSIF par_i9_form_ind = 'N' THEN
      IF par_i9_date IS NULL THEN
         IF par_i9_expire_date IS NOT NULL THEN
            msg :=  G$_NLS.Get('NOPI9IN-0005', 'SQL','*ERROR* I9 Expiration Date not allowed when I9 Form Indicator = Not Received.')
                ;
            msg_type := 'E';
         END IF ;
      ELSE
        msg :=  G$_NLS.Get('NOPI9IN-0006', 'SQL','*ERROR* I9 Date not allowed when I9 Form Indicator = Not Received.')
               ;
        msg_type := 'E';
      END IF ;
   ELSE
      IF par_i9_date is NULL THEN
         msg :=  G$_NLS.Get('NOPI9IN-0007', 'SQL','*ERROR*  I9 Date must be entered.') ;
         msg_type := 'E';
      ELSE
         IF par_i9_expire_date IS NOT NULL THEN
            msg :=  G$_NLS.Get('NOPI9IN-0008', 'SQL','*ERROR*  I9 Expiration Date not allowed when I9 Form Indicator = Received.')
                   ;
            msg_type := 'E';
         END IF ;
      END IF ;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_PEBEMPL_I9_INFO;

CREATE PUBLIC SYNONYM P_EDIT_PEBEMPL_I9_INFO FOR BANINST1.P_EDIT_PEBEMPL_I9_INFO;


GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_INFO TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_INFO TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_INFO TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_INFO TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_INFO TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_INFO TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_INFO TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_INFO TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_INFO TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_INFO TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_INFO TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_INFO TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_INFO TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_INFO TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_INFO TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_INFO TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_I9_INFO TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_pebempl_last_work_date
     (par_first_work_date   IN  date,
      par_last_work_date    IN  date,
      msg                  OUT varchar2,
      msg_type             OUT varchar2)
IS
--
-- FILE NAME..: noplast.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_PEBEMPL_LAST_WORK_DATE
-- PRODUCT....: POSNCTL
-- USAGE......: Comparing two dates.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure verifies that the Last Work Date entered is not less than
-- the First Work Date entered.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
IF par_first_work_date IS NOT NULL AND par_last_work_date IS NOT NULL
THEN
   IF par_last_work_date < par_first_work_date
   THEN
        msg :=  G$_NLS.Get('NOPLAST-0000', 'SQL','*ERROR* Last Work Date must be greater than or same as First Work Date.')
               ;
        msg_type := 'E';
   END IF;
END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_PEBEMPL_LAST_WORK_DATE;

CREATE PUBLIC SYNONYM P_EDIT_PEBEMPL_LAST_WORK_DATE FOR BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE;


GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LAST_WORK_DATE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_pebempl_loa_end_date
     (par_loa_end_date    IN  date,
      par_loa_beg_date    IN  date,
      par_pidm            IN  number,
      par_trans_no        IN  number,
      par_exe_source      IN  varchar2,
      msg                 OUT varchar2,
      msg_type            OUT varchar2)
IS
--
-- FILE NAME..: noploae.sql
-- RELEASE....: 7.1
-- OBJECT NAME: P_EDIT_PEBEMPL_LOA_END_DATE
-- PRODUCT....: POSNCTL
-- USAGE......: Perfoms edit on Leave End Date.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This Procedure verifies that the Leave End Date is not less than
-- the Leave Begin Date and that the employee does not have any jobs
-- with a leave status beyond the Leave End Date entered.
--
-- DESCRIPTION END
--
     var_dummy     varchar2(1) := NULL;
     var_posn      varchar2(6) := NULL;
     var_suff      varchar2(2) := NULL;
--
    CURSOR c1   (cur_par_end_date NUMBER)
    IS
        SELECT nbrbjob_posn, nbrbjob_suff
          FROM nbrbjob,
               nbrjobs X
         WHERE nbrbjob_pidm = par_pidm
           AND nbrbjob_pidm = nbrjobs_pidm
           AND nbrbjob_posn = nbrjobs_posn
           AND nbrbjob_suff = nbrjobs_suff
           AND (nbrbjob_end_date is null or
                nbrbjob_end_date > to_date(cur_par_end_date,'J'))
           AND nbrjobs_status IN ('L', 'B', 'P', 'F')
           AND nbrjobs_pers_chg_date =
                    ( SELECT MAX(nbrjobs_pers_chg_date)
                        FROM nbrjobs
                       WHERE nbrjobs_pidm = X.nbrjobs_pidm
                         AND nbrjobs_posn = X.nbrjobs_posn
                         AND nbrjobs_suff = X.nbrjobs_suff
                         AND nbrjobs_pers_chg_date <= to_date(cur_par_end_date,'J'));
--
   CURSOR check_for_react IS
   SELECT 'X'
   FROM nortran N
   WHERE N.nortran_transaction_no = par_trans_no
     AND N.nortran_posn = var_posn
     AND N.nortran_suff = var_suff
     AND N.nortran_aufd_code = 'NBRJOBS_STATUS'
     AND N.nortran_value = 'A'
     AND EXISTS
         (SELECT 'X'
          FROM nortran D
          WHERE D.nortran_transaction_no = par_trans_no
            AND D.nortran_posn = var_posn
            AND D.nortran_suff = var_suff
            AND (D.nortran_aufd_code = 'NBRJOBS_PERS_CHG_DATE'
            AND (to_date(D.nortran_value,'DD-MON-YYYY') = par_loa_end_date
                 OR to_date(D.nortran_value,'DD-MON-YYYY') =
                 par_loa_end_date + 1)));
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
    IF par_loa_end_date < par_loa_beg_date THEN
       msg := '*ERROR* Leave of absence end date must be greater than' ||
             ' or same as begin date.';
       msg_type := 'E';
    ELSE
       OPEN c1(to_number(to_char(par_loa_end_date,'J')) + 1);
       LOOP
          FETCH c1 INTO var_posn, var_suff;
          EXIT WHEN c1%NOTFOUND;
          IF c1%FOUND THEN
             IF par_exe_source IN ('PAF','MASS') THEN
                OPEN check_for_react;
                FETCH check_for_react INTO var_dummy;
                IF check_for_react%NOTFOUND THEN
                 msg := '*ERROR* Job(s) Exist with leave status on or after ' ||
                        'Leave End Date Entered';
                   msg_type := 'E';
                   CLOSE check_for_react;
                   CLOSE c1;
                   RETURN;
                END IF;
             ELSE
                msg := '*ERROR* Job(s) Exist with leave status on or after ' ||
                       'Leave End Date Entered';
                msg_type := 'E';
             END IF;
          END IF;
       END LOOP;
       CLOSE c1;
    END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_PEBEMPL_LOA_END_DATE;

CREATE PUBLIC SYNONYM P_EDIT_PEBEMPL_LOA_END_DATE FOR BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE;


GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO PAYROLL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LOA_END_DATE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PEBEMPL_LREA_CODE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_pebempl_lrea_code
     (par_trea_code    IN  varchar2,
      par_lrea_code    IN  varchar2,
      par_desc     IN OUT  varchar2,
      exe_source       IN  varchar2,
      msg             OUT  varchar2,
      msg_type        OUT  varchar,
      edit_num     IN OUT  number)
IS
--
-- FILE NAME..: noplrea.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_PEBEMPL_LREA_CODE
-- PRODUCT....: POSNCTL
-- USAGE......: Validation of the Leave Reason Code.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- Procedure validates the Leave Reason Code entered and whether the employee
-- has current termination information which needs to be removed before
-- the leave information can be entered.
--
-- DESCRIPTION END
--
  var_string   varchar2(45)  := NULL;
  end_edit     number(2)      := 99;
  ptrlrea_rec  nokplib.ptrlreac%ROWTYPE;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
  IF edit_num = 1 THEN
     edit_num := edit_num + 1;
     IF par_trea_code IS NOT NULL THEN
       msg :=  G$_NLS.Get('NOPLREA-0000', 'SQL','*ERROR*  Termination information has been entered for this employee.') ;
       msg_type := 'E';
       RETURN;
     END IF;
  END IF;
  IF edit_num = 2 THEN
      edit_num := end_edit;
      IF par_lrea_code IS NOT NULL THEN
         OPEN nokplib.ptrlreac(par_lrea_code);
         FETCH nokplib.ptrlreac INTO ptrlrea_rec;
         IF nokplib.ptrlreac%NOTFOUND THEN
              par_desc := NULL;
              IF exe_source <> 'MASS' THEN
                   var_string :=  G$_NLS.Get('NOPLREA-0002', 'SQL','Press LIST for valid codes.') ;
              END IF;
              msg :=  G$_NLS.Get('NOPLREA-0003', 'SQL',
	'*ERROR* Invalid Leave Reason Code. %01%'
	, var_string);
              msg_type := 'E';
         ELSE
              par_desc := ptrlrea_rec.ptrlrea_desc;
         END IF;
         CLOSE nokplib.ptrlreac;
      END IF;
 END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_PEBEMPL_LREA_CODE;

CREATE PUBLIC SYNONYM P_EDIT_PEBEMPL_LREA_CODE FOR BANINST1.P_EDIT_PEBEMPL_LREA_CODE;


GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LREA_CODE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LREA_CODE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LREA_CODE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LREA_CODE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LREA_CODE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LREA_CODE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LREA_CODE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LREA_CODE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LREA_CODE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LREA_CODE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LREA_CODE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LREA_CODE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LREA_CODE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LREA_CODE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LREA_CODE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LREA_CODE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_LREA_CODE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PEBEMPL_NRSI_CODE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_pebempl_nrsi_code
            (par_nrsi_code  IN varchar2,
             par_desc   IN OUT varchar2,
             exe_source     IN varchar2,
             msg           OUT varchar2,
             msg_type      OUT varchar2)
 IS
--
-- FILE NAME..: nopnrsi.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_PEBEMPL_NRSI_CODE
-- PRODUCT....: POSNCTL
-- USAGE......: Validate the Service Industry Code entered.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates the Service Industry Code entered.
--
-- DESCRIPTION END
--
     var_string   varchar2(48)  := null;
     ptvnrsi_rec  nokplib.ptvnrsic%ROWTYPE;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_nrsi_code IS NOT NULL THEN
      OPEN nokplib.ptvnrsic(par_nrsi_code) ;
      FETCH nokplib.ptvnrsic INTO ptvnrsi_rec;
      IF nokplib.ptvnrsic%NOTFOUND THEN
         par_desc := NULL;
         IF exe_source <> 'MASS' THEN
            var_string :=  G$_NLS.Get('NOPNRSI-0001', 'SQL','Press LIST for valid codes.') ;
         END IF;
         msg :=  G$_NLS.Get('NOPNRSI-0002', 'SQL',
	'*ERROR* Invalid Service Industry Code. %01%'
	, var_string);
         msg_type := 'E';
      ELSE
         par_desc := ptvnrsi_rec.ptvnrsi_desc;
      END IF;
      CLOSE nokplib.ptvnrsic;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_PEBEMPL_NRSI_CODE;

CREATE PUBLIC SYNONYM P_EDIT_PEBEMPL_NRSI_CODE FOR BANINST1.P_EDIT_PEBEMPL_NRSI_CODE;


GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_NRSI_CODE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_NRSI_CODE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_NRSI_CODE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_NRSI_CODE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_NRSI_CODE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_NRSI_CODE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_NRSI_CODE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_NRSI_CODE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_NRSI_CODE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_NRSI_CODE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_NRSI_CODE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PEBEMPL_STGR_CODE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_pebempl_stgr_code
     (par_stgr_code         IN  varchar2,
      par_location          IN  varchar2,
      par_installation      IN  varchar2,
      par_desc           IN OUT varchar2,
      exe_source            IN  varchar2,
      msg                   OUT varchar2,
      msg_type              OUT varchar2)
IS
--
-- FILE NAME..: nopstgr.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_PEBEMPL_STGR_CODE
-- PRODUCT....: POSNCTL
-- USAGE......: Retrieve the Stats Canada Group Description.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates the Stats Canada Group Code and retrieves the
-- group description if the code is valid.
--
-- DESCRIPTION END
--
--
   var_string     varchar2(50)  := null;
   ptvstgr_rec    nokplib.ptvstgrc%ROWTYPE;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
IF par_location = 'C'
THEN
    IF par_stgr_code IS NULL THEN
       IF par_installation = 'G' THEN
          msg :=  G$_NLS.Get('NOPSTGR-0000', 'SQL','*ERROR* Statistical Canada Grouping code must be entered.') ;
          msg_type := 'E';
       END IF;
    ELSE
       IF par_stgr_code IS NOT NULL THEN
        OPEN nokplib.ptvstgrc(par_stgr_code);
        FETCH nokplib.ptvstgrc INTO ptvstgr_rec;
        IF nokplib.ptvstgrc%NOTFOUND THEN
           par_desc := NULL;
           IF exe_source <> 'MASS' THEN
              var_string :=  G$_NLS.Get('NOPSTGR-0002', 'SQL','Press LIST for valid codes.') ;
           END IF;
           msg :=  G$_NLS.Get('NOPSTGR-0003', 'SQL',
	'*ERROR* Invalid Stats Canada Grouping Code. %01%'
	,  var_string);
           msg_type := 'E';
        ELSE
           par_desc := ptvstgr_rec.ptvstgr_desc;
        END IF;
        CLOSE nokplib.ptvstgrc;
       END IF;
   END IF;
END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_PEBEMPL_STGR_CODE;

CREATE PUBLIC SYNONYM P_EDIT_PEBEMPL_STGR_CODE FOR BANINST1.P_EDIT_PEBEMPL_STGR_CODE;


GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_STGR_CODE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_STGR_CODE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_STGR_CODE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_STGR_CODE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_STGR_CODE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_STGR_CODE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_STGR_CODE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_STGR_CODE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_STGR_CODE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_STGR_CODE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_STGR_CODE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_STGR_CODE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_STGR_CODE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_STGR_CODE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_STGR_CODE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_STGR_CODE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_STGR_CODE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PEBEMPL_TERM_DATE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_pebempl_term_date
     (par_loa_end_date        IN   date,
      par_term_date           IN   date,
      par_current_hire_date   IN   date,
      par_first_hire_date     IN   date,
      par_adj_service_date    IN   date,
      par_seniority_date      IN   date,
      par_first_work_date     IN   date,
      par_last_work_date      IN   date,
      par_pidm                IN   number,
      msg                     OUT  varchar2,
      msg_type                OUT  varchar2,
      edit_num             IN OUT  number)
IS
--
-- FILE NAME..: nopterm.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_PEBEMPL_TERM_DATE
-- PRODUCT....: POSNCTL
-- USAGE......: Validate the Termination Date.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates the Termination Date entered for the employee.
--
-- DESCRIPTION END
--
  var varchar2(1);
  end_edit  number(2) := 99;
--
  CURSOR C1 IS
  SELECT 'X'
  FROM   nbrbjob, nbrjobs
  WHERE  nbrbjob_pidm = par_pidm
  AND  nbrjobs_pidm = par_pidm
  AND  nbrbjob_posn = nbrjobs_posn
  AND  nbrbjob_suff = nbrjobs_suff
  AND  nbrjobs_status = 'T'
  AND  nbrjobs_effective_date = nbrbjob_end_date
  AND  nbrjobs_pers_chg_date > par_term_date;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
 IF edit_num = 1
 THEN
     edit_num := edit_num + 1;
     IF par_term_date < par_current_hire_date
     THEN
         msg := G$_NLS.Get('NOPTERM-0000', 'SQL','*ERROR* Termination Date has to be >= Current Hire Service date.') ;
         msg_type := 'E';
         RETURN;
     END IF;
 END IF;
 IF edit_num = 2
 THEN
      edit_num := edit_num + 1;
      IF par_term_date < par_first_hire_date
      THEN
         msg := G$_NLS.Get('NOPTERM-0001', 'SQL','*ERROR* Termination Date has to be >= Original Hire Service date.') ;
         msg_type := 'E';
         RETURN;
      END IF;
 END IF;
 IF edit_num = 3
 THEN
      edit_num := edit_num + 1;
     IF par_term_date < par_adj_service_date
     THEN
         msg := G$_NLS.Get('NOPTERM-0002', 'SQL','*ERROR* Termination Date has to be >= Adjusted Service date.') ;
         msg_type := 'E';
         RETURN;
     END IF;
 END IF;
 IF edit_num = 4
 THEN
      edit_num := edit_num + 1;
      IF par_term_date < par_seniority_date
      THEN
         msg := G$_NLS.Get('NOPTERM-0003', 'SQL','*ERROR* Termination Date has to be >= Seniority Service date.') ;
         msg_type := 'E';
         RETURN;
      END IF;
 END IF;
 IF edit_num = 5
 THEN
      edit_num := edit_num + 1;
      IF par_term_date < par_first_work_date
      THEN
         msg := G$_NLS.Get('NOPTERM-0004', 'SQL','*ERROR* Termination Date has to be >= First Work Day Service date.') ;
         msg_type := 'E';
         RETURN;
      END IF;
 END IF;
 IF edit_num = 6
 THEN
      edit_num := edit_num + 1;
       IF par_term_date < par_last_work_date
       THEN
         msg := G$_NLS.Get('NOPTERM-0005', 'SQL','*ERROR* Termination Date has to be >= Last Work Day Service date.') ;
         msg_type := 'E';
         RETURN;
       END IF;
 END IF;
 IF edit_num = 7
 THEN
      edit_num := edit_num + 1;
      OPEN c1;
      FETCH c1 INTO var;
      IF c1%FOUND
      THEN
          msg := G$_NLS.Get('NOPTERM-0006', 'SQL','*ERROR* Termination Date has to be >= Jobs End date.') ;
          msg_type := 'E';
          CLOSE c1;
          RETURN;
      END IF;
      CLOSE c1;
 END IF;
 IF edit_num = 8 THEN
    edit_num := end_edit;
    IF(par_term_date IS NOT NULL and par_loa_end_date IS NOT NULL) AND
       (par_term_date < par_loa_end_date) THEN
       msg :=  G$_NLS.Get('NOPTERM-0007', 'SQL','*ERROR* Termination Date cannot be less than Leave of Absence End Date.')
              ;
       msg_type := 'E';
       RETURN;
    END IF;
 END IF;
END ;
/


DROP PUBLIC SYNONYM P_EDIT_PEBEMPL_TERM_DATE;

CREATE PUBLIC SYNONYM P_EDIT_PEBEMPL_TERM_DATE FOR BANINST1.P_EDIT_PEBEMPL_TERM_DATE;


GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TERM_DATE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TERM_DATE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TERM_DATE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TERM_DATE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TERM_DATE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TERM_DATE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TERM_DATE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TERM_DATE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TERM_DATE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TERM_DATE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TERM_DATE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TERM_DATE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TERM_DATE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TERM_DATE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TERM_DATE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TERM_DATE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TERM_DATE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PEBEMPL_TREA_CODE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_pebempl_trea_code
     (par_trea_code    IN  varchar2,
      par_lrea_code    IN  varchar2,
      par_loa_beg_date IN  date,
      par_loa_end_date IN  date,
      par_pidm         IN  number,
      par_desc     IN OUT  varchar2,
      exe_source       IN  varchar2,
      par_trans_no     IN  number,
      msg             OUT  varchar2,
      msg_type        OUT  varchar2,
      edit_num     IN OUT  number)
AS
--
-- FILE NAME..: noptrea.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_PEBEMPL_TREA_CODE
-- PRODUCT....: POSNCTL
-- USAGE......: Validate the termination reason code .
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates the employee termination reason code based
-- on active jobs and leave of absence dates.
--
-- DESCRIPTION END
--
  end_edit      number(2)  := 99;
  var_dummy     varchar2(1) := NULL;
  var_posn      varchar2(6) := NULL;
  var_suff      varchar2(2) := NULL;
  var_string    varchar2(50) := null;
  ptrtrea_rec   nokplib.ptrtreac%ROWTYPE;
--
     CURSOR check_paf_term
     IS
     SELECT 'X'
     FROM nortran
     WHERE nortran_transaction_no = par_trans_no
       AND nortran_aufd_code = 'NBRJOBS_STATUS'
       AND nortran_value = 'T'
       AND nortran_posn = var_posn
       AND nortran_suff = var_suff;
--
     CURSOR check_job_ended
     IS
           SELECT nbrbjob_posn, nbrbjob_suff
             FROM nbrbjob
            WHERE nbrbjob_pidm = par_pidm
              AND nbrbjob_end_date IS NULL;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
IF edit_num = 1 THEN
   edit_num := edit_num + 1;
   IF par_trea_code IS NOT NULL THEN
    OPEN check_job_ended;
    LOOP
       FETCH check_job_ended INTO var_posn, var_suff;
       EXIT WHEN check_job_ended%NOTFOUND;
       OPEN check_paf_term;
       FETCH check_paf_term INTO var_dummy;
       IF check_paf_term%NOTFOUND THEN
          msg :=  G$_NLS.Get('NOPTREA-0001', 'SQL','*ERROR* Cannot be terminated. All jobs have to be ended.') ;
          msg_type := 'E';
          CLOSE check_job_ended;
          CLOSE check_paf_term;
          RETURN;
       END IF;
    CLOSE check_paf_term;
    END LOOP;
    CLOSE check_job_ended;
   END IF;
END IF;
--
IF edit_num = 2 THEN
   edit_num := edit_num + 1;
   IF (par_lrea_code IS NOT NULL AND
       par_loa_beg_date IS NOT NULL AND
       par_loa_end_date IS NULL) THEN
       msg :=  G$_NLS.Get('NOPTREA-0002', 'SQL','*ERROR* Leave of Absence End Date must be entered for this employee.')
              ;
       msg_type := 'E';
       RETURN;
   END IF;
END IF;
IF edit_num = 3
THEN
    edit_num := end_edit;
    IF par_trea_code IS NOT NULL THEN
    OPEN nokplib.ptrtreac(par_trea_code);
    FETCH nokplib.ptrtreac INTO ptrtrea_rec;
    IF nokplib.ptrtreac%NOTFOUND
    THEN
        par_desc := NULL;
        IF exe_source <> 'MASS'
        THEN
            var_string :=  G$_NLS.Get('NOPTREA-0004', 'SQL','Press LIST for valid codes.') ;
        END IF;
            msg :=  G$_NLS.Get('NOPTREA-0005', 'SQL',
	'*ERROR* Invalid Termination Reason Code. %01%'
	, var_string);
            msg_type := 'E';
    ELSE
       par_desc := ptrtrea_rec.ptrtrea_desc;
    END IF;
    CLOSE nokplib.ptrtreac;
    END IF;
END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_PEBEMPL_TREA_CODE;

CREATE PUBLIC SYNONYM P_EDIT_PEBEMPL_TREA_CODE FOR BANINST1.P_EDIT_PEBEMPL_TREA_CODE;


GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TREA_CODE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TREA_CODE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TREA_CODE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TREA_CODE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TREA_CODE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TREA_CODE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TREA_CODE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TREA_CODE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TREA_CODE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TREA_CODE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TREA_CODE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TREA_CODE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TREA_CODE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TREA_CODE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TREA_CODE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TREA_CODE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_TREA_CODE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PEBEMPL_WKPR_CODE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_pebempl_wkpr_code
     (par_wkpr_code  IN  varchar2,
      par_desc   IN OUT  varchar2,
      exe_source     IN  varchar2,
      msg           OUT  varchar2,
      msg_type      OUT  varchar2)
 IS
--
-- FILE NAME..: nopwper.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_PEBEMPL_WKPR_CODE
-- PRODUCT....: POSNCTL
-- USAGE......: Validates Work Period Code.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates the Work Period Code entered.
--
-- DESCRIPTION END
--
--
      var_string   varchar2(48)  := null;
      ptrwkpr_rec  nokplib.ptrwkprc%ROWTYPE;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_wkpr_code IS NOT NULL THEN
      OPEN nokplib.ptrwkprc(par_wkpr_code) ;
      FETCH nokplib.ptrwkprc INTO ptrwkpr_rec;
      IF nokplib.ptrwkprc%NOTFOUND
      THEN
          par_desc := NULL;
           IF exe_source <> 'MASS'
           THEN
               var_string :=  G$_NLS.Get('NOPWPER-0001', 'SQL','Press LIST for valid codes.') ;
           END IF;
           msg :=  G$_NLS.Get('NOPWPER-0002', 'SQL',
	'*ERROR* Invalid Work Period Code. %01%'
	, var_string);
           msg_type := 'E';
      ELSE
         par_desc := ptrwkpr_rec.ptrwkpr_desc;
      END IF;
      CLOSE nokplib.ptrwkprc;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_PEBEMPL_WKPR_CODE;

CREATE PUBLIC SYNONYM P_EDIT_PEBEMPL_WKPR_CODE FOR BANINST1.P_EDIT_PEBEMPL_WKPR_CODE;


GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_WKPR_CODE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_WKPR_CODE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_WKPR_CODE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_WKPR_CODE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_WKPR_CODE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_WKPR_CODE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_WKPR_CODE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_WKPR_CODE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_WKPR_CODE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_WKPR_CODE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_WKPR_CODE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_WKPR_CODE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_WKPR_CODE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_WKPR_CODE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_WKPR_CODE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_WKPR_CODE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PEBEMPL_WKPR_CODE TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PLBD_EXISTS;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_plbd_exists
     (par_posn            IN    nbrbjob.nbrbjob_posn%TYPE,
      par_cur_fisc        IN    nbbfisc.nbbfisc_code%TYPE,
      msg                 OUT   noreaer.noreaer_error_msg%TYPE,
      msg_type            OUT   noreaer.noreaer_msg_type%TYPE)
IS
--
-- FILE NAME..: nopplbd.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_PLBD_EXISTS
-- PRODUCT....: POSNCTL
-- USAGE......: Validate position labor distribution record.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates the existence of a position labor distribution
-- record for a particular position within a fiscal year.
--
-- DESCRIPTION END
--
--
CURSOR PTI_CURSOR IS
   SELECT 'X'
   FROM   NBRPLBD
   WHERE  NBRPLBD_POSN = par_posn
     AND  NBRPLBD_FISC_CODE = par_cur_fisc;
--
   var_dummy      VARCHAR2(1) := NULL;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   OPEN PTI_CURSOR ;
   FETCH PTI_CURSOR INTO var_dummy;
   IF PTI_CURSOR%NOTFOUND THEN
      msg :=  G$_NLS.Get('NOPPLBD-0000', 'SQL','*ERROR* Position Labor Distribution not found for position and fiscal year.')
             ;
      msg_type := 'E';
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_PLBD_EXISTS;

CREATE PUBLIC SYNONYM P_EDIT_PLBD_EXISTS FOR BANINST1.P_EDIT_PLBD_EXISTS;


GRANT EXECUTE ON BANINST1.P_EDIT_PLBD_EXISTS TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PLBD_EXISTS TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PLBD_EXISTS TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PLBD_EXISTS TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PLBD_EXISTS TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PLBD_EXISTS TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PLBD_EXISTS TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PLBD_EXISTS TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PLBD_EXISTS TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PLBD_EXISTS TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PLBD_EXISTS TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PLBD_EXISTS TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PLBD_EXISTS TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PLBD_EXISTS TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PLBD_EXISTS TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PLBD_EXISTS TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PLBD_EXISTS TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_POSN_PCLS;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_posn_pcls
      (par_posn_pcls IN  ntrpcls.ntrpcls_code%TYPE,
       par_pcls_eskl OUT ntrpcls.ntrpcls_eskl_code%type,
       msg           OUT noreaer.noreaer_msg_type%TYPE,
       msg_type      OUT noreaer.noreaer_error_msg%TYPE)
AS
--
-- FILE NAME..: noppcls.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_POSN_PCLS
-- PRODUCT....: POSNCTL
-- USAGE......: Validate position class.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates position class against NTRPCLS.
--
-- DESCRIPTION END
--
  CURSOR c1 IS
         SELECT SUBSTR(NTRPCLS_ESKL_CODE, 1, 1)
           FROM NTRPCLS
          WHERE NTRPCLS_CODE = par_posn_pcls;
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   OPEN c1;
   FETCH c1 INTO par_pcls_eskl;
   IF c1%NOTFOUND
   THEN
       par_pcls_eskl := NULL;
       msg :=  G$_NLS.Get('NOPPCLS-0000', 'SQL','*ERROR* Position Class not found on NTRPCLS.') ;
       msg_type := 'E';
   END IF;
   CLOSE c1;
END;
/


DROP PUBLIC SYNONYM P_EDIT_POSN_PCLS;

CREATE PUBLIC SYNONYM P_EDIT_POSN_PCLS FOR BANINST1.P_EDIT_POSN_PCLS;


GRANT EXECUTE ON BANINST1.P_EDIT_POSN_PCLS TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_PCLS TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_PCLS TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_PCLS TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_PCLS TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_PCLS TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_PCLS TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_PCLS TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_PCLS TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_PCLS TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_PCLS TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_PCLS TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_PCLS TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_PCLS TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_PCLS TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_PCLS TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_PCLS TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_POSN_STATUS_FOR_JOB;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_posn_status_for_job
     (par_posn_status    IN   nbrjobs.nbrjobs_status%TYPE,
      msg                OUT  VARCHAR2,
      msg_type           OUT  VARCHAR2)
IS
--
-- FILE NAME..: nopesta.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_POSN_STATUS_FOR_JOB
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edit on position status.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure checks if position is active when updating/creating a job.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF NVL(par_posn_status,'*') <> 'A' THEN
      msg :=   G$_NLS.Get('NOPESTA-0000', 'SQL','*ERROR* Position Status not active; Assignment change or insertion not allowed.')
              ;
      msg_type := 'E';
      RETURN;
   END IF;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_POSN_STATUS_FOR_JOB;

CREATE PUBLIC SYNONYM P_EDIT_POSN_STATUS_FOR_JOB FOR BANINST1.P_EDIT_POSN_STATUS_FOR_JOB;


GRANT EXECUTE ON BANINST1.P_EDIT_POSN_STATUS_FOR_JOB TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_STATUS_FOR_JOB TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_STATUS_FOR_JOB TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_STATUS_FOR_JOB TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_STATUS_FOR_JOB TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_STATUS_FOR_JOB TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_STATUS_FOR_JOB TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_STATUS_FOR_JOB TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_STATUS_FOR_JOB TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_STATUS_FOR_JOB TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_STATUS_FOR_JOB TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_STATUS_FOR_JOB TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_STATUS_FOR_JOB TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_STATUS_FOR_JOB TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_STATUS_FOR_JOB TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_STATUS_FOR_JOB TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_POSN_STATUS_FOR_JOB TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_PRIMARY_EXISTS;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_primary_exists
 (par_begin_date    IN      date,
  par_contract_type IN      varchar2,
  par_end_date      IN      date,
  par_pidm          IN      number,
  par_posn          IN      varchar2,
  par_suff          IN      varchar2,
  par_exe_source    IN      varchar2,
  par_effective_date IN     date,
  par_trans_no      IN      number,
  msg               OUT     varchar2,
  msg_type          OUT     varchar2,
  edit_num          IN  OUT number)
IS
--
-- FILE NAME..: noppjob.sql
-- RELEASE....: 5.0
-- OBJECT NAME: P_EDIT_PRIMARY_EXISTS
-- PRODUCT....: POSNCTL
-- USAGE......: Validate contract job type and primary job.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates contract job type and primary job
--
-- DESCRIPTION END
--
--
   end_edit NUMBER := 99;
   pti_into_temp   VARCHAR2(1);
   var_dummy   varchar2(1);
   var_posn    nbrbjob.nbrbjob_posn%TYPE;
   var_suff    nbrbjob.nbrbjob_suff%TYPE;
--
   CURSOR check_for_term
   IS
   SELECT 'X'
   FROM   nortran N
   WHERE  N.nortran_transaction_no = par_trans_no
     AND  N.nortran_posn = var_posn
     AND  N.nortran_suff = var_suff
     AND  N.nortran_aufd_code = 'NBRJOBS_STATUS'
     AND  N.nortran_value = 'T'
     AND EXISTS
         (SELECT 'X'
          FROM   nortran D
          WHERE  D.nortran_transaction_no = par_trans_no
          AND  D.nortran_posn = var_posn
          AND  D.nortran_suff = var_suff
          AND  D.nortran_aufd_code = 'NBRJOBS_EFFECTIVE_DATE'
          AND  to_date(D.nortran_value,G$_DATE.GET_NLS_DATE_FORMAT) <= par_effective_date);
--
      CURSOR check_primary
      IS
             SELECT nbrbjob_posn,
                    nbrbjob_suff
               FROM nbrbjob
              WHERE nbrbjob_pidm = par_pidm
                AND nbrbjob_contract_type = 'P'
                AND (NBRBJOB_POSN <> par_posn
                 OR (NBRBJOB_POSN = par_posn
                AND NBRBJOB_SUFF <> par_suff))
                AND (NBRBJOB_END_DATE >= par_begin_date
                 OR NBRBJOB_END_DATE IS NULL)
                AND (NBRBJOB_BEGIN_DATE <= par_end_date
                 OR par_end_date IS NULL) ;
--
      CURSOR CHECK_PRIMARY_2 IS
      SELECT 'X'
       FROM   NBRBJOB
       WHERE  NBRBJOB_PIDM = par_pidm
         AND  NBRBJOB_CONTRACT_TYPE = 'P';
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_contract_type IS NULL THEN
      msg :=  G$_NLS.Get('NOPPJOB-0001', 'SQL','*ERROR* Job Type must be entered.') ;
      msg_type := 'E';
      edit_num := end_edit;
      RETURN;
   END IF;
--
   IF edit_num = 1 THEN
      edit_num := edit_num + 1;
      IF par_contract_type = 'P' THEN
         IF par_pidm IS NOT NULL THEN
         OPEN check_primary;
         LOOP
            FETCH check_primary INTO var_posn,
                                     var_suff;
            EXIT WHEN check_primary%NOTFOUND;
            IF check_primary%FOUND THEN
               IF par_exe_source IN ('PAF','MASS') THEN
                  OPEN check_for_term;
                  FETCH check_for_term INTO var_dummy;
                  IF check_for_term%NOTFOUND THEN
                     msg :=  G$_NLS.Get('NOPPJOB-0004', 'SQL','*ERROR* This employee already has a primary job.') ;
                     msg_type := 'E';
                     CLOSE check_primary;
                     CLOSE check_for_term;
                     RETURN;
                  END IF;
               ELSE
                  msg :=  G$_NLS.Get('NOPPJOB-0005', 'SQL','*ERROR* This employee already has a primary job.') ;
                  msg_type := 'E';
                  CLOSE check_primary;
                  RETURN;
               END IF;
            END IF;
         END LOOP;
         CLOSE check_primary;
         END IF;
      END IF;
   END IF;
--
   IF edit_num = 2 THEN
      edit_num := end_edit;
      IF par_contract_type <> 'P' THEN
         IF par_pidm IS NOT NULL THEN
            OPEN check_primary_2;
            FETCH check_primary_2 INTO pti_into_temp;
            IF check_primary_2%NOTFOUND THEN
               msg :=  G$_NLS.Get('NOPPJOB-0006', 'SQL','*ERROR* A Primary Job has not been defined for this employee.')
                              ;
               msg_type := 'E';
            END IF;
            CLOSE check_primary_2;
         END IF;
      END IF;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_PRIMARY_EXISTS;

CREATE PUBLIC SYNONYM P_EDIT_PRIMARY_EXISTS FOR BANINST1.P_EDIT_PRIMARY_EXISTS;


GRANT EXECUTE ON BANINST1.P_EDIT_PRIMARY_EXISTS TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PRIMARY_EXISTS TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PRIMARY_EXISTS TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_PRIMARY_EXISTS TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_PRIMARY_EXISTS TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PRIMARY_EXISTS TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PRIMARY_EXISTS TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PRIMARY_EXISTS TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PRIMARY_EXISTS TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_PRIMARY_EXISTS TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PRIMARY_EXISTS TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PRIMARY_EXISTS TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_PRIMARY_EXISTS TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_PRIMARY_EXISTS TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_PRIMARY_EXISTS TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_PRIMARY_EXISTS TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_PRIMARY_EXISTS TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_RANGE_SALB;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_range_salb
     (par_salb_low   IN  ntrsalb.ntrsalb_low%TYPE,
      par_salb_high  IN  ntrsalb.ntrsalb_high%TYPE,
      par_salb_ind   IN  ntrsalb.ntrsalb_ind%TYPE,
      par_ann_salary IN  nbrjobs.nbrjobs_ann_salary%TYPE,
      par_reg_rate   IN  nbrjobs.nbrjobs_reg_rate%TYPE,
      msg           OUT  noreaer.noreaer_error_msg%TYPE,
      msg_type      OUT  noreaer.noreaer_msg_type%TYPE)
IS
--
-- FILE NAME..:  nopersb.sql
-- RELEASE....:  4.1
-- OBJECT NAME:  P_EDIT_RANGE_SALB
-- PRODUCT....:  POSNCTL
-- USAGE......:  Edits rate and salary against NTRSALB table.
--
-- COPYRIGHT..:  Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- Edit - Procedure edits rate and annual salary against the NTRSALB
--        table to determine if the value is between the high and low
--        range for the table, grade and step.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_salb_ind = 'S' THEN
      IF par_ann_salary IS NOT NULL THEN
         IF par_ann_salary NOT BETWEEN par_salb_low AND par_salb_high THEN
            msg :=  G$_NLS.Get('NOPERSB-0000', 'SQL','*WARNING* Annual Salary is outside the Table/Grade range.')

                   ;
            msg_type := 'W';
         END IF;
      END IF;
   ELSIF par_salb_ind = 'H' THEN
      IF par_reg_rate IS NOT NULL THEN
         IF par_reg_rate NOT BETWEEN par_salb_low AND par_salb_high THEN
            msg :=  G$_NLS.Get('NOPERSB-0001', 'SQL','*WARNING* Rate for this job is outside the Table/Grade range.')

                   ;
            msg_type := 'W';
         END IF;
      END IF;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_RANGE_SALB;

CREATE PUBLIC SYNONYM P_EDIT_RANGE_SALB FOR BANINST1.P_EDIT_RANGE_SALB;


GRANT EXECUTE ON BANINST1.P_EDIT_RANGE_SALB TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_RANGE_SALB TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_RANGE_SALB TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_RANGE_SALB TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_RANGE_SALB TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_RANGE_SALB TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_RANGE_SALB TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_RANGE_SALB TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_RANGE_SALB TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_RANGE_SALB TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_RANGE_SALB TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_RANGE_SALB TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_RANGE_SALB TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_RANGE_SALB TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_RANGE_SALB TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_RANGE_SALB TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_RANGE_SALB TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_REQ_FIELD;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_req_field
     (par_field        IN  varchar2,
      par_value        IN  varchar2,
      msg             OUT  varchar2,
      msg_type        OUT  varchar2)
IS
--
-- FILE NAME..: nopreqf.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_REQ_FIELD
-- PRODUCT....: POSNCTL
-- USAGE......: Validate required field.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates required field is not null by passing a string
-- (field name) for par_field. If par_value is null, par_field is joined
-- with 'must be entered' and the message is returned.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_value IS NULL THEN
      msg :=  G$_NLS.Get('NOPREQF-0000', 'SQL',
	'*ERROR* %01% must be entered.'
	,  par_field );
      msg_type := 'E';
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_REQ_FIELD;

CREATE PUBLIC SYNONYM P_EDIT_REQ_FIELD FOR BANINST1.P_EDIT_REQ_FIELD;


GRANT EXECUTE ON BANINST1.P_EDIT_REQ_FIELD TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_REQ_FIELD TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_REQ_FIELD TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_REQ_FIELD TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_REQ_FIELD TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_REQ_FIELD TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_REQ_FIELD TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_REQ_FIELD TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_REQ_FIELD TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_REQ_FIELD TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_REQ_FIELD TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_REQ_FIELD TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_REQ_FIELD TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_REQ_FIELD TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_REQ_FIELD TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_REQ_FIELD TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_REQ_FIELD TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_SALARY_ENC;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_salary_enc
       (par_pidm               IN  number,
        par_posn               IN  varchar2,
        par_suff               IN  varchar2,
        par_fisc_begin         IN  date,
        par_fisc_end           IN  date,
        par_enc_method         IN  varchar2,
        par_salary_enc         IN  number,
        par_total_encum_hrs    IN  number,
        par_total_contract_hrs IN  number,
        par_effective_date     IN  date,
        par_jobs_enc_hrs       IN  number,
        msg                   OUT  varchar2,
        msg_type              OUT  varchar2,
        edit_num           IN OUT  number)
IS
--
-- FILE NAME..: nopwsee.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_SALARY_ENC
-- PRODUCT....: POSNCTL
-- USAGE......: Perform edits on null salary encumbrance value and hours.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure displays warning message that a null salary encumbrance
-- value has been set to zero for the value and hours input methods. Also,
-- it validates encumbrance hours and total contract hours.
--
-- DESCRIPTION END
--
  CURSOR ADD_HOURS IS
  SELECT NVL(SUM(NVL(NBRJOBS_ENCUMBRANCE_HRS,0)),0)
  FROM NBRJOBS
  WHERE NBRJOBS_PIDM = par_pidm
  AND NBRJOBS_POSN = par_posn
  AND NBRJOBS_SUFF = par_suff
  AND NBRJOBS_EFFECTIVE_DATE
    BETWEEN par_fisc_begin
    AND par_fisc_end;
--
  TOTAL_HOURS NUMBER := NULL;
  end_edit NUMBER := 99;
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF edit_num = 1 THEN
      edit_num := edit_num + 1;
      IF par_salary_enc IS NULL THEN
         IF par_enc_method = 'V' THEN
            msg :=  G$_NLS.Get('NOPWSEE-0000', 'SQL','*WARNING* Encumbrance has been set to 0, because method is Value Input.')
                   ;
            msg_type := 'W';
            RETURN;
         ELSIF par_enc_method = 'H' THEN
            msg :=  G$_NLS.Get('NOPWSEE-0001', 'SQL','*WARNING* Encumbrance has been set to 0, because method is Hours Input.')
                   ;
            msg_type := 'W';
            RETURN;
         END IF;
      END IF;
   END IF;
--
   IF edit_num = 2 THEN
      edit_num := edit_num + 1;
      IF par_total_encum_hrs IS NOT NULL OR
         (par_enc_method = 'H' and par_effective_date BETWEEN
         par_fisc_begin and par_fisc_end) THEN
         OPEN ADD_HOURS;
         FETCH ADD_HOURS INTO TOTAL_HOURS;
         IF add_hours%NOTFOUND THEN
            total_hours := 0;
         END IF;
         IF TOTAL_HOURS <> NVL(par_total_encum_hrs,0) THEN
            msg :=  G$_NLS.Get('NOPWSEE-0002', 'SQL',
	'*WARNING* Total Enc Hrs do not equal sum of Enc Hrs (%01%) in fiscal year.'

	,  to_char(total_hours) );
            msg_type := 'W';
            CLOSE ADD_HOURS;
            RETURN;
         END IF;
         CLOSE ADD_HOURS;
      END IF;
   END IF;
--
   IF edit_num = 3 THEN
      edit_num := end_edit;
      IF par_total_encum_hrs IS NOT NULL OR
         (par_enc_method = 'H' and par_effective_date BETWEEN
         par_fisc_begin and par_fisc_end) THEN
         IF NVL(par_total_encum_hrs,0) > NVL(par_total_contract_hrs,0) THEN
            msg :=  G$_NLS.Get('NOPWSEE-0003', 'SQL','*ERROR* Total Contract Hrs must not be less than the total Encumbrance Hrs.')
                   ;
            msg_type := 'E';
            RETURN;
        END IF;
      END IF;
   END IF;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_SALARY_ENC;

CREATE PUBLIC SYNONYM P_EDIT_SALARY_ENC FOR BANINST1.P_EDIT_SALARY_ENC;


GRANT EXECUTE ON BANINST1.P_EDIT_SALARY_ENC TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_SALARY_ENC TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_SALARY_ENC TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_SALARY_ENC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_SALARY_ENC TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_SALARY_ENC TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_SALARY_ENC TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_SALARY_ENC TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_SALARY_ENC TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_SALARY_ENC TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_SALARY_ENC TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_SALARY_ENC TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_SALARY_ENC TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_SALARY_ENC TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_SALARY_ENC TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_SALARY_ENC TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_SALARY_ENC TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_STEP_INCR_MONTH_DAY;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_step_incr_month_day
     (par_step_incr_mon  IN   nbrbjob.nbrbjob_step_incr_mon%TYPE,
      par_step_incr_day  IN   nbrbjob.nbrbjob_step_incr_day%TYPE,
      msg                OUT  VARCHAR2,
      msg_type           OUT  VARCHAR2)
IS
--
-- FILE NAME..: nopsmsd.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_STEP_INCR_MONTH_DAY
-- PRODUCT....: POSNCTL
-- USAGE......: Check existence of step increase month and step increase day.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure checks existence of both step increase month and
-- step increase day when either is entered.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF par_step_incr_mon IS NULL THEN
      IF par_step_incr_day IS NOT NULL THEN
         msg :=  G$_NLS.Get('NOPSMSD-0000', 'SQL','*ERROR* Step Increase Month and Day must both be valued or both be blank.')
                 ;
         msg_type := 'E';
         RETURN;
      END IF ;
   ELSE
      IF par_step_incr_day IS NULL THEN
         msg :=  G$_NLS.Get('NOPSMSD-0001', 'SQL','*ERROR* Step Increase Month and Day must both be valued or both be blank.')
                 ;
         msg_type := 'E';
         RETURN;
      END IF ;
   END IF ;
--
END;
/


DROP PUBLIC SYNONYM P_EDIT_STEP_INCR_MONTH_DAY;

CREATE PUBLIC SYNONYM P_EDIT_STEP_INCR_MONTH_DAY FOR BANINST1.P_EDIT_STEP_INCR_MONTH_DAY;


GRANT EXECUTE ON BANINST1.P_EDIT_STEP_INCR_MONTH_DAY TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_STEP_INCR_MONTH_DAY TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_STEP_INCR_MONTH_DAY TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_STEP_INCR_MONTH_DAY TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_STEP_INCR_MONTH_DAY TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_STEP_INCR_MONTH_DAY TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_STEP_INCR_MONTH_DAY TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_STEP_INCR_MONTH_DAY TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_STEP_INCR_MONTH_DAY TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_STEP_INCR_MONTH_DAY TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_STEP_INCR_MONTH_DAY TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_STEP_INCR_MONTH_DAY TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_STEP_INCR_MONTH_DAY TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_STEP_INCR_MONTH_DAY TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_STEP_INCR_MONTH_DAY TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_STEP_INCR_MONTH_DAY TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_STEP_INCR_MONTH_DAY TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_TERM_INFO;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_term_info
     (par_pebempl_trea_code     IN varchar2,
      par_pebempl_term_date     IN date,
      par_pebempl_empl_status   IN varchar2,
      msg                      OUT varchar2,
      msg_type                 OUT varchar2)
IS
--
-- FILE NAME..: noptinc.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_TERM_INFO
-- PRODUCT....: POSNCTL
-- USAGE......: Ensure that termination information for PEBEMPL is complete.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure ensures that termination information for PEBEMPL is complete.
-- Both the term reason code and date must be entered if either is present.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
      IF par_pebempl_empl_status = 'T' THEN
         IF par_pebempl_term_date IS NULL THEN
            msg :=  G$_NLS.Get('NOPTINC-0000', 'SQL','*ERROR* Termination Date must be entered when employee status is (Terminated).')
                   ;
            msg_type := 'E';
            RETURN;
         END IF;
       END IF;
--
       IF (par_pebempl_trea_code IS NOT NULL AND par_pebempl_term_date IS NULL)
           OR (par_pebempl_term_date IS NOT NULL AND par_pebempl_trea_code IS NULL) THEN
           msg :=  G$_NLS.Get('NOPTINC-0001', 'SQL','*ERROR* Termination Reason and Date must both be entered.') ;
           msg_type := 'E';
           RETURN;
       END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_TERM_INFO;

CREATE PUBLIC SYNONYM P_EDIT_TERM_INFO FOR BANINST1.P_EDIT_TERM_INFO;


GRANT EXECUTE ON BANINST1.P_EDIT_TERM_INFO TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_TERM_INFO TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_TERM_INFO TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_TERM_INFO TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_TERM_INFO TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_TERM_INFO TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_TERM_INFO TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_TERM_INFO TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_TERM_INFO TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_TERM_INFO TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_TERM_INFO TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_TERM_INFO TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_TERM_INFO TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_TERM_INFO TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_TERM_INFO TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_TERM_INFO TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_TERM_INFO TO WTAILOR;
DROP PROCEDURE BANINST1.P_EDIT_WORK_PERIOD_CODE;

CREATE OR REPLACE PROCEDURE BANINST1.p_edit_work_period_code
     (par_pebempl_flsa_ind     IN   varchar2,
      par_pebempl_wkpr_code    IN   varchar2,
      msg                     OUT   varchar2,
      msg_type                OUT   varchar2)
IS
--
-- FILE NAME..: nopwkpr.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_EDIT_WORK_PERIOD_CODE
-- PRODUCT....: POSNCTL
-- USAGE......: Validate work period code when FLSA indicator exists.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure validates work period code when FLSA indicator exists.
--
-- DESCRIPTION END
--
BEGIN
   msg := NULL;
   msg_type := NULL;
--
   IF (par_pebempl_flsa_ind IS NOT NULL AND par_pebempl_flsa_ind <> 'N') THEN
      IF par_pebempl_wkpr_code IS NULL THEN
         msg :=  G$_NLS.Get('NOPWKPR-0000', 'SQL','*ERROR* Must fill in Work Period Code when FLSA Ind = (A)ccrual, (C)ash.')
            ;
         msg_type := 'E';
      END IF;
   END IF;
END;
/


DROP PUBLIC SYNONYM P_EDIT_WORK_PERIOD_CODE;

CREATE PUBLIC SYNONYM P_EDIT_WORK_PERIOD_CODE FOR BANINST1.P_EDIT_WORK_PERIOD_CODE;


GRANT EXECUTE ON BANINST1.P_EDIT_WORK_PERIOD_CODE TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_WORK_PERIOD_CODE TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_WORK_PERIOD_CODE TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_EDIT_WORK_PERIOD_CODE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_EDIT_WORK_PERIOD_CODE TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_WORK_PERIOD_CODE TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_WORK_PERIOD_CODE TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_WORK_PERIOD_CODE TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_WORK_PERIOD_CODE TO GENERAL;

GRANT EXECUTE ON BANINST1.P_EDIT_WORK_PERIOD_CODE TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_WORK_PERIOD_CODE TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_WORK_PERIOD_CODE TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_EDIT_WORK_PERIOD_CODE TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_EDIT_WORK_PERIOD_CODE TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_EDIT_WORK_PERIOD_CODE TO SATURN;

GRANT EXECUTE ON BANINST1.P_EDIT_WORK_PERIOD_CODE TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_EDIT_WORK_PERIOD_CODE TO WTAILOR;
DROP PROCEDURE BANINST1.P_FAPFTYP;

CREATE OR REPLACE PROCEDURE BANINST1.p_fapftyp
                          (COAS_CODE IN FTVFTYP.FTVFTYP_COAS_CODE%TYPE,
                           FUNDTYPE_CODE IN FTVFTYP.FTVFTYP_FTYP_CODE%TYPE,
                           EFF_DATE IN VARCHAR2,
--
-- FILE NAME..: fapftyp.sql
-- RELEASE....: 4.2
-- OBJECT NAME: P_FAPFTYP
-- PRODUCT....: FINANCE
-- USAGE......: Returns Override Indicator for COA and Fund Type code
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
--  SUMMARY: Looks up the Override Indicator for a given COA code and Fund
--          Type code from the FTVFTYP table, with respect to an effective
--          date
--
--  RETURNS: Override Indicator (VARCHAR2(1)) if found
--          '', if not
--          Value returned in OVERRIDE_IND parameter
--
--  PARAMETERS: COAS_CODE - Chart of Accounts code
--             FUNDTYPE_CODE - Fund Type code
--             EFF_DATE - Effective Date (format YYYYMMDDHH24MISS)
--             OVERRIDE_IND - Return value of procedure
--
--
--
-- DESCRIPTION END
--
                           OVERRIDE_IND OUT FTVFTYP.FTVFTYP_DEF_OVERRIDE_IND%TYPE) IS
                  CURSOR PTI_CURSOR IS
                    SELECT FTVFTYP_DEF_OVERRIDE_IND
                    FROM FTVFTYP
                    WHERE FTVFTYP_COAS_CODE = COAS_CODE
                    AND FTVFTYP_FTYP_CODE = FUNDTYPE_CODE
                    AND FTVFTYP_EFF_DATE <= TO_DATE(EFF_DATE,'YYYYMMDDHH24MISS')
                    AND FTVFTYP_NCHG_DATE > TO_DATE(EFF_DATE,'YYYYMMDDHH24MISS')
                    AND (FTVFTYP_TERM_DATE > TO_DATE(EFF_DATE,'YYYYMMDDHH24MISS')
                    OR FTVFTYP_TERM_DATE IS NULL);
                 BEGIN

                   OPEN PTI_CURSOR;
                   FETCH PTI_CURSOR INTO OVERRIDE_IND;

                 END p_fapftyp;
/


DROP PUBLIC SYNONYM P_FAPFTYP;

CREATE PUBLIC SYNONYM P_FAPFTYP FOR BANINST1.P_FAPFTYP;


GRANT EXECUTE ON BANINST1.P_FAPFTYP TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_FAPFTYP TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_FAPFTYP TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_FAPFTYP TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_FAPFTYP TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_FAPFTYP TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_FAPFTYP TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_FAPFTYP TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_FAPFTYP TO GENERAL;

GRANT EXECUTE ON BANINST1.P_FAPFTYP TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_FAPFTYP TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_FAPFTYP TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_FAPFTYP TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_FAPFTYP TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_FAPFTYP TO SATURN;

GRANT EXECUTE ON BANINST1.P_FAPFTYP TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_FAPFTYP TO WTAILOR;
DROP PROCEDURE BANINST1.P_GETCATALOGITEMS;

CREATE OR REPLACE PROCEDURE BANINST1.P_GetCatalogItems
     (parm_subj_code       in varchar2,
      parm_crse_numb       in varchar2,
      parm_eff_term        in varchar2,
      error_ind            in out varchar2,
      course_coll_code     out varchar2,
      course_divs_code     out varchar2,
      course_dept_code     out varchar2,
      course_subj_code     out varchar2)
is
    cursor ScbcrseC is
      select *
      from scbcrse x
      where scbcrse_subj_code  = parm_subj_code
      and scbcrse_crse_numb = parm_crse_numb
      and scbcrse_eff_term =
           (select max(scbcrse_eff_term)
            from scbcrse
            where scbcrse_subj_code = x.scbcrse_subj_code
            and scbcrse_crse_numb = x.scbcrse_crse_numb
            and scbcrse_eff_term <= parm_eff_term);
    scbcrse_rec    ScbcrseC%rowtype;
begin
    error_ind := 'N';
    open ScbcrseC;
    fetch ScbcrseC into scbcrse_rec;
    if ScbcrseC%notfound then
       error_ind := 'Y';
    else
        course_coll_code := scbcrse_rec.scbcrse_coll_code;
        course_divs_code := scbcrse_rec.scbcrse_divs_code;
        course_dept_code := scbcrse_rec.scbcrse_dept_code;
        course_subj_code := scbcrse_rec.scbcrse_subj_code;
    end if;
    close ScbcrseC;
end P_GetCatalogItems;
/


DROP PUBLIC SYNONYM P_GETCATALOGITEMS;

CREATE PUBLIC SYNONYM P_GETCATALOGITEMS FOR BANINST1.P_GETCATALOGITEMS;


GRANT EXECUTE ON BANINST1.P_GETCATALOGITEMS TO PUBLIC;
DROP PROCEDURE BANINST1.P_GETEMAILADDRESS;

CREATE OR REPLACE PROCEDURE BANINST1.p_getemailaddress
--
-- FILE NAME..: gopgeml.sql
-- RELEASE....: 4.2
-- OBJECT NAME:  P_GETEMAILADDRESS
-- PRODUCT....: GENERAL
-- USAGE......: One line description of this object. Max line length 80 bytes.
-- COPYRIGHT..: Copyright (C) SCT Corporation 1999. All rights reserved.
--
-- DESCRIPTION:
--
-- INPUT - Pass in a pidm. Pass in the internal group code, and internal code
-- used to identify the gtvsdax
-- record that defines the campus pipeline email address type. Pass in an
-- optional flag that tells the
-- process to strip off the domain, or not.
-- PROCESS - Get the gtvsdax record that defines the campus pipeline email
-- address type. Get the email
-- address for the pidm based on the above address type. Strip off the domain
-- if requested.
-- OUTPUT - Pass back the email address.
--
-- DESCRIPTION END
--
 (
   pidm_in IN goremal.goremal_pidm%TYPE,
   internal_code_group_in IN gtvsdax.gtvsdax_internal_code_group%TYPE,
   internal_code_in IN gtvsdax.gtvsdax_internal_code%TYPE,
   email_address_out OUT goremal.goremal_email_address%TYPE,
   include_domain_in IN VARCHAR2 DEFAULT 'N'
   )
AS
   gtvsdax_emal_code             gtvsdax.gtvsdax_external_code%TYPE;
   goremal_rec                   goremal%ROWTYPE;

   --
   -- Cursor that gets the campus pipline address type
   -- defined in gtvsdax.
   -- ==================================================
   CURSOR get_gtvsdax_email (
      internal_code_group_in IN gtvsdax.gtvsdax_internal_code_group%TYPE,
      internal_code_in IN gtvsdax.gtvsdax_internal_code%TYPE
      )
   IS
      SELECT gtvsdax_external_code
        FROM gtvsdax
       WHERE gtvsdax_internal_code_group = internal_code_group_in
         AND gtvsdax_internal_code = internal_code_in;

   --
   -- Cursor that gets the email address for a given pidm
   -- and address type.
   -- ==================================================
   CURSOR goremalc (
      pidm_in IN goremal.goremal_pidm%TYPE,
      emal_code_in IN goremal.goremal_emal_code%TYPE
      )
   IS
      SELECT *
        FROM goremal
       WHERE goremal_pidm = pidm_in
         AND goremal_emal_code = emal_code_in
         AND goremal_status_ind = 'A';
   user_length                   NUMBER(2);
   email                         VARCHAR2(90);

BEGIN
   --
   -- Get the campus pipeline address type defined in gtvsdax.
   -- ==================================================
   OPEN get_gtvsdax_email (internal_code_group_in, internal_code_in);
   FETCH get_gtvsdax_email INTO gtvsdax_emal_code;
   CLOSE get_gtvsdax_email;

   --
   -- Get the campus pipeline email address.
   -- ==================================================
   OPEN goremalc (pidm_in, gtvsdax_emal_code);
   FETCH goremalc INTO goremal_rec;
   CLOSE goremalc;

   --
   -- Strip off domain if requested.
   -- ==================================================
   IF include_domain_in = 'Y'
   THEN
      email_address_out := goremal_rec.goremal_email_address;
   ELSE
      email := goremal_rec.goremal_email_address;
      user_length := INSTR (email, '@', 1);
      IF user_length = 0
      THEN
         email_address_out := email;
      ELSE
         email_address_out := SUBSTR (email, 1, user_length - 1);
      END IF;
   END IF;

END p_getemailaddress;
/


DROP PUBLIC SYNONYM P_GETEMAILADDRESS;

CREATE PUBLIC SYNONYM P_GETEMAILADDRESS FOR BANINST1.P_GETEMAILADDRESS;


GRANT EXECUTE ON BANINST1.P_GETEMAILADDRESS TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_GETEMAILADDRESS TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_GETEMAILADDRESS TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_GETEMAILADDRESS TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_GETEMAILADDRESS TO GENERAL;

GRANT EXECUTE ON BANINST1.P_GETEMAILADDRESS TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_GETEMAILADDRESS TO PUBLIC;

GRANT EXECUTE ON BANINST1.P_GETEMAILADDRESS TO SATURN;

GRANT EXECUTE ON BANINST1.P_GETEMAILADDRESS TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_GETEMAILADDRESS TO WTAILOR;
DROP PROCEDURE BANINST1.P_GET_SALARY_FOR_STEP;

CREATE OR REPLACE PROCEDURE BANINST1.p_get_salary_for_step
     (par_sal_table    IN      nbrjobs.nbrjobs_sal_table%TYPE,
      par_sal_grade    IN      nbrjobs.nbrjobs_sal_grade%TYPE,
      par_sal_step     IN      nbrjobs.nbrjobs_sal_step%TYPE,
      par_sgrp         IN      nbrjobs.nbrjobs_sgrp_code%TYPE,
      par_appt_pct     IN      nbrjobs.nbrjobs_appt_pct%TYPE,
      par_sala_amount  OUT     ntrsala.ntrsala_amount%TYPE,
      msg              OUT     noreaer.noreaer_error_msg%TYPE ,
      msg_type         OUT     noreaer.noreaer_msg_type%TYPE)
IS
--
-- FILE NAME..: nopgsal.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_GET_SALARY_FOR_STEP
-- PRODUCT....: POSNCTL
-- USAGE......: Retrieve salary amount.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure retrieves the salary amount based on a combination of
-- salary table, grade, step, and group entered or defaulted on PAF.
--
-- DESCRIPTION END
--
   CURSOR PTI_CURSOR IS
          SELECT TO_CHAR(ROUND(NTRSALA_AMOUNT, 6))
          FROM   NTRSALA
          WHERE  NTRSALA_TABLE = par_sal_table
            AND  NTRSALA_GRADE = par_sal_grade
            AND  NTRSALA_STEP = par_sal_step
            AND  NTRSALA_SGRP_CODE = par_sgrp;
--
   BEGIN
   msg := NULL;
   msg_type := NULL;
--
      OPEN PTI_CURSOR ;
      FETCH PTI_CURSOR INTO par_sala_amount;
      IF PTI_CURSOR%NOTFOUND THEN
           msg :=  G$_NLS.Get('NOPGSAL-0000', 'SQL','*ERROR* Salary record not found for entered Table, Grade, and Step.')
                  ;
           msg_type := 'E';
      END IF;
   END ;
/


DROP PUBLIC SYNONYM P_GET_SALARY_FOR_STEP;

CREATE PUBLIC SYNONYM P_GET_SALARY_FOR_STEP FOR BANINST1.P_GET_SALARY_FOR_STEP;


GRANT EXECUTE ON BANINST1.P_GET_SALARY_FOR_STEP TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_GET_SALARY_FOR_STEP TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_GET_SALARY_FOR_STEP TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_GET_SALARY_FOR_STEP TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_GET_SALARY_FOR_STEP TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_GET_SALARY_FOR_STEP TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_GET_SALARY_FOR_STEP TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_GET_SALARY_FOR_STEP TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_GET_SALARY_FOR_STEP TO GENERAL;

GRANT EXECUTE ON BANINST1.P_GET_SALARY_FOR_STEP TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_GET_SALARY_FOR_STEP TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_GET_SALARY_FOR_STEP TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_GET_SALARY_FOR_STEP TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_GET_SALARY_FOR_STEP TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_GET_SALARY_FOR_STEP TO SATURN;

GRANT EXECUTE ON BANINST1.P_GET_SALARY_FOR_STEP TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_GET_SALARY_FOR_STEP TO WTAILOR;
DROP PROCEDURE BANINST1.P_GLOBAL_GRNT_ASSGN;

CREATE OR REPLACE PROCEDURE BANINST1.p_global_grnt_assgn(
                coas_code       ftvcoas.ftvcoas_coas_code%type := NULL,
                grnt_code       frrgrnl.frrgrnl_grnt_code%type := NULL,
                grnt_beg_prd    varchar2 := NULL,
                grnt_end_prd    varchar2 := NULL,
                grnt_beg_yr     frrgrnl.frrgrnl_grnt_yr%type := NULL,
                grnt_end_yr     frrgrnl.frrgrnl_grnt_yr%type := NULL,
                atyp_code       ftvatyp.ftvatyp_atyp_code%type := NULL,
                acct_code       ftvacct.ftvacct_acct_code%type := NULL,
                atyp_level_1_2_ind number := NULL,
                fund_code       ftvfund.ftvfund_fund_code%type := NULL,
                orgn_code       ftvorgn.ftvorgn_orgn_code%type := NULL,
                prog_code       ftvprog.ftvprog_prog_code%type := NULL,
                actv_code       ftvactv.ftvactv_actv_code%type := NULL,
                locn_code       ftvlocn.ftvlocn_locn_code%type := NULL,
                rev_acct_ind    varchar2 := NULL,
                trail_in_prd_ind varchar2 := NULL
                                              ) as
--
-- FILE NAME..: frpgasn.sql
-- RELEASE....: 4.2
-- OBJECT NAME: P_GLOBAL_GRNT_ASSGN
-- PRODUCT....: FINANCE
-- USAGE......: Assigns values to global variables in frkgvar package
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- Procedure: p_global_grnt_asgn
-- It assigns values to global variables in frkgvar package used in
-- FRVGBAL and FRVGBAA views in Grant Inception To Date Form FRIGITD
-- Parameters:
-- frkgvar.coas_code := 'B';
-- frkgvar.grnt_code := '215502';
-- frkgvar.grnt_end_prd := '03' ;
-- frkgvar.grnt_beg_prd := '01';
-- frkgvar.grnt_end_prd := '03';
-- frkgvar.grnt_end_yr := '97'  ;
-- frkgvar.grnt_beg_yr := '96' ;
-- frkgvar.atyp_code   := '61' ;
-- frkgvar.acct_code := '6111' ;
-- frkgvar.atyp_level_1_2_ind := 1;
-- frkgvar.trail_in_prd_ind   := 'Y';
-- Example:
-- p_global_grnt_assgn(coas_code,grnt_code,grnt_beg_prd,grnt_end_prd,
--                             grnt_beg_yr,grnt_end_yr,atyp_code,
--                             acct_code,atyp_level_1_2_ind,
--                             trail_in_prd_ind)
--
--
-- DESCRIPTION END
--
  begin
--
  frkgvar.coas_code := coas_code;
--
  frkgvar.grnt_code := grnt_code;
--
  frkgvar.grnt_beg_prd := grnt_beg_prd;
--
  frkgvar.grnt_end_prd := grnt_end_prd;
--
  frkgvar.grnt_beg_yr  := grnt_beg_yr;
--
  frkgvar.grnt_end_yr  := grnt_end_yr;
--
  frkgvar.atyp_code    := atyp_code;
--
  frkgvar.acct_code    := acct_code;
--
  frkgvar.atyp_level_1_2_ind := atyp_level_1_2_ind;
--
  frkgvar.fund_code    := fund_code;
--
  frkgvar.orgn_code    := orgn_code;
--
  frkgvar.prog_code    := prog_code;
--
  frkgvar.actv_code    := actv_code;
--
  frkgvar.locn_code    := locn_code;
--
  frkgvar.incl_revenue_acct := rev_acct_ind;
--
  frkgvar.trail_in_prd_ind  := trail_in_prd_ind;
--
end p_global_grnt_assgn;
/


DROP PUBLIC SYNONYM P_GLOBAL_GRNT_ASSGN;

CREATE PUBLIC SYNONYM P_GLOBAL_GRNT_ASSGN FOR BANINST1.P_GLOBAL_GRNT_ASSGN;


GRANT EXECUTE ON BANINST1.P_GLOBAL_GRNT_ASSGN TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_GLOBAL_GRNT_ASSGN TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_GLOBAL_GRNT_ASSGN TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_GLOBAL_GRNT_ASSGN TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_GLOBAL_GRNT_ASSGN TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_GLOBAL_GRNT_ASSGN TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_GLOBAL_GRNT_ASSGN TO GENERAL;

GRANT EXECUTE ON BANINST1.P_GLOBAL_GRNT_ASSGN TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_GLOBAL_GRNT_ASSGN TO SATURN;

GRANT EXECUTE ON BANINST1.P_GLOBAL_GRNT_ASSGN TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_GLOBAL_GRNT_ASSGN TO WTAILOR;
DROP PROCEDURE BANINST1.P_INS_DFLT_EARN_REC;

CREATE OR REPLACE PROCEDURE BANINST1.p_ins_dflt_earn_rec
     (par_nbrearn_pidm IN nbrearn.nbrearn_pidm%TYPE,
      par_nbrearn_posn IN nbrearn.nbrearn_posn%TYPE,
      par_nbrearn_suff IN nbrearn.nbrearn_suff%TYPE,
      par_nbrearn_effective_date IN nbrearn.nbrearn_effective_date%TYPE,
      par_nbrearn_earn_code IN nbrearn.nbrearn_earn_code%TYPE,
      par_nbrearn_hrs IN nbrearn.nbrearn_hrs%TYPE,
      par_nbrearn_shift IN nbrearn.nbrearn_shift%TYPE,
      par_msg OUT VARCHAR2)
--
IS
--
-- FILE NAME..: nopiern.sql
-- RELEASE....: 7.3
-- OBJECT NAME: P_INS_DFLT_EARN_REC
-- PRODUCT....: POSNCTL
-- USAGE......: Insert default earn record for a new job.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure inserts a default earn record for a new job.
--
-- DESCRIPTION END
--
   CURSOR PTI_CURSOR IS
   SELECT 'X'
   FROM   NBREARN
   WHERE  NBREARN_PIDM = par_nbrearn_pidm
     AND  NBREARN_POSN = par_nbrearn_posn
     AND  NBREARN_SUFF = par_nbrearn_suff
     AND  NBREARN_EARN_CODE = par_nbrearn_earn_code
     AND  NBREARN_EFFECTIVE_DATE = par_nbrearn_effective_date;
--
   EARN_EXISTS VARCHAR2(1) ;
--
BEGIN
   par_msg := NULL;
--
   OPEN PTI_CURSOR ;
   FETCH PTI_CURSOR INTO EARN_EXISTS ;
   IF PTI_CURSOR%NOTFOUND THEN
      INSERT INTO NBREARN (
        nbrearn_pidm,
        nbrearn_posn,
        nbrearn_suff,
        nbrearn_effective_date,
        nbrearn_earn_code,
        nbrearn_active_ind,
        nbrearn_hrs,
        nbrearn_special_rate,
        nbrearn_shift,
        nbrearn_activity_date,
        nbrearn_deemed_hrs,
        nbrearn_user_id,
        nbrearn_data_origin)
      VALUES (
        par_nbrearn_pidm,
        par_nbrearn_posn,
        par_nbrearn_suff,
        par_nbrearn_effective_date,
        par_nbrearn_earn_code,
        'Y',
        par_nbrearn_hrs,
        NULL,
        par_nbrearn_shift,
        SYSDATE,
        NULL,
        gb_common.f_sct_user,
        gb_common.DATA_ORIGIN);
   CLOSE PTI_CURSOR;
   END IF;
EXCEPTION
   WHEN OTHERS THEN
      par_msg :=  G$_NLS.Get('NOPIERN-0000', 'SQL',
	'*ERROR* Unable to insert NBREARN record (Oracle Error %01%).',  TO_CHAR(SQLCODE) );
END;
/


DROP PUBLIC SYNONYM P_INS_DFLT_EARN_REC;

CREATE PUBLIC SYNONYM P_INS_DFLT_EARN_REC FOR BANINST1.P_INS_DFLT_EARN_REC;


GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO GENERAL;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO PAYROLL;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO SATURN;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_EARN_REC TO WTAILOR;
DROP PROCEDURE BANINST1.P_INS_DFLT_WKSH;

CREATE OR REPLACE PROCEDURE BANINST1.p_ins_dflt_wksh
     (par_pidm                   IN nbrjobs.nbrjobs_pidm%TYPE,
      par_posn                   IN nbrjobs.nbrjobs_posn%TYPE,
      par_suff                   IN nbrjobs.nbrjobs_suff%TYPE,
      par_jobs_eff_date          IN nbrjobs.nbrjobs_effective_date%TYPE,
      par_wksh_code              IN varchar2,
      par_posn_wksh              IN nbbposn.nbbposn_wksh_code%TYPE,
      par_wksh_eff_date          IN nbbwksh.nbbwksh_effective_date%TYPE,
      par_msg                    OUT noreaer.noreaer_error_msg%TYPE)
IS
--
-- FILE NAME..: nopiwks.sql
-- RELEASE....: 7.3
-- OBJECT NAME: P_INS_DFLT_WKSH
-- PRODUCT....: POSNCTL
-- USAGE......: Insert default work schedule for a new job.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure inserts default work schedule for a new job.
--
-- DESCRIPTION END
--
   CURSOR PTI_CURSOR IS
      SELECT 'X'
      FROM   NBBWKSH
      WHERE  NBBWKSH_PIDM = par_pidm
        AND  NBBWKSH_POSN = par_posn
        AND  NBBWKSH_SUFF = par_suff;
--
   CURSOR PTI_CURSOR_2 IS
      SELECT MAX(NTRWKSH_DAY), MIN(NTRWKSH_DAY)
      FROM   NTRWKSH
      WHERE  NTRWKSH_CODE = NVL(par_wksh_code, par_posn_wksh) ;
--
   var_dummy             VARCHAR2(1);
   var_hold_day          nbbwksh.nbbwksh_schedule_begin_day%TYPE;
   var_hold_max_day      nbbwksh.nbbwksh_schedule_begin_day%TYPE;
   missing_nbrwksh       EXCEPTION;
--
BEGIN
   par_msg := NULL;
--
   OPEN PTI_CURSOR ;
   FETCH PTI_CURSOR INTO var_dummy ;
      IF PTI_CURSOR%NOTFOUND THEN
         INSERT INTO NBBWKSH(
           nbbwksh_pidm,
           nbbwksh_posn,
           nbbwksh_suff,
           nbbwksh_effective_date,
           nbbwksh_schedule_begin_day,
           nbbwksh_schedule_end_date,
           nbbwksh_activity_date,
           nbbwksh_deemed_hrs)
         VALUES
          (par_pidm,
           par_posn,
           par_suff,
           par_jobs_eff_date,
           1,
           NULL,
           SYSDATE,
           NULL);
--
   OPEN PTI_CURSOR_2 ;
         FETCH PTI_CURSOR_2 INTO var_hold_max_day, var_hold_day;
         IF var_hold_day IS NOT NULL THEN
            WHILE var_hold_day <= var_hold_max_day
            LOOP
            INSERT INTO NBRWKSH
                SELECT par_pidm,
                       par_posn,
                       par_suff,
                       NVL(par_wksh_eff_date, par_jobs_eff_date),
                       NTRWKSH_DAY,
                       NTRWKSH_SHIFT,
                       NTRWKSH_HOURS,
                       SYSDATE
                FROM   NTRWKSH
                WHERE  NTRWKSH_CODE = NVL(par_wksh_code, par_posn_wksh)
                  AND  NTRWKSH_DAY = var_hold_day;
           var_hold_day := var_hold_day + 1;
           END LOOP;
         ELSE
            CLOSE PTI_CURSOR;
            CLOSE PTI_CURSOR_2;
            RAISE missing_nbrwksh;
         END IF;
         CLOSE PTI_CURSOR_2;
      ELSE
         RETURN;
      END IF;
   CLOSE PTI_CURSOR;
--
EXCEPTION
   WHEN missing_nbrwksh THEN
      par_msg :=  G$_NLS.Get('NOPIWKS-0000', 'SQL','*ERROR* Daily Schedule which corresponds to Schedule Base Block does not exist.') ;
   WHEN OTHERS THEN
      par_msg :=  G$_NLS.Get('NOPIWKS-0001', 'SQL',
	'*ERROR* Unable to insert default work schedule (Oracle Error %01%).',  TO_CHAR(SQLCODE) );
END;
/


DROP PUBLIC SYNONYM P_INS_DFLT_WKSH;

CREATE PUBLIC SYNONYM P_INS_DFLT_WKSH FOR BANINST1.P_INS_DFLT_WKSH;


GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO GENERAL;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO PAYROLL;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO SATURN;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_INS_DFLT_WKSH TO WTAILOR;
DROP PROCEDURE BANINST1.P_INS_NBRBJLH_REC;

CREATE OR REPLACE PROCEDURE BANINST1.p_ins_nbrbjlh_rec
     (par_nbrjlbd_pidm           IN nbrjlbd.nbrjlbd_pidm%TYPE,
      par_nbrjlbd_posn           IN nbrjlbd.nbrjlbd_posn%TYPE,
      par_nbrjlbd_suff           IN nbrjlbd.nbrjlbd_suff%TYPE,
      par_nbrjlbd_effective_date IN nbrjlbd.nbrjlbd_effective_date%TYPE,
      par_change_reason          IN nbrbjlh.nbrbjlh_change_reason%TYPE,
      par_nbrbjob_begin_date     IN nbrbjob.nbrbjob_begin_date%TYPE,
      par_capture_date           IN date,
      par_msg                   OUT VARCHAR2)
IS
--
-- FILE NAME..: nopijlh.sql
-- RELEASE....: 7.3
-- OBJECT NAME: P_INS_NBRBJLH_REC
-- PRODUCT....: POSNCTL
-- USAGE......: Insert a base job labor distribution history record, NBRBJLH.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure inserts a base job labor distribution history record,NBRBJLH.
--
-- DESCRIPTION END
--
BEGIN
   par_msg := NULL;
--
   INSERT INTO nbrbjlh (
     nbrbjlh_pidm,
     nbrbjlh_posn,
     nbrbjlh_suff,
     nbrbjlh_effective_date,
     nbrbjlh_capture_date,
     nbrbjlh_change_reason,
     nbrbjlh_user_id,
     nbrbjlh_activity_date,
     nbrbjlh_data_origin)
   VALUES(
     par_nbrjlbd_pidm,
     par_nbrjlbd_posn,
     par_nbrjlbd_suff,
     NVL(par_nbrjlbd_effective_date,par_nbrbjob_begin_date),
     par_capture_date,
     par_change_reason,
     gb_common.f_sct_user,
     SYSDATE,
     gb_common.DATA_ORIGIN);
EXCEPTION
   WHEN OTHERS THEN
      par_msg :=  G$_NLS.Get('NOPIJLH-0000', 'SQL',
	'*ERROR* Unable to insert NBRBJLH record (Oracle Error %01%).',
                 TO_CHAR(SQLCODE) );
END;
/


DROP PUBLIC SYNONYM P_INS_NBRBJLH_REC;

CREATE PUBLIC SYNONYM P_INS_NBRBJLH_REC FOR BANINST1.P_INS_NBRBJLH_REC;


GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO GENERAL;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO PAYROLL;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO SATURN;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJLH_REC TO WTAILOR;
DROP PROCEDURE BANINST1.P_INS_NBRBJOB_REC;

CREATE OR REPLACE PROCEDURE BANINST1.p_ins_nbrbjob_rec
     (par_nbrbjob_pidm IN nbrbjob.nbrbjob_pidm%TYPE,
      par_nbrbjob_posn IN nbrbjob.nbrbjob_posn%TYPE,
      par_nbrbjob_suff IN nbrbjob.nbrbjob_suff%TYPE,
      par_nbrbjob_begin_date IN nbrbjob.nbrbjob_begin_date%TYPE,
      par_nbrbjob_end_date IN nbrbjob.nbrbjob_end_date%TYPE,
      par_nbrbjob_defer_bal IN nbrbjob.nbrbjob_defer_bal%TYPE,
      par_nbrbjob_contract_type IN nbrbjob.nbrbjob_contract_type%TYPE,
      par_nbrbjob_salary_encumbrance IN nbrbjob.nbrbjob_salary_encumbrance%TYPE,
   par_nbrbjob_contract_beg_date IN nbrbjob.nbrbjob_contract_begin_date%TYPE,
   par_nbrbjob_contract_end_date IN nbrbjob.nbrbjob_contract_end_date%TYPE,
   par_nbrbjob_total_contract_hrs IN nbrbjob.nbrbjob_total_contract_hrs%TYPE,
   par_nbrbjob_total_encumb_hrs IN nbrbjob.nbrbjob_total_encumbrance_hrs%TYPE,
      par_nbrbjob_step_incr_mon IN nbrbjob.nbrbjob_step_incr_mon%TYPE,
      par_nbrbjob_step_incr_day IN nbrbjob.nbrbjob_step_incr_day%TYPE,
      par_nbrbjob_coas_code IN nbrbjob.nbrbjob_coas_code%TYPE,
      par_nbrbjob_accrue_leave_ind IN nbrbjob.nbrbjob_accrue_leave_ind%TYPE,
      par_nbrbjob_civil_service_ind IN nbrbjob.nbrbjob_civil_service_ind%TYPE,
  par_nbrbjob_encumb_change_ind IN nbrbjob.nbrbjob_encumbrance_change_ind%TYPE,
  par_nbrbjob_fringe_encumbrance IN nbrbjob.nbrbjob_fringe_encumbrance%TYPE,
      par_nbrbjob_ipeds_rept_ind IN nbrbjob.nbrbjob_ipeds_rept_ind%TYPE,
  par_nbrbjob_facl_stat_rpt_ind IN nbrbjob.nbrbjob_facl_statscan_rept_ind%TYPE,
  par_nbrbjob_probation_beg_date IN nbrbjob.nbrbjob_probation_begin_date%TYPE,
      par_nbrbjob_probation_end_date IN nbrbjob.nbrbjob_probation_end_date%TYPE,
      par_nbrbjob_probation_units IN nbrbjob.nbrbjob_probation_units%TYPE,
      par_nbrbjob_eligible_date IN nbrbjob.nbrbjob_eligible_date%TYPE,
      par_msg OUT VARCHAR2)
IS
--
-- FILE NAME..: nopijob.sql
-- RELEASE....: 7.3
-- OBJECT NAME: P_INS_NBRBJOB_REC
-- PRODUCT....: POSNCTL
-- USAGE......: Insert the NBRBJOB record for a new job.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure inserts the NBRBJOB record for a new job.
--
-- DESCRIPTION END
--
BEGIN
   par_msg := NULL;
--
   INSERT INTO nbrbjob(
     nbrbjob_pidm,
     nbrbjob_posn,
     nbrbjob_suff,
     nbrbjob_begin_date,
     nbrbjob_end_date,
     nbrbjob_defer_bal,
     nbrbjob_contract_type,
     nbrbjob_salary_encumbrance,
     nbrbjob_contract_begin_date,
     nbrbjob_contract_end_date,
     nbrbjob_total_contract_hrs,
     nbrbjob_total_encumbrance_hrs,
     nbrbjob_step_incr_mon,
     nbrbjob_step_incr_day,
     nbrbjob_coas_code,
     nbrbjob_activity_date,
     nbrbjob_accrue_leave_ind,
     nbrbjob_civil_service_ind,
     nbrbjob_encumbrance_change_ind,
     nbrbjob_fringe_encumbrance,
     nbrbjob_ipeds_rept_ind,
     nbrbjob_facl_statscan_rept_ind,
     nbrbjob_probation_begin_date,
     nbrbjob_probation_end_date,
     nbrbjob_probation_units,
     nbrbjob_eligible_date,
     nbrbjob_user_id,
     nbrbjob_data_origin)
   VALUES
    (par_nbrbjob_pidm,
     par_nbrbjob_posn,
     par_nbrbjob_suff,
     par_nbrbjob_begin_date,
     par_nbrbjob_end_date,
     par_nbrbjob_defer_bal,
     par_nbrbjob_contract_type,
     par_nbrbjob_salary_encumbrance,
     par_nbrbjob_contract_beg_date,
     par_nbrbjob_contract_end_date,
     par_nbrbjob_total_contract_hrs,
     par_nbrbjob_total_encumb_hrs,
     par_nbrbjob_step_incr_mon,
     par_nbrbjob_step_incr_day,
     par_nbrbjob_coas_code,
     SYSDATE,
     par_nbrbjob_accrue_leave_ind,
     par_nbrbjob_civil_service_ind,
     par_nbrbjob_encumb_change_ind,
     par_nbrbjob_fringe_encumbrance,
     par_nbrbjob_ipeds_rept_ind,
     par_nbrbjob_facl_stat_rpt_ind,
     par_nbrbjob_probation_beg_date,
     par_nbrbjob_probation_end_date,
     par_nbrbjob_probation_units,
     par_nbrbjob_eligible_date,
     gb_common.f_sct_user,
     gb_common.DATA_ORIGIN);
EXCEPTION
   WHEN OTHERS THEN
      par_msg :=  G$_NLS.Get('NOPIJOB-0000', 'SQL',
	'*ERROR* Unable to insert NBRBJOB record (Oracle Error %01%).',
                 TO_CHAR(SQLCODE) );
END;
/


DROP PUBLIC SYNONYM P_INS_NBRBJOB_REC;

CREATE PUBLIC SYNONYM P_INS_NBRBJOB_REC FOR BANINST1.P_INS_NBRBJOB_REC;


GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO BANIMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO GENERAL;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO PAYROLL;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO SATURN;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRBJOB_REC TO WTAILOR;
DROP PROCEDURE BANINST1.P_INS_NBRJLBD_BACKOUT_REC;

CREATE OR REPLACE PROCEDURE BANINST1.p_ins_nbrjlbd_backout_rec
     (par_nbrjlbd_pidm           IN nbrjlbd.nbrjlbd_pidm%TYPE,
      par_nbrjlbd_posn           IN nbrjlbd.nbrjlbd_posn%TYPE,
      par_nbrjlbd_suff           IN nbrjlbd.nbrjlbd_suff%TYPE,
      par_nbrjlbd_effective_date IN nbrjlbd.nbrjlbd_effective_date%TYPE,
      par_msg                   OUT VARCHAR2)
IS
--
-- FILE NAME..: nopibck.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_INS_NBRJLBD_BACKOUT_REC
-- PRODUCT....: POSNCTL
-- USAGE......: Insert a set of deleted records in NBRJLBD.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure inserts the deleted records when a record is changed or
-- deleted in the NBRJBLN table. When needed it also reverse the records
-- for posted amounts.
--
-- DESCRIPTION END
--
BEGIN
   par_msg := NULL;
--
   INSERT INTO NBRJLBD
      (NBRJLBD_PIDM,
       NBRJLBD_SUFF,
       NBRJLBD_EFFECTIVE_DATE,
       NBRJLBD_POSN,
       NBRJLBD_COAS_CODE,
       NBRJLBD_ACCI_CODE,
       NBRJLBD_FUND_CODE,
       NBRJLBD_ORGN_CODE,
       NBRJLBD_ACCT_CODE,
       NBRJLBD_PROG_CODE,
       NBRJLBD_ACTV_CODE,
       NBRJLBD_LOCN_CODE,
       NBRJLBD_ACCT_CODE_EXTERNAL,
       NBRJLBD_PERCENT,
       NBRJLBD_ACTIVITY_DATE,
       NBRJLBD_ENCD_NUM,
       NBRJLBD_ENCD_SEQ_NUM,
       NBRJLBD_CHANGE_IND,
       NBRJLBD_SALARY_ENCUMBRANCE,
       NBRJLBD_SALARY_ENC_TO_POST,
       NBRJLBD_FRINGE_ENCUMBRANCE,
       NBRJLBD_FRINGE_ENC_TO_POST,
       NBRJLBD_FRINGE_RESIDUAL,
       NBRJLBD_FRINGE_RES_TO_POST,
       NBRJLBD_FUND_CODE_FRINGE,
       NBRJLBD_ORGN_CODE_FRINGE,
       NBRJLBD_ACCT_CODE_FRINGE,
       NBRJLBD_PROG_CODE_FRINGE,
       NBRJLBD_ACTV_CODE_FRINGE,
       NBRJLBD_LOCN_CODE_FRINGE,
       NBRJLBD_PROJ_CODE,
       NBRJLBD_CTYP_CODE )
   SELECT
      par_nbrjlbd_pidm,
      par_nbrjlbd_suff,
      NBRJLBD_EFFECTIVE_DATE,
      NBRJLBD_POSN,
      NBRJLBD_COAS_CODE,
      NBRJLBD_ACCI_CODE,
      NBRJLBD_FUND_CODE,
      NBRJLBD_ORGN_CODE,
      NBRJLBD_ACCT_CODE,
      NBRJLBD_PROG_CODE,
      NBRJLBD_ACTV_CODE,
      NBRJLBD_LOCN_CODE,
      NBRJLBD_ACCT_CODE_EXTERNAL,
      NBRJLBD_PERCENT,
      NBRJLBD_ACTIVITY_DATE,
      NBRJLBD_ENCD_NUM,
      NBRJLBD_ENCD_SEQ_NUM,
      'D',
      NBRJLBD_SALARY_ENCUMBRANCE,
      NVL(NBRJLBD_SALARY_ENC_TO_POST,0) -
          NVL(NBRJLBD_SALARY_ENCUMBRANCE,0),
      NBRJLBD_FRINGE_ENCUMBRANCE,
      NVL(NBRJLBD_FRINGE_ENC_TO_POST,0) -
          NVL(NBRJLBD_FRINGE_ENCUMBRANCE,0),
      NBRJLBD_FRINGE_RESIDUAL,
      NVL(NBRJLBD_FRINGE_RES_TO_POST,0) -
          NVL(NBRJLBD_FRINGE_RESIDUAL,0),
      NBRJLBD_FUND_CODE_FRINGE,
      NBRJLBD_ORGN_CODE_FRINGE,
      NBRJLBD_ACCT_CODE_FRINGE,
      NBRJLBD_PROG_CODE_FRINGE,
      NBRJLBD_ACTV_CODE_FRINGE,
      NBRJLBD_LOCN_CODE_FRINGE,
      NBRJLBD_PROJ_CODE,
      NBRJLBD_CTYP_CODE
   FROM   NBRJLBD
   WHERE  NBRJLBD_PIDM = par_nbrjlbd_pidm
     AND  NBRJLBD_POSN = par_nbrjlbd_posn
     AND  NBRJLBD_SUFF = par_nbrjlbd_suff
     AND  NBRJLBD_EFFECTIVE_DATE = par_nbrjlbd_effective_date
     AND NBRJLBD_CHANGE_IND = 'A';
EXCEPTION
   WHEN OTHERS THEN
      par_msg :=  G$_NLS.Get('NOPIBCK-0000', 'SQL',
	'*ERROR* Unable to back out Job Labor Distribution (Oracle Error %01%).'
	,  TO_CHAR(SQLCODE) );
END;
/


DROP PUBLIC SYNONYM P_INS_NBRJLBD_BACKOUT_REC;

CREATE PUBLIC SYNONYM P_INS_NBRJLBD_BACKOUT_REC FOR BANINST1.P_INS_NBRJLBD_BACKOUT_REC;


GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_BACKOUT_REC TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_BACKOUT_REC TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_BACKOUT_REC TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_BACKOUT_REC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_BACKOUT_REC TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_BACKOUT_REC TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_BACKOUT_REC TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_BACKOUT_REC TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_BACKOUT_REC TO GENERAL;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_BACKOUT_REC TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_BACKOUT_REC TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_BACKOUT_REC TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_BACKOUT_REC TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_BACKOUT_REC TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_BACKOUT_REC TO SATURN;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_BACKOUT_REC TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_BACKOUT_REC TO WTAILOR;
DROP PROCEDURE BANINST1.P_INS_NBRJLBD_REC;

CREATE OR REPLACE PROCEDURE BANINST1.p_ins_nbrjlbd_rec
     (par_nbrjlbd_pidm IN nbrjlbd.nbrjlbd_pidm%TYPE,
      par_nbrjlbd_posn IN nbrjlbd.nbrjlbd_posn%TYPE,
      par_nbrjlbd_suff IN nbrjlbd.nbrjlbd_suff%TYPE,
      par_nbrjlbd_effective_date IN nbrjlbd.nbrjlbd_effective_date%TYPE,
      par_nbrjlbd_coas_code IN nbrjlbd.nbrjlbd_coas_code%TYPE,
      par_nbrjlbd_acci_code IN nbrjlbd.nbrjlbd_acci_code%TYPE,
      par_nbrjlbd_fund_code IN nbrjlbd.nbrjlbd_fund_code%TYPE,
      par_nbrjlbd_orgn_code IN nbrjlbd.nbrjlbd_orgn_code%TYPE,
      par_nbrjlbd_acct_code IN nbrjlbd.nbrjlbd_acct_code%TYPE,
      par_nbrjlbd_prog_code IN nbrjlbd.nbrjlbd_prog_code%TYPE,
      par_nbrjlbd_actv_code IN nbrjlbd.nbrjlbd_actv_code%TYPE,
      par_nbrjlbd_locn_code IN nbrjlbd.nbrjlbd_locn_code%TYPE,
      par_nbrjlbd_proj_code IN nbrjlbd.nbrjlbd_proj_code%TYPE,
      par_nbrjlbd_ctyp_code IN nbrjlbd.nbrjlbd_ctyp_code%TYPE,
      par_nbrjlbd_acct_code_external IN nbrjlbd.nbrjlbd_acct_code_external%TYPE,
      par_nbrjlbd_percent IN nbrjlbd.nbrjlbd_percent%TYPE,
      par_nbrjlbd_encd_num IN nbrjlbd.nbrjlbd_encd_num%TYPE,
      par_nbrjlbd_encd_seq_num IN nbrjlbd.nbrjlbd_encd_seq_num%TYPE,
      par_msg OUT noreaer.noreaer_error_msg%TYPE)
IS
--
-- FILE NAME..: nopilbd.sql
-- RELEASE....: 7.3
-- OBJECT NAME: P_INS_NBRJLBD_REC
-- PRODUCT....: POSNCTL
-- USAGE......: Insert job labor distribution record.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure inserts job labor distribution record.
--
-- DESCRIPTION END
--
BEGIN
   par_msg := NULL;
--
   INSERT INTO NBRJLBD (
     nbrjlbd_pidm,
     nbrjlbd_posn,
     nbrjlbd_suff,
     nbrjlbd_effective_date,
     nbrjlbd_coas_code,
     nbrjlbd_acci_code,
     nbrjlbd_fund_code,
     nbrjlbd_orgn_code,
     nbrjlbd_acct_code,
     nbrjlbd_prog_code,
     nbrjlbd_actv_code,
     nbrjlbd_locn_code,
     nbrjlbd_proj_code,
     nbrjlbd_ctyp_code,
     nbrjlbd_acct_code_external,
     nbrjlbd_percent,
     nbrjlbd_encd_num,
     nbrjlbd_encd_seq_num,
     nbrjlbd_salary_encumbrance,
     nbrjlbd_salary_enc_to_post,
     nbrjlbd_fringe_encumbrance,
     nbrjlbd_fringe_enc_to_post,
     nbrjlbd_fund_code_fringe,
     nbrjlbd_orgn_code_fringe,
     nbrjlbd_acct_code_fringe,
     nbrjlbd_prog_code_fringe,
     nbrjlbd_actv_code_fringe,
     nbrjlbd_locn_code_fringe,
     nbrjlbd_change_ind,
     nbrjlbd_activity_date,
     nbrjlbd_fringe_residual,
     nbrjlbd_fringe_res_to_post,
     nbrjlbd_user_id,
     nbrjlbd_data_origin)
   VALUES
    (par_nbrjlbd_pidm,
     par_nbrjlbd_posn,
     par_nbrjlbd_suff,
     par_nbrjlbd_effective_date,
     par_nbrjlbd_coas_code,
     par_nbrjlbd_acci_code,
     par_nbrjlbd_fund_code,
     par_nbrjlbd_orgn_code,
     par_nbrjlbd_acct_code,
     par_nbrjlbd_prog_code,
     par_nbrjlbd_actv_code,
     par_nbrjlbd_locn_code,
     par_nbrjlbd_proj_code,
     par_nbrjlbd_ctyp_code,
     par_nbrjlbd_acct_code_external,
     par_nbrjlbd_percent,
     par_nbrjlbd_encd_num,
     par_nbrjlbd_encd_seq_num,
     '',
     0,
     '',
     0,
     '',
     '',
     '',
     '',
     '',
     '',
     'A',
     SYSDATE,
     '',
     0,
     gb_common.f_sct_user,
     gb_common.DATA_ORIGIN);

EXCEPTION
   WHEN OTHERS THEN
      par_msg :=  G$_NLS.Get('NOPILBD-0000', 'SQL',
	'*ERROR* Unable to insert NBRJLBD record (Oracle Error %01%).',  TO_CHAR(SQLCODE) );
END;
/


DROP PUBLIC SYNONYM P_INS_NBRJLBD_REC;

CREATE PUBLIC SYNONYM P_INS_NBRJLBD_REC FOR BANINST1.P_INS_NBRJLBD_REC;


GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO GENERAL;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO PAYROLL;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO SATURN;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLBD_REC TO WTAILOR;
DROP PROCEDURE BANINST1.P_INS_NBRJLHS_REC;

CREATE OR REPLACE PROCEDURE BANINST1.p_ins_nbrjlhs_rec
     (par_nbrjlbd_pidm           IN nbrjlbd.nbrjlbd_pidm%TYPE,
      par_nbrjlbd_posn           IN nbrjlbd.nbrjlbd_posn%TYPE,
      par_nbrjlbd_suff           IN nbrjlbd.nbrjlbd_suff%TYPE,
      par_nbrjlbd_effective_date IN nbrjlbd.nbrjlbd_effective_date%TYPE,
      par_change_reason          IN nbrbjlh.nbrbjlh_change_reason%TYPE,
      par_nbrbjob_begin_date     IN nbrbjob.nbrbjob_begin_date%TYPE,
      par_capture_date           IN date,
      par_msg                   OUT VARCHAR2)
IS
--
-- FILE NAME..: nopilhs.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_INS_NBRJLHS_REC
-- PRODUCT....: POSNCTL
-- USAGE......: Insert an assignment labor distribution history record.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure inserts an assignment labor distribution history
-- record.
--
-- DESCRIPTION END
--
BEGIN
   par_msg := NULL;
--
   INSERT INTO NBRJLHS
      (NBRJLHS_PIDM,
       NBRJLHS_POSN,
       NBRJLHS_SUFF,
       NBRJLHS_EFFECTIVE_DATE,
       NBRJLHS_CAPTURE_DATE,
       NBRJLHS_COAS_CODE,
       NBRJLHS_ACCI_CODE,
       NBRJLHS_FUND_CODE,
       NBRJLHS_ORGN_CODE,
       NBRJLHS_ACCT_CODE,
       NBRJLHS_PROG_CODE,
       NBRJLHS_ACTV_CODE,
       NBRJLHS_LOCN_CODE,
       NBRJLHS_PROJ_CODE,
       NBRJLHS_CTYP_CODE,
       NBRJLHS_ACCT_CODE_EXTERNAL,
       NBRJLHS_PERCENT,
       NBRJLHS_ENCD_NUM,
       NBRJLHS_ENCD_SEQ_NUM,
       NBRJLHS_SALARY_ENCUMBRANCE,
       NBRJLHS_SALARY_ENC_TO_POST,
       NBRJLHS_FRINGE_ENCUMBRANCE,
       NBRJLHS_FRINGE_ENC_TO_POST,
       NBRJLHS_FRINGE_RESIDUAL,
       NBRJLHS_FRINGE_RES_TO_POST,
       NBRJLHS_FUND_CODE_FRINGE,
       NBRJLHS_ORGN_CODE_FRINGE,
       NBRJLHS_ACCT_CODE_FRINGE,
       NBRJLHS_PROG_CODE_FRINGE,
       NBRJLHS_ACTV_CODE_FRINGE,
       NBRJLHS_LOCN_CODE_FRINGE,
       NBRJLHS_ACTIVITY_DATE)
      SELECT NBRJLBD_PIDM,
             NBRJLBD_POSN,
             NBRJLBD_SUFF,
             NBRJLBD_EFFECTIVE_DATE,
             par_capture_date,
             NBRJLBD_COAS_CODE,
             NBRJLBD_ACCI_CODE,
             NBRJLBD_FUND_CODE,
             NBRJLBD_ORGN_CODE,
             NBRJLBD_ACCT_CODE,
             NBRJLBD_PROG_CODE,
             NBRJLBD_ACTV_CODE,
             NBRJLBD_LOCN_CODE,
             NBRJLBD_PROJ_CODE,
             NBRJLBD_CTYP_CODE,
             NBRJLBD_ACCT_CODE_EXTERNAL,
             NBRJLBD_PERCENT,
             NBRJLBD_ENCD_NUM,
             NBRJLBD_ENCD_SEQ_NUM,
             NBRJLBD_SALARY_ENCUMBRANCE,
             NBRJLBD_SALARY_ENC_TO_POST,
             NBRJLBD_FRINGE_ENCUMBRANCE,
             NBRJLBD_FRINGE_ENC_TO_POST,
             NBRJLBD_FRINGE_RESIDUAL,
             NBRJLBD_FRINGE_RES_TO_POST,
             NBRJLBD_FUND_CODE_FRINGE,
             NBRJLBD_ORGN_CODE_FRINGE,
             NBRJLBD_ACCT_CODE_FRINGE,
             NBRJLBD_PROG_CODE_FRINGE,
             NBRJLBD_ACTV_CODE_FRINGE,
             NBRJLBD_LOCN_CODE_FRINGE,
             NBRJLBD_ACTIVITY_DATE
       FROM  NBRJLBD
       WHERE NBRJLBD_PIDM = par_nbrjlbd_pidm
         AND NBRJLBD_POSN = par_nbrjlbd_posn
         AND NBRJLBD_SUFF = par_nbrjlbd_suff
         AND NBRJLBD_CHANGE_IND = 'A'
         AND NBRJLBD_EFFECTIVE_DATE =
             NVL(par_nbrjlbd_effective_date,par_nbrbjob_begin_date);
  EXCEPTION
     WHEN OTHERS THEN
     par_msg :=  G$_NLS.Get('NOPILHS-0000', 'SQL',
	'*ERROR* Unable to insert NBRJLHS record (Oracle Error %01%).'
	,
                 TO_CHAR(SQLCODE) );
END;
/


DROP PUBLIC SYNONYM P_INS_NBRJLHS_REC;

CREATE PUBLIC SYNONYM P_INS_NBRJLHS_REC FOR BANINST1.P_INS_NBRJLHS_REC;


GRANT EXECUTE ON BANINST1.P_INS_NBRJLHS_REC TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLHS_REC TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLHS_REC TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLHS_REC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLHS_REC TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLHS_REC TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLHS_REC TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLHS_REC TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLHS_REC TO GENERAL;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLHS_REC TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLHS_REC TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLHS_REC TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLHS_REC TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLHS_REC TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLHS_REC TO SATURN;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLHS_REC TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJLHS_REC TO WTAILOR;
DROP PROCEDURE BANINST1.P_INS_NBRJOBS_REC;

CREATE OR REPLACE PROCEDURE BANINST1.p_ins_nbrjobs_rec
     (par_nbrjobs_pidm IN nbrjobs.nbrjobs_pidm%TYPE,
      par_nbrjobs_posn IN nbrjobs.nbrjobs_posn%TYPE,
      par_nbrjobs_suff IN nbrjobs.nbrjobs_suff%TYPE,
      par_nbrjobs_effective_date IN nbrjobs.nbrjobs_effective_date%TYPE,
      par_nbrjobs_status IN nbrjobs.nbrjobs_status%TYPE,
      par_nbrjobs_desc IN nbrjobs.nbrjobs_desc%TYPE,
      par_nbrjobs_ecls_code IN nbrjobs.nbrjobs_ecls_code%TYPE,
      par_nbrjobs_pict_code IN nbrjobs.nbrjobs_pict_code%TYPE,
      par_nbrjobs_coas_code_ts IN nbrjobs.nbrjobs_coas_code_ts%TYPE,
      par_nbrjobs_orgn_code_ts IN nbrjobs.nbrjobs_orgn_code_ts%TYPE,
      par_nbrjobs_sal_table IN nbrjobs.nbrjobs_sal_table%TYPE,
      par_nbrjobs_sal_grade IN nbrjobs.nbrjobs_sal_grade%TYPE,
      par_nbrjobs_sal_step IN nbrjobs.nbrjobs_sal_step%TYPE,
      par_nbrjobs_appt_pct IN nbrjobs.nbrjobs_appt_pct%TYPE,
      par_nbrjobs_fte IN nbrjobs.nbrjobs_fte%TYPE,
      par_nbrjobs_hrs_day IN nbrjobs.nbrjobs_hrs_day%TYPE,
      par_nbrjobs_hrs_pay IN nbrjobs.nbrjobs_hrs_pay%TYPE,
      par_nbrjobs_shift IN nbrjobs.nbrjobs_shift%TYPE,
      par_nbrjobs_reg_rate IN nbrjobs.nbrjobs_reg_rate%TYPE,
      par_nbrjobs_assgn_salary IN nbrjobs.nbrjobs_assgn_salary%TYPE,
      par_nbrjobs_factor IN nbrjobs.nbrjobs_factor%TYPE,
      par_nbrjobs_ann_salary IN nbrjobs.nbrjobs_ann_salary%TYPE,
      par_nbrjobs_per_pay_salary IN nbrjobs.nbrjobs_per_pay_salary%TYPE,
      par_nbrjobs_pays IN nbrjobs.nbrjobs_pays%TYPE,
      par_nbrjobs_per_pay_defer_amt IN nbrjobs.nbrjobs_per_pay_defer_amt%TYPE,
      par_nbrjobs_jcre_code IN nbrjobs.nbrjobs_jcre_code%TYPE,
      par_nbrjobs_sgrp_code IN nbrjobs.nbrjobs_sgrp_code%TYPE,
      par_nbrjobs_empr_code IN nbrjobs.nbrjobs_empr_code%TYPE,
      par_nbrjobs_lgcd_code IN nbrjobs.nbrjobs_lgcd_code%TYPE,
      par_nbrjobs_locn_code IN nbrjobs.nbrjobs_locn_code%TYPE,
      par_nbrjobs_schl_code IN nbrjobs.nbrjobs_schl_code%TYPE,
      par_nbrjobs_supervisor_pidm IN nbrjobs.nbrjobs_supervisor_pidm%TYPE,
      par_nbrjobs_supervisor_posn IN nbrjobs.nbrjobs_supervisor_posn%TYPE,
      par_nbrjobs_supervisor_suff IN nbrjobs.nbrjobs_supervisor_suff%TYPE,
      par_nbrjobs_wkcp_code IN nbrjobs.nbrjobs_wkcp_code%TYPE,
      par_nbrjobs_jbln_code IN nbrjobs.nbrjobs_jbln_code%TYPE,
      par_nbrjobs_pers_chg_date IN nbrjobs.nbrjobs_pers_chg_date%TYPE,
      par_nbrjobs_pcat_code IN nbrjobs.nbrjobs_pcat_code%TYPE,
      par_nbrjobs_dfpr_code IN nbrjobs.nbrjobs_dfpr_code%TYPE,
      par_nbrjobs_encumbrance_hrs IN nbrjobs.nbrjobs_encumbrance_hrs%TYPE,
      par_nbrjobs_contract_no IN nbrjobs.nbrjobs_contract_no%TYPE,
      par_nbrjobs_strs_assn_code IN nbrjobs.nbrjobs_strs_assn_code%TYPE,
      par_nbrjobs_strs_pay_code IN nbrjobs.nbrjobs_strs_pay_code%TYPE,
      par_nbrjobs_pers_pay_code IN nbrjobs.nbrjobs_pers_pay_code%TYPE,
      par_nbrjobs_time_entry_method IN nbrjobs.nbrjobs_time_entry_method%TYPE,
      par_nbrjobs_time_entry_type IN nbrjobs.nbrjobs_time_entry_type%TYPE,
      par_nbrjobs_time_in_out_ind IN nbrjobs.nbrjobs_time_in_out_ind%TYPE,
      par_nbrjobs_lcat_code IN nbrjobs.nbrjobs_lcat_code%TYPE,
      par_nbrjobs_leav_rept_method IN nbrjobs.nbrjobs_leav_rept_method%TYPE,
      par_nbrjobs_pict_code_leav IN nbrjobs.nbrjobs_pict_code_leav_rept%TYPE,
      par_msg OUT VARCHAR2)
IS
--
-- FILE NAME..: nopijbs.sql
-- RELEASE....: 6.0
-- OBJECT NAME: P_INS_NBRJOBS_REC
-- PRODUCT....: POSNCTL
-- USAGE......: Insert detail job assignment records,NBRJOBS, for a job.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure inserts detail job assignment records,NBRJOBS, for a job.
--
-- DESCRIPTION END
--
BEGIN
   par_msg := NULL;
--
   INSERT INTO nbrjobs (
      NBRJOBS_PIDM,
      NBRJOBS_POSN,
      NBRJOBS_SUFF ,
      NBRJOBS_EFFECTIVE_DATE,
      NBRJOBS_STATUS,
      NBRJOBS_DESC,
      NBRJOBS_ECLS_CODE,
      NBRJOBS_PICT_CODE,
      NBRJOBS_COAS_CODE_TS,
      NBRJOBS_ORGN_CODE_TS,
      NBRJOBS_SAL_TABLE,
      NBRJOBS_SAL_GRADE,
      NBRJOBS_SAL_STEP,
      NBRJOBS_APPT_PCT,
      NBRJOBS_FTE,
      NBRJOBS_HRS_DAY,
      NBRJOBS_HRS_PAY,
      NBRJOBS_SHIFT,
      NBRJOBS_REG_RATE,
      NBRJOBS_ASSGN_SALARY,
      NBRJOBS_FACTOR,
      NBRJOBS_ANN_SALARY,
      NBRJOBS_PER_PAY_SALARY,
      NBRJOBS_PAYS,
      NBRJOBS_PER_PAY_DEFER_AMT,
      NBRJOBS_ACTIVITY_DATE,
      NBRJOBS_JCRE_CODE,
      NBRJOBS_SGRP_CODE,
      NBRJOBS_EMPR_CODE,
      NBRJOBS_LGCD_CODE,
      NBRJOBS_LOCN_CODE,
      NBRJOBS_SCHL_CODE,
      NBRJOBS_SUPERVISOR_PIDM,
      NBRJOBS_SUPERVISOR_POSN,
      NBRJOBS_SUPERVISOR_SUFF,
      NBRJOBS_WKCP_CODE,
      NBRJOBS_JBLN_CODE,
      NBRJOBS_PERS_CHG_DATE,
      NBRJOBS_PCAT_CODE,
      NBRJOBS_DFPR_CODE,
      NBRJOBS_ENCUMBRANCE_HRS,
      NBRJOBS_CONTRACT_NO,
      NBRJOBS_STRS_ASSN_CODE,
      NBRJOBS_STRS_PAY_CODE,
      NBRJOBS_PERS_PAY_CODE,
      NBRJOBS_TIME_ENTRY_METHOD,
      NBRJOBS_TIME_ENTRY_TYPE,
      NBRJOBS_TIME_IN_OUT_IND,
      NBRJOBS_LCAT_CODE,
      NBRJOBS_LEAV_REPT_METHOD,
      NBRJOBS_PICT_CODE_LEAV_REPT)
   VALUES
     (par_nbrjobs_pidm,
      par_nbrjobs_posn,
      par_nbrjobs_suff,
      par_nbrjobs_effective_date,
      par_nbrjobs_status,
      par_nbrjobs_desc,
      par_nbrjobs_ecls_code,
      par_nbrjobs_pict_code,
      par_nbrjobs_coas_code_ts,
      par_nbrjobs_orgn_code_ts,
      par_nbrjobs_sal_table,
      par_nbrjobs_sal_grade,
      par_nbrjobs_sal_step,
      par_nbrjobs_appt_pct,
      par_nbrjobs_fte,
      par_nbrjobs_hrs_day,
      par_nbrjobs_hrs_pay,
      par_nbrjobs_shift,
      par_nbrjobs_reg_rate,
      par_nbrjobs_assgn_salary,
      par_nbrjobs_factor,
      par_nbrjobs_ann_salary,
      par_nbrjobs_per_pay_salary,
      par_nbrjobs_pays,
      par_nbrjobs_per_pay_defer_amt,
      SYSDATE,
      par_nbrjobs_jcre_code,
      par_nbrjobs_sgrp_code,
      par_nbrjobs_empr_code,
      par_nbrjobs_lgcd_code,
      par_nbrjobs_locn_code,
      par_nbrjobs_schl_code,
      par_nbrjobs_supervisor_pidm,
      par_nbrjobs_supervisor_posn,
      par_nbrjobs_supervisor_suff,
      par_nbrjobs_wkcp_code,
      par_nbrjobs_jbln_code,
      par_nbrjobs_pers_chg_date,
      par_nbrjobs_pcat_code,
      par_nbrjobs_dfpr_code,
      par_nbrjobs_encumbrance_hrs,
      par_nbrjobs_contract_no,
      par_nbrjobs_strs_assn_code,
      par_nbrjobs_strs_pay_code,
      par_nbrjobs_pers_pay_code,
      par_nbrjobs_time_entry_method,
      par_nbrjobs_time_entry_type,
      par_nbrjobs_time_in_out_ind,
      par_nbrjobs_lcat_code,
      par_nbrjobs_leav_rept_method,
      par_nbrjobs_pict_code_leav);
   EXCEPTION
   WHEN OTHERS THEN
      par_msg := '*ERROR* Unable to insert nbrjobs record (Oracle Error ' ||
                 TO_CHAR(SQLCODE) || ').';
END;
/


DROP PUBLIC SYNONYM P_INS_NBRJOBS_REC;

CREATE PUBLIC SYNONYM P_INS_NBRJOBS_REC FOR BANINST1.P_INS_NBRJOBS_REC;


GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO BANIMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO GENERAL;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO SATURN;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_INS_NBRJOBS_REC TO WTAILOR;
DROP PROCEDURE BANINST1.PK_CREACONTATO_DOCUMENTO;

CREATE OR REPLACE PROCEDURE BANINST1.pk_CreaContato_Documento is
/******************************************************************************
Nombre de Script:   pk_CreaContato_Documento
Objetivo:           Crea el contrato y sus documentos por  N $.
Autor:              Roman Ruiz
Fecha:              10-dic-2013
******************************************************************************/

/*AGREGAMOS $ A DOCUMENTO */

    vnNumTran       TBRACCD.TBRACCD_TRAN_NUMBER%TYPE;
    vnNumSeqDoc     TWBDOCU.TWBDOCU_SEQ_NUM%TYPE;
    vsCuenta        TWVACNT.TWVACNT_ACCOUNT%TYPE;
    vsCCosto        TWVCCTS.TWVCCTS_CODE%TYPE;
    vsPrograma      SGBSTDN.SGBSTDN_PROGRAM_1%TYPE;
    vsRes           VARCHAR2(1);
    vsMsg           VARCHAR2(4000);
    vsPIDM          NUMBER(8);
    vsPeriodo       VARCHAR2(6);
    vsContrato      VARCHAR2(10);
    viLargo         number(4);
    ciContrato      number(2);
    viSalva         number(4);

BEGIN
   vsPIDM:= null;
   vsPeriodo:='201075';   -- AQUI VA EL PERIODO
   vsContrato := null;
   vnNumTran := NULL;
   vnNumSeqDoc := NULL;
   vsCuenta := '';
   vsCCosto := '';
   vsRes := '';
   vsMsg := '';
   vsPrograma := null;
   viLargo := 0;
   ciContrato := 10;  --log max de un contato
   viSalva    := 0;

   for curMoroso in (select distinct TWRCLMR_CONTRACT, TWRCLMR_CCTS_CODE, TWRCLMR_RUT_ALUM , TWRCLMR_RUT_APO
                     from TWRCLMR ) loop
                   --  where   TWRCLMR_CONTRACT =  '102849-9') loop   --debug..

      viSalva := viSalva + 1;

      for curPers in (select SPBPERS_PIDM from spbpers
                      where spbpers_name_suffix = curMoroso.TWRCLMR_RUT_ALUM) loop

          vsPIDM := curPers.SPBPERS_PIDM;

          vsContrato := curMoroso.TWRCLMR_CONTRACT;

          select length( vsContrato) into viLargo  from dual;

          if viLargo > 3 then
             viLargo := viLargo +1;
          end if;

          FOR Lcntr IN viLargo..ciContrato  LOOP

              vsContrato := '0'||vsContrato;

          END LOOP;


          -- programa
          for curProg in (select SGBSTDN_PROGRAM_1
                          from sgbstdn
                          where SGBSTDN_PIDM = vsPIDM
                          and SGBSTDN_TERM_CODE_EFF = (select max( sdnt.SGBSTDN_TERM_CODE_EFF)
                                                      from sgbstdn sdnt
                                                      where sdnt.SGBSTDN_PIDM = vsPIDM)) loop

              vsPrograma := curProg.SGBSTDN_PROGRAM_1;

          end loop; -- end programa

          if vsPrograma is null then
             exit;
          end if;

          -- inserta contrato..
          INSERT INTO TWBCNTR VALUES (vsPIDM,     vsContrato,
                                      vsPeriodo,  curMoroso.TWRCLMR_RUT_APO,
                                      SYSDATE,    'A',
                                      SYSDATE,    'BANSECR',
                                      vsPrograma,  null,
									  'BANSECR',  null,
									  null,     null,
									  null,     null);

          -- documentos a insertar
          for curDoctos in (select * from TWRCLMR
                            where  TWRCLMR_CONTRACT = curMoroso.TWRCLMR_CONTRACT) loop

              vnNumSeqDoc := pk_Matricula.f_InsDocAuto(vsPIDM
                                                      ,vsPeriodo
                                                      ,'CUP'
                                                      ,curDoctos.TWRCLMR_AMOUNT
                                                      ,'AC'
                                                      ,curDoctos.TWRCLMR_CANCEL_DATE );

              UPDATE TWBDOCU SET  TWBDOCU_CNTR_NUM = vsContrato
              WHERE TWBDOCU_SEQ_NUM = vnNumSeqDoc;

              commit;

              --Creo la transaccion en TBRACCD
              vnNumTran := pk_Matricula.f_InsertaCargo(vsPIDM
                                                       ,curDoctos.TWRCLMR_AMOUNT
                                                       ,'MGAR'
                                                       ,vsPeriodo
                                                       ,'T'
                                                       ,USER );

              commit;
              --Creo TWRDOTR
              pk_Matricula.p_insTranDocu(vsPIDM
                                       ,vnNumTran
                                       ,vnNumSeqDoc
                                       ,curDoctos.TWRCLMR_AMOUNT
                                       ,'Y'
                                       ,SYSDATE
                                       ,NULL);

               commit;
               -- inserto encabezado en cotabilidad para no generar contabilizacin
               insert into TWRADMV values (vnNumSeqDoc
                                          ,1 --,vnNumTran
                                          ,curDoctos.TWRCLMR_AMOUNT
                                          ,curDoctos.TWRCLMR_ACCOUNT
                                          ,curDoctos.TWRCLMR_CCTS_CODE
                                          ,'Y'
                                          ,sysdate
                                          ,'banner');

                commit;
                -- actualizo info en tabla principal del proceso

                update TWRCLMR set  TWRCLMR_DOCU_SEQ_NUM = vnNumSeqDoc , TWRCLMR_MOVE_NUM = vnNumTran
                 where TWRCLMR_CONTRACT = curMoroso.TWRCLMR_CONTRACT
                 and  TWRCLMR_ACCOUNT   = curDoctos.TWRCLMR_ACCOUNT
                 and  TWRCLMR_AMOUNT    = curDoctos.TWRCLMR_AMOUNT;

                 commit;
          end loop; -- doctos

      end loop; -- for pers

      if viSalva = 500 then
         commit;
         viSalva := 0;
      end if;

   end loop;  -- for pricipal

   COMMIT;

END   pk_CreaContato_Documento;
/
DROP PROCEDURE BANINST1.P_LSTCROSS;

CREATE OR REPLACE PROCEDURE BANINST1.P_LSTCROSS(psTerm           VARCHAR2,
                                                  psListaCruzada   VARCHAR2,
                                                  psCrnMaster      VARCHAR2,
                                                                             psError      OUT VARCHAR2
                                                                             ) IS

  /*

        Modulo: Programacin acadmica
    Modificado: 04/06/2009
                GEPC
                * Work Order 101052
                  La aplicacin esta reportando un error y no se esta manejando correctamente

  */

  -- Cursor para traer los crn Simultaneos de la lista cruzada para el periodo dado
  CURSOR cuLista(psTermCode   VARCHAR2 DEFAULT NULL,
                          psListaCross VARCHAR2 DEFAULT NULL ) IS
            SELECT SSRXLST_CRN CrnSimult
           FROM SSRXLST, SWRXLST
          WHERE SWRXLST_TERM_CODE  = SSRXLST_TERM_CODE
            AND SWRXLST_XLST_GROUP = SSRXLST_XLST_GROUP
            AND SWRXLST_CRN        = SSRXLST_CRN
            AND SSRXLST_TERM_CODE  = psTermCode
            AND SSRXLST_XLST_GROUP = psListaCross
            AND SWRXLST_TYPE       = 'S'
             UNION ALL     -- Esto se realiza porque no necesariamente los simultneos estn en la tabla SWRXLST *** --
         SELECT SSRXLST_CRN
           FROM SSRXLST
          WHERE SSRXLST_TERM_CODE  = psTermCode
            AND SSRXLST_XLST_GROUP = psListaCross
            AND SSRXLST_CRN NOT IN (SELECT SWRXLST_CRN
                                      FROM SWRXLST
                                   );

  -- Cursor para traer toda la informacin de SSRMEET del Crn Master
  CURSOR cuSesiones(psTermCode     VARCHAR2 DEFAULT NULL,
                             psCrn          VARCHAR2 DEFAULT NULL ) IS
         SELECT SSRMEET_TERM_CODE       TermCode,
                   SSRMEET_CRN             Crn,
                         SSRMEET_DAYS_CODE       Days,
                SSRMEET_DAY_NUMBER      Day,
                SSRMEET_BEGIN_TIME      BeginTime,
                SSRMEET_END_TIME        EndTime,
                SSRMEET_BLDG_CODE       Bldg,
                SSRMEET_ROOM_CODE       Room,
                SSRMEET_ACTIVITY_DATE   Activity,
                SSRMEET_START_DATE      StarDate,
                SSRMEET_END_DATE        EndDate,
                SSRMEET_CATAGORY        Catagory,
                SSRMEET_SUN_DAY         Sun,
                SSRMEET_MON_DAY         Monday,
                SSRMEET_TUE_DAY         Tue,
                SSRMEET_WED_DAY         Wed,
                SSRMEET_THU_DAY         Thu,
                SSRMEET_FRI_DAY         Fri,
                SSRMEET_SAT_DAY         Sat,
                SSRMEET_SCHD_CODE       Schd,
                SSRMEET_OVER_RIDE       Over,
                SSRMEET_CREDIT_HR_SESS  Credit,
                SSRMEET_MEET_NO         Meet,
                SSRMEET_HRS_WEEK        Hrs,
                SSRMEET_FUNC_CODE       Func,
                SSRMEET_COMT_CODE       Comt,
                SSRMEET_SCHS_CODE       Schs,
                SSRMEET_MTYP_CODE       Mtyp
           FROM SSRMEET
          WHERE SSRMEET_TERM_CODE = psTermCode
            AND SSRMEET_CRN       = psCrn;

  -- Cursor para traer toda la informacin de SIRASGN del Crn Master
  CURSOR cuProfesor(psTermCode     VARCHAR2 DEFAULT NULL,
                             psCrn          VARCHAR2 DEFAULT NULL ) IS
            SELECT SIRASGN_TERM_CODE           TermCode,
                   SIRASGN_CRN                 Crn,
                SIRASGN_PIDM                Pidm,
                SIRASGN_CATEGORY            Category,
                SIRASGN_PERCENT_RESPONSE    Percent,
                SIRASGN_WORKLOAD_ADJUST     Workload,
                SIRASGN_PERCENT_SESS        PerSess,
                SIRASGN_PRIMARY_IND         PrimarInd,
                SIRASGN_OVER_RIDE           Over,
                SIRASGN_POSITION            Position,
                SIRASGN_ACTIVITY_DATE       Activity,
                SIRASGN_FCNT_CODE           Fcnt,
                SIRASGN_POSN                Posn,
                SIRASGN_SUFF                Suff,
                SIRASGN_ASTY_CODE           Asty
           FROM SIRASGN
          WHERE SIRASGN_TERM_CODE = psTermCode
            AND SIRASGN_CRN       = psCrn;

  BEGIN
      -- Abrir el cursor y para cada Crn borrar e insertar los registros
      FOR regLista IN cuLista(psTerm,psListaCruzada) LOOP
          -- 1. Borrar SSRMEET para el crn Simultaneo
          BEGIN
              DELETE SSRMEET
               WHERE SSRMEET_TERM_CODE = psTerm
                 AND SSRMEET_CRN       = regLista.CrnSimult;
          EXCEPTION
              WHEN OTHERS THEN
                   psError := SQLERRM;

                   RETURN;
          END;

          BEGIN
              DELETE SIRASGN
               WHERE SIRASGN_TERM_CODE = psTerm
                 AND SIRASGN_CRN       = regLista.CrnSimult;
          EXCEPTION
              WHEN OTHERS THEN
                   psError := SQLERRM;

                   RETURN;
          END;

             -- 3.Insertar sesiones para el crn Simultaneo a partir del crn Master
             -- Abrir el cursor del CrnMaster para insertar los registros de Sesiones para el Crn Simultaneo
          FOR regSesion IN cuSesiones(psTerm,psCrnMaster) LOOP
              BEGIN
                  INSERT INTO SSRMEET (SSRMEET_TERM_CODE,      SSRMEET_CRN,        SSRMEET_DAYS_CODE,
                                             SSRMEET_DAY_NUMBER,     SSRMEET_BEGIN_TIME, SSRMEET_END_TIME,
                                       SSRMEET_BLDG_CODE,      SSRMEET_ROOM_CODE,  SSRMEET_ACTIVITY_DATE,
                                       SSRMEET_START_DATE,     SSRMEET_END_DATE,   SSRMEET_CATAGORY,
                                       SSRMEET_SUN_DAY,        SSRMEET_MON_DAY,    SSRMEET_TUE_DAY,
                                       SSRMEET_WED_DAY,        SSRMEET_THU_DAY,    SSRMEET_FRI_DAY,
                                       SSRMEET_SAT_DAY,        SSRMEET_SCHD_CODE,  SSRMEET_OVER_RIDE,
                                       SSRMEET_CREDIT_HR_SESS, SSRMEET_MEET_NO,    SSRMEET_HRS_WEEK,
                                       SSRMEET_FUNC_CODE,      SSRMEET_COMT_CODE,  SSRMEET_SCHS_CODE,
                                       SSRMEET_MTYP_CODE)
                                      VALUES(regSesion.TermCode, regLista.CrnSimult,  regSesion.Days,
                                                         regSesion.Day,      regSesion.BeginTime, regSesion.EndTime,
                                       regSesion.Bldg,     regSesion.Room,      regSesion.Activity,
                                       regSesion.StarDate, regSesion.EndDate,   regSesion.Catagory,
                                       regSesion.Sun,      regSesion.Monday,    regSesion.Tue,
                                       regSesion.Wed,      regSesion.Thu,       regSesion.Fri,
                                       regSesion.Sat,      regSesion.Schd,      regSesion.Over,
                                       regSesion.Credit,   regSesion.Meet,      regSesion.Hrs,
                                       regSesion.Func,     regSesion.Comt,      regSesion.Schs,
                                       regSesion.Mtyp);
              EXCEPTION
                  WHEN DUP_VAL_ON_INDEX THEN
                       psError := SQLERRM;

                       RETURN;
                  WHEN OTHERS THEN
                             psError := SQLERRM;

                       RETURN;

                 END;
          END LOOP;

          -- 4. Insertar profesor para el crn Simultneo a partir del crn Master
          -- Abrir el cursor del CrnMaster para insertar los registros de Profesores para el Crn Simultaneo
          FOR regProf IN cuProfesor(psTerm,psCrnMaster) LOOP
              BEGIN
                  INSERT INTO SIRASGN(SIRASGN_TERM_CODE,    SIRASGN_CRN,              SIRASGN_PIDM,
                                               SIRASGN_CATEGORY,     SIRASGN_PERCENT_RESPONSE, SIRASGN_WORKLOAD_ADJUST,
                                                              SIRASGN_PERCENT_SESS, SIRASGN_PRIMARY_IND,      SIRASGN_OVER_RIDE,
                                                              SIRASGN_POSITION,     SIRASGN_ACTIVITY_DATE,    SIRASGN_FCNT_CODE,
                                                              SIRASGN_POSN,         SIRASGN_SUFF,             SIRASGN_ASTY_CODE)
                                  VALUES(regProf.TermCode,     regLista.CrnSimult,       regProf.Pidm,
                                                        regProf.Category,     0,                                 regProf.Workload,
                                                              0,                             regProf.PrimarInd,        'O',
                                                              regProf.Position,     regProf.Activity,         regProf.Fcnt,
                                                              regProf.Posn,         regProf.Suff,             regProf.Asty  );
                    EXCEPTION
                  WHEN OTHERS THEN
                             psError := SQLERRM;

                       RETURN;
                 END;
          END LOOP;
      END LOOP;

      COMMIT;

        EXCEPTION
      WHEN OTHERS THEN
                 psError := SQLERRM;

           RETURN;
  END P_LSTCROSS;
/
DROP PROCEDURE BANINST1.P_MESS_REMINDER;

CREATE OR REPLACE PROCEDURE BANINST1.p_mess_reminder as
--
err_code		NUMBER		:= 0;
err_msg			VARCHAR2(512)	:= NULL;
REMAINDER_MSG		VARCHAR2(100)	:= NULL;
WORK_CODE		VARCHAR2(16)	:= NULL;
WORK_EVNT_CODE		VARCHAR2(6)	:= NULL;
WORK_EVNT_SEQ_NUM	NUMBER(3)	:= 0;
WORK_USER_ID 		VARCHAR2(30)	:= NULL;
WORK_ERROR_MSG1		VARCHAR2(100)	:= NULL;
WORK_ERROR_MSG2		VARCHAR2(100)	:= NULL;
WORK_IDEN_CODE		VARCHAR2(5)	:= NULL;
--
-- FILE NAME..: frpmess.sql
-- RELEASE....: 7.0
-- OBJECT NAME: P_MESS_REMINDER
-- PRODUCT....: FINANCE
-- USAGE......: Creates messages for Event Managemen Process
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This stored procedure creates messages for Event Managemen Process
--
-- DESCRIPTION END
--
--
    CURSOR GRNT_BEFORE_CSR IS
	SELECT distinct f_get_pms_code(FRREVNG_GRNT_CODE) as frrevng_grnt_code,
                 	FRREVNG_EVNT_CODE,
	        	FRREVNG_SEQ_NUM,
        		FRREVNG_RESPONSIBLE_USER_ID,
        		TRUNC(FRREVNG_DUE_DATE) - TRUNC(SYSDATE) DAYSNUM
	FROM FRREVNG, FRBEVNG
	WHERE FRREVNG_GRNT_CODE = FRBEVNG_GRNT_CODE
	  AND FRREVNG_EVNT_CODE = FRBEVNG_EVNT_CODE
	  AND TRUNC(FRREVNG_DUE_DATE) > TRUNC(SYSDATE)
	  AND TRUNC(FRREVNG_DUE_DATE) - TRUNC(SYSDATE) <=
			FRBEVNG_NUM_OF_DAYS_REMINDER
	  AND FRBEVNG_NUM_OF_DAYS_REMINDER IS NOT NULL
	  AND FRREVNG_STATUS_IND='P'
	ORDER BY 1,
                 FRREVNG_EVNT_CODE, FRREVNG_SEQ_NUM;
--
    CURSOR GRNT_EQUAL_CSR IS
	SELECT distinct f_get_pms_code(FRREVNG_GRNT_CODE) as frrevng_grnt_code,
		FRREVNG_EVNT_CODE,
		FRREVNG_SEQ_NUM,
		FRREVNG_RESPONSIBLE_USER_ID
	FROM FRREVNG, FRBEVNG
	WHERE FRREVNG_GRNT_CODE = FRBEVNG_GRNT_CODE
	  AND FRREVNG_EVNT_CODE = FRBEVNG_EVNT_CODE
	  AND TRUNC(FRREVNG_DUE_DATE) = TRUNC(SYSDATE)
	  AND FRREVNG_STATUS_IND='P'
	ORDER BY 1,
                 FRREVNG_EVNT_CODE, FRREVNG_SEQ_NUM;
--
    CURSOR GRNT_OVER_CSR IS
	SELECT distinct f_get_pms_code(FRREVNG_GRNT_CODE) as frrevng_grnt_code,
		FRREVNG_EVNT_CODE,
		FRREVNG_SEQ_NUM,
		FRREVNG_RESPONSIBLE_USER_ID,
		TRUNC(SYSDATE) - TRUNC(FRREVNG_DUE_DATE) DAYSNUM
	FROM FRREVNG, FRBEVNG
	WHERE FRREVNG_GRNT_CODE = FRBEVNG_GRNT_CODE
	  AND FRREVNG_EVNT_CODE = FRBEVNG_EVNT_CODE
	  AND TRUNC(FRREVNG_DUE_DATE) < TRUNC(SYSDATE)
	  AND FRREVNG_STATUS_IND='P'
	ORDER BY 1,
                 FRREVNG_EVNT_CODE, FRREVNG_SEQ_NUM;
--
    CURSOR PROP_BEFORE_CSR IS
	SELECT 	FRREVNP_PROP_CODE,
		FRREVNP_EVNT_CODE,
		FRREVNP_SEQ_NUM,
		FRREVNP_RESPONSIBLE_USER_ID,
		TRUNC(FRREVNP_DUE_DATE) - TRUNC(SYSDATE) DAYSNUM
	FROM FRREVNP, FRBEVNP
	WHERE FRREVNP_PROP_CODE = FRBEVNP_PROP_CODE
	  AND FRREVNP_EVNT_CODE = FRBEVNP_EVNT_CODE
	  AND TRUNC(FRREVNP_DUE_DATE) > TRUNC(SYSDATE)
	  AND TRUNC(FRREVNP_DUE_DATE) - TRUNC(SYSDATE) <=
			FRBEVNP_NUM_OF_DAYS_REMINDER
	  AND FRBEVNP_NUM_OF_DAYS_REMINDER IS NOT NULL
	  AND FRREVNP_STATUS_IND='P'
	ORDER BY FRREVNP_PROP_CODE, FRREVNP_EVNT_CODE, FRREVNP_SEQ_NUM;
--
    CURSOR PROP_EQUAL_CSR IS
	SELECT 	FRREVNP_PROP_CODE,
		FRREVNP_EVNT_CODE,
		FRREVNP_SEQ_NUM,
		FRREVNP_RESPONSIBLE_USER_ID
	FROM FRREVNP, FRBEVNP
	WHERE FRREVNP_PROP_CODE = FRBEVNP_PROP_CODE
	  AND FRREVNP_EVNT_CODE = FRBEVNP_EVNT_CODE
	  AND TRUNC(FRREVNP_DUE_DATE) = TRUNC(SYSDATE)
	  AND FRREVNP_STATUS_IND='P'
	ORDER BY FRREVNP_PROP_CODE, FRREVNP_EVNT_CODE, FRREVNP_SEQ_NUM;
--
    CURSOR PROP_OVER_CSR IS
	SELECT 	FRREVNP_PROP_CODE,
		FRREVNP_EVNT_CODE,
		FRREVNP_SEQ_NUM,
		FRREVNP_RESPONSIBLE_USER_ID,
		TRUNC(SYSDATE) - TRUNC(FRREVNP_DUE_DATE) DAYSNUM
	FROM FRREVNP, FRBEVNP
	WHERE FRREVNP_PROP_CODE = FRBEVNP_PROP_CODE
	  AND FRREVNP_EVNT_CODE = FRBEVNP_EVNT_CODE
	  AND TRUNC(FRREVNP_DUE_DATE) < TRUNC(SYSDATE)
	  AND FRREVNP_STATUS_IND='P'
	ORDER BY FRREVNP_PROP_CODE, FRREVNP_EVNT_CODE, FRREVNP_SEQ_NUM;
--
    CURSOR GRNT_PROXY_CSR IS
	SELECT FRRPRXG_PROXY_USER_ID
	FROM FRRPRXG
	WHERE f_get_pms_code(FRRPRXG_GRNT_CODE) = WORK_CODE
	  AND FRRPRXG_EVNT_CODE    = WORK_EVNT_CODE
	  AND FRRPRXG_EVNT_SEQ_NUM = WORK_EVNT_SEQ_NUM;
--
    CURSOR PROP_PROXY_CSR IS
	SELECT FRRPRXP_PROXY_USER_ID
	FROM FRRPRXP
	WHERE FRRPRXP_PROP_CODE    = WORK_CODE
	  AND FRRPRXP_EVNT_CODE    = WORK_EVNT_CODE
	  AND FRRPRXP_EVNT_SEQ_NUM = WORK_EVNT_SEQ_NUM;
--
    PROCEDURE INSERT_GURTKLR
	    (WORK_USER_ID 	IN VARCHAR2,
	     WORK_ERROR_MSG1 	IN VARCHAR2,
	     WORK_ERROR_MSG2 	IN VARCHAR2,
	     REMAINDER_MSG	IN VARCHAR2,
	     WORK_CODE		IN VARCHAR2,
	     WORK_EVNT_CODE	IN VARCHAR2,
	     WORK_IDEN_CODE	IN VARCHAR2)
    IS
--
	MAXSEQNO		NUMBER(3)	:= 0;
--
	BEGIN
	     BEGIN
		SELECT NVL(MAX(GURTKLR_SEQNO), 0)
		  INTO MAXSEQNO
		  FROM GURTKLR
		  WHERE GURTKLR_USER_ID = WORK_USER_ID
		    AND TRUNC(GURTKLR_TODO_DATE) = TRUNC(SYSDATE);
	     EXCEPTION
	       WHEN OTHERS
	       THEN
		  ROLLBACK;
	     END;
--
	     BEGIN

		INSERT INTO GURTKLR
		  ( GURTKLR_USER_ID,
		    GURTKLR_TODO_DATE,
		    GURTKLR_CREATOR,
		    GURTKLR_SEQNO,
		    GURTKLR_STATUS,
		    GURTKLR_SYSTEM_IND,
		    GURTKLR_COMMENT,
		    GURTKLR_ACTIVITY_DATE,
		    GURTKLR_SOURCE,
		    GURTKLR_IDEN_CODE,
		    GURTKLR_ITEM_REFNO )
		VALUES
		  ( WORK_USER_ID,
		    TRUNC (SYSDATE),
		    USER,
		    MAXSEQNO + 1,
		    'P',
		    'F',
		    REMAINDER_MSG,
		    TRUNC (SYSDATE),
		    WORK_EVNT_CODE,
		    WORK_IDEN_CODE,
		    SUBSTR(WORK_CODE,1,15)
		    );
	     EXCEPTION
	       WHEN OTHERS
	       THEN
		 ROLLBACK;
	     END;
	END;
--
BEGIN
--
	BEGIN
		DELETE FROM GURTKLR
		 WHERE GURTKLR_IDEN_CODE = 'PROP'
		    OR GURTKLR_IDEN_CODE = 'GRNT';
	EXCEPTION
	  WHEN OTHERS
	  THEN ROLLBACK;
	END;
--
	FOR GRNT_OVER IN GRNT_OVER_CSR LOOP
--
	   WORK_CODE       	:= GRNT_OVER.FRREVNG_GRNT_CODE;
	   WORK_EVNT_CODE  	:= GRNT_OVER.FRREVNG_EVNT_CODE;
	   WORK_USER_ID		:= GRNT_OVER.FRREVNG_RESPONSIBLE_USER_ID;
	   WORK_ERROR_MSG1 	:=  G$_NLS.Get('FRPMESS-0002', 'SQL',' GURTKLR Select MAXSEQNO error from GRNT_OVER_CSR') ;
	   WORK_ERROR_MSG2	:=  G$_NLS.Get('FRPMESS-0003', 'SQL',' GURTKLR Responsible-User Insert error from GRNT_OVER_CSR') ;
	   WORK_IDEN_CODE	:= 'GRNT';

	   IF GRNT_OVER.DAYSNUM = 1 THEN
		  REMAINDER_MSG	:= TO_CHAR(GRNT_OVER.DAYSNUM,'999')||' day past since the event has been due. RESPONSIBLE USER';
	   ELSE
		  REMAINDER_MSG	:= TO_CHAR(GRNT_OVER.DAYSNUM,'999')||' days past since the event has been due. RESPONSIBLE USER';
	   END IF;
--
		INSERT_GURTKLR (WORK_USER_ID,
				WORK_ERROR_MSG1,
				WORK_ERROR_MSG2,
				REMAINDER_MSG,
				SUBSTR(WORK_CODE,1,15),
				WORK_EVNT_CODE,
				WORK_IDEN_CODE);
--
	   WORK_CODE         := GRNT_OVER.FRREVNG_GRNT_CODE;
	   WORK_EVNT_CODE    := GRNT_OVER.FRREVNG_EVNT_CODE;
	   WORK_EVNT_SEQ_NUM := GRNT_OVER.FRREVNG_SEQ_NUM;
--
	   FOR GRNT_PROXY IN GRNT_PROXY_CSR LOOP
--
		WORK_USER_ID	:= GRNT_PROXY.FRRPRXG_PROXY_USER_ID;
		WORK_ERROR_MSG1	:=  G$_NLS.Get('FRPMESS-0005', 'SQL',' GURTKLR Select MAXSEQNO error from GRNT_OVER_CSR') ;
		WORK_ERROR_MSG2	:=  G$_NLS.Get('FRPMESS-0006', 'SQL',' GURTKLR Proxy Insert error from GRNT_PROXY_CSR') ;
		WORK_IDEN_CODE	:= 'GRNT';

		IF GRNT_OVER.DAYSNUM = 1 THEN
		  REMAINDER_MSG	:= TO_CHAR(GRNT_OVER.DAYSNUM,'999')||' day past since the event has been due. PROXY';
		ELSE
		  REMAINDER_MSG	:= TO_CHAR(GRNT_OVER.DAYSNUM,'999')||' days past since the event has been due. PROXY';
		END IF;
--
		INSERT_GURTKLR (WORK_USER_ID,
				WORK_ERROR_MSG1,
				WORK_ERROR_MSG2,
				REMAINDER_MSG,
				SUBSTR(WORK_CODE,1,15),
				WORK_EVNT_CODE,
				WORK_IDEN_CODE);
	   END LOOP;
	END LOOP;
	COMMIT;
--
	FOR GRNT_EQUAL IN GRNT_EQUAL_CSR LOOP
--
	   WORK_CODE       	:= GRNT_EQUAL.FRREVNG_GRNT_CODE;
	   WORK_EVNT_CODE  	:= GRNT_EQUAL.FRREVNG_EVNT_CODE;
	   WORK_USER_ID		:= GRNT_EQUAL.FRREVNG_RESPONSIBLE_USER_ID;
	   WORK_ERROR_MSG1 	:=  G$_NLS.Get('FRPMESS-0008', 'SQL',' GURTKLR Select MAXSEQNO error from GRNT_EQUAL_CSR') ;
	   WORK_ERROR_MSG2	:=  G$_NLS.Get('FRPMESS-0009', 'SQL',' GURTKLR Responsible-User Insert error from GRNT_EQUAL_CSR') ;
	   WORK_IDEN_CODE		:= 'GRNT';
	   REMAINDER_MSG		:= ' The event is due today. RESPONSIBLE USER';
--
		INSERT_GURTKLR (WORK_USER_ID,
				WORK_ERROR_MSG1,
				WORK_ERROR_MSG2,
				REMAINDER_MSG,
				SUBSTR(WORK_CODE,1,15),
				WORK_EVNT_CODE,
				WORK_IDEN_CODE);
--
	   WORK_CODE         := GRNT_EQUAL.FRREVNG_GRNT_CODE;
	   WORK_EVNT_CODE    := GRNT_EQUAL.FRREVNG_EVNT_CODE;
	   WORK_EVNT_SEQ_NUM := GRNT_EQUAL.FRREVNG_SEQ_NUM;
--
	   FOR GRNT_PROXY IN GRNT_PROXY_CSR LOOP
--
		WORK_USER_ID	:= GRNT_PROXY.FRRPRXG_PROXY_USER_ID;
		WORK_ERROR_MSG1	:=  G$_NLS.Get('FRPMESS-0011', 'SQL',' GURTKLR Select MAXSEQNO error from GRNT_EQUAL_CSR') ;
		WORK_ERROR_MSG2	:=  G$_NLS.Get('FRPMESS-0012', 'SQL',' GURTKLR Proxy Insert error from GRNT_PROXY_CSR') ;
		WORK_IDEN_CODE	:= 'GRNT';
		REMAINDER_MSG	:= ' The event is due today. PROXY';
--
		INSERT_GURTKLR (WORK_USER_ID,
				WORK_ERROR_MSG1,
				WORK_ERROR_MSG2,
				REMAINDER_MSG,
				SUBSTR(WORK_CODE,1,15),
				WORK_EVNT_CODE,
				WORK_IDEN_CODE);
	   END LOOP;
	END LOOP;
	COMMIT;
--
	FOR GRNT_BEFORE IN GRNT_BEFORE_CSR LOOP
--
	   WORK_CODE       	:= GRNT_BEFORE.FRREVNG_GRNT_CODE;
	   WORK_EVNT_CODE  	:= GRNT_BEFORE.FRREVNG_EVNT_CODE;
	   WORK_USER_ID		:= GRNT_BEFORE.FRREVNG_RESPONSIBLE_USER_ID;
	   WORK_ERROR_MSG1 	:=  G$_NLS.Get('FRPMESS-0014', 'SQL',' GURTKLR Select MAXSEQNO error from GRNT_BEFORE_CSR') ;
	   WORK_ERROR_MSG2	:=  G$_NLS.Get('FRPMESS-0015', 'SQL',' GURTKLR Responsible-User Insert error from GRNT_BEFORE_CSR') ;
	   WORK_IDEN_CODE	:= 'GRNT';

	   IF GRNT_BEFORE.DAYSNUM = 1 THEN
		  REMAINDER_MSG	:= TO_CHAR(GRNT_BEFORE.DAYSNUM,'999')||' day left. RESPONSIBLE USER';
	   ELSE
		  REMAINDER_MSG	:= TO_CHAR(GRNT_BEFORE.DAYSNUM,'999')||' days left. RESPONSIBLE USER';
	   END IF;
--
		INSERT_GURTKLR (WORK_USER_ID,
				WORK_ERROR_MSG1,
				WORK_ERROR_MSG2,
				REMAINDER_MSG,
				SUBSTR(WORK_CODE,1,15),
				WORK_EVNT_CODE,
				WORK_IDEN_CODE);
--
	   WORK_CODE         := GRNT_BEFORE.FRREVNG_GRNT_CODE;
	   WORK_EVNT_CODE    := GRNT_BEFORE.FRREVNG_EVNT_CODE;
	   WORK_EVNT_SEQ_NUM := GRNT_BEFORE.FRREVNG_SEQ_NUM;
--
	   FOR GRNT_PROXY IN GRNT_PROXY_CSR LOOP
--
		WORK_USER_ID	:= GRNT_PROXY.FRRPRXG_PROXY_USER_ID;
		WORK_ERROR_MSG1	:=  G$_NLS.Get('FRPMESS-0017', 'SQL',' GURTKLR Select MAXSEQNO error from GRNT_BEFORE_CSR') ;
		WORK_ERROR_MSG2	:=  G$_NLS.Get('FRPMESS-0018', 'SQL',' GURTKLR Proxy Insert error from GRNT_PROXY_CSR') ;
		WORK_IDEN_CODE	:= 'GRNT';

		IF GRNT_BEFORE.DAYSNUM = 1 THEN
		  REMAINDER_MSG	:= TO_CHAR(GRNT_BEFORE.DAYSNUM,'999')||' day left. PROXY';
		ELSE
		  REMAINDER_MSG	:= TO_CHAR(GRNT_BEFORE.DAYSNUM,'999')||' days left. PROXY';
		END IF;
--
		INSERT_GURTKLR (WORK_USER_ID,
				WORK_ERROR_MSG1,
				WORK_ERROR_MSG2,
				REMAINDER_MSG,
				SUBSTR(WORK_CODE,1,15),
				WORK_EVNT_CODE,
				WORK_IDEN_CODE);
	   END LOOP;
	END LOOP;
	COMMIT;
--
	FOR PROP_OVER IN PROP_OVER_CSR LOOP
--
	   WORK_CODE       	:= PROP_OVER.FRREVNP_PROP_CODE;
	   WORK_EVNT_CODE  	:= PROP_OVER.FRREVNP_EVNT_CODE;
	   WORK_USER_ID		:= PROP_OVER.FRREVNP_RESPONSIBLE_USER_ID;
	   WORK_ERROR_MSG1 	:=  G$_NLS.Get('FRPMESS-0020', 'SQL',' GURTKLR Select MAXSEQNO error from PROP_OVER_CSR') ;
	   WORK_ERROR_MSG2	:=  G$_NLS.Get('FRPMESS-0021', 'SQL',' GURTKLR Responsible-User Insert error from PROP_OVER_CSR') ;
	   WORK_IDEN_CODE	:= 'PROP';

	   IF PROP_OVER.DAYSNUM = 1 THEN
		  REMAINDER_MSG	:= TO_CHAR(PROP_OVER.DAYSNUM,'999')||' day past since the event has been due. RESPONSIBLE USER';
	   ELSE
		  REMAINDER_MSG	:= TO_CHAR(PROP_OVER.DAYSNUM,'999')||' days past since the event has been due. RESPONSIBLE USER';
	   END IF;
--
		INSERT_GURTKLR (WORK_USER_ID,
				WORK_ERROR_MSG1,
				WORK_ERROR_MSG2,
				REMAINDER_MSG,
				SUBSTR(WORK_CODE,1,15),
				WORK_EVNT_CODE,
				WORK_IDEN_CODE);
--
	   WORK_CODE         := PROP_OVER.FRREVNP_PROP_CODE;
	   WORK_EVNT_CODE    := PROP_OVER.FRREVNP_EVNT_CODE;
	   WORK_EVNT_SEQ_NUM := PROP_OVER.FRREVNP_SEQ_NUM;

	   FOR PROP_PROXY IN PROP_PROXY_CSR LOOP

		WORK_USER_ID	:= PROP_PROXY.FRRPRXP_PROXY_USER_ID;
		WORK_ERROR_MSG1	:=  G$_NLS.Get('FRPMESS-0023', 'SQL',' GURTKLR Select MAXSEQNO error from PROP_OVER_CSR') ;
		WORK_ERROR_MSG2	:=  G$_NLS.Get('FRPMESS-0024', 'SQL',' GURTKLR Proxy Insert error from PROP_PROXY_CSR') ;
		WORK_IDEN_CODE	:= 'PROP';

		IF PROP_OVER.DAYSNUM = 1 THEN
		  REMAINDER_MSG	:= TO_CHAR(PROP_OVER.DAYSNUM,'999')||' day past since the event has been due. PROXY';
		ELSE
		  REMAINDER_MSG	:= TO_CHAR(PROP_OVER.DAYSNUM,'999')||' days past since the event has been due. PROXY';
		END IF;
--
		INSERT_GURTKLR (WORK_USER_ID,
				WORK_ERROR_MSG1,
				WORK_ERROR_MSG2,
				REMAINDER_MSG,
				SUBSTR(WORK_CODE,1,15),
				WORK_EVNT_CODE,
				WORK_IDEN_CODE);
	   END LOOP;
	END LOOP;
	COMMIT;
--
	FOR PROP_EQUAL IN PROP_EQUAL_CSR LOOP
--
	   WORK_CODE       	:= PROP_EQUAL.FRREVNP_PROP_CODE;
	   WORK_EVNT_CODE  	:= PROP_EQUAL.FRREVNP_EVNT_CODE;
	   WORK_USER_ID		:= PROP_EQUAL.FRREVNP_RESPONSIBLE_USER_ID;
	   WORK_ERROR_MSG1 	:=  G$_NLS.Get('FRPMESS-0026', 'SQL',' GURTKLR Select MAXSEQNO error from PROP_EQUAL_CSR') ;
	   WORK_ERROR_MSG2	:=  G$_NLS.Get('FRPMESS-0027', 'SQL',' GURTKLR Responsible-User Insert error from PROP_EQUAL_CSR') ;
	   WORK_IDEN_CODE		:= 'PROP';
	   REMAINDER_MSG		:= ' The event is due today. RESPONSIBLE USER';
--
		INSERT_GURTKLR (WORK_USER_ID,
				WORK_ERROR_MSG1,
				WORK_ERROR_MSG2,
				REMAINDER_MSG,
				SUBSTR(WORK_CODE,1,15),
				WORK_EVNT_CODE,
				WORK_IDEN_CODE);
--
	   WORK_CODE         := PROP_EQUAL.FRREVNP_PROP_CODE;
	   WORK_EVNT_CODE    := PROP_EQUAL.FRREVNP_EVNT_CODE;
	   WORK_EVNT_SEQ_NUM := PROP_EQUAL.FRREVNP_SEQ_NUM;

	   FOR PROP_PROXY IN PROP_PROXY_CSR LOOP

		WORK_USER_ID	:= PROP_PROXY.FRRPRXP_PROXY_USER_ID;
		WORK_ERROR_MSG1	:=  G$_NLS.Get('FRPMESS-0029', 'SQL',' GURTKLR Select MAXSEQNO error from PROP_EQUAL_CSR') ;
		WORK_ERROR_MSG2	:=  G$_NLS.Get('FRPMESS-0030', 'SQL',' GURTKLR Proxy Insert error from PROP_PROXY_CSR') ;
		WORK_IDEN_CODE	:= 'PROP';
		REMAINDER_MSG	:= ' The event is due today. PROXY';

		INSERT_GURTKLR (WORK_USER_ID,
				WORK_ERROR_MSG1,
				WORK_ERROR_MSG2,
				REMAINDER_MSG,
				SUBSTR(WORK_CODE,1,15),
				WORK_EVNT_CODE,
				WORK_IDEN_CODE);
	   END LOOP;
	END LOOP;
	COMMIT;


	FOR PROP_BEFORE IN PROP_BEFORE_CSR LOOP


	   WORK_CODE       	:= PROP_BEFORE.FRREVNP_PROP_CODE;
	   WORK_EVNT_CODE  	:= PROP_BEFORE.FRREVNP_EVNT_CODE;
	   WORK_USER_ID		:= PROP_BEFORE.FRREVNP_RESPONSIBLE_USER_ID;
	   WORK_ERROR_MSG1 	:=  G$_NLS.Get('FRPMESS-0032', 'SQL',' GURTKLR Select MAXSEQNO error from PROP_BEFORE_CSR') ;
	   WORK_ERROR_MSG2	:=  G$_NLS.Get('FRPMESS-0033', 'SQL',' GURTKLR Responsible-User Insert error from PROP_BEFORE_CSR') ;
	   WORK_IDEN_CODE	:= 'PROP';

	   IF PROP_BEFORE.DAYSNUM = 1 THEN
		  REMAINDER_MSG	:= TO_CHAR(PROP_BEFORE.DAYSNUM,'999')||' day left. RESPONSIBLE USER';
	   ELSE
		  REMAINDER_MSG	:= TO_CHAR(PROP_BEFORE.DAYSNUM,'999')||' days left. RESPONSIBLE USER';
	   END IF;
--
		INSERT_GURTKLR (WORK_USER_ID,
				WORK_ERROR_MSG1,
				WORK_ERROR_MSG2,
				REMAINDER_MSG,
				SUBSTR(WORK_CODE,1,15),
				WORK_EVNT_CODE,
				WORK_IDEN_CODE);
--
	   WORK_CODE         := PROP_BEFORE.FRREVNP_PROP_CODE;
	   WORK_EVNT_CODE    := PROP_BEFORE.FRREVNP_EVNT_CODE;
	   WORK_EVNT_SEQ_NUM := PROP_BEFORE.FRREVNP_SEQ_NUM;
--
	   FOR PROP_PROXY IN PROP_PROXY_CSR LOOP
--
		WORK_USER_ID	:= PROP_PROXY.FRRPRXP_PROXY_USER_ID;
		WORK_ERROR_MSG1	:=  G$_NLS.Get('FRPMESS-0035', 'SQL',' GURTKLR Select MAXSEQNO error from PROP_BEFORE_CSR') ;
		WORK_ERROR_MSG2	:=  G$_NLS.Get('FRPMESS-0036', 'SQL',' GURTKLR Proxy Insert error from PROP_PROXY_CSR') ;
		WORK_IDEN_CODE	:= 'PROP';

		IF PROP_BEFORE.DAYSNUM = 1 THEN
		  REMAINDER_MSG	:= TO_CHAR(PROP_BEFORE.DAYSNUM,'999')||' day left. PROXY';
		ELSE
		  REMAINDER_MSG	:= TO_CHAR(PROP_BEFORE.DAYSNUM,'999')||' days left. PROXY';
		END IF;
--
		INSERT_GURTKLR (WORK_USER_ID,
				WORK_ERROR_MSG1,
				WORK_ERROR_MSG2,
				REMAINDER_MSG,
				SUBSTR(WORK_CODE,1,15),
				WORK_EVNT_CODE,
				WORK_IDEN_CODE);
	   END LOOP;
	END LOOP;
	COMMIT;
END p_mess_reminder;
/


DROP PUBLIC SYNONYM P_MESS_REMINDER;

CREATE PUBLIC SYNONYM P_MESS_REMINDER FOR BANINST1.P_MESS_REMINDER;


GRANT EXECUTE ON BANINST1.P_MESS_REMINDER TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_MESS_REMINDER TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_MESS_REMINDER TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_MESS_REMINDER TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_MESS_REMINDER TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_MESS_REMINDER TO BANIMGR;

GRANT EXECUTE ON BANINST1.P_MESS_REMINDER TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_MESS_REMINDER TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_MESS_REMINDER TO GENERAL;

GRANT EXECUTE ON BANINST1.P_MESS_REMINDER TO PAYROLL;

GRANT EXECUTE ON BANINST1.P_MESS_REMINDER TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_MESS_REMINDER TO SATURN;

GRANT EXECUTE ON BANINST1.P_MESS_REMINDER TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_MESS_REMINDER TO WTAILOR;
DROP PROCEDURE BANINST1.P_UPD_CANCEL_EARN;

CREATE OR REPLACE PROCEDURE BANINST1.p_upd_cancel_earn
     (par_nbrearn_pidm           IN nbrearn.nbrearn_pidm%TYPE,
      par_nbrearn_posn           IN nbrearn.nbrearn_posn%TYPE,
      par_nbrearn_suff           IN nbrearn.nbrearn_suff%TYPE,
      par_nbrearn_effective_date IN nbrearn.nbrearn_effective_date%TYPE,
      par_nbrearn_earn_code      IN nbrearn.nbrearn_earn_code%TYPE,
      par_nbrearn_hrs            IN nbrearn.nbrearn_hrs%TYPE,
      par_nbrearn_deemed_hrs     IN nbrearn.nbrearn_deemed_hrs%TYPE,
      par_nbrearn_special_rate   IN nbrearn.nbrearn_special_rate%TYPE,
      par_nbrearn_shift          IN nbrearn.nbrearn_shift%TYPE,
      par_cancel_date            IN nortern.nortern_cancel_date%TYPE,
      par_hold_earn_date         IN OUT nbrearn.nbrearn_effective_date%TYPE,
      par_msg OUT VARCHAR2)
IS
--
-- FILE NAME..: nopucen.sql
-- RELEASE....: 7.3
-- OBJECT NAME: P_UPD_CANCEL_EARN
-- PRODUCT....: POSNCTL
-- USAGE......: Process the cancel date on Employee Default Earnings records.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure processes the cancel date on Employee Default Earnings
-- (NBREARN) records.
--
-- DESCRIPTION END
--
   CURSOR PTI_CURSOR IS
      SELECT MIN(NBREARN_EFFECTIVE_DATE)
      FROM   NBREARN M
      WHERE  M.NBREARN_PIDM = par_nbrearn_pidm
        AND  M.NBREARN_POSN = par_nbrearn_posn
           AND  M.NBREARN_SUFF = par_nbrearn_suff
           AND  M.NBREARN_EFFECTIVE_DATE >=  par_nbrearn_effective_date
           AND  M.NBREARN_EARN_CODE = par_nbrearn_earn_code
           AND  M.NBREARN_ACTIVE_IND = 'N'
           AND  NOT EXISTS  (
               SELECT 'X'
               FROM   NBREARN S
               WHERE  NBREARN_PIDM = par_nbrearn_pidm
                 AND  S.NBREARN_POSN = par_nbrearn_posn
                 AND  S.NBREARN_SUFF = par_nbrearn_suff
                 AND  S.NBREARN_EARN_CODE = par_nbrearn_earn_code
                 AND  S.NBREARN_ACTIVE_IND = 'Y'
                 AND  S.NBREARN_EFFECTIVE_DATE BETWEEN (
                    par_nbrearn_effective_date + 1) AND
                    M.NBREARN_EFFECTIVE_DATE )  ;
--
   delete_error EXCEPTION;
   insert_error EXCEPTION;
   update_error EXCEPTION;
--
BEGIN
   par_msg := NULL;
--
   OPEN PTI_CURSOR ;
   FETCH PTI_CURSOR INTO par_hold_earn_date ;
   IF PTI_CURSOR%NOTFOUND THEN
      par_hold_earn_date := NULL;
   END IF;
   CLOSE PTI_CURSOR;
--
   IF par_cancel_date IS NULL  THEN
      IF par_hold_earn_date IS NULL  THEN
         par_hold_earn_date := par_cancel_date ;
      ELSE
         DELETE FROM NBREARN
         WHERE  NBREARN_PIDM = par_nbrearn_pidm
           AND  NBREARN_POSN = par_nbrearn_posn
           AND  NBREARN_SUFF = par_nbrearn_suff
           AND  NBREARN_EARN_CODE = par_nbrearn_earn_code
           AND  NBREARN_EFFECTIVE_DATE = par_hold_earn_date
           AND  NBREARN_ACTIVE_IND = 'N' ;
        IF SQL%NOTFOUND THEN
           RAISE delete_error;
        ELSE
           par_hold_earn_date := par_cancel_date;
        END IF ;
      END IF ;
   ELSE
     IF par_hold_earn_date IS NULL  THEN
         INSERT INTO NBREARN (
           nbrearn_pidm,
           nbrearn_posn,
           nbrearn_suff,
           nbrearn_effective_date,
           nbrearn_earn_code,
           nbrearn_active_ind,
           nbrearn_hrs,
           nbrearn_special_rate,
           nbrearn_shift,
           nbrearn_activity_date,
           nbrearn_deemed_hrs,
           nbrearn_user_id,
           nbrearn_data_origin)
         VALUES (
           par_nbrearn_pidm,
           par_nbrearn_posn,
           par_nbrearn_suff,
           par_cancel_date,
           par_nbrearn_earn_code,
           'N',
           par_nbrearn_hrs,
           par_nbrearn_special_rate,
           par_nbrearn_shift,
           SYSDATE,
           par_nbrearn_deemed_hrs,
           gb_common.f_sct_user,
           gb_common.DATA_ORIGIN);

         IF SQL%NOTFOUND THEN
            RAISE insert_error;
         ELSE
            par_hold_earn_date := par_cancel_date;
         END IF;
      ELSE
         UPDATE NBREARN
         SET    NBREARN_EFFECTIVE_DATE = par_cancel_date
         WHERE  NBREARN_PIDM = par_nbrearn_pidm
         AND  NBREARN_POSN = par_nbrearn_posn
         AND  NBREARN_SUFF = par_nbrearn_suff
         AND  NBREARN_EARN_CODE = par_nbrearn_earn_code
         AND  NBREARN_EFFECTIVE_DATE = par_hold_earn_date
         AND  NBREARN_ACTIVE_IND = 'N' ;
         IF SQL%NOTFOUND THEN
            RAISE update_error;
         ELSE
            par_hold_earn_date := par_cancel_date;
          END IF ;
      END IF;
   END IF;
EXCEPTION
   WHEN delete_error THEN
      par_msg :=  G$_NLS.Get('NOPUCEN-0000', 'SQL',
	'*ERROR* Unable to delete inactive NBREARN record (Oracle Error %01%).',  TO_CHAR(SQLCODE) );
   WHEN insert_error THEN
      par_msg :=  G$_NLS.Get('NOPUCEN-0001', 'SQL',
	'*ERROR* Unable to insert inactive NBREARN record (Oracle Error %01%).',  TO_CHAR(SQLCODE));
   WHEN update_error THEN
      par_msg :=  G$_NLS.Get('NOPUCEN-0002', 'SQL',
	'*ERROR* Unable to update inactive NBREARN record (Oracle Error %01%).',  TO_CHAR(SQLCODE));
   WHEN OTHERS THEN
      par_msg :=  G$_NLS.Get('NOPUCEN-0003', 'SQL',
	'*ERROR* Unable to cancel NBREARN record (Oracle Error %01%).',  TO_CHAR(SQLCODE));
END;
/


DROP PUBLIC SYNONYM P_UPD_CANCEL_EARN;

CREATE PUBLIC SYNONYM P_UPD_CANCEL_EARN FOR BANINST1.P_UPD_CANCEL_EARN;


GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO GENERAL;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO PAYROLL;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO SATURN;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_UPD_CANCEL_EARN TO WTAILOR;
DROP PROCEDURE BANINST1.P_UPD_ENCUMBRANCE_HRS;

CREATE OR REPLACE PROCEDURE BANINST1.p_upd_encumbrance_hrs
       (par_pidm                   IN  number,
        par_posn                   IN  varchar2,
        par_suff                   IN  varchar2,
        par_encum_hrs_change       IN  number,
        par_eff_date_change        IN  date,
        par_hrsys_ind              IN  varchar2,
        msg                        OUT varchar2)
IS
--
-- FILE NAME..: nopuenc.sql
-- RELEASE....: 4.1
-- OBJECT NAME: P_UPD_ENCUMBRANCE_HRS
-- PRODUCT....: POSNCTL
-- USAGE......: Update the NBRJOBS_ENCUMBRANCE_HRS
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure updates the NBRJOBS_ENCUMBRANCE_HRS on a prior effective dated
-- record in order to balance the total encumbrance hours when the job e-class
-- uses the hours input encumbrance method.
--
-- DESCRIPTION END
--
   var_msg          varchar2(80) := NULL;
--
   update_error     EXCEPTION;
BEGIN
   msg := NULL;
--
   UPDATE nbrjobs
   SET    nbrjobs_encumbrance_hrs = par_encum_hrs_change
   WHERE  nbrjobs_pidm = par_pidm
     AND  nbrjobs_posn = par_posn
     AND  nbrjobs_suff = par_suff
     AND  nbrjobs_effective_date = par_eff_date_change;
   IF SQL%NOTFOUND THEN
      RAISE update_error;
   END IF;
--
   IF par_hrsys_ind = 'Y' THEN
      nokplib.p_upd_perjhis_enc_hrs(
         par_pidm,
         par_posn,
         par_suff,
         par_encum_hrs_change,
         par_eff_date_change,
         var_msg);
   END IF;
   IF var_msg IS NOT NULL THEN
      msg := var_msg;
   END IF;
--
   EXCEPTION
      WHEN update_error THEN
         msg :=  G$_NLS.Get('NOPUENC-0000', 'SQL',
	'*ERROR* Unable to update enc hrs for a previous record (Oracle Error %01%).'

	,  TO_CHAR(SQLCODE));
END;
/


DROP PUBLIC SYNONYM P_UPD_ENCUMBRANCE_HRS;

CREATE PUBLIC SYNONYM P_UPD_ENCUMBRANCE_HRS FOR BANINST1.P_UPD_ENCUMBRANCE_HRS;


GRANT EXECUTE ON BANINST1.P_UPD_ENCUMBRANCE_HRS TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_UPD_ENCUMBRANCE_HRS TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_UPD_ENCUMBRANCE_HRS TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_UPD_ENCUMBRANCE_HRS TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_UPD_ENCUMBRANCE_HRS TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_UPD_ENCUMBRANCE_HRS TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_UPD_ENCUMBRANCE_HRS TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_UPD_ENCUMBRANCE_HRS TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_UPD_ENCUMBRANCE_HRS TO GENERAL;

GRANT EXECUTE ON BANINST1.P_UPD_ENCUMBRANCE_HRS TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_UPD_ENCUMBRANCE_HRS TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_UPD_ENCUMBRANCE_HRS TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_UPD_ENCUMBRANCE_HRS TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_UPD_ENCUMBRANCE_HRS TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_UPD_ENCUMBRANCE_HRS TO SATURN;

GRANT EXECUTE ON BANINST1.P_UPD_ENCUMBRANCE_HRS TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_UPD_ENCUMBRANCE_HRS TO WTAILOR;
DROP PROCEDURE BANINST1.P_UPD_NBRBJOB_REC;

CREATE OR REPLACE PROCEDURE BANINST1.p_upd_nbrbjob_rec
     (par_nbrbjob_pidm IN nbrbjob.nbrbjob_pidm%TYPE,
      par_nbrbjob_posn IN nbrbjob.nbrbjob_posn%TYPE,
      par_nbrbjob_suff IN nbrbjob.nbrbjob_suff%TYPE,
      par_nbrbjob_begin_date IN nbrbjob.nbrbjob_begin_date%TYPE,
      par_nbrbjob_end_date IN nbrbjob.nbrbjob_end_date%TYPE,
      par_nbrbjob_defer_bal IN nbrbjob.nbrbjob_defer_bal%TYPE,
      par_nbrbjob_contract_type IN nbrbjob.nbrbjob_contract_type%TYPE,
      par_nbrbjob_salary_encumbrance IN nbrbjob.nbrbjob_salary_encumbrance%TYPE,
   par_nbrbjob_contract_beg_date IN nbrbjob.nbrbjob_contract_begin_date%TYPE,
   par_nbrbjob_contract_end_date IN nbrbjob.nbrbjob_contract_end_date%TYPE,
   par_nbrbjob_total_contract_hrs IN nbrbjob.nbrbjob_total_contract_hrs%TYPE,
   par_nbrbjob_total_encumb_hrs IN nbrbjob.nbrbjob_total_encumbrance_hrs%TYPE,
      par_nbrbjob_step_incr_mon IN nbrbjob.nbrbjob_step_incr_mon%TYPE,
      par_nbrbjob_step_incr_day IN nbrbjob.nbrbjob_step_incr_day%TYPE,
      par_nbrbjob_coas_code IN nbrbjob.nbrbjob_coas_code%TYPE,
      par_nbrbjob_accrue_leave_ind IN nbrbjob.nbrbjob_accrue_leave_ind%TYPE,
      par_nbrbjob_civil_service_ind IN nbrbjob.nbrbjob_civil_service_ind%TYPE,
  par_nbrbjob_encumb_change_ind IN nbrbjob.nbrbjob_encumbrance_change_ind%TYPE,
  par_nbrbjob_fringe_encumbrance IN nbrbjob.nbrbjob_fringe_encumbrance%TYPE,
      par_nbrbjob_ipeds_rept_ind IN nbrbjob.nbrbjob_ipeds_rept_ind%TYPE,
  par_nbrbjob_facl_stat_rpt_ind IN nbrbjob.nbrbjob_facl_statscan_rept_ind%TYPE,
  par_nbrbjob_probation_beg_date IN nbrbjob.nbrbjob_probation_begin_date%TYPE,
      par_nbrbjob_probation_end_date IN nbrbjob.nbrbjob_probation_end_date%TYPE,
      par_nbrbjob_probation_units IN nbrbjob.nbrbjob_probation_units%TYPE,
      par_nbrbjob_eligible_date IN nbrbjob.nbrbjob_eligible_date%TYPE,
      par_msg OUT VARCHAR2)
IS
--
-- FILE NAME..: nopujob.sql
-- RELEASE....: 6.0
-- OBJECT NAME: P_UPD_NBRBJOB_REC
-- PRODUCT....: POSNCTL
-- USAGE......: Update base job record.
-- COPYRIGHT..: Copyright (c) SCT Corporation 1998.  All rights reserved.
--
-- DESCRIPTION:
--
-- This procedure updates the base job record (nbrbjob) for a job.
--
-- DESCRIPTION END
--
BEGIN
   par_msg := NULL;
--
   UPDATE nbrbjob
      SET nbrbjob_posn = par_nbrbjob_posn,
          nbrbjob_suff = par_nbrbjob_suff,
          nbrbjob_begin_date = par_nbrbjob_begin_date,
          nbrbjob_end_date = par_nbrbjob_end_date,
          nbrbjob_defer_bal = par_nbrbjob_defer_bal,
          nbrbjob_contract_type = par_nbrbjob_contract_type,
          nbrbjob_salary_encumbrance = par_nbrbjob_salary_encumbrance,
          nbrbjob_contract_begin_date = par_nbrbjob_contract_beg_date,
          nbrbjob_contract_end_date = par_nbrbjob_contract_end_date,
          nbrbjob_total_contract_hrs = par_nbrbjob_total_contract_hrs,
          nbrbjob_total_encumbrance_hrs = par_nbrbjob_total_encumb_hrs,
          nbrbjob_step_incr_mon = par_nbrbjob_step_incr_mon,
          nbrbjob_step_incr_day = par_nbrbjob_step_incr_day,
          nbrbjob_coas_code = par_nbrbjob_coas_code,
          nbrbjob_activity_date = SYSDATE,
          nbrbjob_accrue_leave_ind = par_nbrbjob_accrue_leave_ind,
          nbrbjob_civil_service_ind = par_nbrbjob_civil_service_ind,
          nbrbjob_encumbrance_change_ind = par_nbrbjob_encumb_change_ind,
          nbrbjob_fringe_encumbrance = par_nbrbjob_fringe_encumbrance,
          nbrbjob_ipeds_rept_ind = par_nbrbjob_ipeds_rept_ind,
          nbrbjob_facl_statscan_rept_ind = par_nbrbjob_facl_stat_rpt_ind,
          nbrbjob_probation_begin_date = par_nbrbjob_probation_beg_date,
          nbrbjob_probation_end_date = par_nbrbjob_probation_end_date,
          nbrbjob_probation_units = par_nbrbjob_probation_units,
          nbrbjob_eligible_date = par_nbrbjob_eligible_date
       WHERE nbrbjob_pidm = par_nbrbjob_pidm
       AND   nbrbjob_posn = par_nbrbjob_posn
       AND   nbrbjob_suff = par_nbrbjob_suff;
EXCEPTION
   WHEN OTHERS THEN
      par_msg := '*ERROR* Unable to update nbrbjob record (Oracle Error ' ||
                 TO_CHAR(SQLCODE) || ').';
END;
/


DROP PUBLIC SYNONYM P_UPD_NBRBJOB_REC;

CREATE PUBLIC SYNONYM P_UPD_NBRBJOB_REC FOR BANINST1.P_UPD_NBRBJOB_REC;


GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO ADISPRD;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO ADISUSR;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO ALUMNI;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO BANIMGR;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO FAISMGR;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO FIMSMGR;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO FIMSPRD;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO FIMSUSR;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO GENERAL;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO HRISPRD;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO HRISUSR;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO POSNCTL;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO SAISPRD;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO SAISUSR;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO SATURN;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO TAISMGR;

GRANT EXECUTE ON BANINST1.P_UPD_NBRBJOB_REC TO WTAILOR;
DROP PROCEDURE BANINST1.PWAASGR;

CREATE OR REPLACE PROCEDURE BANINST1.PWAASGR(psNameNEW   VARCHAR2,
                                             psNameOLD   VARCHAR2,
                                             psDeleteOLD VARCHAR2,
                                             psName      VARCHAR2 DEFAULT NULL,
                                             psSubName   VARCHAR2 DEFAULT NULL,
                                             pnRecmCode  NUMBER   DEFAULT NULL,
                                             psRecmExts  VARCHAR2 DEFAULT 'NEW'
                                            ) IS

/*
    Tarea: Reasigna un reporte a otro
    Fecha: 23/03/2010
    Autor: GEPC
   Modulo: General

           -- psNameNEW   VARCHAR2,               NOMBRE DEL PROCEDIMIENTO (NUEVA CLAVE DEL REPORTE)

           -- psNameOLD   VARCHAR2,               CLAVE DEL REPORTE        (VIEJA CLAVE DEL REPORTE "SWBRECL_NOMBRE")

           -- psDeleteOLD VARCHAR2,               "Y" eliminar la anterior clave del reporte en SWBRECL, SWRRECL y SWRUSUR
                                                  "N" para clonacin de reporte (asignarle otras caracterisitricas al reporte clonado)


           -- psName      VARCHAR2 DEFAULT NULL,  Nuevo nombre del reporte (Sustituye el actaul nombre del reporte)

           -- psSubName   VARCHAR2 DEFAULT NULL   Se agrega al actual nombre del reporte  al "nuevo nombre" del reporte

           -- pnRecmCode  NUMBER   DEFAULT NULL   Reasignar un reporte a otro modulo

           -- psRecmExts  VARCHAR2 DEFAULT 'N'    * "NEW" el reporte se registra en otro modulo y no se asigna a usuarios
                                                  * "OLD" el reporte se registra en otro modulo y se reasigna a usuarios

*/

  vsAccion  VARCHAR2(2)    := NULL;
  vsEtapa   VARCHAR2(100)  := NULL;
  vsError   VARCHAR2(4000) := NULL;
  vsBkpoint VARCHAR2(7)    := 'BK0001 ';

  --Busca el reporte asignado a los usuarios
  CURSOR cuRepUsu IS
         SELECT SWRUSUR_USUARIO   Usee,
                psNameNEW         Rept,
                SWRUSUR_RECMCODE  Recm
           FROM SWRUSUR
          WHERE SWRUSUR_REPORT_NAME = psNameOLD;

  procedure RegistraEtapa is

  begin
      if vsError is not null then
         rollback;

         vsAccion := Null;
      else
         commit;
      end if;

      insert into gwrasgr(gwrasgr_new, gwrasgr_old, gwrasgr_accion, gwrasgr_etapa, gwrasgr_error)
                   values(psNameNEW,   psNameOLD,   vsAccion,       vsEtapa,       vsError);

      commit;

      vsError  := null;
      vsAccion := 'OK';
  end RegistraEtapa;

  BEGIN
      vsEtapa  := 'Registro de reporte';
      vsAccion := 'OK';

      BEGIN
          IF pnRecmCode IS NOT NULL THEN
             INSERT INTO SWBRECL(SWBRECL_NOMBRE,SWBRECL_DESC,                        SWBRECL_PROCESO,SWBRECL_RECMCODE)
                          SELECT psNameNEW,     NVL(psName,SWBRECL_DESC)||psSubName, psNameNEW,      pnRecmCode
                            FROM SWBRECL
                           WHERE SWBRECL_NOMBRE = psNameOLD
                           GROUP BY psNameNEW,NVL(psName,SWBRECL_DESC)||psSubName, psNameNEW;
          ELSE
             INSERT INTO SWBRECL(SWBRECL_NOMBRE,SWBRECL_DESC,                        SWBRECL_PROCESO,SWBRECL_RECMCODE)
                          SELECT psNameNEW,     NVL(psName,SWBRECL_DESC)||psSubName, psNameNEW,      NVL(pnRecmCode,SWBRECL_RECMCODE)
                            FROM SWBRECL
                           WHERE SWBRECL_NOMBRE = psNameOLD;
          END IF;

          IF SQL%ROWCOUNT = 0  THEN
             vsError := vsBkpoint||SQLERRM;
          END IF;

      EXCEPTION
          WHEN DUP_VAL_ON_INDEX THEN
               vsError := vsBkpoint||SQLERRM;
          WHEN OTHERS THEN
               vsError := vsBkpoint||SQLERRM;
      END;

      vsBkpoint := 'BK0002 ';

      RegistraEtapa;

      vsEtapa  := 'Registro de parametros';

      BEGIN
          INSERT INTO SWRRECL(SWRRECL_NOMBRE,      SWRRECL_NOMBRE_PAR,    SWRRECL_PARAMETRO_DESC,           SWRRECL_PARAMETRO_TIPO,
                              SWRRECL_ORDEN,       SWRRECL_PARAMETRO_REQ, SWRRECL_RECMCODE,                 SWRRECL_PARAM_FILTRO,
                              SWRRECL_CONDICION_1, SWRRECL_CONDICION_2,   SWRRECL_CONDICION_3,              SWRRECL_OBJECT_CLEAN,
                              SWRRECL_ALL,         SWRRECL_DEFAULT
                             )
                       SELECT psNameNEW,           SWRRECL_NOMBRE_PAR,    SWRRECL_PARAMETRO_DESC,           SWRRECL_PARAMETRO_TIPO,
                              SWRRECL_ORDEN,       SWRRECL_PARAMETRO_REQ, NVL(pnRecmCode,SWRRECL_RECMCODE), SWRRECL_PARAM_FILTRO,
                              SWRRECL_CONDICION_1, SWRRECL_CONDICION_2,   SWRRECL_CONDICION_3,              SWRRECL_OBJECT_CLEAN,
                              SWRRECL_ALL,         SWRRECL_DEFAULT
                         FROM SWRRECL
                        WHERE SWRRECL_Nombre = psNameOLD;

          IF SQL%ROWCOUNT = 0  THEN
             vsError := vsBkpoint||SQLERRM;
          END IF;

      EXCEPTION
          WHEN DUP_VAL_ON_INDEX THEN
               vsError := vsBkpoint||SQLERRM;
          WHEN OTHERS THEN
               vsError := vsBkpoint||SQLERRM;
      END;

      vsBkpoint := 'BK0003 ';

      RegistraEtapa;

      IF pnRecmCode IS NULL OR (pnRecmCode IS NOT NULL AND psRecmExts = 'OLD') THEN
         vsEtapa  := 'Aignar reporte a usuarios';

         FOR regRep IN cuRepUsu LOOP

             --Se asigna el nuevo reporte a los usuarios
             BEGIN
                 INSERT INTO SWRUSUR(SWRUSUR_USUARIO, SWRUSUR_REPORT_NAME, SWRUSUR_RECMCODE)
                              VALUES(regRep.Usee,     regRep.Rept,         NVL(pnRecmCode,regRep.Recm));
             EXCEPTION
                 WHEN DUP_VAL_ON_INDEX THEN
                      vsError := vsBkpoint||SQLERRM;
                 WHEN OTHERS THEN
                      vsError := vsBkpoint||SQLERRM;
             END;

         END LOOP;

         vsBkpoint := 'BK0004 ';

         RegistraEtapa;

         IF psDeleteOLD = 'Y' THEN
            vsEtapa := NULL;

            BEGIN
                BEGIN
                    SELECT SWBRECL_PROCESO
                      INTO vsEtapa
                      FROM SWBRECL
                     WHERE SWBRECL_NOMBRE = psNameOLD
                     GROUP BY SWBRECL_PROCESO;
                EXCEPTION
                    WHEN NO_DATA_FOUND THEN
                         vsEtapa := NULL;

                    WHEN OTHERS THEN
                         vsEtapa := NULL;
                END;

                IF vsEtapa IS NOT NULL THEN
                   DELETE FROM TWGBWMNU
                    WHERE TWGBWMNU_NAME = vsEtapa;

                   IF SQL%ROWCOUNT = 0  THEN
                      vsError := vsBkpoint||SQLERRM;
                   END IF;
                END IF;
            END;

            vsBkpoint := 'BK0005 ';

            RegistraEtapa;

            vsEtapa  := 'elimina el reporte anterior al usuario';

            BEGIN
                DELETE FROM SWRUSUR WHERE SWRUSUR_REPORT_NAME = psNameOLD;

                IF SQL%ROWCOUNT = 0  THEN
                   vsError := vsBkpoint||SQLERRM;
                END IF;
            END;

            vsBkpoint := 'BK0006 ';

            RegistraEtapa;

            vsEtapa  := 'elimina los parametros al reprote anterior';

            BEGIN
                DELETE FROM SWRRECL WHERE SWRRECL_NOMBRE = psNameOLD;

                IF SQL%ROWCOUNT = 0  THEN
                   vsError := vsBkpoint||SQLERRM;
                END IF;
            END;

            vsBkpoint := 'BK0007 ';

            RegistraEtapa;

            vsEtapa  := 'elimina el registro del reporte';

            BEGIN
                DELETE FROM SWBRECL WHERE SWBRECL_NOMBRE = psNameOLD;

                IF SQL%ROWCOUNT = 0  THEN
                   vsError := vsBkpoint||SQLERRM;
                END IF;
            END;

            RegistraEtapa;

         END IF;
      END IF;

  END PWAASGR;
/
DROP PROCEDURE BANINST1.PWAAVPG;

CREATE OR REPLACE PROCEDURE BANINST1.pwaavpg (psCamp    VARCHAR2,
                            psTerm    VARCHAR2,
                            psColl    VARCHAR2,
                            psSede    VARCHAR2 DEFAULT NULL)
IS
   /*
            TAREA: Llena tablas de paso para mejorar la velocidad en el reporte
            FECHA: 01/08/2011
            AUTOR: GEPC
           MODULO: Profesores

     Modificacin: 22/09/2011
                   JCCR
                   Se Agrego la Condicion  (C.SSBSECT_GMOD_CODE != csS OR C.SSBSECT_GMOD_CODE != csX)

     Modificacin: 05/10/2011
                   GEPC
                   Se modifico la Condicion  (C.SSBSECT_GMOD_CODE != csS OR C.SSBSECT_GMOD_CODE != csX)
                   por
                        AND C.SSBSECT_GMOD_CODE <> csS
                        AND C.SSBSECT_GMOD_CODE <> csX
   */

   cs0         CONSTANT VARCHAR2 (1) := '0';
   csA         CONSTANT VARCHAR2 (1) := 'A';
   csY         CONSTANT VARCHAR2 (1) := 'Y';
   csS         CONSTANT VARCHAR2 (1) := 'S';
   csX         CONSTANT VARCHAR2 (1) := 'X';
   csDI        CONSTANT VARCHAR2 (2) := 'DI';
   csZZ        CONSTANT VARCHAR2 (2) := 'ZZ';
   csSinSede   CONSTANT VARCHAR2 (8) := 'sin Sede';
   ciCero      CONSTANT INTEGER := 0;
   cn1         CONSTANT NUMBER (1) := 1;
   cn2         CONSTANT NUMBER (1) := 2;

   vsCamp               VARCHAR2 (6) := psCamp;
   vsSede               VARCHAR2 (10) := psSede;
   vsTerm               VARCHAR2 (10) := psTerm;
   vsColl               VARCHAR2 (10) := psColl;
BEGIN
   DELETE SWRPGAC;

   INSERT INTO SWRPGAC (SWRPGAC_TERM_CODE,
                        SWRPGAC_CRN,
                        SWRPGAC_COLL_CODE,
                        SWRPGAC_SUBJ_CODE,
                        SWRPGAC_CRSE_NUMB,
                        SWRPGAC_TITLE,
                        SWRPGAC_GMOD_CODE)
      SELECT C.SSBSECT_TERM_CODE,
             C.SSBSECT_CRN,
             NVL (D.SSBOVRR_COLL_CODE, A.SCBCRSE_COLL_CODE),
             A.SCBCRSE_SUBJ_CODE,
             A.SCBCRSE_CRSE_NUMB,
             A.SCBCRSE_TITLE,
             C.SSBSECT_GMOD_CODE
        FROM SSBSECT C, SCBCRSE A, SSBOVRR D
       WHERE A.SCBCRSE_EFF_TERM =
                (SELECT MAX (B.SCBCRSE_EFF_TERM)
                   FROM SCBCRSE B
                  WHERE     B.SCBCRSE_EFF_TERM <= C.SSBSECT_TERM_CODE
                        AND B.SCBCRSE_SUBJ_CODE = C.SSBSECT_SUBJ_CODE
                        AND B.SCBCRSE_CRSE_NUMB = C.SSBSECT_CRSE_NUMB)
             AND C.SSBSECT_TERM_CODE = D.SSBOVRR_TERM_CODE(+)
             AND C.SSBSECT_CRN = D.SSBOVRR_CRN(+)
             AND C.SSBSECT_SUBJ_CODE = A.SCBCRSE_SUBJ_CODE
             AND C.SSBSECT_CRSE_NUMB = A.SCBCRSE_CRSE_NUMB
             AND (NVL (D.SSBOVRR_COLL_CODE, A.SCBCRSE_COLL_CODE) = vsColl
                  OR vsColl = csZZ)
             AND NVL (C.SSBSECT_INSM_CODE, cs0) <> csDI
             AND C.SSBSECT_SSTS_CODE = csA
             AND C.SSBSECT_TERM_CODE = vsTerm
             AND C.SSBSECT_CAMP_CODE = vsCamp
             AND NVL (C.SSBSECT_GMOD_CODE, cs0) <> csS
             AND NVL (C.SSBSECT_GMOD_CODE, cs0) <> csX;

   DELETE FWRHORS;

   INSERT INTO FWRHORS (FWRHORS_PIDM,
                        FWRHORS_TERM_CODE,
                        FWRHORS_CRN,
                        FWRHORS_ROOM_CODE)
      SELECT sirasg.asgnPidm,
             sirasg.termCode,
             sirasg.asgnCrnn,
             sirasg.deptSede
        FROM (SELECT DISTINCT SIRASGN_PIDM AS asgnPidm,
                              SIRASGN_TERM_CODE AS termCode,
                              SIRASGN_CRN AS asgnCrnn,
                              NVL (SIRDPC.deptSede, csSinSede) AS deptSede
                FROM SIRASGN,
                     (SELECT SIRDPCL_PIDM AS dpclPidm,
                             SIRDPCL_DEPT_CODE AS deptSede
                        FROM SIRDPCL A
                       WHERE SIRDPCL_HOME_IND = csY
                             AND SIRDPCL_TERM_CODE_EFF =
                                    (SELECT MAX (SI.SIRDPCL_TERM_CODE_EFF)
                                       FROM SIRDPCL SI
                                      WHERE SI.SIRDPCL_PIDM = A.SIRDPCL_PIDM
                                            AND SI.SIRDPCL_TERM_CODE_EFF <=
                                                   vsTerm)) SIRDPC
               WHERE SIRASGN_PIDM = SIRDPC.dpclPidm(+)
                     AND (SIRASGN_CRN, SIRASGN_TERM_CODE) IN
                            (SELECT SWRPGAC_CRN, SWRPGAC_TERM_CODE
                               FROM SWRPGAC)
                     AND SIRASGN_PRIMARY_IND = csY
                     AND (NVL (SIRDPC.deptSede, csSinSede) = vsSede
                          OR vsSede IS NULL)) sirasg;

   DELETE FWRSIRG;

   INSERT INTO FWRSIRG (FWRSIRG_PIDM,
                        FWRSIRG_TERM_CODE,
                        FWRSIRG_CRN,
                        FWRSIRG_DEPT_CODE,
                        FWRSIRG_COLL_CODE)
      SELECT FWRHORS_PIDM,
             SWRPGAC_TERM_CODE,
             SWRPGAC_CRN,
             FWRHORS_ROOM_CODE,
             SWRPGAC_COLL_CODE
        FROM SWRPGAC, FWRHORS
       WHERE SWRPGAC_TERM_CODE = FWRHORS_TERM_CODE
             AND SWRPGAC_CRN = FWRHORS_CRN;
END PWAAVPG;
/


DROP PUBLIC SYNONYM PWAAVPG;

CREATE PUBLIC SYNONYM PWAAVPG FOR BANINST1.PWAAVPG;
DROP PROCEDURE BANINST1.PWABCDE;

CREATE OR REPLACE PROCEDURE BANINST1.PWABCDE (psReclDesc VARCHAR2)
IS
/******************************************************************************
PROCEDIMIENTO:          BANINST1.PWABCDE
OBJETIVO:               Reporte de Becas, Creditos y Descuentos
AUTORES:                Guillermo Almazan Ibaez
FECHA:                  10/12/2010
******************************************************************************/

   vnRow         INTEGER := 0;
   vnExists      INTEGER := 0;
   vnColumnas    INTEGER := 17;
   vsProg       smrprle.smrprle_program_desc%TYPE;
   vsVia        stvstst.stvstst_code%TYPE;
   vsTyAl       stvstyp.stvstyp_code%TYPE;
   vsYear       varchar2(4);
   vsCont       twbcntr.twbcntr_num%TYPE;
   vsPidm       TWRCRAL.TWRCRAL_PIDM%TYPE;
   tabColumna   Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla (1);
   vsInicioPag   VARCHAR2 (10) := NULL;
CURSOR cuABCDE (vsProg in smrprle.smrprle_program_desc%TYPE,
                          vsVia in stvstst.stvstst_code%TYPE,
                          vsType in stvstyp.stvstyp_code%TYPE,
                          vsYear in VARCHAR2,
                          vsCont in twbcntr.twbcntr_num%TYPE)
  IS
  select pidm, periodo, rut_beneficiado, dv_rut, rut_def, id_al, nombre,
         programa, periodo_ing, code_nuevo_antiguo,
         decode(code_nuevo_antiguo, 'A', 'Avanzado','N', 'Nuevo Ingreso') nuevo_antiguo,
         pk_catalogo.stastst(condicion) condicion,
         contrato,
         monto_cntr, --to_char(monto_cntr, pk_contrato.ConstglFormato) monto_cntr,
         monto_mat, --to_char(monto_mat, pk_contrato.ConstglFormato) monto_mat,
         monto_ara, --to_char(monto_ara, pk_contrato.ConstglFormato) monto_ara,
         monto_Beca, --to_char(monto_Beca, pk_contrato.ConstglFormato) monto_Beca,
         beca, descrip, Por_Beca
  from (
        select twbcntr_pidm                                                                 pidm
             , twbcntr_term_code                                                            periodo
             , substr(f_get_rut(twbcntr_pidm), 1, length(f_get_rut(twbcntr_pidm))-2)        rut_beneficiado
             , substr(f_get_rut(twbcntr_pidm), length(f_get_rut(twbcntr_pidm)),1)           dv_rut
             , f_get_rut(twbcntr_pidm)                                                      rut_def
             , f_get_id(twbcntr_pidm)                                                       id_al
             , f_format_name(twbcntr_pidm, 'LF30')                                          nombre
             , pk_catalogo.programa(f_get_programa(twbcntr_pidm, twbcntr_term_code))        programa
             , pk_AdMat.f_PeriodoIngreso(twbcntr_pidm, twbcntr_term_code)                   periodo_ing
             , case
                    when pk_AdMat.f_PeriodoIngreso(twbcntr_pidm, twbcntr_term_code) < twbcntr_term_code then 'A'
                    else 'N'
               end                                                                          code_nuevo_antiguo
             , f_sgbstdn_fields(twbcntr_pidm, twbcntr_term_code, 'STU_STATUS')                condicion
             , twbcntr_num                                                                  contrato
             , pk_matricula.f_MontoContrato(twbcntr_num)                                    monto_cntr
--             ,(select sum(TBRACCD_AMOUNT)
--               from TBRACCD
--               where TBRACCD_DETAIL_CODE in (select TBBDETC_DETAIL_CODE
--                                             from TBBDETC
--                                             where TBBDETC_DCAT_CODE = 'FEE'
--                                               and TBBDETC_TYPE_IND = 'C')
--                and TBRACCD_PIDM = twbcntr_pidm
--                and TBRACCD_TERM_CODE = twbcntr_term_code)                                  monto_mat
             ,(select sum( abs(twrdotr_part_amount)*sign(tbraccd_amount) )
               from tbbdetc ,tbraccd ,twbdocu ,twrdotr ,twbcntr b
               where tbbdetc_detail_code = tbraccd_detail_code
                 and tbbdetc_type_ind = 'C'
                 and tbbdetc_dcat_code = 'FEE'
                 and tbraccd_pidm = twrdotr_pidm
                 and tbraccd_tran_number = twrdotr_tran_number
                 and twbdocu_seq_num = twrdotr_docu_seq_num
                 and twbdocu_cntr_num = b.twbcntr_num
                 and twrdotr_orig_ind = 'O'
                 and b.twbcntr_num = a.twbcntr_num
                 and not exists (select 1
                                 from twbretr
                                 where twbretr_cntr_num = b.twbcntr_num))                   monto_mat
--             ,(select sum(TBRACCD_AMOUNT)
--               from TBRACCD
--               where TBRACCD_DETAIL_CODE in (select TBBDETC_DETAIL_CODE
--                                             from TBBDETC
--                                             where TBBDETC_DCAT_CODE = 'TUI'
--                                               and TBBDETC_TYPE_IND = 'C')
--                and TBRACCD_PIDM = twbcntr_pidm
--                and TBRACCD_TERM_CODE = twbcntr_term_code)                                  monto_ara
             ,(select sum( abs(twrdotr_part_amount)*sign(tbraccd_amount) )
               from tbbdetc ,tbraccd ,twbdocu ,twrdotr ,twbcntr b
               where tbbdetc_detail_code = tbraccd_detail_code
                 and tbbdetc_type_ind = 'C'
                 and tbbdetc_dcat_code = 'TUI'
                 and tbraccd_pidm = twrdotr_pidm
                 and tbraccd_tran_number = twrdotr_tran_number
                 and twbdocu_seq_num = twrdotr_docu_seq_num
                 and twbdocu_cntr_num = b.twbcntr_num
                 and twrdotr_orig_ind = 'O'
                 and b.twbcntr_num = a.twbcntr_num
                 and not exists (select 1
                                 from twbretr
                                 where twbretr_cntr_num = b.twbcntr_num))                   monto_ara
             , Becas.monto                                                                  monto_Beca
             , Becas.code                                                                   beca
             , Becas.descrip                                                                descrip
             , Becas.por                                                                    Por_Beca
        --     , Tipo
        --     , Grupo
        from twbcntr a, (
        select TWBDOCU_CNTR_NUM cntr, tbbestu_exemption_code code, tbbexpt_desc descrip, max(TBREDET_PERCENT) por, twbdocu_amount monto
                       from tbbestu, tbbexpt, tbredet, twbdocu
                       where TWBDOCU_PIDM = TBBESTU_PIDM
                         and TWBDOCU_TERM_CODE = TBBESTU_TERM_CODE
                         and TWBDOCU_DOCU_NUM = TBBESTU_EXEMPTION_CODE
                         and TBBEXPT_EXEMPTION_CODE = TBBESTU_EXEMPTION_CODE
                         and TBBEXPT_TERM_CODE = TBBESTU_TERM_CODE
                         and TBREDET_EXEMPTION_CODE = TBBESTU_EXEMPTION_CODE
                         and TBREDET_TERM_CODE = TBBESTU_TERM_CODE
                         group by TWBDOCU_CNTR_NUM, tbbestu_exemption_code, tbbexpt_desc, twbdocu_amount
                         union
                         select TWBDOCU_CNTR_NUM cntr, 'CUFT_'||TWRCUFT_NUM   code, 'Crdito UFT' descrip, TWRCUFT_PERCENT por, pk_MatCreUFT.f_montocobercred(TWRCUFT_NUM) monto
                         from TWRCUFT, twbdocu
                         where TWRCUFT_DOCU_SEQ_NUM is not null
                         and TWBDOCU_SEQ_NUM = TWRCUFT_DOCU_SEQ_NUM
                         union
                         select TWBDOCU_CNTR_NUM cntr, TWRCRAL_CRET_CODE      code, TWVCRET_DESC descrip, null por,                 TWBCRET_AMOUNT monto
                         from twbdocu, TWVCRET, TWBCRET, TWRCRAL
                         where TWBDOCU_PIDM = TWRCRAL_PIDM
                           and TWBDOCU_TERM_CODE = TWRCRAL_TERM_CODE
                           and TWBCRET_CODE = TWVCRET_CODE
                           and TWRCRAL_TERM_CODE = TWBCRET_TERM_CODE
                           and TWRCRAL_MAJR_CODE = TWBCRET_MAJR_CODE
                           and TWRCRAL_CRET_CODE = TWBCRET_CODE
                           and TWRCRAL_DOCU_SEQ_NUM is not null
                           and TWBDOCU_SEQ_NUM = TWRCRAL_DOCU_SEQ_NUM
                           ) Becas
        where twbcntr_status_ind = 'A'
          and Becas.cntr = twbcntr_num
          and not exists (select 1
                          from twbretr
                          where twbretr_cntr_num = twbcntr_num)
        )
  where (programa = vsProg or vsProg is null)
    --and (stvadmt_code = vsVia or vsVia is null)
    and (code_nuevo_antiguo = vsTyAl or vsTyAl is null)
    and (periodo like (vsYear||'%') or vsYear is null)
    and (contrato = vsCont or vsCont is null)
    order by pidm;

BEGIN

   IF Pk_Login.F_ValidacionDeAcceso (pk_login.vgsUSR)
   THEN
      RETURN;
   END IF;

    /* Parmetros */
    --Se busca el valor de la cookie (parmetro) para asignarlo al filtro del query.
    vsProg  := pk_ObjHtml.getValueCookie ('psProgr');
    vsVia  := pk_ObjHtml.getValueCookie ('psVia');
    vsTyAl   := pk_ObjHtml.getValueCookie ('psTiPo');
    vsYear   := pk_ObjHtml.getValueCookie ('psYear');
    vsCont   := pk_ObjHtml.getValueCookie ('psCont');

  -- Nmero de columnas de la tabla --
   tabColumna.EXTEND (vnColumnas);

   /* Encabezado de las columnas */
   tabColumna (1) := 'RUT Beneficiado';
   tabColumna (2) := 'DV RUT';
   tabColumna (3) := 'RUT Def';
   tabColumna (4) := 'ID';
   tabColumna (5) := 'Alumno';
   tabColumna (6) := 'Programa';
   tabColumna (7) := 'Periodo Ingreso';
   tabColumna (8) := 'Nuevo/Antiguo';
   tabColumna (9) := 'Condicin';
   tabColumna (10) := 'Periodo Matricula';
   tabColumna (11) := 'Contrato';
   tabColumna (12) := 'Monto Contrato';
   tabColumna (13) := 'Monto Matricula';
   tabColumna (14) := 'Monto Arancel';
   tabColumna (15) := 'Monto Beneficio';
   tabColumna (16) := 'Beneficio';
   tabColumna (17) := 'Descripcin Beneficio';
   tabColumna (18) := 'Porcentaje Beneficio';

      FOR regRep IN cuABCDE(vsProg, vsVia, vsTyAl, vsYear, vsCont) LOOP
          IF vnRow = 0 THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag);
             vsInicioPag := 'SALTO';
             vnRow  := 0;
          END IF;

          htp.p(
          '<tr>
          <td valign="top">'||regRep.rut_beneficiado||'</td>
          <td valign="top">'||regRep.dv_rut||'</td>
          <td valign="top">'||regRep.rut_def||'</td>
          <td valign="top">'||regRep.id_al||'</td>
          <td valign="top">'||regRep.nombre||'</td>
          <td valign="top">'||regRep.programa||'</td>
          <td valign="top">'||regRep.periodo_ing||'</td>
          <td valign="top">'||regRep.nuevo_antiguo||'</td>
          <td valign="top">'||regRep.condicion||'</td>
          <td valign="top">'||regRep.periodo||'</td>
          <td valign="top">'||regRep.contrato||'</td>
          <td valign="top">'||regRep.monto_cntr||'</td>
          <td valign="top">'||regRep.monto_mat||'</td>
          <td valign="top">'||regRep.monto_ara||'</td>
          <td valign="top">'||regRep.monto_Beca||'</td>
          <td valign="top">'||regRep.beca||'</td>
          <td valign="top">'||regRep.descrip||'</td>
          <td valign="top">'||regRep.Por_Beca||'</td>');

          vnExists   := 1;
          vnRow      := vnRow + 1;
      END LOOP;

   IF vnExists = 0
   THEN
      HTP.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- es omitido el encabezado del reporte pero se agrega el salto de pagina
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
   END IF;

   HTP.p ('</table><br/></body></html>');
EXCEPTION
   WHEN OTHERS
   THEN
      HTP.P (SQLERRM);
END PWABCDE;
/


DROP PUBLIC SYNONYM PWABCDE;

CREATE PUBLIC SYNONYM PWABCDE FOR BANINST1.PWABCDE;


GRANT EXECUTE ON BANINST1.PWABCDE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWABCDE TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWABCDE TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWABCDE TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWABCDE TO WWW2_USER;
DROP PROCEDURE BANINST1.PWABWMNU;

CREATE OR REPLACE PROCEDURE BANINST1.PWABWMNU(psName    VARCHAR2,
                                              psTitle   VARCHAR2 DEFAULT NULL,
                                              psBackURL VARCHAR2 DEFAULT NULL,
                                              psRoles   VARCHAR2 DEFAULT NULL
                                             ) IS

/*
          TAREA: Registrar las aplicaciones WEB en el SSB
          AUTOR: GEPC
          FECHA: 03/02/2010

   Modificacion: 11/02/2010
                 GEPC
                 * Se agrego la variable "vsProceso" por que no se obtenia correctamente el nombre
                   del proceso del parametro "psName" en el caso de que un objeto sea un "procedure"

   Modificacion: 15/02/2010
                 GEPC
                 * Se actualizo que la "validacin de acceso" no este en comentarios.


*/

  TYPE reg_Colum IS RECORD(Text VARCHAR2(4000));

  TYPE tableRows IS TABLE OF reg_Colum INDEX BY BINARY_INTEGER;

  tabText    tableRows;
  vnRows     INTEGER        := 0;
  vnLine     INTEGER        := NULL;
  vsError    VARCHAR2(4000) := NULL;
  vsProceso  VARCHAR2(100)  := NULL;
  vsOwner    VARCHAR2(32)   := NULL;
  vsBKP      VARCHAR2(10)   := NULL;
  vsBackLink VARCHAR2(20)   := 'Regresar al Men';
  vsBackInd  VARCHAR2(1)    := 'Y';
  vsRoles    VARCHAR2(500)  := psRoles;
  vsRol      VARCHAR2(30)   := NULL;

  cdSysdate CONSTANT DATE        := SYSDATE;
  csN       CONSTANT VARCHAR2(1) := 'N';
  csL       CONSTANT VARCHAR2(1) := 'L';
  csY       CONSTANT VARCHAR2(1) := 'Y';
  csS       CONSTANT VARCHAR2(1) := 'S';
  csOK      CONSTANT VARCHAR2(2) := 'OK';

  vbSinCmnr BOOLEAN        := TRUE;

  CURSOR cuComentario(vnLinea INTEGER) IS
         SELECT TEXT
            FROM DBA_SOURCE
           WHERE TYPE IN ('PROCEDURE','PACKAGE BODY')
             AND NAME  = vsProceso
             AND OWNER = 'BANINST1'
             AND LINE  < vnLinea;

  procedure RegistraEtapa(psAccion varchar2 default null) is

  begin

      update gwrasgr
         set gwrasgr_accion = psAccion,
             gwrasgr_error  = vsError
       where gwrasgr_new   = vsProceso
         and gwrasgr_old   = psName
         and gwrasgr_etapa = 'Registro en SSB';

      commit;

  end RegistraEtapa;

  BEGIN
      IF psBackURL IS NULL THEN
         vsBackLink := NULL;
         vsBackInd  := csN;
      END IF;

      SELECT UPPER(SUBSTR(psName,1,DECODE(INSTR(psName,'.')-1,-1,LENGTH(psName),INSTR(psName,'.')-1)))
        INTO vsProceso
        FROM DUAL;

      vsBKP := 'BK001';
      --Verifica que el proceso este valido
      BEGIN
          SELECT OWNER
            INTO vsOwner
            FROM DBA_OBJECTS
           WHERE OWNER        = 'BANINST1'
             AND OBJECT_TYPE IN ('PROCEDURE','PACKAGE BODY')
             AND STATUS       = 'VALID'
             AND OBJECT_NAME  = vsProceso;
      EXCEPTION
          WHEN NO_DATA_FOUND THEN
               RAISE_APPLICATION_ERROR(-20091, 'OPERACIn INTERRUMPIDA: Tu aplicacin causo un error en la compilacin.');
               RETURN;
      END;

      vsBKP := 'BK002';
      --Verifica que el proceso se una aplicacin WEB
      BEGIN
          SELECT LINE
            INTO vnLine
            FROM DBA_SOURCE
           WHERE (   REPLACE(UPPER(LTRIM(TEXT)),' ',NULL) LIKE 'IFPK_LOGIN.F_VALIDACIONDEACCESO(VGSUSR)THENRETURN;ENDIF;%'
                  OR REPLACE(UPPER(LTRIM(TEXT)),' ',NULL) LIKE 'IFPK_LOGIN.F_VALIDACIONDEACCESO(PK_LOGIN.VGSUSR)THENRETURN;ENDIF;%'
                  OR REPLACE(UPPER(LTRIM(TEXT)),' ',NULL) LIKE 'IFNOTTWBKWBIS.F_VALIDUSER(GLOBAL_PIDM)THENRETURN;ENDIF;%'
                 )
             AND TYPE IN ('PROCEDURE','PACKAGE BODY')
             AND NAME  = vsProceso
             AND OWNER = 'BANINST1';
      EXCEPTION
          WHEN TOO_MANY_ROWS THEN
               NULL;
          WHEN NO_DATA_FOUND THEN
               RAISE_APPLICATION_ERROR(-20091, 'OPERACIN INTERRUMPIDA: No estas validando el acceso del usuario.');
               RETURN;
      END;

      vsBKP := 'BK003';
      -- Se busca que la validacin de acceso no este comentada
      FOR regCom IN cuComentario(vnLine) LOOP
          vnRows := vnRows + 1;

          tabText(vnRows).Text := regCom.Text;
      END LOOP;

      vsBKP := 'BK004';
      WHILE vbSinCmnr LOOP
            IF    vnRows = 0 THEN
                  vbSinCmnr := FALSE;
            ELSIF INSTR(tabText(vnRows).Text,'*/') > 0 THEN
                  vbSinCmnr := FALSE;
            ELSIF INSTR(tabText(vnRows).Text,'/*') > 0 THEN
                  vbSinCmnr := FALSE;

                  RAISE_APPLICATION_ERROR(-20091, 'OPERACIN INTERRUMPIDA: No estas validando el aecceso del usuario.');
                  RETURN;
            END IF;

            vnRows := vnRows - 1;
      END LOOP;

      vsBKP := 'BK005';
      --registro del nombre del procedimiento o paquete en el SSB
      BEGIN
          INSERT INTO GWRASGR(GWRASGR_NEW,
                              GWRASGR_OLD,
                              GWRASGR_ETAPA
                             )
                       VALUES(vsProceso,
                              psName,
                              'Registro en SSB'
                              );

          COMMIT;

          INSERT INTO TWGBWMNU
          (
           TWGBWMNU_NAME,           TWGBWMNU_DESC,               TWGBWMNU_BACK_MENU_IND,
           TWGBWMNU_MODULE,         TWGBWMNU_ENABLED_IND,        TWGBWMNU_INSECURE_ALLOWED_IND,
           TWGBWMNU_ACTIVITY_DATE,  TWGBWMNU_CACHE_OVERRIDE,     TWGBWMNU_SOURCE_IND,
           TWGBWMNU_ADM_ACCESS_IND, TWGBWMNU_PAGE_TITLE,         TWGBWMNU_HEADER,
           TWGBWMNU_BACK_URL,       TWGBWMNU_BACK_LINK,          TWGBWMNU_MAP_TITLE
          )
          VALUES
          (
           psName,                 NVL(psTitle,'Grupo integer'), vsBackInd,
           'AGS',                  csY,                          csN,
           cdSysdate,              csS,                          csL,
           csN,                    psTitle,                      psTitle,
           psBackURL,              vsBackLink,                   psTitle
          );

          vsBKP := 'BK006';
          RegistraEtapa(csOK);

      EXCEPTION
          WHEN DUP_VAL_ON_INDEX THEN
               vsError := SQLERRM;

               RegistraEtapa;

          WHEN OTHERS THEN
               vsError := SQLERRM;

               RegistraEtapa;
      END;

      --Registro de roles asociados
      WHILE INSTR(vsRoles,',') >0 LOOP
            vsRol := SUBSTR(vsRoles,1, INSTR(vsRoles,',')-1);

            BEGIN
                INSERT INTO TWGRWMRL
                (TWGRWMRL_NAME,          TWGRWMRL_ROLE,
                 TWGRWMRL_ACTIVITY_DATE, TWGRWMRL_SOURCE_IND
                )
                VALUES
                (psName,                 vsRol,
                 cdSysdate,              csL
                );

                vsBKP := 'BK007';
                RegistraEtapa(csOK);
            EXCEPTION
                WHEN DUP_VAL_ON_INDEX THEN
                     vsError := SQLERRM;

                     RegistraEtapa;

                WHEN OTHERS THEN
                     vsError := SQLERRM;

                     RegistraEtapa;
            END;

            vsRoles := SUBSTR(vsRoles,INSTR(vsRoles,',')+1);
      END LOOP;

      vsBKP := 'BK008';
      --Realiza la asignacin del "GRANT EXECUTE" al usuario WEB_BAN_....
      PWAGRAN(vsProceso);

  EXCEPTION
      WHEN OTHERS THEN
           RAISE_APPLICATION_ERROR(-20091, vsBKP||' - '||SQLERRM);
  END PWABWMNU;
/


DROP PUBLIC SYNONYM PWABWMNU;

CREATE PUBLIC SYNONYM PWABWMNU FOR BANINST1.PWABWMNU;


GRANT EXECUTE ON BANINST1.PWABWMNU TO BANSECR;

GRANT EXECUTE ON BANINST1.PWABWMNU TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWABWMNU TO WWW2_USER;
DROP PROCEDURE BANINST1.PWACLSD;

CREATE OR REPLACE PROCEDURE BANINST1.PWACLSD(psNombreFuncion VARCHAR2 DEFAULT NULL,
                                             psTitulo        VARCHAR2 DEFAULT NULL,
                                             psMensaje1      VARCHAR2 DEFAULT NULL,
                                             psMensaje2      VARCHAR2 DEFAULT NULL,
                                             psEvento        VARCHAR2 DEFAULT NULL
                                            ) IS

/*
   AUTOR: GEPC
   FECHA: 22/03/2010
   TAREA: Craea la funcin en lenguale JavaSCript "paginaSalir", para reabrir una pagina HTML
          y no crear una sesion en el servidor WEB y en la instancia de base de datos.
  MODULO: GENERAL

*/

  vsTitulo   VARCHAR2(1000) := 'Salir de la aplicacin';
  vsMensaje1 VARCHAR2(1000) := 'La aplicacin se esta cerrando...';

  BEGIN
      vsTitulo   := NVL(psTitulo,  vsTitulo);
      vsMensaje1 := NVL(psMensaje1, vsMensaje1);

      htp.p(
      'function paginaSalir'||psNombreFuncion||'() {
      document.open();
      document.writeln("<html><head><title>'||vsTitulo||'<\/title>");

      document.writeln("<meta http-equiv=''Expires''       CONTENT=''0''>");
      document.writeln("<meta http-equiv=''Cache-Control'' CONTENT=''no-cache''>");
      document.writeln("<meta http-equiv=''Pragma''        CONTENT=''no-cache''>");
      document.writeln("<link rel=''stylesheet'' href=''\/css\/web_defaultapp.css'' TYPE=''text\/css''>");
      document.writeln("<script type=''text/javaScript''><!--");
      document.writeln("javascript:window.history.forward(1);");

      document.writeln("function fCerrarVentana() {");'
      );

      IF psEvento IS NULL THEN
         htp.p(
         'document.writeln("setTimeout(''fClose()'',3000);");'
         );
      ELSE
         htp.p(
         'document.writeln("fAplicacion();");'
         );
      END IF;

      htp.p(
      'document.writeln("}");

      document.writeln("function fClose() {");
      document.writeln("close();");
      document.writeln("}");

      document.writeln("function DerechosReservados() {");
      document.writeln("if (event.button==2) {");
      document.writeln("alert(''Operacin deshabilitada.'');");
      document.writeln("}");
      document.writeln("}");

      document.writeln("function fAplicacion() {");
      document.writeln("setTimeout(\"fAbriendo()\",3000);");
      document.writeln("}");

      document.writeln("function fAbriendo() {");
      document.writeln("document.frmMenuAplicacion.submit();");
      document.writeln("}");

      //document.writeln("document.onmousedown=DerechosReservados;");
      document.writeln("\/\/--><\/script>");
      document.writeln("<\/head><body bgcolor=''#ffffff'' style=''cursor:wait;'' onLoad=''fCerrarVentana();''><br\/><br\/><br\/><br\/><br\/>");

      document.writeln("<table border=''0'' width=''100%'' align=''center'' cellpadding=''0'' cellspacing=''0''>");
      document.writeln("<tr><th align=''left'' valign=''bottom''>");
      document.writeln("'||vsTitulo||'<\/th><\/tr>");
      document.writeln("<\/table>");
      document.writeln("<br\/>");
      document.writeln("<table class=''plaintable'' width=''100%'' cellSpacing=''0'' cellPadding=''0'' border=''0''>");
      document.writeln("<tr class=''trSeparado4''>");
      document.writeln("<td class=''bg3'' width=''100%''>");
      document.writeln("<img src=''/wtlgifs/web_transparent.gif'' hspace=''0'' vspace=''0'' border=''0'' height=''3'' width=''10''></td>");
      document.writeln("</tr>");
      document.writeln("</table>");
      document.writeln("<br\/>");

      document.writeln("<p><center><font size=''6''>'||vsMensaje1||'<\/font><\/center><\/p>");'
      );

      IF psMensaje2 IS NOT NULL THEN
         htp.p(
         'document.writeln("<p><center><font size=''6''>'||psMensaje2||'<\/font><\/center><\/p>");'
         );
      END IF;

      htp.p(
      'document.writeln("<br\/>");
      document.writeln("<table border=''0'' width=''100%'' align=''center'' cellpadding=''0'' cellspacing=''0''>");
      document.writeln("<tr><th align=''right'' valign=''bottom''>");

      document.writeln("<\/th><\/tr>");
      document.writeln("<\/table>");
      document.writeln("<br\/>");

      document.writeln("<form name=''frmMenuAplicacion'' action=''pk_AsignaAplicacion.P_Aplicacion'' target=''_top'' method=''post''>");
      document.writeln("<input type=''hidden'' name=''psParametro'' value=''ADM'' \/>");
      document.writeln("<\/form>");

      document.writeln("<br\/>");
      document.writeln("<table class=''plaintable'' width=''100%'' cellSpacing=''0'' cellPadding=''0'' border=''0''>");
      document.writeln("<tr class=''trSeparado4''>");
      document.writeln("<td class=''bg3'' width=''100%''>");
      document.writeln("<img src=''/wtlgifs/web_transparent.gif'' hspace=''0'' vspace=''0'' border=''0'' height=''3'' width=''10''></td>");
      document.writeln("</tr>");
      document.writeln("</table>");

      document.writeln("<table border=''0'' width=''100%'' align=''center'' cellpadding=''0'' cellspacing=''0''>");
      document.writeln("<tr><th align=''right'' valign=''bottom''>");
      document.writeln("<img src=''\/imagenes\/UFT.gif''>");
      document.writeln("<\/th><\/tr>");
      document.writeln("<\/table>");
      document.writeln("<br\/>");

      document.writeln("<\/body><\/html>");
      document.close();

      } //paginaSalir'
      );
  END PWACLSD;
/


DROP PUBLIC SYNONYM PWACLSD;

CREATE PUBLIC SYNONYM PWACLSD FOR BANINST1.PWACLSD;
DROP PROCEDURE BANINST1.PWACREV;

CREATE OR REPLACE PROCEDURE BANINST1.PWACREV IS
/*
    Tarea : Copia los criterios de evaluacin del curso a los alumnos.
            Esto debe hacerse por los lumnos que se inscribieron despues de haber sido
            asignados los criterios de evaluacin.
    Autor : GEPC
    Fecha : 02/12/2010

*/

  TYPE reg_Crn IS RECORD (Crnn SWRXLST.SWRXLST_CRN%TYPE,
                          Grup SWRXLST.SWRXLST_XLST_GROUP%TYPE,
                          Term SWRXLST.SWRXLST_TERM_CODE%TYPE
                         );

  TYPE tableCrn IS TABLE OF reg_Crn INDEX BY BINARY_INTEGER;

  tabCrn   tableCrn;
  vnExiste INTEGER        := 0;
  vnRow    INTEGER        := 0;
  vsError  VARCHAR2(4000) := NULL;
  vsBreak  VARCHAR2(10)   := 'BKP01';

--P_JobCriterioEvaluacion(

  csA        CONSTANT VARCHAR2(1) := 'A';
  csM        CONSTANT VARCHAR2(1) := 'M';
  csS        CONSTANT VARCHAR2(1) := 'S';
  csRE       CONSTANT VARCHAR2(2) := 'RE';
  csRW       CONSTANT VARCHAR2(2) := 'RW';
  csOE       CONSTANT VARCHAR2(2) := 'OE';
  cs201010   CONSTANT VARCHAR2(6) := '201010';
  csFixReg   CONSTANT VARCHAR2(7) := 'FIX_REG';
  csESCALALC CONSTANT VARCHAR2(8) := 'ESCALALC';

  cdSysDate  CONSTANT DATE        := SYSDATE;

  CURSOR cuCriterioAlumno IS
         SELECT SHRGCOM_TERM_CODE AS Term,
                SHRGCOM_CRN       AS Crnn,
                SFRSTCR_PIDM      AS Pidm,
                SHRGCOM_ID        AS Iddd,
                SHRGCOM_DATE      AS GcoD
           FROM SHRGCOM,
                SFRSTCR
          WHERE SHRGCOM_TERM_CODE = SFRSTCR_TERM_CODE
            AND SHRGCOM_CRN       = SFRSTCR_CRN
            AND NOT EXISTS (SELECT NULL
                              FROM SHRMRKS
                             WHERE SHRMRKS_GCOM_ID   = SHRGCOM_ID
                               AND SHRMRKS_PIDM      = SFRSTCR_PIDM
                               AND SHRMRKS_CRN       = SFRSTCR_CRN
                               AND SHRMRKS_TERM_CODE = SFRSTCR_TERM_CODE
                           )
            AND SFRSTCR_RSTS_CODE IN (csRE,csRW)
            AND SHRGCOM_TERM_CODE >= cs201010;

  -- Cursos simultaneos con status activo
  --                    que tienen alumnos inscritos
  --                    no tiene registrados los criterios de evaluacin
  --                    y el curso maestro tiene criterios de evaluacin
  CURSOR cuSimul IS
         SELECT A.SWRXLST_CRN        AS Crnn,
                A.SWRXLST_XLST_GROUP AS Grup,
                A.SWRXLST_TERM_CODE  AS Term
           FROM (SELECT B.SWRXLST_CRN        AS Crnn,
                        B.SWRXLST_XLST_GROUP AS Grup,
                        B.SWRXLST_TERM_CODE  AS Term
                   FROM SWRXLST B, SHRGCOM C
                  WHERE C.SHRGCOM_TERM_CODE  = B.SWRXLST_TERM_CODE
                    AND C.SHRGCOM_CRN        = B.SWRXLST_CRN
                    AND B.SWRXLST_TYPE       = csM
                    AND B.SWRXLST_TERM_CODE >= cs201010
                ) Maestro,
                SWRXLST A
          WHERE A.SWRXLST_XLST_GROUP = Maestro.Grup
            AND A.SWRXLST_TERM_CODE  = Maestro.Term
            AND     EXISTS (SELECT NULL
                              FROM SFRSTCR,
                                   SSBSECT
                             WHERE SSBSECT_TERM_CODE  = A.SWRXLST_TERM_CODE
                               AND SSBSECT_CRN        = A.SWRXLST_CRN
                               AND SFRSTCR_TERM_CODE  = SSBSECT_TERM_CODE
                               AND SFRSTCR_CRN        = SSBSECT_CRN
                               AND SSBSECT_SSTS_CODE  = csA
                               AND SFRSTCR_RSTS_CODE IN (csRE,csRW)
                               AND SSBSECT_TERM_CODE >= cs201010
                           )
            AND NOT EXISTS (SELECT NULL
                              FROM SHRGCOM
                             WHERE SHRGCOM_TERM_CODE  = A.SWRXLST_TERM_CODE
                               AND SHRGCOM_CRN        = A.SWRXLST_CRN
                               AND SHRGCOM_TERM_CODE >= cs201010
                           )
            AND SWRXLST_TYPE       = csS
            AND SWRXLST_TERM_CODE >= cs201010;

  --obtine los cursos maestros por grupo y periodo
  CURSOR cuMaestro(psTerm VARCHAR2,
                   psGrup VARCHAR2
                  ) IS
         SELECT SHRGCOM_NAME           AS Name,
                SHRGCOM_WEIGHT         AS Weight,
                SHRGCOM_TOTAL_SCORE    AS Score,
                SHRGCOM_INCL_IND       AS incl,
                SHRGCOM_DATE           AS Daet,
                SHRGCOM_SEQ_NO         AS Seq,
                SHRGCOM_DESCRIPTION    AS Descr,
                SHRGCOM_GRADE_SCALE    AS Escala,
                SHRGCOM_MIN_PASS_SCORE AS Minp,
                SHRGCOM_TERM_CODE      AS Term,
                SHRGCOM_CRN            AS Crn,
                SHRGCOM_ID             as gcomId
           FROM SHRGCOM C,SWRXLST A
          WHERE SHRGCOM_TERM_CODE  = SWRXLST_TERM_CODE
            AND SHRGCOM_CRN        = SWRXLST_CRN
            AND SWRXLST_TYPE       = csM
            AND SWRXLST_XLST_GROUP = psGrup
            AND SWRXLST_TERM_CODE  = psTerm;

  CURSOR cuAlumnos(psTerm VARCHAR2,
                   psNrc  VARCHAR2
                  ) IS
         SELECT SFRSTCR_PIDM AS Pidm
           FROM SFRSTCR
          WHERE SFRSTCR_RSTS_CODE IN (csRE,csRW)
            AND SFRSTCR_CRN        = psNrc
            AND SFRSTCR_TERM_CODE  = psTerm;

  BEGIN
      --Seguardan datos antes de procesar la informacin
      FOR regSim IN cuSimul LOOP
          vnRow := vnRow + 1;

          tabCrn(vnRow).Crnn := regSim.Crnn;
          tabCrn(vnRow).Grup := regSim.Grup;
          tabCrn(vnRow).Term := regSim.Term;
      END LOOP;

      vsBreak := 'BKP02';

      --sebuscan los criterios de evaluacin del curso maestro
      FOR vnI IN 1..vnRow LOOP
          -- se actualiza la escala de calificacin del curso simultaneo
          BEGIN
              UPDATE SSBSECT
                 SET SSBSECT_GSCH_NAME = csESCALALC
               WHERE SSBSECT_TERM_CODE = tabCrn(vnI).Term
                 AND SSBSECT_CRN       = tabCrn(vnI).Crnn;
          EXCEPTION
              WHEN OTHERS THEN
                   NULL;
          END;

          vsBreak := 'BKP03';

          FOR regMast IN cuMaestro(tabCrn(vnI).Term, tabCrn(vnI).Grup) LOOP
              vnExiste := 0;

              -- se busca el criterio de evaluacin para ya no agregarlo
              SELECT COUNT(1)
                INTO vnExiste
                FROM SHRGCOM
               WHERE SHRGCOM_TERM_CODE = regMast.Term
                 AND SHRGCOM_CRN       = tabCrn(vnI).Crnn --CRN sumultaneo
                 AND SHRGCOM_NAME      = regMast.Name
                 AND SHRGCOM_SEQ_NO    = regMast.Seq;

              IF vnExiste = 0 THEN
                 BEGIN
                     INSERT INTO SHRGCOM
                     (
                      SHRGCOM_TERM_CODE, SHRGCOM_CRN,         SHRGCOM_ID,          SHRGCOM_NAME,
                      SHRGCOM_WEIGHT,    SHRGCOM_TOTAL_SCORE, SHRGCOM_INCL_IND,    SHRGCOM_DATE,
                      SHRGCOM_SEQ_NO,    SHRGCOM_DESCRIPTION, SHRGCOM_GRADE_SCALE, SHRGCOM_MIN_PASS_SCORE
                     )
                     VALUES
                     (
                      regMast.Term,      tabCrn(vnI).Crnn,    regMast.gcomId,      regMast.Name,
                      regMast.Weight,    regMast.Score,       regMast.Incl,        regMast.Daet,
                      regMast.Seq,       regMast.Descr,       regMast.Escala,      regMast.Minp
                     );
                 EXCEPTION
                     WHEN DUP_VAL_ON_INDEX THEN
                          NULL;
                     WHEN OTHERS THEN
                          NULL;
                 END;

                 vsBreak := 'BKP04';

                 --registra el componente a los alumnos del curso
                 FOR regAlu IN cuAlumnos(regMast.Term, tabCrn(vnI).Crnn) LOOP
                     BEGIN
                         INSERT INTO SHRMRKS
                         (
                          SHRMRKS_TERM_CODE, SHRMRKS_CRN,      SHRMRKS_PIDM, SHRMRKS_GCOM_ID,
                          SHRMRKS_GCOM_DATE, SHRMRKS_GCHG_CODE
                         )
                         VALUES
                         (
                          regMast.Term,      tabCrn(vnI).Crnn, regAlu.Pidm,  regMast.gcomId,
                          TRUNC(cdSysDate),  csOE
                         );
                     EXCEPTION
                         WHEN DUP_VAL_ON_INDEX THEN
                              NULL;
                         WHEN OTHERS           THEN
                              NULL;
                     END;
                 END LOOP;
              END IF;

              vsBreak := 'BKP05';

          END LOOP;

          COMMIT;

      END LOOP;

      vsBreak := 'BKP06';

      --introduce los criterios de evaluacin al laumno que se registro despues que profesor
      --capturo los criterios de evaluacin
      FOR regCrAl IN cuCriterioAlumno LOOP
          NULL;

          BEGIN
              INSERT INTO SHRMRKS
              (
               SHRMRKS_TERM_CODE, SHRMRKS_CRN,           SHRMRKS_PIDM,
               SHRMRKS_GCOM_ID,   SHRMRKS_ACTIVITY_DATE, SHRMRKS_USER_ID,
               SHRMRKS_GCOM_DATE, SHRMRKS_GCHG_CODE
              )
              VALUES
              (
               regCrAl.Term,      regCrAl.CRNn,          regCrAl.Pidm,
               regCrAl.IDdd,      cdSysDate,             csFixReg,
               regCrAl.GcoD,      csOE
              );
          EXCEPTION
              WHEN DUP_VAL_ON_INDEX  THEN
                   NULL;
              WHEN OTHERS           THEN
                   NULL;
          END;

      END LOOP;

      COMMIT;

      vsBreak := 'BKP07';

      -- Se agrega el update para actualizar la escala de calificaciones a cursos que les hace falta
      -- y por ese motivo no pueden rolarse a historia acadmica
      UPDATE SSBSECT
         SET SSBSECT_GSCH_NAME = csESCALALC
       WHERE EXISTS (SELECT NULL
                       FROM SHRGCOM
                      WHERE SHRGCOM_TERM_CODE  = SSBSECT_TERM_CODE
                        AND SHRGCOM_CRN        = SSBSECT_CRN
                        AND SHRGCOM_TERM_CODE >= cs201010
                    )
         AND SSBSECT_GSCH_NAME IS NULL
         AND SSBSECT_TERM_CODE >= cs201010;


      COMMIT;

  EXCEPTION
      WHEN OTHERS THEN
           RAISE;

  END PWACREV;
/
DROP PROCEDURE BANINST1.PWADPNC;

CREATE OR REPLACE PROCEDURE BANINST1.PWADPNC(psObject VARCHAR2) IS

/*
          TAREA: Script para generar el archivo que compilara los respaldos
          FECHA: 08/03/2010
          AUTOR: GEPC
         MODULO: General
  OBSERVACIONES:
                 * "A" identifica la apertura del spool para obtener la bitacora de instalacin (SPOOL RUTA\)
                   "Z" identifica el cierre del archivo de bitacora (SPOOL OFF)
                   "E" sentencias "SET" para definir las "Caracteristicas de compilacin"
                   "Y" sentencia "SET FEEDBACK ON" para compilar las dependencias y poder observar posibles errores
                   "I" identifica la instruccin para compilar el respaldo
                   "D" identifica las dependencias de los respaldos para ser compilados.
                   "W" identifica los objetos de pendientes de las dependencias de los respaldos.
                   "X" sentencias "SET" para el fin del script "compilador de respaldos"

                 * En el script "install.sql" agregar la instruccin "@generaCompilador.SQL &&RUTA"
                   despues de haber realizado el respaldo de objetos.

                 * En el script "respaldo.sql" agregar las instruccines
                      -- BEGIN
                      -- PWADPNC('&2');
                      -- END;
                      -- /
                   despues de la sentencia "SPOOL OFF;"


   Modificacion: 17/03/2010
                 GEPC
                 * Se agrego la columna "GWBDPNC_ORDEN" para establecer el orden de ejecucin de los procesos

   Modificacion: 18/03/2010
                 GEPC
                 * Se establece un orden para la seccin "X" que corresponde al fin del script
                 * Se agrega el filtro 'INVALID' en la obtencin de las dependencias, para que solo
                   se compilen la dependencias invalidas.

   Modificacion: 26/11/2012
                 GVH
                 * Se cambian los separadores de directorios a diagonales normales para que se soporte la ejecucion en UNIX
                 * Se cambian los saltos de linea al estandar UNIX lf \n CHR(10) en lugar de CR \r CHR(13)



*/

  vsProceso VARCHAR2(100) := NULL;
  vnOrden   INTEGER       := NULL;

  CURSOR cuDependencia IS
         SELECT GWBDPNC_DEPENDENCIA Depend
           FROM GWBDPNC
          WHERE GWBDPNC_TIPO = 'D';

  BEGIN
      SELECT UPPER(SUBSTR(psObject,1,DECODE(INSTR(psObject,'.')-1,-1,LENGTH(psObject),INSTR(psObject,'.')-1)))
        INTO vsProceso
        FROM DUAL;

      SELECT NVL(MAX(GWBDPNC_ORDEN),0)+1
        INTO vnOrden
        FROM GWBDPNC;

      ------OBTENER LA SALIDA AL RESTITUIR LA COMPILACION
      INSERT INTO GWBDPNC(GWBDPNC_OBJECT,GWBDPNC_TIPO)
      SELECT spoo.Code1, spoo.Code2
        FROM (SELECT 'SPOOL RUTA/Respaldo'||TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')||'.txt' Code1,'A' Code2
                FROM DUAL
               UNION ALL
              SELECT 'SPOOL OFF','Z'
                FROM DUAL
             ) spoo
       WHERE NOT EXISTS (SELECT NULL
                          FROM GWBDPNC
                         WHERE GWBDPNC_TIPO = spoo.Code2
                       );

      ------CARACTERISTICAS DE LA COMPILACION
      INSERT INTO GWBDPNC(GWBDPNC_OBJECT,GWBDPNC_TIPO)
      SELECT setss.Code1,setss.Code2
        FROM (SELECT 'SET ECHO          OFF' Code1,'E' Code2 FROM DUAL UNION ALL
              SELECT 'SET FEEDBACK      OFF'      ,'E' FROM DUAL UNION ALL
              SELECT 'SET VERIFY        OFF'      ,'E' FROM DUAL UNION ALL
              SELECT 'SET SHOWMODE      OFF'      ,'E' FROM DUAL UNION ALL
              SELECT 'SET PAGESIZE      0'        ,'E' FROM DUAL UNION ALL
              SELECT 'SET LINESIZE      1000'     ,'E' FROM DUAL UNION ALL
              SELECT 'SET LONG          900000'   ,'E' FROM DUAL UNION ALL
              SELECT 'SET LONGCHUNKSIZE 900000'   ,'E' FROM DUAL UNION ALL
              SELECT 'SET TRIMSPOOL     ON'       ,'E' FROM DUAL UNION ALL
              SELECT 'SET DEFINE        OFF'      ,'E' FROM DUAL
             ) setss
       WHERE NOT EXISTS (SELECT NULL
                           FROM GWBDPNC
                          WHERE GWBDPNC_TIPO = setss.Code2
                        );

      ------CARACTERISTICAS DE LA DEPENDENCIA
      INSERT INTO GWBDPNC(GWBDPNC_OBJECT,GWBDPNC_TIPO)
      SELECT setss.Code1,setss.Code2
        FROM (SELECT CHR(10)||'SET FEEDBACK ON'||CHR(10) Code1,'Y' Code2 FROM DUAL
             ) setss
       WHERE NOT EXISTS (SELECT NULL
                           FROM GWBDPNC
                          WHERE GWBDPNC_TIPO = setss.Code2
                        );

      ------OBJETOS A COMPILAR
      INSERT INTO GWBDPNC(GWBDPNC_OBJECT,GWBDPNC_TIPO,GWBDPNC_ORDEN)
      VALUES('PROMPT ***Restaurando '||psObject||CHR(10)||'@'||psObject||CHR(10)||'@propiedades.sql'||CHR(10),'I',vnOrden);

      ------OBJETOS DEPENDIENTES AL RESTAURAR COMPILACION
      INSERT INTO GWBDPNC(GWBDPNC_OBJECT,GWBDPNC_TIPO,GWBDPNC_DEPENDENCIA,GWBDPNC_TYPE_OBJECT)
      SELECT dependenc.Comp,
             'D',
             dependenc.Obje,
             dependenc.Typp
         FROM (SELECT CHR(10)||
                      'PROMPT ***DEPENDENCIA '||OBJECT_NAME||CHR(10)||
                      'ALTER '||REPLACE(OBJECT_TYPE,' BODY')||' '||
                      OWNER||'.'||OBJECT_NAME||' COMPILE;' Comp,
                      OBJECT_NAME                          Obje,
                      OBJECT_TYPE                          Typp
                 FROM PUBLIC_DEPENDENCY A,
                      ALL_OBJECTS       B
                WHERE REFERENCED_OBJECT_ID = (SELECT OBJECT_ID
                                                FROM ALL_OBJECTS
                                               WHERE OWNER        = 'BANINST1'
                                                 AND OBJECT_TYPE IN ('FUNCTION','PACKAGE','PROCEDURE','TRIGGER')
                                                 AND OBJECT_NAME  = vsProceso
                                             )
                  AND B.OBJECT_NAME       <> vsProceso
                  AND A.OBJECT_ID          = B.OBJECT_ID
                  AND B.STATUS             = 'INVALID'
                  AND NOT EXISTS (SELECT NULL
                                    FROM GWBDPNC
                                   WHERE GWBDPNC_DEPENDENCIA = B.OBJECT_NAME
                                     AND GWBDPNC_TIPO        = 'D'
                                 )
              ) dependenc;

      COMMIT;

      ------OBJETOS dependencias de los DEPENDIENTES AL RESTAURAR COMPILACION
      FOR regDep IN cuDependencia LOOP
          vsProceso := regDep.Depend;

          INSERT INTO GWBDPNC(GWBDPNC_OBJECT,GWBDPNC_TIPO,GWBDPNC_DEPENDENCIA,GWBDPNC_TYPE_OBJECT)
          SELECT dependenc.Comp,
                 'W',
                 dependenc.Obje,
                 dependenc.Typp
            FROM (SELECT CHR(10)||
                         'PROMPT ***DEPENDENCIA '||OBJECT_NAME||CHR(10)||
                         'ALTER '||REPLACE(OBJECT_TYPE,' BODY')||' '||
                         OWNER||'.'||OBJECT_NAME||' COMPILE;' Comp,
                         OBJECT_NAME                          Obje,
                         OBJECT_TYPE                          Typp
                    FROM PUBLIC_DEPENDENCY A,
                         ALL_OBJECTS       B
                   WHERE REFERENCED_OBJECT_ID = (SELECT OBJECT_ID
                                                   FROM ALL_OBJECTS
                                                  WHERE OWNER        = 'BANINST1'
                                                    AND OBJECT_TYPE IN ('FUNCTION','PACKAGE','PROCEDURE','TRIGGER')
                                                    AND OBJECT_NAME  = vsProceso
                                                )
                     AND B.OBJECT_NAME       <> vsProceso
                     AND A.OBJECT_ID          = B.OBJECT_ID
                     AND B.STATUS             = 'INVALID'
                     AND NOT EXISTS (SELECT NULL
                                       FROM GWBDPNC
                                      WHERE GWBDPNC_DEPENDENCIA = B.OBJECT_NAME
                                        AND GWBDPNC_TIPO        = 'W'
                                    )
                     AND NOT EXISTS (SELECT NULL
                                       FROM GWBDPNC
                                      WHERE GWBDPNC_DEPENDENCIA = B.OBJECT_NAME
                                        AND GWBDPNC_TIPO        = 'D'
                                    )
                 ) dependenc;

          COMMIT;
      END LOOP;

      ------SALIDA DEL ARCHIVO
      INSERT INTO GWBDPNC(GWBDPNC_OBJECT,GWBDPNC_TIPO,GWBDPNC_ORDEN)
      SELECT exits.Code1, exits.Code2, exits.Orden
        FROM (SELECT 'SET DEFINE ON' Code1,                    'X' Code2, 80 Orden FROM DUAL UNION ALL
              SELECT 'PROMPT',                                 'X', 81 FROM DUAL UNION ALL
              SELECT 'PROMPT GRACIAS :)',                      'X', 82 FROM DUAL UNION ALL
              SELECT 'PROMPT',                                 'X', 83 FROM DUAL UNION ALL
              SELECT 'PROMPT',                                 'X', 84 FROM DUAL UNION ALL
              SELECT 'PROMPT [ oprime ENTER para continuar ]', 'X', 85 FROM DUAL UNION ALL
              SELECT 'ACCEPT RESPALDO CHAR;',                  'X', 86 FROM DUAL UNION ALL
              SELECT 'PROMPT',                                 'X', 87 FROM DUAL UNION ALL
              SELECT 'SET TERM OFF',                           'X', 88 FROM DUAL UNION ALL
              SELECT 'DISCONNECT',                             'X', 89 FROM DUAL UNION ALL
              SELECT 'EXIT;',                                  'X', 90 FROM DUAL
             ) exits
       WHERE NOT EXISTS (SELECT NULL
                           FROM GWBDPNC
                          WHERE GWBDPNC_TIPO = exits.Code2
                        );

       COMMIT;

  END PWADPNC;
/


DROP PUBLIC SYNONYM PWADPNC;

CREATE PUBLIC SYNONYM PWADPNC FOR BANINST1.PWADPNC;


GRANT EXECUTE ON BANINST1.PWADPNC TO BANSECR;
DROP PROCEDURE BANINST1.PWADXCA;

CREATE OR REPLACE PROCEDURE BANINST1.PWADXCA (psReclDesc VARCHAR2)
IS
   vnRow         INTEGER := 0;
   vnExists      INTEGER := 0;
   vnColumnas    INTEGER := 30;
   vsProg        sgbstdn.sgbstdn_program_1%TYPE;
   vsPerio1      sgbstdn.sgbstdn_term_code_admit%TYPE;
   vsPerio2      sgbstdn.sgbstdn_term_code_admit%TYPE;
   tabColumna   Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla (1);
   vsInicioPag   VARCHAR2 (10) := NULL;

CURSOR cuReporte_Cambio (vsProg        sgbstdn.sgbstdn_program_1%TYPE,
                         vsPerio1      sgbstdn.sgbstdn_term_code_admit%TYPE,
                         vsPerio2      sgbstdn.sgbstdn_term_code_admit%TYPE)
  IS
  select smrprle_program
           , smrprle_program_desc
         , reg_nueing_per1
         , reg_nueing_per2
         , reg_anti_per1
         , reg_anti_per2
         , libre_per1
         , libre_per2
         , psu_ant_per1
         , psu_ant_per2
         , convalidacion_per1
         , convalidacion_per2
         , estu_extranjeros_per1
         , estu_extranjeros_per2
         , vespertino_per1
         , vespertino_per2
         , bach_ingles_per1
         , bach_ingles_per2
         , bach_frances_per1
         , bach_frances_per2
         , bach_aleman_per1
         , bach_aleman_per2
         , bach_artes_per1
         , bach_artes_per2
         , lt_otra_u_per1
         , lt_otra_u_per2
         , lt_uft_per1
         , lt_uft_per2
         , adm_med_per1
         , adm_med_per2
  from smrprle,
       /***** Regular Nuevo Ingreso per1 *****/
      (select prog_code, prog_des, sum(pidm) reg_nueing_per1
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select code_prog, pidm_g1, admt_peri, admt_code, nue_ant
                   from (select g1.sgbstdn_program_1         code_prog
                              , g1.sgbstdn_pidm              pidm_g1
                              , g1.sgbstdn_term_code_admit   admt_peri
                              , g1.sgbstdn_admt_code         admt_code
                              , fwatyaluft(g1.sgbstdn_pidm, g1.sgbstdn_term_code_admit) nue_ant
                         from sgbstdn g1
                         where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                           from sgbstdn g2
                                                           where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                           and g1.sgbstdn_admt_code = 'AD'
                           and g1.sgbstdn_term_code_admit = vsPerio1)
             where nue_ant = 'N')a
       where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) RNIP1,
       /***** Regular Nuevo Ingreso per2 *****/
      (select prog_code, prog_des, sum(pidm) reg_nueing_per2
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select code_prog, pidm_g1, admt_peri, admt_code, nue_ant
                   from (select g1.sgbstdn_program_1         code_prog
                              , g1.sgbstdn_pidm              pidm_g1
                              , g1.sgbstdn_term_code_admit   admt_peri
                              , g1.sgbstdn_admt_code         admt_code
                              , fwatyaluft(g1.sgbstdn_pidm, g1.sgbstdn_term_code_admit) nue_ant
                         from sgbstdn g1
                         where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                           from sgbstdn g2
                                                           where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                           and g1.sgbstdn_admt_code = 'AD'
                           and g1.sgbstdn_term_code_admit = vsPerio2)
                   where nue_ant = 'N')a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) RNIP2,
       /***** Regular Antiguo per1 *****/
      (select prog_code, prog_des, sum(pidm) reg_anti_per1
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select code_prog, pidm_g1, admt_peri, admt_code, nue_ant
                   from (select g1.sgbstdn_program_1         code_prog
                              , g1.sgbstdn_pidm              pidm_g1
                              , g1.sgbstdn_term_code_admit   admt_peri
                              , g1.sgbstdn_admt_code         admt_code
                              , fwatyaluft(g1.sgbstdn_pidm, g1.sgbstdn_term_code_admit) nue_ant
                         from sgbstdn g1
                         where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                           from sgbstdn g2
                                                           where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                           and g1.sgbstdn_admt_code = 'AD'
                           and g1.sgbstdn_term_code_admit = vsPerio1)
                   where nue_ant = 'A')a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) RAP1,
       /***** Regular Antiguo per2 *****/
      (select prog_code, prog_des, sum(pidm) reg_anti_per2
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select code_prog, pidm_g1, admt_peri, admt_code, nue_ant
                   from (select g1.sgbstdn_program_1         code_prog
                              , g1.sgbstdn_pidm              pidm_g1
                              , g1.sgbstdn_term_code_admit   admt_peri
                              , g1.sgbstdn_admt_code         admt_code
                              , fwatyaluft(g1.sgbstdn_pidm, g1.sgbstdn_term_code_admit) nue_ant
                         from sgbstdn g1
                         where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                           from sgbstdn g2
                                                           where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                           and g1.sgbstdn_admt_code = 'AD'
                           and g1.sgbstdn_term_code_admit = vsPerio2)
                   where nue_ant = 'A')a
            where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) RAP2,
       /***** Libre per1 *****/
      (select prog_code, prog_des, sum(pidm) libre_per1
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'AL'
                     and g1.sgbstdn_term_code_admit = vsPerio1)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) LP1,
       /***** Libre per2 *****/
      (select prog_code, prog_des, sum(pidm) libre_per2
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'AL'
                     and g1.sgbstdn_term_code_admit = vsPerio2)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) LP2,
       /***** PSU Anterior per1 *****/
      (select prog_code, prog_des, sum(pidm) psu_ant_per1
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'PA'
                     and g1.sgbstdn_term_code_admit = vsPerio1)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) PSUAP1,
       /***** PSU Anterior per2 *****/
      (select prog_code, prog_des, sum(pidm) psu_ant_per2
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'PA'
                     and g1.sgbstdn_term_code_admit = vsPerio2)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) PSUAP2,
       /***** Convalidacin per1 *****/
      (select prog_code, prog_des, sum(pidm) convalidacion_per1
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'CO'
                     and g1.sgbstdn_term_code_admit = vsPerio1)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) CP1,
       /***** Convalidacin per2 *****/
      (select prog_code, prog_des, sum(pidm) convalidacion_per2
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'CO'
                     and g1.sgbstdn_term_code_admit = vsPerio2)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) CP2,
       /***** Estudios Extranjeros per1 *****/
      (select prog_code, prog_des, sum(pidm) estu_extranjeros_per1
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                  , (select g1.sgbstdn_program_1         code_prog
                           , g1.sgbstdn_pidm              pidm_g1
                           , g1.sgbstdn_term_code_admit   admt_peri
                           , g1.sgbstdn_admt_code         admt_code
                      from sgbstdn g1
                      where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                        from sgbstdn g2
                                                        where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                        and g1.sgbstdn_admt_code = 'EE'
                        and g1.sgbstdn_term_code_admit = vsPerio1)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) EEP1,
       /***** Estudios Extranjeros per2 *****/
      (select prog_code, prog_des, sum(pidm) estu_extranjeros_per2
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'EE'
                     and g1.sgbstdn_term_code_admit = vsPerio2)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) EEP2,
       /***** Vespertino per1 *****/
      (select prog_code, prog_des, sum(pidm) vespertino_per1
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'VP'
                     and g1.sgbstdn_term_code_admit = vsPerio1)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) VP1,
       /***** Vespertino per2 *****/
      (select prog_code, prog_des, sum(pidm) vespertino_per2
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'VP'
                     and g1.sgbstdn_term_code_admit = vsPerio2)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) VP2,
       /*****     Bachillerato Ingls per1 *****/
      (select prog_code, prog_des, sum(pidm) bach_ingles_per1
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'BI'
                     and g1.sgbstdn_term_code_admit = vsPerio1)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) BIP1,
       /***** Bachillerato Ingls per2 *****/
      (select prog_code, prog_des, sum(pidm) bach_ingles_per2
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
              from smrprle
                 , (select g1.sgbstdn_program_1         code_prog
                         , g1.sgbstdn_pidm              pidm_g1
                         , g1.sgbstdn_term_code_admit   admt_peri
                         , g1.sgbstdn_admt_code         admt_code
                    from sgbstdn g1
                    where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                      from sgbstdn g2
                                                      where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                    and g1.sgbstdn_admt_code = 'BI'
                    and g1.sgbstdn_term_code_admit = vsPerio2)a
              where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) BIP2,
       /***** Bachillerato Francs per1 *****/
      (select prog_code, prog_des, sum(pidm) bach_frances_per1
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'BF'
                     and g1.sgbstdn_term_code_admit = vsPerio1)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) BFP1,
       /***** Bachillerato Francs per2 *****/
      (select prog_code, prog_des, sum(pidm) bach_frances_per2
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'BF'
                     and g1.sgbstdn_term_code_admit = vsPerio2)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) BFP2,
       /***** Bachillerato Alemn per1 *****/
      (select prog_code, prog_des, sum(pidm) bach_aleman_per1
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'BA'
                     and g1.sgbstdn_term_code_admit = vsPerio1)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) BAP1,
       /***** Bachillerato Alemn per2 *****/
      (select prog_code, prog_des, sum(pidm) bach_aleman_per2
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'BA'
                     and g1.sgbstdn_term_code_admit = vsPerio2)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) BAP2,
       /***** Bachillerato Artes per1 *****/
      (select prog_code, prog_des, sum(pidm) bach_artes_per1
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'BR'
                     and g1.sgbstdn_term_code_admit = vsPerio1)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) BRP1,
       /***** Bachillerato Artes per2 *****/
      (select prog_code, prog_des, sum(pidm) bach_artes_per2
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'BR'
                     and g1.sgbstdn_term_code_admit = vsPerio2)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) BRP2,
       /***** Licenciatura / Tit. Otras Univ per1 *****/
      (select prog_code, prog_des, sum(pidm) lt_otra_u_per1
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'LO'
                     and g1.sgbstdn_term_code_admit = vsPerio1)a
       where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) LTOUP1,
       /***** Licenciatura / Tit. Otras Univ per2 *****/
      (select prog_code, prog_des, sum(pidm) lt_otra_u_per2
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'LO'
                     and g1.sgbstdn_term_code_admit = vsPerio2)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) LTOUP2,
       /***** Licenciatura / Tit. UFT per1 *****/
      (select prog_code, prog_des, sum(pidm) lt_uft_per1
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'LU'
                     and g1.sgbstdn_term_code_admit = vsPerio1)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) LTUFTP1,
       /***** Licenciatura / Tit. UFT per2 *****/
      (select prog_code, prog_des, sum(pidm) lt_uft_per2
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'LU'
                     and g1.sgbstdn_term_code_admit = vsPerio2)a
       where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) LTUFTP2,
       /***** Admisin IV Medio *****/
      (select prog_code, prog_des, sum(pidm) adm_med_per1
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'CM'
                     and g1.sgbstdn_term_code_admit = vsPerio1)a
             where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) CMP1,
       /***** Admisin IV Medio *****/
      (select prog_code, prog_des, sum(pidm) adm_med_per2
       from (select smrprle_program                    prog_code
                  , smrprle_program_desc               prog_des
                  , decode(a.pidm_g1, null,0,1)        pidm
                  , a.admt_code                        peri_admit
             from smrprle
                , (select g1.sgbstdn_program_1         code_prog
                        , g1.sgbstdn_pidm              pidm_g1
                        , g1.sgbstdn_term_code_admit   admt_peri
                        , g1.sgbstdn_admt_code         admt_code
                   from sgbstdn g1
                   where g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
                                                     from sgbstdn g2
                                                     where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
                     and g1.sgbstdn_admt_code = 'CM'
                     and g1.sgbstdn_term_code_admit = vsPerio2)a
       where smrprle_program = a.code_prog(+))
       group by prog_code, prog_des
       order by prog_des, prog_code) CMP2
  where RNIP1.prog_code(+) = smrprle_program
    and RNIP2.prog_code(+) = smrprle_program
    and RAP1.prog_code(+) = smrprle_program
    and RAP2.prog_code(+) = smrprle_program
    and LP1.prog_code(+) = smrprle_program
    and LP2.prog_code(+) = smrprle_program
    and PSUAP1.prog_code(+) = smrprle_program
    and PSUAP2.prog_code(+) = smrprle_program
    and CP1.prog_code(+) = smrprle_program
    and CP2.prog_code(+) = smrprle_program
    and EEP1.prog_code(+) = smrprle_program
    and EEP2.prog_code(+) = smrprle_program
    and VP1.prog_code(+) = smrprle_program
    and VP2.prog_code(+) = smrprle_program
    and BIP1.prog_code(+) = smrprle_program
    and BIP2.prog_code(+) = smrprle_program
    and BFP1.prog_code(+) = smrprle_program
    and BFP2.prog_code(+) = smrprle_program
    and BAP1.prog_code(+) = smrprle_program
    and BAP2.prog_code(+) = smrprle_program
    and BRP1.prog_code(+) = smrprle_program
    and BRP2.prog_code(+) = smrprle_program
    and LTOUP1.prog_code(+) = smrprle_program
    and LTOUP2.prog_code(+) = smrprle_program
    and LTUFTP1.prog_code(+) = smrprle_program
    and LTUFTP2.prog_code(+) = smrprle_program
    and CMP1.prog_code(+) = smrprle_program
    and CMP2.prog_code(+) = smrprle_program
    and (smrprle_program = vsProg or vsProg is null);

BEGIN

   IF Pk_Login.F_ValidacionDeAcceso (pk_login.vgsUSR)
   THEN
      RETURN;
   END IF;

    /* Parmetros */
    --Se busca el valor de la cookie (parmetro) para asignarlo al filtro del query.
    vsProg   := pk_ObjHtml.getValueCookie ('psProgr');
    vsPerio1 := pk_ObjHtml.getValueCookie ('psPerio');
    vsPerio2 := pk_ObjHtml.getValueCookie ('psTerm');

  -- Nmero de columnas de la tabla --
   FOR vnI IN 1 .. vnColumnas
   LOOP
      tabColumna.EXTEND (vnI);
      tabColumna (vnI) := NULL;
   END LOOP;

   /* Encabezado de las columnas */
   tabColumna (1) := 'Programa';
   tabColumna (2) := 'Programa Descripcin';
   tabColumna (3) := 'Regular Nuevo Ingreso Periodo 1';
   tabColumna (4) := 'Regular Nuevo Ingreso Periodo 2';
   tabColumna (5) := 'Regular Avanzado Periodo 1';
   tabColumna (6) := 'Regular Avanzado Periodo 2';
   tabColumna (7) := 'Libre Periodo 1';
   tabColumna (8) := 'Libre Periodo 2';
   tabColumna (9) := 'PSU Anterior Periodo 1';
   tabColumna (10) := 'PSU Anterior Periodo 2';
   tabColumna (11) := 'Convalidacin Periodo 1';
   tabColumna (12) := 'Convalidacin Periodo 2';
   tabColumna (13) := 'Estudios Extranjeros Periodo 1';
   tabColumna (14) := 'Estudios Extranjeros Periodo 2';
   tabColumna (15) := 'Vespertino Periodo 1';
   tabColumna (16) := 'Vespertino Periodo 2';
   tabColumna (17) := 'Bach. Ingles Periodo 1';
   tabColumna (18) := 'Bach. Ingles Periodo 2';
   tabColumna (19) := 'Bach. Francs Periodo 1';
   tabColumna (20) := 'Bach. Francs Periodo 2';
   tabColumna (21) := 'Bach. Alemn Periodo 1';
   tabColumna (22) := 'Bach. Alemn Periodo 2';
   tabColumna (23) := 'Bach. Artes Periodo 1';
   tabColumna (24) := 'Bach. Artes Periodo 2';
   tabColumna (25) := 'L/T otra U Periodo 1';
   tabColumna (26) := 'L/T otra U Periodo 2';
   tabColumna (27) := 'L/T UFT Periodo 1';
   tabColumna (28) := 'L/T UFT Periodo 2';
   tabColumna (29) := 'Admisin IV Medio Periodo 1';
   tabColumna (30) := 'Admisin IV Medio Periodo 2';

      FOR regRep IN cuReporte_Cambio(vsProg, vsPerio1, vsPerio2) LOOP
          IF vnRow = 0 THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag,
                                                psSubtitulo=>'Periodo 1: '||vsPerio1||'  '||Pk_Catalogo.PERIODO(vsPerio1)||
                                                        '<br> Periodo 2: '||vsPerio2||'  '||Pk_Catalogo.PERIODO(vsPerio2));
             vsInicioPag := 'SALTO';
             vnRow  := 0;
          END IF;

          htp.p(
          '<tr>
          <td valign="top">'||regRep.smrprle_program||'</td>
          <td valign="top">'||regRep.smrprle_program_desc||'</td>
          <td valign="top">'||regRep.reg_nueing_per1||'</td>
          <td valign="top">'||regRep.reg_nueing_per2||'</td>
          <td valign="top">'||regRep.reg_anti_per1||'</td>
          <td valign="top">'||regRep.reg_anti_per2||'</td>
          <td valign="top">'||regRep.libre_per1||'</td>
          <td valign="top">'||regRep.libre_per2||'</td>
          <td valign="top">'||regRep.psu_ant_per1||'</td>
          <td valign="top">'||regRep.psu_ant_per2||'</td>
          <td valign="top">'||regRep.convalidacion_per1||'</td>
          <td valign="top">'||regRep.convalidacion_per2||'</td>
          <td valign="top">'||regRep.estu_extranjeros_per1||'</td>
          <td valign="top">'||regRep.estu_extranjeros_per2||'</td>
          <td valign="top">'||regRep.vespertino_per1||'</td>
          <td valign="top">'||regRep.vespertino_per2||'</td>
          <td valign="top">'||regRep.bach_ingles_per1||'</td>
          <td valign="top">'||regRep.bach_ingles_per2||'</td>
          <td valign="top">'||regRep.bach_frances_per1||'</td>
          <td valign="top">'||regRep.bach_frances_per2||'</td>
          <td valign="top">'||regRep.bach_aleman_per1||'</td>
          <td valign="top">'||regRep.bach_aleman_per2||'</td>
          <td valign="top">'||regRep.bach_artes_per1||'</td>
          <td valign="top">'||regRep.bach_artes_per2||'</td>
          <td valign="top">'||regRep.lt_otra_u_per1||'</td>
          <td valign="top">'||regRep.lt_otra_u_per2||'</td>
          <td valign="top">'||regRep.lt_uft_per1||'</td>
          <td valign="top">'||regRep.lt_uft_per2||'</td>
          <td valign="top">'||regRep.adm_med_per1||'</td>
          <td valign="top">'||regRep.adm_med_per2||'</td>
          ');

          vnExists   := 1;
          vnRow      := vnRow + 1;
      END LOOP;

   IF vnExists = 0
   THEN
      HTP.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- es omitido el encabezado del reporte pero se agrega el salto de pagina
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
   END IF;

   HTP.p ('</table><br/></body></html>');
EXCEPTION
   WHEN OTHERS
   THEN
      HTP.P (SQLERRM);
END PWADXCA;
/


DROP PUBLIC SYNONYM PWADXCA;

CREATE PUBLIC SYNONYM PWADXCA FOR BANINST1.PWADXCA;


GRANT EXECUTE ON BANINST1.PWADXCA TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWADXCA TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWADXCA TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWADXCA TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWADXCA TO WWW2_USER;
DROP PROCEDURE BANINST1.PWAENRL;

CREATE OR REPLACE PROCEDURE BANINST1.PWAENRL(psTerm VARCHAR2) IS

  /*
     TAREA: Actualizar la cantidad de inscritos en la programacin acadmica
     FECHA: 17/03/2009
     AUTOR: GEPC
    MODULO: Programacin academica

             * Etapas de actualizacin
               1. UPDATE INCORRECT ENROLLMENT COUNT ON SSBSECT
               2. UPDATE INCORRECT AVAILABLE SEATS COUNT ON SSBSECT
               3. UPDATE INCORRECT WAITING LIST COUNT ON SSBSECT
               4. UPDATE INCORRECT AVAILABLE WAITING LIST SEATS
               5. UPDATE ENROLLMENT COUNT ON XLIST RECORDS SSBXLST
               6. UPDATE INCORRECT AVAILABLE SEATS COUNT ON XLISTS SSBXLST
               7. UPDATE INCORRECT ENROLLMENT COUNT ON RESERVED SEATS SSBXLST
               8. UPDATE INCORRECT WAITING LIST COUNT ON RESERVED SEATS SSBXLST
               9. UPDATE INCORRECT AVAILABLE SEATS COUNT ON RESERVED SEATS
  */

  vsErr  VARCHAR2(4000) := NULL;
  vnRows NUMBER        := 0;

  procedure InsertEatapa(psEtapa varchar2) is

  begin
      INSERT INTO SWRERRP(SWRERRP_ETAPA, SWRERRP_ACCION, SWRERRP_TERM_CODE, SWRERRP_CAMP_CODE, SWRERRP_ERROR, SWRERRP_CODE)
                   VALUES('EnrlBanner',  'UPDATE',       psTerm,            'UFT',            psEtapa,       vnRows);
  end InsertEatapa;

  procedure InsertError(psEtapa varchar2,
                        psError varchar2) is

  begin
      INSERT INTO SWRERRP(SWRERRP_ETAPA, SWRERRP_ACCION, SWRERRP_TERM_CODE, SWRERRP_CAMP_CODE, SWRERRP_TSSC_CODE, SWRERRP_ERROR)
                   VALUES('EnrlBanner',  'UPDATE',       psTerm,            'UFT',            psEtapa,           psError);
  end InsertError;

  BEGIN

      --UPDATE INCORRECT ENROLLMENT COUNT ON SSBSECT
      BEGIN
          UPDATE SSBSECT X
             SET (X.SSBSECT_ENRL,
                  X.SSBSECT_TOT_CREDIT_HRS) = (SELECT NVL(COUNT(SFRSTCR_CRN),0),
                                                      NVL(SUM(SFRSTCR_CREDIT_HR),0)
                                                 FROM SFRSTCR,
                                                      STVRSTS
                                                WHERE SFRSTCR_CRN            = X.SSBSECT_CRN
                                                  AND SFRSTCR_TERM_CODE      = X.SSBSECT_TERM_CODE
                                                  AND SFRSTCR_RSTS_CODE      = STVRSTS_CODE
                                                  AND STVRSTS_INCL_SECT_ENRL = 'Y'
                                              ),
                 X.SSBSECT_CENSUS_ENRL      = (SELECT NVL(COUNT(SFRSTCR_CRN),0)
                                                 FROM SFRSTCR,
                                                      STVRSTS
                                                WHERE SFRSTCR_CRN             = X.SSBSECT_CRN
                                                  AND SFRSTCR_TERM_CODE       = X.SSBSECT_TERM_CODE
                                                  AND SFRSTCR_RSTS_CODE       = STVRSTS_CODE
                                                  AND STVRSTS_INCL_SECT_ENRL  = 'Y'
                                                  AND SFRSTCR_RSTS_DATE      <= X.SSBSECT_CENSUS_ENRL_DATE
                                              ),
                 X.SSBSECT_CENSUS_2_ENRL    = (SELECT NVL(COUNT(SFRSTCR_CRN),0)
                                                 FROM SFRSTCR,
                                                      STVRSTS
                                                WHERE SFRSTCR_CRN             = X.SSBSECT_CRN
                                                  AND SFRSTCR_TERM_CODE       = X.SSBSECT_TERM_CODE
                                                  AND SFRSTCR_RSTS_CODE       = STVRSTS_CODE
                                                  AND STVRSTS_INCL_SECT_ENRL  = 'Y'
                                                  AND SFRSTCR_RSTS_DATE      <= X.SSBSECT_CENSUS_2_DATE
                                              )
           WHERE X.SSBSECT_TERM_CODE = psTerm
             AND X.SSBSECT_ENRL     <> (SELECT NVL(COUNT(SFRSTCR_CRN),0)
                                          FROM SFRSTCR,
                                               STVRSTS
                                         WHERE SFRSTCR_TERM_CODE      = X.SSBSECT_TERM_CODE
                                           AND SFRSTCR_CRN            = X.SSBSECT_CRN
                                           AND SFRSTCR_RSTS_CODE      = STVRSTS_CODE
                                           AND STVRSTS_INCL_SECT_ENRL = 'Y'
                                       )
             AND EXISTS (SELECT NULL
                           FROM SFRSTCR,
                                STVRSTS
                          WHERE SFRSTCR_TERM_CODE      = X.SSBSECT_TERM_CODE
                            AND SFRSTCR_CRN            = X.SSBSECT_CRN
                            AND SFRSTCR_RSTS_CODE      = STVRSTS_CODE
                            AND STVRSTS_INCL_SECT_ENRL = 'Y'
                        );

          vnRows := SQL%ROWCOUNT;

          InsertEatapa('UPDATE INCORRECT ENROLLMENT COUNT ON SSBSECT');

      EXCEPTION
          WHEN OTHERS THEN
               vsErr := SUBSTR(SQLERRM,1,4000);

               InsertError('uiecoSSBSECT', vsErr);
      END;

      --UPDATE INCORRECT AVAILABLE SEATS COUNT ON SSBSECT
      BEGIN
          UPDATE SSBSECT
             SET SSBSECT_SEATS_AVAIL = (SSBSECT_MAX_ENRL      - SSBSECT_ENRL),
                 SSBSECT_WAIT_AVAIL  = (SSBSECT_WAIT_CAPACITY - SSBSECT_WAIT_COUNT)
           WHERE SSBSECT_TERM_CODE   = psTerm
             AND (   SSBSECT_SEATS_AVAIL <> (SSBSECT_MAX_ENRL      - SSBSECT_ENRL)
                  OR SSBSECT_WAIT_AVAIL  <> (SSBSECT_WAIT_CAPACITY - SSBSECT_WAIT_COUNT)
                 );

          vnRows := SQL%ROWCOUNT;

          InsertEatapa('UPDATE INCORRECT AVAILABLE SEATS COUNT ON SSBSECT');

      EXCEPTION
          WHEN OTHERS THEN
               vsErr := SUBSTR(SQLERRM,1,4000);

               InsertError('uiascoSSBSECT', vsErr);
      END;

      COMMIT;

      --UPDATE INCORRECT WAITING LIST COUNT ON SSBSECT
      BEGIN
          UPDATE SSBSECT
             SET SSBSECT_WAIT_COUNT   = (SELECT NVL(COUNT(SFRSTCR_CRN),0)
                                           FROM STVRSTS,
                                                SFRSTCR
                                          WHERE SFRSTCR_CRN       = SSBSECT_CRN
                                            AND SFRSTCR_TERM_CODE = SSBSECT_TERM_CODE
                                            AND SFRSTCR_RSTS_CODE = STVRSTS_CODE
                                            AND STVRSTS_WAIT_IND  = 'Y'
                                        )
            WHERE SSBSECT_TERM_CODE   = psTerm
              AND SSBSECT_WAIT_COUNT <> (SELECT NVL(COUNT(SFRSTCR_CRN),0)
                                           FROM STVRSTS,
                                                SFRSTCR
                                          WHERE SFRSTCR_CRN       = SSBSECT_CRN
                                            AND SFRSTCR_TERM_CODE = SSBSECT_TERM_CODE
                                            AND SFRSTCR_RSTS_CODE = STVRSTS_CODE
                                            AND STVRSTS_WAIT_IND  = 'Y'
                                        )
              AND EXISTS (SELECT NULL
                            FROM STVRSTS,
                                 SFRSTCR
                           WHERE SFRSTCR_CRN       = SSBSECT_CRN
                             AND SFRSTCR_TERM_CODE = SSBSECT_TERM_CODE
                             AND SFRSTCR_RSTS_CODE = STVRSTS_CODE
                             AND STVRSTS_WAIT_IND  = 'Y'
                         );

          vnRows := SQL%ROWCOUNT;

          InsertEatapa('UPDATE INCORRECT WAITING LIST COUNT ON SSBSECT');

      EXCEPTION
          WHEN OTHERS THEN
               vsErr := SUBSTR(SQLERRM,1,4000);

               InsertError('uiwlcoSSBSECT', vsErr);
      END;

      --UPDATE INCORRECT AVAILABLE WAITING LIST SEATS
      BEGIN
          UPDATE SSBSECT
             SET SSBSECT_WAIT_AVAIL  = (SSBSECT_WAIT_CAPACITY - SSBSECT_WAIT_COUNT)
           WHERE SSBSECT_TERM_CODE   = psTerm
             AND SSBSECT_WAIT_AVAIL <> (SSBSECT_WAIT_CAPACITY - SSBSECT_WAIT_COUNT);

          vnRows := SQL%ROWCOUNT;

          InsertEatapa('UPDATE INCORRECT AVAILABLE WAITING LIST SEATS');

      EXCEPTION
          WHEN OTHERS THEN
               vsErr := SUBSTR(SQLERRM,1,4000);

               InsertError('uiawlSEATS', vsErr);
      END;

      COMMIT;

      --UPDATE ENROLLMENT COUNT ON XLIST RECORDS SSBXLST
      BEGIN
          UPDATE SSBXLST
             SET SSBXLST_ENRL  = (SELECT NVL(SUM(SSBSECT_ENRL),0)
                                    FROM SSBSECT,
                                         SSRXLST
                                   WHERE SSBSECT_TERM_CODE  = SSBXLST_TERM_CODE
                                     AND SSRXLST_TERM_CODE  = SSBXLST_TERM_CODE
                                     AND SSRXLST_XLST_GROUP = SSBXLST_XLST_GROUP
                                     AND SSRXLST_CRN        = SSBSECT_CRN
                                 )
           WHERE SSBXLST_ENRL <> (SELECT SUM(SSBSECT_ENRL)
                                    FROM SSBSECT,
                                         SSRXLST
                                   WHERE SSBSECT_TERM_CODE  = SSBXLST_TERM_CODE
                                     AND SSRXLST_TERM_CODE  = SSBXLST_TERM_CODE
                                     AND SSRXLST_XLST_GROUP = SSBXLST_XLST_GROUP
                                     AND SSRXLST_CRN        = SSBSECT_CRN
                                 )
             AND SSBXLST_TERM_CODE = psTerm;

          vnRows := SQL%ROWCOUNT;

          InsertEatapa('UPDATE ENROLLMENT COUNT ON XLIST RECORDS SSBXLST');

      EXCEPTION
          WHEN OTHERS THEN
               vsErr := SUBSTR(SQLERRM,1,4000);

               InsertError('uecoxrSSBXLST', vsErr);
      END;

      --UPDATE INCORRECT AVAILABLE SEATS COUNT ON XLISTS SSBXLST
      BEGIN
          UPDATE SSBXLST
             SET SSBXLST_SEATS_AVAIL  = (SSBXLST_MAX_ENRL - SSBXLST_ENRL)
           WHERE SSBXLST_SEATS_AVAIL <> (SSBXLST_MAX_ENRL - SSBXLST_ENRL)
             AND SSBXLST_TERM_CODE    = psTerm;

          vnRows := SQL%ROWCOUNT;

          InsertEatapa('UPDATE INCORRECT AVAILABLE SEATS COUNT ON XLISTS SSBXLST');

      EXCEPTION
          WHEN OTHERS THEN
               vsErr := SUBSTR(SQLERRM,1,4000);

               InsertError('uiascoxSSBXLST', vsErr);
      END;

      COMMIT;

      --UPDATE INCORRECT ENROLLMENT COUNT ON RESERVED SEATS SSBXLST
      BEGIN
          UPDATE SSRRESV  Y
             SET Y.SSRRESV_ENRL  =  (SELECT NVL(COUNT(SFRSTCR_CRN),0)
                                       FROM SFRSTCR,
                                            STVRSTS,
                                            SGBSTDN
                                      WHERE SFRSTCR_TERM_CODE      = Y.SSRRESV_TERM_CODE
                                        AND SFRSTCR_CRN            = Y.SSRRESV_CRN
                                        AND SFRSTCR_RSTS_CODE      = STVRSTS_CODE
                                        AND STVRSTS_INCL_SECT_ENRL = 'Y'
                                        AND SFRSTCR_PIDM           = SGBSTDN_PIDM
                                        AND SGBSTDN_TERM_CODE_EFF  = (SELECT MAX(F.SGBSTDN_TERM_CODE_EFF)
                                                                        FROM SGBSTDN F
                                                                       WHERE F.SGBSTDN_PIDM           = SGBSTDN_PIDM
                                                                         AND F.SGBSTDN_TERM_CODE_EFF <= Y.SSRRESV_TERM_CODE
                                                                     )
                                        AND (Y.SSRRESV_LEVL_CODE || Y.SSRRESV_MAJR_CODE ||
                                             Y.SSRRESV_CLAS_CODE || Y.ROWID )  = (SELECT MAX(G.SSRRESV_LEVL_CODE || G.SSRRESV_MAJR_CODE ||
                                                                                             G.SSRRESV_CLAS_CODE || G.ROWID  )
                                                                                    FROM SSRRESV G
                                                                                   WHERE (    G.SSRRESV_CLAS_CODE = F_CLASS_CALC_FNC(SGBSTDN_PIDM, SGBSTDN_LEVL_CODE, Y.SSRRESV_TERM_CODE)
                                                                                          OR  G.SSRRESV_CLAS_CODE IS NULL
                                                                                         )
                                                                                     AND (   G.SSRRESV_MAJR_CODE = SGBSTDN_MAJR_CODE_1
                                                                                          OR G.SSRRESV_MAJR_CODE IS NULL
                                                                                         )
                                                                                     AND (   G.SSRRESV_LEVL_CODE = SGBSTDN_LEVL_CODE
                                                                                          OR G.SSRRESV_LEVL_CODE IS NULL
                                                                                         )
                                                                                     AND G.SSRRESV_CRN       = Y.SSRRESV_CRN
                                                                                     AND G.SSRRESV_TERM_CODE = Y.SSRRESV_TERM_CODE
                                                                                 )
                                    )
           WHERE Y.SSRRESV_TERM_CODE  = psTerm
             AND Y.SSRRESV_ENRL      <> (SELECT NVL(COUNT(SFRSTCR_CRN),0)
                                           FROM SFRSTCR,
                                                STVRSTS,
                                                SGBSTDN
                                          WHERE SFRSTCR_TERM_CODE      = Y.SSRRESV_TERM_CODE
                                            AND SFRSTCR_CRN            = Y.SSRRESV_CRN
                                            AND SFRSTCR_RSTS_CODE      = STVRSTS_CODE
                                            AND STVRSTS_INCL_SECT_ENRL = 'Y'
                                            AND SFRSTCR_PIDM           = SGBSTDN_PIDM
                                            AND SGBSTDN_TERM_CODE_EFF  = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                                                            FROM SGBSTDN B
                                                                           WHERE B.SGBSTDN_PIDM           = SGBSTDN_PIDM
                                                                             AND B.SGBSTDN_TERM_CODE_EFF <= Y.SSRRESV_TERM_CODE
                                                                         )
                                            AND (Y.SSRRESV_LEVL_CODE || Y.SSRRESV_MAJR_CODE ||
                                                 Y.SSRRESV_CLAS_CODE || Y.ROWID )  = (SELECT MAX(C.SSRRESV_LEVL_CODE || C.SSRRESV_MAJR_CODE ||
                                                                                                 C.SSRRESV_CLAS_CODE || C.ROWID)
                                                                                        FROM SSRRESV C
                                                                                       WHERE (   C.SSRRESV_CLAS_CODE = F_CLASS_CALC_FNC(SGBSTDN_PIDM, SGBSTDN_LEVL_CODE, Y.SSRRESV_TERM_CODE )
                                                                                              OR C.SSRRESV_CLAS_CODE IS NULL
                                                                                             )
                                                                                         AND (   C.SSRRESV_MAJR_CODE = SGBSTDN_MAJR_CODE_1
                                                                                              OR C.SSRRESV_MAJR_CODE IS NULL
                                                                                             )
                                                                                         AND (   C.SSRRESV_LEVL_CODE = SGBSTDN_LEVL_CODE
                                                                                              OR C.SSRRESV_LEVL_CODE IS NULL
                                                                                             )
                                                                                         AND C.SSRRESV_CRN       = Y.SSRRESV_CRN
                                                                                         AND C.SSRRESV_TERM_CODE = Y.SSRRESV_TERM_CODE
                                                                                     )
                                        )
             AND EXISTS (SELECT NULL
                           FROM SFRSTCR,
                                STVRSTS,
                                SGBSTDN
                          WHERE SFRSTCR_TERM_CODE      = Y.SSRRESV_TERM_CODE
                            AND SFRSTCR_CRN            = Y.SSRRESV_CRN
                            AND SFRSTCR_RSTS_CODE      = STVRSTS_CODE
                            AND STVRSTS_INCL_SECT_ENRL = 'Y'
                            AND SFRSTCR_PIDM           = SGBSTDN_PIDM
                            AND SGBSTDN_TERM_CODE_EFF  = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                                            FROM SGBSTDN B
                                                           WHERE B.SGBSTDN_PIDM           = SGBSTDN_PIDM
                                                             AND B.SGBSTDN_TERM_CODE_EFF <= Y.SSRRESV_TERM_CODE
                                                         )
                            AND (Y.SSRRESV_LEVL_CODE || Y.SSRRESV_MAJR_CODE ||
                                 Y.SSRRESV_CLAS_CODE || Y.ROWID )  =  (SELECT MAX(C.SSRRESV_LEVL_CODE || C.SSRRESV_MAJR_CODE ||
                                                                                  C.SSRRESV_CLAS_CODE || C.ROWID)
                                                                         FROM SSRRESV C
                                                                        WHERE (   C.SSRRESV_CLAS_CODE = F_CLASS_CALC_FNC(SGBSTDN_PIDM, SGBSTDN_LEVL_CODE, Y.SSRRESV_TERM_CODE)
                                                                               OR C.SSRRESV_CLAS_CODE IS NULL
                                                                              )
                                                                          AND (   C.SSRRESV_MAJR_CODE = SGBSTDN_MAJR_CODE_1
                                                                               OR C.SSRRESV_MAJR_CODE IS NULL
                                                                              )
                                                                          AND (   C.SSRRESV_LEVL_CODE = SGBSTDN_LEVL_CODE
                                                                               OR C.SSRRESV_LEVL_CODE IS NULL
                                                                              )
                                                                          AND C.SSRRESV_CRN       = Y.SSRRESV_CRN
                                                                          AND C.SSRRESV_TERM_CODE = Y.SSRRESV_TERM_CODE
                                                                      )
                        );

          vnRows := SQL%ROWCOUNT;

          InsertEatapa('UPDATE INCORRECT ENROLLMENT COUNT ON RESERVED SEATS SSBXLST');

      EXCEPTION
          WHEN OTHERS THEN
               vsErr := SUBSTR(SQLERRM,1,4000);

               InsertError('uiecorsSSBXLST', vsErr);
      END;

      COMMIT;

      --UPDATE INCORRECT WAITING LIST COUNT ON RESERVED SEATS SSBXLST
      BEGIN
          UPDATE SSRRESV  Y
             SET Y.SSRRESV_WAIT_COUNT = (SELECT NVL(COUNT(SFRSTCR_CRN),0)
                                           FROM SFRSTCR,
                                                STVRSTS,
                                                SGBSTDN
                                          WHERE SFRSTCR_TERM_CODE     = Y.SSRRESV_TERM_CODE
                                            AND SFRSTCR_CRN           = Y.SSRRESV_CRN
                                            AND SFRSTCR_RSTS_CODE     = STVRSTS_CODE
                                            AND STVRSTS_WAIT_IND      = 'Y'
                                            AND SFRSTCR_PIDM          = SGBSTDN_PIDM
                                            AND SGBSTDN_TERM_CODE_EFF = (SELECT MAX(F.SGBSTDN_TERM_CODE_EFF)
                                                                           FROM SGBSTDN F
                                                                          WHERE F.SGBSTDN_PIDM = SGBSTDN_PIDM
                                                                            AND F.SGBSTDN_TERM_CODE_EFF <= Y.SSRRESV_TERM_CODE)
                                                                            AND (Y.SSRRESV_LEVL_CODE || Y.SSRRESV_MAJR_CODE ||
                                                                                 Y.SSRRESV_CLAS_CODE || Y.ROWID )  =  (SELECT MAX(G.SSRRESV_LEVL_CODE || G.SSRRESV_MAJR_CODE ||
                                                                                                                                  G.SSRRESV_CLAS_CODE || G.ROWID)
                                                                                                                         FROM SSRRESV G
                                                                                                                        WHERE (   G.SSRRESV_CLAS_CODE = F_CLASS_CALC_FNC(SGBSTDN_PIDM, SGBSTDN_LEVL_CODE, Y.SSRRESV_TERM_CODE )
                                                                                                                               OR G.SSRRESV_CLAS_CODE IS NULL
                                                                                                                              )
                                                                                                                          AND (   G.SSRRESV_MAJR_CODE = SGBSTDN_MAJR_CODE_1
                                                                                                                               OR G.SSRRESV_MAJR_CODE IS NULL
                                                                                                                              )
                                                                                                                          AND (   G.SSRRESV_LEVL_CODE = SGBSTDN_LEVL_CODE
                                                                                                                               OR G.SSRRESV_LEVL_CODE IS NULL
                                                                                                                              )
                                                                                                                          AND G.SSRRESV_CRN       = Y.SSRRESV_CRN
                                                                                                                          AND G.SSRRESV_TERM_CODE = Y.SSRRESV_TERM_CODE
                                                                                                                      )
                                        )
           WHERE Y.SSRRESV_TERM_CODE   = psTerm
             AND Y.SSRRESV_WAIT_COUNT <> (SELECT NVL(COUNT(SFRSTCR_CRN),0)
                                            FROM SFRSTCR,
                                                 STVRSTS,
                                                 SGBSTDN
                                           WHERE SFRSTCR_TERM_CODE     = Y.SSRRESV_TERM_CODE
                                             AND SFRSTCR_CRN           = Y.SSRRESV_CRN
                                             AND SFRSTCR_RSTS_CODE     = STVRSTS_CODE
                                             AND STVRSTS_WAIT_IND      = 'Y'
                                             AND SFRSTCR_PIDM          = SGBSTDN_PIDM
                                             AND SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                                                            FROM SGBSTDN B
                                                                           WHERE B.SGBSTDN_PIDM           = SGBSTDN_PIDM
                                                                             AND B.SGBSTDN_TERM_CODE_EFF <= Y.SSRRESV_TERM_CODE
                                                                         )
                                             AND (Y.SSRRESV_LEVL_CODE || Y.SSRRESV_MAJR_CODE ||
                                                  Y.SSRRESV_CLAS_CODE || Y.ROWID )  =  (SELECT MAX(C.SSRRESV_LEVL_CODE || C.SSRRESV_MAJR_CODE ||
                                                                                                   C.SSRRESV_CLAS_CODE || C.ROWID)
                                                                                          FROM SATURN.SSRRESV C
                                                                                         WHERE (   C.SSRRESV_CLAS_CODE = F_CLASS_CALC_FNC(SGBSTDN_PIDM, SGBSTDN_LEVL_CODE, Y.SSRRESV_TERM_CODE)
                                                                                                OR C.SSRRESV_CLAS_CODE IS NULL
                                                                                               )
                                                                                           AND (   C.SSRRESV_MAJR_CODE = SGBSTDN_MAJR_CODE_1
                                                                                                OR C.SSRRESV_MAJR_CODE IS NULL
                                                                                               )
                                                                                           AND (   C.SSRRESV_LEVL_CODE = SGBSTDN_LEVL_CODE
                                                                                                OR C.SSRRESV_LEVL_CODE IS NULL)
                                                                                           AND C.SSRRESV_CRN       = Y.SSRRESV_CRN
                                                                                           AND C.SSRRESV_TERM_CODE = Y.SSRRESV_TERM_CODE
                                                                                       )
                                         )
             AND EXISTS (SELECT NULL
                           FROM SFRSTCR,
                                STVRSTS,
                                SGBSTDN
                          WHERE SFRSTCR_TERM_CODE     = Y.SSRRESV_TERM_CODE
                            AND SFRSTCR_CRN           = Y.SSRRESV_CRN
                            AND SFRSTCR_RSTS_CODE     = STVRSTS_CODE
                            AND STVRSTS_WAIT_IND      = 'Y'
                            AND SFRSTCR_PIDM          = SGBSTDN_PIDM
                            AND SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                                           FROM SGBSTDN B
                                                          WHERE B.SGBSTDN_PIDM           = SGBSTDN_PIDM
                                                            AND B.SGBSTDN_TERM_CODE_EFF <= Y.SSRRESV_TERM_CODE
                                                        )
                            AND (Y.SSRRESV_LEVL_CODE || Y.SSRRESV_MAJR_CODE ||
                                 Y.SSRRESV_CLAS_CODE || Y.ROWID )  =  (SELECT MAX(C.SSRRESV_LEVL_CODE || C.SSRRESV_MAJR_CODE ||
                                                                                  C.SSRRESV_CLAS_CODE || C.ROWID)
                                                                         FROM SSRRESV C
                                                                        WHERE (   C.SSRRESV_CLAS_CODE = F_CLASS_CALC_FNC( SGBSTDN_PIDM, SGBSTDN_LEVL_CODE, Y.SSRRESV_TERM_CODE)
                                                                               OR C.SSRRESV_CLAS_CODE IS NULL
                                                                              )
                                                                          AND (   C.SSRRESV_MAJR_CODE = SGBSTDN_MAJR_CODE_1
                                                                               OR C.SSRRESV_MAJR_CODE IS NULL
                                                                              )
                                                                          AND (   C.SSRRESV_LEVL_CODE = SGBSTDN_LEVL_CODE
                                                                               OR C.SSRRESV_LEVL_CODE IS NULL
                                                                              )
                                                                          AND C.SSRRESV_CRN       = Y.SSRRESV_CRN
                                                                          AND C.SSRRESV_TERM_CODE = Y.SSRRESV_TERM_CODE
                                                                      )
                        );

          vnRows := SQL%ROWCOUNT;

          InsertEatapa('UPDATE INCORRECT WAITING LIST COUNT ON RESERVED SEATS SSBXLST');

      EXCEPTION
          WHEN OTHERS THEN
               vsErr := SUBSTR(SQLERRM,1,4000);

               InsertError('uiwlcorsSSBXLST', vsErr);
      END;

      --UPDATE INCORRECT  AVAILABLE  SEATS  COUNT ON RESERVED SEATS
      BEGIN
          UPDATE SSRRESV
             SET SSRRESV_SEATS_AVAIL = (SSRRESV_MAX_ENRL - SSRRESV_ENRL) ,
                 SSRRESV_WAIT_AVAIL  = (SSRRESV_WAIT_CAPACITY - SSRRESV_WAIT_COUNT)
           WHERE SSRRESV_TERM_CODE = psTerm
             AND (   SSRRESV_SEATS_AVAIL <> (SSRRESV_MAX_ENRL - SSRRESV_ENRL)
                  OR SSRRESV_WAIT_AVAIL  <> (SSRRESV_WAIT_CAPACITY - SSRRESV_WAIT_COUNT)
                 );

          vnRows := SQL%ROWCOUNT;

          InsertEatapa('UPDATE INCORRECT WAITING LIST COUNT ON RESERVED SEATS SSBXLST');

      EXCEPTION
          WHEN OTHERS THEN
               vsErr := SUBSTR(SQLERRM,1,4000);

               InsertError('uiwlcorsSSBXLST', vsErr);
      END;

      COMMIT;

  EXCEPTION
      WHEN OTHERS THEN
           vsErr := SUBSTR(SQLERRM,1,4000);

           InsertError('JobEnrl', vsErr);

  END PWAENRL;
/
DROP PROCEDURE BANINST1.PWAENRL1;

CREATE OR REPLACE PROCEDURE BANINST1.PWAENRL1(psTerm VARCHAR2
                                             ) IS

  /*
     TAREA: Actualizar la cantidad de inscritos en la programacin acadmica
     FECHA: 17/03/2009
     AUTOR: GEPC
    MODULO: Programacin academica

             * Etapas de actualizacin

               6. UPDATE INCORRECT AVAILABLE SEATS COUNT ON XLISTS SSBXLST

               9. UPDATE INCORRECT AVAILABLE SEATS COUNT ON RESERVED SEATS

  Modificacin: 07/04/2011
                GEPC
                * Se quito la tabla SWRERRP que era de auditoria

  */

  csY CONSTANT VARCHAR2(1) := 'Y';
  cn0 CONSTANT NUMBER(1)   := 0;

  BEGIN
      --UPDATE INCORRECT AVAILABLE SEATS COUNT ON XLISTS SSBXLST
      BEGIN
          UPDATE SSBXLST
             SET SSBXLST_SEATS_AVAIL  = (SSBXLST_MAX_ENRL - SSBXLST_ENRL)
           WHERE SSBXLST_SEATS_AVAIL <> (SSBXLST_MAX_ENRL - SSBXLST_ENRL)
             AND SSBXLST_TERM_CODE = psTerm;

      EXCEPTION
          WHEN OTHERS THEN
               NULL;
      END;

      COMMIT;

      --UPDATE INCORRECT  AVAILABLE  SEATS  COUNT ON RESERVED SEATS
      BEGIN
          UPDATE SSRRESV
             SET SSRRESV_SEATS_AVAIL = (SSRRESV_MAX_ENRL - SSRRESV_ENRL) ,
                 SSRRESV_WAIT_AVAIL  = (SSRRESV_WAIT_CAPACITY - SSRRESV_WAIT_COUNT)
           WHERE (
                     SSRRESV_SEATS_AVAIL <> (SSRRESV_MAX_ENRL - SSRRESV_ENRL)
                  OR
                     SSRRESV_WAIT_AVAIL  <> (SSRRESV_WAIT_CAPACITY - SSRRESV_WAIT_COUNT)
                 )
             AND SSRRESV_TERM_CODE = psTerm;

      EXCEPTION
          WHEN OTHERS THEN
               NULL;
      END;

      COMMIT;

  END PWAENRL1;
/
DROP PROCEDURE BANINST1.PWAENRL2;

CREATE OR REPLACE PROCEDURE BANINST1.PWAENRL2(psTerm VARCHAR2
                                             ) IS

  /*
     TAREA: Actualizar la cantidad de inscritos en la programacin acadmica
     FECHA: 17/03/2009
     AUTOR: GEPC
    MODULO: Programacin academica

             * Etapas de actualizacin
               7. UPDATE INCORRECT ENROLLMENT COUNT ON RESERVED SEATS SSBXLST
               8. UPDATE INCORRECT WAITING LIST COUNT ON RESERVED SEATS SSBXLST

  Modificacin: 07/04/2011
                GEPC
                * Se quito la tabla SWRERRP que era de auditoria

  */

  csY CONSTANT VARCHAR2(1) := 'Y';
  cn0 CONSTANT NUMBER(1)   := 0;

  BEGIN
      --UPDATE INCORRECT ENROLLMENT COUNT ON RESERVED SEATS SSBXLST
      BEGIN
          UPDATE SSRRESV  Y
             SET Y.SSRRESV_ENRL  =  (SELECT NVL(COUNT(SFRSTCR_CRN),cn0)
                                       FROM SFRSTCR,
                                            STVRSTS,
                                            SGBSTDN
                                      WHERE SFRSTCR_TERM_CODE      = Y.SSRRESV_TERM_CODE
                                        AND SFRSTCR_CRN            = Y.SSRRESV_CRN
                                        AND SFRSTCR_RSTS_CODE      = STVRSTS_CODE
                                        AND STVRSTS_INCL_SECT_ENRL = csY
                                        AND SFRSTCR_PIDM           = SGBSTDN_PIDM
                                        AND SGBSTDN_TERM_CODE_EFF  = (SELECT MAX(F.SGBSTDN_TERM_CODE_EFF)
                                                                        FROM SGBSTDN F
                                                                       WHERE F.SGBSTDN_PIDM           = SGBSTDN_PIDM
                                                                         AND F.SGBSTDN_TERM_CODE_EFF <= Y.SSRRESV_TERM_CODE
                                                                     )
                                        AND (Y.SSRRESV_LEVL_CODE || Y.SSRRESV_MAJR_CODE ||
                                             Y.SSRRESV_CLAS_CODE || Y.ROWID )  = (SELECT MAX(G.SSRRESV_LEVL_CODE || G.SSRRESV_MAJR_CODE ||
                                                                                             G.SSRRESV_CLAS_CODE || G.ROWID  )
                                                                                    FROM SSRRESV G
                                                                                   WHERE (    G.SSRRESV_CLAS_CODE = F_CLASS_CALC_FNC(SGBSTDN_PIDM, SGBSTDN_LEVL_CODE, Y.SSRRESV_TERM_CODE)
                                                                                          OR  G.SSRRESV_CLAS_CODE IS NULL
                                                                                         )
                                                                                     AND (   G.SSRRESV_MAJR_CODE = SGBSTDN_MAJR_CODE_1
                                                                                          OR G.SSRRESV_MAJR_CODE IS NULL
                                                                                         )
                                                                                     AND (   G.SSRRESV_LEVL_CODE = SGBSTDN_LEVL_CODE
                                                                                          OR G.SSRRESV_LEVL_CODE IS NULL
                                                                                         )
                                                                                     AND G.SSRRESV_CRN       = Y.SSRRESV_CRN
                                                                                     AND G.SSRRESV_TERM_CODE = Y.SSRRESV_TERM_CODE
                                                                                 )
                                    )
           WHERE Y.SSRRESV_ENRL      <> (SELECT NVL(COUNT(SFRSTCR_CRN),cn0)
                                           FROM SFRSTCR,
                                                STVRSTS,
                                                SGBSTDN
                                          WHERE SFRSTCR_TERM_CODE      = Y.SSRRESV_TERM_CODE
                                            AND SFRSTCR_CRN            = Y.SSRRESV_CRN
                                            AND SFRSTCR_RSTS_CODE      = STVRSTS_CODE
                                            AND STVRSTS_INCL_SECT_ENRL = csY
                                            AND SFRSTCR_PIDM           = SGBSTDN_PIDM
                                            AND SGBSTDN_TERM_CODE_EFF  = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                                                            FROM SGBSTDN B
                                                                           WHERE B.SGBSTDN_PIDM           = SGBSTDN_PIDM
                                                                             AND B.SGBSTDN_TERM_CODE_EFF <= Y.SSRRESV_TERM_CODE
                                                                         )
                                            AND (Y.SSRRESV_LEVL_CODE || Y.SSRRESV_MAJR_CODE ||
                                                 Y.SSRRESV_CLAS_CODE || Y.ROWID )  = (SELECT MAX(C.SSRRESV_LEVL_CODE || C.SSRRESV_MAJR_CODE ||
                                                                                                 C.SSRRESV_CLAS_CODE || C.ROWID)
                                                                                        FROM SSRRESV C
                                                                                       WHERE (   C.SSRRESV_CLAS_CODE = F_CLASS_CALC_FNC(SGBSTDN_PIDM, SGBSTDN_LEVL_CODE, Y.SSRRESV_TERM_CODE )
                                                                                              OR C.SSRRESV_CLAS_CODE IS NULL
                                                                                             )
                                                                                         AND (   C.SSRRESV_MAJR_CODE = SGBSTDN_MAJR_CODE_1
                                                                                              OR C.SSRRESV_MAJR_CODE IS NULL
                                                                                             )
                                                                                         AND (   C.SSRRESV_LEVL_CODE = SGBSTDN_LEVL_CODE
                                                                                              OR C.SSRRESV_LEVL_CODE IS NULL
                                                                                             )
                                                                                         AND C.SSRRESV_CRN       = Y.SSRRESV_CRN
                                                                                         AND C.SSRRESV_TERM_CODE = Y.SSRRESV_TERM_CODE
                                                                                         AND C.SSRRESV_TERM_CODE  = psTerm
                                                                                     )
                                            AND SFRSTCR_TERM_CODE  = psTerm
                                        )
             AND EXISTS (SELECT NULL
                           FROM SFRSTCR,
                                STVRSTS,
                                SGBSTDN
                          WHERE SFRSTCR_TERM_CODE      = Y.SSRRESV_TERM_CODE
                            AND SFRSTCR_CRN            = Y.SSRRESV_CRN
                            AND SFRSTCR_RSTS_CODE      = STVRSTS_CODE
                            AND STVRSTS_INCL_SECT_ENRL = csY
                            AND SFRSTCR_PIDM           = SGBSTDN_PIDM
                            AND SGBSTDN_TERM_CODE_EFF  = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                                            FROM SGBSTDN B
                                                           WHERE B.SGBSTDN_PIDM           = SGBSTDN_PIDM
                                                             AND B.SGBSTDN_TERM_CODE_EFF <= Y.SSRRESV_TERM_CODE
                                                         )
                            AND (Y.SSRRESV_LEVL_CODE || Y.SSRRESV_MAJR_CODE ||
                                 Y.SSRRESV_CLAS_CODE || Y.ROWID )  =  (SELECT MAX(C.SSRRESV_LEVL_CODE || C.SSRRESV_MAJR_CODE ||
                                                                                  C.SSRRESV_CLAS_CODE || C.ROWID)
                                                                         FROM SSRRESV C
                                                                        WHERE (   C.SSRRESV_CLAS_CODE = F_CLASS_CALC_FNC(SGBSTDN_PIDM, SGBSTDN_LEVL_CODE, Y.SSRRESV_TERM_CODE)
                                                                               OR C.SSRRESV_CLAS_CODE IS NULL
                                                                              )
                                                                          AND (   C.SSRRESV_MAJR_CODE = SGBSTDN_MAJR_CODE_1
                                                                               OR C.SSRRESV_MAJR_CODE IS NULL
                                                                              )
                                                                          AND (   C.SSRRESV_LEVL_CODE = SGBSTDN_LEVL_CODE
                                                                               OR C.SSRRESV_LEVL_CODE IS NULL
                                                                              )
                                                                          AND C.SSRRESV_CRN       = Y.SSRRESV_CRN
                                                                          AND C.SSRRESV_TERM_CODE = Y.SSRRESV_TERM_CODE
                                                                          AND C.SSRRESV_TERM_CODE = psTerm
                                                                      )
                            AND SFRSTCR_TERM_CODE  = psTerm
                        )
             AND Y.SSRRESV_TERM_CODE  = psTerm;

      EXCEPTION
          WHEN OTHERS THEN
               NULL;
      END;

      COMMIT;

      --UPDATE INCORRECT WAITING LIST COUNT ON RESERVED SEATS SSBXLST
      BEGIN
          UPDATE SSRRESV  Y
             SET Y.SSRRESV_WAIT_COUNT = (SELECT NVL(COUNT(SFRSTCR_CRN),cn0)
                                           FROM SFRSTCR,
                                                STVRSTS,
                                                SGBSTDN
                                          WHERE SFRSTCR_TERM_CODE     = Y.SSRRESV_TERM_CODE
                                            AND SFRSTCR_CRN           = Y.SSRRESV_CRN
                                            AND SFRSTCR_RSTS_CODE     = STVRSTS_CODE
                                            AND STVRSTS_WAIT_IND      = csY
                                            AND SFRSTCR_PIDM          = SGBSTDN_PIDM
                                            AND SGBSTDN_TERM_CODE_EFF = (SELECT MAX(F.SGBSTDN_TERM_CODE_EFF)
                                                                           FROM SGBSTDN F
                                                                          WHERE F.SGBSTDN_PIDM = SGBSTDN_PIDM
                                                                            AND F.SGBSTDN_TERM_CODE_EFF <= Y.SSRRESV_TERM_CODE)
                                                                            AND (Y.SSRRESV_LEVL_CODE || Y.SSRRESV_MAJR_CODE ||
                                                                                 Y.SSRRESV_CLAS_CODE || Y.ROWID )  =  (SELECT MAX(G.SSRRESV_LEVL_CODE || G.SSRRESV_MAJR_CODE ||
                                                                                                                                  G.SSRRESV_CLAS_CODE || G.ROWID)
                                                                                                                         FROM SSRRESV G
                                                                                                                        WHERE (   G.SSRRESV_CLAS_CODE = F_CLASS_CALC_FNC(SGBSTDN_PIDM, SGBSTDN_LEVL_CODE, Y.SSRRESV_TERM_CODE )
                                                                                                                               OR G.SSRRESV_CLAS_CODE IS NULL
                                                                                                                              )
                                                                                                                          AND (   G.SSRRESV_MAJR_CODE = SGBSTDN_MAJR_CODE_1
                                                                                                                               OR G.SSRRESV_MAJR_CODE IS NULL
                                                                                                                              )
                                                                                                                          AND (   G.SSRRESV_LEVL_CODE = SGBSTDN_LEVL_CODE
                                                                                                                               OR G.SSRRESV_LEVL_CODE IS NULL
                                                                                                                              )
                                                                                                                          AND G.SSRRESV_CRN       = Y.SSRRESV_CRN
                                                                                                                          AND G.SSRRESV_TERM_CODE = Y.SSRRESV_TERM_CODE
                                                                                                                      )
                                        )
           WHERE Y.SSRRESV_WAIT_COUNT <> (SELECT NVL(COUNT(SFRSTCR_CRN),cn0)
                                            FROM SFRSTCR,
                                                 STVRSTS,
                                                 SGBSTDN
                                           WHERE SFRSTCR_TERM_CODE     = Y.SSRRESV_TERM_CODE
                                             AND SFRSTCR_CRN           = Y.SSRRESV_CRN
                                             AND SFRSTCR_RSTS_CODE     = STVRSTS_CODE
                                             AND STVRSTS_WAIT_IND      = csY
                                             AND SFRSTCR_PIDM          = SGBSTDN_PIDM
                                             AND SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                                                            FROM SGBSTDN B
                                                                           WHERE B.SGBSTDN_PIDM           = SGBSTDN_PIDM
                                                                             AND B.SGBSTDN_TERM_CODE_EFF <= Y.SSRRESV_TERM_CODE
                                                                         )
                                             AND (Y.SSRRESV_LEVL_CODE || Y.SSRRESV_MAJR_CODE ||
                                                  Y.SSRRESV_CLAS_CODE || Y.ROWID )  =  (SELECT MAX(C.SSRRESV_LEVL_CODE || C.SSRRESV_MAJR_CODE ||
                                                                                                   C.SSRRESV_CLAS_CODE || C.ROWID)
                                                                                          FROM SATURN.SSRRESV C
                                                                                         WHERE (   C.SSRRESV_CLAS_CODE = F_CLASS_CALC_FNC(SGBSTDN_PIDM, SGBSTDN_LEVL_CODE, Y.SSRRESV_TERM_CODE)
                                                                                                OR C.SSRRESV_CLAS_CODE IS NULL
                                                                                               )
                                                                                           AND (   C.SSRRESV_MAJR_CODE = SGBSTDN_MAJR_CODE_1
                                                                                                OR C.SSRRESV_MAJR_CODE IS NULL
                                                                                               )
                                                                                           AND (   C.SSRRESV_LEVL_CODE = SGBSTDN_LEVL_CODE
                                                                                                OR C.SSRRESV_LEVL_CODE IS NULL)
                                                                                           AND C.SSRRESV_CRN       = Y.SSRRESV_CRN
                                                                                           AND C.SSRRESV_TERM_CODE = Y.SSRRESV_TERM_CODE
                                                                                           AND SFRSTCR_TERM_CODE  = psTerm
                                                                                       )
                                             AND SFRSTCR_TERM_CODE  = psTerm
                                         )
             AND EXISTS (SELECT NULL
                           FROM SFRSTCR,
                                STVRSTS,
                                SGBSTDN
                          WHERE SFRSTCR_TERM_CODE     = Y.SSRRESV_TERM_CODE
                            AND SFRSTCR_CRN           = Y.SSRRESV_CRN
                            AND SFRSTCR_RSTS_CODE     = STVRSTS_CODE
                            AND STVRSTS_WAIT_IND      = csY
                            AND SFRSTCR_PIDM          = SGBSTDN_PIDM
                            AND SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                                           FROM SGBSTDN B
                                                          WHERE B.SGBSTDN_PIDM           = SGBSTDN_PIDM
                                                            AND B.SGBSTDN_TERM_CODE_EFF <= Y.SSRRESV_TERM_CODE
                                                        )
                            AND (Y.SSRRESV_LEVL_CODE || Y.SSRRESV_MAJR_CODE ||
                                 Y.SSRRESV_CLAS_CODE || Y.ROWID )  =  (SELECT MAX(C.SSRRESV_LEVL_CODE || C.SSRRESV_MAJR_CODE ||
                                                                                  C.SSRRESV_CLAS_CODE || C.ROWID)
                                                                         FROM SSRRESV C
                                                                        WHERE (   C.SSRRESV_CLAS_CODE = F_CLASS_CALC_FNC( SGBSTDN_PIDM, SGBSTDN_LEVL_CODE, Y.SSRRESV_TERM_CODE)
                                                                               OR C.SSRRESV_CLAS_CODE IS NULL
                                                                              )
                                                                          AND (   C.SSRRESV_MAJR_CODE = SGBSTDN_MAJR_CODE_1
                                                                               OR C.SSRRESV_MAJR_CODE IS NULL
                                                                              )
                                                                          AND (   C.SSRRESV_LEVL_CODE = SGBSTDN_LEVL_CODE
                                                                               OR C.SSRRESV_LEVL_CODE IS NULL
                                                                              )
                                                                          AND C.SSRRESV_CRN       = Y.SSRRESV_CRN
                                                                          AND C.SSRRESV_TERM_CODE = Y.SSRRESV_TERM_CODE
                                                                          AND C.SSRRESV_TERM_CODE  = psTerm
                                                                      )
                           AND SFRSTCR_TERM_CODE  = psTerm
                        )
             AND Y.SSRRESV_TERM_CODE   = psTerm;

       EXCEPTION
          WHEN OTHERS THEN
               NULL;
       END;

      COMMIT;

  END PWAENRL2;
/
DROP PROCEDURE BANINST1.PWAGRAN;

CREATE OR REPLACE PROCEDURE BANINST1.PWAGRAN(psObject VARCHAR2) AUTHID DEFINER IS
/*
         Tarea: Realiza la asignacin del "GRANT EXECUTE" al usuario WEB_BAN_....
         Autor: MAC
         Fecha: 03/02/2010

  Modificacion: 03/12/2010
                GEPC
                * Se comprueba que el sinonimo publico exista no importa si esta valido o invalido.

*/

  vsPrilg VARCHAR2(20) := NULL;
  vsOwner VARCHAR2(32) := NULL;

  csVALID     CONSTANT VARCHAR2(5) := 'VALID';
  csPUBLIC    CONSTANT VARCHAR2(6) := 'PUBLIC';
  csINVALID   CONSTANT VARCHAR2(7) := 'INVALID';
  csSYNONYM   CONSTANT VARCHAR2(7) := 'SYNONYM';
  csEXECUTE   CONSTANT VARCHAR2(7) := 'EXECUTE';
  csBANINST1  CONSTANT VARCHAR2(8) := 'BANINST1';
  csWWW2_USER CONSTANT VARCHAR2(9) := 'WWW2_USER';
  cn1         CONSTANT NUMBER(1)   := 1;

  -- Asigna el permiso de ejecucin para el usuario WEB
  -- grantExecute
  procedure grantExecute(psUser varchar2) is

  vnCursor integer := null;

  begin
      vnCursor := dbms_sql.open_cursor;

      dbms_sql.parse(vnCursor, 'GRANT EXECUTE ON BANINST1.'||psObject||' TO '||psUser, dbms_sql.v7);

      dbms_sql.close_cursor(vncursor);

  exception
      when others then
           dbms_sql.close_cursor(vnCursor);

           RAISE;

  end grantExecute;

  -- Crea el sinonimo publico para la aplicacin WEB
  -- publicSynonym
  procedure publicSynonym is

  vnCursor integer := null;

  begin
      vnCursor := dbms_sql.open_cursor;

      dbms_sql.parse(vnCursor, 'CREATE PUBLIC SYNONYM '||psObject||' FOR BANINST1.'||psObject, dbms_sql.v7);

      dbms_sql.close_cursor(vncursor);

  exception
      when others then
           dbms_sql.close_cursor(vnCursor);

           RAISE;

  end publicSynonym;

  BEGIN
      --Revisa si el objeto ya puede ser ejecutado por los usuarios WEB_BAN
      BEGIN
          SELECT PRIVILEGE
            INTO vsPrilg
            FROM DBA_TAB_PRIVS
           WHERE TABLE_NAME = psObject
             AND PRIVILEGE  = csEXECUTE
             AND GRANTOR    = csBANINST1
             AND GRANTEE    = csWWW2_USER
          HAVING COUNT(cn1) = cn1
           GROUP BY PRIVILEGE;
      EXCEPTION
          WHEN NO_DATA_FOUND THEN
               grantExecute('WWW2_USER');

      END;

      BEGIN
          SELECT OWNER
            INTO vsOwner
            FROM DBA_OBJECTS
           WHERE OWNER        = csPUBLIC
             AND OBJECT_TYPE  = csSYNONYM
             AND OBJECT_NAME  = psObject;
      EXCEPTION
          WHEN NO_DATA_FOUND THEN
               publicSynonym;
      END;

  EXCEPTION
      WHEN OTHERS THEN
           RAISE;

  END PWAGRAN;
/


DROP PUBLIC SYNONYM PWAGRAN;

CREATE PUBLIC SYNONYM PWAGRAN FOR BANINST1.PWAGRAN;


GRANT EXECUTE ON BANINST1.PWAGRAN TO BANSECR;

GRANT EXECUTE ON BANINST1.PWAGRAN TO WWW_USER;
DROP PROCEDURE BANINST1.PWAGWBT;

CREATE OR REPLACE PROCEDURE BANINST1.PWAGWBT IS

/*

    TAREA: * Consulta de admiciones para alimentar la lectura del CRM
             para los periodos definidos en "GWBTERM".
    FECHA: 20/12/2010
    AUTOR: GEPC
   MODULO: GENERAL

*/

  vsError VARCHAR2(4000) := NULL;

  cn1        CONSTANT NUMBER(1)    := 1;
  cn2        CONSTANT NUMBER(1)    := 2;
  csEsp      CONSTANT VARCHAR2(1)  := ' ';
  csY        CONSTANT VARCHAR2(1)  := 'Y';
  csA        CONSTANT VARCHAR2(1)  := 'A';
  csPR       CONSTANT VARCHAR2(2)  := 'PR';
  cs99       CONSTANT VARCHAR2(2)  := '99';
  cs88       CONSTANT VARCHAR2(2)  := '88';
  cs440      CONSTANT VARCHAR2(3)  := '440';
  cs115      CONSTANT VARCHAR2(3)  := '115';
  cs221      CONSTANT VARCHAR2(3)  := '221';
  csEsp_     CONSTANT VARCHAR2(3)  := ' - ';
  csYYYY     CONSTANT VARCHAR2(4)  := 'YYYY';
  csPSMA     CONSTANT VARCHAR2(4)  := 'PSMA';
  csPSLC     CONSTANT VARCHAR2(4)  := 'PSLC';
  csPSCI     CONSTANT VARCHAR2(4)  := 'PSCI';
  csPSHC     CONSTANT VARCHAR2(4)  := 'PSHC';
  csTFPA     CONSTANT VARCHAR2(4)  := 'TFPA';
  csTMPA     CONSTANT VARCHAR2(4)  := 'TMPA';
  csNEME     CONSTANT VARCHAR2(4)  := 'NEME';
  cs11110    CONSTANT VARCHAR2(5)  := '11110';
  cs11220    CONSTANT VARCHAR2(5)  := '11220';
  cs11210    CONSTANT VARCHAR2(5)  := '11210';
  cs22220    CONSTANT VARCHAR2(5)  := '22220';
  csGENERAL  CONSTANT VARCHAR2(7)  := 'GENERAL';
  csGWBTCR0  CONSTANT VARCHAR2(7)  := 'GWBTCR0';
  csGWBTCR1  CONSTANT VARCHAR2(7)  := 'GWBTCR1';
  csGWBTCR2  CONSTANT VARCHAR2(7)  := 'GWBTCR2';
  csGWBTCR3  CONSTANT VARCHAR2(7)  := 'GWBTCR3';
  csGWBTCRM  CONSTANT VARCHAR2(7)  := 'GWBTCRM';
  cs11440050 CONSTANT VARCHAR2(8)  := '11440050';
  cs11330010 CONSTANT VARCHAR2(8)  := '11330010';
  csSysDate  CONSTANT DATE         := SYSDATE;
  csUser     CONSTANT VARCHAR2(32) := USER;

  -- Informacin personal
  -- insertGWBTCR0
  procedure insertGWBTCR0 is

  begin
      insert into gwbtcr0(
      gwbtcr0_pidm,                 gwbtcr0_name_suffix,          gwbtcr0_id,                  gwbtcr0_program_code,
      gwbtcr0_date_banner,          gwbtcr0_sts_adm,              gwbtcr0_term_code,           gwbtcr0_sarhead_code,
      gwbtcr0_sarhead_apls_code,    gwbtcr0_sarhead_add_date,     gwbtcr0_saretry_priority_no, gwbtcr0_saraddr_street_line1,
      gwbtcr0_saraddr_street_line2, gwbtcr0_saraddr_street_line3, gwbtcr0_saraddr_city,        gwbtcr0_saraddr_stat_cde,
      gwbtcr0_saraddr_cnty_cde,     gwbtcr0_saraddr_zip,          gwbtcr0_saraddr_natn_cde,    gwbtcr0_sarphon_pqlf_cde1,
      gwbtcr0_sarphon_phone1,       gwbtcr0_sarphon_pqlf_cde2,    gwbtcr0_sarphon_phone2,      gwbtcr0_sarpers_first_name,
      gwbtcr0_sarpers_last_name,    gwbtcr0_sarpers_middle_name1, gwbtcr0_sarpers_birth_dte,   gwbtcr0_sarpers_gender,
      gwbtcr0_sarpers_citz_cde,     gwbtcr0_sarpcol_iden_cde,     gwbtcr0_sarrqst_ansr_desc,   gwbtcr0_sarrqst_ansr_desc2,
      gwbtcr0_activity_date,        gwbtcr0_user
      )
      select spride.idenPidm,
             spbpers_name_suffix,
             spride.idenIddd,
             (select j.sovlcur_program
                from sovlcur j
               where j.sovlcur_pidm        = a.saradap_pidm
                 and j.sovlcur_key_seqno   = a.saradap_appl_no
                 and j.sovlcur_term_code   = a.saradap_term_code_entry
                 and j.sovlcur_lmod_code   = sb_curriculum_str.f_admissions
                 and j.sovlcur_current_ind = csY
                 and j.sovlcur_active_ind  = csY
                 and j.sovlcur_seqno       = (select min(k.sovlcur_seqno)
                                                from sovlcur k
                                               where k.sovlcur_pidm        = a.saradap_pidm
                                                 and k.sovlcur_key_seqno   = a.saradap_appl_no
                                                 and k.sovlcur_term_code   = a.saradap_term_code_entry
                                                 and k.sovlcur_lmod_code   = sb_curriculum_str.f_admissions
                                                 and k.sovlcur_current_ind = csY
                                                 and k.sovlcur_active_ind  = csY
                                             )
                 and rownum                = cn1
             ) lcurProg,
             a.saradap_appl_date,
             a.saradap_apst_code,
             a.saradap_term_code_entry,
             a.saradap_admt_code,
             (select i.sarhead_apls_code
                from sarhead i
               where i.sarhead_appl_seqno = (select max(j.sarhead_appl_seqno)
                                               from sarhead j
                                              where j.sarhead_aidm = i.sarhead_aidm
                                            )
                 and i.sarhead_aidm       = (select sabiden_aidm
                                               from sabiden
                                              where sabiden_pidm = a.saradap_pidm
                                            )
                 and rownum               = cn1
             ) aplsCode,
             a.saradap_appl_date,
             a.saradap_appl_no,
             spradd.addrLIN1,
             spradd.addrLIN2,
             spradd.addrLIN3,
             spradd.addrCity,
             spradd.addrStat,
             spradd.addrCnty,
             spradd.addrZipp,
             spradd.addrNatn,
             csTFPA,
             (select sprtele_phone_area||csEsp_||sprtele_phone_number||csEsp_||sprtele_phone_ext
                from sprtele
               where sprtele_seqno     = (select max(sprtele_seqno)
                                            from sprtele
                                           where sprtele_tele_code = csTFPA
                                             and sprtele_pidm      = a.saradap_pidm
                                         )
                 and sprtele_tele_code = csTFPA
                 and sprtele_pidm      = a.saradap_pidm
                 and rownum            = cn1
             ) AS teleArea,
             csTMPA,
             (select sprtele_phone_area||csEsp_||sprtele_phone_number||csEsp_||sprtele_phone_ext
                from sprtele
               where sprtele_seqno     = (select max(sprtele_seqno)
                                            from sprtele
                                           where sprtele_tele_code = csTMPA
                                             and sprtele_pidm      = a.saradap_pidm
                                         )
                 and sprtele_tele_code = csTMPA
                 and sprtele_pidm      = a.saradap_pidm
                 and rownum            = cn1
             ) AS teleAre2,
             spride.idenFirs,
             spride.idenLast,
             spride.idenMiii,
             spbpers_birth_date,
             spbpers_sex,
             spbpers_citz_code,
             sorpcol_sbgi_code,
             (select sarquan_answer
                from sarquan g
               where g.sarquan_appl_no         = (select max(h.sarquan_appl_no)
                                                    from sarquan h
                                                   where h.sarquan_seqno           = g.sarquan_seqno
                                                     and h.sarquan_term_code_entry = g.sarquan_term_code_entry
                                                     and h.sarquan_pidm            = g.sarquan_pidm
                                                 )
                 and g.sarquan_seqno           = cn1
                 and g.sarquan_term_code_entry = a.saradap_term_code_entry
                 and g.sarquan_pidm            = a.saradap_pidm
                 and rownum                    = cn1
             ) ANSWER1,
             (select sarquan_answer
                from sarquan g
               where g.sarquan_appl_no         = (select max(h.sarquan_appl_no)
                                                    from sarquan h
                                                   where h.sarquan_seqno           = g.sarquan_seqno
                                                     and h.sarquan_term_code_entry = g.sarquan_term_code_entry
                                                     and h.sarquan_pidm            = g.sarquan_pidm
                                                 )
                 and g.sarquan_seqno           = cn2
                 and g.sarquan_term_code_entry = a.saradap_term_code_entry
                 and g.sarquan_pidm            = a.saradap_pidm
                 and rownum                    = cn1
             ) ANSWER2,
             csSysDate,
             csUSER
        from saradap a,
             spbpers,
             (select spriden_id         as idenIddd,
                     spriden_last_name  AS idenLast,
                     spriden_first_name AS idenFirs,
                     spriden_mi         AS idenMiii,
                     spriden_pidm       AS idenPidm
                from spriden
               where spriden_change_ind is null
             ) spride,
             (select c.spraddr_street_line1 as addrLIN1,
                     c.spraddr_street_line2 as addrLIN2,
                     c.spraddr_street_line3 as addrLIN3,
                     c.spraddr_city         as addrCity,
                     c.spraddr_stat_code    as addrStat,
                     c.spraddr_cnty_code    as addrCnty,
                     c.spraddr_zip          as addrZipp,
                     c.spraddr_natn_code    as addrNatn,
                     c.spraddr_pidm         as addrPidm
                from spraddr c
               where c.spraddr_atyp_code = csPR
                 and c.spraddr_seqno     = (select max(d.spraddr_seqno)
                                              from spraddr d
                                             where d.spraddr_atyp_code = csPR
                                               and d.spraddr_pidm      = c.spraddr_pidm
                                           )
             ) spradd,
             sorpcol
--       where a.saradap_appl_no          = (select max(b.saradap_appl_no)
--                                             from saradap b
--                                            where b.saradap_term_code_entry = a.saradap_term_code_entry
--                                              and b.saradap_pidm            = a.saradap_pidm
--                                          )
         where a.saradap_pidm             = spbpers_pidm
         and a.saradap_pidm             = spride.idenPidm
         and a.saradap_pidm             = spradd.addrPidm(+)
         and a.saradap_pidm             = sorpcol_pidm(+)
         and a.saradap_term_code_entry in (select gwbterm_term_code
                                             from gwbterm
                                            where gwbterm_check_ind = csY
                                          );

  exception
      when others then
           vsError := sqlerrm;

           rollback;

           insert into gwrerrm(gwrerrm_error,gwrerrm_origin) values(vsError, csGWBTCR0);

           commit;
  end insertGWBTCR0;

  -- Promedios
  -- insertGWBTCR1
  procedure insertGWBTCR1 is

  begin
      insert into gwbtcr1
      (
      gwbtcr1_pidm,       gwbtcr1_psma,       gwbtcr1_pslc,       gwbtcr1_psci,
      gwbtcr1_pshc,       gwbtcr1_nem,        gwbtcr1_psu_score,
      gwbtcr1_exp_autpsu, gwbtcr1_exp_autcol, gwbtcr1_exp_esar,   gwbtcr1_exp_eses,
      gwbtcr1_exp_conv,   gwbtcr1_exp_desc,   gwbtcr1_exp_bher,   gwbtcr1_exp_bpar,
      gwbtcr1_exp_basi,   gwbtcr1_exp_bdep
      )
      select
        gwbtcr.tcr0Pidm,
      fwascor(gwbtcr.tcr0Pidm, csPSMA),
      fwascor(gwbtcr.tcr0Pidm, csPSLC),
      fwascor(gwbtcr.tcr0Pidm, csPSCI),
      fwascor(gwbtcr.tcr0Pidm, csPSHC),
      fwascor(gwbtcr.tcr0Pidm, csNEME),
      fwappsu(gwbtcr.tcr0Pidm),
      fwrbeca(gwbtcr.tcr0Pidm, cs11110),
      fwrbeca(gwbtcr.tcr0Pidm, cs440),
      fwrbeca(gwbtcr.tcr0Pidm, cs11220),
      fwrbeca(gwbtcr.tcr0Pidm, cs11210),
      fwrbeca(gwbtcr.tcr0Pidm, cs99),
      fwrbeca(gwbtcr.tcr0Pidm, cs88,cs11440050),
      fwrbeca(gwbtcr.tcr0Pidm, cs11330010),
      fwrbeca(gwbtcr.tcr0Pidm, cs115),
      fwrbeca(gwbtcr.tcr0Pidm, cs221),
      fwrbeca(gwbtcr.tcr0Pidm, cs22220)
 from (select distinct gwbtcr0_pidm as tcr0Pidm
         from gwbtcr0
      ) gwbtcr;

  exception
      when others then
           vsError := sqlerrm;

           rollback;

           insert into gwrerrm(gwrerrm_error,gwrerrm_origin) values(vsError, csGWBTCR1);

           commit;
  end insertGWBTCR1;

  -- Correo electronico
  -- insertGWBTCR2
  procedure insertGWBTCR2 is

  begin
      insert into gwbtcr2
      (
      gwbtcr2_pidm,
      gwbtcr2_sarphon_pqlf_cde3,
      gwbtcr2_sarphon_phone3
      )
      select
      gwbtcr1_pidm,
      gorema.emalCode,
      gorema.emalAddr
        from (select goremal_emal_code     as emalCode,
                     goremal_email_address as emalAddr,
                     goremal_pidm          as emalPidm
                from goremal
               where goremal_status_ind = csA
             ) gorema,
             gwbtcr1
       where gorema.emalPidm = gwbtcr1_pidm;

  exception
      when others then
           vsError := sqlerrm;

           rollback;

           insert into gwrerrm(gwrerrm_error,gwrerrm_origin) values(vsError, csGWBTCR2);

           commit;
  end insertGWBTCR2;

  -- Registro de estado
  -- insertGWBTCR3
  procedure insertGWBTCR3 is

  begin
      insert into gwbtcr3
      (
      gwbtcr3_pidm,
      gwbtcr3_dec_adm,
      gwbtcr3_date_fin,
      gwbtcr3_user_fin
      )
      select
      gwbtcr1_pidm,
      sarapp.appdCode,
      sarapp.appdDate,
      sarapp.appdUser
        from (select e.sarappd_apdc_code       as appdcode,
                     e.sarappd_apdc_date       as appddate,
                     e.sarappd_user            as appduser,
                     e.sarappd_term_code_entry as appdterm,
                     e.sarappd_pidm            as appdpidm
                from sarappd e
               where (e.sarappd_appl_no, e.sarappd_seq_no) = (select max(f.sarappd_appl_no),
                                                                     max(f.sarappd_seq_no)
                                                                from sarappd f
                                                               where f.sarappd_term_code_entry = e.sarappd_term_code_entry
                                                                 and f.sarappd_pidm            = e.sarappd_pidm
                                                             )
             ) sarapp,
            gwbtcr1
      where sarapp.appdpidm = gwbtcr1_pidm;
        --and sarapp.appdterm = gwbtcr0_term_code;

  exception
      when others then
           vsError := sqlerrm;

           rollback;

           insert into gwrerrm(gwrerrm_error,gwrerrm_origin) values(vsError, csGWBTCR3);

           commit;
  end insertGWBTCR3;


  -- Promedios
  -- insertGWBTCR1
  procedure insertGWBTCR4 is

  begin
      insert into gwbtcr4
      (
      gwbtcr4_pidm,       GWBTCR4_PROGRAM_CODE, GWBTCR4_PROGRAM_SCORE
      )
      select
      gwbtcr0_pidm,
      gwbtcr0_program_code,
      fwapond(gwbtcr0_pidm, gwbtcr0_program_code)
      from gwbtcr0;
  exception
      when others then
           vsError := sqlerrm;

           rollback;

           insert into gwrerrm(gwrerrm_error,gwrerrm_origin) values(vsError, csGWBTCR1);

           commit;
  end insertGWBTCR4;

  -- homologacion de las consultas anteriores
  -- insertGWBTCRM
  procedure insertGWBTCRM is

  begin
      insert into gwbtcrm
      (
      gwbtcrm_name_suffix,          gwbtcrm_id,                  gwbtcrm_program_code,
      gwbtcrm_date_banner,
      gwbtcrm_sts_adm,
      gwbtcrm_term_code,            gwbtcrm_sarhead_code,
      gwbtcrm_sarhead_apls_code,    gwbtcrm_sarhead_add_date,     gwbtcrm_saretry_priority_no, gwbtcrm_saraddr_street_line1,
      gwbtcrm_saraddr_street_line2, gwbtcrm_saraddr_street_line3, gwbtcrm_saraddr_city,        gwbtcrm_saraddr_stat_cde,
      gwbtcrm_saraddr_cnty_cde,     gwbtcrm_saraddr_zip,          gwbtcrm_saraddr_natn_cde,    gwbtcrm_sarphon_pqlf_cde1,
      gwbtcrm_sarphon_phone1,       gwbtcrm_sarphon_pqlf_cde2,    gwbtcrm_sarphon_phone2,
      gwbtcrm_sarpers_first_name,   gwbtcrm_sarpers_last_name,   gwbtcrm_sarpers_middle_name1,
      gwbtcrm_sarpers_birth_dte,    gwbtcrm_sarpers_gender,       gwbtcrm_sarpers_citz_cde,
      gwbtcrm_sarpcol_iden_cde,     gwbtcrm_sarrqst_ansr_desc,   gwbtcrm_sarrqst_ansr_desc2,
      gwbtcrm_activity_date,        gwbtcrm_user ,
      gwbtcrm_psma,       gwbtcrm_pslc,       gwbtcrm_psci,
      gwbtcrm_pshc,       gwbtcrm_nem,        gwbtcrm_prog_score, gwbtcrm_psu_score,
      gwbtcrm_exp_autpsu, gwbtcrm_exp_autcol, gwbtcrm_exp_esar,   gwbtcrm_exp_eses,
      gwbtcrm_exp_conv,   gwbtcrm_exp_desc,   gwbtcrm_exp_bher,   gwbtcrm_exp_bpar,
      gwbtcrm_exp_basi,   gwbtcrm_exp_bdep,
      gwbtcrm_sarphon_pqlf_cde3,
      gwbtcrm_sarphon_phone3,
      gwbtcrm_dec_adm,
      gwbtcrm_date_fin,
      gwbtcrm_user_fin
      )
      select
      gwbtcr0_name_suffix,          gwbtcr0_id,                  gwbtcr0_program_code,
      gwbtcr0_date_banner,
      gwbtcr0_sts_adm,
      gwbtcr0_term_code,            gwbtcr0_sarhead_code,
      gwbtcr0_sarhead_apls_code,    gwbtcr0_sarhead_add_date,     gwbtcr0_saretry_priority_no, gwbtcr0_saraddr_street_line1,
      gwbtcr0_saraddr_street_line2, gwbtcr0_saraddr_street_line3, gwbtcr0_saraddr_city,        gwbtcr0_saraddr_stat_cde,
      gwbtcr0_saraddr_cnty_cde,     gwbtcr0_saraddr_zip,          gwbtcr0_saraddr_natn_cde,    gwbtcr0_sarphon_pqlf_cde1,
      gwbtcr0_sarphon_phone1,       gwbtcr0_sarphon_pqlf_cde2,    gwbtcr0_sarphon_phone2,
      gwbtcr0_sarpers_first_name,   gwbtcr0_sarpers_last_name,   gwbtcr0_sarpers_middle_name1,
      gwbtcr0_sarpers_birth_dte,    gwbtcr0_sarpers_gender,       gwbtcr0_sarpers_citz_cde,
      gwbtcr0_sarpcol_iden_cde,     gwbtcr0_sarrqst_ansr_desc,   gwbtcr0_sarrqst_ansr_desc2,
      gwbtcr0_activity_date,        gwbtcr0_user ,
      gwbtcr1_psma,       gwbtcr1_pslc,       gwbtcr1_psci,
      gwbtcr1_pshc,       gwbtcr1_nem,        GWBTCR4_PROGRAM_SCORE, gwbtcr1_psu_score,
      gwbtcr1_exp_autpsu, gwbtcr1_exp_autcol, gwbtcr1_exp_esar,   gwbtcr1_exp_eses,
      gwbtcr1_exp_conv,   gwbtcr1_exp_desc,   gwbtcr1_exp_bher,   gwbtcr1_exp_bpar,
      gwbtcr1_exp_basi,   gwbtcr1_exp_bdep,
      gwbtcr2_sarphon_pqlf_cde3,
      gwbtcr2_sarphon_phone3,
      gwbtcr3_dec_adm,
      gwbtcr3_date_fin,
      gwbtcr3_user_fin
        from gwbtcr0,
             gwbtcr1,
             gwbtcr2,
             gwbtcr3,
             gwbtcr4
       where gwbtcr0_pidm = gwbtcr1_pidm(+)
         and gwbtcr0_pidm = gwbtcr2_pidm(+)
         and gwbtcr0_pidm = gwbtcr3_pidm(+)
         and gwbtcr0_pidm = gwbtcr4_pidm(+);

  exception
      when others then
           vsError := sqlerrm;

           rollback;

           insert into gwrerrm(gwrerrm_error,gwrerrm_origin) values(vsError, csGWBTCRM);

           commit;
  end insertGWBTCRM;

  BEGIN
      -- Informacin personal
      insertGWBTCR0;
      --Promedios
      insertGWBTCR1;
      -- Correo electronico
      insertGWBTCR2;
      -- Registro de estado
      insertGWBTCR3;
      -- homologacion de las consultas anteriores
      insertGWBTCRM;

      COMMIT;

  EXCEPTION
      WHEN OTHERS THEN
           vsError := SQLERRM;

           ROLLBACK;

           INSERT INTO GWRERRM(GWRERRM_ERROR,GWRERRM_ORIGIN) VALUES(vsError, csGENERAL);

           COMMIT;

  END PWAGWBT;
/
DROP PROCEDURE BANINST1.PWAHIAC;

CREATE OR REPLACE PROCEDURE BANINST1.PWAHIAC(pnPidm     NUMBER,
                                             psPrograma VARCHAR2,
                                             psNivel    VARCHAR2,
                                             psMayab    VARCHAR2 DEFAULT NULL,
                                             psMatEx    VARCHAR2 DEFAULT NULL
                                            ) IS

  /*
            TAREA: Realizar la consulta para los diferentes reprotes de Historia academica
                   PWRHIAC, PWRHAMY, PWRHIPG
            FECHA: 01/04/2010
            AUTOR: GEPC

     MODIFICACION: 26/01/2011
                   GEPC
                   * Se crearon las tablas temporales "SWRDOCN" y "SWRDOUS", para actualizar valores
                     de historia acadmica.

     MODIFICACION: 28/01/2011
                   GEPC
                   * Se actualiza la prioridad del BLOQUE ELECTIVO.

     MODIFICACION: 22/03/2011
                   LPV
                   * Se agrego la condicin para el campo "csLevlCode", esto con el fin de que se tomen en cuenta todo el posgrado.

                                              and (
                                                     (
                                                          nvl(z.smrdocn_levl_code,csLevlCode) = csLevlCode
                                                      and
                                                          psNivel = csLIC
                                                     )
                                                  or
                                                     (
                                                          nvl(z.smrdocn_levl_code,csLevlCode) IN (csLevlCode,csES)
                                                      and
                                                          psNivel = csPOS
                                                     )
                                                  )

     MODIFICACION: 22/03/2011
                   LPV
                   * Corregir cerocreditos con extraordinario aprobado

     MODIFICACION: 02/06/2011
                   LPV
                   * Se cambio la sentancia del subquery reprobadasConCreditos, "por min(to_number(".
                   * Se agrego el parametro psMayab, para la parte de eliminar SWRDOCN (SMRDOCN_REPEAT_COURSE_IND = E y SMRDOCN_GMOD_CODE = N.
                   * Se agrego en el cursor aprobadasConCreditos el filtro para que existan en SHRTCKN (caso 00300063 MER3108).

     MODIFICACION: 20/06/2011
                   LPV
                   * Se agrego en el cursor materiasCeroCreditos, el filtro de que sean iguales los CRN.

     MODIFICACION: 24/10/2011
                   LPV
                   * Se agrego el parametro psMatEx para el reporte Historia acadmica (Posgrado)



  */

  vnPriority SWRCAPP.SWRCAPP_AREA_PRIORITY%TYPE := NULL;

  csPrograma  CONSTANT VARCHAR2(20) := psPrograma;
  csBloqueElc CONSTANT VARCHAR2(15) := 'BLOQUE ELECTIVO';
  csLevlCode  CONSTANT VARCHAR2(2)  := SUBSTR(psPrograma,1,2);
  csOtros     CONSTANT VARCHAR2(5)  := 'OTROS';
  csAsesores  CONSTANT VARCHAR2(8)  := 'ASESORES';
  csBloque    CONSTANT VARCHAR2(6)  := 'BLOQUE';
  csCN        CONSTANT VARCHAR2(2)  := 'CN';
  csUS        CONSTANT VARCHAR2(2)  := 'US';
  csOT        CONSTANT VARCHAR2(2)  := 'OT';
  csOU        CONSTANT VARCHAR2(2)  := 'OU';
  csPO        CONSTANT VARCHAR2(2)  := 'PO';
  csAC        CONSTANT VARCHAR2(2)  := 'AC';
  csAD        CONSTANT VARCHAR2(2)  := 'AD';
  csLIC       CONSTANT VARCHAR2(3)  := 'lic';
  csPOS       CONSTANT VARCHAR2(3)  := 'pos';
  csES        CONSTANT VARCHAR2(2)  := 'ES';
  csR         CONSTANT VARCHAR2(1)  := 'R';
  csH         CONSTANT VARCHAR2(1)  := 'H';
  csF         CONSTANT VARCHAR2(1)  := 'F';
  csP         CONSTANT VARCHAR2(1)  := 'P';
  csE         CONSTANT VARCHAR2(1)  := 'E';
  csX         CONSTANT VARCHAR2(1)  := 'X';
  csN         CONSTANT VARCHAR2(1)  := 'N';
  csI         CONSTANT VARCHAR2(1)  := 'I';
  cs4         CONSTANT VARCHAR2(1)  := '4';
  csNull      CONSTANT VARCHAR2(1)  := NULL;
  csTilde     CONSTANT VARCHAR2(2)  := '~';
  cs10        CONSTANT VARCHAR2(2)  := '10';
  cs20        CONSTANT VARCHAR2(2)  := '20';
  cs30        CONSTANT VARCHAR2(2)  := '30';
  cs40        CONSTANT VARCHAR2(2)  := '40';
  cn0         CONSTANT INTEGER      := 0;
  cn1         CONSTANT INTEGER      := 1;
  cn6         CONSTANT INTEGER      := 6;
  cn999       CONSTANT INTEGER      := 999;
  cn500       CONSTANT INTEGER      := 500;

  --Son registrados los cursos usados
  procedure cursosUsados is

  cursor cuLCnull is
         select l.shrtckl_levl_code       as levlCode,
                g.shrtckg_gmod_code       as gmodCode,
                g.shrtckg_credit_hours    as credHour,
                g.shrtckg_grde_code_final as grdeCode,
                n.shrtckn_seq_no          as tcknSeqn,
                n.shrtckn_crn             as tcknCrnn,
                n.shrtckn_term_code       as termCode,
                n.shrtckn_pidm            as tcknPidm
           from shrtckn n,
                shrtckg g,
                shrtckl l
          where g.shrtckg_pidm         = n.shrtckn_pidm
            and g.shrtckg_term_code    = n.shrtckn_term_code
            and g.shrtckg_tckn_seq_no  = n.shrtckn_seq_no
            and g.shrtckg_seq_no       = (select max(g1.shrtckg_seq_no)
                                            from shrtckg g1
                                           where g1.shrtckg_pidm        = g.shrtckg_pidm
                                             and g1.shrtckg_term_code   = g.shrtckg_term_code
                                             and g1.shrtckg_tckn_seq_no = g.shrtckg_tckn_seq_no
                                         )
            and l.shrtckl_pidm         = n.shrtckn_pidm
            and l.shrtckl_term_code    = n.shrtckn_term_code
            and l.shrtckl_tckn_seq_no  = n.shrtckn_seq_no
            and (n.shrtckn_seq_no,    n.shrtckn_crn,
                 n.shrtckn_term_code, n.shrtckn_pidm
                ) in
                (select
                 smrdous_tckn_seq_no, smrdous_crn,
                 smrdous_term_code,   smrdous_pidm
                   from swrdous
                  where (
                            smrdous_levl_code    is null
                         or smrdous_gmod_code    is null
                         or smrdous_grde_code    is null
                         or smrdous_credit_hours is null
                        )
                );

  begin
      insert into sWrdous
      (smrdous_pidm,                smrdous_request_no,         smrdous_compliance_order,    smrdous_area,
       smrdous_caa_seqno,           smrdous_group,              smrdous_key_rule,            smrdous_term_code_eff,
       smrdous_rul_seqno,           smrdous_rule,               smrdous_rul_seqno_2,         smrdous_program,
       smrdous_area_priority,       smrdous_cnt_in_program_ind, smrdous_cnt_in_area_ind,     smrdous_cnt_in_group_ind,
       smrdous_cnt_in_gpa_ind,      smrdous_split_ind,          smrdous_crse_source,         smrdous_applied_ind,
       smrdous_activity_date,       smrdous_a_crse_reuse_ind,   smrdous_a_attr_reuse_ind,    smrdous_g_crse_reuse_ind,
       smrdous_g_attr_reuse_ind,    smrdous_potential_used_ind, smrdous_equivalent_ind,      smrdous_catalog_ind,
       smrdous_agam_set,            smrdous_agam_subset,        smrdous_crn,                 smrdous_title,
       smrdous_term_code,           smrdous_levl_code,          smrdous_subj_code,           smrdous_crse_numb,
       smrdous_grde_code,           smrdous_gmod_code,          smrdous_credit_hours,        smrdous_credit_hours_used,
       smrdous_camp_code,           smrdous_coll_code,          smrdous_dept_code,           smrdous_attr_code,
       smrdous_atts_code,           smrdous_repeat_course_ind,  smrdous_trad_ind,            smrdous_tckn_seq_no,
       smrdous_trit_seq_no,         smrdous_tram_seq_no,        smrdous_trcr_seq_no,         smrdous_trce_seq_no,
       smrdous_dgmr_seq_no,         smrdous_earned_ind,         smrdous_cnt_in_area_gpa_ind, smrdous_cnt_in_prog_gpa_ind,
       smrdous_grde_quality_points, smrdous_compl_credits,      smrdous_compl_courses,       smrdous_actn_code,
       smrdous_adj_credits,         smrdous_adj_courses,        smrdous_adj_source_ind,      smrdous_agrl_key_rule,
       smrdous_agrl_rul_seqno,      smrdous_agrl_rule,          smrdous_agrl_rul_seqno_2,    smrdous_tesc_code,
       smrdous_test_score,          smrdous_concurrency_ind
      )
      select
       smrdous_pidm,                smrdous_request_no,         smrdous_compliance_order,    smrdous_area,
       smrdous_caa_seqno,           smrdous_group,              smrdous_key_rule,            smrdous_term_code_eff,
       smrdous_rul_seqno,           smrdous_rule,               smrdous_rul_seqno_2,         smrdous_program,
       smrdous_area_priority,       smrdous_cnt_in_program_ind, smrdous_cnt_in_area_ind,     smrdous_cnt_in_group_ind,
       smrdous_cnt_in_gpa_ind,      smrdous_split_ind,          smrdous_crse_source,         smrdous_applied_ind,
       smrdous_activity_date,       smrdous_a_crse_reuse_ind,   smrdous_a_attr_reuse_ind,    smrdous_g_crse_reuse_ind,
       smrdous_g_attr_reuse_ind,    smrdous_potential_used_ind, smrdous_equivalent_ind,      smrdous_catalog_ind,
       smrdous_agam_set,            smrdous_agam_subset,        smrdous_crn,                 smrdous_title,
       smrdous_term_code,           smrdous_levl_code,          smrdous_subj_code,           smrdous_crse_numb,
       smrdous_grde_code,           smrdous_gmod_code,          smrdous_credit_hours,        smrdous_credit_hours_used,
       smrdous_camp_code,           smrdous_coll_code,          smrdous_dept_code,           smrdous_attr_code,
       smrdous_atts_code,           smrdous_repeat_course_ind,  smrdous_trad_ind,            smrdous_tckn_seq_no,
       smrdous_trit_seq_no,         smrdous_tram_seq_no,        smrdous_trcr_seq_no,         smrdous_trce_seq_no,
       smrdous_dgmr_seq_no,         smrdous_earned_ind,         smrdous_cnt_in_area_gpa_ind, smrdous_cnt_in_prog_gpa_ind,
       smrdous_grde_quality_points, smrdous_compl_credits,      smrdous_compl_courses,       smrdous_actn_code,
       smrdous_adj_credits,         smrdous_adj_courses,        smrdous_adj_source_ind,      smrdous_agrl_key_rule,
       smrdous_agrl_rul_seqno,      smrdous_agrl_rule,          smrdous_agrl_rul_seqno_2,    smrdous_tesc_code,
       smrdous_test_score,          smrdous_concurrency_ind
        from smrdous a
       where a.smrdous_request_no = (select max(b.smrdous_request_no)
                                       from smrdous b
                                      where b.smrdous_pidm      = pnPidm
                                        and b.smrdous_program   = csPrograma
                                        and exists (select null
                                                      from smrprrq
                                                     where smrprrq_request_no = b.smrdous_request_no
                                                       and smrprrq_pidm       = pnPidm
                                                       and smrprrq_cprt_code  = csAsesores
                                                   )
                                    )
         and a.smrdous_pidm       = pnPidm
         and a.smrdous_program    = csPrograma;

      --actualizando valores nulos
      for regLcn in cuLCnull loop
          update sWrdous
             set smrdous_levl_code          = regLcn.levlCode,
                 smrdous_gmod_code          = regLcn.gmodCode,
                 smrdous_grde_code          = regLcn.grdeCode,
                 smrdous_credit_hours       = regLcn.credHour
           where smrdous_tckn_seq_no = regLcn.tcknSeqn
             and smrdous_crn         = regLcn.tcknCrnn
             and smrdous_term_code   = regLcn.termCode
             and smrdous_pidm        = regLcn.tcknPidm;
      end loop;

      --registra los datos a procesar
      insert into swrcapp
      (swrcapp_area,        swrcapp_area_priority, swrcapp_group,
       swrcapp_subj_code,   swrcapp_crse_numb,     swrcapp_grde_code,
       swrcapp_term_code,   swrcapp_credit_hours,  swrcapp_gmod_code,
       swrcapp_crn,         swrcapp_title,         swrcapp_request_no,
       swrcapp_crse_source, swrcapp_camp_code,     swrcapp_type
      )
      select
      smrdous_area,        smrdous_area_priority, smrdous_group,
      smrdous_subj_code,   smrdous_crse_numb,     smrdous_grde_code,
      smrdous_term_code,   smrdous_credit_hours,  smrdous_gmod_code,
      smrdous_crn,         smrdous_title,         smrdous_request_no,
      smrdous_crse_source, smrdous_camp_code,     csUS
        from sWrdous a
       where (a.smrdous_tckn_seq_no||
              a.smrdous_term_code) = (select min(z.smrdous_tckn_seq_no||z.smrdous_term_code)
                                        from sWrdous z
                                       where z.smrdous_request_no = a.smrdous_request_no
                                         and z.smrdous_crse_numb  = a.smrdous_crse_numb
                                         and z.smrdous_subj_code  = a.smrdous_subj_code
                                         and (
                                                (
                                                     z.smrdous_levl_code = csLevlCode
                                                 and
                                                     psNivel = csLIC
                                                )
                                             or
                                                (
                                                     z.smrdous_levl_code in (csLevlCode,csES)
                                                 and
                                                     psNivel = csPOS
                                                )
                                             )
                                         and z.smrdous_program    = csPrograma
                                         and z.smrdous_pidm       = pnPidm
                                     )
         and a.smrdous_pidm        = pnPidm
         and a.smrdous_program     = csPrograma
         and (
                (
                     a.smrdous_levl_code = csLevlCode
                 and
                     psNivel = csLIC
                )
             or
                (
                     a.smrdous_levl_code in (csLevlCode,csES)
                 and
                     psNivel = csPOS
                )
             );


  end cursosUsados;

  -- Cursos no usados
  procedure cursosNoUsados is

  cursor cuLCnull is
         select l.shrtckl_levl_code       as levlCode,
                g.shrtckg_gmod_code       as gmodCode,
                g.shrtckg_credit_hours    as credHour,
                g.shrtckg_grde_code_final as grdeCode,
                n.shrtckn_seq_no          as tcknSeqn,
                n.shrtckn_crn             as tcknCrnn,
                n.shrtckn_term_code       as termCode,
                n.shrtckn_pidm            as tcknPidm
           from shrtckn n,
                shrtckg g,
                shrtckl l
          where g.shrtckg_pidm         = n.shrtckn_pidm
            and g.shrtckg_term_code    = n.shrtckn_term_code
            and g.shrtckg_tckn_seq_no  = n.shrtckn_seq_no
            and g.shrtckg_seq_no       = (select max(g1.shrtckg_seq_no)
                                            from shrtckg g1
                                           where g1.shrtckg_pidm        = g.shrtckg_pidm
                                             and g1.shrtckg_term_code   = g.shrtckg_term_code
                                             and g1.shrtckg_tckn_seq_no = g.shrtckg_tckn_seq_no
                                         )
            and l.shrtckl_pidm         = n.shrtckn_pidm
            and l.shrtckl_term_code    = n.shrtckn_term_code
            and l.shrtckl_tckn_seq_no  = n.shrtckn_seq_no
            and (n.shrtckn_seq_no,    n.shrtckn_crn,
                 n.shrtckn_term_code, n.shrtckn_pidm
                ) in
                (select
                 smrdocn_tckn_seq_no, smrdocn_crn,
                 smrdocn_term_code,   smrdocn_pidm
                   from swrdocn
                  where (
                            smrdocn_levl_code    is null
                         or smrdocn_gmod_code    is null
                         or smrdocn_grde_code    is null
                         or smrdocn_credit_hours is null
                        )
                );

  begin
      insert into swrdocn
      (
      smrdocn_pidm,        smrdocn_request_no,        smrdocn_term_code,
      smrdocn_crn,         smrdocn_subj_code,         smrdocn_crse_numb,
      smrdocn_program,     smrdocn_activity_date,     smrdocn_crse_title,
      smrdocn_crse_source, smrdocn_levl_code,         smrdocn_grde_code,
      smrdocn_gmod_code,   smrdocn_credit_hours,      smrdocn_credit_hours_avail,
      smrdocn_camp_code,   smrdocn_coll_code,         smrdocn_dept_code,
      smrdocn_trad_ind,    smrdocn_repeat_course_ind, smrdocn_tckn_seq_no,
      smrdocn_trit_seq_no, smrdocn_tram_seq_no,       smrdocn_trcr_seq_no,
      smrdocn_trce_seq_no, smrdocn_dgmr_seq_no,       smrdocn_concurrency_ind
      )
      select
      smrdocn_pidm,        smrdocn_request_no,        smrdocn_term_code,
      smrdocn_crn,         smrdocn_subj_code,         smrdocn_crse_numb,
      smrdocn_program,     smrdocn_activity_date,     smrdocn_crse_title,
      smrdocn_crse_source, smrdocn_levl_code,         smrdocn_grde_code,
      smrdocn_gmod_code,   smrdocn_credit_hours,      smrdocn_credit_hours_avail,
      smrdocn_camp_code,   smrdocn_coll_code,         smrdocn_dept_code,
      smrdocn_trad_ind,    smrdocn_repeat_course_ind, smrdocn_tckn_seq_no,
      smrdocn_trit_seq_no, smrdocn_tram_seq_no,       smrdocn_trcr_seq_no,
      smrdocn_trce_seq_no, smrdocn_dgmr_seq_no,       smrdocn_concurrency_ind
        from smrdocn b
       where b.smrdocn_request_no = (select max(c.smrdocn_request_no)
                                       from smrdocn c
                                      where c.smrdocn_pidm      = pnPidm
                                        and c.smrdocn_program   = csPrograma
                                        and exists (select null
                                                      from smrprrq
                                                     where smrprrq_request_no = c.smrdocn_request_no
                                                       and smrprrq_pidm       = pnPidm
                                                       and smrprrq_cprt_code  = csAsesores
                                                   )
                                    )
         and exists (select null
                       from shrtckn
                      where shrtckn_pidm      = b.smrdocn_pidm
                        and shrtckn_subj_code = b.smrdocn_subj_code
                        and shrtckn_crse_numb = b.smrdocn_crse_numb
                    )
         and not exists (select null
                           from sWrdous
                          where smrdous_subj_code  = b.smrdocn_subj_code
                            and smrdous_crse_numb  = b.smrdocn_crse_numb
                            and smrdous_camp_code <> b.smrdocn_camp_code
                        )
         and b.smrdocn_program    = csPrograma
         and b.smrdocn_pidm       = pnPidm
         and (psMatEx = 'false' or psMatEx is null);

      --actualizando valores nulos
      for regLcn in cuLCnull loop
          update sWrdocn
             set smrdocn_levl_code          = regLcn.levlCode,
                 smrdocn_gmod_code          = regLcn.gmodCode,
                 smrdocn_grde_code          = regLcn.grdeCode,
                 smrdocn_credit_hours       = regLcn.credHour,
                 smrdocn_credit_hours_avail = regLcn.credHour
           where smrdocn_tckn_seq_no = regLcn.tcknSeqn
             and smrdocn_crn         = regLcn.tcknCrnn
             and smrdocn_term_code   = regLcn.termCode
             and smrdocn_pidm        = regLcn.tcknPidm;
      end loop;

  end cursosNoUsados;

  -- Cursos no usados
  -- Materias que se colocan en el bloque que les corresponde
  -- Reprobadas y con creditos
  procedure reprobadasConCreditos is

  begin
      insert into swrcapp
      (swrcapp_area,        swrcapp_area_priority, swrcapp_group,
       swrcapp_subj_code,   swrcapp_crse_numb,     swrcapp_grde_code,
       swrcapp_term_code,   swrcapp_credit_hours,  swrcapp_gmod_code,
       swrcapp_crn,         swrcapp_title,         swrcapp_request_no,
       swrcapp_crse_source, swrcapp_camp_code,     swrcapp_type
      )
      select
      SUBSTR(SMRDO2.Area,cn1,INSTR(SMRDO2.Area,csTilde)-cn1),
      TO_NUMBER(SUBSTR(SUBSTR(SMRDO2.Area,  INSTR(SMRDO2.Area,csTilde)+cn1),cn1,INSTR(SUBSTR(SMRDO2.Area,  INSTR(SMRDO2.Area,csTilde)+cn1),csTilde)-cn1)),
      SUBSTR(SUBSTR(SMRDO2.Area,  INSTR(SMRDO2.Area,csTilde)+cn1),  INSTR(SUBSTR(SMRDO2.Area,  INSTR(SMRDO2.Area,csTilde)+cn1),csTilde)+cn1),
      SMRDO2.Subj,          SMRDO2.Crse,           SMRDO2.Grde,
      SMRDO2.Term,          SMRDO2.Cred,           SMRDO2.Gmod,
      SMRDO2.Crn,           SMRDO2.Titl,           SMRDO2.Requ,
      SMRDO2.Sour,          SMRDO2.Camp,           csCN
         from (
               select nvl(
                           (select d.smrpaap_area||csTilde||d.smrpaap_area_priority||csTilde||b.smrgcaa_group
                              from smragam a,
                                   smrgcaa b,
                                   smrpaap d
                             where b.smrgcaa_group         = a.smragam_group
                               and b.smrgcaa_term_code_eff = a.smragam_term_code_eff
                               and b.smrgcaa_term_code_eff = (select max(c.smrgcaa_term_code_eff)
                                                                from smrgcaa c
                                                               where c.smrgcaa_subj_code      = b.smrgcaa_subj_code
                                                                 and c.smrgcaa_crse_numb_low  = b.smrgcaa_crse_numb_low
                                                                 and c.smrgcaa_term_code_eff <= a.smragam_term_code_eff
                                                                 and c.smrgcaa_group          = b.smrgcaa_group
                                                             )
                               and b.smrgcaa_seqno         = (select max(smrgcaa_seqno)
                                                                from smrgcaa c
                                                               where c.smrgcaa_subj_code      = b.smrgcaa_subj_code
                                                                 and c.smrgcaa_crse_numb_low  = b.smrgcaa_crse_numb_low
                                                                 and c.smrgcaa_group          = b.smrgcaa_group
                                                                 and c.smrgcaa_term_code_eff  = (select max(d.smrgcaa_term_code_eff)
                                                                                                   from smrgcaa d
                                                                                                  where d.smrgcaa_subj_code      = c.smrgcaa_subj_code
                                                                                                    and d.smrgcaa_crse_numb_low  = c.smrgcaa_crse_numb_low
                                                                                                    and d.smrgcaa_term_code_eff <= a.smragam_term_code_eff
                                                                                                    and d.smrgcaa_group          = c.smrgcaa_group
                                                                                                )
                                                             )
                               and a.smragam_area          = d.smrpaap_area
                               and d.smrpaap_term_code_eff = (select max(e.smrpaap_term_code_eff)
                                                                from smrpaap e
                                                               where e.smrpaap_area    = d.smrpaap_area
                                                                 and e.smrpaap_program = csPrograma
                                                             )
                               and d.smrpaap_program       = csPrograma
                               and b.smrgcaa_subj_code     = smrdocn_subj_code
                               and b.smrgcaa_crse_numb_low = smrdocn_crse_numb
                               and rownum = cn1
                           )
                          ,
                           nvl(
                                (select c.smrpaap_area||csTilde||c.smrpaap_area_priority||csTilde||null as Areapriogrop
                                   from smracaa a,
                                        smrpaap c
                                  where a.smracaa_term_code_eff = (select max(b.smracaa_term_code_eff)
                                                                     from smracaa b
                                                                    where b.smracaa_term_code_eff <= smrdocn_term_code
                                                                      and b.smracaa_subj_code      = a.smracaa_subj_code
                                                                      and b.smracaa_crse_numb_low  = a.smracaa_crse_numb_low
                                                                      and b.smracaa_area           = c.smrpaap_area
                                                                  )
                                    and a.smracaa_activity_date = (select max(c.smracaa_activity_date)
                                                                     from smracaa c
                                                                    where c.smracaa_term_code_eff <= smrdocn_term_code
                                                                      and c.smracaa_subj_code      = a.smracaa_subj_code
                                                                      and c.smracaa_crse_numb_low  = a.smracaa_crse_numb_low
                                                                      and c.smracaa_area           = c.smrpaap_area
                                                                      and c.smracaa_term_code_eff  = (select max(d.smracaa_term_code_eff)
                                                                                                        from smracaa d
                                                                                                       where d.smracaa_subj_code      = a.smracaa_subj_code
                                                                                                         and d.smracaa_crse_numb_low  = a.smracaa_crse_numb_low
                                                                                                         and d.smracaa_area           = c.smrpaap_area
                                                                                                         and d.smracaa_term_code_eff <= smrdocn_term_code
                                                                                                     )
                                                                  )
                                    and a.smracaa_area          = c.smrpaap_area
                                    and c.smrpaap_term_code_eff = (select max(d.smrpaap_term_code_eff)
                                                                     from smrpaap d
                                                                    where d.smrpaap_program = csPrograma
                                                                      and d.smrpaap_area    = c.smrpaap_area
                                                                  )
                                    and c.smrpaap_program       = csPrograma
                                    and a.smracaa_subj_code     = smrdocn_subj_code
                                    and a.smracaa_crse_numb_low = smrdocn_crse_numb
                                    and rownum = cn1
                                )
                               ,
                                nvl(
                                     (select e.smrpaap_area||csTilde||e.smrpaap_area_priority||csTilde||c.smragam_group as Areapriogrop
                                        from smragam c,
                                             smrgcaa d,
                                             smrpaap e
                                       where c.smragam_group         = d.smrgcaa_group
                                         and c.smragam_term_code_eff = d.smrgcaa_term_code_eff
                                         and exists (select null
                                                       from smrgrul a
                                                      where a.smrgrul_subj_code     = smrdocn_subj_code
                                                        and a.smrgrul_crse_numb_low = smrdocn_crse_numb
                                                        and a.smrgrul_group         = d.smrgcaa_group
                                                        and a.smrgrul_key_rule      = d.smrgcaa_rule
                                                        and a.smrgrul_term_code_eff = d.smrgcaa_term_code_eff
                                                        and a.smrgrul_seqno         = (select max(b.smrgrul_seqno)
                                                                                         from smrgrul b
                                                                                        where b.smrgrul_subj_code     = a.smrgrul_subj_code
                                                                                          and b.smrgrul_crse_numb_low = a.smrgrul_crse_numb_low
                                                                                     )
                                                    )
                                         and c.smragam_area          = e.smrpaap_area
                                         and e.smrpaap_term_code_eff = (select max(f.smrpaap_term_code_eff)
                                                                          from smrpaap f
                                                                         where f.smrpaap_program = csPrograma
                                                                           and f.smrpaap_area    = e.smrpaap_area
                                                                       )
                                         and e.smrpaap_program       = csPrograma
                                         and d.smrgcaa_crse_numb_low = smrdocn_crse_numb ---GEPC 04/01/2012
                                         and d.smrgcaa_subj_code     = smrdocn_subj_code --GEPC 04/01/2012
                                         and rownum = cn1
                                     )
                                    ,
                                     nvl(
                                          (select e.smrpaap_area||csTilde||e.smrpaap_area_priority||csTilde||c.smragam_group as Areapriogrop
                                             from smragam c,
                                                  smrgcaa d,
                                                  smrpaap e
                                            where c.smragam_group         = d.smrgcaa_group
                                              and c.smragam_term_code_eff = d.smrgcaa_term_code_eff
                                              and exists (select null
                                                            from smrgrul a
                                                           where a.smrgrul_subj_code     = smrdocn_subj_code
                                                             and a.smrgrul_crse_numb_low = smrdocn_crse_numb
                                                             and a.smrgrul_group         = d.smrgcaa_group
                                                             and a.smrgrul_key_rule      = d.smrgcaa_rule
                                                             and a.smrgrul_term_code_eff = d.smrgcaa_term_code_eff
                                                             and a.smrgrul_seqno         = (select max(b.smrgrul_seqno)
                                                                                              from smrgrul b
                                                                                             where b.smrgrul_subj_code     = a.smrgrul_subj_code
                                                                                               and b.smrgrul_crse_numb_low = a.smrgrul_crse_numb_low
                                                                                          )
                                                         )
                                              and c.smragam_area          = e.smrpaap_area
                                              and e.smrpaap_term_code_eff = (select max(f.smrpaap_term_code_eff)
                                                                               from smrpaap f
                                                                              where f.smrpaap_program = e.smrpaap_program
                                                                                and f.smrpaap_area    = e.smrpaap_area
                                                                            )
                                              and d.smrgcaa_crse_numb_low = smrdocn_crse_numb ---GEPC 04/01/2012
                                              and d.smrgcaa_subj_code     = smrdocn_subj_code --GEPC 04/01/2012
                                              and rownum = cn1
                                          )
                                         ,
--                                          nvl(
--                                               (select a.smracaa_area||csTilde||decode(substr(a.smracaa_area,length(a.smracaa_area),cn1),csF,cs10,csP,cs20,cs4,cs20,csE,cs30,cs40)||csTilde as areapriogrop
--                                                  from smracaa a
--                                                 where a.smracaa_term_code_eff = (select max(b.smracaa_term_code_eff)
--                                                                                    from smracaa b
--                                                                                   where b.smracaa_term_code_eff <= SMRDOCN_TERM_CODE
--                                                                                     and b.smracaa_subj_code      = a.smracaa_subj_code
--                                                                                     and b.smracaa_crse_numb_low  = a.smracaa_crse_numb_low
--                                                                                     and b.smracaa_area           = a.smracaa_area
--                                                                                 )
--                                                   and a.smracaa_activity_date = (select max(c.smracaa_activity_date)
--                                                                                    from smracaa c
--                                                                                   where c.smracaa_term_code_eff <= SMRDOCN_TERM_CODE
--                                                                                     and c.smracaa_subj_code      = a.smracaa_subj_code
--                                                                                     and c.smracaa_crse_numb_low  = a.smracaa_crse_numb_low
--                                                                                     and c.smracaa_area           = a.smracaa_area
--                                                                                     and c.smracaa_term_code_eff  = (select max(d.smracaa_term_code_eff)
--                                                                                                                       from smracaa d
--                                                                                                                      where d.smracaa_subj_code      = a.smracaa_subj_code
--                                                                                                                        and d.smracaa_crse_numb_low  = a.smracaa_crse_numb_low
--                                                                                                                        and d.smracaa_area           = a.smracaa_area
--                                                                                                                        and d.smracaa_term_code_eff <= SMRDOCN_TERM_CODE
--                                                                                                                    )
--                                                                                 )
--                                                   and a.smracaa_subj_code     = SMRDOCN_SUBJ_CODE
--                                                   and a.smracaa_crse_numb_low = SMRDOCN_CRSE_NUMB
--                                                   and rownum = cn1
--                                               )
--                                              ,
                                               csBloque||csTilde --csOtros||csTilde--
                                             --)
                                        )
                                   )
                              )
                         )                 as Area,
                      smrdocn_subj_code    as Subj,
                      smrdocn_crse_numb    as Crse,
                      smrdocn_grde_code    as Grde,
                      smrdocn_term_code    as Term,
                      smrdocn_credit_hours as Cred,
                      smrdocn_gmod_code    as Gmod,
                      smrdocn_crn          as Crn,
                      smrdocn_crse_title   as Titl,
                      smrdocn_request_no   as Requ,
                      smrdocn_crse_source  as Sour,
                      smrdocn_camp_code    as Camp
                 from sWrdocn b,
                      shrgrde a
                where not exists (select null
                                    from swrcapp
                                   where swrcapp_gmod_code    = b.smrdocn_gmod_code
                                     and swrcapp_subj_code    = b.smrdocn_subj_code
                                     and swrcapp_crse_numb    = b.smrdocn_crse_numb
                                     and swrcapp_crse_source <> csR
                                     and swrcapp_gmod_code   <> csX
                                 )
                  and b.smrdocn_credit_hours        > cn0
                  and a.shrgrde_quality_points      < cn6
                  and a.shrgrde_term_code_effective = (select max(d.shrgrde_term_code_effective)
                                                         from shrgrde d
                                                        where d.shrgrde_levl_code = a.shrgrde_levl_code
                                                          and d.shrgrde_code      = a.shrgrde_code
                                                      )
                  and a.shrgrde_levl_code           = smrdocn_levl_code
                  and a.shrgrde_code                = smrdocn_grde_code
                  and (b.smrdocn_tckn_seq_no||
                       b.smrdocn_term_code        ) = (select min(to_number(z.smrdocn_tckn_seq_no||z.smrdocn_term_code))
                                                         from sWrdocn z
                                                        where z.smrdocn_request_no = b.smrdocn_request_no
                                                          and z.smrdocn_crse_numb  = b.smrdocn_crse_numb
                                                          and z.smrdocn_subj_code  = b.smrdocn_subj_code
                                                          and z.smrdocn_gmod_code  = b.smrdocn_gmod_code
                                                          and (
                                                                 (
                                                                      z.smrdocn_levl_code = csLevlCode
                                                                  and
                                                                      psNivel = csLIC
                                                                 )
                                                              or
                                                                 (
                                                                      z.smrdocn_levl_code in (csLevlCode,csES)
                                                                  AND
                                                                      psNivel = csPOS
                                                                 )
                                                              )
                                                          and z.smrdocn_program    = csPrograma
                                                          and z.smrdocn_pidm       = pnPidm
                                                      )
                  and b.smrdocn_pidm                = pnPidm
                  and b.smrdocn_program             = csprograma
                  and (
                         (
                              b.smrdocn_levl_code = csLevlCode
                          and
                              psNivel = csLIC
                         )
                      or
                         (
                              b.smrdocn_levl_code in (csLevlCode,csES)
                          AND
                              psNivel = csPOS
                         )
                      )
              ) SMRDO2;

  end reprobadasConCreditos;

  -- Cursos no usados
  -- Materias con cero creditos
  procedure materiasCeroCreditos is

  begin
      insert into swrcapp
      (swrcapp_area,        swrcapp_area_priority, swrcapp_group,
       swrcapp_subj_code,   swrcapp_crse_numb,     swrcapp_grde_code,
       swrcapp_term_code,   swrcapp_credit_hours,  swrcapp_gmod_code,
       swrcapp_crn,         swrcapp_title,         swrcapp_request_no,
       swrcapp_crse_source, swrcapp_camp_code,     swrcapp_type
      )
      select
      csOtros,              cn999,                 csNull,
      smrdocn_subj_code,    smrdocn_crse_numb,     smrdocn_grde_code,
      smrdocn_term_code,    smrdocn_credit_hours,  smrdocn_gmod_code,
      smrdocn_crn,          smrdocn_crse_title,    smrdocn_request_no,
      smrdocn_crse_source,  smrdocn_camp_code,     csOT
        from sWrdocn b
       where (b.smrdocn_tckn_seq_no||
              b.smrdocn_term_code    ) = (select min(z.smrdocn_tckn_seq_no)||min(z.smrdocn_term_code)
                                              from sWrdocn z
                                             where z.smrdocn_request_no = b.smrdocn_request_no
                                               and z.smrdocn_crse_numb  = b.smrdocn_crse_numb
                                               and z.smrdocn_subj_code  = b.smrdocn_subj_code
                                              and (
                                                     (
                                                          nvl(z.smrdocn_levl_code,csLevlCode) = csLevlCode
                                                      and
                                                          psNivel = csLIC
                                                     )
                                                  or
                                                     (
                                                          nvl(z.smrdocn_levl_code,csLevlCode) IN (csLevlCode,csES)
                                                      and
                                                          psNivel = csPOS
                                                     )
                                                  )
                                               and z.smrdocn_program    = csPrograma
                                               and z.smrdocn_pidm       = pnPidm
                                           )
         and b.smrdocn_program         = csPrograma
         and b.smrdocn_pidm            = pnPidm
         and b.smrdocn_credit_hours    = cn0
         and (
                (
                     nvl(b.smrdocn_levl_code,csLevlCode) = csLevlCode
                 and
                     psNivel = csLIC
                )
             or
                (
                     nvl(b.smrdocn_levl_code,csLevlCode) IN (csLevlCode,csES)
                 and
                     psNivel = csPOS
                )
             );

  end materiasCeroCreditos;

  -- Cursos no usados
  -- MATERIAS QUE SE COLOCAN EN EL BLOQUE ELECTIVO
  -- Aprobadas y con creditos
  procedure aprobadasConCreditos is

  begin
      insert into swrcapp
      (swrcapp_area,        swrcapp_area_priority, swrcapp_group,
       swrcapp_subj_code,   swrcapp_crse_numb,     swrcapp_grde_code,
       swrcapp_term_code,   swrcapp_credit_hours,  swrcapp_gmod_code,
       swrcapp_crn,         swrcapp_title,         swrcapp_request_no,
       swrcapp_crse_source, swrcapp_camp_code,     swrcapp_type
      )
      select
      SMRDOC.Area,          SMRDOC.Prio,           SMRDOC.Grup,
      SMRDOC.Subj,          SMRDOC.Crse,           SMRDOC.Grde,
      SMRDOC.Term,          SMRDOC.Cred,           SMRDOC.Gmod,
      SMRDOC.Crnn,          SMRDOC.Titl,           SMRDOC.Requ,
      SMRDOC.Sour,          SMRDOC.Camp,           csAC
        from (select csBloque             as Area,
                     cn500                as Prio,
                     csNULL               as Grup,
                     smrdocn_subj_code    as Subj,
                     smrdocn_crse_numb    as Crse,
                     smrdocn_grde_code    as Grde,
                     smrdocn_term_code    as Term,
                     smrdocn_credit_hours as Cred,
                     smrdocn_gmod_code    as Gmod,
                     smrdocn_crn          as Crnn,
                     smrdocn_crse_title   as Titl,
                     (select shrgrde_quality_points
                        from shrgrde a
                       where a.shrgrde_term_code_effective = (select max(b.shrgrde_term_code_effective)
                                                                from shrgrde b
                                                               where b.shrgrde_levl_code = a.shrgrde_levl_code
                                                                 and b.shrgrde_code      = a.shrgrde_code
                                                             )
                         and a.shrgrde_levl_code = smrdocn_levl_code
                         and a.shrgrde_code      = smrdocn_grde_code
                     )                     as Grd2,
                     b.smrdocn_request_no  as Requ,
                     b.smrdocn_crse_source as Sour,
                     b.smrdocn_camp_code   as Camp
                from sWrdocn b
               where (b.smrdocn_tckn_seq_no||
                      b.smrdocn_term_code    ) = (select min(to_number(z.smrdocn_tckn_seq_no||z.smrdocn_term_code))
                                                      from sWrdocn z
                                                     where z.smrdocn_request_no = b.smrdocn_request_no
                                                       and z.smrdocn_crse_numb  = b.smrdocn_crse_numb
                                                       and z.smrdocn_subj_code  = b.smrdocn_subj_code
                                                       and (
                                                            (
                                                                 z.smrdocn_levl_code = csLevlCode
                                                             and
                                                                 psNivel = csLIC
                                                            )
                                                         or
                                                            (
                                                                 z.smrdocn_levl_code in (csLevlCode,csES)
                                                             and
                                                                 psNivel = csPOS
                                                            )
                                                           )
                                                       and z.smrdocn_program    = csPrograma
                                                       and z.smrdocn_pidm       = pnPidm
                                                   )
                 and not exists (select null
                                    from swrcapp
                                   where swrcapp_gmod_code    = b.smrdocn_gmod_code
                                     and swrcapp_subj_code    = b.smrdocn_subj_code
                                     and swrcapp_crse_numb    = b.smrdocn_crse_numb
                                     and swrcapp_crse_source <> csR
                                     and swrcapp_gmod_code   <> csX
                                 )
                 and b.smrdocn_program            = csPrograma
                 and b.smrdocn_pidm               = pnPidm
                 and b.smrdocn_credit_hours       > cn0
                 and (
                      (
                           b.smrdocn_levl_code = csLevlCode
                       and
                           psNivel = csLIC
                      )
                   or
                      (
                           b.smrdocn_levl_code in (csLevlCode,csES)
                       and
                           psNivel = csPOS
                      )
                   )
             ) SMRDOC
       where SMRDOC.Grd2 >= cn6;

  end aprobadasConCreditos;

  -- Cursos no usados
  -- filtros solo para posgrado
  procedure materiasPosgrado is

  begin
      insert into swrcapp
      (swrcapp_area,        swrcapp_area_priority, swrcapp_group,
       swrcapp_subj_code,   swrcapp_crse_numb,     swrcapp_grde_code,
       swrcapp_term_code,   swrcapp_credit_hours,  swrcapp_gmod_code,
       swrcapp_crn,         swrcapp_title,         swrcapp_request_no,
       swrcapp_crse_source, swrcapp_camp_code,     swrcapp_type
      )
      select
       csNULL,               cn999,                 cn0,
       smrdocn_subj_code,   smrdocn_crse_numb,     smrdocn_grde_code,
       smrdocn_term_code,   smrdocn_credit_hours,  smrdocn_gmod_code,
       smrdocn_crn,         smrdocn_crse_title,    smrdocn_request_no,
       smrdocn_crse_source, smrdocn_camp_code,     csPO
        from sWrdocn b
       where (b.smrdocn_tckn_seq_no||
              b.smrdocn_term_code    ) = (select min(z.smrdocn_tckn_seq_no)||min(z.smrdocn_term_code)
                                              from sWrdocn z
                                             where z.smrdocn_request_no = b.smrdocn_request_no
                                               and z.smrdocn_crse_numb  = b.smrdocn_crse_numb
                                               and z.smrdocn_subj_code  = b.smrdocn_subj_code
                                               and z.smrdocn_levl_code  IN (csLevlCode,csES)
                                               and z.smrdocn_program    = csPrograma
                                               and z.smrdocn_pidm       = pnPidm
                                           )
         and b.smrdocn_program             = csPrograma
         and b.smrdocn_levl_code          IN (csLevlCode,csES)
         and b.smrdocn_pidm                = pnPidm
         and psNivel                       = csPOS
         and not exists (select null
                           from swrcapp
                          where swrcapp_subj_code    = smrdocn_subj_code
                            and swrcapp_crse_numb    = smrdocn_crse_numb
                            and swrcapp_crse_source <> csR
                        );

  end materiasPosgrado;

  --corregir cerocreditos con extraordinario aprobado
  procedure ceroCreditosExtrAprobado IS

  --credtos aprobados
  cursor cuCero is
         select swrcapp_term_code     as cappTerm,
                swrcapp_crn           as cappCrnn,
                sWrdou.dousArea       as dousArea,
                sWrdou.dousPrio       as dousPrio,
                sWrdou.dousGrop       as dousGrop,
                sWrdou.dousCred       as dousCred
           from swrcapp,
                (select smrdous_subj_code                as dousSubj,
                        smrdous_crse_numb                as dousCrse,
                        smrdous_area                     as dousArea,
                        smrdous_area_priority            as dousPrio,
                        smrdous_group                    as dousGrop,
                        smrdous_credit_hours             as dousCred,
                        max(smrdous_grde_quality_points) as dousGrde
                   from sWrdous
                  where smrdous_grde_quality_points >= cn6
                    and smrdous_credit_hours         > cn0
                    and smrdous_gmod_code            = csX
                  group by smrdous_subj_code,
                           smrdous_crse_numb,
                           smrdous_area,
                           smrdous_area_priority,
                           smrdous_group,
                            smrdous_credit_hours
                ) sWrdou
          where swrcapp_subj_code = sWrdou.dousSubj
            and swrcapp_crse_numb = sWrdou.dousCrse
            and swrcapp_type      = csOT;

  begin

      for regCap in cuCero loop
          update swrcapp
             set swrcapp_area          = regCap.dousArea,
                 swrcapp_area_priority = regCap.dousPrio,
                 swrcapp_group         = regCap.dousGrop,
                 swrcapp_credit_hours  = regCap.dousCred
           where swrcapp_crn       = regCap.cappCrnn
             and swrcapp_term_code = regCap.cappTerm
             and swrcapp_type      = csOT;
      end loop;

  end ceroCreditosExtrAprobado;

  BEGIN

      --Son registrados los cursos usados
      cursosUsados;

      -- Cursos no usados
      cursosNoUsados;

      DELETE FROM SWRDOCN A
       WHERE A.SMRDOCN_REPEAT_COURSE_IND  = csE
         AND A.SMRDOCN_GMOD_CODE          = csN
         AND A.SMRDOCN_GRDE_CODE         <> csOU
         AND NOT EXISTS (SELECT NULL
                           FROM SWRDOCN B
                          WHERE B.SMRDOCN_SUBJ_CODE                   = A.SMRDOCN_SUBJ_CODE
                            AND B.SMRDOCN_CRSE_NUMB                   = A.SMRDOCN_CRSE_NUMB
                            AND NVL(B.SMRDOCN_REPEAT_COURSE_IND,'I') IN (csE,csI)
                            AND B.SMRDOCN_GMOD_CODE                   = csX
                        )
         AND NOT EXISTS (SELECT NULL
                          FROM SWRCAPP B
                         WHERE B.SWRCAPP_SUBJ_CODE = A.SMRDOCN_SUBJ_CODE
                           AND B.SWRCAPP_CRSE_NUMB = A.SMRDOCN_CRSE_NUMB
                           AND B.SWRCAPP_GMOD_CODE = csX
                        );

      -- Cursos no usados
      -- Materias que se colocan en el bloque que les corresponde
      -- Reprobadas y con creditos
      reprobadasConCreditos;

      -- Cursos no usados
      -- Materias con cero creditos
      materiasCeroCreditos;

      -- Cursos no usados
      -- MATERIAS QUE SE COLOCAN EN EL BLOQUE ELECTIVO
      -- Aprobadas y con creditos
      aprobadasConCreditos;

      -- Cursos no usados
      -- filtros solo para posgrado
      materiasPosgrado;

      --corregir cerocreditos con extraordinario aprobado
      ceroCreditosExtrAprobado;

      --buscando un bloque electivo
      BEGIN
          SELECT MAX(SWRCAPP_AREA_PRIORITY)
            INTO vnPriority
            FROM SWRCAPP
           WHERE EXISTS (SELECT C.SMRACMT_TEXT
                           FROM SMRACMT C
                          WHERE (C.SMRACMT_TERM_CODE_EFF,C.SMRACMT_TEXT_SEQNO) = (SELECT MAX(D.SMRACMT_TERM_CODE_EFF),MAX(D.SMRACMT_TEXT_SEQNO)
                                                                                    FROM SMRACMT D
                                                                                   WHERE D.SMRACMT_AREA = C.SMRACMT_AREA
                                                                                 )
                            AND LTRIM(RTRIM(C.SMRACMT_TEXT))                   = csBloqueElc
                            AND C.SMRACMT_AREA                                 = SWRCAPP_AREA
                        )
             AND SWRCAPP_AREA_PRIORITY IS NOT NULL
             AND ROWNUM                 = cn1
           GROUP BY SWRCAPP_AREA;
      EXCEPTION
          WHEN NO_DATA_FOUND THEN
               NULL;
          WHEN OTHERS THEN
               NULL;
      END;

      --ACTUALIZANDO LA PRIORIDAD A UN BLOQUE ELECTIVO
      UPDATE SWRCAPP
         SET SWRCAPP_AREA_PRIORITY = vnPriority
       WHERE (
                 EXISTS (SELECT C.SMRACMT_TEXT
                           FROM SMRACMT C
                          WHERE (C.SMRACMT_TERM_CODE_EFF,C.SMRACMT_TEXT_SEQNO) = (SELECT MAX(D.SMRACMT_TERM_CODE_EFF),MAX(D.SMRACMT_TEXT_SEQNO)
                                                                                    FROM SMRACMT D
                                                                                   WHERE D.SMRACMT_AREA = C.SMRACMT_AREA
                                                                                 )
                            AND LTRIM(RTRIM(C.SMRACMT_TEXT))                   = csBloqueElc
                            AND C.SMRACMT_AREA                                 = SWRCAPP_AREA
                        )
              OR
                 SWRCAPP_AREA = csBloque
             )
         AND vnPriority IS NOT NULL;

      --ACTUALIZANDO LA PRIORIDAD A UN BLOQUE ELECTIVO
      --EN CASO DE QUE LA VARIABLE "vnPriority" TENGA EL VALOR NULL SE EJECUTA LA SIGUIENTE ACTUALIZACION
      UPDATE SWRCAPP A
         SET A.SWRCAPP_AREA_PRIORITY  = (SELECT MIN(B.SWRCAPP_AREA_PRIORITY)
                                           FROM SWRCAPP B
                                          WHERE B.SWRCAPP_AREA_PRIORITY IS NOT NULL
                                            AND B.SWRCAPP_AREA           = csBloque
                                        )
       WHERE A.SWRCAPP_AREA_PRIORITY IS NULL
         AND A.SWRCAPP_AREA           = csBloque
         AND vnPriority              IS NULL;

  END PWAHIAC;
/
DROP PROCEDURE BANINST1.PWAINGD;

CREATE OR REPLACE PROCEDURE BANINST1.PWAINGD(psCamp  VARCHAR2,
                                             psTerm  VARCHAR2,
                                             psColl  VARCHAR2,
                                             psSede  VARCHAR2 DEFAULT NULL,
                                             ps2     VARCHAR2 DEFAULT NULL
                                            ) IS

/*
         TAREA: Llena tablas de paso para mejorar la velocidad en el reporte
         FECHA: 19/04/2010
         AUTOR: GEPC
        MODULO: Registro de calificaciones

  MODIFICACION: 09/08/2010
                GEPC
                * Se agrega el parametro "ps2" para hacer el filtro de las materias
                  que pertenece al nuevo programa educativo 2010 y ocupar el proceso
                  en el reporte de "Avance captura de programas magisteriales"

*/

  cs0       CONSTANT VARCHAR2(1) := '0';
  csA       CONSTANT VARCHAR2(1) := 'A';
  csY       CONSTANT VARCHAR2(1) := 'Y';
  csDI      CONSTANT VARCHAR2(2) := 'DI';
  csZZ      CONSTANT VARCHAR2(2) := 'ZZ';
  csSinSede CONSTANT VARCHAR2(8) := 'sin Sede';
  ciCero    CONSTANT INTEGER     := 0;
  cn1       CONSTANT NUMBER(1)   := 1;
  cn2       CONSTANT NUMBER(1)   := 2;

  vsCamp VARCHAR2(6)  := psCamp;
  vsSede VARCHAR2(10) := psSede;
  vsTerm VARCHAR2(10) := psTerm;
  vsColl VARCHAR2(10) := psColl;

  BEGIN
      INSERT INTO SWRPGAC
      (SWRPGAC_TERM_CODE, SWRPGAC_CRN, SWRPGAC_COLL_CODE, SWRPGAC_SUBJ_CODE, SWRPGAC_CRSE_NUMB, SWRPGAC_TITLE
      )
       SELECT C.SSBSECT_TERM_CODE,
              C.SSBSECT_CRN,
              NVL(D.SSBOVRR_COLL_CODE,A.SCBCRSE_COLL_CODE),
              A.SCBCRSE_SUBJ_CODE,
			           A.SCBCRSE_CRSE_NUMB,
			           A.SCBCRSE_TITLE
         FROM SSBSECT C,
              SCBCRSE A,
              SSBOVRR D
        WHERE (NVL(D.SSBOVRR_COLL_CODE,A.SCBCRSE_COLL_CODE) = vsColl OR vsColl  is null)
          AND A.SCBCRSE_EFF_TERM            = (SELECT MAX(B.SCBCRSE_EFF_TERM)
                                                 FROM SCBCRSE B
                                                WHERE B.SCBCRSE_EFF_TERM <= C.SSBSECT_TERM_CODE
                                                  AND B.SCBCRSE_SUBJ_CODE = C.SSBSECT_SUBJ_CODE
                                                  AND B.SCBCRSE_CRSE_NUMB = C.SSBSECT_CRSE_NUMB
                                              )
          AND C.SSBSECT_TERM_CODE           = D.SSBOVRR_TERM_CODE(+)
          AND C.SSBSECT_CRN                 = D.SSBOVRR_CRN(+)
          AND C.SSBSECT_SUBJ_CODE           = A.SCBCRSE_SUBJ_CODE
          AND C.SSBSECT_CRSE_NUMB           = A.SCBCRSE_CRSE_NUMB
          AND (
                 (
                      ps2 IS NULL
                  AND
                      C.SSBSECT_ENRL > ciCero
                 )
              OR (
                      ps2 IS NOT NULL
                  AND
                      SUBSTR(SSBSECT_CRSE_NUMB,cn2,cn1) = ps2
                 )
              )
          AND NVL(C.SSBSECT_INSM_CODE,cs0) <> csDI
          AND C.SSBSECT_SSTS_CODE           = csA
          AND C.SSBSECT_TERM_CODE           = vsTerm
          AND C.SSBSECT_CAMP_CODE           = vsCamp;

      INSERT INTO FWRHORS
      (FWRHORS_PIDM, FWRHORS_TERM_CODE, FWRHORS_CRN, FWRHORS_ROOM_CODE
       )
       SELECT sirasg.asgnPidm,
              sirasg.termCode,
              sirasg.asgnCrnn,
              sirasg.deptSede
         FROM (SELECT DISTINCT SIRASGN_PIDM                   AS asgnPidm,
                               SIRASGN_TERM_CODE              AS termCode,
                               SIRASGN_CRN                    AS asgnCrnn,
                               NVL(SIRDPC.deptSede,csSinSede) AS deptSede
                 FROM SIRASGN,
                      (SELECT SIRDPCL_PIDM      AS dpclPidm,
                              SIRDPCL_DEPT_CODE AS deptSede
                         FROM SIRDPCL A
                        WHERE SIRDPCL_HOME_IND      = csY
                          AND SIRDPCL_TERM_CODE_EFF = (SELECT MAX(SI.SIRDPCL_TERM_CODE_EFF)
                                                         FROM SIRDPCL SI
                                                        WHERE SI.SIRDPCL_PIDM           =  A.SIRDPCL_PIDM
                                                          AND SI.SIRDPCL_TERM_CODE_EFF <= vsTerm
                                                      )
                      ) SIRDPC
                WHERE SIRASGN_PIDM                     = SIRDPC.dpclPidm(+)
                  AND (SIRASGN_CRN,SIRASGN_TERM_CODE) IN (SELECT SWRPGAC_CRN,SWRPGAC_TERM_CODE
                                                            FROM SWRPGAC
                                                         )
                  AND SIRASGN_PRIMARY_IND              = csY
                  AND (NVL(SIRDPC.deptSede,csSinSede) = vsSede OR vsSede IS NULL)
              ) sirasg;

      INSERT INTO FWRSIRG
      (FWRSIRG_PIDM, FWRSIRG_TERM_CODE, FWRSIRG_CRN, FWRSIRG_DEPT_CODE, FWRSIRG_COLL_CODE)
      SELECT FWRHORS_PIDM,
             SWRPGAC_TERM_CODE,
             SWRPGAC_CRN,
             FWRHORS_ROOM_CODE,
             SWRPGAC_COLL_CODE
        FROM SWRPGAC,
             FWRHORS
       WHERE SWRPGAC_TERM_CODE = FWRHORS_TERM_CODE
         AND SWRPGAC_CRN       = FWRHORS_CRN;

  END PWAINGD;
/
DROP PROCEDURE BANINST1.PWAISSBSECT;

CREATE OR REPLACE PROCEDURE BANINST1.PWAISSBSECT(psCampCode VARCHAR2 DEFAULT NULL,
                                                   psTermCode VARCHAR2 DEFAULT NULL,
                                                   psCollCode VARCHAR2 DEFAULT NULL,
                                                   psSubjCode VARCHAR2 DEFAULT NULL,
                                                   psSstsCode VARCHAR2 DEFAULT NULL,
                                                   psPtrmCode VARCHAR2 DEFAULT NULL
                                                  ) IS

  /*
     Tarea: Insertar datos para la optimizacin de consultas
     Fecha: 24/05/2010
     Autor: GEPC             U  F  T

            Observaciones: El proceso es llamdo en
                           -- PWRPGAC
                           -- PWRPGA2
                           -- PWRINDR
                           -- PWRFMPS

     Modif:  21 ENE 2011
        * JCCR
        - Se Agregarn las Columnas de SWRPGAC_SECT_TITLE, SWRPGAC_SESS_CODE, para igusalarlo a RUA
        - campo SWRPGAC_SESS_CODE por Modificaciones e UFT Reporte PWRPGAC


  */

  csEsp CONSTANT VARCHAR2(1) := ' ';
  csSlh CONSTANT VARCHAR2(1) := '/';
  csA   CONSTANT VARCHAR2(1) := 'A';

  BEGIN
      INSERT INTO SWRPGAC
      (SWRPGAC_TERM_CODE, SWRPGAC_CAMP_CODE, SWRPGAC_CRN,        SWRPGAC_SSTS_CODE,
       SWRPGAC_SCHD_CODE, SWRPGAC_INSM_CODE, SWRPGAC_SUBJ_CODE,  SWRPGAC_PTRM_CODE,
       SWRPGAC_CRSE_NUMB, SWRPGAC_TITLE,     SWRPGAC_CONT_HR_LOW,SWRPGAC_CREDIT_HR_LOW,
       SWRPGAC_SEQ_NUMB,  SWRPGAC_MAX_ENRL,  SWRPGAC_ENRL,       SWRPGAC_COLL_CODE,
       SWRPGAC_GMOD_CODE, SWRPGAC_PTRM,      SWRPGAC_SECT_TITLE, SWRPGAC_SESS_CODE
      )
      SELECT
       SSBSECT_TERM_CODE, SSBSECT_CAMP_CODE, SSBSECT_CRN,        SSBSECT_SSTS_CODE,
       SSBSECT_SCHD_CODE, SSBSECT_INSM_CODE, SCBCRSE_SUBJ_CODE,  SSBSECT_PTRM_CODE||csEsp||SSBSECT_PTRM_START_DATE||csEsp||SSBSECT_PTRM_END_DATE||csEsp||SSBSECT_PTRM_WEEKS,
       SCBCRSE_CRSE_NUMB, SCBCRSE_TITLE,     SCBCRSE_CONT_HR_LOW,SCBCRSE_CREDIT_HR_LOW,
       SSBSECT_SEQ_NUMB,  SSBSECT_MAX_ENRL,  SSBSECT_ENRL,       NVL(SSBOVRR_COLL_CODE,SCBCRSE_COLL_CODE),
       SSBSECT_GMOD_CODE, SSBSECT_PTRM_CODE, SSBSECT_CRSE_TITLE, SSBSECT_SESS_CODE
        FROM SSBSECT,
             SCBCRSE,
             SSBOVRR
       WHERE SSBSECT_SUBJ_CODE     = SCBCRSE_SUBJ_CODE
         AND SSBSECT_CRSE_NUMB     = SCBCRSE_CRSE_NUMB
         AND SCBCRSE_EFF_TERM      = (SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                        FROM SCBCRSE SC
                                       WHERE SC.SCBCRSE_EFF_TERM <= SSBSECT_TERM_CODE
                                         AND SC.SCBCRSE_SUBJ_CODE = SSBSECT_SUBJ_CODE
                                         AND SC.SCBCRSE_CRSE_NUMB = SSBSECT_CRSE_NUMB
                                     )
         AND SSBSECT_SSTS_CODE     = csA
         AND SSBSECT_TERM_CODE     = SSBOVRR_TERM_CODE(+)
         AND SSBSECT_CRN           = SSBOVRR_CRN(+)
         AND (SSBSECT_CAMP_CODE                                        = psCampCode OR psCampCode IS NULL)
         AND (SSBSECT_TERM_CODE                                        = psTermCode OR psTermCode IS NULL)
         AND (NVL(SSBOVRR_COLL_CODE,SCBCRSE_COLL_CODE)                 = psCollCode OR psCollCode IS NULL)
         AND (SCBCRSE_SUBJ_CODE                                        = psSubjCode OR psSubjCode IS NULL)
         AND (SSBSECT_SSTS_CODE                                        = psSstsCode OR psSstsCode IS NULL)
         AND (INSTR(csSlh||psPtrmCode,csSlh||SSBSECT_PTRM_CODE||csSlh) > 0          OR psPtrmCode = csSlh OR psPtrmCode IS NULL);


  END PWAISSBSECT;
/
DROP PROCEDURE BANINST1.PWALVRS;

CREATE OR REPLACE PROCEDURE BANINST1.PWALVRS(psCatalogo VARCHAR2 DEFAULT NULL,
 psVisible VARCHAR2 DEFAULT NULL,
 psFiltroA VARCHAR2 DEFAULT NULL,
 psFiltroB VARCHAR2 DEFAULT NULL,
 psFiltroC VARCHAR2 DEFAULT NULL,
 psFiltroD VARCHAR2 DEFAULT NULL,
 psFiltroE VARCHAR2 DEFAULT NULL,
 psObjectA VARCHAR2 DEFAULT NULL,
 psObjectB VARCHAR2 DEFAULT NULL,
 psObjectC VARCHAR2 DEFAULT NULL,
 psObjectD VARCHAR2 DEFAULT NULL,
 psObjectE VARCHAR2 DEFAULT NULL,
 psTitulo VARCHAR2 DEFAULT NULL) IS

/*
 AUTOR: GEPC
 FECHA: 30/03/2009
 TAREA: Presenta la ventana para hacer una lista de valores
 MODULO: Reportes

*/

 vsOpciones VARCHAR2(50) := '"limpiar","buscar","sali",';
 vsTraduccn VARCHAR2(50) := '"Limpiar","Buscar","Salir",';
 vsAcciones VARCHAR2(200) := 'javascript:f_Limpia();,javascript:f_Busca();,javascript:f_Salir(),';
 vsFiltroA VARCHAR2(400) := '<input type="text" name="psFiltroA" value="'||psFiltroA||'" />';
 vsFiltroB VARCHAR2(400) := '<input type="hidden" name="psFiltroB" value="'||psFiltroB||'" />';
 vsFiltroC VARCHAR2(400) := '<input type="hidden" name="psFiltroC" value="'||psFiltroC||'" />';
 vsFiltroD VARCHAR2(400) := '<input type="hidden" name="psFiltroD" value="'||psFiltroD||'" />';
 vsFiltroE VARCHAR2(400) := '<input type="hidden" name="psFiltroE" value="'||psFiltroE||'" />';
 vsTitulo VARCHAR2(400) := NULL;

 -- El procedimiento realiza la consulta del catalogo
 procedure p_Query is

 TYPE regDato IS RECORD (valDatoA VARCHAR2(300),
 valDatoB VARCHAR2(300),
 valDatoC VARCHAR2(300),
 valDatoD VARCHAR2(300),
 valDatoE VARCHAR2(300),
 valDatoF VARCHAR2(300),
 valDatoG VARCHAR2(300),
 valDatoH VARCHAR2(300)
 );

 TYPE tableDato IS TABLE OF regDato INDEX BY BINARY_INTEGER;

 tabDato tableDato;
 cuCatalogo LOV.t_ListaDeValores;
 vnRow integer := 1;
 vnExists integer := 0;

 begin
 cuCatalogo := LOV.Consulta(psCatalogo, psFiltroA, psFiltroB, psFiltroC, psFiltroD, psFiltroE);

 loop
 exit when cuCatalogo%notfound;
 fetch cuCatalogo into tabDato(vnRow).valDatoA,
 tabDato(vnRow).valDatoB,
 tabDato(vnRow).valDatoC,
 tabDato(vnRow).valDatoD,
 tabDato(vnRow).valDatoE,
 tabDato(vnRow).valDatoF,
 tabDato(vnRow).valDatoG,
 tabDato(vnRow).valDatoH;
 exit when cuCatalogo%notfound;

 vnRow := vnRow + 1;

 end loop;
 close cuCatalogo;

 vnRow := vnRow - 1;

 htp.p('function f_ClockNormal() {
 document.body.className = "bodyCero2";
 parent.f_Clock();
 }//f_Limpia
 ');

 htp.p('
 //--></script>

 <style type="text/css"><!--
 body.bodyCero1 {margin-left: 0pt; margin-right: 0pt; margin-top: 0pt;margin-bottom: 0pt; cursor:wait;}
 body.bodyCero2 {margin-left: 0pt; margin-right: 0pt; margin-top: 0pt;margin-bottom: 0pt;}
 --></style>

 <head><body bgcolor="#ffffff" class="bodyCero1" onLoad="f_ClockNormal();">
 <form name="frmPast" onSubmit="return false;">
 <table border="0" cellpadding="2" cellspacing="1" width="100%" bgcolor="#ffffff">
 ');

 for vnI in 1..vnRow loop
 htp.p('<tr>
 <td>'||
 PK_ObjHTML.f_a(tabDato(vnI).valDatoA,
 'javascript:parent.f_pastValue('''||tabDato(vnI).valDatoA||''',document.frmPast.psCodeA'||vnI||'.value)',
 vnI,
 1
 )||
 '</td>
 <td>'||tabDato(vnI).valDatoB||'</td>
 <td>'||tabDato(vnI).valDatoC||'</td>
 <td>'||tabDato(vnI).valDatoD||'</td>
 <td>'||tabDato(vnI).valDatoE||'</td>
 <td>'||tabDato(vnI).valDatoF||'</td>
 <td>'||tabDato(vnI).valDatoG||'</td>
 <td>'||tabDato(vnI).valDatoH||'</td>
 <td>
 <input type="text" name="psCodeA'||vnI||'" class="oculto" value="'||tabDato(vnI).valDatoA||'" tabindex="-1" />
 </td>
 </tr>');
 --
 vnExists := 1;
 end loop;

 htp.p('
 </form>
 </table>
 ');

 if vnExists = 0 then
 htp.p('
 <br/>
 <p align="center">
 <font color="#aa0000" size="4">No existen valores con el filtro de busqueda</font>
 </p>
 ');
 end if;

 htp.p('
 </body>
 </html>
 ');

 exception
 when others then
 htp.p(sqlerrm);
 end p_Query;

 BEGIN
 SELECT DECODE(psFiltroB,NULL,psFiltroB,' ('||psFiltroB||')')
 INTO vsTitulo
 FROM DUAL;

 htp.p('<html><head><title>'||psTitulo||vsTitulo||'</title>');

 PK_ObjHTML.P_NoCache;

 pK_ObjHTML.P_CssTabs;

 htp.p('<script language=''JavaScript''><!--
 javascript:window.history.forward(1);
 ');

 IF psVisible IS NOT NULL THEN
 p_Query;

 RETURN;
 END IF;

 ----
 htp.p('function f_Limpia() {
 document.frmBusca.reset();

 document.frmBusca.psFiltroA.value = "";
 }//f_Limpia
 ');

 ----
 htp.p('function f_Salir() {
 window.close();
 }//f_Limpia
 ');

 ----
 htp.p('function f_Busca() {
 document.body.className = "bodyCursorW";
 document.frmBusca.submit();

 window.status = "Espere un momento por favor...";
 }//f_Limpia
 ');

 ----
 htp.p('function f_Clock() {
 document.body.className="";
 }//f_Limpia
 ');

 ----
 htp.p('function f_pastValue(psValueA, psValueB, psValueC, psValueD, psValueE) {
 ');

 IF psObjectA IS NOT NULL THEN
 htp.p('opener.'||psObjectA||'.value = psValueA;'); -- Antes opener.frmdatos 02/07/2009
 END IF;

 IF psObjectB IS NOT NULL THEN
 htp.p('opener.'||psObjectB||'.value = psValueB;');
 END IF;

 IF psObjectC IS NOT NULL THEN
 htp.p('opener.'||psObjectC||'.value = psValueC;');
 END IF;

 IF psObjectD IS NOT NULL THEN
 htp.p('opener.'||psObjectD||'.value = psValueD;');
 END IF;

 IF psObjectE IS NOT NULL THEN
 htp.p('opener.'||psObjectE||'.value = psValueE;');
 END IF;

 htp.p('
 f_Salir();
 }//f_pastValue
 ');

 htp.p('//--></script>');

 htp.p('
 </head><body bgcolor="#F48D00" onLoad="document.frmBusca.psFiltroA.focus();">
 <table border="0" cellpadding="2" cellspacing="1" width="100%" height="100%" bgcolor="#dedede">
 <form name="frmBusca" action=BANINST1."PWALVRS" method="post" target="fraFind">
 <tr height="0%">
 <td height="0%" colspan="2">'||psTitulo||vsTitulo||'</td>
 <td width="20%" height="0%" rowspan="3">
 ');

 pk_MenuAplicacion.P_MenuDinamico(vsOpciones, vsAcciones, vsTraduccn);

 htp.p('
 </td>
 </tr>
 <tr height="0%">
 <td height="0%"></td>
 <td height="0%"></td>
 </tr>
 <tr height="0%">
 <th width="10%" height="0%" align="right">Buscar</th>
 <td width="70%" height="0%">
 <input type="hidden" name="psCatalogo" value="'||psCatalogo||'" />
 <input type="hidden" name="psVisible" value="true" />
 '||vsFiltroA||
 vsFiltroB||'
 <input type="hidden" name="psTitulo" value="'||psTitulo||'" />
 </td>
 </tr>
 <tr height="90%">
 <td height="95%" colspan="3" valign="top">
 <iframe name="fraFind" id="fraFind" src="about:blank" width="100%" height="100%" frameborder="0">
 </iframe>
 </td>
 </tr>
 <tr height="5%">
 <td height="5%" colspan="3">
 </td>
 </tr>

 </form>
 </table>
 ');

 IF (psFiltroA IS NOT NULL OR psFiltroB IS NOT NULL) AND psVisible IS NULL THEN
 htp.p('<script language=''JavaScript''><!--
 f_Busca()
 //--></script>');
 END IF;

 htp.p('
 </body>
 </html>
 ');

 EXCEPTION
 WHEN OTHERS THEN
 htp.p(SQLERRM);
 END PWALVRS;
/


DROP PUBLIC SYNONYM PWALVRS;

CREATE PUBLIC SYNONYM PWALVRS FOR BANINST1.PWALVRS;
DROP PROCEDURE BANINST1.PWAPMER;

CREATE OR REPLACE PROCEDURE BANINST1.PWAPMER (psTerm    VARCHAR2,
                            psCrnn    VARCHAR2,
                            psSecc    VARCHAR2,
                            psErro    VARCHAR2,
                            psSubb    VARCHAR2 DEFAULT 'A',
                            psAccn    VARCHAR2 DEFAULT 'I')
IS
   vnSecuencia    NUMBER (3) := 0;

   csA   CONSTANT VARCHAR2 (1) := 'A';
   csI   CONSTANT VARCHAR2 (1) := 'I';
   csD   CONSTANT VARCHAR2 (1) := 'D';
BEGIN
   SELECT NVL (MAX (SWRPMER_SEQN), 0) + 1
     INTO vnSecuencia
     FROM SWRPMER
    WHERE     SWRPMER_TERM_CODE = psTerm
          AND SWRPMER_CRN = psCrnn
          AND SWRPMER_SECC_CODE = psSecc
          AND NVL (SWRPMER_SUBB_SECC, csA) = psSubb;

   IF psAccn = csI
   THEN
      INSERT INTO SWRPMER (SWRPMER_TERM_CODE,
                           SWRPMER_CRN,
                           SWRPMER_SEQN,
                           SWRPMER_SECC_CODE,
                           SWRPMER_SUBB_SECC,
                           SWRPMER_ERROR)
           VALUES (psTerm,
                   psCrnn,
                   vnSecuencia,
                   psSecc,
                   psSubb,
                   SUBSTR (psErro, 1, 4000));
   ELSIF psAccn = csD
   THEN
      DELETE SWRPMER
       WHERE     SWRPMER_TERM_CODE = psTerm
             AND SWRPMER_CRN = psCrnn
             AND SWRPMER_SECC_CODE = psSecc
             AND NVL (SWRPMER_SUBB_SECC, csA) = NVL (psSubb, csA);
   END IF;

   COMMIT;
END PWAPMER;
/


DROP PUBLIC SYNONYM PWAPMER;

CREATE PUBLIC SYNONYM PWAPMER FOR BANINST1.PWAPMER;


GRANT EXECUTE ON BANINST1.PWAPMER TO WWW_USER;
DROP PROCEDURE BANINST1.PWAPRSS;

CREATE OR REPLACE PROCEDURE BANINST1.PWAPRSS(pnPrss  INTEGER,
                                  pnBarra INTEGER DEFAULT 10) IS

  BEGIN
      IF pnPrss = 0 THEN
         htp.p('<style type="text/css"><!--
         .proceso0 {background-color:#ffffff;}
         .proceso1 {background-color:#5992BE;}
         .proceso2 {background-color:#FFFFE5;}
         --></style>

         <script language=''JavaScript''><!--
         var vgnObjProces = 0;
         var vgnEtapa     = 0;
         var vgnEjecucion = true;

         function f_ColorProgreso(object, pnAccion) {
           var objNode = object.parentNode;

           if(pnAccion==1){
              objNode.className = "proceso2";
              return;
           }

           if (objNode.className == "proceso0") {
               objNode.className = "proceso1";
           } else {
               objNode.className = "proceso0";
           }

         } //f_ColorProgreso

         function f_Intervalo() {
           setTimeout("f_Progreso()",200);
         }//f_Intervalo

         function f_Progreso() {
           var objTxt = null;

           if(!vgnEjecucion) { return false; }

           if(vgnObjProces < '||pnBarra||') {
              objTxt = eval("document.frmObjeto" + vgnEtapa + ".proceso" + vgnObjProces);
              f_ColorProgreso(objTxt,0);
           }

           vgnObjProces++;

           if(vgnObjProces > '||(pnBarra+1)||') {
              vgnObjProces = 0;

              for(vnI=0; vnI<'||pnBarra||'; vnI++) {
                  objTxt = eval("document.frmObjeto" + vgnEtapa + ".proceso"+vnI);
                  f_ColorProgreso(objTxt,0);
              }
           }

           f_Intervalo();
         } //f_Progreso

         function f_CompletaProgreso(pnEtapa) {

           for(vnI=0; vnI<'||pnBarra||'; vnI++) {
               objTxt = eval("document.frmObjeto" + pnEtapa + ".proceso"+vnI);
               f_ColorProgreso(objTxt,1);
           }

         } //f_CompletaProgreso

         //--></script>
          ');
      END IF;

      htp.p('
      <table border="0" cellpadding="0" cellspacing="0" width="100%">
      <form name="frmObjeto'||pnPrss||'">
        <tr>
      ');

      FOR vnI IN 0..(pnBarra-1) LOOP
          htp.p('
          <td width="10%" class="proceso0" align="right">
              <img src="/imagenes/progreso.gif" border="0" /><input type="hidden" name="proceso'||vnI||'"/></td>
          ');
      END LOOP;

      htp.p('
        </tr>
      </form>
      </table>
      ');


  END PWAPRSS;
/


DROP PUBLIC SYNONYM PWAPRSS;

CREATE PUBLIC SYNONYM PWAPRSS FOR BANINST1.PWAPRSS;
DROP PROCEDURE BANINST1.PWAREGL;

CREATE OR REPLACE PROCEDURE BANINST1.PWAREGL(psParametro VARCHAR2) IS
/*
    Tarea: Aplicaci?n principal para aplicar las reglas de repetici?n.
    Fecha: 08/07/2011
    Autor: MAC
   Modulo: Historia academica


*/

  vgsUSR VARCHAR2(500);

  CURSOR cuStvLevl IS
         SELECT STVLEVL_CODE levlCode,
                STVLEVL_DESC levlDesc
           FROM STVLEVL
          WHERE STVLEVL_CODE <> '00'
          ORDER BY levlCode;

  CURSOR cuStvTerm IS
         SELECT STVTERM_CODE termCode,
                STVTERM_DESC termDesc
           FROM STVTERM
          WHERE (STVTERM_ACYR_CODE = TO_CHAR(SYSDATE,'YYYY')
             OR STVTERM_ACYR_CODE = TO_CHAR(SYSDATE,'YYYY')+1
             OR STVTERM_ACYR_CODE = TO_CHAR(SYSDATE,'YYYY')-1
             )
          ORDER BY termCode DESC;

  BEGIN
      -- valida que el usuario pertenezca a la base de datos.
      IF PK_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      htp.p('
      <html><head><title></title>
      ');

      PK_ObjHTML.P_NoCache;

      htp.p(PK_ObjHTML.vgsCssBanner);

      pK_ObjHTML.P_CssTabs;

      htp.p('<script language=''JavaScript''><!--
      javascript:window.history.forward(1);

      vgsEjecuta = false;
      vgsLevel   = "";
      vgsComa    = "";
      ');

      ----
      htp.p('function f_Limpia() {
        if(vgsEjecuta) { return; }

        document.frmRegla.reset();
      } //f_Limpia
      ');

      ----
      htp.p('function f_Ejecutar() {
        if(vgsEjecuta) { return; }

        var vsTerm   = document.frmRegla.psTermCode.options[document.frmRegla.psTermCode.selectedIndex].value;
        var objLista = document.frmRegla.psLevlCode;
        var vnLength = objLista.length;
        var vsLevl   = "";
        var vnSeqc   = document.frmEjecutar.pnSeqc.value;

        document.frmRegla.txtPen1.value = "Nivel pendiente:";
        document.frmRegla.txtCon1.value = "Nivel concluido:";
        document.frmRegla.txtConc.value = "";

        for(var vnI=0; vnI<vnLength; vnI++) {
            if(objLista.options[vnI].selected == true) {
               vsLevl = vsLevl + objLista.options[vnI].value + ",";
            }
        }

               if(vsTerm == "") {
                  alert("Por favor selecciona el periodo.");
                  document.frmRegla.psTermCode.focus();
        } else if(vsLevl == "") {
                  alert("Por favor selecciona el nivel.");
                  document.frmRegla.psLevlCode.focus();
        }

        if(vsTerm!="" && vsLevl!="") {
           document.frmEjecutar.psTerm.value = vsTerm;
           vgsLevel                          = vsLevl;
           vgsEjecuta                        = true;
           document.body.className           = "bodyCursorW";

           if(vnSeqc == null || vnSeqc == "") {
              vnSeqc = 0;
           }

           f_Enviar(vnSeqc,"");
        }
      } //f_Ejecutar
      ');

      ----
      htp.p('function f_Enviar(pnSeqc,psLevel) {

      if(vgsLevel.length == 0) {

         vgsEjecuta                        = false;
         document.body.className           = "";
         vgsComa                           = "";
         document.frmRegla.txtPen1.value   = "";
         document.frmRegla.txtPend.value   = vgsLevel;
         document.frmRegla.txtConc.value   = document.frmRegla.txtConc.value + psLevel;
         document.frmEjecutar.pnSeqc.value = pnSeqc
         document.frmReporte.pnSeq.value   = document.frmEjecutar.pnSeqc.value;

         setTimeout("document.frmReporte.submit();",2000);

         return;
      }

      document.frmRegla.txtPend.value = vgsLevel;
      document.frmRegla.txtConc.value = document.frmRegla.txtConc.value + psLevel + vgsComa;

      var vsLevl = vgsLevel.substr(0, 2);

      document.frmEjecutar.pnSeqc.value = pnSeqc;
      document.frmEjecutar.psLevl.value = vsLevl;
      document.frmEjecutar.submit();

      vgsLevel = vgsLevel.substr(3);
      vgsComa  = ", ";
      } //f_Enviar
      ');

      ----
      htp.p('function f_InicializarValores() {
        if(vgsEjecuta) { return; }

        document.frmEjecutar.psTerm.value = "";
        document.frmEjecutar.psLevl.value = "";
        document.frmEjecutar.pnSeqc.value = "";
        document.frmRegla.txtPend.value   = "";
        document.frmRegla.txtConc.value   = "";
        document.frmRegla.txtPen1.value   = "";
        document.frmRegla.txtCon1.value   = "";
      } //f_InicializarValores ');

      ----
      htp.p('function f_Buscar() {
        if(vgsEjecuta) { return; }

        document.frmBuscar.submit();
      } //f_Buscar');

      htp.p('//--></script>');

      htp.p('
      </head><body bgcolor="#ffffff"><br/><br/><br/><br/><br/>
      <table border="0" width="100%" cellpadding="0" cellspacing="0">
      <form name="frmRegla" onSubmit="return false;">
      <tr><th width="60%" class="thTitulo" valign="bottom" align="left">
      <br>Reglas de repetici&oacute;n
      </th><td width="40%">
      ');

      pk_MenuAplicacion.P_MenuSalir('pk_MenuAplicacion.p_MenuAplicacion');

      htp.p('</td></tr></table>
      <hr size="1" width="100%">

      <table border="0" cellpadding="2" cellspacing="1" width="100%" bgcolor="#ffffff">
      <tr>
          <th width="10%" valign="top" align="right" bgcolor="#efefef">Periodo</th>
          <td width="40%" valign="top" bgcolor="#efefef">
              <select name="psTermCode" onChange="f_InicializarValores();"><option value=""></option>
      ');

      FOR regTerm IN cuStvTerm LOOP
          htp.p('<option value="'||regTerm.termCode||'">'||regTerm.termCode||' '||regTerm.termDesc||'</option>');
      END LOOP;

      htp.p('
      </select>
      </td>
      <td valign="top" rowspan="12">
          <iframe name="fraRegla" id="fraRegla" src="about:blank" width="100%" height="300px" frameborder="0">
          </iframe>
          </td>
          </tr>
      <tr>
          <th valign="top" align="right" bgcolor="#efefef">Nivel</th>
          <td valign="top" bgcolor="#efefef">
              <select name="psLevlCode" multiple size="10" onChange="f_InicializarValores();">
      ');

      FOR regLevl IN cuStvLevl LOOP
          htp.p('<option value="'||regLevl.levlCode||'">'||regLevl.levlCode||' - '||regLevl.levlDesc||'</option>');
      END LOOP;

      htp.p('
       </select>
      </td></tr>
      <tr><td></td>
          <td rowspan="3">
      ');

      pk_MenuAplicacion.P_MenuDinamico('"limpiar","ejecutar","buscar",','javascript:f_Limpia();,javascript:f_Ejecutar();,javascript:f_Buscar();,','"Limpiar","Ejecutar","Reporte",');

      htp.p('
          </td>
          </tr>
      <tr><td></td></tr>
      <tr><td></td></tr>

      <tr><td><input type="text" name="txtPen1" tabindex="-1" style="border:outset 0;text-align:right" readonly />
              </td>
          <td><input type="text" name="txtPend" tabindex="-1" style="border:outset 0;" readonly />
              </td>
          </tr>
      <tr><td><input type="text" name="txtCon1" tabindex="-1" style="border:outset 0;text-align:right" readonly />
              </td>
          <td><input type="text" name="txtConc" tabindex="-1" style="border:outset 0;" readonly />
              </td>
          </tr>
      <tr><td colspan="2"></td></tr>
      <tr><td colspan="2"></td></tr>
      <tr><td colspan="2"></td></tr>
      <tr><td colspan="2"></td></tr>
      <tr><td colspan="2"></td></tr>
      </form>
      </table>
      </br></br>
      <hr size="1" width="100%">
      </br>

      <form name="frmEjecutar" action="PWAREG5" target="fraRegla" method="post">
      <input type="hidden" name="psTerm" />
      <input type="hidden" name="psLevl" />
      <input type="hidden" name="pnSeqc" />
      </form>

      <form name="frmReporte" action="PWAREG8" target="fraRegla" method="post">
      <input type="hidden" name="pnSeq" />
      </form>

      <form name="frmBuscar" action="PWAREG9" target="_top" method="post">
      <input type="hidden" name="pnBuscar" value="FIND" />
      </form>

      </body>
      </html>');
  END PWAREGL;
/


DROP PUBLIC SYNONYM PWAREGL;

CREATE PUBLIC SYNONYM PWAREGL FOR BANINST1.PWAREGL;


GRANT EXECUTE ON BANINST1.PWAREGL TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWAREGL TO WWW2_USER;
DROP PROCEDURE BANINST1.PWAREG1;

CREATE OR REPLACE PROCEDURE BANINST1.PWAREG1(psLevl VARCHAR2,
                                             psTerm VARCHAR2,
                                             pnSeq  INTEGER,
                                             psUser VARCHAR2,
                                             psStat VARCHAR2) IS

/*
    Tarea: Reglas de repetici?n (Primera etapa)
           Buscar las materias repetidas por los alumnos
    Fecha: 07/07/2011
   Modulo: Historia academica

*/

  vsCodErr VARCHAR2(5000) := NULL;

  CURSOR cuRegla IS
         SELECT SHRTCKN_PIDM      PIDM,
                SHRTCKN_SUBJ_CODE SUBJ,
                SHRTCKN_CRSE_NUMB CRSE,
                COUNT(1)
           FROM SHRTCKN,
                SHRTCKL
          WHERE SHRTCKL_PIDM        = SHRTCKN_PIDM
            AND SHRTCKL_TERM_CODE   = SHRTCKN_TERM_CODE
            AND SHRTCKL_TCKN_SEQ_NO = SHRTCKN_SEQ_NO
            AND SHRTCKL_LEVL_CODE   = psLevl
--            AND SHRTCKN_PIDM = 4450
          GROUP BY SHRTCKN_PIDM,
                   SHRTCKN_SUBJ_CODE,
                   SHRTCKN_CRSE_NUMB
         HAVING COUNT(1) > 1;

  BEGIN
      PWAREG7(psLevl, psTerm, pnSeq, psUser, psStat, 'I');

      FOR regRgl IN cuRegla LOOP

          INSERT INTO SWRTCKN(SWRTCKN_SEQ, SWRTCKN_PIDM, SWRTCKN_SUBJ_CODE, SWRTCKN_CRSE_NUMB, SWRTCKN_LEVL_CODE, SWRTCKN_TERM_CODE, SWRTCKN_USER)
                       VALUES(pnSeq,       regRgl.PIDM,  regRgl.SUBJ,       regRgl.CRSE,       psLevl,            psTerm,            psUser);

      END LOOP;

      COMMIT;

     PWAREG7(psLevl, psTerm, pnSeq, psUser, psStat, 'U');

  EXCEPTION
      WHEN OTHERS THEN
           vsCodErr := SQLCODE;

           ROLLBACK;

           PWAREG7(psLevl, psTerm, pnSeq, psUser, psStat, 'O', vsCodErr);

  END PWAREG1;
/


DROP PUBLIC SYNONYM PWAREG1;

CREATE PUBLIC SYNONYM PWAREG1 FOR BANINST1.PWAREG1;


GRANT EXECUTE ON BANINST1.PWAREG1 TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWAREG1 TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWAREG1 TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWAREG1 TO OAS_PUBLIC;

GRANT EXECUTE ON BANINST1.PWAREG1 TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWAREG1 TO WWW2_USER;
DROP PROCEDURE BANINST1.PWAREG2;

CREATE OR REPLACE PROCEDURE BANINST1.PWAREG2(psLevl VARCHAR2,
                                             psTerm VARCHAR2,
                                             pnSeq  INTEGER,
                                             psUser VARCHAR2,
                                             psStat VARCHAR2) IS

/*
    Tarea: Reglas de repetici?n (Segunda etapa)
             * Obtener los valores iniciales de los campos
               "SHRTCKN_REPEAT_COURSE_IND", "SHRTCKN_ACTIVITY_DATE", "SHRTCKN_REPEAT_SYS_IND",
               antes de actualizarlos y encaso de error restaurarlos.

    Fecha: 07/07/2011
   Modulo: Historia academica

*/

  vsCodErr VARCHAR2(5000) := NULL;

  CURSOR cuValorInicial IS
         SELECT SHRTCKN_PIDM              Pidm,
                SHRTCKN_TERM_CODE         Term,
                SHRTCKN_SEQ_NO            SeqN,
                SHRTCKN_CRN               Crn,
                SHRTCKN_SUBJ_CODE         Subj,
                SHRTCKN_CRSE_NUMB         Crse,
                SHRTCKN_REPEAT_COURSE_IND RepC,
                SHRTCKN_ACTIVITY_DATE     Acty,
                SHRTCKN_REPEAT_SYS_IND    RepS
           FROM SHRTCKN
          WHERE           (SHRTCKN_PIDM, SHRTCKN_SUBJ_CODE, SHRTCKN_CRSE_NUMB)
                IN (SELECT SWRTCKN_PIDM, SWRTCKN_SUBJ_CODE, SWRTCKN_CRSE_NUMB
                      FROM SWRTCKN
                     WHERE SWRTCKN_SEQ       = pnSeq
                       AND SWRTCKN_LEVL_CODE = psLevl
                       AND SWRTCKN_TERM_CODE = psTerm
                   );

  BEGIN
      PWAREG7(psLevl, psTerm, pnSeq, psUser, psStat, 'I');

      FOR regVal IN cuValorInicial LOOP

          INSERT INTO SWNTCKN(SWNTCKN_SEQ,      SWNTCKN_PIDM,           SWNTCKN_TERM_CODE, SWNTCKN_SEQ_NO,
                              SWNTCKN_CRN,      SWNTCKN_SUBJ_CODE,      SWNTCKN_CRSE_NUMB, SWNTCKN_REPEAT_COURSE_IND,
                              SWNTCKN_ACTIVITY, SWNTCKN_REPEAT_SYS_IND, SWNTCKN_TERM,      SWNTCKN_LEVL_CODE,
                              SWNTCKN_USER
                             )
                       VALUES(pnSeq,            regVal.Pidm,            regVal.Term,       regVal.SeqN,
                              regVal.Crn,       regVal.Subj,            regVal.Crse,       regVal.RepC,
                              regVal.Acty,      regVal.RepS,            psTerm,            psLevl,
                              psUser
                             );

      END LOOP;

      COMMIT;

      PWAREG7(psLevl, psTerm, pnSeq, psUser, psStat, 'U');

  EXCEPTION
      WHEN OTHERS THEN
           vsCodErr := SQLCODE;
           ROLLBACK;

           PWAREG7(psLevl, psTerm, pnSeq, psUser, psStat, 'O', vsCodErr);

  END PWAREG2;
/


DROP PUBLIC SYNONYM PWAREG2;

CREATE PUBLIC SYNONYM PWAREG2 FOR BANINST1.PWAREG2;


GRANT EXECUTE ON BANINST1.PWAREG2 TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWAREG2 TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWAREG2 TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWAREG2 TO OAS_PUBLIC;

GRANT EXECUTE ON BANINST1.PWAREG2 TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWAREG2 TO WWW2_USER;
DROP PROCEDURE BANINST1.PWAREG3;

CREATE OR REPLACE PROCEDURE BANINST1.PWAREG3(psLevl VARCHAR2,
                                             psTerm VARCHAR2,
                                             pnSeq  INTEGER,
                                             psUser VARCHAR2,
                                             psStat VARCHAR2) IS

/*
    Tarea: Reglas de repetici?n (Tercera etapa)
             * Actualizar los campos
               "SHRTCKN_REPEAT_COURSE_IND", "SHRTCKN_ACTIVITY_DATE", "SHRTCKN_REPEAT_SYS_IND",
               de las materias repetidas por los alumnos encontrados en la "etapa 1"

    Fecha: 07/07/2011

   Modulo: Historia academica

*/

  vsCodErr   VARCHAR2(50) := NULL;
  vnRowCount NUMBER       := 0;

  BEGIN
      PWAREG7(psLevl, psTerm, pnSeq, psUser, psStat, 'I');

      BEGIN
          UPDATE SHRTCKN
             SET SHRTCKN_REPEAT_COURSE_IND = NULL,
                 SHRTCKN_ACTIVITY_DATE     = SYSDATE,
                 SHRTCKN_REPEAT_SYS_IND    = NULL
           WHERE SHRTCKN_TERM_CODE        <= psTerm
             AND EXISTS (SELECT NULL
                           FROM SHRTCKL
                          WHERE SHRTCKL_PIDM        = SHRTCKN_PIDM
                            AND SHRTCKL_TERM_CODE   = SHRTCKN_TERM_CODE
                            AND SHRTCKL_TCKN_SEQ_NO = SHRTCKN_SEQ_NO
                            AND SHRTCKL_LEVL_CODE   = psLevl
                        )
              AND           (SHRTCKN_PIDM, SHRTCKN_SUBJ_CODE, SHRTCKN_CRSE_NUMB)
                  IN (SELECT SWRTCKN_PIDM, SWRTCKN_SUBJ_CODE, SWRTCKN_CRSE_NUMB
                        FROM SWRTCKN
                       WHERE SWRTCKN_SEQ       = pnSeq
                         AND SWRTCKN_LEVL_CODE = psLevl
                         AND SWRTCKN_TERM_CODE = psTerm
                     );

          vnRowCount := SQL%ROWCOUNT;

      END;

      COMMIT;

      PWAREG7(psLevl, psTerm, pnSeq, psUser, psStat, 'U');

  EXCEPTION
      WHEN OTHERS THEN
           vsCodErr := SQLCODE;

           ROLLBACK;

           PWAREG7(psLevl, psTerm, pnSeq, psUser, psStat, 'O', vsCodErr);

  END PWAREG3;
/


DROP PUBLIC SYNONYM PWAREG3;

CREATE PUBLIC SYNONYM PWAREG3 FOR BANINST1.PWAREG3;


GRANT EXECUTE ON BANINST1.PWAREG3 TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWAREG3 TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWAREG3 TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWAREG3 TO OAS_PUBLIC;

GRANT EXECUTE ON BANINST1.PWAREG3 TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWAREG3 TO WWW2_USER;
DROP PROCEDURE BANINST1.PWAREG4;

CREATE OR REPLACE PROCEDURE BANINST1.PWAREG4(psLevl VARCHAR2,
                                             psTerm VARCHAR2,
                                             pnSeq  INTEGER,
                                             psUser VARCHAR2,
                                             psStat VARCHAR2
                                            ) IS

/*
    Tarea: Reglas de repetici?n (Cuarta etapa)
             * Actualizar los campos
               "SHRTCKN_REPEAT_COURSE_IND", "SHRTCKN_ACTIVITY_DATE", "SHRTCKN_REPEAT_SYS_IND",
               de las materias repetidas por los alumnos encontrados en la "etapa 1" y
               actualizadas en la "etapa 2", con los valores

               --Materia aprobada
               SHRTCKN_REPEAT_COURSE_IND = 'I',  (Incluir, "Tomar encuenta la calificacin")
               SHRTCKN_ACTIVITY_DATE     = SYSDATE,
               SHRTCKN_REPEAT_SYS_IND    = 'S'

               --Materia reprobada
               SHRTCKN_REPEAT_COURSE_IND = 'E',  (Excluir, "No tomar encuenta la calificacin")
               SHRTCKN_ACTIVITY_DATE     = SYSDATE,
               SHRTCKN_REPEAT_SYS_IND    = 'S'

    Fecha: 07/07/2011
    AUTOR: MAC
   Modulo: Historia academica



*/

  vnRow    INTEGER      := 0;
  vsCodErr VARCHAR2(50) := NULL;

  csS       CONSTANT VARCHAR2(1) := 'S';
  cdSysDate CONSTANT DATE        := SYSDATE;
  cn4       constant VARCHAR2(1)   := '4';
  csRE      constant VARCHAR2(2)   := 'RE';
  cn1       constant number(1)   := 1;
  vnReprobadas number(2)   := 0;
  vnAprobadas number(3) := 0;
  -- alumnos y materias
  --cuRegla
  CURSOR cuRegla IS
         SELECT SWRTCKN_PIDM      AS Pidm,
                SWRTCKN_SUBJ_CODE AS Subj,
                SWRTCKN_CRSE_NUMB AS Crse,
                SWRTCKN_GRDE_CODE_FINAL As Cali
           FROM SWRTCKN
          WHERE SWRTCKN_SEQ       = pnSeq
            AND SWRTCKN_LEVL_CODE = psLevl
            AND SWRTCKN_TERM_CODE = psTerm;

  --excluir (E: no tomar encuenta la calificacin) todas la materias encontradas en la "etapa 1" del proceso
  --excluirMaterias
  procedure excluirMaterias(pnPidm number,
                            psSubj varchar2,
                            psCrse varchar2
                           ) is

  csE constant varchar2(1) := 'E';

  begin
      update shrtckn
         set shrtckn_repeat_course_ind  = csE,
             shrtckn_activity_date      = cdSysDate,
             shrtckn_repeat_sys_ind     = csS
       where shrtckn_repeat_course_ind is null
         and shrtckn_crse_numb          = psCrse
         and shrtckn_subj_code          = psSubj
         and shrtckn_pidm               = pnPidm;
  end excluirMaterias;

  --incluir (I: si tomar encuenta la calificacin) todas la materias encontradas en la "etapa 1" del proceso
  --incluirMaterias

  procedure incluirMaterias(pnPidm number,
                            psSubj varchar2,
                            psCrse varchar2
                           ) is

  typE regGrde is record(rGrde shrtckg.shrtckg_grde_code_final%type,
                         rCrnn shrtckn.shrtckn_crn%type,
                         rSeqn shrtckn.shrtckn_seq_no%type,
                         rTerm shrtckn.shrtckn_term_code%type
                        );

  regActualiza regGrde;

  cn5   constant number(1)   := 5;
  csP   constant varchar2(1) := 'P';
  cs0   constant varchar2(1) := '0';
  csAC  constant varchar2(2) := 'AC';
  csAD  constant varchar2(2) := 'AD';
  csCN  constant varchar2(2) := 'CN';
  csOU  constant varchar2(2) := 'OU';
  csRM  constant varchar2(2) := 'RM';
  csNV  constant varchar2(2) := 'RM';
  csOU1 constant varchar2(3) := 'OU1';
  csRE  constant varchar2(2) := 'RE';
  csOU2 constant varchar2(3) := 'OU2';
  cs7c0 constant varchar2(3) := '7,0';
  cs7p0 constant varchar2(3) := '7.0';
  cs3p5 constant varchar2(3) := '3.5';

  -- calificaciones de las materias
  --cuGrde
  cursor cuGrde Is
         select decode(b.shrtckg_grde_code_final,
                       cs7c0, cs7p0,
                       csAC,  cs7p0,
                       csAD,  cs0,
                       csCN,  cs0,
                       csOU,  cs0,
                       csOU1, cs0,
                       csOU2, cs0,
                       csP,   cs0,
                       csRM,  cs0,
                       csNV,  cs0,
                       csRE,  cs3p5,
                       b.shrtckg_grde_code_final
                )                   as Grde,
                a.shrtckn_crn       as Crnn,
                a.shrtckn_seq_no    as Seqn,
                a.shrtckn_term_code as Term
           from shrtckn a,
                shrtckg b
          where a.shrtckn_pidm      = b.shrtckg_pidm
            and a.shrtckn_seq_no    = b.shrtckg_tckn_seq_no
            and a.shrtckn_term_code = b.shrtckg_term_code
            and b.shrtckg_seq_no    = (select max(c.shrtckg_seq_no)
                                         from shrtckg c
                                        where c.shrtckg_term_code   = a.shrtckn_term_code
                                          and c.shrtckg_pidm        = a.shrtckn_pidm
                                          and c.shrtckg_tckn_seq_no = a.shrtckn_seq_no
                                      )
            and a.shrtckn_crse_numb = psCrse
            and a.shrtckn_subj_code = psSubj
            and a.shrtckn_pidm      = pnPidm
            and b.shrtckg_grde_code_final <> 'NV'
            order by 1 desc, a.shrtckn_term_code desc,
            shrtckg_activity_date;



  --incluirCurso
  procedure incluirCurso(psTerm varchar2,
                         pnSeqn number
                        ) is

  csI constant varchar2(1) := 'I';

  begin
      update shrtckn
          set shrtckn_repeat_course_ind = csI,
              shrtckn_activity_date     = cdSysDate,
              shrtckn_repeat_sys_ind    = csS
        where shrtckn_seq_no    = pnSeqn
          and shrtckn_term_code = psTerm
          and shrtckn_subj_code = psSubj
          and shrtckn_crse_numb = psCrse
          and shrtckn_pidm      = pnPidm;
  end incluirCurso;


  begin
      -- el cursor solo "procesa" el primer registro de varios que puede obtener

      open cuGrde;
      fetch cuGrde into regActualiza;

            --incluir el primer curso encontrado
            incluirCurso(regActualiza.rTerm, regActualiza.rSeqn);

      close cuGrde;


  end incluirMaterias;

procedure incluirMateriasReprobadas(pnPidm number,
                            psSubj varchar2,
                            psCrse varchar2
                           ) is

  typE regGrdeOrden is record(rGrde shrtckg.shrtckg_grde_code_final%type,
                         rCrnn shrtckn.shrtckn_crn%type,
                         rSeqn shrtckn.shrtckn_seq_no%type,
                         rTerm shrtckn.shrtckn_term_code%type
                        );

  regActualizaOrden regGrdeOrden;

  cn5   constant number(1)   := 5;
  csP   constant varchar2(1) := 'P';
  cs0   constant varchar2(1) := '0';
  csAC  constant varchar2(2) := 'AC';
  csAD  constant varchar2(2) := 'AD';
  csCN  constant varchar2(2) := 'CN';
  csOU  constant varchar2(2) := 'OU';
  csRM  constant varchar2(2) := 'RM';
  csOU1 constant varchar2(3) := 'OU1';
  csOU2 constant varchar2(3) := 'OU2';
  cs7c0 constant varchar2(3) := '7,0';
  cs7p0 constant varchar2(3) := '7.0';
  csNV  constant varchar2(3) := 'NV';
  cs3p5 constant varchar2(3) := '3.5';
  -- calificaciones de las materias
  --cuGrde

  cursor cuGrdeOrden Is
         select decode(b.shrtckg_grde_code_final,
                       cs7c0, cs7p0,
                       csAC,  cs7p0,
                       csAD,  cs0,
                       csCN,  cs0,
                       csOU,  cs0,
                       csOU1, cs0,
                       csOU2, cs0,
                       csP,   cs0,
                       csRM,  cs0,
                       csNV,  cs0,
                       csRE,  cs3p5,
                       b.shrtckg_grde_code_final
                )                   as Grde,
                a.shrtckn_crn       as Crnn,
                a.shrtckn_seq_no    as Seqn,
                a.shrtckn_term_code as Term
           from shrtckn a,
                shrtckg b
          where a.shrtckn_pidm      = b.shrtckg_pidm
            and a.shrtckn_seq_no    = b.shrtckg_tckn_seq_no
            and a.shrtckn_term_code = b.shrtckg_term_code
            and b.shrtckg_seq_no    = (select max(c.shrtckg_seq_no)
                                         from shrtckg c
                                        where c.shrtckg_term_code   = a.shrtckn_term_code
                                          and c.shrtckg_pidm        = a.shrtckn_pidm
                                          and c.shrtckg_tckn_seq_no = a.shrtckn_seq_no
                                      )
            and a.shrtckn_crse_numb = psCrse
            and a.shrtckn_subj_code = psSubj
            and a.shrtckn_pidm      = pnPidm
             and b.shrtckg_grde_code_final <> 'NV'
          order by-- b.shrtckg_grde_code_final desc,
                   a.shrtckn_term_code   desc;


  --incluirCurso
  procedure incluirCursoReprobado(psTerm varchar2,
                         pnSeqn number
                        ) is

  csI constant varchar2(1) := 'I';
  csAC constant varchar2(2) := 'AC';

  begin
      update shrtckn
          set shrtckn_repeat_course_ind = csI,
              shrtckn_activity_date     = cdSysDate,
              shrtckn_repeat_sys_ind    = csS
        where shrtckn_seq_no    = pnSeqn
          and shrtckn_term_code = psTerm
          and shrtckn_subj_code = psSubj
          and shrtckn_crse_numb = psCrse
          and shrtckn_pidm      = pnPidm;
  end incluirCursoReprobado;


  begin
      -- el cursor solo "procesa" el primer registro de varios que puede obtener

     open cuGrdeOrden;

        fetch cuGrdeOrden into regActualizaOrden;

            --incluir el primer curso encontrado
            incluirCursoReprobado(regActualizaOrden.rTerm, regActualizaOrden.rSeqn);

        close cuGrdeOrden;


  end incluirMateriasReprobadas;


  BEGIN

      PWAREG7(psLevl, psTerm, pnSeq, psUser, psStat, 'I');

      -- alumnos y materias
      FOR regRgl IN cuRegla LOOP
        vnRow := vnRow + 1;

          --excluir todas la materias encontradas en la "etapa 1" del proceso
          --(E: no tomar encuenta la calificacin)
          excluirMaterias(regRgl.Pidm, regRgl.Subj, regRgl.Crse);


          --incluir la primera meteria que tenga la fecha mas actual por periodo y calificacion
          --(I: si tomar encuenta la calificacin)

          select count(1) into vnReprobadas
         from shrtckn a,
                shrtckg b
          where a.shrtckn_pidm      = b.shrtckg_pidm
            and a.shrtckn_seq_no    = b.shrtckg_tckn_seq_no
            and a.shrtckn_term_code = b.shrtckg_term_code
            and b.shrtckg_seq_no    = (select max(c.shrtckg_seq_no)
                                         from shrtckg c
                                        where c.shrtckg_term_code   = a.shrtckn_term_code
                                          and c.shrtckg_pidm        = a.shrtckn_pidm
                                          and c.shrtckg_tckn_seq_no = a.shrtckn_seq_no
                                      )
            and a.shrtckn_crse_numb = regRgl.Crse
            and a.shrtckn_subj_code = regRgl.Subj
            and a.shrtckn_pidm      = regRgl.Pidm
            and    (b.shrtckg_grde_code_final = csRE or b.shrtckg_grde_code_final <= cn4)
            and (b.shrtckg_grde_code_final <> 'AC' or b.shrtckg_grde_code_final >= cn4);

             select count(1) into vnAprobadas
         from shrtckn a,
                shrtckg b
          where a.shrtckn_pidm      = b.shrtckg_pidm
            and a.shrtckn_seq_no    = b.shrtckg_tckn_seq_no
            and a.shrtckn_term_code = b.shrtckg_term_code
            and b.shrtckg_seq_no    = (select max(c.shrtckg_seq_no)
                                         from shrtckg c
                                        where c.shrtckg_term_code   = a.shrtckn_term_code
                                          and c.shrtckg_pidm        = a.shrtckn_pidm
                                          and c.shrtckg_tckn_seq_no = a.shrtckn_seq_no
                                      )
            and a.shrtckn_crse_numb = regRgl.Crse
            and a.shrtckn_subj_code = regRgl.Subj
            and a.shrtckn_pidm      = regRgl.Pidm
            and    (b.shrtckg_grde_code_final <> csRE or b.shrtckg_grde_code_final >= cn4)
            and (b.shrtckg_grde_code_final = 'AC' or b.shrtckg_grde_code_final >= cn4);


         if vnReprobadas <= 0 AND vnAprobadas > 0 then
          incluirMaterias(regRgl.Pidm, regRgl.Subj, regRgl.Crse);
          end if;
         -- if vnReprobadas = cn1 AND vnAprobadas = 0 then
          --incluirMaterias(regRgl.Pidm, regRgl.Subj, regRgl.Crse);
          --end if;
          if vnReprobadas > 0 AND vnAprobadas = 0 then
          incluirMateriasReprobadas(regRgl.Pidm, regRgl.Subj, regRgl.Crse);
          end if;
          if vnReprobadas  > 0 AND vnAprobadas > 0 then
           incluirMaterias(regRgl.Pidm, regRgl.Subj, regRgl.Crse);
          end if;
          if vnReprobadas = 0 AND vnAprobadas > 0 then
           incluirMaterias(regRgl.Pidm, regRgl.Subj, regRgl.Crse);
          end if;
          IF vnRow = 50 THEN
             vnRow := 0;
             COMMIT;
          END IF;

      END LOOP;

      COMMIT;

      PWAREG7(psLevl, psTerm, pnSeq, psUser, psStat, 'U');

  EXCEPTION
      WHEN OTHERS THEN
           vsCodErr := SQLCODE;

           ROLLBACK;

           PWAREG7(psLevl, psTerm, pnSeq, psUser, psStat, 'O', vsCodErr);

  END PWAREG4;
/


DROP PUBLIC SYNONYM PWAREG4;

CREATE PUBLIC SYNONYM PWAREG4 FOR BANINST1.PWAREG4;


GRANT EXECUTE ON BANINST1.PWAREG4 TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWAREG4 TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWAREG4 TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWAREG4 TO OAS_PUBLIC;

GRANT EXECUTE ON BANINST1.PWAREG4 TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWAREG4 TO WWW2_USER;
DROP PROCEDURE BANINST1.PWAREG5;

CREATE OR REPLACE PROCEDURE BANINST1.PWAREG5(psTerm VARCHAR2,
                                             psLevl VARCHAR2,
                                             pnSeqc INTEGER DEFAULT 0) IS

  vnEtapa    INTEGER        := 4;
  vnSeq      INTEGER        := pnSeqc;
  vsEatapa1  VARCHAR2(200)  := 'Identificar materias repetidas por los alumnos.';
  vsEatapa2  VARCHAR2(200)  := 'Respaldo de las materias de historia acad?mica';
  vsEatapa3  VARCHAR2(200)  := 'Actualizar a \"NULL\" los campos SHRTCKN_REPEAT_COURSE_IND y SHRTCKN_REPEAT_SYS_IND';
  vsEatapa4  VARCHAR2(200)  := 'Actualizar las materias repetidas con \"I, E\"';
  vsUser     VARCHAR2(500);
vgsUSR VARCHAR2(500);
  BEGIN
      -- valida que el usuario pertenezca a la base de datos.
      --IF PK_Login.F_ValidacionDeAcceso(vsUser) THEN RETURN; END IF;
   IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      IF vnSeq = 0 THEN
         SELECT SQC_SWNTCKA.NEXTVAL
           INTO vnSeq
           FROM DUAL;
      END IF;

      htp.p('
      <html><head><title></title>
      ');

      pK_ObjHTML.P_CssTabs;

      PK_ObjHTML.P_NoCache;

      htp.p('<script language=''JavaScript''><!--
      javascript:window.history.forward(1);

      var vgsEatapa1 = "'||vsEatapa1||'";
      var vgsEatapa2 = "'||vsEatapa2||'";
      var vgsEatapa3 = "'||vsEatapa3||'";
      var vgsEatapa4 = "'||vsEatapa4||'";
      ');

      ----
      htp.p('function f_Etapa(pnEtapa) {
        switch(pnEtapa) {
          case 1: document.frmDescEtp1.txtEtapa1.value = vgsEatapa1;
                  break;
          case 2: document.frmDescEtp2.txtEtapa2.value = vgsEatapa2;
                  break;
          case 3: document.frmDescEtp3.txtEtapa3.value = vgsEatapa3;
                  break;
          case 4: document.frmDescEtp4.txtEtapa4.value = vgsEatapa4;
                  break;
        }

      } //f_Etapa
      ');

      ----
      htp.p('function f_Ejecucion(pnEtapa, psLevel) {
        if(pnEtapa==5) {
           vgnEjecucion = false;

           f_CompletaProgreso(pnEtapa-2);

           parent.f_Enviar('||vnSeq||',psLevel);

           return;
        }

        vgnEtapa     = (pnEtapa - 1);
        vgnObjProces = 0;

        f_Etapa(pnEtapa);

               if(pnEtapa == 1) {
                  f_Intervalo();
        } else if(pnEtapa > 1) {
                  f_CompletaProgreso(pnEtapa-2);
        }

        document.frmExecut.psLevl.value = psLevel;
        document.frmExecut.psStat.value = pnEtapa;
        document.frmExecut.submit();

        f_Ciclo();
      } //f_Ejecucion
      ');

      ----
      htp.p('function f_Ciclo() {
      setTimeout("document.frmExecut.submit()",100000);
      } //f_Ciclo
      ');

      htp.p('//--></script>');
      --
      htp.p('
      </head><body bgcolor="#ffffff" class="bodyCursorW" onLoad="f_Ejecucion(1,'''||psLevl||''');">

      <table border="0" cellpadding="1" cellspacing="1" width="100%" bordercolor="#000000" bgcolor="#ffffff">

      <tr bgcolor="#efefef">
          <th align="right">Periodo:</th>
          <td colspan="2">'||psTerm||' - '||pk_Catalogo.Periodo(psTerm)||'</td></tr>
      <tr bgcolor="#efefef">
          <th align="right" >Nivel:</th>
          <td colspan="2">'||psLevl||' - '||pk_Catalogo.Nivel(psLevl)  ||'</td></tr>
      ');

      FOR vnI IN 1..vnEtapa LOOP
          htp.p('
          <tr>
          <th width="20%" align="right">Etapa '||vnI||'</th>
          <td width="15%">
          ');

          PWAPRSS((vnI-1),6);

          htp.p('</td>
          <form name="frmDescEtp'||vnI||'" onSubmit="return false;">
          <td width="65%">
              <input type="text" name="txtEtapa'||vnI||'" tabindex="-1" style="border:outset 0;" readonly />
              </td></form></tr>
          ');
      END LOOP;

      htp.p('
      <tr><td></td>
          <td colspan="2">
               <iframe name="fraExecut" id="fraExecut" src="about:blank" width="100%" height="100px" frameborder="0">
               </iframe>
          </td></tr>
      </table>

      <form name="frmExecut" action="PWAREG6" method="post" target="fraExecut">
      <input type="hidden" name="psLevl" value="'||psLevl||'" />
      <input type="hidden" name="psTerm" value="'||psTerm||'" />
      <input type="hidden" name="pnSeq"  value="'||vnSeq ||'" />
      <input type="hidden" name="psUser" value="'||vgsUSR||'" />
      <input type="hidden" name="psStat" />
      </form>



      </body>
      </html>
      ');

  END PWAREG5;
/


DROP PUBLIC SYNONYM PWAREG5;

CREATE PUBLIC SYNONYM PWAREG5 FOR BANINST1.PWAREG5;


GRANT EXECUTE ON BANINST1.PWAREG5 TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWAREG5 TO WWW2_USER;
DROP PROCEDURE BANINST1.PWAREG6;

CREATE OR REPLACE PROCEDURE BANINST1.PWAREG6(psLevl  VARCHAR2,
                                             psTerm  VARCHAR2,
                                             pnSeq   INTEGER,
                                             psUser  VARCHAR2,
                                             psStat  VARCHAR2) IS

/*
    Tarea: Ejecutar las Reglas de repetici?n (Primera etapa)
    Fecha: 07/07/20011
   Modulo: Historia academica

*/
  vgsUSR    VARCHAR2(500);
  vsProceso VARCHAR2(50)   := '(Etapa: '||psStat||') Proceso en ejecuci?n...';
  vdEnd     DATE           := NULL;
  vdBegin   DATE           := NULL;

  procedure p_SiguienteEtapa is

  vnEtapa INTEGER := TO_NUMBER(psStat)+1;

  begin
      htp.p('
      <html><head><title></title>

      <script language=''JavaScript''><!--
      javascript:window.history.forward(1);
      //--></script>

      <style type="text/css"><!--
      body {cursor:wait;}
      --></style>

      </head>
      <body bgcolor="#ffffff" onLoad="parent.f_Ejecucion('||vnEtapa||','''||psLevl||''');">
      ');

      IF vnEtapa > 4 THEN
         htp.p('EL PROCESO A TERMINADO DE EJECUTARSE');
      ELSE
         htp.p(vsProceso);
      END IF;

      htp.p('
      </body>
      </html>
      ');

  end p_SiguienteEtapa;

  procedure p_Ciclo is


  begin
      htp.p('
      <html><head><title></title>

      <script language=''JavaScript''><!--
      javascript:window.history.forward(1);
      //--></script>

      <style type="text/css"><!--
      body {cursor:wait;}
      --></style>

      </head>
      <body bgcolor="#ffffff" onLoad="parent.f_Ciclo();">
      '||vsProceso||'
      </body>
      </html>
      ');

  end p_Ciclo;

  procedure p_Inicio is


  begin
      htp.p('
      <html><head><title></title>

      <script language=''JavaScript''><!--
      javascript:window.history.forward(1);
      //--></script>

      <style type="text/css"><!--
      body {cursor:wait;}
      --></style>

      </head>
      <body bgcolor="#ffffff">
      '||vsProceso||'
      </body>
      </html>
      ');

  end p_Inicio;

  BEGIN
      -- valida que el usuario pertenezca a la base de datos.
      IF PK_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      -- se busca si el proceso ya termino
      BEGIN
          SELECT SWNTCKA_BEGIN,SWNTCKA_END
            INTO vdBegin, vdEnd
            FROM SWNTCKA
           WHERE SWNTCKA_SEQ       = pnSeq
             AND SWNTCKA_TERM_CODE = psTerm
             AND SWNTCKA_LEVL_CODE = psLevl
             AND SWNTCKA_PROCEDURE = 'PWAREG'||psStat
             AND SWNTCKA_USER      = psUser;
      EXCEPTION
          WHEN NO_DATA_FOUND THEN
               vdEnd := NULL;
          WHEN OTHERS THEN
               vdEnd := NULL;
      END;


      IF    vdEnd IS NOT NULL THEN
            p_SiguienteEtapa;


            RETURN;
      ELSIF vdBegin IS NOT NULL AND vdEnd IS NULL THEN
            p_Ciclo;

            RETURN;
      END IF;

      p_Inicio;

      IF vdBegin IS NULL THEN
         IF    psStat = '1' THEN
               PWAREG1(psLevl, psTerm, pnSeq, psUser, psStat);

         ELSIF psStat = '2' THEN
               PWAREG2(psLevl, psTerm, pnSeq, psUser, psStat);

         ELSIF psStat = '3' THEN
               PWAREG3(psLevl, psTerm, pnSeq, psUser, psStat);

         ELSIF psStat = '4' THEN
               PWAREG4(psLevl, psTerm, pnSeq, psUser, psStat);

         END IF;
      END IF;


  END PWAREG6;
/


DROP PUBLIC SYNONYM PWAREG6;

CREATE PUBLIC SYNONYM PWAREG6 FOR BANINST1.PWAREG6;


GRANT EXECUTE ON BANINST1.PWAREG6 TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWAREG6 TO WWW2_USER;
DROP PROCEDURE BANINST1.PWAREG7;

CREATE OR REPLACE PROCEDURE BANINST1.PWAREG7(psLevl   VARCHAR2,
                                             psTerm   VARCHAR2,
                                             pnSeq    INTEGER,
                                             psUser   VARCHAR2,
                                             psStat   VARCHAR2,
                                             psAccion VARCHAR2,
                                             psCodErr VARCHAR2 DEFAULT NULL) IS

/*
    Tarea: Ejecutar las Reglas de repetici?n (Primera etapa)
    Fecha: 07/07/2011
   Modulo: Historia academica



*/

vsCodErr Varchar2(5000);
  BEGIN


            IF    psAccion = 'I' THEN
            INSERT INTO SWNTCKA(SWNTCKA_SEQ, SWNTCKA_TERM_CODE, SWNTCKA_LEVL_CODE, SWNTCKA_PROCEDURE, SWNTCKA_USER)
                         VALUES(pnSeq,       psTerm,            psLevl,            'PWAREG'||psStat,  psUser);

      ELSIF psAccion = 'U' THEN
            UPDATE SWNTCKA
               SET SWNTCKA_END       = SYSDATE
             WHERE SWNTCKA_SEQ       = pnSeq
               AND SWNTCKA_TERM_CODE = psTerm
               AND SWNTCKA_LEVL_CODE = psLevl
               AND SWNTCKA_PROCEDURE = 'PWAREG'||psStat
               AND SWNTCKA_USER      = psUser;

      ELSIF psAccion = 'O' THEN
            UPDATE SWNTCKA
               SET SWNTCKA_ERROR     = SWNTCKA_ERROR||' '||psCodErr,
                   SWNTCKA_END       = SYSDATE
             WHERE SWNTCKA_SEQ       = pnSeq
               AND SWNTCKA_TERM_CODE = psTerm
               AND SWNTCKA_LEVL_CODE = psLevl
               AND SWNTCKA_PROCEDURE = 'PWAREG'||psStat
               AND SWNTCKA_USER      = psUser;

      END IF;


        EXCEPTION WHEN OTHERS then
        vsCodErr := SQLCODE;
COMMIT;
  END PWAREG7;
/


DROP PUBLIC SYNONYM PWAREG7;

CREATE PUBLIC SYNONYM PWAREG7 FOR BANINST1.PWAREG7;


GRANT EXECUTE ON BANINST1.PWAREG7 TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWAREG7 TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWAREG7 TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWAREG7 TO OAS_PUBLIC;

GRANT EXECUTE ON BANINST1.PWAREG7 TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWAREG7 TO WWW2_USER;
DROP PROCEDURE BANINST1.PWAREG8;

CREATE OR REPLACE PROCEDURE BANINST1.PWAREG8(pnSeq INTEGER,
 psExl VARCHAR2 DEFAULT NULL) IS

/*
 Tarea: REPORTE DE REGLAS DE REPETICI?N
 Fecha: 07/07/2011

 Modulo: Historia academica

*/

 vnRow INTEGER := 0;
 vsOpciones VARCHAR2(50) := '"imprimir","excel",';
 vsAcciones VARCHAR2(200) := 'javascript:f_Imprimir();,javascript:f_Excel(),';
 vgsUSR VARCHAR2(500);
 vsError SWNTCKA.SWNTCKA_ERROR%TYPE := NULL;

 cursor cuReglas IS
 SELECT SWNTCKA_SEQ Seqn,
 SWNTCKA_TERM_CODE Term,
 SWNTCKA_LEVL_CODE Levl,
 DECODE(SWNTCKA_PROCEDURE,
 'PWAREG1',
 '1. Identificar materias repetidas por los alumnos',
 'PWAREG2',
 '2. Respaldo de las materias de historia acad?mica',
 'PWAREG3',
 '3. Actualizar a "NULL" los campos SHRTCKN_REPEAT_COURSE_IND y SHRTCKN_REPEAT_SYS_IND',
 'PWAREG4',
 '4. Actualizar las materias repetidas con "I, E"'
 ) Etpa,
 SWNTCKA_ERROR Erro
 FROM SWNTCKA
 WHERE SWNTCKA_SEQ = pnSeq
 ORDER BY SWNTCKA_BEGIN;

 BEGIN
 -- valida que el usuario pertenezca a la base de datos.
 IF PK_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

 IF psExl IS NOT NULL THEN
 owa_util.mime_header('application/ms-excel',true);
 END IF;

 htp.p('
 <html><head><title>&nbsp;</title>
 ');

 pK_ObjHTML.P_CssTabs;

 PK_ObjHTML.P_NoCache;

 htp.p('<script language=''JavaScript''><!--
 javascript:window.history.forward(1);
 ');
 ----
 htp.p('function f_Imprimir() {
	 window.focus()
		 print();
 } //f_Imprimir;
 ');

 ----
 htp.p('function f_Excel(){
 window.status = "Excel...";
 document.frmReporte.submit();
 } //f_Excel');

 htp.p('
 //--></script>
 </head><body bgcolor="#ffffff" class="bodyCeroR">
 <table border="0" cellpadding="0" cellspacing="0" width="20%">
 <tr><td>');

 pk_MenuAplicacion.P_MenuDinamico(vsOpciones, vsAcciones, vsOpciones);

 htp.p('
 </td></tr></table>
 <br/>
 <table border="1" cellpadding="2" cellspacing="1" width="100%" bordercolor="#eeeeee">
 <tr><td colspan="5" bgcolor="#dddddd" align="center">
 En caso de ocurrir un error favor de reportar a
 <a href="mailto:soportesiu@caesc.mx"><font color="#ff8500">HELP DESK</font></a>
 </td>
 </tr>
 <tr><th width="10%" bgcolor="#efefef">Proceso</th>
 <th width="10%" bgcolor="#efefef">Periodo</th>
 <th width="10%" bgcolor="#efefef">Nivel </th>
 <th width="40%" bgcolor="#efefef">Etapa </th>
 <th width="30%" bgcolor="#efefef"><font color="#ff0000">Error</font></th>
 </tr>
 ');

 FOR regRgl IN cuReglas LOOP
 IF vnRow = 1 THEN
 regRgl.Seqn := NULL;
 END IF;

 IF vsError IS NULL THEN
 vsError := regRgl.Erro;
 END IF;

 htp.p('
 <tr>
 <td valign="top" align="center">'||regRgl.Seqn||'</td>
 <td valign="top" align="center">'||regRgl.Term||'</td>
 <td valign="top" align="center">'||regRgl.Levl||'</td>
 <td valign="top">'||regRgl.Etpa||'</td>
 <td valign="top">'||regRgl.Erro||'</td>
 </tr>
 ');

 vnRow := 1;
 END LOOP;

 htp.p('
 <tr><td colspan="5" bgcolor="#dddddd" align="center">
 En caso de ocurrir un error favor de reportar a
 <a href="mailto:soportesiu@caesc.mx"><font color="#ff8500">HELP DESK</font></a>
 </td>
 </tr>
 </table>
 <br/>
 <br/>

 <form name="frmReporte" action=BANINST1."PWAREG8" method="post">
 <input type="hidden" name="pnSeq" value="'||pnSeq||'"/>
 <input type="hidden" name="psExl" value="'||pnSeq||'" />
 </form>

 </body>
 </html>
 ');
 END PWAREG8;
/


DROP PUBLIC SYNONYM PWAREG8;

CREATE PUBLIC SYNONYM PWAREG8 FOR BANINST1.PWAREG8;


GRANT EXECUTE ON BANINST1.PWAREG8 TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWAREG8 TO WWW2_USER;
DROP PROCEDURE BANINST1.PWAREG9;

CREATE OR REPLACE PROCEDURE BANINST1.PWAREG9(pnBuscar VARCHAR2,
 pnProc INTEGER DEFAULT NULL,
 psLevl VARCHAR2 DEFAULT NULL) IS

 vgsUSR VARCHAR2(500);

 CURSOR cuRegla IS
 SELECT SWNTCKA_TERM_CODE Term,
 SWNTCKA_LEVL_CODE Levl,
 SWNTCKA_USER Usrr,
 SWNTCKA_SEQ Proc
 FROM SWNTCKA
 WHERE SWNTCKA_PROCEDURE = 'PWAREG1'
 ORDER BY SWNTCKA_SEQ DESC, SWNTCKA_LEVL_CODE;

 procedure p_Cantidad is

 vnCantidad INTEGER := 0;
 vnIndex INTEGER := 0;
 vnLnght INTEGER := 1;

 cursor cuMaterias is
 select substr(swntckn_subj_code,1,1) Subj,
 count(1) Cantidad
 from swntckn
 where swntckn_seq = pnProc
 and swntckn_levl_code = psLevl
 group by substr(swntckn_subj_code,1,1)
 order by substr(swntckn_subj_code,1,1);

 begin
 select count(1)
 into vnCantidad
 from swntckn
 where swntckn_seq = pnProc
 and swntckn_levl_code = psLevl;

 htp.p('<html><head><title>&nbsp;</title>

 <script language="JavaScript"><!--
 function f_Cantidad() {
 opener.document.frmRegla.psLetra.length = 0;
 opener.document.frmRegla.psLetra.length = '||vnLnght||';
 opener.document.frmRegla.psLetra['||vnIndex||'].text = "";
 opener.document.frmRegla.psLetra['||vnIndex||'].value = "";
 ');

 for regMat in cuMaterias loop
 vnLnght := vnLnght + 1;
 vnIndex := vnIndex + 1;

 htp.p('
 opener.document.frmRegla.psLetra.length = '||vnLnght||';
 opener.document.frmRegla.psLetra['||vnIndex||'].text = "'||regMat.Subj||' - '||regMat.Cantidad||'";
 opener.document.frmRegla.psLetra['||vnIndex||'].value = "'||regMat.Subj||'";
 ');
 end loop;

 htp.p('
 opener.document.frmRegla.txtRegs.value = "'||vnCantidad||'";
 opener.document.frmRegla.psLetra.className = "";
 opener.document.frmRegla.txtRegs.className = "";
 opener.document.frmRegla.psLetr1.className = "";
 opener.document.frmRegla.txtReg1.className = "";
 opener.document.body.className = ""
 close();
	 }
 //--></script>
	 </head><body onLoad="f_Cantidad();">
 </body></html>
 ');

 end p_Cantidad;

 BEGIN
 -- valida que el usuario pertenezca a la base de datos.
 IF PK_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

 IF pnProc IS NOT NULL THEN
 p_Cantidad;

 RETURN;
 END IF;

 htp.p('
 <html><head><title></title>
 ');

 PK_ObjHTML.P_NoCache;

 htp.p(PK_ObjHTML.vgsCssBanner);

 pK_ObjHTML.P_CssTabs;

 htp.p('
 <style type="text/css"><!--
 select.oculta {font-size:1.0pt;width:0%;}
 --></style>
 <script language=''JavaScript''><!--
 javascript:window.history.forward(1);
 var vgsBuscar = true;
 ');

 ----
 htp.p('function f_Buscar() {
 if(!vgsBuscar) { return; }

 document.frmLimpia.submit();
 document.body.className = "bodyCursorW";

 var vsTerm = document.frmRegla.psTermCode.options[document.frmRegla.psTermCode.selectedIndex].alt;
 var vsLevl = document.frmRegla.psTermCode.options[document.frmRegla.psTermCode.selectedIndex].title;
 var vsSeqc = document.frmRegla.psTermCode.options[document.frmRegla.psTermCode.selectedIndex].value;
 var vsLetr = document.frmRegla.psLetra.options[document.frmRegla.psLetra.selectedIndex].value;

 document.frmBuscar.psTerm.value = vsTerm;
 document.frmBuscar.psLevl.value = vsLevl;
 document.frmBuscar.pnSeqc.value = vsSeqc;
 document.frmBuscar.psLett.value = vsLetr;

 vgsBuscar = false;

 document.frmBuscar.submit();
 } //f_Buscar');

 ----
 htp.p('function f_Registros() {
 if(!vgsBuscar) { return; }

 document.frmRegla.psLetra.className = "oculta";
 document.frmRegla.txtRegs.className = "oculto";
 document.frmRegla.psLetr1.className = "oculto";
 document.frmRegla.txtReg1.className = "oculto";

 var vsSeqc = document.frmRegla.psTermCode.options[document.frmRegla.psTermCode.selectedIndex].value;
 var vsLevl = document.frmRegla.psTermCode.options[document.frmRegla.psTermCode.selectedIndex].title;

 frmLOV = open("about:blank", "winMateria", "toolbar=no,directories=no,status=no,resizable=yes,location=no,titlebar=no,scrollbars=yes");

 if(navigator.appVersion.charAt(0) >=4) {
		 frmLOV.resizeTo(10,10);
		 frmLOV.moveTo(0,0);
	 }

 if(frmLOV.opener == null) {
 frmLOV.opener = self;
 }

 document.frmMateria.pnProc.value = vsSeqc;
 document.frmMateria.psLevl.value = vsLevl;
 document.body.className = "bodyCursorW";

 setTimeout("document.frmMateria.submit()",1000);

 } //f_Registros');

 ----
 htp.p('function f_Ejecutar() {
 if(!vgsBuscar) { return; }

 var vsTerm = document.frmRegla.psTermCode.options[document.frmRegla.psTermCode.selectedIndex].alt;
 var vsLevl = document.frmRegla.psTermCode.options[document.frmRegla.psTermCode.selectedIndex].title;
 var vsSeqc = document.frmRegla.psTermCode.options[document.frmRegla.psTermCode.selectedIndex].value;
 var vsLetr = document.frmRegla.psLetra.options[document.frmRegla.psLetra.selectedIndex].value;

 if( vsLetr != "") {

 }

 } //f_Ejecutar');

 htp.p('function f_ReiniciarOperacioes() {
 vgsBuscar = true;

 } //f_ReiniciarOperacioes');

 htp.p('function f_LimpiarFrame() {
 if(!vgsBuscar) { return; }

 document.frmLimpia.submit();
 } //f_LimpiarFrame');

 htp.p('function f_QuitarReloj() {
 document.body.className = "";
 vgsBuscar = true;
 } //f_QuitarReloj');

 htp.p('//--></script>');

 htp.p('
 </head><body bgcolor="#ffffff"><br/><br/><br/><br/><br/>
 <table border="0" width="100%" cellpadding="0" cellspacing="0">
 <form name="frmRegla" onSubmit="return false;">
 <tr><th width="60%" class="thTitulo" valign="bottom" align="left">
 <br>Reporte de reglas de repetici&oacute;n
 </th><td width="40%">
 ');

 pk_MenuAplicacion.P_MenuSalir('PWAREGL?psParametro=PWAREGL');

 htp.p('</td></tr></table>
 <hr size="1" width="100%">

 <table border="0" cellpadding="2" cellspacing="1" width="100%" bgcolor="#ffffff">
 <tr>
 <th width="10%" valign="top" align="right" bgcolor="#FCB654">Regla</th>
 <td width="40%" valign="top" bgcolor="#efefef" colspan="2">
 <select name="psTermCode" onChange="f_Registros();"><option value=""></option>
 ');

 FOR regRgl IN cuRegla LOOP
 htp.p('<option value="'||regRgl.Proc||'" alt="'||regRgl.Term||'" title="'||regRgl.Levl||'">'||regRgl.Term||' - '||regRgl.Levl||' - '||regRgl.Usrr||' - '||regRgl.Proc||'</option>');
 END LOOP;

 htp.p('
 </select>
 </td>
 <td valign="top" rowspan="3" width="20%">
 ');

 --pk_MenuAplicacion.P_MenuDinamico('"Buscar","Ejecutar",','javascript:f_Buscar();,javascript:f_Ejecutar();,','"Buscar","Desaplicar",');
 pk_MenuAplicacion.P_MenuDinamico('"buscar",','javascript:f_Buscar();,','"Buscar",');

 htp.p('
 </td>
 <td valign="top" rowspan="3" width="30%"></td></tr>
 <tr><td><input type="text" name="txtReg1" class="oculto" tabindex="-1" style="border:outset 0;text-align:right" readonly value="Cantidad de registros:" /></td>
 <td colspan="2">
 <input type="text" name="txtRegs" class="oculto" tabindex="-1" style="border:outset 0;" readonly/></td>
 </tr>
 <tr><td><input type="text" name="psLetr1" class="oculto" tabindex="-1" style="border:outset 0;text-align:right" readonly value="Inicial de la materia" /></td>
 <td width="20%"><select name="psLetra" class="oculta" onChange="f_LimpiarFrame();" />
 </select></td>
 <td width="20%"></td>
 </tr>
 ');

 htp.p('

 <tr><td colspan="5">
 <iframe name="fraBusca" id="fraBusca" src="about:blank" width="100%" height="300px" frameborder="1">
 </iframe>
 </td>

 </form>
 </table>
 </br></br>
 <hr size="1" width="100%">
 </br>

 <form name="frmBuscar" action="PWRREGL" target="fraBusca" method="post">
 <input type="hidden" name="psTerm" />
 <input type="hidden" name="psLevl" />
 <input type="hidden" name="pnSeqc" />
 <input type="hidden" name="psExlS" />
 <input type="hidden" name="psLett" />
 </form>

 <form name="frmMateria" action="PWAREG9" target="winMateria" method="get">
 <input type="hidden" name="pnBuscar" value="B"/>
 <input type="hidden" name="pnProc" />
 <input type="hidden" name="psLevl" />
 </form>

 <form name="frmLimpia" action="about:blank" target="fraBusca">
 </form>

 </body>
 </html>');
 END PWAREG9;
/


DROP PUBLIC SYNONYM PWAREG9;

CREATE PUBLIC SYNONYM PWAREG9 FOR BANINST1.PWAREG9;


GRANT EXECUTE ON BANINST1.PWAREG9 TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWAREG9 TO WWW2_USER;
DROP PROCEDURE BANINST1.PWARSEPRAD;

CREATE OR REPLACE PROCEDURE BANINST1.PWARSEPRAD(psTerm  VARCHAR2,
                                                psEncu  VARCHAR2,
                                                psRate  VARCHAR2 DEFAULT NULL
                                               ) IS

/**************************************************************
           tarea:  realiza la selecin de informacin para el proceso seprad
          mdulo:  resultados del sistema de evaluacin de la prctica docente (seprad)
           autor:  horacio martnez ramrez - hmr
           fecha:  01/nov/2010
**************************************************************/

  csSIN    CONSTANT VARCHAR2(3) := 'SIN';
  csCOMENT CONSTANT VARCHAR2(6) := 'COMENT';
  csC      CONSTANT VARCHAR2(1) := 'C';

  BEGIN
      INSERT INTO SWRPSPD
      (SWRPSPD_TERM_CODE,SWRPSPD_FACULTY_PIDM,SWRPSPD_PIDM,
       SWRPSPD_TEMP_PIDM,SWRPSPD_CRN
      )
      SELECT
       SVRESAS_TERM_CODE,SVRESAS_FACULTY_PIDM,SVRESAS_PIDM,
       SVRESAS_TEMP_PIDM,SVRESAS_CRN
        FROM SVRESAS INNER JOIN SWRPGAC ON (SVRESAS_CRN = SWRPGAC_CRN AND SVRESAS_TERM_CODE = SWRPGAC_TERM_CODE)
       WHERE (
                 psRate IS NULL
              OR
                 SVRESAS_PIDM IN (SELECT A.SGBSTDN_PIDM
                                    FROM SGBSTDN A
                                   WHERE A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                                                      FROM SGBSTDN B
                                                                     WHERE B.SGBSTDN_PIDM = A.SGBSTDN_PIDM
                                                                   )
                                     AND NVL(A.SGBSTDN_RATE_CODE,csSIN) = psRate
                                 )
             )
         AND EXISTS (SELECT NULL
                       FROM SVBTESH
                      WHERE SVBTESH_TSSC_CODE       = SVRESAS_TSSC_CODE
                        AND SVBTESH_ESAS_STATUS_IND = csC
                        AND SVBTESH_FACULTY_PIDM    = SVRESAS_FACULTY_PIDM
                        AND SVBTESH_CRN             = SVRESAS_CRN
                        AND SVBTESH_TERM_CODE       = psTerm
                        AND SVBTESH_ESAS_TEMP_PIDM  = SVRESAS_TEMP_PIDM
                    )
         AND SVRESAS_TSSC_CODE                = psEncu
         AND SVRESAS_TERM_CODE                = psTerm;


  END PWARSEPRAD;
/
DROP PROCEDURE BANINST1.PWATABS;

CREATE OR REPLACE PROCEDURE BANINST1.PWATABS(psTitulos VARCHAR2,
                                             psNames   VARCHAR2
                                            ) IS

/*
   AUTOR: GEPC
   FECHA: 22/03/2010
   TAREA: Objeto para crear pestaas dinamicas.
  MODULO: GENERAL

*/

  vsTitulos VARCHAR2(500) := psTitulos;
  vsTitle   VARCHAR2(30)  := NULL;
  vnTab     INTEGER       := 0;
  vnTabSup  INTEGER       := 0;
  vnTabInf  INTEGER       := NULL;
  vnColumna INTEGER       := 2;
  vnWidTabl NUMBER        := 100;
  vnWdhTab  NUMBER        := 20;

  BEGIN
      WHILE INSTR(vsTitulos,',') > 0 LOOP
            vnTabSup  := vnTabSup + 1;
            vsTitulos := SUBSTR(vsTitulos,INSTR(vsTitulos,',') + 1);
      END LOOP;

      IF vnTabSup > 4 THEN
         vnWdhTab := ROUND(vnWidTabl/vnTabSup,2);
         vnWdhTab := vnWdhTab - 2;
      END IF;

      FOR vnI IN 1..vnTabSup LOOP
          vnWidTabl := vnWidTabl - (vnWdhTab+2);
      END LOOP;

      vsTitulos := psTitulos;
      vnTabInf  := vnTabSup;

      IF vnWidTabl > 0 THEN
         vnColumna := (vnColumna * vnTabSup) + 1;
      ELSE
         vnColumna := vnColumna * vnTabSup;
      END IF;

      htp.p('
      <script language="JavaScript"><!--
      function setTime() {
        setTimeout("f_AplicacionMenu('''||vsTitle||''')",1500);
      } //setTime

      function f_AplicacionMenu(psApliDesc) {
      f_Linea3(document.frmTab.chk1,document.frmTab.chk'||(vnTabInf+1)||');
      f_tab(1);

      window.status = psApliDesc;

      } //f_AplicacionMenu
      //--></script>
      ');

      ---###################3
      htp.p('<table border="0" cellpadding="0" cellspacing="0" width="100%">
      <form name="frmTab">
      <tr>');

      WHILE INSTR(vsTitulos,',') > 0 LOOP
            vsTitle  := SUBSTR(vsTitulos,1, INSTR(vsTitulos,',') - 1);
            vnTab    := vnTab + 1;
            vnTabInf := vnTabInf + 1;

            htp.p('
            <td width="'||vnWdhTab||'%">
                <table border="0" cellpadding="0" cellspacing="0" width="100%">
                      <tr onMouseOver="f_ClassTab(this)" onMouseOut="f_ClassTab(this)" onClick="javascript:f_Linea3(document.frmTab.chk'||vnTab||',document.frmTab.chk'||vnTabInf||'); f_tab('||vnTab||'); f_ClassTab(this); eventoTAB('||vnTab||'); displeyTitle('''||vsTitle||''')" class="CEL2r"><td width="5%">
                              <img src="/imagenes/SupIzq2.gif" /></td>
                          <td width="90%">
                              <input type="hidden" name="chk'||vnTab||'" tabindex="-1" />
                              '||vsTitle||'
                              </td>
                          <td width="5%">
                              <img src="/imagenes/SupDer2.gif" /></td>
                          </tr>
                </table>
            </td>
            <td width="2%"></td>
            ');

            vsTitulos := SUBSTR(vsTitulos,INSTR(vsTitulos,',') + 1);
      END LOOP;

      vsTitulos := psTitulos;

      IF vnWidTabl > 0 THEN
         htp.p('
         <td width="'||vnWidTabl||'%"></td>
         ');
      END IF;

      htp.p('
      </tr>
      <tr class="CEL0Height08">
      ');

      WHILE INSTR(vsTitulos,',') > 0 LOOP
            vnTabSup := vnTabSup + 1;

            htp.p('
            <td class="td03">
                <table border="0" cellpadding="0" cellspacing="0" width="100%">
                    <tr class="CEL2s">
                        <td class="td03"><input type="hidden" name="chk'||vnTabSup||'" tabindex="-1" />
                        </td></tr>
                </table>
            </td>
            <td class="td03"></td>
            ');

            vsTitulos := SUBSTR(vsTitulos,INSTR(vsTitulos,',') + 1);
      END LOOP;

      IF vnWidTabl > 0 THEN
         htp.p('
         <td class="td03"></td>
         ');
      END IF;

      htp.p('
      </tr>
      <tr class="CELHeightr20">
          <td colspan="'||vnColumna||'"></td>
         </tr>
      </form>
      </table>
      ');
      ---###################
      vsTitulos := psTitulos;
      vsTitle   := SUBSTR(vsTitulos,1, INSTR(vsTitulos,',') - 1);

      PK_ObjHTML.P_JavaTabsV2(psNames=>psNames);
      htp.p(
      '<script language="JavaScript"><!--
      setTime();
      //--></script>'
      );

  EXCEPTION
      WHEN OTHERS THEN
           htp.p(sqlerrm);
  END PWATABS;
/


DROP PUBLIC SYNONYM PWATABS;

CREATE PUBLIC SYNONYM PWATABS FOR BANINST1.PWATABS;
DROP PROCEDURE BANINST1.PWATCRM;

CREATE OR REPLACE PROCEDURE BANINST1.PWATCRM IS

/*

    TAREA: * Consulta de admiciones para alimentar la lectura del CRM
             y carga las diferencias.
    FECHA: 20/12/2010
    AUTOR: GEPC
   MODULO: GENERAL

*/

  vsError VARCHAR2(4000) := NULL;

  csEsp      CONSTANT VARCHAR2(1) := ' ';
  cs9999     CONSTANT VARCHAR2(4) := '9999';
  csSIMPLE   CONSTANT VARCHAR2(6) := 'SIMPLE';
  csDDMMYYYY CONSTANT VARCHAR2(8) := 'DDMMYYYY';

  BEGIN
      INSERT INTO SWRTCRM
      (
      SWRTCRM_SEQNC,                SWRTCRM_NAME_SUFFIX,          SWRTCRM_ID,                  SWRTCRM_PROGRAM_CODE,
      SWRTCRM_DATE_BANNER,          SWRTCRM_PSMA,                 SWRTCRM_PSLC,                SWRTCRM_PSCI,
      SWRTCRM_PSHC,                 SWRTCRM_NEM,                  SWRTCRM_PROG_SCORE,          SWRTCRM_PSU_SCORE,
      SWRTCRM_EXP_AUTPSU,           SWRTCRM_EXP_AUTCOL,           SWRTCRM_EXP_ESAR,            SWRTCRM_EXP_ESES,
      SWRTCRM_EXP_CONV,             SWRTCRM_EXP_DESC,             SWRTCRM_EXP_BHER,            SWRTCRM_EXP_BPAR,
      SWRTCRM_EXP_BASI,             SWRTCRM_EXP_BDEP,             SWRTCRM_STS_ADM,             SWRTCRM_DEC_ADM,
      SWRTCRM_DATE_FIN,             SWRTCRM_USER_FIN,             SWRTCRM_TERM_CODE,           SWRTCRM_SARHEAD_CODE,
      SWRTCRM_SARHEAD_APLS_CODE,    SWRTCRM_SARHEAD_ADD_DATE,     SWRTCRM_SARETRY_PRIORITY_NO, SWRTCRM_SARADDR_STREET_LINE1,
      SWRTCRM_SARADDR_STREET_LINE2, SWRTCRM_SARADDR_STREET_LINE3, SWRTCRM_SARADDR_CITY,        SWRTCRM_SARADDR_STAT_CDE,
      SWRTCRM_SARADDR_CNTY_CDE,     SWRTCRM_SARADDR_ZIP,          SWRTCRM_SARADDR_NATN_CDE,    SWRTCRM_SARPHON_PQLF_CDE1,
      SWRTCRM_SARPHON_PHONE1,       SWRTCRM_SARPHON_PQLF_CDE2,    SWRTCRM_SARPHON_PHONE2,      SWRTCRM_SARPHON_PQLF_CDE3,
      SWRTCRM_SARPHON_PHONE3,       SWRTCRM_SARPERS_FIRST_NAME,   SWRTCRM_SARPERS_LAST_NAME,   SWRTCRM_SARPERS_MIDDLE_NAME1,
      SWRTCRM_SARPERS_BIRTH_DTE,    SWRTCRM_SARPERS_GENDER,       SWRTCRM_SARPERS_CITZ_CDE,    SWRTCRM_SARHSCH_IDEN_CDE,
      SWRTCRM_SARHSCH_HSGR_DATE,    SWRTCRM_SARPCOL_IDEN_CDE,     SWRTCRM_SARRQST_ANSR_DESC,   SWRTCRM_SARRQST_ANSR_DESC2,
      SWRTCRM_ACTIVITY_DATE,        SWRTCRM_USER
      )
      SELECT
      FWASEQN,                      GWBTCRM_NAME_SUFFIX,          GWBTCRM_ID,                  GWBTCRM_PROGRAM_CODE,
      GWBTCRM_DATE_BANNER,          GWBTCRM_PSMA,                 GWBTCRM_PSLC,                GWBTCRM_PSCI,
      GWBTCRM_PSHC,                 GWBTCRM_NEM,                  GWBTCRM_PROG_SCORE,          GWBTCRM_PSU_SCORE,
      GWBTCRM_EXP_AUTPSU,           GWBTCRM_EXP_AUTCOL,           GWBTCRM_EXP_ESAR,            GWBTCRM_EXP_ESES,
      GWBTCRM_EXP_CONV,             GWBTCRM_EXP_DESC,             GWBTCRM_EXP_BHER,            GWBTCRM_EXP_BPAR,
      GWBTCRM_EXP_BASI,             GWBTCRM_EXP_BDEP,             GWBTCRM_STS_ADM,             GWBTCRM_DEC_ADM,
      GWBTCRM_DATE_FIN,             GWBTCRM_USER_FIN,             GWBTCRM_TERM_CODE,           GWBTCRM_SARHEAD_CODE,
      GWBTCRM_SARHEAD_APLS_CODE,    GWBTCRM_SARHEAD_ADD_DATE,     GWBTCRM_SARETRY_PRIORITY_NO, GWBTCRM_SARADDR_STREET_LINE1,
      GWBTCRM_SARADDR_STREET_LINE2, GWBTCRM_SARADDR_STREET_LINE3, GWBTCRM_SARADDR_CITY,        GWBTCRM_SARADDR_STAT_CDE,
      GWBTCRM_SARADDR_CNTY_CDE,     GWBTCRM_SARADDR_ZIP,          GWBTCRM_SARADDR_NATN_CDE,    GWBTCRM_SARPHON_PQLF_CDE1,
      GWBTCRM_SARPHON_PHONE1,       GWBTCRM_SARPHON_PQLF_CDE2,    GWBTCRM_SARPHON_PHONE2,      GWBTCRM_SARPHON_PQLF_CDE3,
      GWBTCRM_SARPHON_PHONE3,       GWBTCRM_SARPERS_FIRST_NAME,   GWBTCRM_SARPERS_LAST_NAME,   GWBTCRM_SARPERS_MIDDLE_NAME1,
      GWBTCRM_SARPERS_BIRTH_DTE,    GWBTCRM_SARPERS_GENDER,       GWBTCRM_SARPERS_CITZ_CDE,    GWBTCRM_SARHSCH_IDEN_CDE,
      GWBTCRM_SARHSCH_HSGR_DATE,    GWBTCRM_SARPCOL_IDEN_CDE,     GWBTCRM_SARRQST_ANSR_DESC,   GWBTCRM_SARRQST_ANSR_DESC2,
      GWBTCRM_ACTIVITY_DATE,        GWBTCRM_USER
       FROM GWBTCRM
      WHERE NOT EXISTS (SELECT NULL
                          FROM SWRTCRM
                         WHERE NVL(SWRTCRM_NAME_SUFFIX                          ,csEsp) = NVL(GWBTCRM_NAME_SUFFIX                            ,csEsp)
                           AND NVL(SWRTCRM_ID                                   ,csEsp) = NVL(GWBTCRM_ID                                     ,csEsp)
                           AND NVL(SWRTCRM_PROGRAM_CODE                         ,csEsp) = NVL(GWBTCRM_PROGRAM_CODE                           ,csEsp)
                           AND NVL(TO_CHAR(SWRTCRM_DATE_BANNER,csDDMMYYYY)      ,csEsp) = NVL(TO_CHAR(GWBTCRM_DATE_BANNER,csDDMMYYYY)        ,csEsp)
                           AND NVL(SWRTCRM_PSMA                                 ,csEsp) = NVL(GWBTCRM_PSMA                                   ,csEsp)
                           AND NVL(SWRTCRM_PSLC                                 ,csEsp) = NVL(GWBTCRM_PSLC                                   ,csEsp)
                           AND NVL(SWRTCRM_PSCI                                 ,csEsp) = NVL(GWBTCRM_PSCI                                   ,csEsp)
                           AND NVL(SWRTCRM_PSHC                                 ,csEsp) = NVL(GWBTCRM_PSHC                                   ,csEsp)
                           AND NVL(SWRTCRM_NEM                                  ,csEsp) = NVL(GWBTCRM_NEM                                    ,csEsp)
                           AND NVL(SWRTCRM_PROG_SCORE                           ,csEsp) = NVL(GWBTCRM_PROG_SCORE                             ,csEsp)
                           AND NVL(SWRTCRM_PSU_SCORE                            ,csEsp) = NVL(GWBTCRM_PSU_SCORE                              ,csEsp)
                           AND NVL(SWRTCRM_EXP_AUTPSU                           ,csEsp) = NVL(GWBTCRM_EXP_AUTPSU                             ,csEsp)
                           AND NVL(SWRTCRM_EXP_AUTCOL                           ,csEsp) = NVL(GWBTCRM_EXP_AUTCOL                             ,csEsp)
                           AND NVL(SWRTCRM_EXP_ESAR                             ,csEsp) = NVL(GWBTCRM_EXP_ESAR                               ,csEsp)
                           AND NVL(SWRTCRM_EXP_ESES                             ,csEsp) = NVL(GWBTCRM_EXP_ESES                               ,csEsp)
                           AND NVL(SWRTCRM_EXP_CONV                             ,csEsp) = NVL(GWBTCRM_EXP_CONV                               ,csEsp)
                           AND NVL(SWRTCRM_EXP_DESC                             ,csEsp) = NVL(GWBTCRM_EXP_DESC                               ,csEsp)
                           AND NVL(SWRTCRM_EXP_BHER                             ,csEsp) = NVL(GWBTCRM_EXP_BHER                               ,csEsp)
                           AND NVL(SWRTCRM_EXP_BPAR                             ,csEsp) = NVL(GWBTCRM_EXP_BPAR                               ,csEsp)
                           AND NVL(SWRTCRM_EXP_BASI                             ,csEsp) = NVL(GWBTCRM_EXP_BASI                               ,csEsp)
                           AND NVL(SWRTCRM_EXP_BDEP                             ,csEsp) = NVL(GWBTCRM_EXP_BDEP                               ,csEsp)
                           AND NVL(SWRTCRM_STS_ADM                              ,csEsp) = NVL(GWBTCRM_STS_ADM                                ,csEsp)
                           AND NVL(SWRTCRM_DEC_ADM                              ,csEsp) = NVL(GWBTCRM_DEC_ADM                                ,csEsp)
                           AND NVL(TO_CHAR(SWRTCRM_DATE_FIN,csDDMMYYYY)         ,csEsp) = NVL(TO_CHAR(GWBTCRM_DATE_FIN,csDDMMYYYY)           ,csEsp)
                           AND NVL(SWRTCRM_USER_FIN                             ,csEsp) = NVL(GWBTCRM_USER_FIN                               ,csEsp)
                           AND NVL(SWRTCRM_TERM_CODE                            ,csEsp) = NVL(GWBTCRM_TERM_CODE                              ,csEsp)
                           AND NVL(SWRTCRM_SARHEAD_CODE                         ,csEsp) = NVL(GWBTCRM_SARHEAD_CODE                           ,csEsp)
                           AND NVL(SWRTCRM_SARHEAD_APLS_CODE                    ,csEsp) = NVL(GWBTCRM_SARHEAD_APLS_CODE                      ,csEsp)
                           AND NVL(TO_CHAR(SWRTCRM_SARHEAD_ADD_DATE,csDDMMYYYY) ,csEsp) = NVL(TO_CHAR(GWBTCRM_SARHEAD_ADD_DATE,csDDMMYYYY)   ,csEsp)
                           AND NVL(TO_CHAR(SWRTCRM_SARETRY_PRIORITY_NO,cs9999)  ,csEsp) = NVL(TO_CHAR(GWBTCRM_SARETRY_PRIORITY_NO,cs9999)    ,csEsp)
                           AND NVL(SWRTCRM_SARADDR_STREET_LINE1                 ,csEsp) = NVL(GWBTCRM_SARADDR_STREET_LINE1                   ,csEsp)
                           AND NVL(SWRTCRM_SARADDR_STREET_LINE2                 ,csEsp) = NVL(GWBTCRM_SARADDR_STREET_LINE2                   ,csEsp)
                           AND NVL(SWRTCRM_SARADDR_STREET_LINE3                 ,csEsp) = NVL(GWBTCRM_SARADDR_STREET_LINE3                   ,csEsp)
                           AND NVL(SWRTCRM_SARADDR_CITY                         ,csEsp) = NVL(GWBTCRM_SARADDR_CITY                           ,csEsp)
                           AND NVL(SWRTCRM_SARADDR_STAT_CDE                     ,csEsp) = NVL(GWBTCRM_SARADDR_STAT_CDE                       ,csEsp)
                           AND NVL(SWRTCRM_SARADDR_CNTY_CDE                     ,csEsp) = NVL(GWBTCRM_SARADDR_CNTY_CDE                       ,csEsp)
                           AND NVL(SWRTCRM_SARADDR_ZIP                          ,csEsp) = NVL(GWBTCRM_SARADDR_ZIP                            ,csEsp)
                           AND NVL(SWRTCRM_SARADDR_NATN_CDE                     ,csEsp) = NVL(GWBTCRM_SARADDR_NATN_CDE                       ,csEsp)
                           AND NVL(SWRTCRM_SARPHON_PQLF_CDE1                    ,csEsp) = NVL(GWBTCRM_SARPHON_PQLF_CDE1                      ,csEsp)
                           AND NVL(SWRTCRM_SARPHON_PHONE1                       ,csEsp) = NVL(GWBTCRM_SARPHON_PHONE1                         ,csEsp)
                           AND NVL(SWRTCRM_SARPHON_PQLF_CDE2                    ,csEsp) = NVL(GWBTCRM_SARPHON_PQLF_CDE2                      ,csEsp)
                           AND NVL(SWRTCRM_SARPHON_PHONE2                       ,csEsp) = NVL(GWBTCRM_SARPHON_PHONE2                         ,csEsp)
                           AND NVL(SWRTCRM_SARPHON_PQLF_CDE3                    ,csEsp) = NVL(GWBTCRM_SARPHON_PQLF_CDE3                      ,csEsp)
                           AND NVL(SWRTCRM_SARPHON_PHONE3                       ,csEsp) = NVL(GWBTCRM_SARPHON_PHONE3                         ,csEsp)
                           AND NVL(SWRTCRM_SARPERS_FIRST_NAME                   ,csEsp) = NVL(GWBTCRM_SARPERS_FIRST_NAME                     ,csEsp)
                           AND NVL(SWRTCRM_SARPERS_LAST_NAME                    ,csEsp) = NVL(GWBTCRM_SARPERS_LAST_NAME                      ,csEsp)
                           AND NVL(SWRTCRM_SARPERS_MIDDLE_NAME1                 ,csEsp) = NVL(GWBTCRM_SARPERS_MIDDLE_NAME1                   ,csEsp)
                           AND NVL(TO_CHAR(SWRTCRM_SARPERS_BIRTH_DTE,csDDMMYYYY),csEsp) = NVL(TO_CHAR(GWBTCRM_SARPERS_BIRTH_DTE,csDDMMYYYY)  ,csEsp)
                           AND NVL(SWRTCRM_SARPERS_GENDER                       ,csEsp) = NVL(GWBTCRM_SARPERS_GENDER                         ,csEsp)
                           AND NVL(SWRTCRM_SARPERS_CITZ_CDE                     ,csEsp) = NVL(GWBTCRM_SARPERS_CITZ_CDE                       ,csEsp)
                           AND NVL(SWRTCRM_SARHSCH_IDEN_CDE                     ,csEsp) = NVL(GWBTCRM_SARHSCH_IDEN_CDE                       ,csEsp)
                           AND NVL(SWRTCRM_SARHSCH_HSGR_DATE                    ,csEsp) = NVL(GWBTCRM_SARHSCH_HSGR_DATE                      ,csEsp)
                           AND NVL(SWRTCRM_SARPCOL_IDEN_CDE                     ,csEsp) = NVL(GWBTCRM_SARPCOL_IDEN_CDE                       ,csEsp)
                           AND NVL(SWRTCRM_SARRQST_ANSR_DESC                    ,csEsp) = NVL(GWBTCRM_SARRQST_ANSR_DESC                      ,csEsp)
                           AND NVL(SWRTCRM_SARRQST_ANSR_DESC2                   ,csEsp) = NVL(GWBTCRM_SARRQST_ANSR_DESC2                     ,csEsp)
                       )
      ORDER BY GWBTCRM_NAME_SUFFIX;

  EXCEPTION
      WHEN OTHERS THEN
           vsError := SQLERRM;

           ROLLBACK;

           INSERT INTO GWRERRM(GWRERRM_ERROR,GWRERRM_ORIGIN) VALUES(vsError, csSIMPLE);

           COMMIT;
  END PWATCRM;
/
DROP PROCEDURE BANINST1.PWAUREN;

CREATE OR REPLACE PROCEDURE BANINST1.PWAUREN (psReclDesc VARCHAR2)
IS
/******************************************************************************
PROCEDIMIENTO:          BANINST1.PWAUREN
OBJETIVO:               Reporte Auditoria Rendimiento
AUTORES:                Guillermo Almazan Ibaez
FECHA:                  27/12/2010
******************************************************************************/
   vnRow         INTEGER := 0;
   vnExists      INTEGER := 0;
   vnColumnas    INTEGER := 33;
   vsProg       smrprle.smrprle_program_desc%TYPE;
   vsVia        stvstst.stvstst_code%TYPE;
   vsTyAl       stvstyp.stvstyp_code%TYPE;
   vsPerio      stvterm.stvterm_code%TYPE;
   vsCont       twbcntr.twbcntr_num%TYPE;
   vsPidm       TWRCRAL.TWRCRAL_PIDM%TYPE;
   tabColumna   Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla (1);
   vsInicioPag   VARCHAR2 (10) := NULL;
CURSOR cuABCDE (vsProg in smrprle.smrprle_program_desc%TYPE,
						  vsVia in stvstst.stvstst_code%TYPE,
						  vsType in stvstyp.stvstyp_code%TYPE,
						  vsPerio in stvterm.stvterm_code%TYPE,
						  vsCont in twbcntr.twbcntr_num%TYPE)
  IS
  select a.pidm
	   , a.anio
	   , a.contrato
	   , a.fecha
	   , a.id
	   , a.rut_al
	   , a.alumno
	   , a.lenguaje
	   , a.matematicas
	   , a.ciencias
	   , a.sociales
	   , a.nem
	   , a.ponderado
	   , a.periodo_in
	   , a.tipo
	   , a.via
	   , a.programa
	   , a.prog_desc
	   , sum(b.por) bec_prom_por,   to_char(sum(b.monto), pk_contrato.ConstglFormato) bec_prom_monto
	   , sum(c.por) bec_ori_por,    to_char(sum(c.monto), pk_contrato.ConstglFormato) bec_ori_monto
	   , sum(d.por) bec_depo_por,   to_char(sum(d.monto), pk_contrato.ConstglFormato) bec_depo_monto
	   , sum(i.por) bec_psu_por,    to_char(sum(i.monto), pk_contrato.ConstglFormato) bec_psu_monto
	   , sum(e.por) bec_descon_por, to_char(sum(e.monto), pk_contrato.ConstglFormato) bec_descon_monto
	   , sum(f.por) cre_uft_por,    to_char(sum(f.monto), pk_contrato.ConstglFormato) cre_uft_monto
	   , sum(g.por) cre_cae_por,    to_char(sum(g.monto), pk_contrato.ConstglFormato) cre_cae_monto
	   , sum(h.por) cre_min_por,    to_char(sum(h.monto), pk_contrato.ConstglFormato) cre_min_monto
  from (select twbcntr_pidm                                                                               pidm
			 , substr(twbcntr_term_code, 1,4)                                                             anio
			 --, to_char(twbcntr_issue_date, 'yyyy')                                                        anio
			 , twbcntr_num                                                                                contrato
			 , twbcntr_term_code                                                                          periodo
			 , twbcntr_issue_date                                                                         fecha
			 , f_get_id(twbcntr_pidm)                                                                     id
			 , f_get_rut(twbcntr_pidm)                                                                    rut_al
			 , f_get_nombre(twbcntr_pidm)                                                                 alumno
			 , pk_AdMat.f_get_PSU(twbcntr_pidm, 'PSLC')                                               lenguaje
			 , pk_AdMat.f_get_PSU(twbcntr_pidm, 'PSMA')                                               matematicas
			 , pk_AdMat.f_get_PSU(twbcntr_pidm, 'PSCI')                                               ciencias
			 , pk_AdMat.f_get_PSU(twbcntr_pidm, 'PSHC')                                               sociales
			 , pk_AdMat.f_get_PSU(twbcntr_pidm, 'NEME')                                               nem
			 , pk_AdMat.f_get_PSU_pond(twbcntr_pidm, twbcntr_term_code)                               ponderado
			 , g1.sgbstdn_term_code_admit                                                                 periodo_in_code
			 , stvterm_desc                                                                               periodo_in
			 , fwatyaluft(twbcntr_pidm, twbcntr_term_code)                                            tipo_code
			 , decode(fwatyaluft(twbcntr_pidm, twbcntr_term_code),'N','Nuevo Ingreso','A','Avanzado') tipo
			 , stvadmt_code                                                                               via_code
			 , stvadmt_desc                                                                               via
			 , f_get_programa(twbcntr_pidm, twbcntr_term_code)                                            programa
			 , pk_catalogo.Programa(f_get_programa(twbcntr_pidm, twbcntr_term_code))                      prog_desc
		from twbcntr
		   , sgbstdn g1
		   , stvterm
		   , stvstyp
		   , stvadmt
		where sgbstdn_pidm = twbcntr_pidm
		  and g1.sgbstdn_term_code_admit = stvterm_code(+)
		  and g1.sgbstdn_styp_code = stvstyp_code(+)
		  and g1.sgbstdn_admt_code = stvadmt_code(+)
		  and g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
										  from sgbstdn g2
										  where g1.sgbstdn_pidm = g2.sgbstdn_pidm
											and g2.sgbstdn_term_code_eff <= twbcntr_term_code)
          and not exists (select 1
                          from twbretr
                          where twbretr_cntr_num = twbcntr_num))A,
	   (SELECT TBBESTU_PIDM pidm, TBBESTU_EXEMPTION_CODE BECA, TBBEXPT_DESC DESCR, TBBESTU_TERM_CODE PER, max(TBREDET_PERCENT) POR, SUM(TWBDOCU_AMOUNT) MONTO
		FROM TBBESTU, TBBEXPT, tbredet, twbdocu
		WHERE TBBEXPT_EXEMPTION_CODE = TBBESTU_EXEMPTION_CODE
		  and TBBEXPT_TERM_CODE = TBBESTU_TERM_CODE
		  AND TBBESTU_DEL_IND IS NULL
		  AND TBBESTU_TERM_CODE = TBREDET_TERM_CODE
		  AND TBBESTU_EXEMPTION_CODE = TBREDET_EXEMPTION_CODE
		  AND TWBDOCU_PAYM_CODE(+) = 'BEC'
		  AND TWBDOCU_DOCU_NUM(+) = TBBESTU_EXEMPTION_CODE
		  AND TBBESTU_EXEMPTION_CODE LIKE '1122%'
		group by TBBESTU_PIDM, TBBESTU_TERM_CODE, TBBESTU_EXEMPTION_CODE, TBBEXPT_DESC)B,
	/*****PSU*****/
	 (SELECT TBBESTU_PIDM pidm, TBBESTU_EXEMPTION_CODE BECA, TBBEXPT_DESC DESCR, TBBESTU_TERM_CODE PER, max(TBREDET_PERCENT) POR, SUM(TWBDOCU_AMOUNT) MONTO
	  FROM TBBESTU, TBBEXPT, tbredet, twbdocu
	  WHERE TBBEXPT_EXEMPTION_CODE = TBBESTU_EXEMPTION_CODE
		and TBBEXPT_TERM_CODE = TBBESTU_TERM_CODE
		AND TBBESTU_DEL_IND IS NULL
		AND TBBESTU_TERM_CODE = TBREDET_TERM_CODE
		AND TBBESTU_EXEMPTION_CODE = TBREDET_EXEMPTION_CODE
		AND TWBDOCU_PAYM_CODE(+) = 'BEC'
		AND TWBDOCU_DOCU_NUM(+) = TBBESTU_EXEMPTION_CODE
		AND TBBESTU_EXEMPTION_CODE LIKE '1111%'
	  group by TBBESTU_PIDM, TBBESTU_TERM_CODE, TBBESTU_EXEMPTION_CODE, TBBEXPT_DESC)I,
	/*****Origen*****/
	 (SELECT TBBESTU_PIDM pidm, TBBESTU_EXEMPTION_CODE BECA, TBBEXPT_DESC DESCR, TBBESTU_TERM_CODE PER, max(TBREDET_PERCENT) POR, SUM(TWBDOCU_AMOUNT) MONTO
	  FROM TBBESTU, TBBEXPT, tbredet, twbdocu
	  WHERE TBBEXPT_EXEMPTION_CODE = TBBESTU_EXEMPTION_CODE
		and TBBEXPT_TERM_CODE = TBBESTU_TERM_CODE
		AND TBBESTU_DEL_IND IS NULL
		AND TBBESTU_TERM_CODE = TBREDET_TERM_CODE
		AND TBBESTU_EXEMPTION_CODE = TBREDET_EXEMPTION_CODE
		AND TWBDOCU_PAYM_CODE(+) = 'BEC'
		AND TWBDOCU_DOCU_NUM(+) = TBBESTU_EXEMPTION_CODE
		AND TBBESTU_EXEMPTION_CODE LIKE '44%'
	  group by TBBESTU_PIDM, TBBESTU_TERM_CODE, TBBESTU_EXEMPTION_CODE, TBBEXPT_DESC)C,
	/*****Deportiva*****/
	 (SELECT TBBESTU_PIDM pidm, TBBESTU_EXEMPTION_CODE BECA, TBBEXPT_DESC DESCR, TBBESTU_TERM_CODE PER, max(TBREDET_PERCENT) POR, SUM(TWBDOCU_AMOUNT) MONTO
	  FROM TBBESTU, TBBEXPT, tbredet, twbdocu
	  WHERE TBBEXPT_EXEMPTION_CODE = TBBESTU_EXEMPTION_CODE
		and TBBEXPT_TERM_CODE = TBBESTU_TERM_CODE
		AND TBBESTU_DEL_IND IS NULL
		AND TBBESTU_TERM_CODE = TBREDET_TERM_CODE
		AND TBBESTU_EXEMPTION_CODE = TBREDET_EXEMPTION_CODE
		AND TWBDOCU_PAYM_CODE(+) = 'BEC'
		AND TWBDOCU_DOCU_NUM(+) = TBBESTU_EXEMPTION_CODE
		AND TBBESTU_EXEMPTION_CODE LIKE '2222%'
	  group by TBBESTU_PIDM, TBBESTU_TERM_CODE, TBBESTU_EXEMPTION_CODE, TBBEXPT_DESC)D,
	/*****Descuentos/Convenios*****/
	 (SELECT TBBESTU_PIDM pidm, TBBESTU_EXEMPTION_CODE BECA, TBBEXPT_DESC DESCR, TBBESTU_TERM_CODE PER, max(TBREDET_PERCENT) POR, SUM(TWBDOCU_AMOUNT) MONTO
	  FROM TBBESTU, TBBEXPT, tbredet, twbdocu
	  WHERE TBBEXPT_EXEMPTION_CODE = TBBESTU_EXEMPTION_CODE
		and TBBEXPT_TERM_CODE = TBBESTU_TERM_CODE
		AND TBBESTU_DEL_IND IS NULL
		AND TBBESTU_TERM_CODE = TBREDET_TERM_CODE
		AND TBBESTU_EXEMPTION_CODE = TBREDET_EXEMPTION_CODE
		AND TWBDOCU_PAYM_CODE(+) = 'BEC'
		AND TWBDOCU_DOCU_NUM(+) = TBBESTU_EXEMPTION_CODE
		AND (TBBESTU_EXEMPTION_CODE LIKE '88%' or TBBESTU_EXEMPTION_CODE LIKE '99%')
	  group by TBBESTU_PIDM, TBBESTU_TERM_CODE, TBBESTU_EXEMPTION_CODE, TBBEXPT_DESC)E,
	/*****Credito UFT*****/
--     (select TWBCRED_CREDIT_CODE credit, TWRALCR_TERM_CODE per, TWRCRPE_PROGRAM prog, TWRALCR_PIDM pidm, TWRCRPE_AMOUNT monto, TWRCRPE_PERCENTAGE por, TWRALCR_STATUS_IND stat
--      from TWBCRED, TWRCRPE, TWRALCR
--      where TWRCRPE_CREDIT_CODE(+) = TWBCRED_CREDIT_CODE
--        and TWRALCR_TERM_CODE(+) = TWRCRPE_TERM_CODE
--        and TWRALCR_PROGRAM = TWRCRPE_PROGRAM
--        and TWRALCR_CREDIT_CODE = TWBCRED_CREDIT_CODE
--        and TWBCRED_CREDIT_CODE = 'CUFT'
--        and TWRALCR_STATUS_IND = 'A')F,
	 (select 'CUFT_'||TWRCUFT_NUM credit, TWRCUFT_TERM_CODE per, f_get_programa(TWRCUFT_PIDM, TWRCUFT_TERM_CODE)prog, TWRCUFT_PIDM pidm,
			   pk_MatCreUFT.f_montocobercred(TWRCUFT_NUM) monto, TWRCUFT_PERCENT por, decode(TWRCUFT_DOCU_SEQ_NUM, null, null,'A') stat
		from TWRCUFT
		where TWRCUFT_DOCU_SEQ_NUM is not null)F,
	/*****Credito CCAE*****/
--     (select TWBCRED_CREDIT_CODE credit, TWRALCR_TERM_CODE per, TWRCRPE_PROGRAM prog, TWRALCR_PIDM pidm, TWRCRPE_AMOUNT monto, TWRCRPE_PERCENTAGE por, TWRALCR_STATUS_IND stat
--      from TWBCRED, TWRCRPE, TWRALCR
--      where TWRCRPE_CREDIT_CODE(+) = TWBCRED_CREDIT_CODE
--        and TWRALCR_TERM_CODE(+) = TWRCRPE_TERM_CODE
--        and TWRALCR_PROGRAM = TWRCRPE_PROGRAM
--        and TWRALCR_CREDIT_CODE = TWBCRED_CREDIT_CODE
--        and TWBCRED_CREDIT_CODE = 'CCAE'
--        and TWRALCR_STATUS_IND = 'A')G,
	   (select TWVCRET_CODE credit, TWRCRAL_TERM_CODE per, f_sgbstdn_fields(TWRCRAL_PIDM, TWRCRAL_TERM_CODE, 'MAJOR_1') prog, TWRCRAL_PIDM pidm, TWBCRET_AMOUNT monto, null por, decode(TWRCRAL_DOCU_SEQ_NUM, null, null,'A') stat
		from TWVCRET, TWBCRET, TWRCRAL
		where TWBCRET_CODE = TWVCRET_CODE
		  and TWRCRAL_TERM_CODE = TWBCRET_TERM_CODE
		  and TWRCRAL_MAJR_CODE = TWBCRET_MAJR_CODE
		  and TWRCRAL_CRET_CODE = TWBCRET_CODE
		  and TWVCRET_CODE = 'CAE'
		  and TWRCRAL_DOCU_SEQ_NUM is not null)G,
	/*****Beca del Ministerio*****/
--     (select TWBCRED_CREDIT_CODE credit, TWRALCR_TERM_CODE per, TWRCRPE_PROGRAM prog, TWRALCR_PIDM pidm, TWRCRPE_AMOUNT monto, TWRCRPE_PERCENTAGE por, TWRALCR_STATUS_IND stat
--      from TWBCRED, TWRCRPE, TWRALCR
--      where TWRCRPE_CREDIT_CODE(+) = TWBCRED_CREDIT_CODE
--        and TWRALCR_TERM_CODE(+) = TWRCRPE_TERM_CODE
--        and TWRALCR_PROGRAM = TWRCRPE_PROGRAM
--        and TWRALCR_CREDIT_CODE = TWBCRED_CREDIT_CODE
--        and TWBCRED_CREDIT_CODE = 'BMIN'
--        and TWRALCR_STATUS_IND = 'A')H
	   (select TWVCRET_CODE credit, TWRCRAL_TERM_CODE per, f_sgbstdn_fields(TWRCRAL_PIDM, TWRCRAL_TERM_CODE, 'MAJOR_1') prog, TWRCRAL_PIDM pidm, TWBCRET_AMOUNT monto, null por, decode(TWRCRAL_DOCU_SEQ_NUM, null, null,'A') stat
		from TWVCRET, TWBCRET, TWRCRAL
		where TWBCRET_CODE = TWVCRET_CODE
		  and TWRCRAL_TERM_CODE = TWBCRET_TERM_CODE
		  and TWRCRAL_MAJR_CODE = TWBCRET_MAJR_CODE
		  and TWRCRAL_CRET_CODE = TWBCRET_CODE
		  and TWVCRET_CODE = 'BMIN'
		  and TWRCRAL_DOCU_SEQ_NUM is not null)H
where b.pidm(+) = a.pidm
	and c.pidm(+) = a.pidm
	and d.pidm(+) = a.pidm
	and e.pidm(+) = a.pidm
	and f.pidm(+) = a.pidm
	and g.pidm(+) = a.pidm
	and h.pidm(+) = a.pidm
	and i.pidm(+) = a.pidm
	and (a.programa = vsProg or vsProg is null)
	and (a.via_code = vsVia or vsVia is null)
	and (a.tipo_code = vsTyAl or vsTyAl is null)
	and (a.periodo_in_code = vsPerio or vsPerio is null)
	and (a.contrato = vsCont or vsCont is null)
group by a.pidm
	   , a.anio
	   , a.contrato
	   , a.fecha
	   , a.id
	   , a.rut_al
	   , a.alumno
	   , a.lenguaje
	   , a.matematicas
	   , a.ciencias
	   , a.sociales
	   , a.nem
	   , a.ponderado
	   , a.periodo_in
	   , a.tipo
	   , a.via
	   , a.programa
	   , a.prog_desc
order by id;

BEGIN

   IF Pk_Login.F_ValidacionDeAcceso (pk_login.vgsUSR)
   THEN
	  RETURN;
   END IF;

	/* Parmetros */
	--Se busca el valor de la cookie (parmetro) para asignarlo al filtro del query.
	vsProg  := pk_ObjHtml.getValueCookie ('psProgr');
	vsVia  := pk_ObjHtml.getValueCookie ('psVia');
	vsTyAl   := pk_ObjHtml.getValueCookie ('psTiPo');
	vsPerio   := pk_ObjHtml.getValueCookie ('psPerio');
	vsCont   := pk_ObjHtml.getValueCookie ('psCont');

  -- Nmero de columnas de la tabla --
   FOR vnI IN 1 .. vnColumnas
   LOOP
	  tabColumna.EXTEND (vnI);
	  tabColumna (vnI) := NULL;
   END LOOP;

   /* Encabezado de las columnas */
   tabColumna (1) := 'Ao';
   tabColumna (2) := 'Contrato';
   tabColumna (3) := 'Fecha Contrato';
   tabColumna (4) := 'Id Alumno';
   tabColumna (5) := 'Rut Alumno';
   tabColumna (6) := 'Alumno';
   tabColumna (7) := 'PSU Lenguaje';
   tabColumna (8) := 'PSU Matemticas';
   tabColumna (9) := 'PSU Ciencias';
   tabColumna (10) := 'PSU Sociales';
   tabColumna (11) := 'NEM';
   tabColumna (12) := 'PSU Ponderado';
   tabColumna (13) := 'Periodo Admisin';
   tabColumna (14) := 'Tipo Alumno';
   tabColumna (15) := 'Va';
   tabColumna (16) := 'Programa';
   tabColumna (17) := 'Descripcin Programa';
   tabColumna (18) := 'Porcentaje Beca Promocional';
   tabColumna (19) := 'Monto Beca Promocional';
   tabColumna (20) := 'Porcentaje Beca Origen';
   tabColumna (21) := 'Monto Beca Origen';
   tabColumna (22) := 'Porcentaje Beca Deportiva';
   tabColumna (23) := 'Monto Beca Deportiva';
   tabColumna (24) := 'Porcentaje Beca PSU';
   tabColumna (25) := 'Monto Beca PSU';
   tabColumna (26) := 'Porcentaje Descuentos /Convenios';
   tabColumna (27) := 'Monto Descuentos /Convenios';
   tabColumna (28) := 'Porcentaje Crdito UFT';
   tabColumna (29) := 'Monto Crdito UFT';
   tabColumna (30) := 'Porcentaje Crdito CAE';
   tabColumna (31) := 'Monto Crdito CAE';
   tabColumna (32) := 'Porcentaje Beca Ministerio';
   tabColumna (33) := 'Monto Beca Ministerio';

	  FOR regRep IN cuABCDE(vsProg, vsVia, vsTyAl, vsPerio, vsCont) LOOP
		  IF vnRow = 0 THEN
			 Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag);
			 vsInicioPag := 'SALTO';
			 vnRow  := 0;
		  END IF;


		  htp.p(
		  '<tr>
		  <td valign="top">'||regRep.anio||'</td>
		  <td valign="top">'||regRep.contrato||'</td>
		  <td valign="top">'||regRep.fecha||'</td>
		  <td valign="top">'||regRep.id||'</td>
		  <td valign="top">'||regRep.rut_al||'</td>
		  <td valign="top">'||regRep.alumno||'</td>
		  <td valign="top">'||regRep.lenguaje||'</td>
		  <td valign="top">'||regRep.matematicas||'</td>
		  <td valign="top">'||regRep.ciencias||'</td>
		  <td valign="top">'||regRep.sociales||'</td>
		  <td valign="top">'||regRep.nem||'</td>
		  <td valign="top">'||regRep.ponderado||'</td>
		  <td valign="top">'||regRep.periodo_in||'</td>
		  <td valign="top">'||regRep.tipo||'</td>
		  <td valign="top">'||regRep.via||'</td>
		  <td valign="top">'||regRep.programa||'</td>
		  <td valign="top">'||regRep.prog_desc||'</td>
		  <td valign="top">'||regRep.bec_prom_por||'</td>
		  <td valign="top">'||regRep.bec_prom_monto||'</td>
		  <td valign="top">'||regRep.bec_ori_por||'</td>
		  <td valign="top">'||regRep.bec_ori_monto||'</td>
		  <td valign="top">'||regRep.bec_depo_por||'</td>
		  <td valign="top">'||regRep.bec_depo_monto||'</td>
		  <td valign="top">'||regRep.bec_psu_por||'</td>
		  <td valign="top">'||regRep.bec_psu_monto||'</td>
		  <td valign="top">'||regRep.bec_descon_por||'</td>
		  <td valign="top">'||regRep.bec_descon_monto||'</td>
		  <td valign="top">'||regRep.cre_uft_por||'</td>
		  <td valign="top">'||regRep.cre_uft_monto||'</td>
		  <td valign="top">'||regRep.cre_cae_por||'</td>
		  <td valign="top">'||regRep.cre_cae_monto||'</td>
		  <td valign="top">'||regRep.cre_min_por||'</td>
		  <td valign="top">'||regRep.cre_min_monto||'</td>');

		  vnExists   := 1;
		  vnRow      := vnRow + 1;
	  END LOOP;

   IF vnExists = 0
   THEN
	  HTP.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
	  -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
	  Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

	  -- es omitido el encabezado del reporte pero se agrega el salto de pagina
	  Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
   END IF;

   HTP.p ('</table><br/></body></html>');
EXCEPTION
   WHEN OTHERS
   THEN
	  HTP.P (SQLERRM);
END PWAUREN;
/


DROP PUBLIC SYNONYM PWAUREN;

CREATE PUBLIC SYNONYM PWAUREN FOR BANINST1.PWAUREN;


GRANT EXECUTE ON BANINST1.PWAUREN TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWAUREN TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWAUREN TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWAUREN TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWAUREN TO WWW2_USER;
DROP PROCEDURE BANINST1.PWCCSXM;

CREATE OR REPLACE PROCEDURE BANINST1.PWCCSXM (psReclDesc VARCHAR2)
IS

  --Esto es autoria de Guillermo Almazan Ibaez, por si alguien pregunta

  --GVH: 2012 06 27, cambie el query con la nueva logica de banderas de estados
  --y se corrigi

   vnRow         INTEGER := 0;
   vnExists      INTEGER := 0;
   vnColumnas    INTEGER := 7;
   vsFecha       twrccas.twrccas_date%type;
   vsCtecs       twrccas.twrccas_num%type;
   tabColumna   Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla (1);
   vsInicioPag   VARCHAR2 (10) := NULL;
CURSOR cuCCSXM (vsFecha in twrccas.twrccas_date%type,
                vsCtecs in twrccas.twrccas_num%type)
  IS
SELECT
	TWRCCAM_CCAS_NUM ccg
	,TO_CHAR (twrccam_date, 'DD/MM/YYYY HH24:MI:SS') fecha_ccg
	,NVL(guriden_desc, TWRCCAM_CCAM_USER) matriculador
	,twrccam_num ccm
	,TO_CHAR (twrccam_date, 'DD/MM/YYYY HH24:MI:SS') fecha_ccm
	,COUNT(TWBDOCU_SEQ_NUM) documentos
	,SUM(TWBDOCU_NOM_AMOUNT) monto
FROM
	TWRCCAM
	,TWRCCMD
	,TWBDOCU
	,TWVPAYM
	,GURIDEN
WHERE
	TWRCCMD_CCAM_USER = TWRCCAM_CCAM_USER
	AND TWRCCMD_CCAM_NUM = TWRCCAM_NUM
	AND TWBDOCU_SEQ_NUM = TWRCCMD_DOCU_SEQ_NUM
	AND TWVPAYM_CODE = TWBDOCU_PAYM_CODE
	AND TWVPAYM_ONLINE_IND = 'Y'
	AND TWVPAYM_USER_VIEWABLE_IND = 'Y'
	AND pk_Matricula.f_GetBanStQ('PAGADO',TWBDOCU_STATUS_IND) = 'Y'
	AND GURIDEN_USER_ID(+) = TWRCCAM_CCAM_USER
	AND (TRUNC (twrccam_date) = vsFecha OR vsFecha IS NULL)
	AND (twrccam_ccas_num = vsCtecs OR vsCtecs IS NULL)
GROUP BY
	TWRCCAM_CCAS_NUM
	,TO_CHAR (twrccam_date, 'DD/MM/YYYY HH24:MI:SS')
	,NVL(guriden_desc, TWRCCAM_CCAM_USER)
	,twrccam_num
	,TO_CHAR (twrccam_date, 'DD/MM/YYYY HH24:MI:SS');

BEGIN

   IF Pk_Login.F_ValidacionDeAcceso (pk_login.vgsUSR)
   THEN
      RETURN;
   END IF;

    /* Parmetros */
    --Se busca el valor de la cookie (parmetro) para asignarlo al filtro del query.
    vsFecha := pk_ObjHtml.getValueCookie ('pdIni');
    vsCtecs := pk_ObjHtml.getValueCookie ('psCont');

  -- Nmero de columnas de la tabla --
   FOR vnI IN 1 .. vnColumnas
   LOOP
      tabColumna.EXTEND (vnI);
      tabColumna (vnI) := NULL;
   END LOOP;

   /* Encabezado de las columnas */

   tabColumna (1) := 'Corte Caja Sup';
   tabColumna (2) := 'Fecha Corte Caja Sup';
   tabColumna (3) := 'Matriculador';
   tabColumna (4) := 'Corte Caja Mat';
   tabColumna (5) := 'Fecha Corte Caja Mat';
   tabColumna (6) := 'Total de Documentos';
   tabColumna (7) := 'Monto del Corte';

      FOR regRep IN cuCCSXM(vsFecha, vsCtecs) LOOP
          IF 70 = vnRow OR 0 = vnRow THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag);
             vsInicioPag := 'SALTO';
             vnRow  := 0;
          END IF;

          htp.p(
          '<tr>
          <td valign="top">'||regRep.ccg||'</td>
          <td valign="top">'||regRep.fecha_ccg||'</td>
          <td valign="top">'||regRep.matriculador||'</td>
          <td valign="top">'||regRep.ccm||'</td>
          <td valign="top">'||regRep.fecha_ccm||'</td>
          <td valign="top">'||regRep.documentos||'</td>
          <td valign="top">'||regRep.monto||'</td>');

          vnExists   := 1;
          vnRow      := vnRow + 1;
      END LOOP;

   IF vnExists = 0
   THEN
      HTP.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- es omitido el encabezado del reporte pero se agrega el salto de pagina
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
   END IF;

   HTP.p ('</table><br/></body></html>');
EXCEPTION
   WHEN OTHERS
   THEN
      HTP.P (SQLERRM);
END PWCCSXM;
/


DROP PUBLIC SYNONYM PWCCSXM;

CREATE PUBLIC SYNONYM PWCCSXM FOR BANINST1.PWCCSXM;


GRANT EXECUTE ON BANINST1.PWCCSXM TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWCCSXM TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWCCSXM TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWCCSXM TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWCCSXM TO WWW2_USER;
DROP PROCEDURE BANINST1.PWCLADO;

CREATE OR REPLACE PROCEDURE BANINST1.PWCLADO (psReclDesc VARCHAR2)
IS
/******************************************************************************
PROCEDIMIENTO:          BANINST1.PWCLADO
OBJETIVO:               Reporte de Clasificacin de Documentos
AUTORES:                Guillermo Almazan Ibaez
FECHA:                  10/12/2010
******************************************************************************/
/****************************************************************
modificacion :          md-01 se elimina la columna programa y se agrega estado del documento
autor        :          Virgilio De la Cruz
fecha        :          20130903
******************************************************************************/
   vnRow         INTEGER := 0;
   vnExists      INTEGER := 0;
   vnColumnas    INTEGER := 18;
   vsProg       smrprle.smrprle_program_desc%TYPE;
   vsType       stvstyp.stvstyp_code%TYPE;
   vsYear       VARCHAR2(4);
   vdIni        twbcntr.twbcntr_issue_date%TYPE;
   vdFin        twbcntr.twbcntr_issue_date%TYPE;
   vsCont       twbcntr.twbcntr_num%TYPE;
   vsPago       twvpaym.twvpaym_code%TYPE;
   vsTaDo       twbdocu.twbdocu_status_ind%TYPE;
   tabColumna   Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla (1);
   vsInicioPag   VARCHAR2 (10) := NULL;
CURSOR cuReporte_Cambio (vsProg in smrprle.smrprle_program_desc%TYPE,
						 vsType in stvstyp.stvstyp_code%TYPE,
						 vsYear in VARCHAR2,
						 vdIni in twbcntr.twbcntr_issue_date%TYPE,
						 vdFin in twbcntr.twbcntr_issue_date%TYPE,
						 vsCont in twbcntr.twbcntr_num%TYPE,
						 vsPago in twvpaym.twvpaym_code%TYPE,
                         vsTaDo in twbdocu.twbdocu_status_ind%TYPE)
  IS
  select anio, term, contrato, secuencia, fecha, monto_con, me_pa_code, medio_pago, documento, vencimiento, banco, monto_doc, id_al, rut_al, nombre_al,  programa, programa_desc, tipo, fechapago, userpago, rutapo, nomapo,
  --md-01 inicio
   status_doc
   --md-01 fin
from (select substr(twbcntr_term_code, 1, 4)                                                                        anio
	   , twbcntr_term_code                                                                                          term
	   , a.twbdocu_cntr_num                                                                                         contrato
	   , twbdocu_seq_num                                                                                            secuencia
	   , twbcntr_issue_date                                                                                         fecha
	   , to_char(pk_matricula.f_MontoContrato(twbdocu_cntr_num), pk_contrato.ConstglFormato)                        monto_con
	   , a.twbdocu_paym_code                                                                                        me_pa_code
	   , pk_matricula.f_existemediopago(a.twbdocu_paym_code)                                                        medio_pago
	   , a.twbdocu_docu_num                                                                                         documento
	   , a.twbdocu_expiration_date                                                                                  vencimiento
	   , pk_matricula.f_existebanco(a.twbdocu_bank_code)                                                            banco
	   , to_char(a.twbdocu_amount, pk_contrato.ConstglFormato)                                                      monto_doc
	   , f_get_id(a.twbdocu_pidm)                                                                                   id_al
	   , f_get_rut(a.twbdocu_pidm)                                                                                  rut_al
	   , f_get_nombre(a.twbdocu_pidm)                                                                               nombre_al
	   , twbcntr_ori_program                                                                                        programa
	   , pk_catalogo.programa(twbcntr_ori_program)                                                                  programa_desc
	   , fwatyaluft(twbcntr_pidm, twbcntr_term_code)                                                                tipo
	   , pk_MatApoderado.f_GetApoderadoDocu(TWBDOCU_SEQ_NUM)														rutapo
	   , pk_MatApoderado.f_NombreCompleto(pk_MatApoderado.f_GetApoderadoDocu(TWBDOCU_SEQ_NUM))						nomapo
	   , a.twbdocu_pay_date																							fechapago
	   , a.twbdocu_pay_user																							userpago
       --md-01 inicio
       ,b.TWVDOST_STATUS_DESC                                                                                 status_doc
       --md-01 fin
from     twbcntr
	   , twbdocu a
	   , sgbstdn g1
       --md-01 inicio
       ,twvdost b
       --md-01 fin
where a.twbdocu_cntr_num = twbcntr_num(+)
  and a.twbdocu_pidm = g1.sgbstdn_pidm
  --md-01 inicio
  and A.TWBDOCU_STATUS_IND = B.TWVDOST_STATUS_IND
  --md-01 fin
  and g1.sgbstdn_term_code_eff = (select max(g2.sgbstdn_term_code_eff)
								  from   sgbstdn g2
								  where g1.sgbstdn_pidm = g2.sgbstdn_pidm
									and g2.sgbstdn_term_code_eff <= twbcntr_term_code)
  and twbcntr_status_ind = 'A'
  and (TWBDOCU_STATUS_IND = vsTaDo or vsTaDo is null)
  and not exists (select 1
                    from twbretr
                    where twbretr_cntr_num = twbcntr_num))
where (programa = vsProg or vsProg is null)
  and (tipo = vsType or vsType is null)
  and (term like (vsYear||'%') or vsYear is null)
  AND (TRUNC(vencimiento) >= TRUNC(vdIni) OR vdIni IS NULL)
  AND (TRUNC(vencimiento) <= TRUNC(vdFin) OR vdFin IS NULL)
--  and (vencimiento between vdIni and vdFin or vdFin is null or vdIni is null)
  and (contrato = vsCont or vsCont is null)
  and (me_pa_code = vsPago or vsPago is null)

order by contrato, fecha, secuencia;

BEGIN

   IF Pk_Login.F_ValidacionDeAcceso (pk_login.vgsUSR)
   THEN
	  RETURN;
   END IF;

	/* Parmetros */
	--Se busca el valor de la cookie (parmetro) para asignarlo al filtro del query.
	vsProg  := pk_ObjHtml.getValueCookie ('psProgr');
	vsType  := pk_ObjHtml.getValueCookie ('psTiPo');
	vsYear := pk_ObjHtml.getValueCookie ('psYear');
	vdIni   := pk_ObjHtml.getValueCookie ('pdIni');
	vdFin   := pk_ObjHtml.getValueCookie ('pdFin');
	vsCont  := pk_ObjHtml.getValueCookie ('psId');
	vsPago  := pk_ObjHtml.getValueCookie ('psPago');
    vsTaDo  := pk_ObjHtml.getValueCookie ('psTaDoc');

  -- Nmero de columnas de la tabla --
   tabColumna.EXTEND (vnColumnas);
   /* Encabezado de las columnas */
   tabColumna (1) := 'Ao';
   tabColumna (2) := 'Contrato';
   tabColumna (3) := 'Fecha Ingreso';
   tabColumna (4) := 'Monto Contrato';
   tabColumna (5) := 'Medio Pago';
   tabColumna (6) := 'Documento';
    --md-01 inicio
    tabColumna (7) := 'Status Documento';
    --md-01 fin
   tabColumna (8) := 'Vencimiento';
   tabColumna (9) := 'Banco';
   tabColumna (10) := 'Monto Documento';
   tabColumna (11) := 'Rut Apoderado';
   tabColumna (12) := 'Apoderado';
   tabColumna (13) := 'Fecha de Pago';
   tabColumna (14) := 'Usuario Pago';
   tabColumna (15) := 'Id Alumno';
   tabColumna (16) := 'Rut Alumno';
   tabColumna (17) := 'Nombre';
   --md-01 tabColumna (17) := 'Programa';
   tabColumna (18) := 'Descripcin Programa';

	  FOR regRep IN cuReporte_Cambio(vsProg, vsType, vsYear, vdIni, vdFin, vsCont, vsPago,vsTaDo) LOOP
		  IF vnRow = 0 THEN
			 Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag);
			 vsInicioPag := 'SALTO';
			 vnRow  := 0;
		  END IF;
		--md-01 se comento la columna donde aparece regRep.programa y se agrego status de documento
		  htp.p(
		  '<tr>
		  <td valign="top">'||regRep.anio||'</td>
		  <td valign="top">'||regRep.contrato||'</td>
		  <td valign="top">'||regRep.fecha||'</td>
		  <td valign="top">'||regRep.monto_con||'</td>
		  <td valign="top">'||regRep.medio_pago||'</td>
		  <td valign="top">'||regRep.documento||'</td>
          <td valign="top">'||regRep.status_doc||'</td>
		  <td valign="top">'||regRep.vencimiento||'</td>
		  <td valign="top">'||regRep.banco||'</td>
		  <td valign="top">'||regRep.monto_doc||'</td>
		  <td valign="top">'||regRep.rutapo||'</td>
		  <td valign="top">'||regRep.nomapo||'</td>
		  <td valign="top">'||regRep.fechapago||'</td>
		  <td valign="top">'||regRep.userpago||'</td>
		  <td valign="top">'||regRep.id_al||'</td>
		  <td valign="top">'||regRep.rut_al||'</td>
		  <td valign="top">'||regRep.nombre_al||'</td>
		  <td valign="top">'||regRep.programa_desc||'</td>');

		  vnExists   := 1;
		  vnRow      := vnRow + 1;
	  END LOOP;

   IF vnExists = 0
   THEN
	  HTP.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
	  -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
	  Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

	  -- es omitido el encabezado del reporte pero se agrega el salto de pagina
	  Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
   END IF;

   HTP.p ('</table><br/></body></html>');
EXCEPTION
   WHEN OTHERS
   THEN
	  HTP.P (SQLERRM);
END PWCLADO;
/


DROP PUBLIC SYNONYM PWCLADO;

CREATE PUBLIC SYNONYM PWCLADO FOR BANINST1.PWCLADO;


GRANT EXECUTE ON BANINST1.PWCLADO TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWCLADO TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWCLADO TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWCLADO TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWCLADO TO WWW2_USER;
DROP PROCEDURE BANINST1.PWCONMA;

CREATE OR REPLACE PROCEDURE BANINST1.PWCONMA (psReclDesc VARCHAR2)
IS
/******************************************************************************
PROCEDIMIENTO:          BANINST1.PWCONMA
OBJETIVO:               Reporte de Contratos y Matriculados Completo
AUTORES:                Guillermo Almazan Iba?ez
FECHA:                  10/12/2010
****************************************************************
modificacion :          md-01 agregar a que se vean contratos en status X
autor        :          Roman Ruiz
fecha        :          23-ago-2013

modificacion :          md-02 agregar filtro de contrato por pregrado y postgrado
autor        :          Virgilio De la Cruz
fecha        :          11-ene-2014

******************************************************************************/
   vnRow         INTEGER := 0;
   vnExists      INTEGER := 0;
   vnColumnas    INTEGER := 33;
   vsProg        smrprle.smrprle_program_desc%TYPE;
   vsStat        sgbstdn.sgbstdn_stst_code%TYPE;
   vsStatus 	   sgbstdn.sgbstdn_stst_code%TYPE;
   vsType        sgbstdn.sgbstdn_styp_code%TYPE;
   vsDstatus	   stvstst.stvstst_desc%TYPE;
   vnRegSte		   NUMBER(1);
   vsYear        VARCHAR2(4);
   vsYterm		   VARCHAR2(4);
   vsTerm		     VARCHAR2(2);
   vsTermStatus  VARCHAR2(8);
   vsStatusCntr  VARCHAR2(8);
   vdIni         twbcntr.twbcntr_issue_date%TYPE;
   vdFin         twbcntr.twbcntr_issue_date%TYPE;
   vsCont        twbcntr.twbcntr_num%TYPE;
   tabColumna    Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla (1);
   vsInicioPag   VARCHAR2 (10) := NULL;
--md-02
   vsTipoCntr VARCHAR2(15);
CURSOR cuReporte_Cambio (vsProg in smrprle.smrprle_program_desc%TYPE,
   vsStat in sgbstdn.sgbstdn_stst_code%TYPE,
   vsType in stvstyp.stvstyp_code%TYPE,
   vsYear in VARCHAR2,
   vdIni in twbcntr.twbcntr_issue_date%TYPE,
   vdFin in twbcntr.twbcntr_issue_date%TYPE,
   vsCont in twbcntr.twbcntr_num%TYPE)
  IS
  select anio, contrato, fecha_cntr, monto_cntr, periodo_cntr, tipo_periodo, comm_cntr, id, rut_al, alumno, direccion_al, region_al, comuna_al,
         telefono_al, psu, sexo, coreo_pers, periodo_adm, via, tipo_code, tipo, tipo_alumno, estatus_alumno, actualizacion_estatus,
         programa, prog_desc, rut_apoderado, apoderado, direccion_ap, region_ap, comuna_ap, tel_ap_tf, tel_ap_tm, email_pers
  from (select substr(twbcntr_term_code, 1, 4)                                                         anio
       , twbcntr_num                                                                                   contrato
       , twbcntr_status_ind                                                                            status
       , twbcntr_issue_date                                                                            fecha_cntr
       , twbcntr_term_code                                                                             periodo_cntr
       , decode(TWBCNTR_TERM_TYPE, 'A', 'Anual',
                                   '1', 'Primer Semestre',
                                   '2', 'Segundo Semestre',
                                   (select decode(STVTERM_TRMT_CODE, 'A', 'Anual', 'S', 'Semestral')
                                    from STVTERM
                                    where STVTERM_CODE = TWBCNTR_TERM_CODE))                           tipo_periodo
       --, pk_matricula.f_MontoContrato(twbcntr_num)                                                   monto_cntr
       , to_char(pk_matricula.f_MontoContrato(twbcntr_num), pk_contrato.ConstglFormato)                monto_cntr
       , pk_matricula.f_comecont(twbcntr_num)                                                          comm_cntr
       , f_get_id(twbcntr_pidm)                                                                        id
       , f_get_rut(twbcntr_pidm)                                                                       rut_al
       ,  f_format_name(twbcntr_pidm, 'LF30')                                                          alumno
       , pk_matricula.f_DirAlumno(twbcntr_pidm)                                                        direccion_al
       , pk_matricula.f_RegAlumno(twbcntr_pidm)                                                        region_al
       , pk_matricula.f_ComuAlumno(twbcntr_pidm)                                                       comuna_al
       , f_get_telefono_al(twbcntr_pidm, 'TFPA')                                                       telefono_al
       , pk_AdMat.f_get_psu_pond(twbcntr_pidm, twbcntr_term_code)                                  psu
       , f_get_sexo(twbcntr_pidm)                                                                      sexo
       , f_get_mail_pers(twbcntr_pidm)                                                                 coreo_pers
       , sgbstdn_term_code_admit                                                                       periodo_adm
       , pk_catalogo.admision(sgbstdn_admt_code)                                                       via
       , sgbstdn_admt_code                                                                             via_code
       , fwatyaluft(twbcntr_pidm, twbcntr_term_code)                                                     tipo_code
       , decode(fwatyaluft(twbcntr_pidm, twbcntr_term_code),'N','Nuevo Ingreso','A','Avanzado')          tipo
       , pk_catalogo.TipoAlumno(sgbstdn_styp_code)                                                     tipo_alumno
       --, f_student_get_desc('stvstst', sgbstdn_stst_code, 30)                                        estatus_alumno
       , f_student_get_desc('stvstst', BANINST1.F_GET_STST_SGB(twbcntr_pidm), 30)                      estatus_alumno
       , f_get_status(twbcntr_pidm, sgbstdn_stst_code)                                                 actualizacion_estatus
       , TWBCNTR_ORI_PROGRAM                                                                           programa
       , pk_catalogo.programa(TWBCNTR_ORI_PROGRAM)                         								prog_desc
       , twbcntr_rut                                                                                   rut_apoderado
       , pk_MatApoderado.f_NombreCompleto(twbcntr_rut)                     apoderado
       , pk_MatApoderado.f_Direccion(twbcntr_rut, twbcntr_term_code)                                        direccion_ap
       , pk_MatApoderado.f_Region(twbcntr_rut, twbcntr_term_code)                                        region_ap
       , pk_MatApoderado.f_Comuna(twbcntr_rut, twbcntr_term_code)                                       comuna_ap
       , pk_MatApoderado.f_Telefono(twbcntr_rut, 'PR', twbcntr_term_code)                                  tel_ap_tf
       , pk_MatApoderado.f_Telefono(twbcntr_rut, 'TMSO', twbcntr_term_code)                                tel_ap_tm
       , pk_MatApoderado.f_Email(twbcntr_rut, 'PERS', twbcntr_term_code)                              email_pers
from   twbcntr
     , sgbstdn g1
where g1.sgbstdn_pidm = twbcntr_pidm
  and g1.sgbstdn_term_code_eff =
                    (select max(g2.sgbstdn_term_code_eff)
                       from sgbstdn g2
                      where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
  -- and twbcntr_status_ind = 'A'              --md-01
  and twbcntr_status_ind in ( 'A','X')         --md-01
  and not exists (select 1
                    from twbretr
                    where twbretr_cntr_num = twbcntr_num)
  and (sgbstdn_stst_code = vsStat or vsStat is null)
  and (sgbstdn_styp_code = vsType or vsType is null))
where (programa = vsProg or vsProg is null)
and (periodo_cntr like (vsYear||'%') or vsYear is null)
--and (fecha_cntr between vdIni and vdFin or vdFin is null or vdIni is null)
and (vdIni is null or fecha_cntr >= vdIni)
and (vdFin is null or fecha_cntr < vdFin+1)
and (contrato = vsCont or vsCont is null);

--md-02
CURSOR cuReporte_Cambio_Postgrado (vsProg in smrprle.smrprle_program_desc%TYPE,
   vsStat in sgbstdn.sgbstdn_stst_code%TYPE,
   vsType in stvstyp.stvstyp_code%TYPE,
   vsYear in VARCHAR2,
   vdIni in twbcntr.twbcntr_issue_date%TYPE,
   vdFin in twbcntr.twbcntr_issue_date%TYPE,
   vsCont in twbcntr.twbcntr_num%TYPE)
  IS
  select anio, contrato, fecha_cntr, monto_cntr, periodo_cntr, tipo_periodo, comm_cntr, id, rut_al, alumno, direccion_al, region_al, comuna_al,
         telefono_al, psu, sexo, coreo_pers, periodo_adm, via, tipo_code, tipo, tipo_alumno, estatus_alumno, actualizacion_estatus,
         programa, prog_desc, rut_apoderado, apoderado, direccion_ap, region_ap, comuna_ap, tel_ap_tf, tel_ap_tm, email_pers
  from (select substr(twbcntr_term_code, 1, 4)                                                         anio
       , twbcntr_num                                                                                   contrato
       , twbcntr_status_ind                                                                            status
       , twbcntr_issue_date                                                                            fecha_cntr
       , twbcntr_term_code                                                                             periodo_cntr
       , decode(TWBCNTR_TERM_TYPE, 'A', 'Anual',
                                   '1', 'Primer Semestre',
                                   '2', 'Segundo Semestre',
                                   (select decode(STVTERM_TRMT_CODE, 'A', 'Anual', 'S', 'Semestral')
                                    from STVTERM
                                    where STVTERM_CODE = TWBCNTR_TERM_CODE))                           tipo_periodo
       --, pk_matricula.f_MontoContrato(twbcntr_num)                                                   monto_cntr
       , to_char(pk_matricula.f_MontoContrato(twbcntr_num), pk_contrato.ConstglFormato)                monto_cntr
       , pk_matricula.f_comecont(twbcntr_num)                                                          comm_cntr
       , f_get_id(twbcntr_pidm)                                                                        id
       , f_get_rut(twbcntr_pidm)                                                                       rut_al
       ,  f_format_name(twbcntr_pidm, 'LF30')                                                          alumno
       , pk_matricula.f_DirAlumno(twbcntr_pidm)                                                        direccion_al
       , pk_matricula.f_RegAlumno(twbcntr_pidm)                                                        region_al
       , pk_matricula.f_ComuAlumno(twbcntr_pidm)                                                       comuna_al
       , f_get_telefono_al(twbcntr_pidm, 'TFPA')                                                       telefono_al
       , pk_AdMat.f_get_psu_pond(twbcntr_pidm, twbcntr_term_code)                                  psu
       , f_get_sexo(twbcntr_pidm)                                                                      sexo
       , f_get_mail_pers(twbcntr_pidm)                                                                 coreo_pers
       , sgbstdn_term_code_admit                                                                       periodo_adm
       , pk_catalogo.admision(sgbstdn_admt_code)                                                       via
       , sgbstdn_admt_code                                                                             via_code
       , fwatyaluft(twbcntr_pidm, twbcntr_term_code)                                                     tipo_code
       , decode(fwatyaluft(twbcntr_pidm, twbcntr_term_code),'N','Nuevo Ingreso','A','Avanzado')          tipo
       , pk_catalogo.TipoAlumno(sgbstdn_styp_code)                                                     tipo_alumno
       --, f_student_get_desc('stvstst', sgbstdn_stst_code, 30)                                        estatus_alumno
       , f_student_get_desc('stvstst', BANINST1.F_GET_STST_SGB(twbcntr_pidm), 30)                      estatus_alumno
       , f_get_status(twbcntr_pidm, sgbstdn_stst_code)                                                 actualizacion_estatus
       , TWBCNTR_ORI_PROGRAM                                                                           programa
       , pk_catalogo.programa(TWBCNTR_ORI_PROGRAM)                                                         prog_desc
       , twbcntr_rut                                                                                   rut_apoderado
       , pk_MatApoderado.f_NombreCompleto(twbcntr_rut)                     apoderado
       , pk_MatApoderado.f_Direccion(twbcntr_rut, twbcntr_term_code)                                        direccion_ap
       , pk_MatApoderado.f_Region(twbcntr_rut, twbcntr_term_code)                                        region_ap
       , pk_MatApoderado.f_Comuna(twbcntr_rut, twbcntr_term_code)                                       comuna_ap
       , pk_MatApoderado.f_Telefono(twbcntr_rut, 'PR', twbcntr_term_code)                                  tel_ap_tf
       , pk_MatApoderado.f_Telefono(twbcntr_rut, 'TMSO', twbcntr_term_code)                                tel_ap_tm
       , pk_MatApoderado.f_Email(twbcntr_rut, 'PERS', twbcntr_term_code)                              email_pers
from   twbcntr
     , sgbstdn g1
where g1.sgbstdn_pidm = twbcntr_pidm
  and g1.sgbstdn_term_code_eff =
                    (select max(g2.sgbstdn_term_code_eff)
                       from sgbstdn g2
                      where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
  -- and twbcntr_status_ind = 'A'              --md-01
  and twbcntr_status_ind in ( 'A','X')         --md-01
  and twbcntr_type_code = 'CFC' --md-02
  and not exists (select 1
                    from twbretr
                    where twbretr_cntr_num = twbcntr_num)
  and (sgbstdn_stst_code = vsStat or vsStat is null)
  and (sgbstdn_styp_code = vsType or vsType is null))
where (programa = vsProg or vsProg is null)
and (periodo_cntr like (vsYear||'%') or vsYear is null)
--and (fecha_cntr between vdIni and vdFin or vdFin is null or vdIni is null)
and (vdIni is null or fecha_cntr >= vdIni)
and (vdFin is null or fecha_cntr < vdFin+1)
and (contrato = vsCont or vsCont is null);


BEGIN

   IF Pk_Login.F_ValidacionDeAcceso (pk_login.vgsUSR)
   THEN
      RETURN;
   END IF;

    /* Par?metros */
    --Se busca el valor de la cookie (par?metro) para asignarlo al filtro del query.
    vsProg  := pk_ObjHtml.getValueCookie ('psProgr');
    vsStat   := pk_ObjHtml.getValueCookie ('psSstst');
    vsType  := pk_ObjHtml.getValueCookie ('psTyAl');
    vsYear := pk_ObjHtml.getValueCookie ('psYear');
    vdIni   := pk_ObjHtml.getValueCookie ('pdIni');
    vdFin   := pk_ObjHtml.getValueCookie ('pdFin');
    vsCont  := pk_ObjHtml.getValueCookie ('psCont');
    --md-02
    vsTipoCntr := pk_ObjHtml.getValueCookie ('psTCntr');

  -- N?mero de columnas de la tabla --
   tabColumna.EXTEND (vnColumnas);


   /* Encabezado de las columnas */
   tabColumna (1) := 'A?o';
   tabColumna (2) := 'Contrato';
   tabColumna (3) := 'Fecha';
   tabColumna (4) := 'Monto';
   tabColumna (5) := 'Comentario';
   tabColumna (6) := 'Id';
   tabColumna (7) := 'RUT';
   tabColumna (8) := 'Alumno';
   tabColumna (9) := 'Direcci?n';
   tabColumna (10) := 'Regi?n';
   tabColumna (11) := 'Comuna';
   tabColumna (12) := 'Tel?fono';
   tabColumna (13) := 'Promedio PSU';
   tabColumna (14) := 'Sexo';
   tabColumna (15) := 'E-mail';
   tabColumna (16) := 'Periodo Ingreso';
   tabColumna (17) := 'Periodo Matricula';
   tabColumna (18) := 'Tipo Periodo';
   tabColumna (19) := 'Tipo de Alumno';
   --tabColumna (18) := 'Tipo de Admisi?n';
   --tabColumna (19) := 'Tipo de Alumno';
   tabColumna (20) := 'Estatus del Alumno<br>al hacer contrato';
   tabColumna (21) := 'Estatus del Alumno<br>actual';
   tabColumna (22) := 'Periodo Estatus del<br>alumno actual ';
   tabColumna (23) := 'Actualizaci?n Status Alumno ';
   tabColumna (24) := 'Programa';
   tabColumna (25) := 'Descripci?n Programa';
   tabColumna (26) := 'Rut Apoderado';
   tabColumna (27) := 'Apoderado';
   tabColumna (28) := 'Direcci?n';
   tabColumna (29) := 'Regi?n';
   tabColumna (30) := 'Comuna';
   tabColumna (31) := 'Tel?fono Personal';
   tabColumna (32) := 'Tel?fono Movil';
   tabColumna (33) := 'E-mail Personal';
--MD-02

IF vsTipoCntr ='PREGRADO'
THEN
      FOR regRep IN cuReporte_Cambio(vsProg, vsStat, vsType, vsYear, vdIni, vdFin, vsCont) LOOP
          IF vnRow = 0 THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag);
             vsInicioPag := 'SALTO';
             vnRow  := 0;
          END IF;


	select count(1) into vnRegSte from sgbstdn x
    	where x.sgbstdn_pidm = f_Get_pidm(regRep.id)
    	and x.sgbstdn_term_code_eff =
                    (select max(y.sgbstdn_term_code_eff)
                       from sgbstdn y
                      where x.sgbstdn_pidm = y.sgbstdn_pidm
                      and y.sgbstdn_term_code_eff like (vsYear||'%'));




--   IF vnRegSte > 0 then
--   	select sgbstdn_stst_code, sgbstdn_term_code_eff into vsStatus, vsTermStatus from sgbstdn x
--    	where x.sgbstdn_pidm = f_Get_pidm(regRep.id)
--    	and x.sgbstdn_term_code_eff =
--                    (select max(y.sgbstdn_term_code_eff)
--                       from sgbstdn y
--                      where x.sgbstdn_pidm = y.sgbstdn_pidm
--                      and y.sgbstdn_term_code_eff like (vsYear||'%'));
--
--   END IF;

  -- IF vnRegSte = 0  THEN
     	select sgbstdn_stst_code, sgbstdn_term_code_eff into vsStatus, vsTermStatus from sgbstdn x
    	where x.sgbstdn_pidm = f_Get_pidm(regRep.id)
    	and x.sgbstdn_term_code_eff =
                    (select max(y.sgbstdn_term_code_eff)
                       from sgbstdn y
                      where x.sgbstdn_pidm = y.sgbstdn_pidm);

   --END IF;




 	select sgbstdn_stst_code into vsStatusCntr from sgbstdn x
    	where x.sgbstdn_pidm = f_Get_pidm(regRep.id)
    	and x.sgbstdn_term_code_eff =
                    (select max(y.sgbstdn_term_code_eff)
                       from sgbstdn y
                      where x.sgbstdn_pidm = y.sgbstdn_pidm
                      and y.sgbstdn_term_code_eff<= regRep.periodo_cntr);




	IF vsStatus IS NOT NULL THEN
	begin
    	select trunc(swrales_chan_date)
    into vsDstatus
    from swrales
    where swrales_pidm = f_Get_pidm(regRep.id)
      and swrales_stst_code = vsStatus
        and swrales_chan_num = (select max (swrales_chan_num)
                                from swrales
                                where swrales_pidm = f_Get_pidm(regRep.id)
                                  and swrales_stst_code = vsStatus);
    exception when no_data_found then
    vsDstatus := null;

    end;

	END IF;


          htp.p(
          '<tr>
          <td valign="top">'||regRep.anio||'</td>
          <td valign="top">'||regRep.contrato||'</td>
          <td valign="top">'||regRep.fecha_cntr||'</td>
          <td valign="top">'||regRep.monto_cntr||'</td>
          <td valign="top">'||regRep.comm_cntr||'</td>
          <td valign="top">'||regRep.id||'</td>
          <td valign="top">'||regRep.rut_al||'</td>
          <td valign="top">'||regRep.alumno||'</td>
          <td valign="top">'||regRep.direccion_al||'</td>
          <td valign="top">'||regRep.region_al||'</td>
          <td valign="top">'||regRep.comuna_al||'</td>
          <td valign="top">'||regRep.telefono_al||'</td>
          <td valign="top">'||regRep.psu||'</td>
          <td valign="top">'||regRep.sexo||'</td>
          <td valign="top">'||regRep.coreo_pers||'</td>
          <td valign="top">'||regRep.periodo_adm||'</td>
          <td valign="top">'||regRep.periodo_cntr||'</td>
          <td valign="top">'||regRep.tipo_periodo||'</td>
          <td valign="top">'||regRep.tipo_alumno||'</td>
          <td valign="top">'||f_student_get_desc('stvstst', vsStatusCntr, 30)||'</td>
          <td valign="top">'||f_student_get_desc('stvstst', vsStatus, 30)||'</td>
          <td valign="top">'||vsTermStatus||'</td>
          <td valign="top">'||vsDstatus||'</td>
          <td valign="top">'||regRep.programa||'</td>
          <td valign="top">'||regRep.prog_desc||'</td>
          <td valign="top">'||regRep.rut_apoderado||'</td>
          <td valign="top">'||regRep.apoderado||'</td>
          <td valign="top">'||regRep.direccion_ap||'</td>
          <td valign="top">'||regRep.region_ap||'</td>
          <td valign="top">'||regRep.comuna_ap||'</td>
          <td valign="top">'||regRep.tel_ap_tf||'</td>
          <td valign="top">'||regRep.tel_ap_tm||'</td>
          <td valign="top">'||regRep.email_pers||'</td>');
          --<td valign="top">'||regRep.via||'</td>
          --<td valign="top">'||regRep.tipo||'</td>


          vnExists   := 1;
          vnRow      := vnRow + 1;
      END LOOP;

   IF vnExists = 0
   THEN
      HTP.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de p?gina para impresion
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- es omitido el encabezado del reporte pero se agrega el salto de pagina
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
   END IF;

   HTP.p ('</table><br/></body></html>');
END IF;

IF vsTipoCntr ='POSTGRADO'
THEN
      FOR regRep IN cuReporte_Cambio_Postgrado(vsProg, vsStat, vsType, vsYear, vdIni, vdFin, vsCont) LOOP
          IF vnRow = 0 THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag);
             vsInicioPag := 'SALTO';
             vnRow  := 0;
          END IF;


    select count(1) into vnRegSte from sgbstdn x
        where x.sgbstdn_pidm = f_Get_pidm(regRep.id)
        and x.sgbstdn_term_code_eff =
                    (select max(y.sgbstdn_term_code_eff)
                       from sgbstdn y
                      where x.sgbstdn_pidm = y.sgbstdn_pidm
                      and y.sgbstdn_term_code_eff like (vsYear||'%'));




--   IF vnRegSte > 0 then
--       select sgbstdn_stst_code, sgbstdn_term_code_eff into vsStatus, vsTermStatus from sgbstdn x
--        where x.sgbstdn_pidm = f_Get_pidm(regRep.id)
--        and x.sgbstdn_term_code_eff =
--                    (select max(y.sgbstdn_term_code_eff)
--                       from sgbstdn y
--                      where x.sgbstdn_pidm = y.sgbstdn_pidm
--                      and y.sgbstdn_term_code_eff like (vsYear||'%'));
--
--   END IF;

  -- IF vnRegSte = 0  THEN
         select sgbstdn_stst_code, sgbstdn_term_code_eff into vsStatus, vsTermStatus from sgbstdn x
        where x.sgbstdn_pidm = f_Get_pidm(regRep.id)
        and x.sgbstdn_term_code_eff =
                    (select max(y.sgbstdn_term_code_eff)
                       from sgbstdn y
                      where x.sgbstdn_pidm = y.sgbstdn_pidm);

   --END IF;




     select sgbstdn_stst_code into vsStatusCntr from sgbstdn x
        where x.sgbstdn_pidm = f_Get_pidm(regRep.id)
        and x.sgbstdn_term_code_eff =
                    (select max(y.sgbstdn_term_code_eff)
                       from sgbstdn y
                      where x.sgbstdn_pidm = y.sgbstdn_pidm
                      and y.sgbstdn_term_code_eff<= regRep.periodo_cntr);




    IF vsStatus IS NOT NULL THEN
    begin
        select trunc(swrales_chan_date)
    into vsDstatus
    from swrales
    where swrales_pidm = f_Get_pidm(regRep.id)
      and swrales_stst_code = vsStatus
        and swrales_chan_num = (select max (swrales_chan_num)
                                from swrales
                                where swrales_pidm = f_Get_pidm(regRep.id)
                                  and swrales_stst_code = vsStatus);
    exception when no_data_found then
    vsDstatus := null;

    end;

    END IF;


          htp.p(
          '<tr>
          <td valign="top">'||regRep.anio||'</td>
          <td valign="top">'||regRep.contrato||'</td>
          <td valign="top">'||regRep.fecha_cntr||'</td>
          <td valign="top">'||regRep.monto_cntr||'</td>
          <td valign="top">'||regRep.comm_cntr||'</td>
          <td valign="top">'||regRep.id||'</td>
          <td valign="top">'||regRep.rut_al||'</td>
          <td valign="top">'||regRep.alumno||'</td>
          <td valign="top">'||regRep.direccion_al||'</td>
          <td valign="top">'||regRep.region_al||'</td>
          <td valign="top">'||regRep.comuna_al||'</td>
          <td valign="top">'||regRep.telefono_al||'</td>
          <td valign="top">'||regRep.psu||'</td>
          <td valign="top">'||regRep.sexo||'</td>
          <td valign="top">'||regRep.coreo_pers||'</td>
          <td valign="top">'||regRep.periodo_adm||'</td>
          <td valign="top">'||regRep.periodo_cntr||'</td>
          <td valign="top">'||regRep.tipo_periodo||'</td>
          <td valign="top">'||regRep.tipo_alumno||'</td>
          <td valign="top">'||f_student_get_desc('stvstst', vsStatusCntr, 30)||'</td>
          <td valign="top">'||f_student_get_desc('stvstst', vsStatus, 30)||'</td>
          <td valign="top">'||vsTermStatus||'</td>
          <td valign="top">'||vsDstatus||'</td>
          <td valign="top">'||regRep.programa||'</td>
          <td valign="top">'||regRep.prog_desc||'</td>
          <td valign="top">'||regRep.rut_apoderado||'</td>
          <td valign="top">'||regRep.apoderado||'</td>
          <td valign="top">'||regRep.direccion_ap||'</td>
          <td valign="top">'||regRep.region_ap||'</td>
          <td valign="top">'||regRep.comuna_ap||'</td>
          <td valign="top">'||regRep.tel_ap_tf||'</td>
          <td valign="top">'||regRep.tel_ap_tm||'</td>
          <td valign="top">'||regRep.email_pers||'</td>');
          --<td valign="top">'||regRep.via||'</td>
          --<td valign="top">'||regRep.tipo||'</td>


          vnExists   := 1;
          vnRow      := vnRow + 1;
      END LOOP;

   IF vnExists = 0
   THEN
      HTP.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de p?gina para impresion
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- es omitido el encabezado del reporte pero se agrega el salto de pagina
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
   END IF;

   HTP.p ('</table><br/></body></html>');
END IF;


EXCEPTION
   WHEN OTHERS
   THEN
      HTP.P (SQLERRM);
--END IF;

END PWCONMA;
/


DROP PUBLIC SYNONYM PWCONMA;

CREATE PUBLIC SYNONYM PWCONMA FOR BANINST1.PWCONMA;


GRANT EXECUTE ON BANINST1.PWCONMA TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWCONMA TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWCONMA TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWCONMA TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWCONMA TO WWW2_USER;
DROP PROCEDURE BANINST1.PWJCCRM;

CREATE OR REPLACE PROCEDURE BANINST1.PWJCCRM(pdNextDate IN OUT DATE) IS

  vsError           VARCHAR2(4000) := NULL;
  vdInterval        DATE           := SYSDATE;
  vdNext            DATE           := TO_DATE(TO_CHAR(SYSDATE+1,'DD/MM/YYYY')||' '||'07:00:00','DD/MM/YYYY HH24:MI:SS');
  vdLimiteEjecucion DATE           := TO_DATE(TO_CHAR(SYSDATE,  'DD/MM/YYYY')||' '||'22:00:00','DD/MM/YYYY HH24:MI:SS');
  csPINSORT         VARCHAR2(7);


  csSysDateI CONSTANT DATE        := SYSDATE;

  --insertIni

  --intervalo
  procedure intervalo is

  begin
      if sysdate >= vdLimiteEjecucion then
         pdNextDate := vdNext;
      else
         pdNextDate := vdInterval + 1/100;
      end if;
  end intervalo;

  BEGIN
      PK_CARGAPSU.p_InsertaSortestInd;

      intervalo;



  EXCEPTION
      WHEN OTHERS THEN
           vsError := SQLERRM;

           --determina el intervalo de nueva ejecucin
           intervalo;

           INSERT INTO GWRERRM(GWRERRM_ERROR,GWRERRM_ORIGIN) VALUES(vsError, csPINSORT);

           COMMIT;

  END PWJCCRM;
/
DROP PROCEDURE BANINST1.PWJCREV;

CREATE OR REPLACE PROCEDURE BANINST1.PWJCREV(pdNextDate IN OUT DATE) IS
  /*
  Tarea: Ejecuta el procedimiento p_CriteriosDeEvaluacion con diferente VPDI
  Autor: GEPC
  Fecha: 31/03/2008

  */

  cn1        CONSTANT NUMBER(1)   := 1;
  cs000      CONSTANT VARCHAR2(3) := '000';
  cdSysDate  CONSTANT DATE        := SYSDATE;
  cdNext     CONSTANT DATE        := TO_DATE(TO_CHAR(cdSysDate,'DD/MM/YYYY')||' '||'10:00:00','DD/MM/YYYY HH24:MI:SS');
  cdInterval CONSTANT DATE        := TO_DATE(TO_CHAR(cdSysDate,'DD/MM/YYYY')||' '||'15:00:00','DD/MM/YYYY HH24:MI:SS');

  BEGIN
      PWACREV;

      IF cdSysDate >= cdNext AND cdSysDate <= cdInterval THEN
         pdNextDate := cdInterval;
      ELSE
         pdNextDate := cdNext + cn1;
      END IF;

  END PWJCREV;
/
DROP PROCEDURE BANINST1.PWJENRL;

CREATE OR REPLACE PROCEDURE BANINST1.PWJENRL(pdNextDate IN OUT DATE) IS
  /*
         TAREA: Actualizar la cantidad de inscritos en la programacin acadmica
         FECHA: 25/07/2013
         AUTOR: MAC
        MODULO: Programacin acamica

                 * Etapas de actualizacin
                   1. UPDATE INCORRECT ENROLLMENT COUNT ON SSBSECT
                   2. UPDATE INCORRECT AVAILABLE SEATS COUNT ON SSBSECT
                   3. UPDATE INCORRECT WAITING LIST COUNT ON SSBSECT
                   4. UPDATE INCORRECT AVAILABLE WAITING LIST SEATS
                   5. UPDATE ENROLLMENT COUNT ON XLIST RECORDS SSBXLST
                   6. UPDATE INCORRECT AVAILABLE SEATS COUNT ON XLISTS SSBXLST
                   7. UPDATE INCORRECT ENROLLMENT COUNT ON RESERVED SEATS SSBXLST
                   8. UPDATE INCORRECT WAITING LIST COUNT ON RESERVED SEATS SSBXLST
                   9. UPDATE INCORRECT AVAILABLE SEATS COUNT ON RESERVED SEATS

  MODIFICACIN:

  */

  cdInterval        CONSTANT DATE        := SYSDATE;
  cdNext            CONSTANT DATE        := TO_DATE(TO_CHAR(SYSDATE+1,'DD/MM/YYYY')||' '||'07:00:00','DD/MM/YYYY HH24:MI:SS');
  cdLimiteEjecucion CONSTANT DATE        := TO_DATE(TO_CHAR(SYSDATE,  'DD/MM/YYYY')||' '||'22:00:00','DD/MM/YYYY HH24:MI:SS');
  cn0               CONSTANT NUMBER(1)   := 0;
  cn1               CONSTANT NUMBER(1)   := 1;
  csY               CONSTANT VARCHAR2(1) := 'Y';
  csRE              CONSTANT VARCHAR2(2) := 'RE';
  csRW              CONSTANT VARCHAR2(2) := 'RW';

  --cuTermCamp
  CURSOR cuTermCamp IS
         SELECT STWCAMP_TERM_CODE AS termCode
           FROM STWCAMP;

  --obtieneCampTerm
  procedure obtieneCampTerm is

  cn1     constant number(1)   := 1;


  csYYYY  constant varchar2(4) := 'YYYY';
  csYear1 constant varchar2(4) := to_char(sysdate,csYYYY);
  csYear2 constant varchar2(4) := to_char(sysdate,csYYYY)+cn1;


  --cuTerm
  cursor cuTerm is
         select stvterm_code as termCode
           from stvterm
          where exists (select null
                          from ssbsect
                         where ssbsect_term_code = stvterm_code
                       )
            and exists (select null
                          from sobterm
                         where sobterm_term_code              = stvterm_code
                           and sobterm_dynamic_sched_term_ind = csY
                       )
            and (   stvterm_acyr_code = csYear1
                 or
                    stvterm_acyr_code = csYear2
                );

  begin
      for regTrm in cuTerm loop

          insert into stwcamp
          (stwcamp_term_code
          )
          values
          (regTrm.termCode
          );
      end loop;

  end obtieneCampTerm;

  --programacionAcademica
  procedure programacionAcademica(psTerm varchar2
                                 ) is

  begin
      --stvrsts_incl_sect_enrl
      insert into swrenrl_incl
      (swrenrl_term_code,
       swrenrl_crn,
       swrenrl_pidm,
       swrenrl_credit_hr,
       swrenrl_rsts_date
      )
      select sfrstcr_term_code,
             sfrstcr_crn,
             sfrstcr_pidm,
             sfrstcr_credit_hr,
             sfrstcr_rsts_date
        from sfrstcr,
             ssbsect
       where sfrstcr_term_code  = ssbsect_term_code
         and sfrstcr_crn        = ssbsect_crn
         and sfrstcr_rsts_code IN (csRE,csRW)
         and ssbsect_term_code  = psTerm;

      --stvrsts_wait_ind
      insert into swrenrl_wait
      (swrenrl_term_code,
       swrenrl_crn,
       swrenrl_pidm,
       swrenrl_credit_hr,
       swrenrl_rsts_date
      )
      select sfrstcr_term_code,
             sfrstcr_crn,
             sfrstcr_pidm,
             sfrstcr_credit_hr,
             sfrstcr_rsts_date
        from sfrstcr,
             ssbsect,
             stvrsts
       where sfrstcr_term_code = ssbsect_term_code
         and sfrstcr_crn       = ssbsect_crn
         and sfrstcr_rsts_code = stvrsts_code
         and stvrsts_wait_ind  = csY
         and ssbsect_term_code = psTerm;

      commit;

  end programacionAcademica;


  --actualiza cursos sin inscritos
  procedure updateCeroInscritos(psTerm varchar2
                               ) is

  begin
      update ssbsect
         set ssbsect_enrl        = cn0,
             ssbsect_seats_avail = ssbsect_max_enrl
       where cn0                 = (select count(cn1)
                                      from sfrstcr
                                     where sfrstcr_rsts_code in (csRE,csRW)
                                       and sfrstcr_crn        = ssbsect_crn
                                       and sfrstcr_term_code  = ssbsect_term_code
                                   )
         and ssbsect_enrl        > cn0
         and ssbsect_term_code   = psTerm;

      commit;
  end updateCeroInscritos;

  --actualizaInscritos
  procedure actualizaInscritos(psTerm varchar2
                              ) is

  begin
      --UPDATE INCORRECT ENROLLMENT COUNT ON SSBSECT

      update ssbsect x
         set (x.ssbsect_enrl,
              x.ssbsect_tot_credit_hrs) = (select nvl(count(swrenrl_crn),cn0),
                                                  nvl(sum(swrenrl_credit_hr),cn0)
                                             from swrenrl_incl
                                            where swrenrl_crn       = x.ssbsect_crn
                                              and swrenrl_term_code = x.ssbsect_term_code
                                          ),
             x.ssbsect_census_enrl      = (select nvl(count(swrenrl_crn),cn0)
                                             from swrenrl_incl
                                            where swrenrl_crn        = x.ssbsect_crn
                                              and swrenrl_term_code  = x.ssbsect_term_code
                                              and swrenrl_rsts_date <= x.ssbsect_census_enrl_date
                                          ),
             x.ssbsect_census_2_enrl    = (select nvl(count(swrenrl_crn),cn0)
                                             from swrenrl_incl
                                            where swrenrl_crn        = x.ssbsect_crn
                                              and swrenrl_term_code  = x.ssbsect_term_code
                                              and swrenrl_rsts_date <= x.ssbsect_census_2_date
                                          )
       where x.ssbsect_enrl     <> (select nvl(count(swrenrl_crn),cn0)
                                      from swrenrl_incl
                                     where swrenrl_term_code      = x.ssbsect_term_code
                                       and swrenrl_crn            = x.ssbsect_crn
                                   )
         and exists (select null
                       from swrenrl_incl
                      where swrenrl_term_code      = x.ssbsect_term_code
                        and swrenrl_crn            = x.ssbsect_crn
                    )
         and x.ssbsect_term_code = psTerm;

      commit;

  end actualizaInscritos;

  --actualizaLuagaresDisponibles
  procedure luagaresDisponibles(psTerm varchar2
                               ) is


  begin
      --UPDATE INCORRECT AVAILABLE SEATS COUNT ON SSBSECT
      update ssbsect
         set ssbsect_seats_avail = (ssbsect_max_enrl      - ssbsect_enrl),
             ssbsect_wait_avail  = (ssbsect_wait_capacity - ssbsect_wait_count)
       where (
                 ssbsect_seats_avail <> (ssbsect_max_enrl      - ssbsect_enrl)
              or
                 ssbsect_wait_avail  <> (ssbsect_wait_capacity - ssbsect_wait_count)
             )
         and ssbsect_term_code = psterm;

      commit;

  end luagaresDisponibles;

  --actualizaEspera
  procedure actualizaEspera(psTerm varchar2
                           ) is

  begin
      --update incorrect available waiting list seats
      update ssbsect
         set ssbsect_wait_avail  = (ssbsect_wait_capacity - ssbsect_wait_count)
       where ssbsect_wait_avail <> (ssbsect_wait_capacity - ssbsect_wait_count)
         and ssbsect_term_code   = psTerm;

      commit;

  end actualizaEspera;

  --lugaresEspera
  procedure lugaresEspera(psTerm varchar2
                         ) is


  --UPDATE INCORRECT WAITING LIST COUNT ON SSBSECT
  begin
      update ssbsect
         set ssbsect_wait_count   = (select nvl(count(swrenrl_crn),cn0)
                                       from swrenrl_wait
                                      where swrenrl_crn       = ssbsect_crn
                                    )
        where ssbsect_wait_count <> (select nvl(count(swrenrl_crn),cn0)
                                       from swrenrl_wait
                                      where swrenrl_crn       = ssbsect_crn
                                    )
          and exists (select null
                        from swrenrl_wait
                       where swrenrl_crn       = ssbsect_crn
                         and swrenrl_term_code = ssbsect_term_code
                     )
          and ssbsect_term_code   = psTerm;

      commit;

  end lugaresEspera;

  --actualizaListacruzada
  procedure actualizaListacruzada(psTerm varchar2
                                 ) is


  --UPDATE ENROLLMENT COUNT ON XLIST RECORDS SSBXLST
  begin
      update ssbxlst
         set ssbxlst_enrl  = (select nvl(sum(ssbsect_enrl),cn0)
                                from ssbsect,
                                     ssrxlst
                               where ssbsect_term_code  = ssbxlst_term_code
                                 and ssrxlst_term_code  = ssbxlst_term_code
                                 and ssrxlst_xlst_group = ssbxlst_xlst_group
                                 and ssrxlst_crn        = ssbsect_crn
                                 and ssbsect_term_code  = psTerm
                             )
       where ssbxlst_enrl <> (select sum(ssbsect_enrl)
                                from ssbsect,
                                     ssrxlst
                               where ssbsect_term_code  = ssbxlst_term_code
                                 and ssrxlst_term_code  = ssbxlst_term_code
                                 and ssrxlst_xlst_group = ssbxlst_xlst_group
                                 and ssrxlst_crn        = ssbsect_crn
                                 and ssbsect_term_code  = psTerm
                             )
         and ssbxlst_term_code = psterm;


  end actualizaListacruzada;

  --El procedimiento mantiene el intervalo de ejecucin de JOB
  --intervalo
  procedure intervalo is

  begin

      if sysdate >= cdLimiteEjecucion then
         pdNextDate := cdNext;
      else
         pdNextDate := cdInterval + 1/12;
      end if;

  end intervalo;

  --REGISTRA EL AVANCE DEL PROCESO PARA CREAR MATERIAS EN LA PROGRAMACIN ACADEMICA
  PROCEDURE ControlAvance(psAccion VARCHAR2
                         ) IS

  vnSeqn NUMBER(8) := 0;

  BEGIN
      IF    psAccion = 'I' THEN
            SELECT NVL(MAX(AWNSEPR_SEQ),0) + 1
              INTO vnSeqn
              FROM AWNSEPR
             WHERE AWNSEPR_TERM_CODE = '000000'
               AND AWNSEPR_PROCEDURE = 'JobEnrl';

            INSERT INTO AWNSEPR
            (AWNSEPR_SEQ, AWNSEPR_TERM_CODE, AWNSEPR_PROCEDURE, AWNSEPR_USER, AWNSEPR_PTRM_CODE, AWNSEPR_CAMP_CODE, AWNSEPR_PROCESO)
            VALUES
            (vnSeqn,      '000000',          'JobEnrl',         User,         '0',               'ALL',             'JobEnrl');

      ELSIF psAccion = 'U' THEN
            SELECT NVL(MAX(AWNSEPR_SEQ),0)
              INTO vnSeqn
              FROM AWNSEPR
             WHERE AWNSEPR_TERM_CODE = '000000'
               AND AWNSEPR_PROCEDURE = 'JobEnrl';

            UPDATE AWNSEPR
               SET AWNSEPR_END       = SYSDATE
             WHERE AWNSEPR_SEQ       = vnSeqn
               AND AWNSEPR_TERM_CODE = '000000'
               AND AWNSEPR_PROCEDURE = 'JobEnrl';

      END IF;

      COMMIT;

  END ControlAvance;

  BEGIN
      ControlAvance('I');

      --obtiene los datos para el cursor "cuTermCamp"
      obtieneCampTerm;

      FOR regCmp IN cuTermCamp LOOP

          updateCeroInscritos  (regCmp.termCode);

          programacionAcademica(regCmp.termCode);

          actualizaInscritos   (regCmp.termCode);

          luagaresDisponibles  (regCmp.termCode);

          lugaresEspera        (regCmp.termCode);

          actualizaEspera      (regCmp.termCode);

          actualizaListacruzada(regCmp.termCode);

          PWAENRL2(regCmp.termCode);

          PWATRNT('SATURN.SWRENRL_INCL');
          PWATRNT('SATURN.SWRENRL_WAIT');

          COMMIT;
      END LOOP;

      FOR regTrm IN cuTermCamp LOOP
          PWAENRL1(regTrm.termCode);
      END LOOP;

      --elimina registros de la tabla
      PWATRNT('SATURN.SWRENRL_INCL');
      PWATRNT('SATURN.SWRENRL_WAIT');
      PWATRNT('SATURN.STWCAMP');

      COMMIT;

      ControlAvance('U');

      intervalo;

  EXCEPTION
      WHEN OTHERS THEN

           --elimina registros de la tabla
           PWATRNT('SATURN.SWRENRL_INCL');
           PWATRNT('SATURN.SWRENRL_WAIT');
           PWATRNT('SATURN.STWCAMP');


           COMMIT;

           intervalo;
  END PWJENRL;
/
DROP PROCEDURE BANINST1.PWJICRM;

CREATE OR REPLACE PROCEDURE BANINST1.PWJICRM(pdNextDate IN OUT DATE) IS

  vsError           VARCHAR2(4000) := NULL;
  vdInterval        DATE           := SYSDATE;
  vdNext            DATE           := TO_DATE(TO_CHAR(SYSDATE+1,'DD/MM/YYYY')||' '||'07:00:00','DD/MM/YYYY HH24:MI:SS');
  vdLimiteEjecucion DATE           := TO_DATE(TO_CHAR(SYSDATE,  'DD/MM/YYYY')||' '||'22:00:00','DD/MM/YYYY HH24:MI:SS');
  csPININD         VARCHAR2(7);


  csSysDateI CONSTANT DATE        := SYSDATE;

  --insertIni

  --intervalo
  procedure intervalo is

  begin
      if sysdate >= vdLimiteEjecucion then
         pdNextDate := vdNext;
      else
         pdNextDate := vdInterval + 5/1440;
      end if;
  end intervalo;

  BEGIN
      PK_CARGAINDIVIDUAL.p_carga;

      intervalo;



  EXCEPTION
      WHEN OTHERS THEN
           vsError := SQLERRM;

           --determina el intervalo de nueva ejecucin
           intervalo;

           INSERT INTO GWRERRM(GWRERRM_ERROR,GWRERRM_ORIGIN) VALUES(vsError, csPININD);

           COMMIT;

  END PWJICRM;
/


DROP PUBLIC SYNONYM PWJICRM;

CREATE PUBLIC SYNONYM PWJICRM FOR BANINST1.PWJICRM;
DROP PROCEDURE BANINST1.PWJINCR;

CREATE OR REPLACE PROCEDURE BANINST1.PWJINCR(pdNextDate IN OUT DATE) IS
/*
   Tarea: Eliminar inconsistencia de Banner
   Autor: GEPC
   Fecha: 27/07/2010

*/

  csOE              CONSTANT VARCHAR2(2)  := 'OE';
  cs201010          CONSTANT VARCHAR2(6)  := '201010';
  csDDMMYYYY        CONSTANT VARCHAR2(10) := 'DD/MM/YYYY';
  cn2               CONSTANT NUMBER(1)    := 2;
  cn0p5             CONSTANT NUMBER(3,2)  := 0.5;
  cn60              CONSTANT NUMBER(2)    := 60;
  cdSysDate         CONSTANT DATE         := SYSDATE;
  cdNext            CONSTANT DATE         := TO_DATE(TO_CHAR(cdSysDate+1,csDDMMYYYY)||' '||'06:00:00','DD/MM/YYYY HH24:MI:SS');
  cdLimiteEjecucion CONSTANT DATE         := TO_DATE(TO_CHAR(cdSysDate,  csDDMMYYYY)||' '||'23:00:00','DD/MM/YYYY HH24:MI:SS');

  BEGIN

      DELETE FROM SHRMRKA
       WHERE LTRIM(SHRMRKA_GRDE_CODE) IS NULL
         AND SHRMRKA_AUDIT_SEQ_NO     >= cn2
         AND SHRMRKA_GCHG_CODE         = csOE
         AND SHRMRKA_TERM_CODE        >= cs201010;

      COMMIT;

      IF cdSysDate >= cdLimiteEjecucion THEN
         pdNextDate := cdNext;
      ELSE
         pdNextDate := cdSysDate + cn0p5/cn60;
      END IF;

  END PWJINCR;
/
DROP PROCEDURE BANINST1.PWJPCRM;

CREATE OR REPLACE PROCEDURE BANINST1.PWJPCRM(pdNextDate IN OUT DATE) IS

  vsError           VARCHAR2(4000) := NULL;
  vdInterval        DATE           := SYSDATE;
  vdNext            DATE           := TO_DATE(TO_CHAR(SYSDATE+1,'DD/MM/YYYY')||' '||'07:00:00','DD/MM/YYYY HH24:MI:SS');
  vdLimiteEjecucion DATE           := TO_DATE(TO_CHAR(SYSDATE,  'DD/MM/YYYY')||' '||'22:00:00','DD/MM/YYYY HH24:MI:SS');


  csPWAGWBT  CONSTANT VARCHAR2(7) := 'PWAGWBT';
  csPWATCRM  CONSTANT VARCHAR2(7) := 'PWATCRM';
  csPWJPCRM  CONSTANT VARCHAR2(7) := 'PWJPCRM';
  csSysDateI CONSTANT DATE        := SYSDATE;

  --insertIni
  procedure insertIni(psCode varchar2) is

  begin
      insert into gwbpcrm
      (
       gwbpcrm_code,gwbpcrm_date_beg
      )
      values
      (
       psCode,      csSysDateI
      );

      commit;
  end insertIni;

  --updateEnd
  procedure updateEnd(psCode varchar2) is

  csSysDateU constant date := sysdate;

  begin
      update gwbpcrm
         set gwbpcrm_date_end = csSysDateU
       where gwbpcrm_code     = psCode
         and gwbpcrm_date_beg = csSysDateI;

      commit;
  end updateEnd;

  --intervalo
  procedure intervalo is

  begin
      if sysdate >= vdLimiteEjecucion then
         pdNextDate := vdNext;
      else
         pdNextDate := vdInterval + 1/100;
      end if;
  end intervalo;

  BEGIN
      insertIni(csPWAGWBT);

      -- * Consulta de admiciones para alimentar la lectura del CRM
      -- para los periodos definidos en "GWBTERM".
      PWAGWBT;

      updateEnd(csPWAGWBT);
      insertIni(csPWATCRM);

      -- * Consulta de admiciones para alimentar la lectura del CRM
      -- y carga las diferencias.
      PWATCRM;

      updateEnd(csPWATCRM);

      --determina el intervalo de nueva ejecucin
      intervalo;

      PWATRNT('GWBTCRM');
      PWATRNT('GWBTCR0');
      PWATRNT('GWBTCR1');
      PWATRNT('GWBTCR2');
      PWATRNT('GWBTCR3');

  EXCEPTION
      WHEN OTHERS THEN
           vsError := SQLERRM;

           --determina el intervalo de nueva ejecucin
           intervalo;

           INSERT INTO GWRERRM(GWRERRM_ERROR,GWRERRM_ORIGIN) VALUES(vsError, csPWJPCRM);

           COMMIT;

  END PWJPCRM;
/
DROP PROCEDURE BANINST1.PWJSEPR;

CREATE OR REPLACE PROCEDURE BANINST1.PWJSEPR(pdNextDate IN OUT DATE) IS
/*
          Tarea: Ejecuta el procedimiento pk_ProcesoSeprad
         Modulo: Evaluacin Docente
          Autor: MAC
          Fecha: 16/11/2010

*/

  TYPE reg_Camps IS RECORD (rTermCode VARCHAR2(10),
                            rPtrmCode VARCHAR2(10),
						                      rCampCode VARCHAR2(10)
                           );

  TYPE tableCamps IS TABLE OF reg_Camps INDEX BY BINARY_INTEGER;

  tabCamp        tableCamps;
  vnRow          INTEGER      := 0;
  vnExiste       INTEGER      := 1;
  vsCamp         VARCHAR2(10) := NULL;

  --cuStatus
  CURSOR cuStatus IS
         SELECT encuesta.TERM AS termCode,
                encuesta.PTRM AS ptrmCode,
                encuesta.CAMP AS campCode,
                encuesta.TSSC AS tsscCode
           FROM (SELECT SVRESAF_TERM_CODE            AS TERM,
                        SSBSECT_PTRM_CODE            AS PTRM,
                        SSBSECT_CAMP_CODE            AS CAMP,
                        SVRESAF_TSSC_CODE            AS TSSC,
                        MIN(SVRESAF_DTES_BEGIN_DATE) AS MIND,
                        MAX(SVRESAF_DTES_END_DATE)   AS MAXD
                   FROM SVRESAF,SSBSECT
                  WHERE SVRESAF_TERM_CODE = SSBSECT_TERM_CODE
                    AND SVRESAF_CRN       = SSBSECT_CRN
                  GROUP BY SVRESAF_TERM_CODE,
                           SSBSECT_PTRM_CODE,
                           SSBSECT_CAMP_CODE,
                           SVRESAF_TSSC_CODE
                ) encuesta
          WHERE TRUNC(SYSDATE) BETWEEN TRUNC(encuesta.MIND) AND TRUNC(encuesta.MAXD+4)
          ORDER BY encuesta.CAMP,
                   encuesta.TERM DESC,
                   encuesta.PTRM;

  CURSOR cuCampus IS
         SELECT encuesta.TERM termCode,
                encuesta.PTRM ptrmCode,
                encuesta.CAMP campCode
           FROM (SELECT SVRESAF_TERM_CODE            TERM,
                        SSBSECT_PTRM_CODE            PTRM,
                        SSBSECT_CAMP_CODE            CAMP,
                        MIN(SVRESAF_DTES_BEGIN_DATE) MIND,
                        MAX(SVRESAF_DTES_END_DATE)   MAXD
                   FROM SVRESAF,SSBSECT
                  WHERE SVRESAF_TERM_CODE = SSBSECT_TERM_CODE
                    AND SVRESAF_CRN       = SSBSECT_CRN
                  GROUP BY SVRESAF_TERM_CODE,SSBSECT_PTRM_CODE,SSBSECT_CAMP_CODE
                ) encuesta
          WHERE TRUNC(SYSDATE) BETWEEN TRUNC(encuesta.MIND) AND TRUNC(encuesta.MAXD+4)
          ORDER BY encuesta.CAMP,
                   encuesta.TERM DESC,
                   encuesta.PTRM;

  CURSOR cuComparativo IS
         SELECT DISTINCT encuesta.TERM termCode,
                         encuesta.CAMP campCode
           FROM (SELECT SVRESAF_TERM_CODE            TERM,
                        SSBSECT_CAMP_CODE            CAMP,
                        MIN(SVRESAF_DTES_BEGIN_DATE) MIND,
                        MAX(SVRESAF_DTES_END_DATE)   MAXD
                   FROM SVRESAF,SSBSECT
                  WHERE SVRESAF_TERM_CODE = SSBSECT_TERM_CODE
                    AND SVRESAF_CRN       = SSBSECT_CRN
                  GROUP BY SVRESAF_TERM_CODE,SSBSECT_CAMP_CODE
                ) encuesta
          WHERE TRUNC(SYSDATE) BETWEEN TRUNC(encuesta.MIND) AND TRUNC(encuesta.MAXD+4)
          ORDER BY encuesta.CAMP,
                   encuesta.TERM DESC;

  BEGIN
      SELECT COUNT(1)
        INTO vnExiste
        FROM SWRERRP
       WHERE SWRERRP_ETAPA       = 'BEGIN'
         AND TRUNC(SWRERRP_DATE) = TRUNC(SYSDATE);

      IF vnExiste = 0 THEN
         FOR regEnc IN cuStatus LOOP
             kwaprsp.statusDeEvaluacion(regEnc.termCode, regEnc.tsscCode, regEnc.ptrmCode, regEnc.campCode);
         END LOOP;

         --Se obtiene los campus que estan aplicando el SEPRAD por periodo y parte de periodo
         FOR regCmp IN cuCampus LOOP
             vnRow := vnRow + 1;

             tabCamp(vnRow).rTermCode := regCmp.termCode;
             tabCamp(vnRow).rPtrmCode := regCmp.ptrmCode;
             tabCamp(vnRow).rCampCode := regCmp.campCode;
         END LOOP;

         --Borra las evaluaciones que se estan aplicando para recalcular los promedios
         FOR vnI IN 1..vnRow LOOP
             DELETE FROM SWRSEPR
              WHERE SWRSEPR_TERM_CODE = tabCamp(vnI).rTermCode
                AND SWRSEPR_CAMP_CODE = tabCamp(vnI).rCampCode
                AND SWRSEPR_PTRM_CODE = tabCamp(vnI).rPtrmCode;

             DELETE FROM SWBSEPR
              WHERE SWBSEPR_TERM_CODE = tabCamp(vnI).rTermCode
                AND SWBSEPR_CAMP_CODE = tabCamp(vnI).rCampCode
                AND SWBSEPR_PTRM_CODE = tabCamp(vnI).rPtrmCode;

             DELETE FROM SWBSEPG
              WHERE SWBSEPG_TERM_CODE = tabCamp(vnI).rTermCode
                AND SWBSEPG_CAMP_CODE = tabCamp(vnI).rCampCode
                AND SWBSEPG_PTRM_CODE = 'GLOBAL';

             DELETE FROM SWBSEPG
              WHERE SWBSEPG_TERM_CODE = tabCamp(vnI).rTermCode
                AND SWBSEPG_CAMP_CODE = tabCamp(vnI).rCampCode
                AND SWBSEPG_PTRM_CODE = tabCamp(vnI).rPtrmCode;

             COMMIT;
         END LOOP;


         --Se calcula el promedio de los cursos
         FOR vnI IN 1..vnRow LOOP


             kwaprsp.PromedioListaCruzada  (tabCamp(vnI).rTermCode,
                                            tabCamp(vnI).rCampCode,
                                            tabCamp(vnI).rPtrmCode,'JobSEPRA1','BEGIN'
                                           );

             kwaprsp.PromedioMaestro       (tabCamp(vnI).rTermCode,
                                            tabCamp(vnI).rCampCode,
                                            tabCamp(vnI).rPtrmCode,'JobSEPRA2','BEGIN'
                                           );

             kwaprsp.PromedioSimultaneo    (tabCamp(vnI).rTermCode,
                                            tabCamp(vnI).rCampCode,
                                            tabCamp(vnI).rPtrmCode,'JobSEPRA3','BEGIN'
                                           );

             kwaprsp.PromedioIndependiente (tabCamp(vnI).rTermCode,
                                            tabCamp(vnI).rCampCode,
                                            tabCamp(vnI).rPtrmCode,'JobSEPRA4','BEGIN'
                                           );

             kwaprsp.InscritosSepradLista  (tabCamp(vnI).rTermCode,
                                            tabCamp(vnI).rCampCode,
                                            tabCamp(vnI).rPtrmCode,'JobSEPRA5','BEGIN'
                                           );

             kwaprsp.InscritosSepradNoLista(tabCamp(vnI).rTermCode,
                                            tabCamp(vnI).rCampCode,
                                            tabCamp(vnI).rPtrmCode,'JobSEPRA6','BEGIN'
                                           );

             kwaprsp.Bruto                 (tabCamp(vnI).rTermCode,
                                            tabCamp(vnI).rCampCode,
                                            tabCamp(vnI).rPtrmCode,'JobSEPRA7','BEGIN'
                                           );

             kwaprsp.PromedioPartePeriodo  (tabCamp(vnI).rTermCode,
                                            tabCamp(vnI).rCampCode,
                                            tabCamp(vnI).rPtrmCode,'JobSEPR10','BEGIN'
                                           );

         END LOOP;


         --se limpia los datos de la tabla
         FOR vnI IN 1..vnRow LOOP
             tabCamp(vnI).rTermCode := NULL;
             tabCamp(vnI).rCampCode := NULL;
             tabCamp(vnI).rPtrmCode := NULL;
         END LOOP;

         vnRow := 0;

         --Se obtiene los campus que estan aplicando el SEPRAD por periodo.
         FOR regCmp IN cuComparativo LOOP
             vnRow := vnRow + 1;

             tabCamp(vnRow).rTermCode := regCmp.termCode;
             tabCamp(vnRow).rCampCode := regCmp.campCode;
         END LOOP;

         --Se calcula el promedio por univeridad y periodo
         FOR vnI IN 1..vnRow LOOP
             kwaprsp.PromedioGlobal(tabCamp(vnI).rTermCode,
                                    tabCamp(vnI).rCampCode,
                                    'GLOBAL','JobSEPRA9','BEGIN'
                                   );

             kwaprsp.TablaBase     (tabCamp(vnI).rTermCode,
                                    tabCamp(vnI).rCampCode,
                                    'JobSEPR11','BEGIN'
                                   );
         END LOOP;

      END IF;

      pdNextDate := TO_DATE(TO_CHAR(SYSDATE+1,'DD/MM/YYYY')||' '||'01:00:00','DD/MM/YYYY HH24:MI:SS');

  END PWJSEPR;
/
DROP PROCEDURE BANINST1.PWLIBVE;

CREATE OR REPLACE PROCEDURE BANINST1.PWLIBVE(psReclDesc VARCHAR2)
IS
/******************************************************************************
PROCEDIMIENTO:          BANINST1.PWLIBVE
OBJETIVO:               Reporte Libro de Venta
AUTORES:                Virgilio De la Cruz Jardn
FECHA:                  07/10/2013
****************************************************************/
   vnTotalMontoBoletas INTEGER:=0;
   vnTotalMontoFacturas INTEGER:=0;
   vnTotalMontoNotCre         INTEGER := 0;
   vnTotalMontoContratosSolos         INTEGER := 0;
   vnRowsContratosSolos  INTEGER := 0;
   vnRowBoletas        INTEGER := 0;
   vnRowFacturas        INTEGER := 0;
   vnRowNotcre        INTEGER := 0;
   vnExistsCntr     INTEGER := 0;
   vnExistsBol     INTEGER := 0;
   vnExistsFac     INTEGER := 0;
   vnExistsNotcre     INTEGER := 0;
   vnColumnas   INTEGER := 9;
   vsMes        VARCHAR2(4);
   vsYear       VARCHAR2(4);
   vsCont       twbcntr.twbcntr_num%TYPE;
   vsId            VARCHAR2(9);
   tabColumna   Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla (1);
   vsInicioPag   VARCHAR2 (10) := NULL;
   flag BOOLEAN;
   csFmt                VARCHAR2(50) := 'fm999,999,999,999,999,999,999,999,999,999';
    csDate                VARCHAR2(20) := 'DD/MM/YYYY';

--Este cursor nos trae los contratos sin boleta ni factura asociada
CURSOR cu_Contratos_sin_bol_y_sin_fac (
  vsMes in varchar2,
  vsYear in VARCHAR2,
  vsCont in twbcntr.twbcntr_num%TYPE,
  vsID in VARCHAR2

   )
  IS
  SELECT
            TWBCNTR_NUM num_cntr,
            TO_CHAR(TWBCNTR_ISSUE_DATE,'DD/MM/YYYY')  fecha_de_generacion_cntr
            , f_get_id(twbcntr_pidm) id_alumno
            , f_get_rut(twbcntr_pidm)  rut_alumno
            ,  f_format_name(twbcntr_pidm, 'LF30')  nombre_alumno
            , f_student_get_desc('stvstst', BANINST1.F_GET_STST_SGB(twbcntr_pidm), 30)  status_alumno
             ,pk_catalogo.programa(TWBCNTR_ORI_PROGRAM)   prog_desc
             ,pk_Matricula.f_MontoContrato(TWBCNTR_NUM) monto
           FROM
            TWBCNTR,
            sgbstdn g1
        WHERE
        g1.sgbstdn_pidm = twbcntr_pidm
        and g1.sgbstdn_term_code_eff =
                    (select max(g2.sgbstdn_term_code_eff)
                       from sgbstdn g2
                      where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
        and twbcntr_status_ind in ( 'A','X')
        and not exists (select 1
                    from twbretr
                    where twbretr_cntr_num = twbcntr_num)
           and  TWBCNTR_STATUS_IND <> 'C'
            AND (vsMes is NULL OR TO_CHAR(TWBCNTR_ISSUE_DATE,'MM')=vsMes)
            AND (vsYear is NULL OR TO_CHAR(TWBCNTR_ISSUE_DATE,'YYYY')=vsYear)
            --and pk_Matricula.f_MontoContrato(TWBCNTR_NUM) > 180
            and (vsCont IS NULL OR vsCont = twbcntr_num)
            and (vsID IS NULL OR vsID = f_get_id(twbcntr_pidm))
      and TWBCNTR_NUM NOT IN ( SELECT TWBBOLE_CNTR_NUM FROM TWBBOLE WHERE TWBBOLE_STATUS_IND ='A')
            and TWBCNTR_NUM NOT IN ( SELECT TWBFCTU_CNTR_NUM FROM TWBFCTU WHERE TWBFCTU_STATUS_IND ='A')
            order by TWBCNTR_ISSUE_DATE;

--Este cursor nos trae los contratos con boleta asignada

CURSOR cu_Boletas (
  vsMes in varchar2,
  vsYear in VARCHAR2,
  vsCont in twbcntr.twbcntr_num%TYPE,
  vsID in VARCHAR2

   )
  IS
       SELECT
            TWBCNTR_NUM num_cntr,
            TO_CHAR(TWBCNTR_ISSUE_DATE,'DD/MM/YYYY')  fecha_de_generacion_cntr
            , f_get_id(twbcntr_pidm) id_alumno
            , f_get_rut(twbcntr_pidm)  rut_alumno
            ,  f_format_name(twbcntr_pidm, 'LF30')  nombre_alumno
            , f_student_get_desc('stvstst', BANINST1.F_GET_STST_SGB(twbcntr_pidm), 30)  status_alumno
             ,pk_catalogo.programa(TWBCNTR_ORI_PROGRAM)   prog_desc
           ,TWBBOLE_BOL_NUM boleta
             ,pk_Matricula.f_MontoContrato(TWBCNTR_NUM) monto
           FROM
            TWBCNTR,
            sgbstdn g1,
            TWBBOLE
        WHERE
        g1.sgbstdn_pidm = twbcntr_pidm
        and g1.sgbstdn_term_code_eff =
                    (select max(g2.sgbstdn_term_code_eff)
                       from sgbstdn g2
                      where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
        and twbcntr_status_ind in ( 'A','X')
        and not exists (select 1
                    from twbretr
                    where twbretr_cntr_num = twbcntr_num)
           and  TWBCNTR_STATUS_IND <> 'C'
            AND (vsMes is NULL OR TO_CHAR(TWBCNTR_ISSUE_DATE,'MM')=vsMes)
            AND (vsYear is NULL OR TO_CHAR(TWBCNTR_ISSUE_DATE,'YYYY')=vsYear)
            --and pk_Matricula.f_MontoContrato(TWBCNTR_NUM) > 180
            and (vsCont IS NULL OR vsCont = twbcntr_num)
            and (vsID IS NULL OR vsID = f_get_id(twbcntr_pidm))
            and TWBBOLE_CNTR_NUM = twbcntr_num
            and TWBBOLE_STATUS_IND = 'A'
            order by TWBCNTR_ISSUE_DATE;

--Este cursor nos trae los contratos con factura asociada
CURSOR cu_Facturas (
  vsMes in varchar2,
  vsYear in VARCHAR2,
  vsCont in twbcntr.twbcntr_num%TYPE,
  vsID in VARCHAR2

   )
  IS
       SELECT
            TWBCNTR_NUM num_cntr,
            TO_CHAR(TWBCNTR_ISSUE_DATE,'DD/MM/YYYY')  fecha_de_generacion_cntr
            , f_get_id(twbcntr_pidm) id_alumno
            , f_get_rut(twbcntr_pidm)  rut_alumno
            ,  f_format_name(twbcntr_pidm, 'LF30')  nombre_alumno
            , f_student_get_desc('stvstst', BANINST1.F_GET_STST_SGB(twbcntr_pidm), 30)  status_alumno
             ,pk_catalogo.programa(TWBCNTR_ORI_PROGRAM)   prog_desc
            ,TWBFCTU_FACT_NUM factura
              ,pk_Matricula.f_MontoContrato(TWBCNTR_NUM) monto
        FROM
            TWBCNTR,
            sgbstdn g1,
            TWBFCTU
        WHERE
        g1.sgbstdn_pidm = twbcntr_pidm
        and g1.sgbstdn_term_code_eff =
                    (select max(g2.sgbstdn_term_code_eff)
                       from sgbstdn g2
                      where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
        and twbcntr_status_ind in ( 'A','X')
        and not exists (select 1
                    from twbretr
                    where twbretr_cntr_num = twbcntr_num)
           and  TWBCNTR_STATUS_IND <> 'C'
            AND (vsMes is NULL OR TO_CHAR(TWBCNTR_ISSUE_DATE,'MM')=vsMes)
            AND (vsYear is NULL OR TO_CHAR(TWBCNTR_ISSUE_DATE,'YYYY')=vsYear)
            --and pk_Matricula.f_MontoContrato(TWBCNTR_NUM) >180
            and (vsCont IS NULL OR vsCont = twbcntr_num)
            and (vsID IS NULL OR vsID = f_get_id(twbcntr_pidm))
            and twbcntr_num = TWBFCTU_CNTR_NUM
            and TWBFCTU_STATUS_IND ='A'
            ORDER BY
            TWBCNTR_ISSUE_DATE;

--Este cursor nos trae los contratos con nota de crdito asociada
CURSOR cu_NotasCredito (
  vsMes in varchar2,
  vsYear in VARCHAR2,
  vsCont in twbcntr.twbcntr_num%TYPE,
  vsID in VARCHAR2

   )
  IS
       SELECT
            TWBCNTR_NUM num_cntr,
            TO_CHAR(TWBCNTR_ISSUE_DATE,'DD/MM/YYYY')  fecha_de_generacion_cntr
            , f_get_id(twbcntr_pidm) id_alumno
            , f_get_rut(twbcntr_pidm)  rut_alumno
            ,  f_format_name(twbcntr_pidm, 'LF30')  nombre_alumno
            , f_student_get_desc('stvstst', BANINST1.F_GET_STST_SGB(twbcntr_pidm), 30)  status_alumno
             ,pk_catalogo.programa(TWBCNTR_ORI_PROGRAM)   prog_desc
              ,TWBNOCR_NOCR_NUM notcredito
              ,pk_Matricula.f_MontoContrato(TWBCNTR_NUM) monto
        FROM
            TWBCNTR,
            sgbstdn g1,
            TWBNOCR
        WHERE
        g1.sgbstdn_pidm = twbcntr_pidm
        and g1.sgbstdn_term_code_eff =
                    (select max(g2.sgbstdn_term_code_eff)
                       from sgbstdn g2
                      where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
        and twbcntr_status_ind in ( 'A','X')
        and not exists (select 1
                    from twbretr
                    where twbretr_cntr_num = twbcntr_num)
           and  TWBCNTR_STATUS_IND <> 'C'
            AND (vsMes is NULL OR TO_CHAR(TWBCNTR_ISSUE_DATE,'MM')=vsMes)
            AND (vsYear is NULL OR TO_CHAR(TWBCNTR_ISSUE_DATE,'YYYY')=vsYear)
            --and pk_Matricula.f_MontoContrato(TWBCNTR_NUM) >180
            and (vsCont IS NULL OR vsCont = twbcntr_num)
            and (vsID IS NULL OR vsID = f_get_id(twbcntr_pidm))
            and twbcntr_num = TWBNOCR_CNTR_NUM
            and TWBNOCR_STATUS_IND ='A'
            ORDER BY
            TWBCNTR_ISSUE_DATE;



BEGIN

    -- valida que el usuario tenga acceso a la base de datos:
    IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

    /* Par?metros */
    --Se busca el valor de la cookie (par?metro) para asignarlo al filtro del query.
    vsYear := pk_ObjHtml.getValueCookie ('psAo');
    vsCont  := pk_ObjHtml.getValueCookie ('psCont');
    vsID    := pk_ObjHtml.getValueCookie ('psID');
    vsMes := pk_ObjHtml.getValueCookie ('psMes');


/*Contratos son facturas ni  boletas asociadas*/
  -- N?mero de columnas de la tabla --
   tabColumna.EXTEND (vnColumnas);


   /* Encabezado de las columnas */
   tabColumna (1) := 'Contrato';
   tabColumna (2) := 'Fecha';
   tabColumna (3) := 'Id';
   tabColumna (4) := 'RUT';
   tabColumna (5) := 'Alumno';
   tabColumna (6) := 'Estatus del Alumno';
   tabColumna (7) := 'Descripcin Programa';
   tabColumna (8) := 'Boleta';
   tabColumna (9) := 'Monto';
     Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag);

      FOR regCntr IN cu_Contratos_sin_bol_y_sin_fac(vsMes,vsYear,vsCont,vsID) LOOP
          IF vnRowsContratosSolos = 0 THEN

              vsInicioPag := 'SALTO';
             vnRowsContratosSolos  := 0;

          END IF;

          htp.p(
          '<tr>
            <td valign="top">'||regCntr.num_cntr||'</td>
            <td valign="top">'||regCntr.fecha_de_generacion_cntr||'</td>
            <td valign="top">'||regCntr.id_alumno||'</td>
            <td valign="top">'||regCntr.rut_alumno ||'</td>
            <td valign="top">'||regCntr.nombre_alumno||'</td>
            <td valign="top">'||regCntr.status_alumno||'</td>
            <td valign="top">'||regCntr.prog_desc ||'</td>
            <td valign="top"> NA</td>
            <td valign="top">'||TO_CHAR(regCntr.monto,csFmt)||'</td></tr>');
            vnTotalMontoContratosSolos :=  vnTotalMontoContratosSolos + regCntr.monto;
          vnExistsCntr   := 1;

          vnRowsContratosSolos      := vnRowsContratosSolos + 1;
      END LOOP;
       htp.p('<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td><b>MONTO TOTAL DE CONTRATOS SIN BOLETA NI FACTURA ASOCIADA</b></td>
       <td><b>' || TO_CHAR(vnTotalMontoContratosSolos,csFmt)||'</td></tr>');
       htp.p('<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td><b>CANTIDAD DE CONTRATOS SIN BOLETA NI FACTURA ASOCIADA</b></td>
       <td><b>' ||TO_CHAR(vnRowsContratosSolos,csFmt)||'</td></tr>');



   IF vnExistsBol = 0
   THEN
           Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);


   END IF;

   HTP.p ('</table><br/>');


/*Boletas*/
  -- N?mero de columnas de la tabla --
   tabColumna.EXTEND (vnColumnas);


   /* Encabezado de las columnas */
   tabColumna (1) := 'Contrato';
   tabColumna (2) := 'Fecha';
   tabColumna (3) := 'Id';
   tabColumna (4) := 'RUT';
   tabColumna (5) := 'Alumno';
   tabColumna (6) := 'Estatus del Alumno';
   tabColumna (7) := 'Descripcin Programa';
   tabColumna (8) := 'Boleta';
   tabColumna (9) := 'Monto';
     Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag);

      FOR regBol IN cu_Boletas(vsMes,vsYear,vsCont,vsID) LOOP
          IF vnRowBoletas = 0 THEN

              vsInicioPag := 'SALTO';
             vnRowBoletas  := 0;

          END IF;

          htp.p(
          '<tr>
            <td valign="top">'||regBol.num_cntr||'</td>
            <td valign="top">'||regBol.fecha_de_generacion_cntr||'</td>
            <td valign="top">'||regBol.id_alumno||'</td>
            <td valign="top">'||regBol.rut_alumno ||'</td>
            <td valign="top">'||regBol.nombre_alumno||'</td>
            <td valign="top">'||regBol.status_alumno||'</td>
            <td valign="top">'||regBol.prog_desc ||'</td>
            <td valign="top">'||regBol.boleta||'</td>
            <td valign="top">'||TO_CHAR(regBol.monto,csFmt)||'</td></tr>');
            vnTotalMontoBoletas := vnTotalMontoBoletas + regBol.monto;
          vnExistsBol   := 1;
          vnRowBoletas      := vnRowBoletas + 1;
      END LOOP;
       htp.p('<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td><b>MONTO TOTAL DE BOLETAS</b></td>
       <td><b>' || TO_CHAR(vnTotalMontoBoletas,csFmt)||'</td></tr>');
       htp.p('<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td><b>CANTIDAD DE BOLETAS</b></td>
       <td><b>' ||TO_CHAR(vnRowBoletas,csFmt)||'</td></tr>');


   IF vnExistsBol = 0
   THEN
           Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);

   END IF;

   HTP.p ('</table><br/>');


   /*facturas*/

      /* Encabezado de las columnas */
   tabColumna (1) := 'Contrato';
   tabColumna (2) := 'Fecha';
   tabColumna (3) := 'Id';
   tabColumna (4) := 'RUT';
   tabColumna (5) := 'Alumno';
   tabColumna (6) := 'Estatus del Alumno';
   tabColumna (7) := 'Descripcin Programa';
   tabColumna (8) := 'Factura';
   tabColumna (9) := 'Monto';
       Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag);

      FOR regFac IN cu_Facturas(vsMes,vsYear,vsCont,vsID) LOOP
          IF vnRowFacturas = 0 THEN

              --vsInicioPag := 'SALTO';
             vnRowFacturas  := 0;

          END IF;
          htp.p(
          '<tr>
            <td valign="top">'||regFac.num_cntr||'</td>
            <td valign="top">'||regFac.fecha_de_generacion_cntr||'</td>
            <td valign="top">'||regFac.id_alumno||'</td>
            <td valign="top">'||regFac.rut_alumno ||'</td>
            <td valign="top">'||regFac.nombre_alumno||'</td>
            <td valign="top">'||regFac.status_alumno||'</td>
            <td valign="top">'||regFac.prog_desc ||'</td>
            <td valign="top">'||regFac.factura||'</td>
            <td valign="top">'||TO_CHAR(regFac.monto,csFmt)||'</td></tr>');
            vnTotalMontoFacturas := vnTotalMontofacturas + regFac.monto;
          vnExistsFac   := 1;
         vnRowFacturas      := vnRowFacturas + 1;
      END LOOP;
       htp.p('<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td><b>MONTO TOTAL DE FACTURAS</b></td>
       <td><b>' || TO_CHAR(vnTotalMontofacturas,csFmt)||'</td></tr>');
       htp.p('<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td><b>CANTIDAD DE  FACTURAS</b></td>
       <td><b>' ||TO_CHAR(vnRowFacturas,csFmt)||'</td></tr>');

   IF vnExistsFac = 0
   THEN
     -- HTP.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
   ELSE
      -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de p?gina para impresion
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- es omitido el encabezado del reporte pero se agrega el salto de pagina
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
   END IF;


    /*notas de credito */
      /* Encabezado de las columnas */
   tabColumna (1) := 'Contrato';
   tabColumna (2) := 'Fecha';
   tabColumna (3) := 'Id';
   tabColumna (4) := 'RUT';
   tabColumna (5) := 'Alumno';
   tabColumna (6) := 'Estatus del Alumno';
   tabColumna (7) := 'Descripcin Programa';
   tabColumna (8) := 'Nota de Crdito';
   tabColumna (9) := 'Monto';
     Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag);

      FOR regNc IN cu_NotasCredito(vsMes,vsYear,vsCont,vsID) LOOP
          IF  vnRowNotcre = 0 THEN
                       vnRowNotcre  := 0;
          END IF;
          htp.p(
          '<tr>
            <td valign="top">'||regNc.num_cntr||'</td>
            <td valign="top">'||regNc.fecha_de_generacion_cntr||'</td>
            <td valign="top">'||regNc.id_alumno||'</td>
            <td valign="top">'||regNc.rut_alumno ||'</td>
            <td valign="top">'||regNc.nombre_alumno||'</td>
            <td valign="top">'||regNc.status_alumno||'</td>
            <td valign="top">'||regNc.prog_desc ||'</td>
            <td valign="top">'||regNc.notcredito||'</td>
            <td valign="top">'||TO_CHAR(regNc.monto,csFmt)||'</td></tr>');
            vnTotalMontoNotCre := vnTotalMontoNotCre + regNc.monto;
          vnExistsNotcre   := 1;
          vnRowNotcre      :=  vnRowNotcre + 1;
      END LOOP;
       htp.p('<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td><b>MONTO TOTAL DE NOTAS DE CREDITO</b></td>
       <td><b>' || TO_CHAR(vnTotalMontoNotCre,csFmt)||'</td></tr>');
       htp.p('<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td><b>CANTIDAD DE NOTAS DE CREDITO</b></td>
       <td><b>' ||TO_CHAR( vnRowNotcre,csFmt)||'</td></tr>');
        htp.p('<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
       <td><b></td></tr>');
         htp.p('<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
       <td><b></td></tr>');
       -- Se calcula el Total Genera de Ventas del Mes
       -- contratos_solos + facturas + boletas - notas_de_credito
       htp.p('<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td><b>TOTAL GENERAL DE VENTAS DEL MES</b></td>
       <td><b>' ||TO_CHAR(vnTotalMontoContratosSolos+vnTotalMontofacturas+vnTotalMontoBoletas-vnTotalMontoNotCre,csFmt)||'</td></tr>');


   IF vnExistsNotcre = 0
   THEN
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
    --HTP.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de p?gina para impresion
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';
      -- es omitido el encabezado del reporte pero se agrega el salto de pagina
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
   END IF;

   HTP.p ('</table><br/>');
   HTP.p ('</body></html>');

EXCEPTION
   WHEN OTHERS
   THEN
       HTP.P ('<font color=#FF0000>' || SQLERRM ||'</font>');
END PWLIBVE;
/


DROP PUBLIC SYNONYM PWLIBVE;

CREATE PUBLIC SYNONYM PWLIBVE FOR BANINST1.PWLIBVE;


GRANT EXECUTE ON BANINST1.PWLIBVE TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWLIBVE TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWLIBVE TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWLIBVE TO WWW2_USER;
DROP PROCEDURE BANINST1.PWMATCO;

CREATE OR REPLACE PROCEDURE BANINST1.PWMATCO (psReclDesc VARCHAR2)
IS
/******************************************************************************
PROCEDIMIENTO:          BANINST1.PWMATCO
OBJETIVO:               Reporte de Matriculados
AUTORES:                Guillermo Almazan Iba?ez
FECHA:                  29/04/2011
Modificacion
  28/Marzo/2012         EAMM       Se quitaron columnas de apoderado y se puso
                                   nueva por cambio de carrera
******************************************************************************/
   vnRow         INTEGER := 0;
   vnExists      INTEGER := 0;
   vnColumnas    INTEGER := 20;
   vsProg        smrprle.smrprle_program_desc%TYPE;
   vsSsts        sgbstdn.sgbstdn_stst_code%TYPE;
   vsType        sgbstdn.sgbstdn_styp_code%TYPE;
   vsYear        VARCHAR2(4);
   vdIni         twbcntr.twbcntr_issue_date%TYPE;
   vdFin         twbcntr.twbcntr_issue_date%TYPE;
   vsCont        twbcntr.twbcntr_num%TYPE;
   tabColumna    Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla (1);
   vsInicioPag   VARCHAR2 (10) := NULL;
   vsTermStatus VARCHAR2(8);
   vsStatusCntr VARCHAR2(8);
   vsStatus 	 sgbstdn.sgbstdn_stst_code%TYPE;
--   vnTest       VARCHAR2(10);
CURSOR cuReporte_Cambio (vsProg in smrprle.smrprle_program_desc%TYPE,
   vsSsts in stvstst.stvstst_code%TYPE,
   vsType in stvstyp.stvstyp_code%TYPE,
   vsYear in VARCHAR2,
   vdIni in twbcntr.twbcntr_issue_date%TYPE,
   vdFin in twbcntr.twbcntr_issue_date%TYPE,
   vsCont in twbcntr.twbcntr_num%TYPE)
  IS
  select anio, contrato, fecha_cntr, monto_cntr, periodo_cntr, tipo_periodo, comm_cntr, id, rut_al, alumno, direccion_al, region_al, comuna_al,
         telefono_al, sexo, coreo_pers, periodo_adm, via, tipo_code, tipo, tipo_alumno, estatus_alumno,
--         actualizacion_estatus,
         program_anterior,
         programa, prog_desc
--    , rut_apoderado, apoderado, direccion_ap, region_ap, comuna_ap, tel_ap_tf, tel_ap_tm, email_pers
  from (select substr(twbcntr_term_code, 1, 4)                                                          anio
       , twbcntr_num                                                                                    contrato
       , twbcntr_status_ind                                                                             status
       , twbcntr_issue_date                                                                             fecha_cntr
       , twbcntr_term_code                                                                              periodo_cntr
       , decode(TWBCNTR_TERM_TYPE, 'A', 'Anual',
                                   '1', 'Primer Semestre',
                                   '2', 'Segundo Semestre',
                                   (select decode(STVTERM_TRMT_CODE, 'A', 'Anual', 'S', 'Semestral')
                                    from STVTERM
                                    where STVTERM_CODE = TWBCNTR_TERM_CODE))                           tipo_periodo
       --, pk_matricula.f_MontoContrato(twbcntr_num)                                                    monto_cntr
       , to_char(pk_matricula.f_MontoContrato(twbcntr_num), pk_contrato.ConstglFormato)                 monto_cntr
       , pk_matricula.f_comecont(twbcntr_num)                                                           comm_cntr
       , f_get_id(twbcntr_pidm)                                                                         id
       , f_get_rut(twbcntr_pidm)                                                                        rut_al
       , f_format_name(twbcntr_pidm, 'LF30')                                                            alumno
       , pk_matricula.f_DirAlumno(twbcntr_pidm)                                                         direccion_al
       , pk_matricula.f_RegAlumno(twbcntr_pidm)                                                         region_al
       , pk_matricula.f_ComuAlumno(twbcntr_pidm)                                                        comuna_al
       , f_get_telefono_al(twbcntr_pidm, 'TFPA')                                                        telefono_al
--       , pk_AdMat.f_get_psu_pond(twbcntr_pidm, twbcntr_term_code)                                       psu
       , f_get_sexo(twbcntr_pidm)                                                                       sexo
       , (
	   		select
	        	goremal_email_address
	     	from
		    	goremal
			where
				goremal_pidm = twbcntr_pidm
				and goremal_emal_code = 'UFT'
				and rownum = 1
	   )                                                                                                coreo_pers
       , sgbstdn_term_code_admit                                                                        periodo_adm
       , pk_catalogo.admision(sgbstdn_admt_code)                                                        via
       , sgbstdn_admt_code                                                                              via_code
       , fwatyaluft(twbcntr_pidm, twbcntr_term_code)                                                    tipo_code
       , decode(fwatyaluft(twbcntr_pidm, twbcntr_term_code),'N','Nuevo Ingreso','A','Avanzado')         tipo
       , pk_catalogo.TipoAlumno(sgbstdn_styp_code)                                                      tipo_alumno
       , f_student_get_desc('stvstst', sgbstdn_stst_code, 30)                                           estatus_alumno
--       , f_get_status(twbcntr_pidm, sgbstdn_stst_code)                                                  actualizacion_estatus
       , F_GET_PROGRAMA_ANT(TWBCNTR_PIDM, TWBCNTR_TERM_CODE, TWBCNTR_ORI_PROGRAM)                       program_anterior
       , TWBCNTR_ORI_PROGRAM                                                                            programa
       , pk_catalogo.programa(TWBCNTR_ORI_PROGRAM)                                                      prog_desc
--       , twbcntr_rut                                                                                    rut_apoderado
--       ,  pk_MatApoderado.f_NombreCompleto(twbcntr_rut)                                                 apoderado
--       , pk_MatApoderado.f_Direccion(twbcntr_rut, twbcntr_term_code)                                    direccion_ap
--       , pk_MatApoderado.f_Region(twbcntr_rut, twbcntr_term_code)                                       region_ap
--       , pk_MatApoderado.f_Comuna(twbcntr_rut, twbcntr_term_code)                                       comuna_ap
--       , pk_MatApoderado.f_Telefono(twbcntr_rut, 'PR', twbcntr_term_code)                               tel_ap_tf
--       , pk_MatApoderado.f_Telefono(twbcntr_rut, 'TMSO', twbcntr_term_code)                             tel_ap_tm
--       , pk_MatApoderado.f_Email(twbcntr_rut, 'PERS', twbcntr_term_code)                                email_pers
from   twbcntr
     , sgbstdn g1
--     , swbfolk sw
where g1.sgbstdn_pidm = twbcntr_pidm
  and g1.sgbstdn_term_code_eff =
                    (select max(g2.sgbstdn_term_code_eff)
                       from sgbstdn g2
                      where g1.sgbstdn_pidm = g2.sgbstdn_pidm)
--  and sw.swbfolk_pidm = twbcntr_pidm
--  and sw.swbfolk_term_code = twbcntr_term_code
--  and sw.swbfolk_rut = twbcntr_rut
  and twbcntr_status_ind = 'A'
  and not exists (select 1
                    from twbretr
                    where twbretr_cntr_num = twbcntr_num)
  and (sgbstdn_stst_code = vsSsts or vsSsts is null)
  and (sgbstdn_styp_code = vsType or vsType is null))
where (programa = vsProg or vsProg is null)

and (periodo_cntr like (vsYear||'%') or vsYear is null)
and (fecha_cntr between vdIni and vdFin or vdFin is null or vdIni is null)
and (contrato = vsCont or vsCont is null);

BEGIN

    IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

    /* Par?metros */
    --Se busca el valor de la cookie (par?metro) para asignarlo al filtro del query.
    vsProg  := pk_ObjHtml.getValueCookie ('psProgr');
    vsSsts  := pk_ObjHtml.getValueCookie ('psSstst');
    vsType  := pk_ObjHtml.getValueCookie ('psTyAl');
    vsYear := pk_ObjHtml.getValueCookie ('psYear');
    vdIni   := pk_ObjHtml.getValueCookie ('pdIni');
    vdFin   := pk_ObjHtml.getValueCookie ('pdFin');
    vsCont  := pk_ObjHtml.getValueCookie ('psCont');

  -- N?mero de columnas de la tabla --
   tabColumna.EXTEND (vnColumnas);

   /* Encabezado de las columnas */
   tabColumna (1) := 'A?o';
   tabColumna (2) := 'Id';
   tabColumna (3) := 'RUT';
   tabColumna (4) := 'Alumno';
   tabColumna (5) := 'Direcci&oacute;n';
   tabColumna (6) := 'Regi&oacute;n';
   tabColumna (7) := 'Comuna';
   tabColumna (8) := 'Tel&eacute;fono';
--   tabColumna (9) := 'Promedio PSU';
   tabColumna (9) := 'Sexo';
   tabColumna (10) := 'E-mail';
   tabColumna (11) := 'Periodo Ingreso';
   tabColumna (12) := 'Periodo Matricula';
   tabColumna (13) := 'Tipo Periodo';
   tabColumna (14) := 'Estatus del Alumno<br>al hacer contrato';
   tabColumna (15) := 'Estatus del Alumno<br>actual';
   tabColumna (16) := 'Periodo Estatus del<br>alumno actual ';
   tabColumna (17) := 'Tipo de Alumno';
--   tabColumna (16) := 'Actualizaci?n Status Alumno ';
   tabColumna (18) := 'Programa Anterior';
   tabColumna (19) := 'Programa';
   tabColumna (20) := 'Descripci&oacute;n Programa';
--   tabColumna (19) := 'Rut Apoderado';
--   tabColumna (20) := 'Apoderado';
--   tabColumna (21) := 'Direcci?n';
--   tabColumna (22) := 'Regi?n';
--   tabColumna (23) := 'Comuna';
--   tabColumna (24) := 'Tel?fono Personal';
--   tabColumna (25) := 'Tel?fono Movil';
--   tabColumna (26) := 'E-mail Personal';


      FOR regRep IN cuReporte_Cambio(vsProg, vsSsts, vsType, vsYear, vdIni, vdFin, vsCont) LOOP
          IF vnRow = 0 THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag);
             vsInicioPag := 'SALTO';
             vnRow  := 0;
          END IF;



     	select sgbstdn_stst_code, sgbstdn_term_code_eff into vsStatus, vsTermStatus from sgbstdn x
    	where x.sgbstdn_pidm = f_Get_pidm(regRep.id)
    	and x.sgbstdn_term_code_eff =
                    (select max(y.sgbstdn_term_code_eff)
                       from sgbstdn y
                      where x.sgbstdn_pidm = y.sgbstdn_pidm);

   --END IF;



--      vnTest := f_Get_pidm(regRep.id);
      BEGIN
      select sgbstdn_stst_code into vsStatusCntr from sgbstdn x
      where x.sgbstdn_pidm = f_Get_pidm(regRep.id)
      and x.sgbstdn_term_code_eff =
                    (select max(y.sgbstdn_term_code_eff)
                      from sgbstdn y
                      where x.sgbstdn_pidm = y.sgbstdn_pidm
                      and y.sgbstdn_term_code_eff <= regRep.periodo_cntr);
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
          vsStatusCntr := '';
      END;


--      select sgbstdn_stst_code into vsStatusCntr from sgbstdn x
--      where x.sgbstdn_pidm = f_Get_pidm(regRep.id)
--      and x.sgbstdn_term_code_eff =
--                    (select max(sgbstdn_term_code_eff)
--                      from sgbstdn
--                      where sgbstdn_pidm = f_Get_pidm(regRep.id));



--      select sgbstdn_stst_code into vsStatusCntr from sgbstdn x
--      where x.sgbstdn_pidm = f_Get_pidm(regRep.id)
--      and x.sgbstdn_term_code_eff =
--                    (select max(y.sgbstdn_term_code_eff)
--                      from sgbstdn y
--                      where x.sgbstdn_pidm = y.sgbstdn_pidm
--                      and y.sgbstdn_term_code_eff<= regRep.periodo_cntr);



          IF vsStatusCntr <> '' THEN
            htp.p(
            '<tr>
            <td valign="top">'||regRep.anio||'</td>
            <td valign="top">'||regRep.id||'</td>
            <td valign="top">'||regRep.rut_al||'</td>
            <td valign="top">'||regRep.alumno||'</td>
            <td valign="top">'||regRep.direccion_al||'</td>
            <td valign="top">'||regRep.region_al||'</td>
            <td valign="top">'||regRep.comuna_al||'</td>
            <td valign="top">'||regRep.telefono_al||'</td>
            <td valign="top">'||regRep.sexo||'</td>
            <td valign="top">'||regRep.coreo_pers||'</td>
            <td valign="top">'||regRep.periodo_adm||'</td>
            <td valign="top">'||regRep.periodo_cntr||'</td>
            <td valign="top">'||regRep.tipo_periodo||'</td>
            <td valign="top">'||f_student_get_desc('stvstst', vsStatusCntr, 30)||'</td>
            <td valign="top">'||f_student_get_desc('stvstst', vsStatus, 30)||'</td>
            <td valign="top">'||vsTermStatus||'</td>
            <td valign="top">'||regRep.tipo_alumno||'</td>
            <td valign="top">'||regRep.program_anterior||'</td>
            <td valign="top">'||regRep.programa||'</td>
            <td valign="top">'||regRep.prog_desc||'</td>');

          ELSE
            htp.p(
            '<tr>
            <td valign="top">'||regRep.anio||'</td>
            <td valign="top">'||regRep.id||'</td>
            <td valign="top">'||regRep.rut_al||'</td>
            <td valign="top">'||regRep.alumno||'</td>
            <td valign="top">'||regRep.direccion_al||'</td>
            <td valign="top">'||regRep.region_al||'</td>
            <td valign="top">'||regRep.comuna_al||'</td>
            <td valign="top">'||regRep.telefono_al||'</td>
            <td valign="top">'||regRep.sexo||'</td>
            <td valign="top">'||regRep.coreo_pers||'</td>
            <td valign="top">'||regRep.periodo_adm||'</td>
            <td valign="top">'||regRep.periodo_cntr||'</td>
            <td valign="top">'||regRep.tipo_periodo||'</td>
            <td valign="top">'||f_student_get_desc('stvstst',vsStatusCntr,30)||'</td>
            <td valign="top">'||f_student_get_desc('stvstst', vsStatus, 30)||'</td>
            <td valign="top">'||vsTermStatus||'</td>
            <td valign="top">'||regRep.tipo_alumno||'</td>
            <td valign="top">'||regRep.program_anterior||'</td>
            <td valign="top">'||regRep.programa||'</td>
            <td valign="top">'||regRep.prog_desc||'</td>');
          END IF;

          vnExists   := 1;
          vnRow      := vnRow + 1;
      END LOOP;

   IF vnExists = 0 THEN
      HTP.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de p?gina para impresion
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- es omitido el encabezado del reporte pero se agrega el salto de pagina
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
   END IF;

   HTP.p ('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
      HTP.P (SQLERRM);
      htp.p('<br>');
      htp.p(DBMS_UTILITY.format_error_backtrace);
--      htp.p('<br>');
--      htp.p(vnTest);
END PWMATCO;
/


DROP PUBLIC SYNONYM PWMATCO;

CREATE PUBLIC SYNONYM PWMATCO FOR BANINST1.PWMATCO;


GRANT EXECUTE ON BANINST1.PWMATCO TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWMATCO TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWMATCO TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWMATCO TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWMATCO TO WWW2_USER;
DROP PROCEDURE BANINST1.PWPMODT;

CREATE OR REPLACE PROCEDURE BANINST1.PWPMODT (psPeriodo VARCHAR DEFAULT NULL,
                                              psFecha VARCHAR DEFAULT NULL
                                              ) AS
    /******************************************************************************
    PROCEDIMIENTO:       PWPMODT
    OBJETIVO:            Extrae informacin de montos de morosidad por Alumno, contrato y documento de un query, insertando en la tabla TAISMGR.TWRMRDT
    REQUIRIMIENTO:       Antes de llamar a ejecutar este procedimiento, validar que se haya ejecutado este insert
    INSERT INTO SOBSEQN (SOBSEQN_FUNCTION,SOBSEQN_SEQNO_PREFIX,SOBSEQN_MAXSEQNO,SOBSEQN_ACTIVITY_DATE) VALUES ('REPORT_SEQ_DT',NULL,0,SYSDATE);
    COMMIT;

    PARAMETROS:
    psPeriodo:           Periodo lectivo del documento
    psFECHA:             Fecha expirada del documento

    AUTOR:               Jos Juan Ochoa
    FECHA:               20130613
    ******************************************************************************/
    -- Variable que almacena numero de sequencia
    vnMorosos    NUMBER :=0;

    -- Variable que almecena fecha de ejecucin del reporte
    vsDate       DATE   := sysdate;

    -- Variable que almacena numero de reporte
    vsReport_Seq   NUMBER := BANINST1.pk_Util.f_NumSec('REPORT_SEQ_DT');

    vnNumErr       NUMBER         :=0;
    vsMsg          VARCHAR2 (9999):= '';
    vdInicial      DATE;
    vdFinal        DATE;
    vsPeriodo      VARCHAR2 (999) := '';
    vsFecha        VARCHAR2 (999) := '';
    vsFechaI       VARCHAR2 (999) := '';
    vsPrograma     VARCHAR2 (14)  := '';
    vsStatusAlum   VARCHAR2 (4)   := '';
    vsPeriodoAd    VARCHAR2 (8)   := '';
    vsCode         VARCHAR2 (8)   := '';
    vsNumContrato  VARCHAR2 (14)  := '';
    vsPeriContrato VARCHAR2 (10)   := '';
    vnPidm         NUMBER(8)      :=0;

    csO        CONSTANT VARCHAR2(3)  := 'O';
    csEsp      CONSTANT VARCHAR2(1)  := ' ';
    csSesp     CONSTANT VARCHAR2(1)  := '';
    csC        CONSTANT VARCHAR2(3)  := 'C';
    csY        CONSTANT VARCHAR2(3)  := 'Y';
    csCAE      CONSTANT VARCHAR2(5)  := 'CAE';
    csBEC      CONSTANT VARCHAR2(5)  := 'BEC';
    csCA       CONSTANT VARCHAR2(4)  := 'CA';
    csRP       CONSTANT VARCHAR2(4)  := 'RP';
    csRV       CONSTANT VARCHAR2(4)  := 'RV';
    cs201399   CONSTANT VARCHAR2(6)  := '201399';
    csPAGADO   CONSTANT VARCHAR2(8)  := 'PAGADO';
    csPWPMODT  CONSTANT VARCHAR2(7)  := 'PWPMODT';
    csVIGENTE  CONSTANT VARCHAR2(9)  := 'VIGENTE';
    csDDMMRRRR CONSTANT VARCHAR2(12) := 'DD/MM/YYYY';
    csHHMISS   CONSTANT VARCHAR2(12)  :='HH24:MI:SS';
    cdHH24MISS CONSTANT VARCHAR2(24)  :='DD/MM/YYYY HH24:MI:SS';


    cn0        CONSTANT NUMBER(1)    := 0;
    cn1        CONSTANT NUMBER(1)    := 1;
    cn30       CONSTANT NUMBER(2)    := 30;
    cn90       CONSTANT NUMBER(2)    := 90;
    cn180      CONSTANT NUMBER(3)    := 180;

    -- CONTRATO
    vsQueryCtr    VARCHAR2(500) :=
               'SELECT TWBCNTR_PIDM,
                       TWBCNTR_NUM,
                       TWBCNTR_TERM_CODE
                  FROM TWBCNTR ';
--                                                 where twbcntr_pidm = 3022';

     vsQueryDoc    VARCHAR2(32765) := '';

     /** Entity record type CTR*/
     TYPE CTR_REC IS RECORD (
      R_PIDM       TWBCNTR.TWBCNTR_PIDM%TYPE,
      R_NUM        TWBCNTR.TWBCNTR_NUM%TYPE,
      R_TERM_CODE  TWBCNTR.TWBCNTR_TERM_CODE%TYPE);

    /** Entity cursor variable type CTR*/
    TYPE CTR_SET IS TABLE OF  CTR_REC;
    CTR_ITEMS CTR_SET;


     /** Entity record type DOC*/
     TYPE DOC_REC IS RECORD (
     MORO_PIDM        TWRMRDT.TWRMRDT_PIDM%TYPE,
     MORO_PERI_CNTR   TWRMRDT.TWRMRDT_CNTR_TERM_CODE%TYPE,
     MORO_PERI_DOCU   TWRMRDT.TWRMRDT_DOCU_TERM_CODE%TYPE,
     DOCU_SEQ         TWRMRDT.TWRMRDT_DOCU_SEQ%TYPE,
     DOCU_NUM         TWRMRDT.TWRMRDT_DOCU_NUM%TYPE,
     MORO_PROG        TWRMRDT.TWRMRDT_PROGRAM_CODE%TYPE,
     MORO_CNTR        TWRMRDT.TWRMRDT_CNTR_NUM%TYPE,
     MORO_AMOUNT      TWRMRDT.TWRMRDT_AMOUNT%TYPE,
     MORO_PAYM        TWRMRDT.TWRMRDT_PAYM_CODE%TYPE,
     MORO_STST        TWRMRDT.TWRMRDT_STST_CODE%TYPE,
     MORO_TERM        TWRMRDT.TWRMRDT_TERM_CODE_ADMIT%TYPE,
     MORO_STU         TWRMRDT.TWRMRDT_STU_RUT%TYPE,
     MORO_MORA_30     TWRMRDT.TWRMRDT_MORA_30%TYPE,
     MORO_MORA_90     TWRMRDT.TWRMRDT_MORA_90%TYPE,
     MORO_MORA_180    TWRMRDT.TWRMRDT_MORA_180%TYPE,
     MORO_MORA_MAYOR  TWRMRDT.TWRMRDT_MORA_MAYOR%TYPE,
     MORO_TOTAL_MORA  TWRMRDT.TWRMRDT_TOTAL_MORA%TYPE,
     MORO_TOTAL_CAE   TWRMRDT.TWRMRDT_TOTAL_CAE%TYPE,
     MORO_TOTAL_BECA  TWRMRDT.TWRMRDT_TOTAL_BECAS%TYPE,
     CODE             TWRMRDT.TWRMRDT_SBGI_CODE%TYPE);


    /** Entity cursor variable type DOC*/
    TYPE DOC_SET IS TABLE OF  DOC_REC;
    regDoc DOC_SET;

    BEGIN

      vdInicial := SYSDATE;

      vsPeriodo := psPeriodo;
      vsFecha   := psFecha;
      --vsFechaI  := vsFecha||' '||TO_CHAR(vsDate, csHHMISS);




      IF vsPeriodo IS NOT NULL THEN
       vsQueryCtr := vsQueryCtr || ' WHERE TWBCNTR_TERM_CODE = '||vsPeriodo;
      END IF;


      EXECUTE IMMEDIATE vsQueryCtr BULK COLLECT INTO CTR_ITEMS;

      IF CTR_ITEMS IS NOT NULL THEN IF CTR_ITEMS.COUNT > 0 THEN
        FOR I IN CTR_ITEMS.FIRST..CTR_ITEMS.LAST LOOP

          vsPrograma     := '';
          vsStatusAlum   := '';
          vsPeriodoAd    := '';
          vsCode         := '';
          vsNumContrato  := '';
          vsPeriContrato := '';
          vnPidm         := 0;

           BEGIN
           -- GASTON,
           --CURSOR cu_gst(vnPidm NUMBER) IS
                  SELECT NVL(a.SGBSTDN_PROGRAM_1,'S_PRG'),
                         NVL(a.SGBSTDN_STST_CODE,'ST'),
                         NVL(SGBSTDN_TERM_CODE_ADMIT,'S_PER')
                    INTO vsPrograma,
                    vsStatusAlum,
                    vsPeriodoAd
                    FROM SGBSTDN a
                   WHERE a.SGBSTDN_TERM_CODE_EFF =
                         (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                            FROM SGBSTDN B
                           WHERE B.SGBSTDN_PIDM = CTR_ITEMS(I).R_PIDM
                             AND B.SGBSTDN_TERM_CODE_EFF <= cs201399)
                     AND A.SGBSTDN_PIDM = CTR_ITEMS(I).R_PIDM;
                                     --and a.sgbstdn_pidm = 3022;

           EXCEPTION
                    WHEN OTHERS
                        THEN
                           vnNumErr     := SQLCODE;
                           vsMsg        := SUBSTR (SQLERRM, 1, 900);
                           vsPrograma   := 'S_PRG';--NULL;
                           vsStatusAlum := 'ST';--NULL;
                           vsPeriodoAd  := 'S_PER';--NULL;
                           INSERT INTO GWBEMRA (GWBEMRA_NUM, GWBEMRA_MSG, GWBEMRA_FECHA)
                                VALUES (vnNumErr, 'SGBSTDN:'||CTR_ITEMS(I).R_PIDM||':'||SUBSTR (vsMsg, 1, 900), SYSDATE);
           END;

           BEGIN
           -- CODE
           --CURSOR cu_stv(vnPidm NUMBER) IS
                  SELECT NVL(MAX(STVSBGI_CODE),'S_COD') Code
                    INTO vsCode
                    FROM STVSBGI,SORHSCH
                   WHERE STVSBGI_CODE = SORHSCH_SBGI_CODE
                     AND SORHSCH_PIDM= CTR_ITEMS(I).R_PIDM;
                                                  --and sorhsch_pidm = 3022;


           EXCEPTION
                    WHEN OTHERS
                        THEN
                           vnNumErr := SQLCODE;
                           vsMsg    := SUBSTR (SQLERRM, 1, 900);
                           vsCode   := 'S_COD';
                           INSERT INTO GWBEMRA (GWBEMRA_NUM, GWBEMRA_MSG, GWBEMRA_FECHA)
                                VALUES (vnNumErr, 'STVSBGI,SORHSCH:'||SUBSTR (vsMsg, 1, 950), SYSDATE);

           END;

          vsNumContrato  := CTR_ITEMS(I).R_NUM;
          vsPeriContrato := CTR_ITEMS(I).R_TERM_CODE;
          vnPidm         := CTR_ITEMS(I).R_PIDM;


--          INSERT INTO UNO VALUES('vsPrograma:'||vsPrograma||':vsStatusAlum:'||vsStatusAlum,
--                                 'vsPeriodoAd:'||vsPeriodoAd||':vsCode:'||vsCode,
--                                 'vsNumContrato:'||vsNumContrato||':vsPeriContrato:'||vsPeriContrato||':vnPidm:'||vnPidm); COMMIT;

                    for regDoc in (
                    SELECT q2.TWBDOCU_PIDM         MORO_PIDM,
                           vsPeriContrato          MORO_PERI_CNTR,
                           q2.TWBDOCU_TERM_CODE    MORO_PERI_DOCU,
                           q2.TWBDOCU_SEQ_NUM      DOCU_SEQ,
                           q2.TWBDOCU_DOCU_NUM     DOCU_NUM,
                           vsPrograma              MORO_PROG,
                           vsNumContrato           MORO_CNTR,
                           SUM( (SELECT SUM(twbdocu_amount)
                                   FROM twbdocu, twrdotr
                                  WHERE TWBDOCU_CNTR_NUM = vsNumContrato
                                    AND twrdotr_docu_Seq_num = twbdocu_Seq_num
                                    AND twrdotr_orig_ind = csO)
                           )                       MORO_AMOUNT,
                           q2.TWBDOCU_PAYM_CODE    MORO_PAYM,
                           vsStatusAlum            MORO_STST,
                           vsPeriodoAd             MORO_TERM,
                           SPBPERS_NAME_SUFFIX     MORO_STU,
                           SUM(q2.menores30)       MORO_MORA_30,
                           SUM(q2.menores3090)     MORO_MORA_90,
                           SUM(q2.menores90180)    MORO_MORA_180,
                           SUM(q2.mas180)          MORO_MORA_MAYOR,
                           SUM(NVL(q2.menores30,cn0)+
                           NVL(q2.menores3090,cn0)+
                           NVL(q2.menores90180,cn0)+
                           NVL(q2.mas180,cn0))     MORO_TOTAL_MORA,
                           MontoCae.TotalCae       MORO_TOTAL_CAE,
                           Beca.TotalBeca          MORO_TOTAL_BECA,
                           vsCode                  CODE
                      FROM SPRIDEN, SPBPERS,
                           (SELECT SUM(TWBDOCU_AMOUNT)  TotalCae,
                                   TWBDOCU_PIDM         Pidm,
                                   TWBDOCU_TERM_CODE    Periodo
                              FROM TWBDOCU
                             WHERE TWBDOCU_PAYM_CODE = csCAE
                               AND TWBDOCU_STATUS_IND NOT IN (csCA,csRP,csRV)
                               AND TWBDOCU_PIDM = vnPidm
                               AND TWBDOCU_CNTR_NUM  = vsNumContrato
                               AND TWBDOCU_TERM_CODE = vsPeriContrato
                             GROUP BY  TWBDOCU_PIDM, TWBDOCU_TERM_CODE                              ) MontoCae,
                           (SELECT TWBDOCU_PIDM         Pidm,
                                   TWBDOCU_TERM_CODE    Periodo,
                                   SUM(TWBDOCU_AMOUNT)  TotalBeca
                              FROM twbdocu
                             WHERE EXISTS( SELECT cn1
                                             FROM TWBCNTR
                                            WHERE TWBCNTR_NUM = TWBDOCU_CNTR_NUM
                                              AND TWBCNTR_PIDM = vnPidm
                                              AND TWBDOCU_STATUS_IND <> csC)
                                              AND EXISTS( SELECT cn1
                                                            FROM twrbast
                                                           WHERE twrbast_status_ind = twbdocu_status_ind
                                                             AND twrbast_code = csPAGADO)
                                                             AND ( twbdocu_paym_code = csBEC
                                                                   OR EXISTS( SELECT cn1
                                                                                FROM TWRDOBE
                                                                               WHERE twrdobe_paym_code = twbdocu_paym_code
                                                                             ))
                                                             AND NOT EXISTS( SELECT cn1
                                                                               FROM TWBRETR
                                                                              WHERE TWBRETR_CNTR_NUM = TWBDOCU_CNTR_NUM
                                                                           )
                                                           GROUP BY  TWBDOCU_PIDM, TWBDOCU_TERM_CODE) Beca,
                           (SELECT q1.TWBDOCU_PIDM,
                                   q1.TWBDOCU_TERM_CODE,
                                   q1.TWBDOCU_SEQ_NUM,
                                   q1.TWBDOCU_DOCU_NUM,
                                   q1.TWBDOCU_CNTR_NUM,
                                   q1.TWBDOCU_PAYM_CODE,
                                   CASE
                                      WHEN q1.dias <=cn30
                                       AND q1.dias >cn0
                                      THEN twbdocu_amount
                                   END menores30,
                                   CASE
                                      WHEN q1.dias >cn30
                                       AND q1.dias<=cn90
                                      THEN twbdocu_amount
                                   END menores3090,
                                   CASE
                                      WHEN q1.dias >cn90
                                       AND q1.dias <=cn180
                                      THEN twbdocu_amount
                                   END menores90180,
                                   CASE
                                      WHEN q1.dias >cn180
                                      THEN twbdocu_amount
                                   END mas180
                                   FROM (
                                   SELECT TWBDOCU_PIDM,
                                          TWBDOCU_TERM_CODE,
                                          TWBDOCU_SEQ_NUM,
                                          TWBDOCU_DOCU_NUM,
                                          TWBDOCU_CNTR_NUM,
                                          TWBDOCU_PAYM_CODE,
                                          TWBDOCU_AMOUNT,
                                          TO_DATE(vsFecha,csDDMMRRRR)-TRUNC(TWBDOCU_EXPIRATION_DATE) dias
                                     FROM TWBDOCU
                                    WHERE EXISTS (SELECT cn1
                                                    FROM TWRBAST
                                                   WHERE TWRBAST_CODE = csVIGENTE
                                                     AND TWRBAST_STATUS_IND = TWBDOCU_STATUS_IND
                                                 )
                                      AND TRUNC(TWBDOCU_EXPIRATION_DATE) <= TO_DATE(vsFecha,csDDMMRRRR)
                                      AND TWBDOCU_PIDM = vnPidm
                                      AND TWBDOCU_CNTR_NUM  = vsNumContrato
                                      AND TWBDOCU_TERM_CODE = vsPeriContrato
                                       --                                                                     and twbdocu_pidm = 3022
                                   ) q1
                           ) q2
                     WHERE SPRIDEN_CHANGE_IND IS NULL
                       AND SPRIDEN_PIDM    = q2.TWBDOCU_PIDM
                       AND SPBPERS_PIDM(+) = q2.TWBDOCU_PIDM
                       AND q2.TWBDOCU_PIDM = MontoCae.Pidm(+)
                       AND q2.TWBDOCU_TERM_CODE = MontoCae.Periodo(+)
                       AND q2.TWBDOCU_PIDM = Beca.Pidm(+)
                       AND q2.TWBDOCU_TERM_CODE = Beca.Periodo(+)
                    HAVING SUM(NVL(q2.menores30   ,cn0)+
                           NVL(q2.menores3090 ,cn0)+
                           NVL(q2.menores90180,cn0)+
                           NVL(q2.mas180, cn0)) > cn0
                     GROUP BY q2.TWBDOCU_PIDM,
                     vsPeriContrato,
                     q2.TWBDOCU_TERM_CODE,
                     q2.TWBDOCU_SEQ_NUM,
                     q2.TWBDOCU_DOCU_NUM,
                     vsPrograma,
                     vsNumContrato,
                     q2.TWBDOCU_PAYM_CODE,
                     vsStatusAlum,
                     vsPeriodoAd,
                     SPBPERS_NAME_SUFFIX,
                     MontoCae.TotalCae,
                     Beca.TotalBeca,
                     vsCode ) LOOP

                   BEGIN


                    vnMorosos := vnMorosos + 1;
                    INSERT INTO TAISMGR.TWRMRDT
                               (TWRMRDT_REPORT_SEQ,
                                TWRMRDT_SEQ_NO,
                                TWRMRDT_PIDM,
                                TWRMRDT_CNTR_TERM_CODE,
                                TWRMRDT_DOCU_TERM_CODE,
                                TWRMRDT_DOCU_SEQ,
                                TWRMRDT_DOCU_NUM,
                                TWRMRDT_PROGRAM_CODE,
                                TWRMRDT_CNTR_NUM,
                                TWRMRDT_AMOUNT,
                                TWRMRDT_PAYM_CODE,
                                TWRMRDT_STST_CODE,
                                TWRMRDT_TERM_CODE_ADMIT,
                                TWRMRDT_STU_RUT,
                                TWRMRDT_MORA_30,
                                TWRMRDT_MORA_90,
                                TWRMRDT_MORA_180,
                                TWRMRDT_MORA_MAYOR,
                                TWRMRDT_TOTAL_MORA,
                                TWRMRDT_TOTAL_CAE,
                                TWRMRDT_TOTAL_BECAS,
                                TWRMRDT_SBGI_CODE,
                                TWRMRDT_ACTIVITY_DATE,
                                TWRMRDT_USER_ID,
                                TWRMRDT_CUT_DATE,
                                TWRMRDT_RANK_DATE)
                    VALUES(vsReport_Seq,
                           vnMorosos,
                           regDoc.MORO_PIDM,
                           regDoc.MORO_PERI_CNTR,
                           regDoc.MORO_PERI_DOCU,
                           regDoc.DOCU_SEQ,
                           regDoc.DOCU_NUM,
                           regDoc.MORO_PROG,
                           regDoc.MORO_CNTR,
                           regDoc.MORO_AMOUNT,
                           regDoc.MORO_PAYM,
                           regDoc.MORO_STST,
                           regDoc.MORO_TERM,
                           regDoc.MORO_STU,
                           regDoc.MORO_MORA_30,
                           regDoc.MORO_MORA_90,
                           regDoc.MORO_MORA_180,
                           regDoc.MORO_MORA_MAYOR,
                           regDoc.MORO_TOTAL_MORA,
                           regDoc.MORO_TOTAL_CAE,
                           regDoc.MORO_TOTAL_BECA,
                           regDoc.CODE,
                           vsDate,
                           USER,
                           TO_CHAR(vsDate,  csDDMMRRRR),
                           TO_DATE(psFECHA||TO_CHAR(SYSDATE, csHHMISS),cdHH24MISS)
                           );

                   EXCEPTION
                      WHEN OTHERS
                          THEN
                             vnNumErr := SQLCODE;
                             vsMsg    := SUBSTR (SQLERRM, 1, 900);

                             INSERT INTO GWBEMRA (GWBEMRA_NUM, GWBEMRA_MSG, GWBEMRA_FECHA)
                                  VALUES (vnNumErr, 'insert'||'vsPrograma:'||vsPrograma||':vsStatusAlum:'||
                                  vsStatusAlum||'vsPeriodoAd:'||vsPeriodoAd||':vsCode:'||vsCode||'vsNumContrato:'||
                                  vsNumContrato||':vsPeriContrato:'||vsPeriContrato||':vnPidm:'||
                                  vnPidm||'-'||SUBSTR (vsMsg, 1, 850), SYSDATE);



                   END;
                  END LOOP;

      END LOOP;
      END IF; END IF;
    vdFinal := SYSDATE;
    INSERT INTO GWBTMRA VALUES (vsReport_Seq,vdInicial, vdFinal,
                                  vnMorosos, vsPeriodo ,vsFecha,
                                  csPWPMODT, vsDate);

      COMMIT;

    EXCEPTION
      WHEN NO_DATA_FOUND  THEN
         vnNumErr := SQLCODE;
         vsMsg    := 'SIN DATOS ' || SQLERRM;

         INSERT INTO GWBEMRA (GWBEMRA_NUM, GWBEMRA_MSG, GWBEMRA_FECHA)
              VALUES (vnNumErr, SUBSTR (vsMsg, 1, 950), SYSDATE);

         COMMIT;
         HTP.P(SQLERRM);
      WHEN TOO_MANY_ROWS  THEN
         vnNumErr := SQLCODE;
         vsMsg    := 'MAS DE 1 REGISTRO ' || SQLERRM;

         INSERT INTO GWBEMRA (GWBEMRA_NUM, GWBEMRA_MSG, GWBEMRA_FECHA)
              VALUES (vnNumErr, SUBSTR (vsMsg, 1, 950), SYSDATE);

         COMMIT;
      WHEN TIMEOUT_ON_RESOURCE
      THEN
         vnNumErr := SQLCODE;
         vsMsg    := 'TIEMPO DE ESPERA TERMINADO ' || SQLERRM;

         INSERT INTO GWBEMRA (GWBEMRA_NUM, GWBEMRA_MSG, GWBEMRA_FECHA)
              VALUES (vnNumErr, SUBSTR (vsMsg, 1, 950), SYSDATE);

         COMMIT;

      WHEN ROWTYPE_MISMATCH
      THEN
         vnNumErr := SQLCODE;
         vsMsg    := 'TIPOS DE DATOS INCOMPATIBLES ' || SQLERRM;

         INSERT INTO GWBEMRA (GWBEMRA_NUM, GWBEMRA_MSG, GWBEMRA_FECHA)
              VALUES (vnNumErr, SUBSTR (vsMsg, 1, 950), SYSDATE);

         COMMIT;
         HTP.P(SQLERRM);
      WHEN DUP_VAL_ON_INDEX
      THEN
         vnNumErr := SQLCODE;
         vsMsg    := 'PK REPETIDA' || SQLERRM;

         INSERT INTO GWBEMRA (GWBEMRA_NUM, GWBEMRA_MSG, GWBEMRA_FECHA)
              VALUES (vnNumErr, SUBSTR (vsMsg, 1, 950), SYSDATE);

         COMMIT;
         HTP.P(SQLERRM);
      WHEN OTHERS
      THEN
         vnNumErr := SQLCODE;
         vsMsg    := 'OTRO' ||SQLERRM;

         INSERT INTO GWBEMRA (GWBEMRA_NUM, GWBEMRA_MSG, GWBEMRA_FECHA)
              VALUES (vnNumErr, SUBSTR (vsMsg, 1, 950), SYSDATE);

         COMMIT;
         HTP.P(SQLERRM);
         RAISE;
END;
/
DROP PROCEDURE BANINST1.PWPMORA;

CREATE OR REPLACE PROCEDURE BANINST1.PWPMORA (psPeriodo VARCHAR,
                                              psFecha VARCHAR
                                              ) AS




    /******************************************************************************
    PROCEDIMIENTO:       PWPMORA
    OBJETIVO:            Extrae informacin de montos de morosidad de un query, insertando en la tabla TAISMGR.TWRMORO
    REQUIRIMIENTO:       Antes de llamar a ejecutar este procedimiento, validar que se haya ejecutado este insert
    INSERT INTO SOBSEQN (SOBSEQN_FUNCTION,SOBSEQN_SEQNO_PREFIX,SOBSEQN_MAXSEQNO,SOBSEQN_ACTIVITY_DATE) VALUES ('REPORT_SEQ',NULL,0,SYSDATE);
    COMMIT;

    PARAMETROS:
    psPeriodo:           Periodo lectivo del documento
    psFECHA:             Fecha expirada del documento

    AUTOR:               Jos Juan Ochoa
    FECHA:               20130613
    ******************************************************************************/
    -- Variable que almacena numero de sequencia
    vnMorosos    NUMBER :=0;

    -- Variable que almecena fecha de ejecucin del reporte
    vsDate       DATE   := sysdate;

    -- Variable que almacena numero de reporte
    vsReport_Seq NUMBER := BANINST1.pk_Util.f_NumSec('REPORT_SEQ');

    vnNumErr     NUMBER;
    vsMsg        VARCHAR2 (9999);
    vdInicial    DATE;
    vdFinal      DATE;
    vsPeriodo    VARCHAR2 (999);
    vsFecha      VARCHAR2 (999);


    csO        CONSTANT VARCHAR2(1)  := 'O';
    csEsp      CONSTANT VARCHAR2(1)  := ' ';
    csSesp     CONSTANT VARCHAR2(1)  := '';
    csC        CONSTANT VARCHAR2(1)  := 'C';
    csY        CONSTANT VARCHAR2(1)  := 'Y';
    csCAE      CONSTANT VARCHAR2(3)  := 'CAE';
    csBEC      CONSTANT VARCHAR2(3)  := 'BEC';
    csCA       CONSTANT VARCHAR2(2)  := 'CA';
    csRP       CONSTANT VARCHAR2(2)  := 'RP';
    csRV       CONSTANT VARCHAR2(2)  := 'RV';
    cs201399   CONSTANT VARCHAR2(6)  := '201399';
    csPAGADO   CONSTANT VARCHAR2(6)  := 'PAGADO';
    csVIGENTE  CONSTANT VARCHAR2(7)  := 'VIGENTE';
    csDDMMRRRR CONSTANT VARCHAR2(10) := 'DD/MM/YYYY';
    csHHMISS   CONSTANT VARCHAR2(10)  := 'HH24:MI:SS';
    cdHH24MISS CONSTANT VARCHAR2(22)  := 'DD/MM/YYYY HH24:MI:SS';


    cn0        CONSTANT NUMBER(1)    := 0;
    cn1        CONSTANT NUMBER(1)    := 1;
    cn30       CONSTANT NUMBER(2)    := 30;
    cn90       CONSTANT NUMBER(2)    := 90;
    cn180      CONSTANT NUMBER(3)    := 180;

      CURSOR cu_moro(psPer VARCHAR,
                     psFec VARCHAR) IS
           SELECT PIDM        MORO_PIDM, PERICONTRATO MORO_PERI_CNTR, DOCU_TERM_CODE MORO_DOCU,
                  PROGR       MORO_PROG, NUMCONT      MORO_CNTR, AMOUNT         MORO_AMOUNT,
                  PAYM_CODE   MORO_PAYM, STATUSALUM   MORO_STST, PERIODOAD      MORO_TERM,
                  NAME_SUFFIX MORO_STU,
                 SUM(MENORES30)    MORO_MORA_30,  SUM(MENORES3090) MORO_MORA_90,
                 SUM(MENORES90180) MORO_MORA_180, SUM(MAS180)  MORO_MORA_MAYOR, SUM(MAS1802)     MORO_TOTAL_MORA,
                 TOTALCAE   MORO_TOTAL_CAE,
                 TOTALBECA  MORO_TOTAL_BECA,
                 CODE       MORO_SBGI_CODE
            FROM(
             SELECT q2.TWBDOCU_PIDM                                      PIDM,
                    Contrato.PeriContrato                                PERICONTRATO,
                    q2.TWBDOCU_TERM_CODE                                 DOCU_TERM_CODE,
                    gaston.programa                                      PROGR,
                    Contrato.NumContrato                                 NUMCONT,
                    (SELECT SUM(twbdocu_amount)
                       FROM twbdocu, twrdotr
                      WHERE TWBDOCU_CNTR_NUM = Contrato.NumContrato
                        AND twrdotr_docu_Seq_num = twbdocu_Seq_num
                        AND twrdotr_orig_ind = csO)                      AMOUNT,
                    q2.TWBDOCU_PAYM_CODE                                 PAYM_CODE,
                    gaston.StatusAlum                                    STATUSALUM,
                    gaston.PeriodoAd                                     PERIODOAD,
                    SPBPERS_NAME_SUFFIX                                  NAME_SUFFIX,
                    SUM(q2.menores30)                                    MENORES30,
                    SUM(q2.menores3090)                                  MENORES3090,
                    SUM(q2.menores90180)                                 MENORES90180,
                    SUM(q2.mas180)                                       MAS180,
                    SUM(NVL(q2.menores30,cn0)+
                        NVL(q2.menores3090,cn0)+
                        NVL(q2.menores90180,cn0)+
                        NVL(q2.mas180,cn0))                              MAS1802,
                    MontoCae.TotalCae                                    TOTALCAE,
                    Beca.TotalBeca                                       TOTALBECA,
                    (SELECT DISTINCT STVSBGI_CODE
                       FROM STVSBGI,SORHSCH
                      WHERE STVSBGI_CODE = SORHSCH_SBGI_CODE
                        AND SORHSCH_PIDM=q2.TWBDOCU_PIDM
                        AND ROWNUM = cn1 )                               CODE
             FROM SPRIDEN, SPBPERS,
                  (SELECT TWBCNTR_PIDM       Pidm,
                          TWBCNTR_NUM        NumContrato,
                          TWBCNTR_TERM_CODE  PeriContrato
                     FROM TWBCNTR                                                        ) CONTRATO,
                  (SELECT a.SGBSTDN_PROGRAM_1    Programa,
                          a.SGBSTDN_PIDM         PIDM,
                          a.SGBSTDN_COLL_CODE_1  Escuela,
                          a.SGBSTDN_STST_CODE    StatusAlum,
                          SGBSTDN_TERM_CODE_ADMIT PeriodoAd
                     FROM SGBSTDN a
                    WHERE a.SGBSTDN_TERM_CODE_EFF =
                          (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                             FROM SGBSTDN B
                            WHERE B.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                              AND B.SGBSTDN_TERM_CODE_EFF <= cs201399)                    ) GASTON,
                  (SELECT SUM(TWBDOCU_AMOUNT)  TotalCae,
                          TWBDOCU_PIDM         Pidm,
                          TWBDOCU_TERM_CODE    Periodo
                     FROM TWBDOCU
                    WHERE TWBDOCU_PAYM_CODE = csCAE
                      AND TWBDOCU_STATUS_IND NOT IN (csCA,csRP,csRV)
                    GROUP BY  TWBDOCU_PIDM, TWBDOCU_TERM_CODE                             ) MontoCae,
                  (SELECT  TWBDOCU_PIDM         Pidm,
                           TWBDOCU_TERM_CODE    Periodo,
                           SUM(TWBDOCU_AMOUNT)  TotalBeca
                      FROM twbdocu
                     WHERE EXISTS( SELECT cn1  --eL CONTRATO DEBE SER VALIDO
                                     FROM TWBCNTR
                                    WHERE TWBCNTR_NUM = TWBDOCU_CNTR_NUM
                                      AND TWBDOCU_STATUS_IND <> csC)
                       AND EXISTS( SELECT cn1  --el estado del documento debe ser pagado, descarta basura tambien
                                     FROM twrbast
                                    WHERE twrbast_status_ind = twbdocu_status_ind
                                      AND twrbast_code = csPAGADO)
                      --Clausula para detectar si es beca
                      AND ( twbdocu_paym_code = csBEC
                           OR EXISTS( SELECT cn1
                                        FROM TWRDOBE
                                       WHERE twrdobe_paym_code = twbdocu_paym_code
                                    )
                          )
                      --Clausula para detectar un retracto
                      AND NOT EXISTS( SELECT cn1
                                        FROM TWBRETR
                                       WHERE TWBRETR_CNTR_NUM = TWBDOCU_CNTR_NUM
                      )
                  GROUP BY  TWBDOCU_PIDM, TWBDOCU_TERM_CODE                               ) Beca,
                  (SELECT q1.TWBDOCU_PIDM,
                          q1.TWBDOCU_TERM_CODE,
                          q1.TWBDOCU_CNTR_NUM,
                          q1.TWBDOCU_PAYM_CODE,
                          CASE
                              WHEN q1.dias <=cn30
                               AND q1.dias >cn0
                              THEN twbdocu_amount
                          END menores30,
                          CASE
                              WHEN q1.dias >cn30
                               AND q1.dias<=cn90
                              THEN twbdocu_amount
                          END menores3090,
                          CASE
                              WHEN q1.dias >cn90
                               AND q1.dias <=cn180
                              THEN twbdocu_amount
                          END menores90180,
                          CASE
                              WHEN q1.dias >cn180
                              THEN twbdocu_amount
                          END mas180
                     FROM
--                           (SELECT TWBDOCU_PIDM,
--                                   TWBDOCU_TERM_CODE,
--                                   TWBDOCU_SEQ_NUM,
--                                   twbdocu_amount,
--                                   TO_DATE(psFECHA,csDDMMRRRR)-TRUNC(TWBDOCU_EXPIRATION_DATE) dias,
--                                   TWBDOCU_CNTR_NUM,
--                                   TWBDOCU_PAYM_CODE
--                              FROM twbdocu
--                             WHERE pk_Matricula.f_GetBanStQ(csVIGENTE,TWBDOCU_STATUS_IND) = csY -- solo vigentes
--                               AND TRUNC(TWBDOCU_EXPIRATION_DATE) <= TO_DATE(psFECHA,csDDMMRRRR)
--                           ) q1
                            (SELECT TWBDOCU_PIDM,
                                    TWBDOCU_TERM_CODE,
                                    TWBDOCU_CNTR_NUM,
                                    TWBDOCU_PAYM_CODE,
                                    twbdocu_amount,
                                    TO_DATE(psFECHA,csDDMMRRRR)-TRUNC(TWBDOCU_EXPIRATION_DATE) dias
                               FROM twbdocu
                              WHERE  EXISTS (SELECT 1
                                               FROM TWRBAST
                                              WHERE TWRBAST_CODE = csVIGENTE
                                                AND TWRBAST_STATUS_IND = TWBDOCU_STATUS_IND
                                            )
                                AND TRUNC(TWBDOCU_EXPIRATION_DATE) <= TO_DATE(psFECHA,csDDMMRRRR)
                            ) q1
                  ) q2
            WHERE SPRIDEN_CHANGE_IND IS NULL
              AND SPRIDEN_PIDM    = q2.TWBDOCU_PIDM
              AND SPBPERS_PIDM(+) = q2.TWBDOCU_PIDM
              AND q2.TWBDOCU_PIDM = Contrato.Pidm(+)
              AND q2.TWBDOCU_CNTR_NUM  = Contrato.NumContrato(+)
              AND q2.TWBDOCU_TERM_CODE = Contrato.PeriContrato(+)
              AND q2.TWBDOCU_PIDM = GASTON.PIDM(+)
              AND q2.TWBDOCU_PIDM = MontoCae.Pidm(+)
              AND q2.TWBDOCU_TERM_CODE = MontoCae.Periodo(+)
              AND q2.TWBDOCU_PIDM = Beca.Pidm(+)
              AND q2.TWBDOCU_TERM_CODE = Beca.Periodo(+)
              AND(CONTRATO.PeriContrato = psPeriodo OR psPeriodo IS NULL OR psPeriodo = csSesp)
           HAVING SUM(NVL(q2.menores30   ,cn0)+
                      NVL(q2.menores3090 ,cn0)+
                      NVL(q2.menores90180,cn0)+
                      NVL(q2.mas180,      cn0)) > cn0
           GROUP BY q2.TWBDOCU_PIDM,
                  q2.TWBDOCU_TERM_CODE,
                  q2.TWBDOCU_PAYM_CODE,
                  SPBPERS_NAME_SUFFIX,
                  SPRIDEN_ID,
                  SPRIDEN_FIRST_NAME||csEsp||SPRIDEN_MI,
                  SPRIDEN_LAST_NAME,
                  gaston.programa,
                  gaston.StatusAlum,
                  gaston.PeriodoAd,
                  MontoCae.TotalCae,
                  Beca.TotalBeca,
                  Contrato.NumContrato,
                  Contrato.PeriContrato
           ) A
         GROUP BY PIDM,      PERICONTRATO,  DOCU_TERM_CODE,
                  PROGR,     NUMCONT,       AMOUNT,PAYM_CODE,
                  STATUSALUM,PERIODOAD,     NAME_SUFFIX,
                  TOTALCAE,  TOTALBECA,     CODE;
    BEGIN
      vsPeriodo :=psPeriodo;
      vsFecha   := psFecha;

      vdInicial := SYSDATE;

      FOR regMoro IN cu_moro(vsPeriodo, vsFecha) LOOP

          BEGIN

             vnMorosos := vnMorosos + 1;
             INSERT INTO TAISMGR.TWRMORO
                        (TWRMORO_REPORT_SEQ,
                         TWRMORO_SEQ_NO,
                         TWRMORO_PIDM,
                         TWRMORO_CNTR_TERM_CODE,
                         TWRMORO_DOCU_TERM_CODE,
                         TWRMORO_PROGRAM_CODE,
                         TWRMORO_CNTR_NUM,
                         TWRMORO_AMOUNT,
                         TWRMORO_PAYM_CODE,
                         TWRMORO_STST_CODE,
                         TWRMORO_TERM_CODE_ADMIT,
                         TWRMORO_STU_RUT,
                         TWRMORO_MORA_30,
                         TWRMORO_MORA_90,
                         TWRMORO_MORA_180,
                         TWRMORO_MORA_MAYOR,
                         TWRMORO_TOTAL_MORA,
                         TWRMORO_TOTAL_CAE,
                         TWRMORO_TOTAL_BECAS,
                         TWRMORO_SBGI_CODE,
                         TWRMORO_ACTIVITY_DATE,
                         TWRMORO_USER_ID ,
                         TWRMORO_CUT_DATE,
                         TWRMORO_RANK_DATE)
             VALUES(vsReport_Seq,
                    vnMorosos,
                    regMoro.MORO_PIDM,
                    regMoro.MORO_PERI_CNTR,
                    regMoro.MORO_DOCU,
                    regMoro.MORO_PROG,
                    regMoro.MORO_CNTR,
                    regMoro.MORO_AMOUNT,
                    regMoro.MORO_PAYM,
                    regMoro.MORO_STST,
                    regMoro.MORO_TERM,
                    regMoro.MORO_STU,
                    regMoro.MORO_MORA_30,
                    regMoro.MORO_MORA_90,
                    regMoro.MORO_MORA_180,
                    regMoro.MORO_MORA_MAYOR,
                    regMoro.MORO_TOTAL_MORA,
                    regMoro.MORO_TOTAL_CAE,
                    regMoro.MORO_TOTAL_BECA,
                    regMoro.MORO_SBGI_CODE,
                    vsDate,
                    USER,
                    TO_CHAR(vsDate,csDDMMRRRR ),
                    TO_DATE(psFECHA||TO_CHAR(vsDate, csHHMISS),cdHH24MISS)
                    );
          EXCEPTION
           WHEN OTHERS
               THEN
                  vnNumErr := SQLCODE;
                  vsMsg    := SQLERRM;

                  INSERT INTO GWBEMRA (GWBEMRA_NUM, GWBEMRA_MSG, GWBEMRA_FECHA)
                       VALUES (vnNumErr, SUBSTR (vsMsg, 1, 950), SYSDATE);

                  COMMIT;
                  HTP.P(SQLERRM);
                  RAISE;
          END;
      END LOOP;

      vdFinal := SYSDATE;
      INSERT INTO GWBTMRA VALUES (vsReport_Seq,vdInicial, vdFinal,  --zzz
                                  vnMorosos, vsPeriodo ,vsFecha,
                                  'PWPMORA',vsDate);

      COMMIT;

    EXCEPTION
      WHEN NO_DATA_FOUND  THEN
         vnNumErr := SQLCODE;
         vsMsg    := 'SIN DATOS ' || SQLERRM;

         INSERT INTO GWBEMRA (GWBEMRA_NUM, GWBEMRA_MSG, GWBEMRA_FECHA)
              VALUES (vnNumErr, SUBSTR (vsMsg, 1, 950), SYSDATE);

         COMMIT;
         HTP.P(SQLERRM);
      WHEN TOO_MANY_ROWS  THEN
         vnNumErr := SQLCODE;
         vsMsg    := 'MAS DE 1 REGISTRO ' || SQLERRM;

         INSERT INTO GWBEMRA (GWBEMRA_NUM, GWBEMRA_MSG, GWBEMRA_FECHA)
              VALUES (vnNumErr, SUBSTR (vsMsg, 1, 950), SYSDATE);

         COMMIT;
      WHEN TIMEOUT_ON_RESOURCE
      THEN
         vnNumErr := SQLCODE;
         vsMsg    := 'TIEMPO DE ESPERA TERMINADO ' || SQLERRM;

         INSERT INTO GWBEMRA (GWBEMRA_NUM, GWBEMRA_MSG, GWBEMRA_FECHA)
              VALUES (vnNumErr, SUBSTR (vsMsg, 1, 950), SYSDATE);

         COMMIT;

      WHEN ROWTYPE_MISMATCH
      THEN
         vnNumErr := SQLCODE;
         vsMsg    := 'TIPOS DE DATOS INCOMPATIBLES ' || SQLERRM;

         INSERT INTO GWBEMRA (GWBEMRA_NUM, GWBEMRA_MSG, GWBEMRA_FECHA)
              VALUES (vnNumErr, SUBSTR (vsMsg, 1, 950), SYSDATE);

         COMMIT;
         HTP.P(SQLERRM);
      WHEN DUP_VAL_ON_INDEX
      THEN
         vnNumErr := SQLCODE;
         vsMsg    := 'PK REPETIDA' || SQLERRM;

         INSERT INTO GWBEMRA (GWBEMRA_NUM, GWBEMRA_MSG, GWBEMRA_FECHA)
              VALUES (vnNumErr, SUBSTR (vsMsg, 1, 950), SYSDATE);

         COMMIT;
         HTP.P(SQLERRM);
      WHEN OTHERS
      THEN
         vnNumErr := SQLCODE;
         vsMsg    := SQLERRM;

         INSERT INTO GWBEMRA (GWBEMRA_NUM, GWBEMRA_MSG, GWBEMRA_FECHA)
              VALUES (vnNumErr, SUBSTR (vsMsg, 1, 950), SYSDATE);

         COMMIT;
         HTP.P(SQLERRM);
         RAISE;
END;
/
DROP PROCEDURE BANINST1.PWRAARC;

CREATE OR REPLACE PROCEDURE BANINST1.PWRAARC (
    psReclDesc            VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:        PWRAARC
OBJETIVO:            Reporte de Alumnos para Anlisis Rechazados CAE
PARAMETROS:
psReclDesc            Variable estandar para la maquina de reportes custom
AUTOR:                Alejandro Gmez Mondragn
FECHA:                20131220
******************************************************************************/

    --Numero de renglones
    vnRow                PLS_INTEGER := 0;
    --Bandera para mostrar si hubo datos
    vnExists            INTEGER := 0;
    --Numero de columnas
    vnColumnas            INTEGER := 7;
    --Numero de registros
    vnRegs                INTEGER := 0;
    --Arreglo (nested table) donde se guardan los encabezados de las columnas
    tabColumna            Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
    -- la variable es una bandera que al tener el valor "imprime" no colocara
    --el salto de pgina para impresion
    vsInicoPag            VARCHAR2(10) := NULL;
    --Nmero de renglones por pgina
    vnRegsPag            PLS_INTEGER := 4000;

    --Filtro de numero de carga
    vnNumProc            NUMBER;
    --Filtro de tipo de dato
    vsTipo                VARCHAR2(1);

    CURSOR cuReporte(
        pnNumProc        NUMBER
        ,psTipo            VARCHAR2
    ) IS
        SELECT distinct
          SPRIDEN_ID                                                      ID,
          SPRIDEN_FIRST_NAME                                              Nombres,
          SPRIDEN_LAST_NAME                                               Apellidos,
          PE.SPBPERS_NAME_SUFFIX                                          RUT,
          SG.SGBSTDN_TERM_CODE_ADMIT                                      Periodo_admision,
          TWRCAES_STATUS_CODE                                             Estatus,
          (SELECT (TWVCAES_DESCRIPTION) FROM TWVCAES
            WHERE TWVCAES_CODE = TWRCAES_STATUS_CODE)                     descripcion
        FROM SPRIDEN SP, SPBPERS PE, SGBSTDN SG, TWRCAES
          WHERE SPBPERS_NAME_SUFFIX = TWRCAES_RUT||'-'||TWRCAES_RUT_DV
          AND SPRIDEN_CHANGE_IND IS NULL
          AND TWRCAES_STATUS_CODE <> 'PS'
          AND SP.SPRIDEN_PIDM = PE.SPBPERS_PIDM
          AND SP.SPRIDEN_PIDM = SG.SGBSTDN_PIDM
          AND SG.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF) FROM SGBSTDN B
                                              WHERE SG.SGBSTDN_PIDM = B.SGBSTDN_PIDM);

BEGIN
    --Seguridad de GWAMNUR
    IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

    --Obtengo el numero de proceso
    vnNumProc := pk_objHtml.getValueCookie('psNum');
    --Obtengo el tipo de registro
    vsTipo := pk_objHtml.getValueCookie('psRgRes');

    -- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
    tabColumna.EXTEND(vnColumnas);

    --Guardamos los encabezados en el arreglo de columnas
    tabColumna( 1) := '<center> ID';
    tabColumna( 2) := '<center> Nombres';
    tabColumna( 3) := '<center> Apellidos';
    tabColumna( 4) := '<center> RUT';
    tabColumna( 5) := '<center> Perodo de Admisin';
    tabColumna( 6) := '<center> Estatus';
    tabColumna( 7) := '<center> Descripcin';

    --Inicializamos contador de renglones
    vnRow := 0;

    FOR regReporte IN cuReporte(vnNumProc,vsTipo) LOOP

        --Incremento el contador de renglones
        vnRow := vnRow + 1;
        vnExists := 1; --Bandera para indicar que hubo resultados

        --Si es el primer renglon de cada pgina...
        IF MOD(vnRow, vnRegsPag) = 1  THEN
            --imprimo el encabezado de reporte
            Pk_Sisrepimp.P_EncabezadoDeReporte(
                psReclDesc ,vnColumnas ,tabColumna
                ,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
            );
            vsInicoPag := 'SALTO';
        END IF;

        --Comienzo a desplegar el renglon
        HTP.P('<tr>');
        HTP.P('<td>'||regReporte.ID||'</td>');
        HTP.P('<td>'||regReporte.Nombres||'</td>');
        HTP.P('<td>'||regReporte.Apellidos||'</td>');
        HTP.P('<td>'||regReporte.RUT||'</td>');
        HTP.P('<td>'||regReporte.Periodo_admision||'</td>');
        HTP.P('<td>'||regReporte.Estatus||'</td>');
        HTP.P('<td>'||regReporte.descripcion||'</td>');
        --Fin del renglon
        HTP.P('</tr>');

    END LOOP;

    IF vnExists = 0 THEN
        --Ojo esta linea lo que hace es imprimir
        --NO SE ENCONTRARON DATOS o un mensaje similar
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
    ELSE

        -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pagina
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
    END IF;

    --Fin de la pagina
    htp.p('</table><br/></body></html>');
EXCEPTION
    WHEN OTHERS THEN
        --pantallazo de error.
        pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
            'PWRAARC', NULL);
END PWRAARC;
/


DROP PUBLIC SYNONYM PWRAARC;

CREATE PUBLIC SYNONYM PWRAARC FOR BANINST1.PWRAARC;


GRANT EXECUTE ON BANINST1.PWRAARC TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRABAJ;

CREATE OR REPLACE PROCEDURE BANINST1.PWRABAJ(psPerio VARCHAR2)   IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de articulo 29
        mdulo: admisiones - uft.

*******************************************************************************/

  -- declaracin de variables:

  vsTerm        SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE	DEFAULT NULL;
  vsExped       SPRIDEN.SPRIDEN_ID%TYPE		DEFAULT NULL;
  vsPidm         SPRIDEN.SPRIDEN_PIDM%TYPE        DEFAULT NULL;
  vsPerioAnt    STVTERM.STVTERM_CODE%TYPE;
  vsPcheckBox   VARCHAR2 (10)             := '';

    global_pidm         spriden.spriden_pidm%TYPE;
    curr_release        CONSTANT VARCHAR2 (10)             := '8.1.1';
    vsCheckBox          CONSTANT VARCHAR2 (10)             := 'disabled';
  -- obtiene la informacin de los alumnos:
  CURSOR cuReporte (	psTerm		VARCHAR2  DEFAULT NULL,
                                  psPidm		VARCHAR2  DEFAULT NULL ) IS
                SELECT  SFRSTCR_CRN NRC,
                            SCBCRSE_SUBJ_CODE||''||SCBCRSE_CRSE_NUMB CLAVE_MATERIA,
                            SCBCRSE_TITLE NOMBRE_MATERIA
                            FROM SFRSTCR, SSBSECT, SCBCRSE A
                        WHERE SFRSTCR_CRN = SSBSECT_CRN
                            AND SFRSTCR_TERM_CODE = SSBSECT_TERM_CODE
                            AND SSBSECT_SUBJ_CODE = SCBCRSE_SUBJ_CODE
                            AND SSBSECT_CRSE_NUMB = SCBCRSE_CRSE_NUMB
                            AND SFRSTCR_PIDM = psPidm
                            AND SFRSTCR_TERM_CODE = psTerm
                            AND SFRSTCR_RSTS_CODE IN ('RE','RW') --CODIGO MATERIAS ACTIVAS
                            AND A.SCBCRSE_EFF_TERM = (SELECT MAX(B.SCBCRSE_EFF_TERM) FROM SCBCRSE B
                                                                        WHERE A.SCBCRSE_SUBJ_CODE = B.SCBCRSE_SUBJ_CODE
                                                                            AND A.SCBCRSE_CRSE_NUMB = B.SCBCRSE_CRSE_NUMB);

   CURSOR primerIngreso (     psTerm        VARCHAR2  DEFAULT NULL,
                                         psPidm        VARCHAR2  DEFAULT NULL ) IS
                            SELECT count(*) FROM SARADAP, TWBCNTR, SGBSTDN
                                WHERE SARADAP_PIDM = TWBCNTR_PIDM
                                    AND SARADAP_TERM_CODE_ENTRY = TWBCNTR_TERM_CODE
                                    AND SGBSTDN_PIDM = SARADAP_PIDM
                                    AND SARADAP_TERM_CODE_ENTRY = SGBSTDN_TERM_CODE_EFF
                                    AND SGBSTDN_STYP_CODE = 'N'
                                    AND SGBSTDN_STST_CODE  <> 'AL'
                                    AND SARADAP_TERM_CODE_ENTRY =psTerm
                                    AND SARADAP_PIDM = psPidm;

  CURSOR bajaMaterias (     psTerm       VARCHAR2  DEFAULT NULL,
                                      psPidm        VARCHAR2  DEFAULT NULL ) IS
                           select count(*) from SFRSTCR
                             WHERE SFRSTCR_RSTS_CODE       = 'RS'
                                 AND SFRSTCR_PIDM                = psPidm
                                 AND SFRSTCR_TERM_CODE      = psTerm;

    vnConteo      PLS_INTEGER;
    vnBajas        PLS_INTEGER;
    vnConteoActual PLS_INTEGER;

---------------------------------------------------
-- bloque principal para la generacin del reporte
--------------------------------------------------

BEGIN

    IF NOT twbkwbis.f_validuser (global_pidm) THEN  RETURN; END IF;

    bwckfrmt.p_open_doc ('PWRABAJ');
    twbkwbis.p_dispinfo ('PWRABAJ');

htp.p('
        <form name="f" method="get">
            <table>');








   FOR regRep IN cuReporte (psPerio,global_pidm) LOOP

      BEGIN
      SELECT vsCheckbox
        INTO vsPcheckBox
        FROM SHRTCKN
       WHERE SHRTCKN_PIDM = global_pidm
         AND SHRTCKN_CRN = regRep.NRC
         AND SHRTCKN_TERM_CODE = psPerio;
        EXCEPTION WHEN NO_DATA_FOUND THEN vsPcheckBox := '';
        END;

       -- muestra los valores para cada registro:
       HTP.P('   <tr>
                    <td><input name="p1" type="checkbox" value="'||regRep.NRC||'" '||vsPcheckBox||' /></td>
                    <td>'||regRep.NRC||'</td>
                    <td>'||regRep.CLAVE_MATERIA||'</td>
                    <td>'||regRep.NOMBRE_MATERIA||'</td>
                    </tr>');

   END LOOP;

    --obtenemos el resultado del cursor de cuantas materias estn dadas de baja

   OPEN bajaMaterias(psPerio,global_pidm);
   FETCH bajaMaterias INTO vnBajas;
   CLOSE bajaMaterias;


   --obtenemos el resultado del cursor de primer ingreso
   --periodo anterior
     SELECT max(STVTERM_CODE) INTO vsPerioAnt
       FROM STVTERM
       where STVTERM_CODE<psPerio
     ORDER BY STVTERM_CODE;

   OPEN primerIngreso(vsPerioAnt,global_pidm);
   FETCH primerIngreso INTO vnConteo;
   CLOSE primerIngreso;
   --periodo actual
   vsPerioAnt:=psPerio;
   OPEN primerIngreso(vsPerioAnt,global_pidm);
   FETCH primerIngreso INTO vnConteoActual;
   CLOSE primerIngreso;


    vnConteo:=vnConteo+vnConteoActual;


      HTP.P('</table>
                <input type="button" name="cmdEnvia" value="Enviar">
                </form>
                <form name=g method="post" action="PWRAEST">
                  <input type="hidden" name="psTerm" value="'||psPerio||'">
                  <input type="hidden" name="psNRC">
                </form>
                  <script type="text/javascript">
                        var f = document.f;
                        var g = document.g;

                        var conteo = '||vnConteo||';
                        var baja = '||vnBajas||';

                        f.cmdEnvia.onclick=Enviar;

                         function UnaSeleccion(){
                                    var seleccion=0;
                            for(var i=0; i<f.elements.length; i++){
                                   if( f.elements[i].type=="checkbox" && f.elements[i].checked ){
                                     seleccion = seleccion+1;
                                }

                            }
                                 if (seleccion>1) {
                                    alert("Revisar la seleccion de informacion:Solo se puede elegir una materia");
                                    return false;
                                 }
                                if (seleccion==0) {
                                    alert("Revisar la seleccion de informacion:Es necesario elegir una materia");
                                    return false;
                                 }

                                 return true;
                        }

                     function NCRSeleccionado(){
                                    var vseleccionado;
                            for(var i=0; i<f.elements.length; i++){
                                   if( f.elements[i].type=="checkbox" && f.elements[i].checked ){
                                      vseleccionado=f.elements[i].value;
                                }
                            }
                            return(vseleccionado);
                        }


                     function Enviar(){
                     //alert("aqui vamos");
                        //si no hubo un solo checkbox seleccionado nos salimos
                        if(! UnaSeleccion() ) return;

                        if(conteo>0){
                            alert("No es posible dar de baja materias para este alumno ya que es de primer ingreso");
                            return;
                        }
                        if(baja>=1){
                            alert("Ya existen materias dadas de baja para este perodo:No es posible cancelar esta materia");
                            return;
                        }

                        //guardamos el nrc seleccionado
                        g.psNRC.value = NCRSeleccionado();

                        //hago que la informacion se envie al servidor
                        g.submit();

                     }
                    </script>');
  twbkwbis.p_closedoc (curr_release);

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRABAJ;
/


DROP PUBLIC SYNONYM PWRABAJ;

CREATE PUBLIC SYNONYM PWRABAJ FOR BANINST1.PWRABAJ;


GRANT EXECUTE ON BANINST1.PWRABAJ TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRABAJ TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRABAJ TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRABAJ TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRACAI;

CREATE OR REPLACE PROCEDURE BANINST1.PWRACAI(psReclDesc VARCHAR2) IS

/**************************************************************
           tarea:  genera el reporte de acta de alumnos de intercambios
         mdulo:  consulta al registro de calificaciones
           autor:  horacio martnez ramrez - hmr
           fecha:  12/oct/2010
**************************************************************/
   vgsUSR        VARCHAR2(500);

 BEGIN

   /* check/update the user's web session */
   IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

    BEGIN
         PWRCRCF(psReclDesc ,'PK_RegcaliCoCalF.P_IntercambioCalF');
    END PWRACAI;
 END;
/


DROP PUBLIC SYNONYM PWRACAI;

CREATE PUBLIC SYNONYM PWRACAI FOR BANINST1.PWRACAI;


GRANT EXECUTE ON BANINST1.PWRACAI TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRACAI TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRACIER;

CREATE OR REPLACE PROCEDURE BANINST1.PWRACIER (
    psReclDesc            VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:        PWRACIER
OBJETIVO:            Cierre de Semestre
PARAMETROS:
psReclDesc            Variable estandar para la maquina de reportes custom
AUTOR:               Alejandra Mungua --- se le agregan columnas y parametros al reporte original
FECHA:                20120912
******************************************************************************/
    --Numero de renglones
    vnRow                PLS_INTEGER := 0;
    --Bandera para mostrar si hubo datos
    vnExists            INTEGER := 0;
    --Numero de columnas
    vnColumnas            INTEGER := 18;
    --Numero de registros
    vnRegs                INTEGER := 0;
    --Arreglo (nested table) donde se guardan los encabezados de las columnas
    tabColumna            Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
    -- la variable es una bandera que al tener el valor "imprime" no colocara
    --el salto de pgina para impresion
    vsInicoPag            VARCHAR2(10) := NULL;
    --Nmero de renglones por pgina
    vnRegsPag            PLS_INTEGER := 25;
    --Variable para guardar el periodo deseado
    vsPerio                STVTERM.STVTERM_CODE%TYPE;
    --Variable para guardar EL PROGRAMA DESEADO
    vsProg                SMRPRLE.SMRPRLE_PROGRAM%TYPE;
    --Variable para guardar el total de matriculados del dia
    vnTotalDia            PLS_INTEGER;
    --Fecha del reporte
    vdFecha                DATE;
    -- Indicador de la escuela
    vsEscu               VARCHAR2(5);

    CURSOR cuReporte(
        psPerio            VARCHAR2
        ,psProgr           VARCHAR2
        ,psEscu             VARCHAR2
     ) IS
            SELECT  DISTINCT S1.SGBSTDN_PROGRAM_1                    CARRERA,
                            S1.SGBSTDN_MAJR_CODE_1                MALLA,
                            S1.SGBSTDN_TERM_CODE_ADMIT      PERIODO_ADMISION,
                            (SELECT SMRPRLE_PROGRAM FROM SMRPRLE
                            WHERE SMRPRLE_PROGRAM = S1.SGBSTDN_PROGRAM_1)           DESCRIPCION_CARRERA,
                            SPBPERS_NAME_SUFFIX                    RUT,
                            SPRIDEN_ID                                          ID,
                            S1.SGBSTDN_PIDM                                 PIDM,
                            S1.SGBSTDN_LEVL_CODE                          NIVEL,
                            SPRIDEN_FIRST_NAME||' '||SPRIDEN_LAST_NAME    NOMBRE_APELLIDOS,
                            NVL(S3.SGBUSER_SUDC_CODE,0)           RAMOS_REPROB_HA,
                            NVL(S3.SGBUSER_SUDD_CODE,0)           OPORT_UTIL_HA,
                            NVL(S3.SGBUSER_SUDE_CODE,0)           AVANC_CRED_TOT,
                            NVL(S3.SGBUSER_SUDA_CODE,0)           ULT_SEM_A_COMP_ACR,
                           NVL( S3.SGBUSER_SUDF_CODE,0)           RANKING,
                            NVL(S3.SGBUSER_SUDG_CODE,0)           PERIOD_CONSEC_REP,
                               NVL (
                     (SELECT ROUND(SHRTGPA_GPA,2)
                        FROM SHRTGPA
                       WHERE     SHRTGPA_PIDM = S1.SGBSTDN_PIDM
                             AND SHRTGPA_LEVL_CODE = S1.SGBSTDN_LEVL_CODE
                             AND SHRTGPA_TERM_CODE = psPerio),
                     0)
                     PPA,
                            NVL(S3.SGBUSER_SUDH_CODE,0)           ASIG_ACRED_PER_ACT,
                             (SELECT DECODE (COUNT (1), 0, 0, COUNT (1))
           FROM SFRSTCR
          WHERE     SFRSTCR_PIDM = S1.SGBSTDN_PIDM
                AND SFRSTCR_TERM_CODE = psPerio
                AND SFRSTCR_RSTS_CODE IN ('RE', 'RW'))AIP,
                            S3.SGBUSER_SUDI_CODE               ASIG_ACRED_ACUM_HIS,
                  (SELECT DECODE(TBBESTU_PIDM, NULL,' ','X')
              FROM TBBESTU
             WHERE TBBESTU_PIDM = S1.SGBSTDN_PIDM
                   AND TBBESTU_TERM_CODE = psPerio
                   and rownum= 1) BECA
              FROM SPRIDEN,
                           SGBSTDN S1,
                           SPBPERS,
                           SGBUSER S3
             WHERE SPRIDEN_PIDM = S1.SGBSTDN_PIDM
                  AND SPRIDEN_CHANGE_IND IS NULL
                  AND SGBSTDN_PIDM = S3.SGBUSER_PIDM
                  AND S1.SGBSTDN_PIDM = SPBPERS_PIDM
                  AND (S3.SGBUSER_TERM_CODE = psPerio OR psPerio IS NULL)
                  AND (S1.SGBSTDN_PROGRAM_1 = psProgr OR psProgr IS NULL)
--                  AND EXISTS (SELECT 1 FROM SWRCIRR
--                                        WHERE SWRCIRR_PIDM = S3.SGBUSER_PIDM)
                  AND S1.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(S2.SGBSTDN_TERM_CODE_EFF)
                                                                                          FROM SGBSTDN S2
                                                                                        WHERE S1.SGBSTDN_PIDM = S2.SGBSTDN_PIDM
                                                                                        )
                  AND s1.SGBSTDN_COLL_CODE_1=nvl(psEscu,s1.SGBSTDN_COLL_CODE_1)
               ORDER BY S1.SGBSTDN_MAJR_CODE_1, S1.SGBSTDN_LEVL_CODE, S1.SGBSTDN_PROGRAM_1;

BEGIN

    --Seguridad de GWAMNUR
    IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;
--HTP.P('PARAMETROS ');
    --Obtengo el numero de corte que se desea para el usuario dado
    vsPerio := pk_objHtml.getValueCookie('psPerio');
--vsPerio := '201175';
    --Obtengo de las cookies el valor fechas de corte de caja
    vsProg := pk_objHtml.getValueCookie('psProgr');
    vsEscu := pk_objHtml.getValueCookie('psEscu');
    --Obtenemos la fecha
    vdFecha := NVL(TO_DATE(pk_objHtml.getValueCookie('psFecha'),'DD/MM/YYYY'),SYSDATE);

 --HTP.P('PARAMETROS periodo:'||vsPerio||' prog:'||vsProg||' IndSem:'||vsIndSem||' Fecha:'||vdFecha);
--HTP.P('PARAMETROS'||vnRetractosDia||'-'||vnRetractosAcum||'-'||);

    -- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
    tabColumna.EXTEND(vnColumnas);

    --Guardamos los encabezados en el arreglo de columnas
    tabColumna( 1) := 'Carrera';
    tabColumna( 2) := 'Malla';
    tabColumna( 3) := 'Periodo de Admision';
    tabColumna( 4) := 'Descripcin de la Carrera';
    tabColumna( 5) := 'RUT';
    tabColumna( 6) := 'ID';
    tabColumna( 7) := 'Nombre';
    tabColumna( 8) := 'Ramos Reprobados en la Historia Academica';
    tabColumna(9) := 'Oportunidades Utilizadas en la Historia Academica';
    tabColumna(10) := '% de Avance Respecto a los Creditos Totales';
    tabColumna(11) := 'Ultimo Semestre o Ao Completo Acreditado';
    tabColumna(12) := 'Ranking';
    tabColumna(13) := 'Periodos Consecutivos Reprobados';
    tabColumna(14) := 'Promedio del Periodo Actual';
    tabColumna(15) := 'Asignaturas Acreditadas en el Periodo Actual';
    tabColumna(16) := 'Asignaturas Inscritas en el Periodo';
    tabColumna(17) := '% Asignaturas Acreditadas Acumuladas en el Historial';
    tabColumna(18) := 'Beca';

    --Inicializamos contador de renglones
    vnRow := 0;

     FOR regReporte IN cuReporte(vsPerio, vsProg,vsEscu) LOOP

        --Incremento el contador de renglones
        vnRow := vnRow + 1;
        vnExists := 1; --Bandera para indicar que hubo resultados

        --Si es el primer renglon de cada pgina...
        IF MOD(vnRow, vnRegsPag) = 1  THEN
            --imprimo el encabezado de reporte
            Pk_Sisrepimp.P_EncabezadoDeReporte(
                psReclDesc ,vnColumnas ,tabColumna
                ,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
            );
            vsInicoPag := 'SALTO';
        END IF;

        --Comienzo a desplegar el renglon
        HTP.P('<tr>');

        HTP.P('<td>'||regReporte.CARRERA||'</td>');
        HTP.P('<td>'||regReporte.MALLA||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.PERIODO_ADMISION ||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.DESCRIPCION_CARRERA ||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.RUT ||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.ID ||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.NOMBRE_APELLIDOS ||'</td>');
        HTP.P(
            '<td valign="top"><a  href="#" ><font title="Informacion de SUB y CRSE y PERIODO');

--        htp.p(regReporte.pidm||''|| regReporte.Nivel||vsPerio);
         --P_DetToolTip (pnPidm NUMBER, psLevel VARCHAR, psTerm VARCHAR2);
         KWACIERRE.P_DetToolTip (regReporte.pidm, regReporte.Nivel, vsPerio);

        HTP.P('<td style="text-align:left;">'||regReporte.RAMOS_REPROB_HA||'</td>');
        HTP.
          p (
            '<td valign="top"><a  href="#" ><font title="Informacion de SUB y CRSE y PERIODO');
         KWACIERRE.P_DetToolTipA (regReporte.pidm, regReporte.Nivel, vsPerio);
         htp.p('hola'||regReporte.pidm);
         htp.p(regReporte.nivel);
         htp.p(vsPerio);
        HTP.P('<td style="text-align:left;">'||regReporte.OPORT_UTIL_HA||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.AVANC_CRED_TOT||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.ULT_SEM_A_COMP_ACR||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.RANKING||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.PERIOD_CONSEC_REP||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.PPA||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.ASIG_ACRED_PER_ACT||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.AIP||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.ASIG_ACRED_ACUM_HIS||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.BECA||'</td>');
        --Fin del renglon
        HTP.P('</tr>');

     END LOOP;



    IF vnExists = 0 THEN
        --Ojo esta linea lo que hace es imprimir
        --NO SE ENCONTRARON DATOS o un mensaje similar
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
    ELSE

        -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pagina
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
    END IF;

    --Fin de la pagina
    htp.p('</table><br/></body></html>');
EXCEPTION
    WHEN OTHERS THEN
        --pantallazo de error.

        htp.p(SQLERRM);

END PWRACIER;
/


DROP PUBLIC SYNONYM PWRACIER;

CREATE PUBLIC SYNONYM PWRACIER FOR BANINST1.PWRACIER;


GRANT EXECUTE ON BANINST1.PWRACIER TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRACLI;

CREATE OR REPLACE PROCEDURE BANINST1.PWRACLI(psReclDesc VARCHAR2) IS

/**************************************************************
           tarea:  genera el reporte de actas liberadas
         mdulo:  consulta al registro de calificaciones
           autor:  horacio martnez ramrez - hmr
           fecha:  12/oct/2010
**************************************************************/

  ckNombres    owa_cookie.vc_arr;
  ckValores    owa_cookie.vc_arr;
  ckCount      INTEGER;
  vgsInicoPag  VARCHAR2(10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vgsUSR       VARCHAR2(500);

  vnRow      INTEGER                            := 0;
  vnExists   INTEGER                            := 0;
  vnColumnas INTEGER                            := 9;
  tabColumna PK_sisRepImp.tipoTabla             := PK_sisRepImp.tipoTabla(1);
  vsPerio    SIBINST.SIBINST_TERM_CODE_EFF%TYPE := NULL;
  vsUniv     VARCHAR2(20)                       := NULL;
  vsSstst    STVSTST.STVSTST_CODE%TYPE          := NULL;
  vsProgr    SMRPRLE.SMRPRLE_PROGRAM_DESC%TYPE  := NULL;
  vsEscu     STVSBGI.STVSBGI_DESC%TYPE          := NULL;
  vsSeccion  VARCHAR2(3)                        := NULL;
  vsTermCode VARCHAR2(6)                        := NULL;
  vsCampCode VARCHAR2(6)                        := NULL;
  vsFechamax VARCHAR2(10)                       := NULL;

  CURSOR cuReporte(pPerio   VARCHAR2 DEFAULT NULL,
                   pUniv    VARCHAR2 DEFAULT NULL,
                   pEscu    VARCHAR2 DEFAULT NULL) IS
         SELECT SWRFOLI_TERM_CODE                termCode,
                SSBSECT_CAMP_CODE                campCode,
                SWRFOLI_CRN                      NRC,
                SCBCRSE_SUBJ_CODE                SUBJ,
                SCBCRSE_CRSE_NUMB                CRSE,
                SCBCRSE_TITLE                    TITULO,
                SPRIDEN_ID                       EXPEDIENTE,
                REPLACE(REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME||' '||SPRIDEN_MI,'','&ntilde;'),'*',' ') NOMBRE,
                SWRFOLI_TEXT                     FOLIO,
                SWRFOLI_ROLPROF_DATE             LIBERACION
           FROM SWRFOLI,
                SSBSECT SS,
                SCBCRSE SC,
                SIRASGN,
                SPRIDEN,
                SSBOVRR SR
          WHERE SWRFOLI_TERM_CODE    = SSBSECT_TERM_CODE
            AND SWRFOLI_CRN          = SSBSECT_CRN
            AND SSBSECT_SUBJ_CODE    = SC.SCBCRSE_SUBJ_CODE
            AND SSBSECT_CRSE_NUMB    = SC.SCBCRSE_CRSE_NUMB
            AND SC.SCBCRSE_EFF_TERM  = (SELECT MAX(C2.SCBCRSE_EFF_TERM)
                                          FROM SCBCRSE C2
                                         WHERE SC.SCBCRSE_SUBJ_CODE = C2.SCBCRSE_SUBJ_CODE
                                           AND SC.SCBCRSE_CRSE_NUMB = C2.SCBCRSE_CRSE_NUMB
                                           AND C2.SCBCRSE_EFF_TERM <= SSBSECT_TERM_CODE
                                       )
           AND SWRFOLI_TERM_CODE    = SIRASGN_TERM_CODE
           AND SWRFOLI_CRN          = SIRASGN_CRN
           AND SS.SSBSECT_CRN       = SR.SSBOVRR_CRN (+)
           AND SS.SSBSECT_TERM_CODE = SR.SSBOVRR_TERM_CODE (+)
           AND SIRASGN_PRIMARY_IND  = 'Y'
           AND SPRIDEN_PIDM         = SIRASGN_PIDM
           AND SPRIDEN_CHANGE_IND   IS NULL
           AND (SWRFOLI_TERM_CODE   = pPerio OR pPerio IS NULL)
           AND (SSBSECT_CAMP_CODE   = pUniv  OR pUniv  IS NULL)
           AND (DECODE(SR.SSBOVRR_COLL_CODE ,NULL,SCBCRSE_COLL_CODE,SR.SSBOVRR_COLL_CODE ) = pEscu  OR pEscu  IS NULL)
         ORDER BY FOLIO;

  function fechaMaxima(pnCrn      number,
                                psTermCode varchar2) return varchar2 is

  vsFecha varchar2(11) := null;

  begin
      select to_char(max(sfrstcr_grde_date),'dd/mm/yyyy')
        into vsFecha
        from sfrstcr
       where sfrstcr_crn        = pnCrn
         and sfrstcr_term_code  = psTermCode
         and sfrstcr_grde_date is not null
         and sfrstcr_rsts_code in (select stvrsts_code
                                              from stvrsts
                                            where stvrsts_gradable_ind = 'Y');

     return vsFecha;

  exception
      when no_data_found then
           return null;

  end fechaMaxima;


  BEGIN
      /* check/update the user's web session */
      IF PK_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      -- son buscadas los valores de las cookies para asignar los valores del filtro del query
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
          FOR vnCOKIES IN 1..ckCount LOOP
              IF ckNOMBRES(vnCOKIES)    = 'psPerio' THEN
                   vsPerio := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psUnive' THEN
                   vsUniv  := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psEscu' THEN
                   vsEscu := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                   vsSeccion := ckValores(vnCOKIES);

              END IF;
          END LOOP;
      END IF;

      -- las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1) := 'No.';
      tabColumna(2) := 'NRC';
      tabColumna(3) := 'Subj';
      tabColumna(4) := 'Crse';
      tabColumna(5) := 'Ttulo';
      tabColumna(6) := 'Expediente';
      tabColumna(7) := 'Nombre';
      tabColumna(8) := 'Folio';
      tabColumna(9) := 'Fecha de rolado';

      FOR regRep IN cuReporte(vsPerio, vsUniv, vsEscu) LOOP
          IF vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
             vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR vnRow = 30 THEN

              PK_sisRepImp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vgsInicoPag,'0','#000000',psSubtitulo=>'Periodo '||regRep.termCode,psUsuario=>vgsUSR,psSeccion=>vsSeccion,psUniversidad=>regRep.campCode);
              vgsInicoPag := 'SALTO';

              vnRow  := 0;
          END IF;

          vnRow := vnRow + 1;

          htp.p('<tr>
          <td valign="top">'||vnRow            ||'</td>
          <td valign="top">'||regRep.NRC       ||'</td>
          <td valign="top">'||regRep.Subj      ||'</td>
          <td valign="top">'||regRep.Crse      ||'</td>
          <td valign="top">'||regRep.Titulo    ||'</td>
          <td valign="top">'||regRep.Expediente||'</td>
          <td valign="top">'||regRep.Nombre    ||'</td>
          <td valign="top">'||regRep.Folio     ||'</td>
          <td valign="top">'||fechaMaxima(regRep.NRC, regRep.termCode)||'</td>
          </tr>');

          vnExists   := 1;
          vsTermCode := regRep.termCode;
          vsCampCode := regRep.campCode;
      END LOOP;


      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||PK_sisRepImp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
         PK_sisRepImp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         PK_sisRepImp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>vgsUSR, psSeccion=>vsSeccion);
      END IF;

      htp.p('</table></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           HTP.P(SQLERRM);

  END PWRACLI;
/


DROP PUBLIC SYNONYM PWRACLI;

CREATE PUBLIC SYNONYM PWRACLI FOR BANINST1.PWRACLI;


GRANT EXECUTE ON BANINST1.PWRACLI TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRACLI TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRACTA;

CREATE OR REPLACE PROCEDURE BANINST1.PWRACTA(psReclDesc VARCHAR2) IS

  BEGIN
      -- valida que el usuario pertenezca a la base de datos.
      IF pk_login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      kwaacta.imprimeActa(psReclDesc);

  END PWRACTA;
/


DROP PUBLIC SYNONYM PWRACTA;

CREATE PUBLIC SYNONYM PWRACTA FOR BANINST1.PWRACTA;


GRANT EXECUTE ON BANINST1.PWRACTA TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRACTA TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRADME;

CREATE OR REPLACE PROCEDURE BANINST1.PWRADME(psReclDesc VARCHAR2) IS
/*
   Tarea: Reporte de archivos de datos del "Motor de encuestas"
   Fecha: 22/11/2010
   Autor: MAC
  Modulo: Motor de encuestas

*/
  TYPE t_Record IS RECORD (rAcod VARCHAR2(10),
                           rQcod VARCHAR2(10),
                           rAnsw VARCHAR2(10),
                           rMaxw INTEGER,
                           rGvbq CLOB,
                           rWeid VARCHAR2(10),
                           rGsrc VARCHAR2(20)
                          );

  TYPE t_Table IS TABLE OF t_Record INDEX BY BINARY_INTEGER;

  vsUnive     VARCHAR2(6)     := NULL;
  vsEncst     VARCHAR2(20)    := NULL;
  vnNmRfE     INTEGER         := NULL;
  vsPerio     VARCHAR2(6)     := NULL;
  vsAccpr     VARCHAR2(20)    := NULL;
  vsEscul     VARCHAR2(2)     := NULL;
  vsDescEncst VARCHAR2(300)   := NULL;

  tabReac     t_Table;
  vsId        VARCHAR2(10)  := NULL;
  vsFecha     VARCHAR2(10)  := NULL;
  vsProgCode  VARCHAR2(20)  := NULL;
  vsProgDesc  VARCHAR2(300) := NULL;
  vsLevlCode  VARCHAR2(3)   := NULL;
  vsCollDesc  VARCHAR2(300) := NULL;
  vsRateCode  VARCHAR2(6)   := NULL;
  vsErned     VARCHAR2(20)  := NULL;
  vsOverall   VARCHAR2(20)  := NULL;
  vsCredito   VARCHAR2(20)  := NULL;
  vsAsnw      VARCHAR2(10)  := NULL;
  vsRate      VARCHAR2(6)   := NULL;
  vnEdad      NUMBER        := 0;
  vnRow       INTEGER       := 0;
  vnReg       INTEGER       := 0;
  vnTDwidth   INTEGER       := 0;
  vnWithTd    INTEGER       := 100;
  vnWit2Td    INTEGER       := 300;
  vnWithTable INTEGER       := 100;

  csSIN CONSTANT VARCHAR2(3) := 'SIN';

  Cursor cuReactivo(pnSrnn INTEGER,
                    psGsrc VARCHAR2) IS
         SELECT GVRASDF_SORT_NUM  SORR,
                GVRASDF_QCOD_CODE QCOD,
                (SELECT GVBQCOD_DESC
                   FROM GVBQCOD
                  WHERE GVBQCOD_CODE = GVRASDF_QCOD_CODE
                )                 GVBQ,
                (SELECT GVBQCOD_ACOD_CODE
                   FROM GVBQCOD
                  WHERE GVBQCOD_CODE = GVRASDF_QCOD_CODE
                )                 ACOD,
                DECODE(GVRASDF_WEIGHT+
                 GVRASDF_TOTAL_SCORE,0,'COMENT',NULL) Weid,
                (SELECT 'Y'
                   FROM GVRSDEF
                  WHERE GVRSDEF_GSRC_CODE_REF_IND = 'Y'
                    AND GVRSDEF_QCOD_CODE        = GVRASDF_QCOD_CODE
                    AND GVRSDEF_GSRC_CODE        = psGsrc
                ) SubE
           FROM GVRASDF
          WHERE GVRASDF_GSRC_CODE = psGsrc
            AND GVRASDF_SRN       = pnSrnn
          ORDER BY GVRASDF_SORT_NUM;

  Cursor cuReactiv2(pnSrnn INTEGER,
                    psGsrc VARCHAR2) IS
         SELECT GVRASDF_SORT_NUM  SORR,
                GVRASDF_QCOD_CODE QCOD,
                (SELECT GVBQCOD_DESC
                   FROM GVBQCOD
                  WHERE GVBQCOD_CODE = GVRASDF_QCOD_CODE
                )                 GVBQ,
                (SELECT GVBQCOD_ACOD_CODE
                   FROM GVBQCOD
                  WHERE GVBQCOD_CODE = GVRASDF_QCOD_CODE
                )                 ACOD,
                DECODE(GVRASDF_WEIGHT+
                 GVRASDF_TOTAL_SCORE,0,'COMENT',NULL) Weid,
                (SELECT 'Y'
                   FROM GVRSDEF
                  WHERE GVRSDEF_GSRC_CODE_REF_IND = 'Y'
                    AND GVRSDEF_QCOD_CODE        = GVRASDF_QCOD_CODE
                    AND GVRSDEF_GSRC_CODE        = psGsrc
                ) SubE
           FROM GVRASDF
          WHERE GVRASDF_GSRC_CODE = psGsrc
            AND GVRASDF_SRN       = pnSrnn
          ORDER BY GVRASDF_SORT_NUM;

  CURSOR cuArchivo(pnSrnn INTEGER,
                   psQcod VARCHAR2,
                   pnPidm NUMBER) IS
         SELECT GVBGSED_PVAC_QPOINTS PVAC,
                GVBGSED_OPEN_ANSWER  OPIN,
                GVBGSED_PVAC_SEQ_NUM SEQN
           FROM GVBGSED
          WHERE GVBGSED_QCOD_CODE      = psQcod
            AND GVBGSED_SRAS_TEMP_PIDM = pnPidm
            AND GVBGSED_SRN            = pnSrnn;

  CURSOR cuEncuestados(pnSrnn INTEGER,
                       psRate VARCHAR2
                      ) IS
         SELECT
         c.SPRIDEN_ID ID,
         c.SPRIDEN_LAST_NAME||' '||c.SPRIDEN_FIRST_NAME NOMBRE,
         SPBPERS_NAME_SUFFIX sufijo,
         GVRSRAS_SPIDM                    Pidm,
                GVRSRAS_TEMP_PIDM                    Temp,
                DECODE(GVRSRAS_STATUS_IND,
                        'P','Pendiente',
                        'I','Proceso',
                        'C','Completada',NULL) Status
           FROM SPRIDEN C, SPBPERS B, GVRSRAS
            WHERE
            C.SPRIDEN_PIDM = B.SPBPERS_PIDM
            AND C.SPRIDEN_CHANGE_IND IS NULL
            AND C.SPRIDEN_PIDM = GVRSRAS_SPIDM
            AND GVRSRAS_SRN = pnSrnn
                AND (
                    EXISTS (SELECT NULL
                               FROM SGBSTDN A
                              WHERE A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                                                 FROM SGBSTDN B
                                                                WHERE B.SGBSTDN_PIDM = A.SGBSTDN_PIDM
                                                              )
                                AND A.SGBSTDN_PIDM          = GVRSRAS_SPIDM
                                AND NVL(A.SGBSTDN_RATE_CODE,csSIN) = psRate
                           )

                 OR
                    psRate IS NULL
                )
          ORDER BY Status;

  CURSOR cuAnswer(psAcod VARCHAR2) IS
         SELECT REPLACE(REPLACE(GVRPVAC_DESC,'<P ALIGN=Center>',NULL),'<br>',NULL) pvacDesc,
                GVRPVAC_QPOINTS pvacQpoi
           FROM GVRPVAC
          WHERE GVRPVAC_ACOD_CODE = psAcod
          ORDER BY GVRPVAC_SEQ_NUM;

  --subencuesta
  CURSOR cuSubEnc(vsGsrc VARCHAR2,
                  vsQcod VARCHAR2) IS
         SELECT GVRSREL_GSRC_CODE_REF GSRC
           FROM GVRSREL
          WHERE GVRSREL_GSRC_CODE = vsGsrc
            AND GVRSREL_QCOD_CODE = vsQcod;

  -- obtiene el campus del encuestado
  function f_Campus(pnPidm number) return varchar2 is

  vsCampDesc     stvcamp.stvcamp_desc%type := null;
  vsVpdiAnterior varchar2(10)              := NULL;

  cursor cuCamp is
         select stvcamp_code campCode
           from stvcamp;

  begin
      vsVpdiAnterior := sys_context('g$_vpdi_home_context','vpdi_home_code');
      vsProgCode     := null;
      vsProgDesc     := null;
      vsLevlCode     := null;
      vsCollDesc     := null;
      vsRateCode     := null;
      vsErned        := null;
      vsOverall      := null;
      vsCredito      := null;

      begin
          select pk_Catalogo.universidad(a.sgbstdn_camp_code),
                 sgbstdn_program_1,
                 pk_Catalogo.programa(sgbstdn_program_1),
                 sgbstdn_levl_code,
                 sgbstdn_rate_code
            into vsCampDesc,
                 vsProgCode,
                 vsProgDesc,
                 vsLevlCode,
                 vsRateCode
            from sgbstdn a
           where a.sgbstdn_term_code_eff = (select max(b.sgbstdn_term_code_eff)
                                              from sgbstdn b
                                             where b.sgbstdn_pidm = pnPidm
                                             and b.sgbstdn_term_code_eff <= vsPerio
                                           )
             and a.sgbstdn_pidm          = pnPidm;
      exception
          when others then
               null;
      end;

      if vsCampDesc is null then
         for regCmp in cuCamp loop
             if vsCampDesc is null then
                g$_vpdi_security.g$_vpdi_set_home_context(regCmp.campCode);

                begin
                    select pk_Catalogo.universidad(a.sgbstdn_camp_code),
                           sgbstdn_program_1,
                           pk_Catalogo.programa(sgbstdn_program_1),
                           sgbstdn_levl_code,
                           sgbstdn_rate_code
                      into vsCampDesc,
                           vsProgCode,
                           vsProgDesc,
                           vsLevlCode,
                           vsRateCode
                      from sgbstdn a
                     where a.sgbstdn_term_code_eff = (select max(b.sgbstdn_term_code_eff)
                                                        from sgbstdn b
                                                       where b.sgbstdn_pidm = pnPidm
                                                       and b.sgbstdn_term_code_eff <= vsPerio
                                                     )
                       and a.sgbstdn_pidm          = pnPidm;
                exception
                    when others then
                         null;
                end;

             end if;
         end loop;

         g$_vpdi_security.g$_vpdi_set_home_context(vsVpdiAnterior);

      end if;

      begin
          select smbpgen_req_credits_overall
            into vsOverall
            from smbpgen
           where smbpgen_program = vsProgCode;
      exception
          when others then
               null;
      end;

      begin
          select pk_Catalogo.colegio(smrprle_coll_code)
            into vsCollDesc
            from smrprle
           where smrprle_program = vsProgCode;
      exception
          when others then
               null;
      end;

      --creditos ganados
      begin
          select decode(sum(nvl(a.shrtgpa_hours_earned,0)),0,null,sum(nvl(a.shrtgpa_hours_earned,0)))
            into vsErned
            from shrtgpa a
           where a.shrtgpa_pidm       = pnPidm
             and a.shrtgpa_levl_code  = vsLevlCode
             and a.shrtgpa_term_code <= vsPerio;
      exception
          when others then
               null;
      end;

      begin
          select sum(NVL(sfrstcr_credit_hr,0))
            into vsCredito
            from sfrstcr
           where sfrstcr_rsts_code in ('RE','RW')
             and sfrstcr_term_code  = vsPerio
             and sfrstcr_pidm       = pnPidm;
      exception
          when others then
               null;
      end;

      return vsCampDesc;

  exception
      when no_data_found then
           g$_vpdi_security.g$_vpdi_set_home_context(vsVpdiAnterior);
           return null;
      when others then
           g$_vpdi_security.g$_vpdi_set_home_context(vsVpdiAnterior);
           return null;
  end f_Campus;

  -- obtiene el sexo de la persona
  function f_Sexo(pnPidm number) return varchar2 is

  vsSexo  varchar2(20) := null;
  vsEdad  varchar2(10) := null;

  begin

      select decode(spbpers_sex,'F','Femenino','M','Masculino','No disponible'),
             to_char(spbpers_birth_date,'dd/mm/yyyy'),
             to_char(spbpers_birth_date,'yyyymmdd')
        into vsSexo,
             vsFecha,
             vsEdad
        from spbpers
       where spbpers_pidm = pnPidm;

      if vsEdad is not null then
         vnEdad := trunc((to_number(to_char(sysdate,'yyyymmdd')) - to_number(vsEdad))/10000);
      end if;

      return vsSexo;

  exception
      when no_data_found then
           return vsSexo;
      when others then
           return vsSexo;
  end f_Sexo;

  function f_Points(pnSrnn integer,
                    psQcod varchar2,
                    pnPidm number,
                    psAnsw varchar2,
                    pnMaxw integer,
                    psAcod varchar2,
                    psAco2 varchar2) return varchar2 is

  type tablePoints is table of number;

  tabPont  tablePoints  := tablePoints(1);
  vnPoints number(10,4) := null;
  vsAnswer clob         := null;
  vnSequen integer      := null;

  begin
      if 'COMENT' in (psAco2, psAcod) then
         htp.p('<td valign="top" width="'||vnWithTD||'px;">');
      else
         htp.p('<td align="center" valign="top">');
      end if;

      if psAnsw = 'MS' then
         for vnI in 1..pnMaxw loop
             tabPont.extend(vnI);
             tabPont(vnI) := null;
         end loop;

         vnTDwidth := 100/pnMaxw;

         htp.p('
         <table border="0" cellpadding="0" cellspacing="0" width="100%">
         <tr>
         ');
      end if;

      for regArh in cuArchivo(pnSrnn, psQcod, pnPidm) loop
          vnPoints := regArh.pvac;
          vsAnswer := regArh.opin;
          vnSequen := regArh.seqn;

          if psAnsw = 'MS' then
             tabPont(vnSequen) := vnPoints;
          else
             if 'COMENT' in (psAco2, psAcod) then
                htp.p(vsAnswer);
             else
                htp.p(vnPoints);
             end if;
          end if;

      end loop;

      if psAnsw = 'MS' then
         for vnI in 1..pnMaxw loop
             htp.p('
             <td width="'||vnTDwidth||'%" valign="top">
             '||tabPont(vnI)||'
             </td>');
         end loop;

         htp.p('</tr></table>');
      end if;

      htp.p('</td>');

      return null;
  end f_Points;

  function f_AsnMax(psAcod varchar2,
                    psAsnw in out varchar2) return integer is

  vnMaxw INTEGER := 0;

  begin
      psAsnw := NULL;

      begin
          select gvvacod_answ
            into psAsnw
            from gvvacod
           where gvvacod_code = psAcod;
      exception
          when others then
               null;
      end;

      if psAsnw = 'MS' then
         begin
             select max(gvrpvac_seq_num)
               into vnMaxw
               from gvrpvac
              where gvrpvac_acod_code = psAcod;
         exception
             when others then
                  null;
         end;
      end if;

      return vnMaxw;

  end f_AsnMax;

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;
         htp.p('<script language="javascript" src="kwacnls.js"></script>');

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      vsRate  := pk_objHTML.getValueCookie('psRatS');
      vsUnive := pk_objHTML.getValueCookie('psUnive');
      vsEncst := pk_objHTML.getValueCookie('psEncst');
      vnNmRfE := pk_objHTML.getValueCookie('psNmRfE');
      vsPerio := pk_objHTML.getValueCookie('psTerm');
      vsAccpr := pk_objHTML.getValueCookie('psAccpr');
      vsEscul := pk_objHTML.getValueCookie('psEscu');

      SELECT GVVGSRC_DESC
        INTO vsDescEncst
        FROM GVVGSRC
       WHERE GVVGSRC_CODE = vsEncst;

      FOR regReac IN cuReactivo(vnNmRfE, vsEncst) LOOP
          vnRow := vnRow + 1;

          tabReac(vnRow).rAcod := regReac.Acod;
          tabReac(vnRow).rQcod := regReac.Qcod;
          tabReac(vnRow).rGvbq := regReac.Gvbq;
          tabReac(vnRow).rWeid := regReac.Weid;
          tabReac(vnRow).rGsrc := vsEncst;

          IF regReac.SubE = 'Y' THEN
             FOR regSub IN cuSubEnc(vsEncst, regReac.Qcod) LOOP
                 FOR regSubE IN cuReactiv2(vnNmRfE, regSub.GSRC) LOOP
                     vnRow := vnRow + 1;

                     tabReac(vnRow).rAcod := regSubE.Acod;
                     tabReac(vnRow).rQcod := regSubE.Qcod;
                     tabReac(vnRow).rGvbq := regSubE.Gvbq;
                     tabReac(vnRow).rWeid := regSubE.Weid;
                     tabReac(vnRow).rGsrc := regSub.GSRC;
                 END LOOP;
             END LOOP;
          END IF;
      END LOOP;

      FOR vnI IN 1..vnRow LOOP
          vsAsnw             :=  NULL;
          tabReac(vnI).rMaxw := f_AsnMax(tabReac(vnI).rAcod, vsAsnw);
          tabReac(vnI).rAnsw := vsAsnw;
      END LOOP;

      vnWithTable := (vnWithTD * 14) + (vnWit2Td * vnRow);

      htp.p('<html><head><title>&nbsp;</title>');

      -- la aplicacin no se guarda en el cache de la maquina.
      pk_objHTML.P_NoCache;

      --cdigo css
      pk_objHTML.P_CssTabs;

      htp.p('<script language="JavaScript"><!--');
      htp.p('function fImprimeReporte() {
      window.focus()
      print();
      }');
      htp.p('--></script>');

      htp.p('</head><body bgcolor="#ffffff" class="bodyCeroR"><br/>
      <table border="0" cellpadding="2" cellspacing="1" width="100%" bgcolor="#ffffff" bordercolor="#ffffff">
      <tr><td width="10%" rowspan="3"><img src="/imagenes/logo_uft.jpg" border="0" width="80"/></td>
          <td width="90%" class="tdTitulo"><b>&nbsp;&nbsp;'||vsDescEncst||' ('||vsEncst||'), NRE: '||vnNmRfE||', Periodo:'||vsPerio||'</td></tr>
      <tr><th align="left">&nbsp;&nbsp;'||psReclDesc||'</th></tr>
      <tr><td>&nbsp;&nbsp;'||pK_Seprad1.F_Fecha||'</td></tr>
      <tr><td colspan="2">&nbsp;</td>
      </table>

      <table border="1" width="'||vnWithTable||'px;" >
      <tr><th colspan="12" bgcolor="#efefef" '||pk_objHTML.vgsBorderDDDDDD||' align="right">C&Oacute;DIGO DE LA ENCUESTA</th>
      ');

      FOR vnI IN 1..vnRow LOOP
          htp.p('<th bgcolor="#efefef" '||pk_objHTML.vgsBorderDDDDDD||'>'||tabReac(vnI).rGsrc||'</th>');
      END LOOP;

      htp.p('
          </tr>
      <tr bgcolor="#efefef">
      <th valign="bottom" align="left" width="'||vnWithTD||'px;" rowspan="3" '||pk_objHTML.vgsBorderDDDDDD||'>No. Registro                               </th>
      <th valign="bottom" align="left" width="'||vnWithTD||'px;" rowspan="3" '||pk_objHTML.vgsBorderDDDDDD||'>Estatus de la encuesta                     </th>
      <th valign="bottom" align="left" width="'||vnWithTD||'px;" rowspan="3" '||pk_objHTML.vgsBorderDDDDDD||'>Campus                                     </th>
      <th valign="bottom" align="left" width="'||vnWithTD||'px;" rowspan="3" '||pk_objHTML.vgsBorderDDDDDD||'>Programa                                   </th>
      <th valign="bottom" align="left" width="'||vnWithTD||'px;" rowspan="3" '||pk_objHTML.vgsBorderDDDDDD||'>Descripci&oacute;n del programa            </th>
      <th valign="bottom" align="left" width="'||vnWithTD||'px;" rowspan="3" '||pk_objHTML.vgsBorderDDDDDD||'>Id                                         </th>
      <th valign="bottom" align="left" width="'||vnWithTD||'px;" rowspan="3" '||pk_objHTML.vgsBorderDDDDDD||'>Nombre                                     </th>
      <th valign="bottom" align="left" width="'||vnWithTD||'px;" rowspan="3" '||pk_objHTML.vgsBorderDDDDDD||'>Rut                                        </th>
      <th valign="bottom" align="left" width="'||vnWithTD||'px;" rowspan="3" '||pk_objHTML.vgsBorderDDDDDD||'>Escuela o Facultad del programa            </th>
      <th valign="bottom" align="left" width="'||vnWithTD||'px;" rowspan="3" '||pk_objHTML.vgsBorderDDDDDD||'>Sede                                       </th>
      <th valign="bottom" align="left" width="'||vnWithTD||'px;" rowspan="3" '||pk_objHTML.vgsBorderDDDDDD||'>Sede - Descripci&oacute;n                  </th>
      <th valign="bottom" align="left" width="'||vnWithTD||'px;" rowspan="3" '||pk_objHTML.vgsBorderDDDDDD||'>No. Cr&eacute;ditos del programa           </th>
      <th valign="bottom" align="left" width="'||vnWithTD||'px;" rowspan="3" '||pk_objHTML.vgsBorderDDDDDD||'>No. Cr&eacute;ditos ganados por el alumno  </th>
      <th valign="bottom" align="left" width="'||vnWithTD||'px;" rowspan="3" '||pk_objHTML.vgsBorderDDDDDD||'>No. Cr&eacute;ditos inscritos por el alumno</th>
      <th valign="bottom" align="left" width="'||vnWithTD||'px;" rowspan="3" '||pk_objHTML.vgsBorderDDDDDD||'>Sexo                                       </th>
      <th valign="bottom" align="left" width="'||vnWithTD||'px;" rowspan="3" '||pk_objHTML.vgsBorderDDDDDD||'>Fecha de nacimiento                        </th>
      <th valign="bottom" align="left" width="'||vnWithTD||'px;" rowspan="3" '||pk_objHTML.vgsBorderDDDDDD||'>Edad                                       </th>
      ');

      FOR vnI IN 1..vnRow LOOP
          SELECT DECODE(tabReac(vnI).rMaxw,0,2,tabReac(vnI).rMaxw)
            INTO vnTDwidth
            FROM DUAL;

          htp.p('<th valign="bottom" align="left" '||pk_objHTML.vgsBorderDDDDDD||'>
          <table border="0" cellpadding="0" cellspacing="0" width="100%">
          <tr><td colspan="'||vnTDwidth||'">'||tabReac(vnI).rAcod||'</td></tr>
          ');

          IF tabReac(vnI).rAnsw = 'MS' THEN
             vnTDwidth := 100/tabReac(vnI).rMaxw;

             htp.p('<tr>');

             FOR regAns IN cuAnswer(tabReac(vnI).rAcod) LOOP
                 htp.p('<td width="'||vnTDwidth||'%" class="tdFont7">'||regAns.pvacDesc||'</td>');
             END LOOP;

             htp.p('</tr><tr>');

             FOR regAns IN cuAnswer(tabReac(vnI).rAcod) LOOP
                 htp.p('<td>'||regAns.pvacQpoi||'</td>');
             END LOOP;

             htp.p('</tr>');

          ELSE
             FOR regAns IN cuAnswer(tabReac(vnI).rAcod) LOOP
                 htp.p('<tr><td width="70%">'||regAns.pvacDesc||'</td><td width="30%">'||regAns.pvacQpoi||'</td></tr>');
             END LOOP;
          END IF;

          htp.p('</table>');

      END LOOP;

      htp.p('</tr><tr bgcolor="#efefef">');

      FOR vnI IN 1..vnRow LOOP
          htp.p('<th valign="bottom" align="left" '||pk_objHTML.vgsBorderDDDDDD||' width="'||vnWit2Td||'px;">'||tabReac(vnI).rGvbq||'</th>');
      END LOOP;

      htp.p('</tr><tr bgcolor="#efefef">');

      FOR vnI IN 1..vnRow LOOP
          htp.p('<th valign="bottom" '||pk_objHTML.vgsBorderDDDDDD||' >'||tabReac(vnI).rQcod||'</th>');
      END LOOP;

      htp.p('</tr>');

      FOR regEnc IN cuEncuestados(vnNmRfE, vsRate) LOOP
          vnReg := vnReg + 1;

          htp.p('
          <tr>
          <td valign="top" align="right"  '||pk_objHTML.vgsBorderDDDDDD||'>'||vnReg                ||'</td>
          <td valign="top" align="left"   '||pk_objHTML.vgsBorderDDDDDD||'>'||regEnc.Status        ||'</td>
          <td valign="top" align="left"   '||pk_objHTML.vgsBorderDDDDDD||'>'||f_Campus(regEnc.Pidm)||'</td>
          <td valign="top" align="left"   '||pk_objHTML.vgsBorderDDDDDD||'>'||vsProgCode           ||'</td>
          <td valign="top" align="left"   '||pk_objHTML.vgsBorderDDDDDD||'>'||vsProgDesc           ||'</td>
          <td valign="top" align="left"   '||pk_objHTML.vgsBorderDDDDDD||'>'||regEnc.Id            ||'</td>
          <td valign="top" align="left"   '||pk_objHTML.vgsBorderDDDDDD||'>'||regEnc.Nombre        ||'</td>
          <td valign="top" align="left"   '||pk_objHTML.vgsBorderDDDDDD||'>'||regEnc.Sufijo           ||'</td>
          <td valign="top" align="left"   '||pk_objHTML.vgsBorderDDDDDD||'>'||vsCollDesc           ||'</td>
          <td valign="top" align="left"   '||pk_objHTML.vgsBorderDDDDDD||'>'||vsRateCode           ||'</td>
          <td valign="top" align="left"   '||pk_objHTML.vgsBorderDDDDDD||'>'||pk_catalogo.fstvrate(vsRateCode)||'</td>
          <td valign="top" align="center" '||pk_objHTML.vgsBorderDDDDDD||'>'||vsOverall            ||'</td>
          <td valign="top" align="center" '||pk_objHTML.vgsBorderDDDDDD||'>'||vsErned              ||'</td>
          <td valign="top" align="center" '||pk_objHTML.vgsBorderDDDDDD||'>'||vsCredito            ||'</td>
          <td valign="top" align="center" '||pk_objHTML.vgsBorderDDDDDD||'>'||f_Sexo(regEnc.Pidm)  ||'</td>
          <td valign="top" align="center" '||pk_objHTML.vgsBorderDDDDDD||'>'||vsFecha              ||'</td>
          <td valign="top" align="center" '||pk_objHTML.vgsBorderDDDDDD||'>'||vnEdad               ||'</td>
          ');

          FOR vnI IN 1..vnRow LOOP
              htp.p(f_Points(vnNmRfE, tabReac(vnI).rQcod, regEnc.Temp, tabReac(vnI).rAnsw, tabReac(vnI).rMaxw, tabReac(vnI).rAcod, tabReac(vnI).rWeid));
          END LOOP;

          htp.p('
          </tr>
          ');
      END LOOP;

      htp.p('</table>
      <br/>
      <br/>
      </body></html>
      ');
  EXCEPTION
      WHEN OTHERS THEN
           htp.p(sqlerrm);
  END PWRADME;
/


DROP PUBLIC SYNONYM PWRADME;

CREATE PUBLIC SYNONYM PWRADME FOR BANINST1.PWRADME;


GRANT EXECUTE ON BANINST1.PWRADME TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRADME TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRAEST;

CREATE OR REPLACE PROCEDURE BANINST1.PWRAEST( psTerm    IN  VARCHAR2,
                                                                             psNRC      IN  VARCHAR2)  IS
vsreprobada   number:=0;
vshistacadem  number:=0;
vscuenta         number:=0;
vnCode  SCBCRSE.SCBCRSE_SUBJ_CODE%TYPE;
vnNumb SCBCRSE.SCBCRSE_CRSE_NUMB%TYPE;

global_pidm            spriden.spriden_pidm%TYPE;
curr_release        CONSTANT VARCHAR2 (10)             := '8.1.1';


 CURSOR materiaSeleccionada  (     psTerm        VARCHAR2  DEFAULT NULL,
                                                psPidm        VARCHAR2  DEFAULT NULL,
                                                psNRC        VARCHAR2  DEFAULT NULL) IS
                        SELECT  SCBCRSE_SUBJ_CODE,
                                    SCBCRSE_CRSE_NUMB
                            FROM SFRSTCR, SSBSECT, SCBCRSE A
                        WHERE SFRSTCR_CRN = SSBSECT_CRN
                            AND SFRSTCR_TERM_CODE = SSBSECT_TERM_CODE
                            AND SSBSECT_SUBJ_CODE = SCBCRSE_SUBJ_CODE
                            AND SSBSECT_CRSE_NUMB = SCBCRSE_CRSE_NUMB
                            AND SFRSTCR_PIDM = psPidm
                            AND SFRSTCR_TERM_CODE = psTerm
                            AND SFRSTCR_CRN=psNRC
                            AND SFRSTCR_RSTS_CODE IN ('RE','RW')
                            AND A.SCBCRSE_EFF_TERM = (SELECT MAX(B.SCBCRSE_EFF_TERM) FROM SCBCRSE B
                                                                        WHERE A.SCBCRSE_SUBJ_CODE = B.SCBCRSE_SUBJ_CODE
                                                                            AND A.SCBCRSE_CRSE_NUMB = B.SCBCRSE_CRSE_NUMB);

BEGIN

    IF NOT twbkwbis.f_validuser (global_pidm) THEN  RETURN; END IF;

    bwckfrmt.p_open_doc ('PWRAEST');
    twbkwbis.p_dispinfo ('PWRAEST');

   OPEN materiaSeleccionada (psTerm,global_pidm,psNRC);
   FETCH materiaSeleccionada  INTO vnCode,vnNumb;
   CLOSE materiaSeleccionada ;

        select count(*) into vsreprobada
              FROM SHRTCKN N, SHRTCKG G, SGBSTDN S, SPRIDEN, SPBPERS
             WHERE S.SGBSTDN_PIDM = N.SHRTCKN_PIDM
               AND S.SGBSTDN_PIDM = SPRIDEN_PIDM
               AND n.shrtckn_pidm = global_pidm
               --and n.shrtckn_TERM_CODE = psTerm
               and shrtckn_SUBJ_CODE=vnCode
               and shrtckn_CRSE_NUMB=vnNumb
               AND S.SGBSTDN_TERM_CODE_EFF =
                                      (SELECT MAX (SS.SGBSTDN_TERM_CODE_EFF)
                                         FROM SGBSTDN SS
                                        WHERE SGBSTDN_PIDM = N.SHRTCKN_PIDM)
               AND G.SHRTCKG_PIDM = N.SHRTCKN_PIDM
               AND G.SHRTCKG_TERM_CODE = N.SHRTCKN_TERM_CODE
               AND G.SHRTCKG_TCKN_SEQ_NO = N.SHRTCKN_SEQ_NO
               AND G.SHRTCKG_SEQ_NO =
                      (SELECT MAX (G1.SHRTCKG_SEQ_NO)
                         FROM SHRTCKG G1
                        WHERE G1.SHRTCKG_PIDM = G.SHRTCKG_PIDM
                          AND G1.SHRTCKG_TERM_CODE = G.SHRTCKG_TERM_CODE
                          AND G1.SHRTCKG_TCKN_SEQ_NO = G.SHRTCKG_TCKN_SEQ_NO)
                          AND SPRIDEN_CHANGE_IND IS NULL
               AND G.SHRTCKG_GRDE_CODE_FINAL<'4,0';

        select count(*) into vshistacadem
          from   SHRTCKN
        WHERE  shrtckn_SUBJ_CODE        =vnCode
        and shrtckn_CRSE_NUMB             =vnNumb
        AND SHRTCKN_PIDM                 = global_pidm;

        select count(*) into vscuenta
          from   SFRSTCR
        WHERE  SFRSTCR_PIDM                 = global_pidm
        AND SFRSTCR_TERM_CODE       = psTerm;

        if vsreprobada=0 and vshistacadem=0 and vsreprobada=0 then
                UPDATE SFRSTCR
                SET SFRSTCR_RSTS_CODE            = 'RS'
                WHERE SFRSTCR_CRN                  = psNRC
                    AND SFRSTCR_PIDM                = global_pidm
                    AND SFRSTCR_TERM_CODE      = psTerm;
                htp.p('<script type="text/javascript"> alert("La materia ha sido dada de baja"); location.href="PWRBAJS";</script>');
                --HTP.P('La materia '||psNRC||' del periodo '||psTerm||' ha sido dada de baja');
               COMMIT;
        end if;
        if vsreprobada<>0 or vshistacadem<>0 then
          if vsreprobada<>0 then
                htp.p('<script type="text/javascript"> alert("Esta materia no se puede dar de baja: Ya ha sido reprobada"); location.href="PWRBAJS";</script>');
            else
                htp.p('<script type="text/javascript"> alert("Esta materia no se puede dar de baja: Tiene historia acadmica"); location.href="PWRBAJS";</script>');
          end if;
        end if;


        twbkwbis.p_closedoc (curr_release);

END PWRAEST;
/


DROP PUBLIC SYNONYM PWRAEST;

CREATE PUBLIC SYNONYM PWRAEST FOR BANINST1.PWRAEST;


GRANT EXECUTE ON BANINST1.PWRAEST TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRAEST TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRAEST TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRAEST TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRAIMD;

CREATE OR REPLACE PROCEDURE BANINST1.PWRAIMD(psReclDesc VARCHAR2) IS
/*
        Nombre: Reporte de alumnos inscritos con menos de 18 crditos
         Fecha: 02/03/2011
        Modulo: Seleccin de Cursos
         Autor: MAC

*/

ckNombres    owa_cookie.vc_arr;
ckValores    owa_cookie.vc_arr;
ckCount      INTEGER;
vgsInicoPag  VARCHAR2(10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
vgsUSR       VARCHAR2(500);

  vnRow      INTEGER                := 0;
  vnExists   INTEGER                := 0;
  vnColumnas INTEGER                := 5;
  tabColumna Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vsPerio    VARCHAR2(20)           := NULL;
  vsUniv     VARCHAR2(20)           := NULL;
  vsProgr    VARCHAR2(20)           := NULL;
  vsFacu     VARCHAR2(20)           := NULL;
  vsSeccion  VARCHAR2(3)            := NULL;
  vsTermCode VARCHAR2(6)            := NULL;

  CURSOR cuReporte(psUniv  VARCHAR2 DEFAULT NULL,
                   psPerio VARCHAR2 DEFAULT NULL,
                   psFacu  VARCHAR2 DEFAULT NULL) IS
         SELECT SFRSTCR_TERM_CODE                        termCode,
                SGBSTDN_CAMP_CODE                        campCode,
                Pk_Catalogo.COLEGIO(SGBSTDN_COLL_CODE_1) collDesc,
                SPRIDEN_ID                               Id,
                F_GET_RUT(SPRIDEN_PIDM)                  RUT,
                Pk_Catalogo.NOMBRE(SPRIDEN_PIDM)         Nombre,
                SUM(NVL(SFRSTCR_CREDIT_HR,0))            Creditos
           FROM SGBSTDN A,
                SPRIDEN,
                SFRSTCR
          WHERE SPRIDEN_PIDM             = A.SGBSTDN_PIDM
            AND SPRIDEN_CHANGE_IND      IS NULL
            AND A.SGBSTDN_TERM_CODE_EFF  = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                              FROM SGBSTDN B
                                             WHERE B.SGBSTDN_PIDM           = A.SGBSTDN_PIDM
                                               AND B.SGBSTDN_STST_CODE      = 'AS'
                                               AND B.SGBSTDN_TERM_CODE_EFF <= SFRSTCR_TERM_CODE
                                           )
            AND SFRSTCR_PIDM             = SPRIDEN_PIDM
            AND NVL(SFRSTCR_CREDIT_HR,0) > 0
            AND SFRSTCR_RSTS_CODE       IN ('RE','RW')
            AND (SFRSTCR_TERM_CODE   = psPerio OR psPerio IS NULL)
            AND (SGBSTDN_CAMP_CODE   = psUniv  OR psUniv IS NULL)
            AND (SGBSTDN_COLL_CODE_1 = psFacu  OR psFacu  IS NULL)
         HAVING SUM(NVL(SFRSTCR_CREDIT_HR,0)) < 18
          GROUP BY SFRSTCR_TERM_CODE,
                   SGBSTDN_CAMP_CODE,
                   SGBSTDN_COLL_CODE_1,
                   SPRIDEN_PIDM,
                   SPRIDEN_ID
          ORDER BY termCode DESC, collDesc, NOMBRE;

  BEGIN
      /* Check/update the user's web session */
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

     IF ckCount != 0 THEN
        FOR vnCOKIES IN 1..ckCount LOOP
            IF    ckNOMBRES(vnCOKIES) = 'psUnive' THEN
                  vsUniv := ckValores(vnCOKIES);

            ELSIF ckNOMBRES(vnCOKIES) = 'psPerio' THEN
                  vsPerio  := ckValores(vnCOKIES);

            ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                  vsFacu := ckValores(vnCOKIES);

            ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                  vsSeccion := ckValores(vnCOKIES);

            END IF;
        END LOOP;
     END IF;

     -- las instrucciones determinan el largo de la tabla
     FOR vnI IN 1..vnColumnas LOOP
         tabColumna.EXTEND(vnI);
         tabColumna(vnI) := NULL;
     END LOOP;

     tabColumna(1) := 'Escuela';
     tabColumna(2) := 'ID';
     tabColumna(3) := 'RUT';
     tabColumna(4) := 'Nombre';
     tabColumna(5) := 'Cr&eacute;ditos inscritos';

     FOR regRep IN cuReporte(vsUniv, vsPerio, vsFacu) LOOP
         IF vsTermCode IS NULL OR vsTermCode <> regRep.TermCode OR vnRow = 30 THEN
            Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vgsInicoPag,'1',psSubtitulo=>'Periodo '||regRep.TermCode,psUsuario=>vgsUSR,psSeccion=>vsSeccion,psUniversidad=>regRep.campCode);
            vgsInicoPag := 'SALTO';

            vnRow  := 0;
         END IF;

         htp.p('
         <tr>
         <td valign="top">'||regRep.collDesc||'</td>
         <td valign="top">'||regRep.Id      ||'</td>
         <td valign="top">'||regRep.RUT     ||'</td>
         <td valign="top">'||regRep.Nombre  ||'</td>
         <td valign="top">'||regRep.Creditos||'</td>
         </tr>
         ');

         vsTermCode := regRep.TermCode;
         vnExists := 1;
         vnRow    := vnRow + 1;
     END LOOP;

     IF vnExists = 0 THEN
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
     ELSE
        -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pagina
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>vgsUSR, psSeccion=>vsSeccion);
     END IF;

     htp.p('</table></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           HTP.P(SQLERRM);

  END PWRAIMD;
/


DROP PUBLIC SYNONYM PWRAIMD;

CREATE PUBLIC SYNONYM PWRAIMD FOR BANINST1.PWRAIMD;


GRANT EXECUTE ON BANINST1.PWRAIMD TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRAIMD TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRAIMR;

CREATE OR REPLACE PROCEDURE BANINST1.PWRAIMR(psReclDesc VARCHAR2) IS

/**************************************************************
           tarea:  procedimiento para el reporte de alumnos inscritos a materias aprobadas
         mdulo:  seleccin de cursos
           autor:  horacio martnez ramrez - hmr
           fecha:  05/sep/2010
**************************************************************/

  vnRow      INTEGER                            := 0;
  vnExists   INTEGER                            := 0;
  vnColumnas INTEGER                            := 11;
  tabColumna Pk_Sisrepimp.tipoTabla             := Pk_Sisrepimp.tipoTabla(1);
  vsPerio    SIBINST.SIBINST_TERM_CODE_EFF%TYPE := NULL;
  vsUniv     STVCAMP.STVCAMP_CODE%TYPE          := NULL;
  vsFacu     STVSBGI.STVSBGI_DESC%TYPE          := NULL;
  vsProgr    SMRPRLE.SMRPRLE_PROGRAM_DESC%TYPE  := NULL;
  vsSeccion  VARCHAR2(3)                        := NULL;
  vsTermCode VARCHAR2(6)                        := NULL;
  vsCampCode VARCHAR2(6)                        := NULL;
  vsID       VARCHAR2(10)                       := NULL;
  vsID2      VARCHAR2(10)                       := NULL;
  vsStyle    VARCHAR2(50)                       := NULL;
  vsInicoPag VARCHAR2(10)                       := NULL;

  CURSOR cuReporte(psUniv  VARCHAR2 DEFAULT NULL,
                             psPerio VARCHAR2 DEFAULT NULL,
                             psFacu  VARCHAR2 DEFAULT NULL,
                             psProgr VARCHAR2 DEFAULT NULL) IS
         SELECT SGBSTDN_CAMP_CODE                                           campCode,
                SFRSTCR_TERM_CODE                                           termCode,
                SGBSTDN_COLL_CODE_1                                         collCode,
                Pk_Catalogo.COLEGIO(SGBSTDN_COLL_CODE_1)                    collDesc,
                SGBSTDN_PROGRAM_1                                           prgmCode,
                Pk_Catalogo.PROGRAMA(SGBSTDN_PROGRAM_1)                     prgmDesc,
                SGBSTDN_PIDM                                                PIDM,
                SPRIDEN_ID                                                  Id,
                SPBPERS_NAME_SUFFIX                                         Rut,
                REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME,'*',' ') Nombre,
                (SELECT SGBUSER_SUDA_CODE
                   FROM SGBUSER
                  WHERE SGBUSER_TERM_CODE = SFRSTCR_TERM_CODE
                    AND SGBUSER_PIDM      = SFRSTCR_PIDM
                )                                                           Semestre,
               FWATELE(SGBSTDN_PIDM)                                        Telefono,
               SSBSECT_SUBJ_CODE                                            Subj,
               SSBSECT_CRSE_NUMB                                            Crse
          FROM SFRSTCR,
               SGBSTDN A,
               SPRIDEN,
               SSBSECT,
               SPBPERS
         WHERE A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                            FROM SGBSTDN B
                                           WHERE B.SGBSTDN_PIDM            = A.SGBSTDN_PIDM
                                             AND B.SGBSTDN_TERM_CODE_EFF  <= SFRSTCR_TERM_CODE
                                         )
               AND A.SGBSTDN_PIDM          = SFRSTCR_PIDM
               AND SPRIDEN_CHANGE_IND     IS NULL
               AND A.SGBSTDN_PIDM          = SPRIDEN_PIDM
               AND A.SGBSTDN_STST_CODE     = 'AS'
               AND SSBSECT_TERM_CODE       = SFRSTCR_TERM_CODE
               AND SSBSECT_CRN             = SFRSTCR_CRN
               AND SGBSTDN_PIDM            = SPBPERS_PIDM
               AND SFRSTCR_RSTS_CODE      IN (SELECT STVRSTS_CODE FROM STVRSTS WHERE STVRSTS_INCL_SECT_ENRL = 'Y')
               AND EXISTS (SELECT NULL
                                    FROM SWVHIAC
                                  WHERE SWVHIAC_PIDM       = SFRSTCR_PIDM
                                      AND SWVHIAC_SUBJ       = SSBSECT_SUBJ_CODE
                                      AND SWVHIAC_CRSE       = SSBSECT_CRSE_NUMB
                                      AND SWVHIAC_PASSED_IND = 'Y'
                                      AND SWVHIAC_CALIF     <> 'RM'
                      )
               AND NOT EXISTS (SELECT NULL
                                           FROM SPRHOLD,STVHLDD
                                          WHERE SPRHOLD_pidm              = SFRSTCR_PIDM
                                              AND TRUNC(SPRHOLD_FROM_DATE) <= TRUNC(SYSDATE)
                                              AND TRUNC(SPRHOLD_TO_DATE)   >= TRUNC(SYSDATE)
                                              AND STVHLDD_CODE              = SPRHOLD_HLDD_CODE
                                              AND STVHLDD_REG_HOLD_IND      = 'Y'
                      )
               AND (SGBSTDN_CAMP_CODE   = psUniv  OR psUniv  IS NULL)
               AND (SFRSTCR_TERM_CODE   = psPerio OR psPerio IS NULL)
               AND (SGBSTDN_COLL_CODE_1 = psFacu  OR psFacu  IS NULL)
               AND (SGBSTDN_PROGRAM_1   = psProgr OR psProgr IS NULL)
            ORDER BY campCode, termCode DESC, prgmCode, Nombre;

  -- obtiene el correo electrnico del alumno
  CURSOR cuGoremal (pnPidm NUMBER) IS
         SELECT GOREMAL_EMAIL_ADDRESS
           FROM GOREMAL
          WHERE GOREMAL_PIDM           = pnPidm
              AND GOREMAL_EMAL_CODE      = 'PR'
              AND GOREMAL_STATUS_IND     = 'A'
              AND GOREMAL_EMAIL_ADDRESS IS NOT NULL;

  function detalle return varchar2 is

  BEGIN
      return '<tr bgcolor="#efefef"><td colspan="5"></td><th colspan="4">Materias aprobadas</th><td colspan="2"></td></tr>';

  END detalle;

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      -- son buscadas los valores de las cookies para asignar los valores del filtro del query.
      vsPerio   := pk_ObjHtml.getValueCookie('psPerio');
      vsUniv    := pk_ObjHtml.getValueCookie('psUnive');
      vsFacu    := pk_ObjHtml.getValueCookie('psFacu');
      vsProgr   := pk_ObjHtml.getValueCookie('psProgr');
      vsSeccion := pk_ObjHtml.getValueCookie('cookSeccion');

      -- las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
            tabColumna.EXTEND(vnI);
            tabColumna(vnI) := NULL;
      END LOOP;

     tabColumna(1)  := 'Escuela';
     tabColumna(2)  := 'Programa';
     tabColumna(3)  := 'Descripci&oacute;n';
     tabColumna(4)  := 'Id';
     tabColumna(5)  := 'Rut';
     tabColumna(6)  := 'Alumno';
     tabColumna(7)  := 'Materia';
     tabColumna(8)  := 'Curso';
     tabColumna(9)  := 'Semestre';
     tabColumna(10) := 'Tel&eacute;fono';
     tabColumna(11) := 'Correo electr&oacute;nico';

     -- materias aprobadas
     FOR regRep IN cuReporte(vsUniv, vsPerio, vsFacu, vsProgr) LOOP
         IF vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
             vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR vnRow = 18 THEN

             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicoPag,'1',psSubtitulo=>'<br>Periodo '||regRep.termCode,psUsuario=>pk_login.vgsUSR,psSeccion=>vsSeccion,psUniversidad=>regRep.campCode, psDetalle=>detalle);

             vsInicoPag := 'SALTO';
             vnRow := 0;

         END IF;

         vsID2 := regRep.Id;

         IF vsID = regRep.Id THEN
             regRep.collDesc := NULL;
             regRep.prgmCode := NULL;
             regRep.prgmDesc := NULL;
             regRep.Id       := NULL;
             regRep.Nombre   := NULL;
             regRep.Semestre := NULL;
             regRep.Telefono := NULL;
             vsStyle := 'style="border-top:none;"';
         ELSE
             vsStyle := 'style="border-bottom:none;"';
         END IF;

         htp.p('<tr><td valign="top" '||vsStyle||'>'||regRep.collDesc||'</td>
                        <td valign="top" '||vsStyle||'>'||regRep.prgmCode||'</td>
                        <td valign="top" '||vsStyle||'>'||regRep.prgmDesc||'</td>
                        <td valign="top" '||vsStyle||'>'||regRep.Id||'</td>
                        <td valign="top" '||vsStyle||'>'||regRep.Rut||'</td>
                        <td valign="top" '||vsStyle||'>'||regRep.Nombre||'</td>
                        <td valign="top" '||vsStyle||'>'||regRep.Subj||'</td>
                        <td valign="top" '||vsStyle||'>'||regRep.Crse||'</td>
                        <td valign="top" '||vsStyle||'>'||regRep.Semestre||'</td>
                        <td valign="top" '||vsStyle||'>'||regRep.Telefono||'</td>
                        <td valign="top" '||vsStyle||'>' );

         regRep.Id := vsID2;

         IF vsID IS NULL OR vsID <> regRep.Id THEN
             FOR regGrm IN cuGoremal(regRep.PIDM)  LOOP
                   htp.p(regGrm.GOREMAL_EMAIL_ADDRESS||'<BR>');
             END LOOP;
         END IF;

         htp.p('</td></tr>');

         vnExists       := 1;
         vnRow         := vnRow + 1;
         vsTermCode  := regRep.termCode;
         vsCampCode := regRep.campCode;
         vsID            := regRep.Id;
     END LOOP;

     IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
     ELSE
        -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pgina
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR, psSeccion=>vsSeccion);
     END IF;

     htp.p('</table><br><br></body></html>');

  EXCEPTION
       WHEN OTHERS THEN
                HTP.P(SQLERRM);

  END PWRAIMR;
/


DROP PUBLIC SYNONYM PWRAIMR;

CREATE PUBLIC SYNONYM PWRAIMR FOR BANINST1.PWRAIMR;


GRANT EXECUTE ON BANINST1.PWRAIMR TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRAIMR TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRAIPG;

CREATE OR REPLACE PROCEDURE BANINST1.PWRAIPG(psReclDesc VARCHAR2) IS

/**************************************************************
           tarea:  procedimiento para el reporte de alumnos inscritos por programa
         mdulo:  seleccin de cursos
           autor:  horacio martnez ramrez - hmr
           fecha:  05/sep/2010
**************************************************************/

  vnRow      INTEGER                := 0;
  vnExists   INTEGER                := 0;
  vnColumnas INTEGER                := 14;
  tabColumna Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vsPerio    VARCHAR2(20)           := NULL;
  vsUniv     VARCHAR2(20)           := NULL;
  vsProgr    VARCHAR2(20)           := NULL;
  vsClase    VARCHAR2(20)           := NULL;
  vsTipo     VARCHAR2(20)           := NULL;
  vsSeccion  VARCHAR2(3)            := NULL;
  vsEdad     VARCHAR2(2)            := NULL;
  vsTipoE    VARCHAR2(5)            := NULL;
  vsSxo      VARCHAR2(5)            := NULL;
  vsMajr     VARCHAR2(30)           := NULL;
  vsTermCode VARCHAR2(10)           := NULL;
  vsCampCode VARCHAR2(10)           := NULL;
  vsRateCode VARCHAR2(10)           := NULL;
  vsEnca     VARCHAR2(1)            := NULL;
  vsSede     VARCHAR2(10)           := NULL;
  vsInicoPag VARCHAR2(10)           := NULL;
  vbEnca     BOOLEAN                := TRUE;

  CURSOR cuReporte(psUniv  VARCHAR2 DEFAULT NULL,
                            psPerio VARCHAR2 DEFAULT NULL,
                            psProgr VARCHAR2 DEFAULT NULL,
                            psTipo  VARCHAR2 DEFAULT NULL,
                            psTipoE VARCHAR2 DEFAULT NULL,
                            psMajr  VARCHAR2 DEFAULT NULL,
                            psSede  VARCHAR2 DEFAULT NULL   ) IS
                SELECT alumno.termCode                             AS TermCode,
                           Pk_Catalogo.PERIODO(alumno.termCode)        AS Descperiodo,
                           NVL(alumno.campCode,'S/Unive')              AS CampCode,
                           alumno.progCode                             AS CvePrograma,
                           Pk_Catalogo.PROGRAMA(alumno.progCode)       AS DescPrograma,
                           SPRIDEN_PIDM                                AS Pidm,
                           SPRIDEN_ID                                  AS Id,
                           SPBPERS_NAME_SUFFIX                   AS Rut,
                           REPLACE(REPLACE(
                           SPRIDEN_LAST_NAME||' '||
                           SPRIDEN_FIRST_NAME,'*',' '),'','&ntilde;') AS Nombre,
                           Pk_Catalogo.TipoAlumno(alumno.stypCode)     AS TipoEstudiante,
                           Pk_Catalogo.Admision(alumno.admtCode)       AS DescAdmision,
                           alumno.Clase                                AS CveClase,
                           alumno.Creditos                             AS Creditos,
                           alumno.BillHrs                              AS BillHrs,
                           alumno.rateCode                             AS rateCode
                   FROM SPRIDEN,
                            SPBPERS,
                        (SELECT SFRSTCR_TERM_CODE               AS termCode,
                                SGBSTDN_CAMP_CODE               AS campCode,
                                SGBSTDN_PROGRAM_1               AS progCode,
                                SGBSTDN_PIDM                    AS Pidm,
                                SGBSTDN_STYP_CODE               AS stypCode,
                                SGBSTDN_ADMT_CODE               AS admtCode,
                                SGBSTDN_MAJR_CODE_1             AS majrCode,
                                SGBSTDN_RATE_CODE               AS rateCode,
                                SGKCLAS.F_CLASS_CODE(
                                SGBSTDN_PIDM,SGBSTDN_LEVL_CODE,
                                NVL(psPerio,'999999'))          AS Clase,
                                SUM(SFRSTCR_CREDIT_HR)          AS Creditos,
                                SUM(SFRSTCR_BILL_HR)            AS BillHrs
                           FROM SGBSTDN A,
                                SFRSTCR
                          WHERE SFRSTCR_PIDM            = A.SGBSTDN_PIDM
                            AND A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                                             FROM SGBSTDN B
                                                            WHERE B.SGBSTDN_PIDM           = A.SGBSTDN_PIDM
                                                              AND B.SGBSTDN_TERM_CODE_EFF <= SFRSTCR_TERM_CODE
                                                          )
                            AND A.SGBSTDN_STST_CODE     = 'AS'
                            AND SFRSTCR_RSTS_CODE      IN ('RW','RE')
                          GROUP BY SFRSTCR_TERM_CODE,
                                   SGBSTDN_CAMP_CODE,
                                   SGBSTDN_PROGRAM_1,
                                   SGBSTDN_PIDM,
                                   SGBSTDN_LEVL_CODE,
                                   SGBSTDN_STYP_CODE,
                                   SGBSTDN_ADMT_CODE,
                                   SGBSTDN_MAJR_CODE_1,
                                   SGBSTDN_RATE_CODE
                        ) alumno
                  WHERE SPRIDEN_PIDM        = alumno.Pidm
                    AND SPRIDEN_PIDM          = SPBPERS_PIDM
                    AND SPRIDEN_CHANGE_IND IS NULL
                    AND (alumno.termCode = psPerio OR psPerio IS NULL)
                    AND (alumno.campCode = psUniv  OR psUniv  IS NULL)
                    AND (alumno.progCode = psProgr OR psProgr IS NULL)
                    AND (alumno.admtCode = psTipo  OR psTipo  IS NULL)
                    AND (alumno.stypCode = psTipoE OR psTipoE IS NULL)
                    AND (alumno.majrCode = psMajr  OR psMajr  IS NULL)
                    AND (alumno.rateCode = psSede  OR psSede  IS NULL)
                  ORDER BY TermCode DESC, rateCode, CvePrograma, NOMBRE;

  CURSOR cuSuda(psPidm NUMBER,
                         psTerm VARCHAR2) IS
         SELECT SGBUSER_SUDA_CODE SUDA
           FROM SGBUSER
          WHERE SGBUSER_TERM_CODE = psTerm
              AND SGBUSER_PIDM      = psPidm;

  function f_Detalle(psCamp varchar2,
                           psProg varchar2,
                           psTerm varchar2) return varchar2 is

  vnAlumnos INTEGER := 0;

  begin

      if psProg is not null then
         SELECT COUNT(DISTINCT alumno.Pidm)
           INTO vnAlumnos
           FROM (SELECT SFRSTCR_TERM_CODE  termCode,
                        SGBSTDN_CAMP_CODE  campCode,
                        SGBSTDN_PROGRAM_1  progCode,
                        SGBSTDN_PIDM       Pidm
                   FROM SGBSTDN A,
                        SFRSTCR
                  WHERE SFRSTCR_PIDM            = A.SGBSTDN_PIDM
                    AND A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                                     FROM SGBSTDN B
                                                    WHERE B.SGBSTDN_PIDM           = A.SGBSTDN_PIDM
                                                      AND B.SGBSTDN_TERM_CODE_EFF <= SFRSTCR_TERM_CODE
                                                  )
                    AND A.SGBSTDN_STST_CODE     = 'AS'
                    AND SFRSTCR_RSTS_CODE      IN ('RW','RE')
                ) alumno
          WHERE alumno.termCode = psTerm
            AND alumno.campCode = psCamp
            AND alumno.progCode = psProg;

         return '<tr><td valign="top" colspan="2" align="right">Total de inscritos al programa:'||
                  '</td><td colspan="'||(vnColumnas-2)||'">'||vnAlumnos||'</td></tr>';
       end if;

       return null;

  end f_Detalle;

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      -- son buscados los valores de las cookies para asignar los valores del filtro del query
      vsUniv    := pk_ObjHtml.getValueCookie('psUnive');
      vsPerio   := pk_ObjHtml.getValueCookie('psPerio');
      vsProgr   := pk_ObjHtml.getValueCookie('psProgr');
      vsClase   := pk_ObjHtml.getValueCookie('psClase');
      vsTipo    := pk_ObjHtml.getValueCookie('psTipoA');
      vsTipoE   := pk_ObjHtml.getValueCookie('psTyAl');
      vsEnca    := pk_ObjHtml.getValueCookie('psEnca');
      vsMajr    := pk_ObjHtml.getValueCookie('psMajrr');
      vsSeccion := pk_ObjHtml.getValueCookie('cookSeccion');
      vsSede    := pk_ObjHtml.getValueCookie('psRate');

      -- las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := 'Programa';
      tabColumna(2)  := 'Descripci&oacute;n';
      tabColumna(3)  := 'Id';
      tabColumna(4)  := 'Rut';
      tabColumna(5)  := 'Nombre';
      tabColumna(6)  := 'Sexo';
      tabColumna(7)  := 'Edad';
      tabColumna(8)  := 'Tipo de Estudiante';
      tabColumna(9)  := 'Periodos cursados';
      tabColumna(10) := 'Tipo de admisi&oacute;n';
      tabColumna(11) := 'Clase ';
      tabColumna(12) := 'Descripci&oacute;n';
      tabColumna(13) := 'Cr&eacute;ditos inscritos';
      tabColumna(14) := 'Bill Hrs';

      FOR regRep IN cuReporte(vsUniv, vsPerio, vsProgr, vsTipo, vsTipoE, vsMajr, vsSede) LOOP
          vsSxo       := NULL;

          IF regRep.CveClase = vsClase  OR vsClase IS NULL  THEN

             IF (vsTermCode IS NULL OR vsTermCode <> regRep.TermCode OR
                  vsCampCode IS NULL OR vsCampCode <> regRep.CampCode OR
                  vsRateCode IS NULL OR vsRateCode <> regRep.rateCode OR
                  vnRow = 28) AND vbEnca THEN

                  Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicoPag,'1',psSubtitulo=>'<br>Periodo '||regRep.TermCode,psUsuario=>pk_login.vgsUSR,psSeccion=>vsSeccion,psUniversidad=>regRep.CampCode, psDetalle=>f_Detalle(regRep.CampCode,vsProgr,regRep.TermCode) );

                  vsInicoPag := 'SALTO';
                  vnRow  := 0;

             END IF;

             IF vsEnca = 'N' THEN
                 vbEnca := FALSE;
             END IF;

             BEGIN
                 SELECT SPBPERS_SEX, FLOOR(MONTHS_BETWEEN(SYSDATE, SPBPERS_BIRTH_DATE)/12)
                   INTO vsSxo,vsEdad
                   FROM SPBPERS
                  WHERE SPBPERS_PIDM = regRep.Pidm;

             EXCEPTION
                 WHEN OTHERS THEN
                          NULL;
             END;

             htp.p('<tr>
             <td valign="top" align="left">'  ||regRep.CvePrograma   ||'</td>
             <td valign="top" align="left">'  ||regRep.DescPrograma  ||'</td>
             <td valign="top" align="left">'  ||regRep.Id            ||'</td>
             <td valign="top" align="left">'  ||regRep.Rut            ||'</td>
             <td valign="top" align="left">'  ||regRep.Nombre        ||'</td>
             <td valign="top" align="center">'||vsSxo                ||'</td>
             <td valign="top" align="center">'||vsEdad               ||'</td>
             <td valign="top" align="left">'  ||regRep.TipoEstudiante||'</td>
             <td valign="top" align="left">');

             FOR regSud IN cuSuda(regRep.Pidm, regRep.TermCode) LOOP
                   htp.p(regSud.SUDA||'</br>');
             END LOOP;

             htp.p('</td>
             <td valign="top" align="left">'  ||regRep.DescAdmision||'</td>
             <td valign="top" align="center">'||regRep.CveClase    ||'</td>
             <td valign="top" align="left">  </td>
             <td valign="top" align="right">' ||regRep.Creditos    ||'</td>
             <td valign="top" align="right">' ||regRep.BillHrs     ||'</td>
             </tr>');

             vnExists   := 1;
             vnRow      := vnRow + 1;
             vsTermCode := regRep.TermCode;
             vsCampCode := regRep.CampCode;
             vsRateCode := regRep.rateCode;
          END IF;
      END LOOP;

      IF vnExists = 0 THEN
          htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
          -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresin
          Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

          -- es omitido el encabezado del reporte pero se agrega el salto de pgina
          Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR, psSeccion=>vsSeccion);
      END IF;

      htp.p('</table><br><br></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
               HTP.P(SQLERRM);

  END PWRAIPG;
/


DROP PUBLIC SYNONYM PWRAIPG;

CREATE PUBLIC SYNONYM PWRAIPG FOR BANINST1.PWRAIPG;


GRANT EXECUTE ON BANINST1.PWRAIPG TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRAIPG TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRALBE;

CREATE OR REPLACE PROCEDURE BANINST1.PWRALBE(psReclDesc VARCHAR2) IS
/*
        NOMBRE: REPORTE DE BECAS SIN FORMATO
         TAREA: La base de este reporte se tomo de PK_REPORTEALUMBECADOS.P_ALUMCON
         FECHA: 15/02/2011
         AUTOR : MAC

*/

ckNombres    owa_cookie.vc_arr;
ckValores    owa_cookie.vc_arr;
ckCount      INTEGER;
vgsInicoPag  VARCHAR2(10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
vgsUSR       VARCHAR2(500);

  vnExists     INTEGER                        := 0;
  vnColumnas   INTEGER                        := 16;
  tabColumna   PK_sisRepImp.tipoTabla         := PK_sisRepImp.tipoTabla(1);
  vsPerio      VARCHAR2(50)                   := NULL;
  vsTermCode   VARCHAR2(6)                    := NULL;
  vsCodeBeca   VARCHAR2(8)                    := NULL;
  vsBeca       VARCHAR2(50)                   := NULL;
  vsNivel      VARCHAR2(50)                   := NULL;
  vsFacu       VARCHAR2(50)                   := NULL;
  vsMajrr      VARCHAR2(50)                   := NULL;
  vsTermAnt    VARCHAR2(6)                    := NULL;
  vsiD         VARCHAR2(10)                   := NULL;
  vsClase      VARCHAR2(15)                   := NULL;
  vsSeccion    VARCHAR2(3)                    := NULL;
  vsIdAnt      SPRIDEN.SPRIDEN_ID%TYPE        := NULL;
  vsCreditHR   SFRSTCR.SFRSTCR_CREDIT_HR%TYPE := NULL;
  vsBillHR     SFRSTCR.SFRSTCR_BILL_HR%TYPE   := NULL;
  vnPorcBeca   NUMBER                         := 0;
  vnTotalMonto NUMBER                         := 0;

  CURSOR cuReporte(psPerio VARCHAR2 DEFAULT NULL,
                   psBeca  VARCHAR2 DEFAULT NULL,
                   psNivel VARCHAR2 DEFAULT NULL,
                   psFacu  VARCHAR2 DEFAULT NULL,
                   psMajrr VARCHAR2 DEFAULT NULL,
                   psID    VARCHAR2 DEFAULT NULL) IS
         SELECT TBBESTU_EXEMPTION_CODE                                     Beca,
                (SELECT TBBEXPT_DESC
                   FROM TBBEXPT
                  WHERE A.TBBESTU_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                    AND A.TBBESTU_TERM_CODE      = TBBEXPT_TERM_CODE
                 )                                                         DescBeca,
                 TBBESTU_EXEMPTION_CODE||' '||
                 (SELECT TBBEXPT_DESC
                    FROM TBBEXPT
                    WHERE A.TBBESTU_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                    AND A.TBBESTU_TERM_CODE        = TBBEXPT_TERM_CODE
                 )                                                         Tipo,
                 D.SPRIDEN_PIDM                                            Pidm,
                 D.SPRIDEN_ID                                              Id,
                 F_GET_RUT(D.SPRIDEN_PIDM)                                   RUT,
                 D.SPRIDEN_LAST_NAME||' '||
                 D.SPRIDEN_FIRST_NAME                                      Nombre,
                 GASTON.NIVEL                                              Nivel,
                 (SELECT STVLEVL_DESC
                    FROM STVLEVL
                   WHERE STVLEVL_CODE = GASTON.NIVEL
                 )                                                        DescNivel,
                 GASTON.CARRERA                                           Carrera,
                 (SELECT STVMAJR_DESC
                    FROM STVMAJR
                   WHERE STVMAJR_CODE = GASTON.CARRERA
                 )                                                        DescCarrera,
                 A.TBBESTU_ACTIVITY_DATE                                  FecRegistro,
                 A.TBBESTU_DEL_IND                                        Status,
                 A.TBBESTU_TERM_CODE                                      TermCode,
                 PK_CATALOGO.COLEGIO(GASTON.ESCUELA)                      Escuela,
                 TBBESTU_USER_ID                                          Usuario,
                 Gaston.StatusSTST                                        StatusSTST,
                 F_GET_TOT_BEC(A.TBBESTU_TERM_CODE,A.TBBESTU_PIDM,
                               A.TBBESTU_EXEMPTION_CODE
                              )                                           Importe
            FROM SPRIDEN D,
                 (SELECT a.SGBSTDN_PROGRAM_1    Programa,
                         a.SGBSTDN_PIDM         Pidm,
                         a.SGBSTDN_CAMP_CODE    Camp,
                         a.SGBSTDN_DEGC_CODE_1  Degree,
                         a.SGBSTDN_LEVL_CODE    Nivel,
                         a.SGBSTDN_MAJR_CODE_1  Carrera,
                         a.SGBSTDN_COLL_CODE_1  Escuela,
                 (SELECT STVSTST_DESC
                    FROM STVSTST
                   WHERE STVSTST_CODE = a.SGBSTDN_STST_CODE) StatusSTST
                    FROM SGBSTDN a
                   WHERE a.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                                      FROM SGBSTDN B
                                                     WHERE B.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                       AND SGBSTDN_TERM_CODE_EFF <= psPerio
                                                   )
                  AND a.SGBSTDN_STST_CODE = 'AS'
                 ) Gaston,
                 TBBESTU A
           WHERE gaston.PIDM            = D.SPRIDEN_PIDM
             AND D.SPRIDEN_PIDM            = A.TBBESTU_PIDM
             AND D.SPRIDEN_CHANGE_IND     IS NULL
             AND NVL(A.TBBESTU_DEL_IND,'A') <> 'D' -- NO MOSTRAR BECAS ELIMINADAS
             AND (A.TBBESTU_EXEMPTION_CODE = psBeca  OR psBeca  IS NULL)
             AND (A.TBBESTU_TERM_CODE      = psPerio OR psPerio IS NULL)
             AND (GASTON.NIVEL             = psNivel OR psNivel IS NULL)
             AND (GASTON.CARRERA           = psMajrr OR psMajrr IS NULL)
             AND (D.SPRIDEN_ID             = psID    OR psID    IS NULL)
             AND (GASTON.ESCUELA           = psFacu  OR psFacu  IS NULL)
           ORDER BY TBBESTU_TERM_CODE, TBBESTU_EXEMPTION_CODE;

  BEGIN
      IF PK_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
         FOR vnCOKIES IN 1..ckCount LOOP
             IF    ckNOMBRES(vnCOKIES) = 'psBeca' THEN
                   vsBeca := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psPerio' THEN
                   vsPerio  := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psNivel' THEN
                   vsNivel := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                   vsFacu  := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psMajrr' THEN
                   vsMajrr := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                   vsSeccion := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psId' THEN
                   vsId := ckValores(vnCOKIES);

             END IF;
         END LOOP;
      END IF;

      -- las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := 'Periodo';
      tabColumna(2)  := 'ID';
      tabColumna(3)  := 'RUT';
      tabColumna(4)  := 'Nombre';
      tabColumna(5)  := 'Descripci&oacute;n del Programa';
      tabColumna(6)  := 'Status alumno';
      tabColumna(7)  := 'Promedio del semestre anterior';
      tabColumna(8)  := 'Materias reprobadas';
      tabColumna(9) := 'Fecha Beca';
      tabColumna(10) := 'Usuario Registrado';
      tabColumna(11) := 'Status de la beca';
      tabColumna(12) := 'Cr&eacute;ditos inscritos (del periodo)';
      tabColumna(13) := 'Total de Cr&eacute;ditos  ganados';
      tabColumna(14) := 'C&oacute;digo de la beca';
      tabColumna(15) := 'Porcentaje';
      tabColumna(16) := 'Tipo de beca';

      vsIdAnt:= '0';

      FOR regRep IN cuReporte(vsPerio,vsBeca,vsNivel,vsFacu,vsMajrr, vsId) LOOP
          IF vnExists = 0 THEN
             PK_sisRepImp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vgsInicoPag,'1',psSubtitulo=>' ',psUsuario=>vgsUSR,psSeccion=>vsSeccion);--, psUniversidad=>'UAS');
             vgsInicoPag := 'SALTO';
          END IF;


          IF (vsIdAnt = regRep.Id and vsTermcode = regRep.TermCode and vsCodeBeca = regRep.Beca) THEN
              -- Mismo expediente
              htp.p('<tr><td></td><td></td><td></td><td></td>');
          ELSE
             SELECT DECODE(SUBSTR(regRep.TermCode,5),'75',SUBSTR(regRep.TermCode,1,4)  ||'25',
                           '25',SUBSTR(regRep.TermCode,1,4)-1||'75',
                           regRep.TermCode)
               INTO vsTermAnt
               FROM DUAL;

             SELECT DECODE(SGKCLAS.F_CLASS_CODE(regRep.Pidm,regRep.Nivel,'999999'),'00','Nuevo ingreso','Reingreso')
               INTO vsClase
               FROM DUAL;

             htp.p('<tr>
             <td valign="top">'||regRep.TermCode   ||'</td>
             <td valign="top">'||regRep.Id         ||'</td>
             <td valign="top">'||regRep.RUT        ||'</td>
             <td valign="top">'||regRep.Nombre     ||'</td>
             <td valign="top">'||regRep.DescCarrera||'</td>
             <td valign="top">'||regRep.StatusSTST ||'</td>
             <td valign="top">'||FWAPRTG(regRep.Pidm, vsTermAnt,'G', regRep.Nivel)||'</td>
             <td valign="top">'||FWRMTRP(regRep.TermCode, regRep.Pidm, regRep.Nivel)                      ||'</td>
             ');
          END IF;

          -- Query obtenido de reporte en pro*c creado por AMP    (tsralbe.pc)
          BEGIN
              SELECT NVL(SUM(SFRSTCR_CREDIT_HR),0),
                     NVL(SUM(SFRSTCR_BILL_HR)  ,0)
                INTO vsCreditHR,
                     vsBillHR
                FROM SFRSTCR
               WHERE SFRSTCR_PIDM      = regRep.Pidm
                 AND SFRSTCR_TERM_CODE = regRep.TermCode
                 AND SFRSTCR_RSTS_CODE IN ('RE','RW');
          EXCEPTION
              WHEN NO_DATA_FOUND THEN
                   vsCreditHR := NULL;
                   vsBillHR   := NULL;
          END;

          --MCC 07/09/2006 Cambio para integrar el % de beca definido por AMP
          BEGIN
              SELECT MAX(TBREDET_PERCENT)
                INTO vnPorcBeca
                FROM TBREDET
               WHERE TBREDET_EXEMPTION_CODE = regRep.beca
                 AND TBREDET_TERM_CODE      = regRep.TermCode;
          EXCEPTION
              WHEN OTHERS THEN
                   vnPorcBeca := 0;
          END;

          htp.p('
          <td valign="top">'||regRep.FecRegistro||'</td>
          <td valign="top">'||regRep.Usuario    ||'</td>
          <td valign="top">'||regRep.Status     ||'</td>
          <td valign="top">'||vsCreditHR        ||'</td>
          <td valign="top">'||FWRCRED(regRep.Pidm, regRep.Nivel, regRep.TermCode)||'</td>
          <td valign="top">'||regRep.Beca       ||'</td>
          <td valign="top">'||vnPorcBeca        ||'</td>
          <td valign="top">'||regRep.Tipo       ||'</td>
          ');

          vnExists := 1;
          vsIdAnt      := regRep.Id;
          vsTermCode   := regRep.TermCode;
          vsCodeBeca   := regRep.Beca;
          vnTotalMonto := NULL;
      END LOOP;

      -- La variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
      PK_sisRepImp.vgsSaltoImp := 'Imprime';

      vgsInicoPag:= 'PIE';
      -- Es omitido el encabezado del reporte pero se agrega el salto de pagina
      PK_sisRepImp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vgsInicoPag,'0', psUsuario=>vgsUSR, psSeccion=>vsSeccion);

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||PK_sisRepImp.vgsResultado||'</font></th></tr>');
      END IF;

      htp.p('</table></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           HTP.P(SQLERRM);
  END PWRALBE;
/


DROP PUBLIC SYNONYM PWRALBE;

CREATE PUBLIC SYNONYM PWRALBE FOR BANINST1.PWRALBE;


GRANT EXECUTE ON BANINST1.PWRALBE TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRALBE TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRAPIN;

CREATE OR REPLACE PROCEDURE BANINST1.PWRAPIN(psReclDesc VARCHAR2) IS
/*
          TAREA: Reporte de alumnos que han pagado inscripci?n
         MODULO: Registro Estudiantil
          AUTOR: GEPC
          FECHA: 03/08/2007

   MODIFICACION: 20/02/2008
                 MCC
                 * Se incluye la columna de majr en el reporte, adem?s
                   de excluir todos los alumnos que tengan nivel PL

                 * Se tiene que considerar que este reporte se toma como base comparativa
                   entre cifras con el reporte de avance de matricula del modulo de admisiones.

   MODIFICACION: 15/09/2009
                 CCR
                 * Se cambio el paquete pk_EstudiantePagoInscripcion y se
                   Creo el proceso PWRAPIN con la misma estructura.
                 * Se agrega el campo "Tipo de Alumno".

   MODIFICACION: 29/01/2010
                 GEPC
                 * Fue agregado el parametro SITE

   MODIFICACION: 10/06/2010
                 CCR
                 * Se le agrega un ' al id en el curso en caso de que el reporte
                   sea ejecutado por el parametro excel para evitar que quite los
                   ceros a la izquierda

*/


  vsInicoPag    VARCHAR2(10)           := NULL;
--  vsInicoPag    VARCHAR2(10)           := NULL;

  vnRow         INTEGER                            := 0;
  vnExists      INTEGER                            := 0;
  vnColumnas    INTEGER                            := 13;
  tabColumna    Pk_Sisrepimp.tipoTabla             := Pk_Sisrepimp.tipoTabla(1);
  vsPerio       SIBINST.SIBINST_TERM_CODE_EFF%TYPE := NULL;
  vsUniv        VARCHAR2(20)                       := NULL;
  vsSstst       STVSTST.STVSTST_CODE%TYPE          := NULL;
  vsProgr       SMRPRLE.SMRPRLE_PROGRAM_DESC%TYPE  := NULL;
  vsPrepa       STVSBGI.STVSBGI_DESC%TYPE          := NULL;
  vsSeccion     VARCHAR2(3)                        := NULL;
  vsPeriodo     VARCHAR2(20)                       := NULL;
  vsUnivers     VARCHAR2(20)                       := NULL;
  vsNivel       VARCHAR2(20)                       := NULL;
  vsRate        VARCHAR2(8)                        := NULL;
  vsEscu        VARCHAR2(20)                       := NULL;
  vsEnca        VARCHAR2(5)                        := NULL;
  vbEnca        BOOLEAN                            := TRUE;
  vsExcel       VARCHAR2(20)                       := NULL;
  --vsId          SPRIDEN.SPRIDEN_ID%TYPE            := NULL;


  CURSOR cuBecas (pnPidm NUMERIC,
                  psTerm VARCHAR2) IS
         SELECT TBBEXPT_DESC BecaDesc
           FROM TBBESTU,
                TBBEXPT
          WHERE TBBESTU_PIDM           = pnPidm
            AND TBBESTU_TERM_CODE      = psTerm
            AND TBBEXPT_EXEMPTION_CODE = TBBESTU_EXEMPTION_CODE
            AND TBBEXPT_TERM_CODE      = TBBESTU_TERM_CODE
            AND TBBESTU_DEL_IND IS NULL;

  CURSOR cuReporte(psUniv  VARCHAR2 DEFAULT NULL,
                   psPerio VARCHAR2 DEFAULT NULL,
                   psProgr VARCHAR2 DEFAULT NULL,
                   psNivel VARCHAR2 DEFAULT NULL,
                   psEscu  VARCHAR2 DEFAULT NULL,
                   psRate  VARCHAR2 DEFAULT NULL
                  ) IS
         SELECT sgbstdn_camp_code                                                            cveuniversidad,
                psperio                                                                      periodo,
                sgbstdn_coll_code_1                                                          escuela,
                sgbstdn_majr_code_1                                                          cvemajr,
                pk_catalogo.carrera(sgbstdn_majr_code_1)                                     majr,
                sgbstdn_program_1                                                            cveprograma,
                pk_catalogo.programa(sg.sgbstdn_program_1)                                   descprograma,
                sg.sgbstdn_levl_code                                                         cvenivel,
                sgbstdn_pidm                                                                 pidm,
                decode(vsExcel,'EXCELL',''''||spriden_id,spriden_id)                         id,
                REPLACE(spriden_last_name||' '||spriden_first_name,'*',' ')                  alumno,
                pk_catalogo.stastst(sgbstdn_stst_code)                                       status,
               -- f_esinscrito(sgbstdn_pidm,psperio,sg.sgbstdn_levl_code,sgbstdn_camp_code)     inscrito,
                --f_esreinscrito(sgbstdn_pidm,psperio,sg.sgbstdn_levl_code,sgbstdn_camp_code)   reinscrito,
                (SELECT 'X'
                   FROM sfbetrm
                  WHERE sfbetrm_pidm      = sgbstdn_pidm
                    AND sfbetrm_term_code = psperio
                    AND sfbetrm_ests_code = 'EL'
                    AND EXISTS (SELECT NULL
                                  FROM sfrstcr
                                 WHERE sfrstcr_term_code  = psperio
                                   AND sfrstcr_pidm       = sfbetrm_pidm
                                   AND sfrstcr_rsts_code IN ('RE','RW')
                               )
                )                                                                            seleccion,
                (SELECT tbbcont_desc
                   FROM tbbcont
                  WHERE (tbbcont_contract_number,
                         tbbcont_term_code,
                         tbbcont_pidm) = (SELECT tbbcstu_contract_number,tbbcstu_term_code,tbbcstu_contract_pidm
                                            FROM tbbcstu a
                                           WHERE a.tbbcstu_stu_pidm          = sgbstdn_pidm
                                             AND a.tbbcstu_term_code         = psperio
                                             AND a.tbbcstu_contract_priority = (SELECT MAX (tbbcstu_contract_priority)
                                                                                  FROM tbbcstu b
                                                                                 WHERE b.tbbcstu_stu_pidm  = sgbstdn_pidm
                                                                                   AND b.tbbcstu_term_code = psperio
                                                                                )
                                         )
                )                                                                            CreditoAcademico,
                (SELECT DECODE(COUNT(1),0,NULL,'CA')
                   FROM sfrstcr
                  WHERE sfrstcr_term_code = psPerio
                    AND sfrstcr_ptrm_code = 'CA'
                    AND sfrstcr_pidm      = sgbstdn_pidm
                )                                                                            Observacion1,
                (SELECT DECODE(COUNT(1),0,NULL,'Ingls')
                   FROM sfrstcr,ssbsect
                  WHERE ssbsect_subj_code in ('ENG','INMA','CLIN')
                    AND sfrstcr_credit_hr  = 0
                    AND sfrstcr_term_code  = ssbsect_term_code
                    AND sfrstcr_crn        = ssbsect_crn
                    AND sfrstcr_term_code  = psperio
                    AND sfrstcr_pidm       = sgbstdn_pidm
                )                                                                            Observacion2,
                (SELECT stvstyp_desc
                   FROM stvstyp
                  WHERE stvstyp_code  = sg.sgbstdn_styp_code
                )                                                                            Tipo_alumno,
                SGBSTDN_RATE_code                                                            Site
           FROM sgbstdn sg,
                spriden
          WHERE sgbstdn_term_code_eff     = (SELECT MAX(sg2.sgbstdn_term_code_eff)
                                               FROM sgbstdn sg2
                                              WHERE sg2.sgbstdn_pidm           = sg.sgbstdn_pidm
                                                AND sg2.sgbstdn_term_code_eff <= psperio
                                            )
            AND sg.sgbstdn_stst_code    = 'AS'
            AND sg.sgbstdn_levl_code    NOT IN 'PL'
            AND sg.sgbstdn_pidm         = spriden_pidm
            AND spriden_change_ind      IS NULL
            AND (sg.sgbstdn_camp_code   = psuniv  OR psuniv   IS NULL)
            AND (sg.sgbstdn_program_1   = psprogr OR psprogr  IS NULL)
            AND (sg.sgbstdn_levl_code   = psnivel OR psnivel IS NULL)
            AND (sg.sgbstdn_coll_code_1 = psescu  OR psescu  IS NULL)
            AND (sg.SGBSTDN_RATE_code   = psRate  OR psRate  IS NULL)
          ORDER BY periodo DESC, cveuniversidad, cveprograma, majr,alumno;

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      vsUniv    := pk_objHTML.getValueCookie('psUnive');
      vsPerio   := pk_objHTML.getValueCookie('psPerio');
      vsProgr   := pk_objHTML.getValueCookie('psProgr');
      vsNivel   := pk_objHTML.getValueCookie('psNivel');
      vsEscu    := pk_objHTML.getValueCookie('psEscu');
      vsEnca    := pk_objHTML.getValueCookie('psEnca');
      vsRate    := pk_objHTML.getValueCookie('psRate');
      vsSeccion := pk_objHTML.getValueCookie('cookSeccion');
      vsExcel   := pk_objHTML.getValueCookie('reporteEnExcel');--=EXCELL

      -- las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := 'Escuela';
      tabColumna(2)  := 'Carrera';
      tabColumna(3)  := 'Programa';
      tabColumna(4)  := 'Descripci&oacute;n';
      tabColumna(5)  := 'ID';
      tabColumna(6)  := 'Nombre';
      tabColumna(7)  := 'Pago inscripci&oacute;n';
      tabColumna(8)  := 'Pago reinscripci&oacute;n';
      tabColumna(9)  := 'Selecci&oacute;n de cursos';
      tabColumna(10) := 'Beca asignada';
      tabColumna(11) := 'Cr&eacute;dito educativo';
      tabColumna(12) := 'Observaciones';
      tabColumna(13) := 'Tipo de Alumno';


      FOR regRep IN cuReporte(vsUniv, vsPerio, vsProgr, vsNivel, vsEscu, vsRate) LOOP
          IF (vsPeriodo IS NULL OR vsPeriodo <> regRep.Periodo OR
              vsUnivers IS NULL OR vsUnivers <> regRep.CveUniversidad OR
              vnRow = 30) AND vbEnca THEN

              Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicoPag,'1',psSubtitulo=>'Periodo '||regRep.Periodo||'<br/>'||pk_Catalogo.fStvSite(regRep.SITE),psUsuario=>pk_login.vgsUSR,psSeccion=>vsSeccion,psUniversidad=>regRep.CveUniversidad);
                            vsInicoPag := 'SALTO';

              vnRow  := 0;
          END IF;

          IF vsEnca = 'N' THEN
             vbEnca := FALSE;
          END IF;

          vsUnivers := regRep.CveUniversidad;
          vsPeriodo := regRep.Periodo;




          --IF regRep.Inscrito   IS NULL AND
            -- regRep.ReInscrito IS NULL AND
             --regRep.Seleccion  IS NULL THEN
             --NULL;
          --ELSE
             --htp.p('<tr>--
             --<td valign="top" align="left">'  ||regRep.Escuela     ||'</td>
             --<td valign="top" align="left">'  ||regRep.CveMajr||'-'||regRep.Majr ||'</td>
             --<td valign="top" align="center">'||regRep.CvePrograma ||'</td>
             --<td valign="top" align="left">'  ||regRep.DescPrograma||'</td>
             --<td valign="top" align="left">'  ||regRep.ID          ||'</td>
             --<td valign="top" align="left">'  ||regRep.Alumno      ||'</td>
             --<td valign="top" align="center">'||regRep.Inscrito    ||'</td>
             --<td valign="top" align="center">'||regRep.ReInscrito  ||'</td>
             --<td valign="top" align="center">'||regRep.Seleccion   ||'</td>
             --<td valign="top">');

             FOR regBeca IN cuBecas(regRep.PIDM,regRep.PERIODO) LOOP
                 htp.p(regBeca.BecaDesc||'<br>');
             END LOOP;

             IF    regRep.Observacion1 IS NOT NULL AND regRep.Observacion2 IS NOT NULL THEN
                   regRep.Observacion1 := regRep.Observacion1||'/'||regRep.Observacion2;
             ELSIF regRep.Observacion1 IS NULL AND regRep.Observacion2 IS NOT NULL THEN
                   regRep.Observacion1 := regRep.Observacion2;
             END IF;

              htp.p('</td>
                     <td valign="top">'||regRep.CreditoAcademico||'</td>
                     <td valign="top">'||regRep.Observacion1    ||'</td>
                     <td valign="top">'||regRep.Tipo_alumno     ||'</td>
                     </tr>');

             vnExists := 1;
             vnRow    := vnRow + 1;
          --END IF;
      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pagina para impresion
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR, psSeccion=>vsSeccion);
      END IF;

      htp.p('</table></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           HTP.P(SQLERRM);


  END PWRAPIN;
/
DROP PROCEDURE BANINST1.PWRARCH;

CREATE OR REPLACE PROCEDURE BANINST1.PWRARCH(psReclDesc VARCHAR2) IS

/**************************************************************
           tarea:  obtiene las evaluaciones realizadas por el alumno (evaluacin sin promediar)
          mdulo:  resultados del sistema de evaluacin de la prctica docente (seprad)
           autor:  horacio martnez ramrez - hmr
           fecha:  01/nov/2010

          21  ENE 2011
          JCCR
          *  Se le agrega lo delk parametro de excell
                IF vsExcel = 'EXCEL' THEN
                 owa_util.mime_header('application/ms-excel',true);
                 owa_util.http_header_close;
              END IF;
**************************************************************/

  TYPE reg_Reac IS RECORD (qcodCode VARCHAR2(30),
                           teqaCode VARCHAR2(30),
                           qcodDesc VARCHAR2(500)
                          );

  TYPE tableReac IS TABLE OF reg_Reac INDEX BY BINARY_INTEGER;

  tabReac  tableReac;

  tabColumna        Pk_Sisrepimp.tipoTabla           := Pk_Sisrepimp.tipoTabla(1);
  vnRow             INTEGER                          := 0;
  vnReac            INTEGER                          := 0;
  vnNoAplTot        INTEGER                          := 0;
  vnNoAplica        INTEGER                          := 0;
  vnColumnas        INTEGER                          := 25;
  vnI               NUMBER(1)                        := 0;
  cn1               NUMBER(1)                        := 1;
  cn2               NUMBER(1)                        := 2;
  cn3               NUMBER(1)                        := 3;
  cn4               NUMBER(1)                        := 4;
  cn5               NUMBER(1)                        := 5;
  cn6               NUMBER(1)                        := 6;
  cn7               NUMBER(1)                        := 7;
  cn8               NUMBER(1)                        := 8;
  cn9               NUMBER(1)                        := 9;
  cnM1              NUMBER(1)                        := -1;
  vsInicoPag        VARCHAR2(10)                     := NULL;
  vnPidmA           NUMBER                           := NULL;
  vnPidmFclt        NUMBER                           := NULL;
  vsCamp            VARCHAR2(6)                      := NULL;
  vsTerm            VARCHAR2(6)                      := NULL;
  vsEncu            VARCHAR2(30)                     := NULL;
  vsRate            VARCHAR2(6)                      := NULL;
  vsColl            VARCHAR2(6)                      := NULL;
  vsSedeCode        VARCHAR2(6)                      := NULL;
  vsProgCode        VARCHAR2(300)                    := NULL;
  vsProgDesc        VARCHAR2(300)                    := NULL;
  vsProgVpdi        VARCHAR2(300)                    := NULL;
  vsProg            VARCHAR2(300)                    := NULL;
  vsPro2            VARCHAR2(300)                    := NULL;
  vsPtrm            VARCHAR2(1000)                   := NULL;
  vsFaculty         VARCHAR2(1000)                   := NULL;
  vsTipoContrato    VARCHAR2(1000)                   := NULL;
  vsGradoAcademico  VARCHAR2(1000)                   := NULL;
  vsSubjCode        VARCHAR2(5)                      := NULL;
  vsSstsCode        VARCHAR2(10)                     := NULL;
  vsNoAplica        SVBTESD.SVBTESD_OPEN_ANSWER%TYPE := NULL;
  vsTipoDesc        STVSCHD.STVSCHD_DESC%TYPE        := NULL;
  vsTipoCode        STVSCHD.STVSCHD_CODE%TYPE        := NULL;
  vsCampCode        STVCAMP.STVCAMP_CODE%TYPE        := NULL;
  vsCampDesc        STVCAMP.STVCAMP_DESC%TYPE        := NULL;
  vsCollCode        STVCOLL.STVCOLL_CODE%TYPE        := NULL;
  vsCollDesc        STVCOLL.STVCOLL_DESC%TYPE        := NULL;

  vsExcel           VARCHAR2(20)                     := NULL;

  vsPaav            SWMSPBR.SWMSPBR_PAAV_ALUMNO%TYPE := NULL;
  vsPaan            SWMSPBR.SWMSPBR_PAAN_ALUMNO%TYPE := NULL;
  vsSexo            VARCHAR2(30)                     := NULL;

  csSIN             CONSTANT VARCHAR2(3)             := 'SIN';
  csAutoEval        CONSTANT VARCHAR2(8)             := 'AUTOEVAL';
  csComment         CONSTANT VARCHAR2(6)             := 'COMENT';
  csPlanea          CONSTANT VARCHAR2(10)            := 'PLANEACION';
  csHabil           CONSTANT VARCHAR2(10)            := 'HABILIDADE';
  csEvalua          CONSTANT VARCHAR2(10)            := 'EVALUACIN';
  csRasgos          CONSTANT VARCHAR2(6)             := 'RASGOS';
  csIdentif         CONSTANT VARCHAR2(10)            := 'IDENTIFICA';
  csVgp             CONSTANT VARCHAR2(8)             := 'VALGPROF';
  csVgc             CONSTANT VARCHAR2(9)             := 'VALGCURSO';
  csMayorQ          CONSTANT VARCHAR2(1)             := '>';
  csArrB            CONSTANT VARCHAR2(1)             := '@';
  csAsterQ          CONSTANT VARCHAR2(1)             := '*';
  csEspace          CONSTANT VARCHAR2(1)             := ' ';
  csSlash           CONSTANT VARCHAR2(1)             := '/';
  cnCero            CONSTANT NUMBER(1)               := 0;

  -- cubruto
  CURSOR cuBruto IS
         SELECT SWRPGAC_TERM_CODE    AS Term,
                SWRPGAC_CRN          AS Crn,
                SWRPGAC_CAMP_CODE    AS Camp,
                SWRPGAC_PTRM_CODE    AS Ptrm,
                SWRPGAC_COLL_CODE    AS Coll,
                SWRPGAC_SUBJ_CODE    AS Subj,
                SWRPGAC_CRSE_NUMB    AS Crse,
                SWRPGAC_TITLE        AS Titulo,
                SWRPGAC_SCHD_CODE    AS Tipo,
                SWRPSPD_FACULTY_PIDM AS Faculty,
                SWRPSPD_PIDM         AS PidA,
                SWRPSPD_TEMP_PIDM    AS PidB
           FROM SWRPGAC, SWRPSPD
          WHERE SWRPGAC_TERM_CODE = SWRPSPD_TERM_CODE
            AND SWRPGAC_CRN       = SWRPSPD_CRN
          ORDER BY SWRPSPD_FACULTY_PIDM,SWRPGAC_CRN,SWRPSPD_PIDM, SWRPGAC_COLL_CODE,
                   SWRPGAC_SUBJ_CODE,   SWRPGAC_CRSE_NUMB;

  -- cureactivos
  CURSOR cuReactivos(psEncu VARCHAR2) IS
         SELECT (SELECT SVBQCOD_DESC
                   FROM SVBQCOD
                  WHERE SVBQCOD_CODE = SVRSDEF_QCOD_CODE
                )                 qcodDesc,
                SVRSDEF_QCOD_CODE qcodCode,
                SVRSDEF_TEQA_CODE teqaCode,
                DECODE(SVRSDEF_TEQA_CODE,csAutoEval,cn1,csPlanea,cn2,csHabil,cn3,csEvalua,cn4,csRasgos,cn5,csIdentif,cn6,csVgp,cn7,csVgc,cn8,csComment,cn9) Orden1,
                SUBSTR(SVRSDEF_QCOD_CODE,LENGTH(SVRSDEF_QCOD_CODE)- cn1,cn2) Orden2
           FROM SVRSDEF
          WHERE SVRSDEF_TSSC_CODE = psEncu
          ORDER BY Orden1,Orden2;

  -- retorna los comentarios
  function f_qpoints(psTerm varchar2,
                     pnCrn  number,
                     pnTemp number,
                     pnFacu number,
                     psQcod varchar2,
                     psEncu varchar2) return varchar2 is

  vsComentarios svbtesd.svbtesd_open_answer%type := null;

  begin
      select DECODE(svbtesd_pvac_qpoints,NULL,svbtesd_open_answer,svbtesd_pvac_qpoints)
        into vsComentarios
        from svbtesd
       where svbtesd_esas_temp_pidm = pnTemp
         and svbtesd_term_code      = psTerm
         and svbtesd_crn            = pnCrn
         and svbtesd_faculty_pidm   = pnFacu
         and svbtesd_tssc_code      = psEncu
         and svbtesd_qcod_code      = psQcod;

      return vsComentarios;

  exception
      when others then
           return null;
  end f_qpoints;

  -- retorna la descripcin del tipo de materia
  function F_TipoMateria(psTipo varchar2) return varchar2 is

  Begin
      if vsTipoCode is null or vsTipoCode <> psTipo then
         select stvschd_desc
           into vsTipoDesc
           from stvschd
          where stvschd_code = psTipo;
      end if;

      return vsTipoDesc;

  exception
      when others then
           return null;
  end F_TipoMateria;

  -- retorna el grado acadmico
  function F_GradoAcademico(pnFaculty number) return varchar2 is

  begin
      if vnPidmFclt is null or vnPidmFclt <> pnFaculty then
         begin
             select '<td valign="top" '||PK_ObjHTML.vgsBorderDDDDDD||csMayorQ||A.STVDEGC_CODE||'</td>'||
                    '<td valign="top" '||PK_ObjHTML.vgsBorderDDDDDD||csMayorQ||A.STVDEGC_DESC||'</td>'
               into vsGradoAcademico
               from sordegr, stvdegc a
              where sordegr_pidm         = pnFaculty
                and sordegr_degc_code   = a.stvdegc_code
                and a.stvdegc_acat_code = (select max(b.stvdegc_acat_code)
                                             from stvdegc b
                                            where b.stvdegc_code = a.stvdegc_code
                                          );
         exception
             when others then
                  vsGradoAcademico := '<td '||PK_ObjHTML.vgsBorderDDDDDD||'></td><td '||PK_ObjHTML.vgsBorderDDDDDD||'></td>';
         end;
      end if;

      return vsGradoAcademico;


  end F_GradoAcademico;

  -- la funcin retorna el tipo de contrato del alumno
  function F_TipoContrato(pnFaculty number) return varchar2 is

  begin
      if vnPidmFclt is null or vnPidmFclt <> pnFaculty then
         begin
             select '<td valign="top" '||PK_ObjHTML.vgsBorderDDDDDD||csMayorQ||a.sibinst_fstp_code||'</td>'||
                    '<td valign="top" '||PK_ObjHTML.vgsBorderDDDDDD||csMayorQ||
                    (select stvfstp_desc
                       from stvfstp
                      where stvfstp_code = a.sibinst_fstp_code)||'</td>'
               into vsTipoContrato
               from sibinst a
              where a.sibinst_pidm          = pnFaculty
                and a.sibinst_term_code_eff = (select max(b.sibinst_term_code_eff)
                                                 from sibinst b
                                                where b.sibinst_pidm = a.sibinst_pidm
                                               );
         exception
             when others then
                  vsTipoContrato := '<td '||PK_ObjHTML.vgsBorderDDDDDD||'></td><td '||PK_ObjHTML.vgsBorderDDDDDD||'></td>';
         end;
      end if;

      return vsTipoContrato;


  end F_TipoContrato;

  -- la funcin retorna el tipo de contrato del alumno
  function F_Contrato(pnFaculty number) return varchar2 is

  vsContrato varchar2(50) := null;

  begin
      select a.sibinst_fstp_code||csArrB||
             (select stvfstp_desc
                from stvfstp
               where stvfstp_code = a.sibinst_fstp_code)
        into vsContrato
        from sibinst a
       where a.sibinst_pidm          = pnFaculty
         and a.sibinst_term_code_eff = (select max(b.sibinst_term_code_eff)
                                          from sibinst b
                                         where b.sibinst_pidm = pnFaculty
                                       );

      return vsContrato;

  exception
      when others then
           return null;
  end F_Contrato;

  -- la funcin retorna el id y nombre del profesor
  function F_IdNameFaculty(pnPidm number) return varchar2 is

  begin
      if vnPidmFclt is null or vnPidmFclt <> pnPidm then
         begin
             select '<td valign="top" '||PK_ObjHTML.vgsBorderDDDDDD||csMayorQ||spriden_id||
                    '</td>'||
                    '<td valign="top" '||PK_ObjHTML.vgsBorderDDDDDD||csMayorQ||f_get_rut(pnPidm)||
                    '</td>'||
                    '<td valign="top" '||PK_ObjHTML.vgsBorderDDDDDD||csMayorQ||
                    replace(spriden_last_name||spriden_first_name,csAsterQ,csEspace)||'</td>'
               into vsFaculty
               from spriden
              where spriden_pidm = pnPidm
                and spriden_change_ind is null;

         exception
             when others then
                  vsFaculty :=  '<td '||PK_ObjHTML.vgsBorderDDDDDD||'></td><td '||PK_ObjHTML.vgsBorderDDDDDD||'></td>';
         end;
      end if;

      return vsFaculty;


  end F_IdNameFaculty;

  function f_CampDesc(psCamp varchar2) return varchar2 is

  begin
      if vsCampCode is null or psCamp <> vsCampCode then
         vsCampDesc := pk_Seprad1.F_CampDesc(psCamp);
      end if;

      return vsCampDesc;
  end f_CampDesc;

  function f_CollDesc(psColl varchar2) return varchar2 is

  begin
      if vsCollCode is null or psColl <> vsCollCode then
         vsCollDesc := pk_Seprad1.F_CollDesc(psColl);
      end if;

      return vsCollDesc;
  end f_CollDesc;

  procedure p_GrdeAdm(pnPidm number) is

  begin
      vsProg := NULL;
      vsPaav := NULL;
      vsPaan := NULL;
      vsSexo := NULL;

      begin
          select swmspbr_program_alumno,
                 swmspbr_paav_alumno,
                 swmspbr_paan_alumno,
                 swmspbr_sexo_alumno
            into vsProg, vsPaav, vsPaan, vsSexo
            from swmspbr
           where swmspbr_camp_code   = vsCamp
             and swmspbr_term_code   = vsTerm
             and swmspbr_pidm_alumno = pnPidm;
      exception
          when others then
               null;
      end;
  end p_GrdeAdm;

  BEGIN
      -- valida que el usuario pertenezca a la base de datos
      IF PK_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      vsCamp := pk_objHTML.getValueCookie('psSprUn');
      vsEncu := pk_objHTML.getValueCookie('psSeprd');
      vsTerm := pk_objHTML.getValueCookie('psSprTD');
      vsColl := pk_objHTML.getValueCookie('psSprCo');
      vsPtrm := pk_objHTML.getValueCookie('psPtrmP');
      vsRate := pk_objHTML.getValueCookie('psRatS');
      vsExcel := PK_ObjHTML.getValueCookie('reporteEnExcel');

      IF vsExcel = 'EXCELL' THEN
         owa_util.mime_header('application/ms-excel',true);
         owa_util.http_header_close;
      END IF;

      -- ejecuta procesos para minimizar tiempo
      PWAISSBSECT(vsCamp,vsTerm,vsColl,vsSubjCode,vsSstsCode,vsPtrm);
      PWARSEPRAD(vsTerm,vsEncu,vsRate);

      FOR regRea IN cuReactivos(vsEncu) LOOP
         vnReac := vnReac + cn1;
         tabReac(vnReac).qcodCode := regRea.qcodCode;
         tabReac(vnReac).qcodDesc := regRea.qcodDesc;
         tabReac(vnReac).teqaCode := regRea.teqaCode;
      END LOOP;

      htp.p('<html><head><title>'||psReclDesc||'</title>' );



      -- la aplicacin no se guarda en el cache de la mquina
      PK_ObjHTML.P_NoCache;

      -- cdigo css
      PK_ObjHTML.P_CssTabs;

      htp.p('<script language="JavaScript"><!--');
      htp.p('function fImprimeReporte() {
      window.focus()
      print();
      }');
      htp.p('//--></script>');

      htp.p('</head><body bgcolor="#ffffff" class="bodyCeroR"><br/>');

      htp.p('<script language="javascript" src="kwacnls.js"></script>');

      htp.p('<table border="0" cellpadding="2" cellspacing="1" bordercolor="#ffffff" bgcolor="#ffffff" width="100%">
      <tr class="trTabSepara">
          <td rowspan="4" width="10%" valign="top"><img src="/imagenes/logo_uft.jpg'||'" width="80" border="0"></td>
          <td colspan="2" align="left" valign="top" class="tdTitulo"><b>'||
           REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(psReclDesc,'~aacute','&aacute'),'~eacute','&eacute'),'~iacute','&iacute'),'~oacute','&oacute'),'~uacute','&uacute')
           ||' - '||vsTerm||'</b></td>
          </tr>
      <tr class="trTabSepara"><td valign="top" width="70%">'||pK_Seprad1.F_Fecha||'</td>
                              <td valign="top" width="30%" align="right"></td></tr>
      <tr class="trTabSepara"><td colspan="2"></td></tr>
      <tr class="trTabSepara"><td colspan="2"></td></tr>
      </table><br/>');

      htp.p('<table border="1" width="100%">');
      htp.p('<tr><td colspan="24"  '||PK_ObjHTML.vgsBorderDDDDDD||'></td>');

      FOR vnI IN cn1..vnReac LOOP
          htp.p('<td bgcolor="#efefef" valign="bottom" class="tdFont7"  '||PK_ObjHTML.vgsBorderDDDDDD||'>'||tabReac(vnI).qcodDesc||'</td>');
      END LOOP;

      htp.p('</tr>
      <tr bgcolor="#efefef">
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>No.</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Campus</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Sede</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Sede_descr</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Parte de periodo</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Cve_Esc_Materia</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Desc_Esc_Materia</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Cve_Programa_Alumno</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Desc_Programa_Alumno</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Exp_Profesor</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Pers_Suffix</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Nombre_Profesor</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Sexo_Profesor</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Cve_Contrato_Profesor</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Desc_Contrato_Profesor</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Cve_Nivel_Acad_Profesor</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Desc_Nivel_Acad_Profesor</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Cve_Materia</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Nombre_Materia</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Tipo_Materia</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>CRN     </td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>PAA Verbal</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>PAA Numrica</td>
      <td valign="bottom" '||PK_ObjHTML.vgsBorderDDDDDD||'>Sexo Alumno</td>');

      FOR vnI IN cn1..vnReac LOOP
          htp.p('<td valign="bottom" class="tdFont7"  '||PK_ObjHTML.vgsBorderDDDDDD||'>'||tabReac(vnI).qcodCode||'</td>');
      END LOOP;

      htp.p('</tr>');


      FOR regBrut IN cuBruto LOOP
             vnRow  := vnRow + cn1;

             IF vnPidmA IS NULL OR vnPidmA <> regBrut.PidA THEN
                p_GrdeAdm(regBrut.PidA);

                vsPro2 := vsProG;
             ELSE
                vsProG := vsPro2;
             END IF;

             vsProgCode := SUBSTR(vsProg,cn1,INSTR(vsProg,csArrB) - cn1);
                 vsProg := SUBSTR(vsProg,    INSTR(vsProg,csArrB) + cn1);

             vsProgDesc := SUBSTR(vsProg,cn1,INSTR(vsProg,csArrB) - cn1);
                 vsProg := SUBSTR(vsProg,    INSTR(vsProg,csArrB) + cn1);

--             vsProgVpdi := SUBSTR(vsProg,cn1,INSTR(vsProg,csArrB)- cn1);
--                 vsProg := SUBSTR(vsProg,  INSTR(vsProg,csArrB)+ cn1);
--             vsSedeCode := SUBSTR(vsProg,  INSTR(vsProg,csArrB)+ cn1);

             IF vsProgCode IS NULL THEN
                vsProgCode := '<b><font color="#ff0000" size="4">'||regBrut.PidA||'</font></b>';
             END IF;

             htp.p('<tr>
             <td '||PK_ObjHTML.vgsBorderDDDDDD||' valign="top" align="right">'||vnRow||'.</td>
             <td '||PK_ObjHTML.vgsBorderDDDDDD||' valign="top">'||f_CampDesc(regBrut.Camp)||'</td>
             <td '||PK_ObjHTML.vgsBorderDDDDDD||' valign="top">'||vsSedeCode||'</td>
             <td '||PK_ObjHTML.vgsBorderDDDDDD||' valign="top">'||pk_catalogo.fstvrate(vsSedeCode)||'</td>
             <td '||PK_ObjHTML.vgsBorderDDDDDD||' valign="top">'||regBrut.Ptrm                       ||'</td>
             <td '||PK_ObjHTML.vgsBorderDDDDDD||' valign="top">'||regBrut.Coll                       ||'</td>
             <td '||PK_ObjHTML.vgsBorderDDDDDD||' valign="top">'||f_CollDesc(regBrut.Coll)||'</td>
             <td '||PK_ObjHTML.vgsBorderDDDDDD||' valign="top">'||vsProgCode                         ||'</td>
             <td '||PK_ObjHTML.vgsBorderDDDDDD||' valign="top">'||vsProgDesc                         ||'</td>
             '                 ||F_IdNameFaculty(regBrut.Faculty)   ||'
             <td '||PK_ObjHTML.vgsBorderDDDDDD||' valign="top">'||FWRSEXO(regBrut.Faculty)           ||'</td>
             '                 ||F_TipoContrato(regBrut.Faculty)    ||'
             '                 ||F_GradoAcademico(regBrut.Faculty)  ||'
             <td '||PK_ObjHTML.vgsBorderDDDDDD||' valign="top">'||regBrut.Subj  ||' '||regBrut.Crse  ||'</td>
             <td '||PK_ObjHTML.vgsBorderDDDDDD||' valign="top">'||regBrut.Titulo                     ||'</td>
             <td '||PK_ObjHTML.vgsBorderDDDDDD||' valign="top">'||F_TipoMateria(regBrut.Tipo)        ||'</td>
             <td '||PK_ObjHTML.vgsBorderDDDDDD||' valign="top">'||regBrut.Crn                        ||'</td>
             <td '||PK_ObjHTML.vgsBorderDDDDDD||' valign="top">'||vsPaav                             ||'</td>
             <td '||PK_ObjHTML.vgsBorderDDDDDD||' valign="top">'||vsPaan                             ||'</td>
             <td '||PK_ObjHTML.vgsBorderDDDDDD||' valign="top">'||vsSexo                             ||'</td>
             ');

             FOR vnI IN cn1..vnReac LOOP
                 vsNoAplica := f_qpoints(regBrut.Term, regBrut.Crn, regBrut.PidB, regBrut.Faculty, tabReac(vnI).qcodCode,vsEncu);

                 -- se realiza la cuenta de las evaluaciones "no aplica"
                 IF tabReac(vnI).teqaCode IN(csPlanea,csHabil,csEvalua,csRasgos,csIdentif,csVgp,csVgc) THEN
                    vnNoAplica := vnNoAplica + TO_NUMBER(vsNoAplica);
                 END IF;

                 htp.prn('<td valign="top" '||PK_ObjHTML.vgsBorderDDDDDD);

                 IF tabReac(vnI).teqaCode = csComment THEN
                    htp.prn(' class="tdFont7" ');
                 ELSE
                    htp.prn(' align="center" ');
                 END IF;

                 htp.prn('>'||vsNoAplica||'</td>');
             END LOOP;

             htp.prn('</tr>');

             IF vnNoAplica = cnCero THEN
                vnNoAplTot := vnNoAplTot + cn1;
             END IF;

            vnPidmA    := regBrut.PidA;
            vsCampCode := regBrut.Camp;
            vsCollCode := regBrut.Coll;
            vnPidmFclt := regBrut.Faculty;
            vsTipoCode := regBrut.Tipo;
            vnNoAplica := cnCero;
      END LOOP;

      htp.p('</table><br/><br/></body></html>');

      ROLLBACK;

  EXCEPTION
      WHEN OTHERS THEN
           HTP.P(SQLERRM);
  END PWRARCH;
/


DROP PUBLIC SYNONYM PWRARCH;

CREATE PUBLIC SYNONYM PWRARCH FOR BANINST1.PWRARCH;


GRANT EXECUTE ON BANINST1.PWRARCH TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRARCH TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRARPC;

CREATE OR REPLACE PROCEDURE BANINST1.PWRARPC (
    psReclDesc            VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:        PWRARPC
OBJETIVO:            Reporte de Alumnos Respaldados para Carga
PARAMETROS:
psReclDesc            Variable estandar para la maquina de reportes custom
AUTOR:                Alejandro Gmez Mondragn
FECHA:                20131220
******************************************************************************/

    --Numero de renglones
    vnRow                PLS_INTEGER := 0;
    --Bandera para mostrar si hubo datos
    vnExists            INTEGER := 0;
    --Numero de columnas
    vnColumnas            INTEGER := 4;
    --Numero de registros
    vnRegs                INTEGER := 0;
    --Arreglo (nested table) donde se guardan los encabezados de las columnas
    tabColumna            Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
    -- la variable es una bandera que al tener el valor "imprime" no colocara
    --el salto de pgina para impresion
    vsInicoPag            VARCHAR2(10) := NULL;
    --Nmero de renglones por pgina
    vnRegsPag            PLS_INTEGER := 4000;

    --Filtro de numero de carga
    vnNumProc            NUMBER;
    --Filtro de tipo de dato
    vsTipo                VARCHAR2(1);

    CURSOR cuReporte(
        pnNumProc        NUMBER
        ,psTipo            VARCHAR2
    ) IS
        SELECT
            SWRRCRM_NUM_LINEA                        AS NumLinea
            ,SWRRCRM_CONTENIDO                        AS Contenido
            ,SWRRCRM_RESULTADO                        AS Resultado
            ,SWRRCRM_MENSAJE                        AS Mensaje
        FROM
            SWRRCRM
        WHERE
            SWRRCRM_NUM_PROCESO = pnNumProc
            AND (
                psTipo = 'T'
                OR (psTipo = 'N' AND SWRRCRM_RESULTADO IN ('W','R','E') )
                  OR (SWRRCRM_RESULTADO = psTipo)
            )
        ORDER BY
            SWRRCRM_NUM_LINEA;

BEGIN


    --Seguridad de GWAMNUR
    IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

    --Obtengo el numero de proceso
    vnNumProc := pk_objHtml.getValueCookie('psNum');
    --Obtengo el tipo de registro
    vsTipo := pk_objHtml.getValueCookie('psRgRes');

    -- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
    tabColumna.EXTEND(vnColumnas);

    --Guardamos los encabezados en el arreglo de columnas
    tabColumna( 1) := '#';
    tabColumna( 2) := 'Contenido';
    tabColumna( 3) := 'Resultado';
    tabColumna( 4) := 'Comentario';

    --Inicializamos contador de renglones
    vnRow := 0;

    FOR regReporte IN cuReporte(vnNumProc,vsTipo) LOOP

        --Incremento el contador de renglones
        vnRow := vnRow + 1;
        vnExists := 1; --Bandera para indicar que hubo resultados

        --Si es el primer renglon de cada pgina...
        IF MOD(vnRow, vnRegsPag) = 1  THEN
            --imprimo el encabezado de reporte
            Pk_Sisrepimp.P_EncabezadoDeReporte(
                psReclDesc ,vnColumnas ,tabColumna
                ,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
            );
            vsInicoPag := 'SALTO';
        END IF;

        --Comienzo a desplegar el renglon
        HTP.P('<tr>');
        HTP.P('<td>'||regReporte.NumLinea||'</td>');
        HTP.P('<td>'||regReporte.Contenido||'</td>');
        HTP.P('<td>'||regReporte.Resultado||'</td>');
        HTP.P('<td>'||regReporte.Mensaje||'</td>');
        --Fin del renglon
        HTP.P('</tr>');

    END LOOP;

    IF vnExists = 0 THEN
        --Ojo esta linea lo que hace es imprimir
        --NO SE ENCONTRARON DATOS o un mensaje similar
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
    ELSE

        -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pagina
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
    END IF;

    --Fin de la pagina
    htp.p('</table><br/></body></html>');
EXCEPTION
    WHEN OTHERS THEN
        --pantallazo de error.
        pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
            'PWRARPC', NULL);
END PWRARPC;
/


DROP PUBLIC SYNONYM PWRARPC;

CREATE PUBLIC SYNONYM PWRARPC FOR BANINST1.PWRARPC;


GRANT EXECUTE ON BANINST1.PWRARPC TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRASAG;

CREATE OR REPLACE PROCEDURE BANINST1.PWRASAG (
   psReclDesc    VARCHAR2,
   psCRN         VARCHAR2 DEFAULT NULL,
   psTerm        VARCHAR2 DEFAULT NULL,
   psClave       VARCHAR2 DEFAULT NULL,
   psTitulo      VARCHAR2 DEFAULT NULL,
   psSiu         VARCHAR2 DEFAULT NULL,
   psAccion      VARCHAR2 DEFAULT NULL,
   psSubjCode    VARCHAR2 DEFAULT NULL,
   psCrseNumb    VARCHAR2 DEFAULT NULL)
IS
   /*
    Tarea: Reportar la situacin acadmica general del estudiante
    Modulo: Historia Acadmica
    Fecha: 31/05/2013.
    Autor: AMC
   */

   global_Pidm                SPRIDEN.SPRIDEN_PIDM%TYPE;

   tabColumna                 Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla (1);
   vnExists                   NUMBER (4) := 0;
   vnColumnas                 NUMBER (1) := 8;
   vnElectivo                 NUMBER (1) := 0;
   vnRequest                  NUMBER (4) := NULL;
   vsPidm                     NUMBER (9) := NULL;
   vnMED_POND                 NUMBER (23, 9) := NULL;
   vnCOMPLETOX                NUMBER (23, 9) := NULL;
   vnPromedioArit             NUMBER (6, 4) := NULL;
   vsLevlCode                 VARCHAR2 (2) := NULL;
   vsTermCode                 VARCHAR2 (6) := NULL;
   vsID                       VARCHAR2 (9) := NULL;
   vgsInicoPag                VARCHAR2 (10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pagina para impresion
   vgCalificacion             VARCHAR2 (15) := NULL;
   vsCamp                     VARCHAR2 (10) := NULL;
   vsTermCodeNoUsado          VARCHAR2 (10) := NULL;
   vsGradCodeNoUsado          VARCHAR2 (10) := NULL;
   vsGmodCodeNoUsado          VARCHAR2 (10) := NULL;
   vsInd01                    VARCHAR2 (15) := NULL;
   vsInd02                    VARCHAR2 (15) := NULL;
   vsProg                     VARCHAR2 (20) := NULL;
   vsMajor                    VARCHAR2 (40) := NULL;
   vsCREDI_REQ                VARCHAR2 (50) := NULL;
   vsCREDI_OBT                VARCHAR2 (50) := NULL;
   vsPrograma                 VARCHAR2 (70) := NULL;
   vsMajorDesc                VARCHAR2 (70) := NULL;
   vsArea                     VARCHAR2 (100) := NULL;
   vsAreaDesc                 VARCHAR2 (400) := NULL;
   vsCDL                      VARCHAR2 (100) := NULL;
   vsIndirizzo                VARCHAR2 (100) := NULL;
   vsImgCorrecto              VARCHAR2 (100) := NULL;
   vsStstDesc                 VARCHAR2 (100) := NULL;
   vsNombre                   VARCHAR2 (120) := NULL;
   vsMateria2                 VARCHAR2 (500) := NULL;
   vsSudbDesc                 STVSUDB.STVSUDB_DESC%TYPE := NULL;
   vsSudeDesc                 STVSUDE.STVSUDE_DESC%TYPE := NULL;
   vsAstdDesc                 STVASTD.STVASTD_DESC%TYPE := NULL;

   csN               CONSTANT VARCHAR2 (1) := 'N';
   csY               CONSTANT VARCHAR2 (1) := 'Y';
   csH               CONSTANT VARCHAR2 (1) := 'H';
   csR               CONSTANT VARCHAR2 (1) := 'R';
   cs0               CONSTANT VARCHAR2 (1) := '0';
   csPunto           CONSTANT VARCHAR2 (1) := '.';
   csEsp             CONSTANT VARCHAR2 (1) := ' ';
   csAst             CONSTANT VARCHAR2 (1) := '*';
   csINGL            CONSTANT VARCHAR2 (4) := 'INGL';
   csAING            CONSTANT VARCHAR2 (4) := 'AING';
   csALIN            CONSTANT VARCHAR2 (4) := 'ALIN';
   csIDIT            CONSTANT VARCHAR2 (4) := 'IDIT';
   csIDIO            CONSTANT VARCHAR2 (4) := 'IDIO';
   csASEM            CONSTANT VARCHAR2 (4) := 'ASEM';
   csSSOSC           CONSTANT VARCHAR2 (4) := 'SSOC';
   csCampCode        CONSTANT VARCHAR2 (6) := f_contexto ();
   csWEBUSER         CONSTANT VARCHAR2 (7) := 'WEBUSER';
   csCursando        CONSTANT VARCHAR2 (8) := 'cursando';
   csSincursar       CONSTANT VARCHAR2 (9) := 'sincursar';
   csAcred           CONSTANT VARCHAR2 (10) := 'acreditado';
   csAcreditado      CONSTANT VARCHAR2 (100)
      := '<img width="13" height="13" border="0" src="/imagenes/acreditado.jpg"/>' ;
   csDesacreditado   CONSTANT VARCHAR2 (100)
      := '<img width="13" height="13" border="0" src="/imagenes/sincursar.jpg"/>' ;
   cn0               CONSTANT INTEGER := 0;
   cn1               CONSTANT INTEGER := 1;
   cn2               CONSTANT INTEGER := 2;
   cn10              CONSTANT INTEGER := 10;
   cn20              CONSTANT INTEGER := 20;
   cn30              CONSTANT INTEGER := 30;
   cn40              CONSTANT INTEGER := 40;
   cn50              CONSTANT INTEGER := 50;
   cn60              CONSTANT INTEGER := 60;
   cn100             CONSTANT INTEGER := 100;

   --cuDetalle
   CURSOR cuDetalle
   IS
        SELECT NVL (
                  (SELECT smrpaap_area_priority
                     FROM smrpaap a
                    WHERE a.smrpaap_term_code_eff =
                             (SELECT MAX (b.smrpaap_term_code_eff)
                                FROM smrpaap b
                               WHERE b.smrpaap_program = vsProg)
                          AND a.smrpaap_area = smrdorq_area
                          AND a.smrpaap_program = vsProg),
                  cn100)
                  AS orden,
               SMRDORQ_AREA AS area,
               DECODE (
                  SMRDOUS_CRSE_SOURCE,
                  csR, SMRDOUS_CREDIT_HOURS,
                  DECODE (
                     SMRDORQ_MET_IND,
                     csY, SMRDOUS_CREDIT_HOURS,
                     NVL (
--                        (SELECT a.scbcrse_credit_hr_low
--                           FROM scbcrse a
--                          WHERE a.scbcrse_eff_term =
--                                   (SELECT MAX (b.scbcrse_eff_term)
--                                      FROM scbcrse b
--                                     WHERE b.scbcrse_crse_numb        = a.scbcrse_crse_numb
--                                           AND b.scbcrse_subj_code    = a.scbcrse_subj_code
--                                           AND b.scbcrse_eff_term     <= NVL (SMRDORQ_TERM_CODE_EFF, SMRDOUS_TERM_CODE))
--                                AND a.scbcrse_crse_numb = NVL (SMRDORQ_CRSE_NUMB_LOW, SMRDOUS_CRSE_NUMB)
--                                AND a.scbcrse_subj_code = NVL (SMRDORQ_SUBJ_CODE, SMRDOUS_SUBJ_CODE))
--                                ,
                        (SELECT a.scbcrse_credit_hr_low
                           FROM scbcrse a
                          WHERE a.scbcrse_eff_term =
                                   (SELECT MAX (b.scbcrse_eff_term)
                                      FROM scbcrse b
                                     WHERE b.scbcrse_crse_numb        = a.scbcrse_crse_numb
                                           AND b.scbcrse_subj_code    = a.scbcrse_subj_code)
                                AND a.scbcrse_crse_numb = NVL (SMRDORQ_CRSE_NUMB_LOW, SMRDOUS_CRSE_NUMB)
                                AND a.scbcrse_subj_code = NVL (SMRDORQ_SUBJ_CODE,SMRDOUS_SUBJ_CODE)
                         ),
                        (SELECT MAX(SCBCRSE_CREDIT_HR_LOW)
                           FROM SCBCRSE
                          WHERE SCBCRSE_SUBJ_CODE||' '||SCBCRSE_CRSE_NUMB IN
                            (SELECT smbarul_key_rule
                               FROM smbarul
                              WHERE smbarul_key_rule = SMRDORQ_RULE
                                    AND smbarul_area = SMRDORQ_AREA
                                    AND smbarul_term_code_eff =
                                           (SELECT MAX (x.smbarul_term_code_eff)
                                              FROM smbarul x
                                             WHERE x.smbarul_key_rule = SMRDORQ_RULE
                                                   AND x.smbarul_area = SMRDORQ_AREA
                                                   AND x.smbarul_term_code_eff <= NVL ( SMRDORQ_TERM_CODE_EFF, SMRDOUS_TERM_CODE))
                             )
                      )
                        )
                        )
                      )
                  AS cred,
                 NVL(
                             (SELECT MAX (SMRDOUS_GRDE_CODE)
                                FROM SMRDOUS-- SMRDOCN_GRDE_CODE
                                WHERE SMRDOUS_PIDM = F_GETPIDM(vsID)
                                  AND SMRDOUS_REQUEST_NO = vnRequest
                                  --AND SMRDOUS_SUBJ_CODE = SWRSEMF.SMRDORQ_SUBJ_CODE
                                  AND SMRDOUS.SMRDOUS_CRSE_NUMB = SWRSEMF.SMRDOUS_CRSE_NUMB
                                  AND SMRDOUS.SMRDOUS_CRN = SWRSEMF.SMRDOUS_CRN
                                  AND SMRDOUS_PROGRAM = vsProg),
                             (SELECT MAX (SMRDOCN_GRDE_CODE)
                                FROM SMRDOCN
                                 WHERE SMRDOCN_PIDM = F_GETPIDM(vsID)
                                   AND SMRDOCN_REQUEST_NO = vnRequest
                                   --AND SMRDOCN_SUBJ_CODE = SWRSEMF.SMRDORQ_SUBJ_CODE
                                   AND SMRDOCN_CRSE_NUMB = SWRSEMF.SMRDOUS_CRSE_NUMB
                                   AND SMRDOCN_CRN = SWRSEMF.SMRDOUS_CRN
                                   AND SMRDOCN_PROGRAM = vsProg)
                     )
                    AS grde,
               SMRDOUS_TERM_CODE AS term,
               DECODE (SMRDOUS_CRSE_SOURCE,
                       csR, csCursando,
                       DECODE (SMRDORQ_MET_IND, csY, csAcred, csSincursar))
                  AS stat,
               SMRDOUS_CRN AS crnn,
               DECODE (SMRDOUS_CRSE_SOURCE, csR, NULL, SMRDOUS_GMOD_CODE)
                  AS gmod,
               NVL (
                  (SELECT a.scrsyln_long_course_title
                     FROM scrsyln a
                    WHERE a.scrsyln_term_code_eff =
                             (SELECT MAX (b.scrsyln_term_code_eff)
                                FROM scrsyln b
                               WHERE b.scrsyln_term_code_eff <=
                                        NVL (SMRDORQ_TERM_CODE_EFF,
                                             SMRDOUS_TERM_CODE)
                                     AND b.scrsyln_crse_numb =
                                            a.scrsyln_crse_numb
                                     AND b.scrsyln_subj_code =
                                            a.scrsyln_subj_code)
                          AND a.scrsyln_crse_numb =
                                 NVL (SMRDORQ_CRSE_NUMB_LOW, SMRDOUS_CRSE_NUMB)
                          AND a.scrsyln_subj_code =
                                 NVL (SMRDORQ_SUBJ_CODE, SMRDOUS_SUBJ_CODE)),
                  UPPER (
                     NVL (
                        smrdous_title,
                        (SELECT MAX (smbarul_desc)
                           FROM smbarul
                          WHERE smbarul_key_rule = SMRDORQ_RULE
                                AND smbarul_area = SMRDORQ_AREA
                                AND smbarul_term_code_eff =
                                       (SELECT MAX (x.smbarul_term_code_eff)
                                          FROM smbarul x
                                         WHERE x.smbarul_key_rule =
                                                  SMRDORQ_RULE
                                               AND x.smbarul_area =
                                                      SMRDORQ_AREA
                                               AND x.smbarul_term_code_eff <=
                                                      NVL (
                                                         SMRDORQ_TERM_CODE_EFF,
                                                         SMRDOUS_TERM_CODE)))


                        )))
                  AS titl,
                  (SELECT MAX (REPLACE(SMBARUL_KEY_RULE,' ',''))
                           FROM smbarul
                          WHERE smbarul_key_rule = SMRDORQ_RULE
                                AND smbarul_area = SMRDORQ_AREA
                                AND smbarul_term_code_eff =
                                       (SELECT MAX (x.smbarul_term_code_eff)
                                          FROM smbarul x
                                         WHERE x.smbarul_key_rule = SMRDORQ_RULE
                                               AND x.smbarul_area = SMRDORQ_AREA
                                               AND x.smbarul_term_code_eff <= NVL ( SMRDORQ_TERM_CODE_EFF, SMRDOUS_TERM_CODE))) clave,
               (SELECT DECODE (COUNT (cn1), cn0, NULL, csAst)
                  FROM scrrtst a
                 WHERE a.scrrtst_term_code_eff =
                          (SELECT MAX (b.scrrtst_term_code_eff)
                             FROM scrrtst b
                            WHERE b.scrrtst_crse_numb = a.scrrtst_crse_numb
                                  AND b.scrrtst_subj_code = a.scrrtst_subj_code
                                  AND b.scrrtst_term_code_eff <=
                                         NVL (SMRDORQ_TERM_CODE_EFF,
                                              SMRDOUS_TERM_CODE))
                       AND a.SCRRTST_SEQNO =
                              (SELECT MAX (c.scrrtst_seqno)
                                 FROM scrrtst c
                                WHERE c.SCRRTST_CRSE_NUMB_PREQ =
                                         a.SCRRTST_CRSE_NUMB_PREQ
                                      AND c.SCRRTST_SUBJ_CODE_PREQ =
                                             a.SCRRTST_SUBJ_CODE_PREQ
                                      AND c.scrrtst_term_code_eff <=
                                             NVL (SMRDORQ_TERM_CODE_EFF,
                                                  SMRDOUS_TERM_CODE))
                       AND a.scrrtst_crse_numb =
                              NVL (SMRDORQ_CRSE_NUMB_LOW, SMRDOUS_CRSE_NUMB)
                       AND a.scrrtst_subj_code =
                              NVL (SMRDORQ_SUBJ_CODE, SMRDOUS_SUBJ_CODE))
                  AS serc,
               SMRDORQ_RULE AS Regla,
               SMRDOUS_ATTR_CODE AS Atrt,
               NVL (SMRDORQ_TERM_CODE_EFF, SMRDOUS_TERM_CODE) AS termCode,
               NVL (SMRDORQ_CRSE_NUMB_LOW, SMRDOUS_CRSE_NUMB) AS crseCode,
               NVL (SMRDORQ_SUBJ_CODE, SMRDOUS_SUBJ_CODE) AS subjCode,
               (SELECT LTRIM (RTRIM (SMRACMT_TEXT))
                  FROM SMRACMT
                 WHERE SMRACMT_TERM_CODE_EFF =
                          (SELECT MAX (B.SMRACMT_TERM_CODE_EFF)
                             FROM SMRACMT B
                            WHERE B.SMRACMT_AREA = SMRDORQ_AREA)
                       AND SMRACMT_AREA = SMRDORQ_AREA
                       AND ROWNUM = cn1)
                  AS areaDesc
          FROM SWRSEMF
         WHERE   SMRDORQ_TERM_CODE_EFF = '201025'
      ORDER BY orden,
               term,
               subjCode,
               crseCode;

   --cuNoCapp
   CURSOR cuNoCapp
   IS
      SELECT (SELECT STVNCRQ_DESC
                FROM STVNCRQ
               WHERE STVNCRQ_CODE = SHRNCRS_NCRQ_CODE)
                AS ncrqCode,
             (SELECT STVNCST_DESC
                FROM STVNCST
               WHERE STVNCST_CODE = SHRNCRS_NCST_CODE)
                AS ncstCode,
             SHRNCRS_NCST_DATE AS ncstDate
        FROM SHRNCRS
       WHERE --(  SHRNCRS_NCRQ_CODE IN (csINGL,csSSOSC,csAING,csALIN,csIDIT,csIDIO,csASEM)
             -- SHRNCRS_NCRQ_CODE IN (NULL, csSSOSC, csAING, csALIN, csIDIT, csIDIO, csASEM)
              --OR SHRNCRS_NCST_CODE IN (NULL, csSSOSC, csAING, csALIN, csIDIT, csIDIO, csASEM))
             --AND
             SHRNCRS_PIDM = vsPidm;

   --cabeceroDet
   FUNCTION cabeceroDet (psArea VARCHAR2, psAreaDesc VARCHAR2)
      RETURN VARCHAR2
   IS
      vsIMG          VARCHAR2 (100) := NULL;
      vsColumna      VARCHAR2 (100)
         := '<th width="8%" bgcolor="#efefef" style="border-left:none;"></th>';
      vsBorderRig    VARCHAR2 (100) := 'style="border-right:none;"';
      vnReqCredits   smbaogn.smbaogn_req_credits_overall%TYPE := NULL;
      vnCredits      smbaogn.smbaogn_req_credits_overall%TYPE := NULL;
   BEGIN
      SELECT CASE
                WHEN COUNT (cn1) > cn0 THEN csDesacreditado
                ELSE csAcreditado
             END
        INTO vsIMG
        FROM swrsemf
       WHERE smrdorq_met_ind <> csY AND smrdorq_area = psArea;

      -- creditos a cumplir
      SELECT smbaogn_req_credits_overall
        INTO vnReqCredits
        FROM smbaogn
       WHERE     smbaogn_pidm = vsPidm
             AND smbaogn_request_no = vnRequest
             AND smbaogn_program = vsProg
             AND smbaogn_area = psArea;

      --creditos cumplidos
      SELECT SUM (
                DECODE (smrdorq_met_ind,
                        csY, NVL (smrdous_credit_hours, cn0),
                        cn0))
        INTO vnCredits
        FROM swrsemf
       WHERE smrdorq_area = psArea;

      IF vnCredits = 0
      THEN
         SELECT SUM (NVL (smrdous_credit_hours, cn0))
           INTO vnCredits
           FROM swrsemf
          WHERE smrdorq_area = psArea;
      END IF;

      IF psAreaDesc LIKE '%ELECTIVO%'
      THEN
         vnElectivo := 1;

         vsBorderRig := NULL;
         vsColumna := '<th width="8%" bgcolor="#efefef">Atributos </th>';
      END IF;

      --||'::'||psArea||'::'
      RETURN    '<tr><th bgcolor="#efefef" align="left" colspan="6">'
             || psAreaDesc
             || '('
             || psArea
             || ')'
             || ' '
             || vnCredits
             || ' de '
             || vnReqCredits
             || '</th>'
             || '<th bgcolor="#efefef" align="right" >Completo</th>'
             || '<td align="center">'
             || vsIMG
             || '</td>'
             || '</tr>'
             || '<tr>'
             || '<th width="47%" bgcolor="#efefef" '
             || vsBorderRig
             || '>Requerimientos</th>'
             || vsColumna
             || '<th width="7%" bgcolor="#efefef">Seriaci&oacuten</th>'
             || '<th width="7%" bgcolor="#efefef">Cr&eacuteditos</th>'
             || '<th width="8%" bgcolor="#efefef">Periodo</th>'
             || '<th width="8%" bgcolor="#efefef">Calificaci&oacuten</th>'
             || '<th width="10%" bgcolor="#efefef">Modo de calificaci&oacuten</th>'
             || '<th width="5%" bgcolor="#efefef">Completo</th>'
             || '</tr>';
   END cabeceroDet;

   --cabeceroGral
   FUNCTION cabeceroGral
      RETURN VARCHAR2
   IS
   BEGIN
      RETURN    '<tr><td colspan="'
             || vnColumnas
             || '" style="border:solid #ffffff 1.0pt;">'
             || '<table border="0" cellpadding="2" cellspacing="0" bordercolor="#dddddd" bgcolor="#ffffff" width="100%"><tr><td width="90%" valign="top">'
             || '<table border="1" bordercolor="#dddddd" bgcolor="#ffffff" width="100%">'
             || '<tr>'
             ||     '<th width="15%" align="left" valign="bottom" bgcolor="#efefef">'
             || '      ID:'
             || '    </th>'
             || '    <td width="17%">'
             ||        vsID
             || '    </td>'
             || '    <th width="17%" align="left" valign="bottom" bgcolor="#efefef">'
             || '      Status alumno:'
             || '    </th>'
             || '    <td width="17%">'
             ||        vsStstDesc
             || '    </td>'
             || '    <th width="18%" align="left" valign="bottom" bgcolor="#efefef">'
             || '      Completo:'
             || '    </th>'
             || '    <td width="16%" align="center" >'
             ||        vsImgCorrecto
             || '    </td>'
             || '</tr>'
             || '<tr>'
             || '    <th align="left" valign="bottom" bgcolor="#efefef">'
             || '      Rut:'
             || '    </th>'
             || '    <td>'
             ||        F_GET_RUT(vsID)
             || '    </td>'
             || '    <th align="left" valign="bottom" bgcolor="#efefef">'
             || '      Carrera:'
             || '    </th>'
             || '    <td>'
             ||        vsIndirizzo
             || '    </td>'
             || '    <th align="left" valign="bottom" bgcolor="#efefef">'
             || '      Cr&eacute;ditos Requeridos:'
             || '    </th>'
             || '    <td >'
             ||        vsCREDI_OBT
             || '    </td>'
             || '</tr>'
             || '<tr>'
             || '    <th align="left" valign="bottom" bgcolor="#efefef">'
             || '      Nombre:'
             || '    </th>'
             || '    <td>'
             ||        vsNombre
             || '    </td>'
             || '    <th align="left" valign="bottom" bgcolor="#efefef">'
             || '      Promedio ponderado:'
             || '    </th>'
             || '    <td lign="center" >'
             ||        vnMED_POND
             || '    </td>'
             || '    <th align="left" valign="bottom" bgcolor="#efefef">'
             || '      % de Avance:'
             || '    </th>'
             || '    <td lign="center" >'
             ||        TO_NUMBER (vsSudeDesc, '999')
             || '   %</td> '
             || '</tr>'
             || '<tr>'
             || '    <th align="left" valign="bottom" bgcolor="#efefef">'
             || '      Programa:'
             || '    </th>'
             || '    <td >'
             ||        vsCDL
             || '    </td>'
             || '    <th align="left" valign="bottom" bgcolor="#efefef"> '
             || '      Promedio aritmtico:'
             || '    </th>'
             || '    <td lign="center" >'
             ||        vnPromedioArit
             || '    </td>'
             || '    <th align="left" valign="bottom" bgcolor="#efefef">'
             || '      Cr&eacute;ditos Obtenidos:'
             || '    </th>'
             || '    <td >'
             ||        vsCREDI_REQ
             || '    </td>'
             || '</tr>'
             || '</table>'
             || '</td><td width="10%">'
             || '<table border="0" cellpadding="0" cellspacing="0" bgcolor="#ffffff" width="5%">'
             || '<tr>'
             || '<td width="20%" align="center" ><img src="ARCHIVO.jpg?pnPidm='
             || vsPidm
             || '" width="100" height="130"></td>'
             || '</tr>'
             || '</table>'
             || '</td></tr></table>'
             || '</td></tr>'
             || '<tr><td colspan="'
             || vnColumnas
             || '" style="border:solid #ffffff 1.0pt;">'
             || '</td></tr>';
   END cabeceroGral;

   --obtiene el maximo valor de ejecucin del CAPP
   --getMaxRequest
   PROCEDURE getMaxRequest (pnPidm NUMBER, psPrograma VARCHAR2)
   IS
   BEGIN
      SELECT MAX (smrrqcm_request_no)
        INTO vnRequest
        FROM smrrqcm
       WHERE     smrrqcm_orig_curr_source <> csWEBUSER
             AND smrrqcm_process_ind = csN
             AND smrrqcm_program = psPrograma
             AND smrrqcm_pidm = pnPidm;

      SELECT smrrqcm_term_code_eval
        INTO vsTermCode
        FROM smrrqcm
       WHERE     smrrqcm_request_no = vnRequest
             AND smrrqcm_orig_curr_source <> csWEBUSER
             AND smrrqcm_process_ind = csN
             AND smrrqcm_program = psPrograma
             AND smrrqcm_pidm = pnPidm;
   END getMaxRequest;

   --getNombre
   FUNCTION getNombre (psId VARCHAR2)
      RETURN VARCHAR2
   IS
      vsPaso   VARCHAR2 (110) := NULL;
   BEGIN
      SELECT REPLACE (spriden_last_name || ' ' || spriden_first_name,
                      '*',
                      ' ')
        INTO vsPaso
        FROM spriden
       WHERE spriden_id = psId AND spriden_change_ind IS NULL;

      RETURN vsPaso;
   EXCEPTION
      WHEN NO_DATA_FOUND
      THEN
         RETURN NULL;
   END getNombre;

   --getSGBSTDN
   PROCEDURE getSGBSTDN
   IS
      --cuTbl1
      CURSOR cuTbl1
      IS
         SELECT smbpogn_pidm pidm,
                DECODE (smbpogn_met_ind, 'Y', csAcred, csSincursar) terminado,
                DECODE (smbpogn_connector_overall,
                        'A', smbpogn_req_credits_overall || ' Crditos ',
                        'O', smbpogn_req_credits_overall || ' Crditos ',
                        'N', smbpogn_req_credits_overall || ' Crditos ')
                   credi_req,
                DECODE (smbpogn_connector_overall,
                        'A', smbpogn_act_credits_overall || ' Crditos ',
                        'O', smbpogn_act_credits_overall || ' Crditos ',
                        'N', smbpogn_act_credits_overall || ' Crditos')
                   credi_obt,
                smbpogn_act_gpa media_ponderata,
                smbpogn_req_credits_overall - smbpogn_act_credits_overall
                   completox
           FROM smbpogn, smrrqcm
          WHERE     smbpogn_pidm = smrrqcm_pidm
                AND smbpogn_request_no = smrrqcm_request_no
                AND smbpogn_program = vsprog
                AND smbpogn_request_no = vnrequest
                AND smbpogn_pidm = vsPidm;
   BEGIN
      BEGIN
         -- Obtiene los Datos
         SELECT Majr,
                NVL ( (SELECT stvmajr_desc
                         FROM stvmajr
                        WHERE stvmajr_code = Majr),
                     csEsp),
                Prog,
                SUBSTR (Prog, cn1, cn2),
                SUBSTR (Prog, LENGTH (Prog) - cn1, cn2),
                --Prog
                NVL ( (SELECT smrprle_program_desc
                         FROM smrprle
                        WHERE smrprle_program = Prog),
                     csEsp),
                (SELECT stvstst_desc
                   FROM stvstst
                  WHERE stvstst_code = ststCode),
                levlCode
           INTO vsMajor,
                vsMajorDesc,
                vsPrograma,
                vsInd01,
                vsInd02,
                vsCDL,
                vsStstDesc,
                vsLevlCode
           FROM (SELECT MIN (sgbstdn_term_code_eff) AS fecMin,
                        MAX (sgbstdn_term_code_eff) AS fecMax,
                        MAX (sgbstdn_majr_code_1) AS Majr,
                        MAX (sgbstdn_program_1) AS Prog,
                        MAX (sgbstdn_stst_code) AS ststCode,
                        MAX (sgbstdn_levl_code) AS levlCode
                   FROM sgbstdn
                  WHERE sgbstdn_pidm = vsPidm AND sgbstdn_program_1 = vsProg);
      EXCEPTION
         WHEN OTHERS
         THEN
            NULL;
      END;

      vsIndirizzo := vsMajorDesc;

      -- Obtiene los datos de la tabla General

      FOR regTbl1 IN cuTbl1
      LOOP
         vsCREDI_REQ := regTbl1.credi_obt;
         vsCREDI_OBT := regTbl1.credi_req;
         vnMED_POND := regTbl1.media_ponderata;
         vnCOMPLETOX := regTbl1.completox;
      END LOOP;

      -- Asigna el Status del Reporte General
      IF vnCOMPLETOX = 0
      THEN
         vsImgCorrecto := csAcreditado;
      ELSE
         vsImgCorrecto := csDesacreditado;
      END IF;

      BEGIN
         SELECT NVL ( (SELECT stvsudb_desc
                         FROM stvsudb
                        WHERE stvsudb_code = sgbuser_sudb_code),
                     csEsp),                                -- Nivel de Ingls
                NVL (sgbuser_sude_code, NULL)                    --% de Avance
           INTO vsSudbDesc, vsSudeDesc
           FROM sgbuser
          WHERE sgbuser_term_code = (SELECT MAX (sgbuser_term_code)
                                       FROM sgbuser
                                      WHERE sgbuser_pidm = vsPidm)
                AND sgbuser_pidm = vsPidm;
      EXCEPTION
         WHEN OTHERS
         THEN
            NULL;
      END;

      BEGIN
         SELECT (SELECT stvastd_desc
                   FROM stvastd
                  WHERE stvastd_code = shrttrm_astd_code_end_of_term)
           INTO vsAstdDesc
           FROM shrttrm
          WHERE shrttrm_term_code =
                   (SELECT MAX (shrttrm_term_code)
                      FROM shrttrm
                     WHERE shrttrm_astd_code_end_of_term IS NOT NULL
                           AND shrttrm_pidm = vsPidm)
                AND shrttrm_pidm = vsPidm;
      EXCEPTION
         WHEN OTHERS
         THEN
            NULL;
      END;
   EXCEPTION
      WHEN OTHERS
      THEN
         NULL;
   END getSGBSTDN;

   --getprofesor
   FUNCTION getprofesor
      RETURN VARCHAR2
   IS
      vsNombre   VARCHAR2 (200) := NULL;
   BEGIN
      SELECT    spriden_id
             || csEsp
             || spriden_first_name
             || csEsp
             || spriden_last_name
                nombre
        INTO vsNombre
        FROM (SELECT sirasgn_pidm AS pidm
                FROM sirasgn
               WHERE     sirasgn_crn = psCrn
                     AND sirasgn_term_code = psTerm
                     AND ROWNUM = cn1) sirasg,
             spriden
       WHERE sirasg.pidm = spriden_pidm AND spriden_change_ind IS NULL;

      RETURN vsNombre;
   EXCEPTION
      WHEN NO_DATA_FOUND
      THEN
         RETURN NULL;
   END getprofesor;


   --datos del curso
   --muestra la informacin del curso en la misma pagina del reporte
   --datosCurso
   PROCEDURE datosCurso
   IS
   BEGIN         --UTL_URL.UNESCAPE(,'UTF-8' se cambia el color a azul #0A75A3
      HTP.
       p (
         '
          <table border="0" cellpadding="0" bordercolor="#651612" bgcolor="#B0B0FF" cellspacing="0" width="100%" align="center">
            <tr>
              <td>
               <br/>
               <table border="0" width="100%" cellpadding="2" cellspacing="1" bgcolor="#B0B0FF" bordercolor="#0A75A3" align="center">
                 <tr>
                   <th align="right" colspan="2">
                     <a href="#"; onClick="javascript:CerrarInformacion();">Cerrar</a>
                   </th>
                 </tr>
                 <tr>
                   <th colspan="2">'
                     || psTitulo|| '
                   </th>
                 </tr>
                 <tr>
                   <th width="30%" align="right"><b>NRC:</b></th>
                   <td width="70%" >'|| NVL (psCRN, '')|| '</td>
                 </tr>
                 <tr>
                   <th align="right"><b>Profesor:</b></th>
                   <td>'|| NVL (getprofesor (), '')|| '</td>
                </tr>
                <tr>
                  <th align="right"><b>Clave:</b></th>
                  <td>'|| NVL (psClave, '')|| '</td>
                </tr>
              </table>
              <br/>
            </td>
          </tr>
        </table>');
   END datosCurso;

   --pre requicitos
   --seriacion
   PROCEDURE seriacion
   IS
      --cuSeriacion
      CURSOR cuSeriacion
      IS
         SELECT (SELECT c.scbcrse_title
                   FROM scbcrse c
                  WHERE c.scbcrse_eff_term =
                           (SELECT MAX (d.scbcrse_eff_term)
                              FROM scbcrse d
                             WHERE d.scbcrse_crse_numb =
                                      a.scrrtst_crse_numb_preq
                                   AND d.scbcrse_subj_code =
                                          a.scrrtst_subj_code_preq
                                   AND d.scbcrse_eff_term <= psTerm)
                        AND c.scbcrse_crse_numb = a.scrrtst_crse_numb_preq
                        AND c.scbcrse_subj_code = a.scrrtst_subj_code_preq)
                   AS crseTitl,
                scrrtst_subj_code_preq AS crseSubj,
                scrrtst_crse_numb_preq AS crseNumb
           FROM scrrtst a
          WHERE a.scrrtst_term_code_eff =
                   (SELECT MAX (b.scrrtst_term_code_eff)
                      FROM scrrtst b
                     WHERE     b.scrrtst_crse_numb = psCrseNumb
                           AND b.scrrtst_subj_code = psSubjCode
                           AND b.scrrtst_term_code_eff <= psTerm)
                AND a.SCRRTST_SEQNO =
                       (SELECT MAX (c.SCRRTST_SEQNO)
                          FROM scrrtst c
                         WHERE c.SCRRTST_CRSE_NUMB_PREQ =
                                  a.SCRRTST_CRSE_NUMB_PREQ
                               AND c.SCRRTST_SUBJ_CODE_PREQ =
                                      a.SCRRTST_SUBJ_CODE_PREQ
                               AND c.scrrtst_term_code_eff <= psTerm)
                AND a.scrrtst_crse_numb = psCrseNumb
                AND a.scrrtst_subj_code = psSubjCode;
   BEGIN
   null;
      HTP.p ('<table border="0" width="100%" cellpadding="2" cellspacing="1" bgcolor="#B0B0FF" bordercolor="#0A75A3" align="center">
                 <tr>
                   <th align="right">
                     <a href="#"; onClick="javascript:CerrarInformacion();">Cerrar</a>
                   </th>
                 </tr>
                 <tr>
                   <th align="center" colspan="2">'
                     || psTitulo|| '
                   </th>
                 </tr> ');

      FOR regSer IN cuSeriacion
      LOOP
         HTP.P (
             '<tr><td align="center">'|| regSer.crseSubj|| regSer.crseNumb||' &nbsp;&nbsp; &nbsp;&nbsp; '|| regSer.crseTitl|| '</td>
             </tr>');
      END LOOP;

      HTP.p ('</table><br/>');
   END seriacion;

   --cdigo java script
   --js
   PROCEDURE js
   IS
   BEGIN
      HTP.P ('
         <script language="javascript" src="kwaslct.js"></script>
         <script type="text/javascript">
          <!--
            var y1 = 10; // change the # on the left to adjuct the Y co-ordinate
            var vbgActiv = false;

          (document.getElementById) ? dom = true : dom = false;
          ');

      --CerrarInformacion
      HTP.P ('
         function CerrarInformacion() {
           document.all.divDatoMateria.style.visibility="hidden";
          } //CerrarInformacion');

      --procesoTerminado
      HTP.p ('
         function procesoTerminado() {
           parent.closeWindowTime();
         } //procesoTerminado
      ');

      --preRequisitos
      HTP.P ('
         function preRequisitos(psTitulo,psTerm, psSubj, psCrse) {
           //parent.iniciaVentana();

           var vsParametros = "psReclDesc=A" +
                              "&psCRN="      + psTerm    +
                              "&psTerm="     + psTerm   +
                              "&psClave="    + psTerm  +
                              "&psTitulo="   + encodeURIComponent(psTitulo) +
                              "&psSiu="      + "'|| psSiu || '" +
                              "&psAccion=S"+
                              "&psSubjCode="    + psSubj  +
                              "&psCrseNumb="    + psCrse;


           getMensaje("PWRASAG",vsParametros,"divDatoMateria");
           document.all.divDatoMateria.style.visibility="visible";

           if(!vbgActiv) {
             cambiaPosicion();
           }

           vbgActiv = true;

         } //preRequisitos
      ');

      --abrirInformacion
      HTP.
       p ('
        function fLovMate(psCRN, psTerm, psClave, psTitulo) {
           //parent.iniciaVentana()

           var vsParametros = "psReclDesc=A" +
                              "&psCRN="      + psCRN    +
                              "&psTerm="     + psTerm   +
                              "&psClave="    + psClave  +
                              "&psTitulo="   + encodeURIComponent(psTitulo) +
                              "&psSiu="      + "'|| psSiu || '" +"&psAccion=D";



           getMensaje("PWRASAG",vsParametros,"divDatoMateria");
           document.all.divDatoMateria.style.visibility="visible";

           if(!vbgActiv) {
             cambiaPosicion();
           }

           vbgActiv = true;
         } //fLovMate

       //cambiaPosicion
        function cambiaPosicion() {

         if (dom) {
           document.getElementById("divDatoMateria").style.visibility=''visible'';
         }

         if (document.layers) {
           document.layers["divDatoMateria"].visibility=''show'';
         }

         document.getElementById("divDatoMateria").style.left = (document.body.clientWidth/2) -400;

         moverVentana();
       } //cambiaPosicion

       //moverVentana
       function moverVentana() {

         if (dom && !document.all) {
           document.getElementById("divDatoMateria").style.top = window.pageYOffset + (window.innerHeight - (window.innerHeight-y1))
         }

 if (document.layers) {
 document.layers["divDatoMateria"].top = window.pageYOffset + (window.innerHeight - (window.innerHeight-y1))
 }

 if (document.all) {
 document.all["divDatoMateria"].style.top = document.body.scrollTop + (document.body.clientHeight - (document.body.clientHeight-y1));
 }

 window.setTimeout("moverVentana()", 10);
 }

 --></script>
 ');
   END js;

   --Son registrados los cursos usados
   PROCEDURE cursosUsados
   IS
   BEGIN
      INSERT INTO sWrdous (smrdous_pidm,
                           smrdous_request_no,
                           smrdous_compliance_order,
                           smrdous_area,
                           smrdous_caa_seqno,
                           smrdous_group,
                           smrdous_key_rule,
                           smrdous_term_code_eff,
                           smrdous_rul_seqno,
                           smrdous_rule,
                           smrdous_rul_seqno_2,
                           smrdous_program,
                           smrdous_area_priority,
                           smrdous_cnt_in_program_ind,
                           smrdous_cnt_in_area_ind,
                           smrdous_cnt_in_group_ind,
                           smrdous_cnt_in_gpa_ind,
                           smrdous_split_ind,
                           smrdous_crse_source,
                           smrdous_applied_ind,
                           smrdous_activity_date,
                           smrdous_a_crse_reuse_ind,
                           smrdous_a_attr_reuse_ind,
                           smrdous_g_crse_reuse_ind,
                           smrdous_g_attr_reuse_ind,
                           smrdous_potential_used_ind,
                           smrdous_equivalent_ind,
                           smrdous_catalog_ind,
                           smrdous_agam_set,
                           smrdous_agam_subset,
                           smrdous_crn,
                           smrdous_title,
                           smrdous_term_code,
                           smrdous_levl_code,
                           smrdous_subj_code,
                           smrdous_crse_numb,
                           smrdous_grde_code,
                           smrdous_gmod_code,
                           smrdous_credit_hours,
                           smrdous_credit_hours_used,
                           smrdous_camp_code,
                           smrdous_coll_code,
                           smrdous_dept_code,
                           smrdous_attr_code,
                           smrdous_atts_code,
                           smrdous_repeat_course_ind,
                           smrdous_trad_ind,
                           smrdous_tckn_seq_no,
                           smrdous_trit_seq_no,
                           smrdous_tram_seq_no,
                           smrdous_trcr_seq_no,
                           smrdous_trce_seq_no,
                           smrdous_dgmr_seq_no,
                           smrdous_earned_ind,
                           smrdous_cnt_in_area_gpa_ind,
                           smrdous_cnt_in_prog_gpa_ind,
                           smrdous_grde_quality_points,
                           smrdous_compl_credits,
                           smrdous_compl_courses,
                           smrdous_actn_code,
                           smrdous_adj_credits,
                           smrdous_adj_courses,
                           smrdous_adj_source_ind,
                           smrdous_agrl_key_rule,
                           smrdous_agrl_rul_seqno,
                           smrdous_agrl_rule,
                           smrdous_agrl_rul_seqno_2,
                           smrdous_tesc_code,
                           smrdous_test_score,
                           smrdous_concurrency_ind)
         SELECT smrdous_pidm,
                smrdous_request_no,
                smrdous_compliance_order,
                smrdous_area,
                smrdous_caa_seqno,
                smrdous_group,
                smrdous_key_rule,
                smrdous_term_code_eff,
                smrdous_rul_seqno,
                smrdous_rule,
                smrdous_rul_seqno_2,
                smrdous_program,
                smrdous_area_priority,
                smrdous_cnt_in_program_ind,
                smrdous_cnt_in_area_ind,
                smrdous_cnt_in_group_ind,
                smrdous_cnt_in_gpa_ind,
                smrdous_split_ind,
                smrdous_crse_source,
                smrdous_applied_ind,
                smrdous_activity_date,
                smrdous_a_crse_reuse_ind,
                smrdous_a_attr_reuse_ind,
                smrdous_g_crse_reuse_ind,
                smrdous_g_attr_reuse_ind,
                smrdous_potential_used_ind,
                smrdous_equivalent_ind,
                smrdous_catalog_ind,
                smrdous_agam_set,
                smrdous_agam_subset,
                smrdous_crn,
                smrdous_title,
                smrdous_term_code,
                smrdous_levl_code,
                smrdous_subj_code,
                smrdous_crse_numb,
                smrdous_grde_code,
                smrdous_gmod_code,
                smrdous_credit_hours,
                smrdous_credit_hours_used,
                smrdous_camp_code,
                smrdous_coll_code,
                smrdous_dept_code,
                smrdous_attr_code,
                smrdous_atts_code,
                smrdous_repeat_course_ind,
                smrdous_trad_ind,
                smrdous_tckn_seq_no,
                smrdous_trit_seq_no,
                smrdous_tram_seq_no,
                smrdous_trcr_seq_no,
                smrdous_trce_seq_no,
                smrdous_dgmr_seq_no,
                smrdous_earned_ind,
                smrdous_cnt_in_area_gpa_ind,
                smrdous_cnt_in_prog_gpa_ind,
                smrdous_grde_quality_points,
                smrdous_compl_credits,
                smrdous_compl_courses,
                smrdous_actn_code,
                smrdous_adj_credits,
                smrdous_adj_courses,
                smrdous_adj_source_ind,
                smrdous_agrl_key_rule,
                smrdous_agrl_rul_seqno,
                smrdous_agrl_rule,
                smrdous_agrl_rul_seqno_2,
                smrdous_tesc_code,
                smrdous_test_score,
                smrdous_concurrency_ind
           FROM smrdous a
          WHERE     smrdous_request_no = vnRequest
                AND smrdous_pidm = vsPidm
                AND smrdous_program = vsProg;

      INSERT INTO sWrdorq (smrdorq_pidm,
                           smrdorq_request_no,
                           smrdorq_area,
                           smrdorq_caa_seqno,
                           smrdorq_group,
                           smrdorq_program,
                           smrdorq_term_code_eff,
                           smrdorq_met_ind,
                           smrdorq_source_ind,
                           smrdorq_addl_level_ind,
                           smrdorq_excl_level_ind,
                           smrdorq_exclusions_ind,
                           smrdorq_transfer_ind,
                           smrdorq_split_course_ind,
                           smrdorq_cnt_in_gpa_ind,
                           smrdorq_activity_date,
                           smrdorq_set,
                           smrdorq_subset,
                           smrdorq_rule,
                           smrdorq_subj_code,
                           smrdorq_crse_numb_low,
                           smrdorq_crse_numb_high,
                           smrdorq_attr_code,
                           smrdorq_atts_code,
                           smrdorq_camp_code,
                           smrdorq_coll_code,
                           smrdorq_dept_code,
                           smrdorq_year_rule,
                           smrdorq_term_code_start,
                           smrdorq_term_code_end,
                           smrdorq_req_credits,
                           smrdorq_connector_req,
                           smrdorq_req_courses,
                           smrdorq_max_credits,
                           smrdorq_connector_max,
                           smrdorq_max_courses,
                           smrdorq_min_cred_crse,
                           smrdorq_max_cred_crse,
                           smrdorq_compl_credits,
                           smrdorq_compl_courses,
                           smrdorq_grde_code_min,
                           smrdorq_max_credits_transfer,
                           smrdorq_connector_transfer,
                           smrdorq_max_courses_transfer,
                           smrdorq_act_credits,
                           smrdorq_act_courses,
                           smrdorq_act_credits_transfer,
                           smrdorq_act_courses_transfer,
                           smrdorq_catalog_ind,
                           smrdorq_actn_code,
                           smrdorq_adj_credits,
                           smrdorq_adj_courses,
                           smrdorq_tesc_code,
                           smrdorq_min_value,
                           smrdorq_max_value,
                           smrdorq_concurrency_ind)
         SELECT smrdorq_pidm,
                smrdorq_request_no,
                smrdorq_area,
                smrdorq_caa_seqno,
                smrdorq_group,
                smrdorq_program,
                smrdorq_term_code_eff,
                smrdorq_met_ind,
                smrdorq_source_ind,
                smrdorq_addl_level_ind,
                smrdorq_excl_level_ind,
                smrdorq_exclusions_ind,
                smrdorq_transfer_ind,
                smrdorq_split_course_ind,
                smrdorq_cnt_in_gpa_ind,
                smrdorq_activity_date,
                smrdorq_set,
                smrdorq_subset,
                smrdorq_rule,
                smrdorq_subj_code,
                smrdorq_crse_numb_low,
                smrdorq_crse_numb_high,
                smrdorq_attr_code,
                smrdorq_atts_code,
                smrdorq_camp_code,
                smrdorq_coll_code,
                smrdorq_dept_code,
                smrdorq_year_rule,
                smrdorq_term_code_start,
                smrdorq_term_code_end,
                smrdorq_req_credits,
                smrdorq_connector_req,
                smrdorq_req_courses,
                smrdorq_max_credits,
                smrdorq_connector_max,
                smrdorq_max_courses,
                smrdorq_min_cred_crse,
                smrdorq_max_cred_crse,
                smrdorq_compl_credits,
                smrdorq_compl_courses,
                smrdorq_grde_code_min,
                smrdorq_max_credits_transfer,
                smrdorq_connector_transfer,
                smrdorq_max_courses_transfer,
                smrdorq_act_credits,
                smrdorq_act_courses,
                smrdorq_act_credits_transfer,
                smrdorq_act_courses_transfer,
                smrdorq_catalog_ind,
                smrdorq_actn_code,
                smrdorq_adj_credits,
                smrdorq_adj_courses,
                smrdorq_tesc_code,
                smrdorq_min_value,
                smrdorq_max_value,
                smrdorq_concurrency_ind
           FROM smrdorq a
          WHERE     smrdorq_request_no = vnRequest
                AND smrdorq_pidm = vsPidm
                AND smrdorq_program = vsProg;

      INSERT INTO swrsemf (smrdorq_area,
                           smrdorq_subj_code,
                           smrdorq_crse_numb_low,
                           smrdous_credit_hours,
                           smrdous_grde_code,
                           smrdorq_rule,
                           smrdous_term_code,
                           smrdorq_met_ind,
                           smrdous_crse_source,
                           smrdous_crn,
                           smrdous_gmod_code,
                           smrdous_crse_numb,
                           smrdous_subj_code,
                           smrdorq_term_code_eff,
                           smrdous_attr_code,
                           smrdous_title)
         SELECT smrdorq_area,
                smrdorq_subj_code,
                smrdorq_crse_numb_low,
                smrdous_credit_hours,
                smrdous_grde_code,
                smrdorq_rule,
                smrdous_term_code,
                smrdorq_met_ind,
                smrdous_crse_source,
                smrdous_crn,
                smrdous_gmod_code,
                smrdous_crse_numb,
                smrdous_subj_code,
                smrdorq_term_code_eff,
                smrdous_attr_code,
                smrdous_title
           FROM sWrdorq a, sWrdous
          WHERE     smrdorq_request_no = smrdous_request_no(+)
                AND smrdorq_pidm = smrdous_pidm(+)
                AND smrdorq_area = smrdous_area(+)
                AND smrdorq_RULE = smrdous_KEY_RULE(+)
                AND smrdorq_program = vsProg
                AND smrdorq_request_no = vnRequest
                AND smrdorq_pidm = vsPidm
                AND SMRDORQ_ACT_CREDITS = 0
         UNION ALL
         SELECT smrdorq_area,
                smrdorq_subj_code,
                smrdorq_crse_numb_low,
                smrdous_credit_hours,
                smrdous_grde_code,
                smrdorq_rule,
                smrdous_term_code,
                smrdorq_met_ind,
                smrdous_crse_source,
                smrdous_crn,
                smrdous_gmod_code,
                smrdous_crse_numb,
                smrdous_subj_code,
                smrdorq_term_code_eff,
                smrdous_attr_code,
                smrdous_title
           FROM sWrdorq, sWrdous
          WHERE     smrdorq_request_no = smrdous_request_no
                AND smrdorq_pidm = smrdous_pidm
                AND smrdorq_area = smrdous_area
                AND smrdorq_program = vsProg
                AND smrdorq_RULE = smrdous_KEY_RULE
                AND smrdorq_request_no = vnRequest
                AND smrdorq_pidm = vsPidm
                AND smrdorq_RULE IS NOT NULL;

      COMMIT;
   END cursosUsados;

   -- Cursos no usados
   PROCEDURE cursosNoUsados
   IS
      CURSOR cuLCnull
      IS
         SELECT l.shrtckl_levl_code AS levlCode,
                g.shrtckg_gmod_code AS gmodCode,
                g.shrtckg_credit_hours AS credHour,
                g.shrtckg_grde_code_final AS grdeCode,
                n.shrtckn_seq_no AS tcknSeqn,
                n.shrtckn_crn AS tcknCrnn,
                n.shrtckn_term_code AS termCode,
                n.shrtckn_pidm AS tcknPidm
           FROM shrtckn n, shrtckg g, shrtckl l
          WHERE     g.shrtckg_pidm = n.shrtckn_pidm
                AND g.shrtckg_term_code = n.shrtckn_term_code
                AND g.shrtckg_tckn_seq_no = n.shrtckn_seq_no
                AND g.shrtckg_seq_no =
                       (SELECT MAX (g1.shrtckg_seq_no)
                          FROM shrtckg g1
                         WHERE g1.shrtckg_pidm = g.shrtckg_pidm
                               AND g1.shrtckg_term_code = g.shrtckg_term_code
                               AND g1.shrtckg_tckn_seq_no =
                                      g.shrtckg_tckn_seq_no)
                AND l.shrtckl_pidm = n.shrtckn_pidm
                AND l.shrtckl_term_code = n.shrtckn_term_code
                AND l.shrtckl_tckn_seq_no = n.shrtckn_seq_no
                AND n.shrtckn_pidm = vsPidm
                AND ( (n.shrtckn_seq_no,
                       n.shrtckn_crn,
                       n.shrtckn_term_code,
                       n.shrtckn_pidm) IN
                        (SELECT smrdocn_tckn_seq_no,
                                smrdocn_crn,
                                smrdocn_term_code,
                                smrdocn_pidm
                           FROM swrdocn
                          WHERE (   smrdocn_levl_code IS NULL
                                 OR smrdocn_gmod_code IS NULL
                                 OR smrdocn_grde_code IS NULL
                                 OR smrdocn_credit_hours IS NULL))
                     OR (EXISTS
                            (SELECT NULL
                               FROM swrdocn
                              WHERE smrdocn_tckn_seq_no = shrtckn_seq_no
                                    AND smrdocn_crn = n.shrtckn_crn
                                    AND smrdocn_term_code =
                                           n.shrtckn_term_code
                                    AND smrdocn_pidm = n.shrtckn_pidm
                                    AND smrdocn_grde_code <>
                                           g.shrtckg_grde_code_final)));
   BEGIN
      INSERT INTO swrdocn (smrdocn_pidm,
                           smrdocn_request_no,
                           smrdocn_term_code,
                           smrdocn_crn,
                           smrdocn_subj_code,
                           smrdocn_crse_numb,
                           smrdocn_program,
                           smrdocn_activity_date,
                           smrdocn_crse_title,
                           smrdocn_crse_source,
                           smrdocn_levl_code,
                           smrdocn_grde_code,
                           smrdocn_gmod_code,
                           smrdocn_credit_hours,
                           smrdocn_credit_hours_avail,
                           smrdocn_camp_code,
                           smrdocn_coll_code,
                           smrdocn_dept_code,
                           smrdocn_trad_ind,
                           smrdocn_repeat_course_ind,
                           smrdocn_tckn_seq_no,
                           smrdocn_trit_seq_no,
                           smrdocn_tram_seq_no,
                           smrdocn_trcr_seq_no,
                           smrdocn_trce_seq_no,
                           smrdocn_dgmr_seq_no,
                           smrdocn_concurrency_ind)
         SELECT smrdocn_pidm,
                smrdocn_request_no,
                smrdocn_term_code,
                smrdocn_crn,
                smrdocn_subj_code,
                smrdocn_crse_numb,
                smrdocn_program,
                smrdocn_activity_date,
                smrdocn_crse_title,
                smrdocn_crse_source,
                smrdocn_levl_code,
                smrdocn_grde_code,
                smrdocn_gmod_code,
                smrdocn_credit_hours,
                smrdocn_credit_hours_avail,
                smrdocn_camp_code,
                smrdocn_coll_code,
                smrdocn_dept_code,
                smrdocn_trad_ind,
                smrdocn_repeat_course_ind,
                smrdocn_tckn_seq_no,
                smrdocn_trit_seq_no,
                smrdocn_tram_seq_no,
                smrdocn_trcr_seq_no,
                smrdocn_trce_seq_no,
                smrdocn_dgmr_seq_no,
                smrdocn_concurrency_ind
           FROM smrdocn b
          WHERE b.smrdocn_request_no = vnRequest
                AND EXISTS
                       (SELECT NULL
                          FROM shrtckn
                         WHERE     shrtckn_pidm = b.smrdocn_pidm
                               AND shrtckn_subj_code = b.smrdocn_subj_code
                               AND shrtckn_crse_numb = b.smrdocn_crse_numb)
                AND NOT EXISTS
                           (SELECT NULL
                              FROM sWrdous
                             WHERE smrdous_subj_code = b.smrdocn_subj_code
                                   AND smrdous_crse_numb =
                                          b.smrdocn_crse_numb
                                   AND smrdous_camp_code <>
                                          b.smrdocn_camp_code)
                AND b.smrdocn_program = vsProg
                AND b.smrdocn_pidm = vsPidm;


      --actualizando valores nulos
      FOR regLcn IN cuLCnull
      LOOP
         UPDATE sWrdocn
            SET smrdocn_levl_code = regLcn.levlCode,
                smrdocn_gmod_code = regLcn.gmodCode,
                smrdocn_grde_code = regLcn.grdeCode,
                smrdocn_credit_hours = regLcn.credHour,
                smrdocn_credit_hours_avail = regLcn.credHour
          WHERE     smrdocn_tckn_seq_no = regLcn.tcknSeqn
                AND smrdocn_crn = regLcn.tcknCrnn
                AND smrdocn_term_code = regLcn.termCode
                AND smrdocn_pidm = regLcn.tcknPidm;
      END LOOP;
   END cursosNoUsados;


   --informacin de cursos no usados
   PROCEDURE datosNoUsados (psSubj     VARCHAR2 DEFAULT NULL,
                            psCrse     VARCHAR2 DEFAULT NULL,
                            psRegla    VARCHAR2 DEFAULT NULL,
                            psArea     VARCHAR2 DEFAULT NULL)
   IS
   BEGIN

--    if psArea = 'EN1004' then
--htp.p('psSubj='||psSubj||'<br>');
--htp.p('psCrse='||psCrse||'<br>');
--htp.p('psRegla='||psRegla||'<br>');
--htp.p('psArea='||psArea||'<br>');
--htp.p('vsGradCodeNoUsado='||vsGradCodeNoUsado||'<br>');
--htp.p('vsGmodCodeNoUsado='||vsGmodCodeNoUsado||'<br>');
--htp.p('vsTermCodeNoUsado='||vsTermCodeNoUsado||'<br><br>');
--end if;
      select smrdocn_grde_code, smrdocn_gmod_code, smrdocn_term_code
        into vsGradCodeNoUsado, vsGmodCodeNoUsado, vsTermCodeNoUsado
        from swrdocn
       where (
                 (
                      psSubj||psCrse    is not null
                  and smrdocn_crse_numb  = psCrse
                  and smrdocn_subj_code  = psSubj
                 )
              or (
                      psSubj||psCrse is null
                  and exists (select null
                                from smrarul a
                               where a.smrarul_term_code_eff = (select max (b.smrarul_term_code_eff)
                                                                  from smrarul b
                                                                 where b.smrarul_area     = a.smrarul_area
                                                                   and b.smrarul_key_rule = a.smrarul_key_rule
                                                               )
                                 and smrarul_crse_numb_low   = substr(smrdocn_crse_numb,1,4)
                                 and smrarul_subj_code       = smrdocn_subj_code
                                 and a.smrarul_area          = psArea
                                 and a.smrarul_key_rule      = psRegla
                             )
                 )
             );



   exception
      when no_data_found
      then
         null;
   end datosNoUsados;

   --inserta historia
   --insertHistoria
   PROCEDURE insertHistoria (pnPidm NUMBER, psLevl VARCHAR2)
   IS
   BEGIN
      INSERT INTO swrhiac (swrhiac_pidm,
                           swrhiac_term_code,
                           swrhiac_levl_code,
                           swrhiac_subj,
                           swrhiac_crse,
                           swrhiac_crse_title,
                           swrhiac_grade_mod,
                           swrhiac_calif,
                           swrhiac_quality_points,
                           swrhiac_credit_hours,
                           swrhiac_passed_ind,
                           swrhiac_gpa_ind)
         SELECT swvhiac_pidm,
                swvhiac_term_code,
                swvhiac_levl_code,
                swvhiac_subj,
                swvhiac_crse,
                swvhiac_crse_title,
                swvhiac_grade_mod,
                swvhiac_calif,
                swvhiac_quality_points,
                swvhiac_credit_hours,
                swvhiac_passed_ind,
                swvhiac_gpa_ind
           FROM swvhiac
          WHERE swvhiac_levl_code = psLevl AND swvhiac_pidm = pnPidm;

      COMMIT;

      SELECT TRUNC (SUM (swrhiac_quality_points) / COUNT (cn1), cn2)
        INTO vnPromedioArit
        FROM swrhiac
       WHERE     swrhiac_credit_hours > cn0
             AND swrhiac_passed_ind = csY
             AND swrhiac_pidm = pnPidm;
   END insertHistoria;
BEGIN
   IF psSiu IS NULL
   THEN
      IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;
   ELSE
      IF NOT twbkwbis.f_validuser (global_Pidm)
      THEN
         RETURN;
      END IF;
   END IF;

   --muestra la informacin del curso en la misma pagina del reporte
   IF psAccion = 'D'
   THEN
      datosCurso;
      RETURN;
   ELSIF psAccion = 'S'
   THEN
      seriacion;
      RETURN;
   END IF;

   --son buscadas los valores de las cookies para asignar los valores del filtro del query.
   vsCamp := PK_OBJHTML.getValueCookie ('psUnive');
   vsProg := PK_OBJHTML.getValueCookie ('psProg');
   vsID := PK_OBJHTML.getValueCookie ('psExped');
   vsPidm := f_get_pidm (vsID);
   vsNombre := getNombre (vsID);

   IF psSiu IS NOT NULL
   THEN
      vsCamp := csCampCode;
   END IF;

--              vsProg    := 'LC-ENFE-10';
--              vsPidm    := f_get_pidm('00019288');

   --obtiene el maximo valor de ejecucin del CAPP

   getMaxRequest (vsPidm, vsProg);

   getSGBSTDN ();

   --Son registrados los cursos usados
   cursosUsados ();

   --Son registrados los cursos NO usados
   cursosNoUsados ();
   insertHistoria (vsPidm, vsLevlCode);

   --RETURN;



   FOR regDetalle IN cuDetalle
   LOOP
      IF vnExists = 0
      THEN
         PK_sisRepImp.
          P_EncabezadoDeReporte (
            psReclDesc,
            vnColumnas,
            tabColumna,
            vgsInicoPag,
            psSubtitulo     =>   vsTermCode
                              || ' '
                              || pk_catalogo.periodo (vsTermCode),
            psUsuario       => pk_login.vgsUSR,
            psUniversidad   => vsCamp,
            psSinPiePag     => 'A',
            psSinLogo       => 'A',
            psTituloSinFr   => 'COLUMNAS',
            psDetalle       => cabeceroGral ()
                              || cabeceroDet (regDetalle.area,
                                              regDetalle.areaDesc));
         vgsInicoPag := 'SALTO';
      END IF;

      IF vsAreaDesc <> regDetalle.areaDesc
      THEN
         HTP.
          p (
            '<tr><td colspan="' || vnColumnas
            || '" style="border-left:solid #ffffff 1.0pt; border-right:solid #ffffff 1.0pt;"></td></tr>'
            || cabeceroDet (regDetalle.area, regDetalle.areaDesc));
      END IF;

      vsImgCorrecto :=
            '<img width="13" height="13" border="0" src="/imagenes/'
         || regDetalle.stat
         || '.jpg"/>';

      vsGradCodeNoUsado := NULL;
      vsGmodCodeNoUsado := NULL;
      vsTermCodeNoUsado := NULL;

      IF regDetalle.stat = csSincursar THEN
         datosNoUsados (regDetalle.subjCode,
                        regDetalle.crseCode,
                        regDetalle.Regla,
                        regDetalle.Area
                      );

         IF vsTermCodeNoUsado IS NOT NULL THEN
            regDetalle.term := vsTermCodeNoUsado;
         END IF;

         IF vsGradCodeNoUsado IS NOT NULL THEN
            regDetalle.grde := vsGradCodeNoUsado;
         END IF;

         IF vsGmodCodeNoUsado IS NOT NULL THEN
            regDetalle.gmod := vsGmodCodeNoUsado;
         END IF;
      END IF;

      IF vnElectivo > 0
      THEN
         HTP.p ('<tr>' || '<td>');
      ELSE
         HTP.p ('<tr>' || '<td style="border-right:none;">');
      END IF;

      IF regDetalle.subjCode||regDetalle.crseCode IS NULL THEN
          HTP.p ('<a href="javascript:fLovMate('
             || ''''
             || NVL (regDetalle.crnn || '''', '''''')
             || ','''
             || regDetalle.term
             || ''','''
             || regDetalle.clave
             || ''','''
             || regDetalle.TITL
             || ''')">'
             || regDetalle.TITL
             --||regDetalle.TITL||'-'||regDetalle.subjCode||'-'||regDetalle.crseCode||'-'||regDetalle.Regla||'-'||regDetalle.Area
             || '</a></td>');
      ELSE
      HTP.p ('<a href="javascript:fLovMate('
             || ''''
             || NVL (regDetalle.crnn || '''', '''''')
             || ','''
             || regDetalle.term
             || ''','''
             || regDetalle.subjCode
             || regDetalle.crseCode
             || ''','''
             || regDetalle.TITL
             || ''')">'
             || regDetalle.TITL
             --||regDetalle.TITL||'-'||regDetalle.subjCode||'-'||regDetalle.crseCode||'-'||regDetalle.Regla||'-'||regDetalle.Area
             || '</a></td>');
      END IF;



      IF vnElectivo > 0
      THEN
         HTP.p ('<td align="center">' || regDetalle.Atrt || '</td>');
      ELSE
         HTP.p ('<td align="center" style="border-left:none;"></td>');
      END IF;

      vgCalificacion := null;

      IF regDetalle.stat = csAcred THEN
          vgCalificacion := regDetalle.grde;

      ELSE
          IF   regDetalle.grde <> 'AC' THEN
            vgCalificacion := regDetalle.grde;
          END IF;
          --regDetalle.term := null;
          --regDetalle.gmod := null;
      END IF;


      IF regDetalle.term IS NULL THEN
        regDetalle.cred := '';
      END IF;

      HTP.p (
            '<td align="center">'
         || '<a href="javascript:preRequisitos('''
         || regDetalle.TITL
         || ''','''
         || regDetalle.termCode
         || ''','''
         || regDetalle.subjCode
         || ''','''
         || regDetalle.crseCode
         || ''')">'
         || regDetalle.Serc
         || '</a></td>'
         || '<td align="center">'
         || regDetalle.cred
         || '</td>'
         || '<td align="center">'
         || regDetalle.term
         || '</td>'
         || '<td align="center">'
         || vgCalificacion
         || '</td>'
         || '<td align="center">'
         || regDetalle.gmod
         || '</td>'
         || '<td align="center">'
         || vsImgCorrecto
         || '</td>'
         || '</tr>');

      vsArea := regDetalle.area;
      vsAreaDesc := regDetalle.areaDesc;
      vnExists := 1;
   END LOOP;

   IF vnExists = 0
   THEN
      HTP.
       p (
            '<tr><th colspan="'
         || vnColumnas
         || '"><font color="#ff0000">'
         || PK_sisRepImp.vgsResultado
         || '</font></th></tr>');
   ELSE
      HTP.
       p (
         '</table><br/>
         <table border="1" cellpadding="0" cellspacing="0" style="border:solid #DDDDDD 1.0pt;" width="47%">
         <tr bgcolor="#efefef">
             <th colspan="3" style="border:solid #DDDDDD 1.0pt;">REQUISITOS CURRICULARES</td></tr>
         <tr bgcolor="#efefef">
              <th width="27%" style="border:solid #DDDDDD 1.0pt;"><b>Requisito           </td>
              <th width="10%" style="border:solid #DDDDDD 1.0pt;"><b>Estado              </td>
              <th width="10%" style="border:solid #DDDDDD 1.0pt;"><b>Acreditaci&oacuten </td></tr>
         ');


      FOR regNoc IN cuNoCapp
      LOOP
         HTP.
          p (
            '<tr>'
            || '<td align="left"   valign="top" style="border:solid #DDDDDD 1.0pt;" >'
            || regNoc.ncrqcode
            || '</td>'
            || '<td align="center" valign="top" style="border:solid #DDDDDD 1.0pt;" >'
            || regNoc.ncstcode
            || '</td>'
            || '<td align="center" valign="top" style="border:solid #DDDDDD 1.0pt;" >'
            || regNoc.ncstdate
            || '</td>'
            || '</tr>');
      END LOOP;

      HTP.
       p (
         '</table>
          <table border="0" cellpadding="0" cellspacing="0" width="50%" >
         <tr><td>
         <div id="divDatoMateria" style="position:absolute;z-index:5;visibility:hidden"></div>
         </td></tr>
         </table>
         ');

      --cdigo java script
      js;

      -- La variable es una bandera que al tener el valor "imprime" no colocara el salto de pagina para impresion
      PK_sisRepImp.vgsSaltoImp := 'Imprime';

      -- Es omitido el encabezado del reporte pero se agrega el salto de pagina
      PK_sisRepImp.P_EncabezadoDeReporte (psReclDesc,
                                          vnColumnas,
                                          tabColumna,
                                          'PIE',
                                          psSinPiePag   => 'A');
   END IF;

   HTP.p ('</body></html>');

   DELETE SWRDOUS;

   DELETE SWRDORQ;

   DELETE SWRSEMF;

   DELETE SWRDOCN;

   DELETE SWRHIAC;

   COMMIT;
EXCEPTION
   WHEN OTHERS
   THEN
      HTP.P (SQLERRM);

      DELETE SWRDOUS;

      DELETE SWRDORQ;

      DELETE SWRSEMF;

      DELETE SWRDOCN;

      DELETE SWRHIAC;

      COMMIT;
END PWRASAG;
/


DROP PUBLIC SYNONYM PWRASAG;

CREATE PUBLIC SYNONYM PWRASAG FOR BANINST1.PWRASAG;


GRANT EXECUTE ON BANINST1.PWRASAG TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRASAL;

CREATE OR REPLACE PROCEDURE BANINST1.PWRASAL(psReclDesc VARCHAR2) IS
/**************************************************************
           tarea:  procedimiento para el reporte de asignacion de salas
         mdulo:  reportes -asignacion academica
           autor:
           fecha:
    ------------------------------------
    Modificacion :   chg-01  16/jul/2013
          cambio :   se agregan columna(escuela) y se cambia orden segregando veticalmente los horarios.
           autor :   RRA - Roman ruiz

**************************************************************/
  vnExists    INTEGER                := 0;
  vnColumnas  INTEGER                := 21;
  tabColumna  Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vsCampCode  VARCHAR2(6)            := NULL;
  vsTermCode  VARCHAR2(1000)         := NULL;
  vsTerm      VARCHAR2(8)            := NULL;
  vsCollCode  VARCHAR2(3)            := NULL;
  vsSubjCode  VARCHAR2(4)            := NULL;
  vsSstsCode  VARCHAR2(2)            := NULL;
  vsPtrmCode  VARCHAR2(1000)         := NULL;
  vsBldgCode  VARCHAR2(50)           := NULL;
  vsStarDate  VARCHAR2(50)           := NULL;
  vsEnddDate  VARCHAR2(50)           := NULL;
  vsFstpCode  VARCHAR2(50)           := NULL;
  vsInicoPag  VARCHAR2(10)           := NULL;
  vsXlstType  VARCHAR2(2)            := NULL;
  vsFattCode  VARCHAR2(10)           := NULL;
  vsSeccion   VARCHAR2(3)            := NULL;
  vsExp       VARCHAR2(15)           := NULL;
  vsBecadef   VARCHAR2(1)            :=NULL;
  vnIngresado VARCHAR2(300);
  vnIngresadoDef VARCHAR2(300);
  global_pidm SPRIDEN.SPRIDEN_PIDM%TYPE;


  csAC      CONSTANT VARCHAR2(2)  := 'AC';
  csEsp     CONSTANT VARCHAR2(1)  := ' ';
  csM       CONSTANT VARCHAR2(1)  := 'M';
  csT       CONSTANT VARCHAR2(1)  := 'T';
  csW       CONSTANT VARCHAR2(1)  := 'W';
  csR       CONSTANT VARCHAR2(1)  := 'R';
  csF       CONSTANT VARCHAR2(1)  := 'F';
  csS       CONSTANT VARCHAR2(1)  := 'S';
  csP       CONSTANT VARCHAR2(1)  := 'P';
  csLu      CONSTANT VARCHAR2(2)  := 'Lu';
  csMa      CONSTANT VARCHAR2(2)  := 'Ma';
  csMi      CONSTANT VARCHAR2(2)  := 'Mi';
  csJu      CONSTANT VARCHAR2(2)  := 'Ju';
  csVi      CONSTANT VARCHAR2(2)  := 'Vi';
  csSa      CONSTANT VARCHAR2(2)  := 'Sa';
  cs2p      CONSTANT VARCHAR2(1)  := ':';
  cs1       CONSTANT VARCHAR2(1)  := '1';
  cs00      CONSTANT VARCHAR2(2)  := '00';
  csAst     CONSTANT VARCHAR2(1)  := '*';
  csSlh     CONSTANT VARCHAR2(1)  := '/';
  csEne     CONSTANT VARCHAR2(1)  := '';
  csTil     CONSTANT VARCHAR2(8)  := '&ntilde;';
  csMas     CONSTANT VARCHAR2(6)  := 'Master';
  csSml     CONSTANT VARCHAR2(10) := 'Simultneo';
  csInd     CONSTANT VARCHAR2(13) := 'Independiente';
  csPeriodo CONSTANT VARCHAR2(8)  := 'Periodo ';

  -- chg 01
  cursor curSepararHoras is
         select * from FWRHORS;

  CURSOR cuReporte_respaldo IS
         SELECT SWRPGAC_TERM_CODE        AS termCode,
                SWRPGAC_CAMP_CODE        AS campCode,
                SWRPGAC_CRN              AS sectCrnn,
               /* Pk_Catalogo.STATUS_1(SWRPGAC_SSTS_CODE) AS sstsCode,
                Pk_Catalogo.SCHDTYPE(SWRPGAC_SCHD_CODE) AS schdCode,
                Pk_Catalogo.INSTMETH(SWRPGAC_INSM_CODE) AS insmCode,
                SWRPGAC_PTRM_CODE        AS ptrmCode,*/
                SWRPGAC_SUBJ_CODE        AS subjCode,
                SWRPGAC_CRSE_NUMB        AS crseNumb,
                SWRPGAC_COLL_CODE         AS escuela,
                SWRPGAC_TITLE            AS crseTitl,
               /* SWRPGAC_CONT_HR_LOW      AS contHrLw,
                SWRPGAC_CREDIT_HR_LOW    AS credHrLw,*/
                SWRPGAC_SEQ_NUMB         AS seqqNumb,
                SWRPGAC_MAX_ENRL         AS maxxEnrl,
               /* SWRPGAC_ENRL             AS sectEnrl,
                Pk_Catalogo.COLEGIO(SWRPGAC_COLL_CODE) AS collCode,*/
                FWRHORS_HRS_WEEK         AS hrssWeek,
                FWRHORS_MON_DAY          AS meetMonn,
                FWRHORS_TUE_DAY          AS meetTuee,
                FWRHORS_WED_DAY          AS meetWedd,
                FWRHORS_THU_DAY          AS meetThuu,
                FWRHORS_FRI_DAY          AS meetFrii,
                FWRHORS_SAT_DAY          AS meetSatt,
                FWRHORS_BEGIN_TIME       AS begnTime,
                FWRHORS_END_TIME         AS enddTime,
                FWRHORS_BLDG_CODE        AS bldgCode,
                FWRHORS_ROOM_CODE        AS roomCode,
                FWRHORS_PERCENT_RESPONSE AS prcnResp,
                Pk_Catalogo.Tipo(FWRHORS_FSTP_CODE) AS fstpCode,
                SWRPGAC_SESS_CODE        AS meetCatg,
                Pk_Catalogo.Categoria(FWRHOR_FCTG_CODE) AS fctgCode,
                SPRIDEN_ID               AS idenIDdd,
                REPLACE(REPLACE(SPRIDEN_LAST_NAME||csEsp||
                SPRIDEN_FIRST_NAME||csEsp||SPRIDEN_MI,csEne,csTil),csAst,csEsp) AS idenName,
                FWRXLST_XLST_GROUP                                              AS xlstGrup,
                DECODE(FWRXLST_TYPE ,csM,csMas,csS,csSml,csInd)                 AS xlstType
           FROM SPRIDEN,
                FWRHORS,
                SWRPGAC,
                FWRXLST
          WHERE FWRHORS_PIDM        = SPRIDEN_PIDM
            AND SPRIDEN_CHANGE_IND IS NULL
            AND SWRPGAC_TERM_CODE   = FWRHORS_TERM_CODE(+)
            AND SWRPGAC_CRN         = FWRHORS_CRN(+)
            AND SWRPGAC_TERM_CODE   = FWRXLST_TERM_CODE(+)
            AND SWRPGAC_CRN         = FWRXLST_CRN(+)
            --AND (FWRXLST_TYPE       = vsXlstType OR vsXlstType IS NULL)
            --AND (FWRHORS_FSTP_CODE  = vsFstpCode OR vsFstpCode IS NULL)
            /*AND (
                   (vsFattCode IS NULL)
                 OR
                   (
                       (vsFattCode IS NOT NULL)
                    AND
                       EXISTS (SELECT NULL
                                 FROM SIRATTR A
                                WHERE A.SIRATTR_TERM_CODE_EFF = (SELECT MAX(B.SIRATTR_TERM_CODE_EFF)
                                                                   FROM SIRATTR B
                                                                  WHERE B.SIRATTR_PIDM = SPRIDEN_PIDM
                                                                )
                                  AND A.SIRATTR_PIDM          = SPRIDEN_PIDM
                                  AND A.SIRATTR_FATT_CODE     = vsFattCode
                              )
                   )
                )*/
--          ORDER BY SWRPGAC_TERM_CODE DESC, SWRPGAC_COLL_CODE,FWRXLST_XLST_GROUP,SWRPGAC_SUBJ_CODE;
          ORDER BY SWRPGAC_CRN, FWRHORS_MON_DAY, FWRHORS_TUE_DAY, FWRHORS_WED_DAY, FWRHORS_THU_DAY, FWRHORS_FRI_DAY, FWRHORS_SAT_DAY, FWRHORS_BEGIN_TIME, FWRHORS_END_TIME;


  CURSOR cuReporte IS
         SELECT SWRPGAC_TERM_CODE        AS termCode,
                SWRPGAC_CAMP_CODE        AS campCode,
                SWRPGAC_CRN              AS sectCrnn,
                SWRPGAC_SUBJ_CODE        AS subjCode,
                SWRPGAC_CRSE_NUMB        AS crseNumb,
                SWRPGAC_COLL_CODE         AS escuela,
                SWRPGAC_TITLE            AS crseTitl,
                SWRPGAC_SEQ_NUMB         AS seqqNumb,
                SWRPGAC_MAX_ENRL         AS maxxEnrl,
                FWRHRSS_HRS_WEEK         AS hrssWeek,
                FWRHRSS_MON_DAY          AS meetMonn,
                FWRHRSS_TUE_DAY          AS meetTuee,
                FWRHRSS_WED_DAY          AS meetWedd,
                FWRHRSS_THU_DAY          AS meetThuu,
                FWRHRSS_FRI_DAY          AS meetFrii,
                FWRHRSS_SAT_DAY          AS meetSatt,
                FWRHRSS_BEGIN_TIME       AS begnTime,
                FWRHRSS_END_TIME         AS enddTime,
                FWRHRSS_BLDG_CODE        AS bldgCode,
                FWRHRSS_ROOM_CODE        AS roomCode,
                FWRHRSS_PERCENT_RESPONSE AS prcnResp,
                Pk_Catalogo.Tipo(FWRHRSS_FSTP_CODE) AS fstpCode,
                SWRPGAC_SESS_CODE        AS meetCatg,
                Pk_Catalogo.Categoria(FWRHRSS_FCTG_CODE) AS fctgCode,
                SPRIDEN_ID               AS idenIDdd,
                REPLACE(REPLACE(SPRIDEN_LAST_NAME||csEsp||
                SPRIDEN_FIRST_NAME||csEsp||SPRIDEN_MI,csEne,csTil),csAst,csEsp) AS idenName,
                FWRXLST_XLST_GROUP                                              AS xlstGrup,
                DECODE(FWRXLST_TYPE ,csM,csMas,csS,csSml,csInd)                 AS xlstType
           FROM SPRIDEN,
                FWRHRSS,
                SWRPGAC,
                FWRXLST
          WHERE FWRHRSS_PIDM      = SPRIDEN_PIDM
            AND SPRIDEN_CHANGE_IND IS NULL
            AND SWRPGAC_TERM_CODE   = FWRHRSS_TERM_CODE(+)
            AND SWRPGAC_CRN         = FWRHRSS_CRN(+)
            AND SWRPGAC_TERM_CODE   = FWRXLST_TERM_CODE(+)
            AND SWRPGAC_CRN         = FWRXLST_CRN(+)
          ORDER BY SWRPGAC_CRN, FWRHRSS_MON_DAY, FWRHRSS_TUE_DAY, FWRHRSS_WED_DAY, FWRHRSS_THU_DAY, FWRHRSS_FRI_DAY, FWRHRSS_SAT_DAY, FWRHRSS_BEGIN_TIME, FWRHRSS_END_TIME;


     cursor cuIngresado(psTerm varchar2,psCrn varchar2) is select SSRSRDF_RDEF_CODE as SSRSRDF_CODE, STVRDEF_DESC
                 from SSRSRDF,STVRDEF
                    where
                       SSRSRDF_TERM_CODE =psTerm
                  and SSRSRDF_CRN=psCrn
                  and SSRSRDF_RDEF_CODE=STVRDEF_CODE;

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.

      vsTermCode := NVL(pk_objHtml.getValueCookie('psPerio'),csSlh);
      vsCollCode := pk_objHtml.getValueCookie('psFacu');
      vsSubjCode := pk_objHtml.getValueCookie('psSubjc');
      --vsFstpCode := pk_objHtml.getValueCookie('psType');
      --vsSstsCode := pk_objHtml.getValueCookie('psStat1');
      --vsBldgCode := pk_objHtml.getValueCookie('psEdifi');
      --vsXlstType := pk_objHtml.getValueCookie('psTipol');
      --vsFattCode := pk_objHtml.getValueCookie('psAtbs');
      vsStarDate := pk_objHtml.getValueCookie('psHrDe');
      vsEnddDate := pk_objHtml.getValueCookie('psHrA');
      vsSeccion  := pk_objHtml.getValueCookie('cookSeccion');
      vsPtrmCode := NVL(pk_objHtml.getValueCookie('psPtrm'),csSlh);
      vsExp    := pk_objHTML.getValueCookie('psExped');

      global_pidm := f_get_pidm(vsExp);

      WHILE INSTR(vsTermCode, csSlh) > 0  LOOP
            vsTerm := SUBSTR(vsTermCode, 1, INSTR(vsTermCode,csSlh)-1);

            PWAISSBSECT(vsCampCode,vsTerm,vsCollCode,vsSubjCode,null,vsPtrmCode);
            vsTermCode := SUBSTR(vsTermCode, INSTR(vsTermCode,csSlh)+1);

      END LOOP ;


      INSERT INTO FWRHORS
      (FWRHORS_PIDM,       FWRHORS_TERM_CODE, FWRHORS_CRN,       FWRHORS_CATAGORY,
       FWRHORS_HRS_WEEK,   FWRHORS_MON_DAY,   FWRHORS_TUE_DAY,   FWRHORS_WED_DAY,
       FWRHORS_THU_DAY,    FWRHORS_FRI_DAY,   FWRHORS_SAT_DAY,   FWRHORS_BEGIN_TIME,
       FWRHORS_END_TIME,   FWRHORS_BLDG_CODE, FWRHORS_ROOM_CODE, FWRHORS_PERCENT_RESPONSE,
       FWRHORS_FSTP_CODE,  FWRHOR_FCTG_CODE
       )
      SELECT
       sirasg.asgnPidm,    sirasg.termCode,   sirasg.meetCrnn,   sirasg.meetCatg,
       sirasg.hrssWeek,    sirasg.meetMonn,   sirasg.meetTuee,   sirasg.meetWedd,
       sirasg.meetThuu,    sirasg.meetFrii,   sirasg.meetSatt,   sirasg.begnTime,
       sirasg.enddTime,    sirasg.bldgCode,   sirasg.roomCode,   sirasg.prcnResp,
       (SELECT A.SIBINST_FSTP_CODE
          FROM SIBINST A
         WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(B.SIBINST_TERM_CODE_EFF)
                                          FROM SIBINST B
                                         WHERE B.SIBINST_PIDM           = sirasg.asgnPidm
                                           AND B.SIBINST_TERM_CODE_EFF <= sirasg.termCode
                                        )
           AND A.SIBINST_FCST_CODE = csAC
           AND A.SIBINST_PIDM      = sirasg.asgnPidm
       ) fstpCode,
       (SELECT A.SIBINST_FCTG_CODE
          FROM SIBINST A
         WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(B.SIBINST_TERM_CODE_EFF)
                                          FROM SIBINST B
                                         WHERE B.SIBINST_PIDM           = sirasg.asgnPidm
                                           AND B.SIBINST_TERM_CODE_EFF <= sirasg.termCode
                                        )
           AND A.SIBINST_FCST_CODE = csAC
           AND A.SIBINST_PIDM      = sirasg.asgnPidm
       ) fctgCode
         FROM (SELECT SIRASGN_PIDM                                        asgnPidm,
                      SSRMEET_TERM_CODE                                   termCode,
                      SSRMEET_CRN                                         meetCrnn,
                      SSRMEET_CATAGORY                                    meetCatg,
                      SUM(NVL(SSRMEET_HRS_WEEK,0))                        hrssWeek,
                      DECODE(SSRMEET_MON_DAY, csM, csLu, SSRMEET_MON_DAY) meetMonn,
                      DECODE(SSRMEET_TUE_DAY, csT, csMa, SSRMEET_TUE_DAY) meetTuee,
                      DECODE(SSRMEET_WED_DAY, csW, csMi, SSRMEET_WED_DAY) meetWedd,
                      DECODE(SSRMEET_THU_DAY, csR, csJu, SSRMEET_THU_DAY) meetThuu,
                      DECODE(SSRMEET_FRI_DAY, csF, csVi, SSRMEET_FRI_DAY) meetFrii,
                      DECODE(SSRMEET_SAT_DAY, csS, csSa, SSRMEET_SAT_DAY) meetSatt,
                      SUBSTR(SSRMEET_BEGIN_TIME,1,2)||cs2p||
                      NVL(SUBSTR(SSRMEET_BEGIN_TIME,3,2),cs00)            begnTime,
                      SUBSTR(SSRMEET_END_TIME,1,2)||cs2p||
                      NVL(SUBSTR(SSRMEET_END_TIME,3,2),cs00)              enddTime,
                      SSRMEET_BLDG_CODE                                   bldgCode,
                      SSRMEET_ROOM_CODE                                   roomCode,
                      SIRASGN_PERCENT_RESPONSE                            prcnResp
                 FROM SSRMEET,
                          SIRASGN
                WHERE SSRMEET_TERM_CODE = SIRASGN_TERM_CODE(+)
                  AND SSRMEET_CRN               = SIRASGN_CRN(+)
                  AND SSRMEET_CATAGORY     = SIRASGN_CATEGORY(+)
                  --AND (SSRMEET_BLDG_CODE = vsBldgCode OR vsBldgCode IS NULL)
                  AND (SIRASGN_PIDM      = global_pidm OR global_pidm IS NULL)
                  --and SIRASGN_PIDM=global_pidm
                  AND nvl(SIRASGN_PRIMARY_IND,'N') ='Y'
                  AND (SSRMEET_CRN,SSRMEET_TERM_CODE) IN (SELECT SWRPGAC_CRN,SWRPGAC_TERM_CODE
                                                            FROM SWRPGAC
                                                         )
                 GROUP BY SIRASGN_PIDM,
                          SSRMEET_TERM_CODE,
                          SSRMEET_CRN,
                          SSRMEET_CATAGORY,
                          DECODE(SSRMEET_MON_DAY, csM, csLu, SSRMEET_MON_DAY),
                          DECODE(SSRMEET_TUE_DAY, csT, csMa, SSRMEET_TUE_DAY),
                          DECODE(SSRMEET_WED_DAY, csW, csMi, SSRMEET_WED_DAY),
                          DECODE(SSRMEET_THU_DAY, csR, csJu, SSRMEET_THU_DAY),
                          DECODE(SSRMEET_FRI_DAY, csF, csVi, SSRMEET_FRI_DAY),
                          DECODE(SSRMEET_SAT_DAY, csS, csSa, SSRMEET_SAT_DAY),
                          SUBSTR(SSRMEET_BEGIN_TIME,1,2)||cs2p||
                          NVL(SUBSTR(SSRMEET_BEGIN_TIME,3,2),cs00),
                          SUBSTR(SSRMEET_END_TIME,1,2)||cs2p||
                          NVL(SUBSTR(SSRMEET_END_TIME,3,2),cs00),
                          SSRMEET_BLDG_CODE,
                          SSRMEET_ROOM_CODE,
                          SIRASGN_PERCENT_RESPONSE
              ) sirasg
        WHERE (sirasg.begnTime >= vsStarDate OR vsStarDate IS NULL)
          AND (sirasg.enddTime <= vsEnddDate OR vsEnddDate IS NULL);


      -- chg-01 start
      -- segregar horarios DE FWRHORS y dejar en FWRHRSS

      FOR regLine IN curSepararHoras LOOP
         if regLine.FWRHORS_MON_DAY is not null then
            insert into FWRHRSS values (regLine.FWRHORS_PIDM, regLine.FWRHORS_TERM_CODE, regLine.FWRHORS_CRN,
                                          regLine.FWRHORS_CATAGORY, regLine.FWRHORS_HRS_WEEK ,
                                          regLine.FWRHORS_MON_DAY, null, null, null, null, null,
                                          regLine.FWRHORS_BEGIN_TIME, regLine.FWRHORS_END_TIME, regLine.FWRHORS_BLDG_CODE,
                                          regLine.FWRHORS_ROOM_CODE, regLine.FWRHORS_PERCENT_RESPONSE, regLine.FWRHORS_START_DATE,
                                          regLine.FWRHORS_END_DATE, regLine.FWRHORS_FSTP_CODE, regLine.FWRHOR_FCTG_CODE, '0');
         end if;

         if regLine.FWRHORS_TUE_DAY is not null then
            insert into FWRHRSS values (regLine.FWRHORS_PIDM, regLine.FWRHORS_TERM_CODE, regLine.FWRHORS_CRN,
                                          regLine.FWRHORS_CATAGORY, regLine.FWRHORS_HRS_WEEK ,
                                          null, regLine.FWRHORS_TUE_DAY, null, null, null, null,
                                          regLine.FWRHORS_BEGIN_TIME, regLine.FWRHORS_END_TIME, regLine.FWRHORS_BLDG_CODE,
                                          regLine.FWRHORS_ROOM_CODE, regLine.FWRHORS_PERCENT_RESPONSE, regLine.FWRHORS_START_DATE,
                                          regLine.FWRHORS_END_DATE, regLine.FWRHORS_FSTP_CODE, regLine.FWRHOR_FCTG_CODE, '0');
         end if;

         if regLine.FWRHORS_WED_DAY is not null then
             insert into FWRHRSS values (regLine.FWRHORS_PIDM, regLine.FWRHORS_TERM_CODE, regLine.FWRHORS_CRN,
                                          regLine.FWRHORS_CATAGORY, regLine.FWRHORS_HRS_WEEK ,
                                          null, null, regLine.FWRHORS_WED_DAY, null, null, null,
                                          regLine.FWRHORS_BEGIN_TIME, regLine.FWRHORS_END_TIME, regLine.FWRHORS_BLDG_CODE,
                                          regLine.FWRHORS_ROOM_CODE, regLine.FWRHORS_PERCENT_RESPONSE, regLine.FWRHORS_START_DATE,
                                          regLine.FWRHORS_END_DATE, regLine.FWRHORS_FSTP_CODE, regLine.FWRHOR_FCTG_CODE, '0');
         end if;

         if regLine.FWRHORS_THU_DAY is not null then
              insert into FWRHRSS values (regLine.FWRHORS_PIDM, regLine.FWRHORS_TERM_CODE, regLine.FWRHORS_CRN,
                                          regLine.FWRHORS_CATAGORY, regLine.FWRHORS_HRS_WEEK ,
                                          null, null, null, regLine.FWRHORS_THU_DAY, null, null,
                                          regLine.FWRHORS_BEGIN_TIME, regLine.FWRHORS_END_TIME, regLine.FWRHORS_BLDG_CODE,
                                          regLine.FWRHORS_ROOM_CODE, regLine.FWRHORS_PERCENT_RESPONSE, regLine.FWRHORS_START_DATE,
                                          regLine.FWRHORS_END_DATE, regLine.FWRHORS_FSTP_CODE, regLine.FWRHOR_FCTG_CODE, '0');
         end if;

         if regLine.FWRHORS_FRI_DAY is not null then
              insert into FWRHRSS values (regLine.FWRHORS_PIDM, regLine.FWRHORS_TERM_CODE, regLine.FWRHORS_CRN,
                                          regLine.FWRHORS_CATAGORY, regLine.FWRHORS_HRS_WEEK ,
                                          null, null, null, null, regLine.FWRHORS_FRI_DAY, null,
                                          regLine.FWRHORS_BEGIN_TIME, regLine.FWRHORS_END_TIME, regLine.FWRHORS_BLDG_CODE,
                                          regLine.FWRHORS_ROOM_CODE, regLine.FWRHORS_PERCENT_RESPONSE, regLine.FWRHORS_START_DATE,
                                          regLine.FWRHORS_END_DATE, regLine.FWRHORS_FSTP_CODE, regLine.FWRHOR_FCTG_CODE, '0');
         end if;

         if regLine.FWRHORS_SAT_DAY is not null then
              insert into FWRHRSS values (regLine.FWRHORS_PIDM, regLine.FWRHORS_TERM_CODE, regLine.FWRHORS_CRN,
                                          regLine.FWRHORS_CATAGORY, regLine.FWRHORS_HRS_WEEK ,
                                          null, null, null, null, null, regLine.FWRHORS_SAT_DAY,
                                          regLine.FWRHORS_BEGIN_TIME, regLine.FWRHORS_END_TIME, regLine.FWRHORS_BLDG_CODE,
                                          regLine.FWRHORS_ROOM_CODE, regLine.FWRHORS_PERCENT_RESPONSE, regLine.FWRHORS_START_DATE,
                                          regLine.FWRHORS_END_DATE, regLine.FWRHORS_FSTP_CODE, regLine.FWRHOR_FCTG_CODE, '0');
         end if;

      end LOOP;

      -- chg-01 end

      INSERT INTO FWRXLST
      (FWRXLST_CRN,FWRXLST_TERM_CODE,FWRXLST_XLST_GROUP,FWRXLST_TYPE)
      SELECT SSRXLST_CRN,
             SSRXLST_TERM_CODE,
             SSRXLST_XLST_GROUP,
             (SELECT SWRXLST_TYPE
                FROM SWRXLST
               WHERE SWRXLST_TERM_CODE  = SSRXLST_TERM_CODE
                 AND SWRXLST_CRN        = SSRXLST_CRN
                 AND SWRXLST_XLST_GROUP = SSRXLST_XLST_GROUP
             )
        FROM SSRXLST
       WHERE (SSRXLST_CRN,SSRXLST_TERM_CODE) IN (SELECT SWRPGAC_CRN,SWRPGAC_TERM_CODE
                                                   FROM SWRPGAC
                                                 );

      vsCampCode := NULL;
      vsTermCode := NULL;

      -- Las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1) := 'Escuela';
      tabColumna(2) := 'NRC';
      tabColumna(3) := 'Secci&oacute;n';
      tabColumna(4) := 'Sesi&oacute;n';
      tabColumna(5) := 'Materia';
      tabColumna(6) := 'Curso';
      tabColumna(7) := 'Nombre materia';
      tabColumna(8) := 'Lista cruzada';
      tabColumna(9) := 'ID Docente Principal';
      tabColumna(10) := 'Nombre Docente';
      tabColumna(11) := csLu;
      tabColumna(12) := csMa;
      tabColumna(13) := csMi;
      tabColumna(14) := csJu;
      tabColumna(15) := csVi;
      tabColumna(16) := csSa;
      tabColumna(17) := 'Hora inicio';
      tabColumna(18) := 'Hora fin';
      tabColumna(19) := 'Cupo';
      tabColumna(20) := 'Preferencia Atributo Sal&oacute;n';
      tabColumna(21) := 'Descripci&oacute;n Preferencia';


      FOR regRep IN cuReporte LOOP
          IF (vnExists = 0 OR vsTermCode <> regRep.termCode) THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicoPag,cs1,psSubtitulo=>csPeriodo||regRep.termCode,psUsuario=>pk_login.vgsUSR,psSeccion=>vsSeccion, psSinPiePag=>csP,psSinLogo=>csP);
             vsInicoPag := 'SALTO';
          END IF;

                    vnIngresado:=null;
                    vnIngresadoDef:=null;
                 for regdet in cuIngresado(regRep.termCode,regRep.sectCrnn) loop
                        vnIngresado:=regdet.SSRSRDF_CODE||'/';
                        vnIngresadoDef:=regdet.STVRDEF_DESC||'/';
                 end loop;

                select substr(vnIngresado,1,length(vnIngresado)-1),substr(vnIngresadoDef,1,length(vnIngresadoDef)-1)
                  into vnIngresado,vnIngresadoDef
                 from dual;

          htp.p(
          '<tr>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.escuela||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.sectCrnn||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.seqqNumb||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.meetCatg||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.subjCode||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.crseNumb||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.crseTitl||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.xlstGrup||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.idenIDdd||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.idenName||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.meetMonn||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.meetTuee||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.meetWedd||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.meetThuu||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.meetFrii||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.meetSatt||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.begnTime||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.enddTime||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.maxxEnrl||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||vnIngresado||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||vnIngresadoDef||'</td>
          </tr>'
          );

          vnExists   := 1;
          vsCampCode := regRep.campCode;
          vsTermCode := regRep.termCode;

      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR, psSeccion=>vsSeccion,psSinPiePag=>'P',psSinLogo=>'P');
      END IF;

      htp.p('</table><br></body></html>');

      ROLLBACK;

 -- EXCEPTION
   --   WHEN OTHERS THEN
 --          htp.p(SQLERRM);
  END PWRASAL;
/


DROP PUBLIC SYNONYM PWRASAL;

CREATE PUBLIC SYNONYM PWRASAL FOR BANINST1.PWRASAL;


GRANT EXECUTE ON BANINST1.PWRASAL TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRASAL TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRASAL TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRASAL TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRASEA;

CREATE OR REPLACE PROCEDURE BANINST1.PWRASEA(psReclDesc VARCHAR2) IS
/*
         Tarea: Alumnos sin encuesta asignada
                Se busca si un alumno le falta la encuesta del SEPRAD
        Modulo: Evaluacin Docente (SEPRAD)
         Fecha: 23/12/2010.
         Autor: GEPC

  Modificacin:
*/

  vsEncu VARCHAR2(30)   := NULL;
  vsTerm VARCHAR2(7)    := NULL;
  vsPtrm VARCHAR2(1000) := NULL;
  vnRow  INTEGER        := 0;

  csY    CONSTANT VARCHAR2(1) := 'Y';
  csShl  CONSTANT VARCHAR2(1) := '/';
  csEsp  CONSTANT VARCHAR2(1) := ' ';
  csAS   CONSTANT VARCHAR2(2) := 'AS';
  csCamp CONSTANT VARCHAR2(6) := F_CONTEXTO();
  cn0    CONSTANT NUMBER(1)   := 0;

  CURSOR cuMateria(psEncu VARCHAR2,
                   psTerm VARCHAR2,
                   psPtrm VARCHAR2 DEFAULT NULL
                  ) IS
         SELECT SFRSTCR_TERM_CODE                            AS Term,
                SPRIDEN_PIDM                                 AS idenPidm,
                SPRIDEN_ID                                   AS idenId,
                SPRIDEN_LAST_NAME||csEsp||SPRIDEN_FIRST_NAME AS idenName,
                SGBSTDN_STST_CODE                            AS STST,
                SGBSTDN_LEVL_CODE                            AS LEVL,
                SS.SSBSECT_CRN                               AS Crn,
                SS.SSBSECT_CAMP_CODE                         AS Camp,
                A.SCBCRSE_COLL_CODE                          AS Coll,
                A.SCBCRSE_SUBJ_CODE                          AS Subj,
                A.SCBCRSE_CRSE_NUMB                          AS Crse,
                A.SCBCRSE_TITLE                              AS Titulo,
                SS.SSBSECT_PTRM_CODE                         AS PTRM
           FROM SCBCRSE A,
                SSBSECT SS,
                SFRSTCR,
                SPRIDEN,
                SGBSTDN A
          WHERE SFRSTCR_TERM_CODE        = psTerm
            AND SFRSTCR_RSTS_CODE       IN (SELECT STVRSTS_CODE FROM STVRSTS WHERE STVRSTS_INCL_SECT_ENRL = csY)
            AND SFRSTCR_PIDM             = SPRIDEN_PIDM
            AND SPRIDEN_CHANGE_IND      IS NULL
            AND A.SGBSTDN_TERM_CODE_EFF  = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                              FROM SGBSTDN B
                                             WHERE B.SGBSTDN_PIDM      = A.SGBSTDN_PIDM
                                               AND B.SGBSTDN_STST_CODE = csAS
                                           )
            AND A.SGBSTDN_STST_CODE      = csAS
            AND SFRSTCR_PIDM             = A.SGBSTDN_PIDM
            AND A.SCBCRSE_SUBJ_CODE      = SS.SSBSECT_SUBJ_CODE
            AND A.SCBCRSE_CRSE_NUMB      = SS.SSBSECT_CRSE_NUMB
            AND A.SCBCRSE_EFF_TERM       = (SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                              FROM SCBCRSE SC
                                             WHERE SC.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                               AND SC.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                               AND SC.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB
                                           )
            AND SS.SSBSECT_TERM_CODE = SFRSTCR_TERM_CODE
            AND SS.SSBSECT_CRN       = SFRSTCR_CRN
            AND SS.SSBSECT_CAMP_CODE = csCamp
            AND (INSTR(csShl||SS.SSBSECT_PTRM_CODE||csShl,csShl||psPtrm) > cn0 OR psPtrm = csShl OR psPtrm IS NULL)
            AND NOT EXISTS (SELECT NULL
                              FROM SVRESAS
                             WHERE SVRESAS_TERM_CODE = SFRSTCR_TERM_CODE
                               AND SVRESAS_CRN       = SFRSTCR_CRN
                               AND SVRESAS_TSSC_CODE = psEncu
                               AND SVRESAS_PIDM      = SFRSTCR_PIDM
                           )
            AND EXISTS (SELECT NULL
                          FROM SVRESAF
                         WHERE SVRESAF_TERM_CODE = SFRSTCR_TERM_CODE
                           AND SVRESAF_CRN       = SFRSTCR_CRN
                           AND SVRESAF_TSSC_CODE = psEncu
                       )
          ORDER BY A.SCBCRSE_SUBJ_CODE,A.SCBCRSE_CRSE_NUMB,SPRIDEN_LAST_NAME||csEsp||SPRIDEN_FIRST_NAME;

  BEGIN
      -- valida que el usuario pertenezca a la base de datos.
      IF PK_Login.F_ValidacionDeAcceso(PK_Login.vgsUSR) THEN RETURN; END IF;

      vsEncu := pk_objhtml.getValueCookie('psSeprd');
      vsTerm := pk_objhtml.getValueCookie('psSpTCO');
      vsPtrm := NVL(pk_objhtml.getValueCookie('psPtrmP'),'/');

      htp.p('<html><head><title>'||psReclDesc||'</title>');

      -- la aplicacin no se guarda en el cache de la maquina.
      pk_ObjHTML.P_NoCache;

      --cdigo css
      pk_ObjHTML.P_CssTabs;

      htp.p('<script language="JavaScript"><!--');
      htp.p('function fImprimeReporte() {
      window.focus()
      print();
      }');
      htp.p('//--></script>
      <script language="javascript" src="kwacnls.js"></script>
      ');

      htp.p('</head><body bgcolor="#ffffff" class="bodyCeroR"><br/>
      <br/>
      <table border="0" cellpadding="2" cellspacing="1" width="100%" bgcolor="#ffffff" bordercolor="#ffffff">
             <tr><td width="10%" rowspan="3" valign="top"><img src="/imagenes/logo_uft.jpg" tabindex="-1" width="110" height="40" border="0"></td>
                 <td width="90%" class="tdTitulo"><b>&nbsp;&nbsp;'||REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(psReclDesc,'~aacute','&aacute'),'~eacute','&eacute'),'~iacute','&iacute'),'~oacute','&oacute'),'~uacute','&uacute')||' '||vsTerm||'</b></td></tr>
             <tr><th align="left">'||vsEncu||' - '||pK_Seprad1.F_Encuesta(vsEncu)||'</th></tr>
             <tr><td>&nbsp;&nbsp;'||pK_Seprad1.F_Fecha||'</td></tr>
             <tr><td colspan="2">&nbsp;</td>
      </table>');

      htp.p('<table border="1" cellpadding="2" cellspacing="1" width="100%" bgcolor="#ffffff" bordercolor="#cccccc">');

      htp.p('
      <tr bgcolor="#efefef">
      <th>'||f_Label(14)||'</th><!--Periodo    -->
      <th>'||f_Label(13)||'</th><!--Expediente -->
      <th>'||f_Label(38)||'</th><!--Nombre     -->
      <th>'||f_Label(82)||'</th><!--RUT        -->
      <th>'||f_Label(71)||'</th><!--Estatus    -->
      <th>'||f_Label(72)||'</th><!--Nivel      -->
      <th>'||f_Label(19)||'</th><!--Crn        -->
      <th>'||f_Label(73)||'</th><!--Campus     -->
      <th>'||f_Label(16)||'</th><!--Escuela    -->
      <th>'||f_Label(44)||'</th><!--Subj       -->
      <th>'||f_Label(45)||'</th><!--Crse       -->
      <th>'||f_Label(46)||'</th><!--Titulo     -->
      <th>'||f_Label(74)||'</th><!--Parte de periodo-->
      </tr>
      ');

      FOR regMat IN cuMateria(vsEncu, vsTerm, vsPtrm) LOOP
          vnRow := 1;

          htp.p('<tr>
          <td>'||regMat.Term  ||'</td>
          <td>'||regMat.idenId    ||'</td>
          <td>'||regMat.idenName  ||'</td>
          <td>'||f_get_rut(regMat.idenPidm)||'</td>
          <td>'||regMat.STST  ||'</td>
          <td>'||regMat.LEVL  ||'</td>
          <td>'||regMat.Crn   ||'</td>
          <td>'||regMat.Camp  ||'</td>
          <td>'||regMat.Coll  ||'</td>
          <td>'||regMat.Subj  ||'</td>
          <td>'||regMat.Crse  ||'</td>
          <td>'||regMat.Titulo||'</td>
          <td>'||regMat.PTRM  ||'</td>
          </tr>
          ');
      END LOOP;

      IF vnRow = 0 THEN
         htp.p('<tr><th colspan="12">Los alumnos ya tienen asignada la encuesta</th></tr>');
      END IF;

      htp.p('</table><br/><br/></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           HTP.P(SQLERRM);
  END PWRASEA;
/


DROP PUBLIC SYNONYM PWRASEA;

CREATE PUBLIC SYNONYM PWRASEA FOR BANINST1.PWRASEA;


GRANT EXECUTE ON BANINST1.PWRASEA TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRASEA TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRAVPG;

CREATE OR REPLACE PROCEDURE BANINST1.pwravpg (psReclDesc VARCHAR2, psSiu VARCHAR2 DEFAULT NULL)
IS
   /*
            TAREA: Avance de captura de programas magisteriales
            FECHA: 09/08/2010
            AUTOR: GEPC
           MODULO: Programacin Academica

     MODIFICACIN: 07/12/2010
                   CCR
                   Se le agrego la instruccin para que termine la imagen load del reporte

     MODIFICACIN: 08/02/2011
                   GEPC
                   * Se cambio el valor del parametro "ps2" a "NULL" del procedimiento "PWAINGD"
                     para mostrar todas la materias

     MODIFICACION: 21/09/2011
                   JCCR
                   * Se Ajustan Totales INGRESADOS - NO INGRESADOS y sus Detalles , se Agrega Temporal TWRPRMG
                     para control de estas cifras


   */

   global_pidm       spriden.spriden_pidm%TYPE;

   vsPeriodoDesc     STVTERM.STVTERM_DESC%TYPE := NULL;
   vsEscuelaDesc     STVCOLL.STVCOLL_DESC%TYPE := NULL;
   vnTermYs          NUMBER (5) := 0;
   vnTermNo          NUMBER (5) := 0;
   vnCursos          NUMBER (5) := 0;
   vnCursosEnd       NUMBER (5) := 0;
   vnCursosNot       NUMBER (5) := 0;
   vnCursosSolVoBo   NUMBER (5) := 0;
   vnTotalM          NUMBER := 0;
   vnTotalC          NUMBER := 0;
   vnTotalCno        NUMBER := 0;
   vnPorcentajeP     NUMBER := 0;
   vnTotalCrs        NUMBER (5) := 0;
   vnTotalEnd        NUMBER (5) := 0;
   vnTotalNot        NUMBER (5) := 0;
   vnTotalSolVoBo    NUMBER (5) := 0;
   vsCamp            VARCHAR2 (6) := NULL;
   vsSede            VARCHAR2 (10) := NULL;
   vsTerm            VARCHAR2 (10) := NULL;
   vsColl            VARCHAR2 (10) := NULL;

   csC      CONSTANT VARCHAR2 (1) := 'C';
   csY      CONSTANT VARCHAR2 (1) := 'Y';
   csS      CONSTANT VARCHAR2 (1) := 'S';
   cn0      CONSTANT NUMBER (1) := 0;
   cn1      CONSTANT NUMBER (1) := 1;


   vnPaso            INTEGER := 0;

   --cuProfesore
   CURSOR cuProfesore
   IS
        SELECT FWRSIRG_COLL_CODE AS collCode,
               COUNT (DISTINCT FWRSIRG_PIDM) AS sirgPidm
          FROM FWRSIRG B
      GROUP BY FWRSIRG_COLL_CODE
      ORDER BY FWRSIRG_COLL_CODE;

   --programasTerminados
   FUNCTION programasTerminados (psCollCode VARCHAR2)
      RETURN NUMBER
   IS
      vnTerminaron      NUMBER (5) := 0;
      vnTerminds        NUMBER (5) := NULL;
      vnMaterias        NUMBER (5) := NULL;

      csTerm   CONSTANT VARCHAR2 (6) := vsTerm;
      cnCero   CONSTANT NUMBER (1) := 0;

      CURSOR cuMaterias
      IS
           SELECT c.fwrsirg_pidm AS sirgPidm, COUNT (c.fwrsirg_crn) AS sirgCrnn
             FROM fwrsirg c
            WHERE c.fwrsirg_coll_code = psCollCode
                  AND c.fwrsirg_pidm IN (SELECT pidmok
                                           FROM (SELECT orig.twrprmg_pidm
                                                           pidmok,
                                                        reg,
                                                        noreg
                                                   FROM (SELECT DISTINCT
                                                                twrprmg_pidm
                                                           FROM twrprmg) orig,
                                                        (  SELECT twrprmg_pidm,
                                                                  COUNT (
                                                                     twrprmg_crn)
                                                                     reg
                                                             FROM twrprmg
                                                            WHERE twrprmg_registrado !=
                                                                     cn0
                                                         GROUP BY twrprmg_pidm) regisrados,
                                                        (  SELECT twrprmg_pidm,
                                                                  COUNT (
                                                                     twrprmg_crn)
                                                                     noreg
                                                             FROM twrprmg
                                                            WHERE twrprmg_registrado =
                                                                     cn0
                                                         GROUP BY twrprmg_pidm) noregistrados
                                                  WHERE orig.twrprmg_pidm =
                                                           regisrados.
                                                            twrprmg_pidm(+)
                                                        AND orig.twrprmg_pidm =
                                                               noregistrados.
                                                                twrprmg_pidm(+))
                                          WHERE noreg IS NULL)
         GROUP BY c.fwrsirg_pidm;
   BEGIN
      FOR regMat IN cuMaterias
      LOOP
         vnTerminaron := vnTerminaron + 1;
      END LOOP;

      RETURN vnTerminaron;
   END programasTerminados;

   --programasNoTerminados
   FUNCTION programasNoTerminados (psCollCode VARCHAR2)
      RETURN NUMBER
   IS
      vnTerminaron      NUMBER (5) := 0;
      vnTerminds        NUMBER (5) := NULL;
      vnMaterias        NUMBER (5) := NULL;

      csTerm   CONSTANT VARCHAR2 (6) := vsTerm;
      cnCero   CONSTANT NUMBER (1) := 0;

      CURSOR cuMaterias
      IS
           SELECT c.fwrsirg_pidm AS sirgPidm, COUNT (c.fwrsirg_crn) AS sirgCrnn
             FROM fwrsirg c
            WHERE c.fwrsirg_coll_code = psCollCode
                  AND c.fwrsirg_pidm IN (SELECT pidmok
                                           FROM (SELECT orig.twrprmg_pidm
                                                           pidmok,
                                                        reg,
                                                        noreg
                                                   FROM (SELECT DISTINCT
                                                                twrprmg_pidm
                                                           FROM twrprmg) orig,
                                                        (  SELECT twrprmg_pidm,
                                                                  COUNT (
                                                                     twrprmg_crn)
                                                                     reg
                                                             FROM twrprmg
                                                            WHERE twrprmg_registrado !=
                                                                     cn0
                                                         GROUP BY twrprmg_pidm) regisrados,
                                                        (  SELECT twrprmg_pidm,
                                                                  COUNT (
                                                                     twrprmg_crn)
                                                                     noreg
                                                             FROM twrprmg
                                                            WHERE twrprmg_registrado =
                                                                     cn0
                                                         GROUP BY twrprmg_pidm) noregistrados
                                                  WHERE orig.twrprmg_pidm =
                                                           regisrados.
                                                            twrprmg_pidm(+)
                                                        AND orig.twrprmg_pidm =
                                                               noregistrados.
                                                                twrprmg_pidm(+))
                                          WHERE noreg IS NOT NULL)
         GROUP BY c.fwrsirg_pidm;
   BEGIN
      FOR regMat IN cuMaterias
      LOOP
         vnTerminaron := vnTerminaron + 1;
      END LOOP;

      RETURN vnTerminaron;
   END programasNoTerminados;

   --cursos
   FUNCTION cursos (psCollCode VARCHAR2)
      RETURN NUMBER
   IS
      vnCantidad   NUMBER (5) := 0;
   BEGIN
      SELECT COUNT (DISTINCT swrpgac_crn)
        INTO vnCantidad
        FROM swrpgac
       WHERE EXISTS
                (SELECT NULL
                   FROM fwrsirg
                  WHERE fwrsirg_crn = swrpgac_crn
                        AND fwrsirg_term_code = swrpgac_term_code)
             AND swrpgac_coll_code = psCollCode;

      RETURN vnCantidad;
   END cursos;

   --cursosTerminados
   FUNCTION cursosTerminados (psCollCode VARCHAR2)
      RETURN NUMBER
   IS
      vnCantidad   NUMBER (5) := 0;
   BEGIN
      SELECT COUNT (DISTINCT swrpgac_crn)
        INTO vnCantidad
        FROM swrpgac, fwrsirg
       WHERE swrpgac_crn = fwrsirg_crn
             AND swrpgac_term_code = fwrsirg_term_code
             AND EXISTS
                    (SELECT NULL
                       FROM fwrpblc
                      WHERE     fwrpblc_publicar = csY
                            AND fwrpblc_crn = swrpgac_crn
                            AND fwrpblc_term_code = swrpgac_term_code)
             AND swrpgac_coll_code = psCollCode;

      RETURN vnCantidad;
   END cursosTerminados;

   --cursosNoTerminados
   FUNCTION cursosNoTerminados (psCollCode VARCHAR2)
      RETURN NUMBER
   IS
      vnCantidad   NUMBER (5) := 0;
   BEGIN
      SELECT COUNT (swrpgac_crn)
        INTO vnCantidad
        FROM swrpgac
       WHERE NOT EXISTS
                    (SELECT NULL
                       FROM fwrpblc
                      WHERE     fwrpblc_solc_vobo = csY
                            AND fwrpblc_crn = swrpgac_crn
                            AND fwrpblc_term_code = swrpgac_term_code)
             AND EXISTS
                    (SELECT NULL
                       FROM fwrsirg
                      WHERE fwrsirg_crn = swrpgac_crn
                            AND fwrsirg_coll_code = psCollCode)
             AND swrpgac_coll_code = psCollCode;

      RETURN vnCantidad;
   END cursosNoTerminados;

   --cursosSolVoBo
   FUNCTION cursosSolVoBo (psCollCode VARCHAR2)
      RETURN NUMBER
   IS
      vnCantidad   NUMBER (5) := 0;
   BEGIN
      SELECT COUNT (swrpgac_crn)
        INTO vnCantidad
        FROM swrpgac, fwrsirg
       WHERE swrpgac_term_code = fwrsirg_term_code
             AND swrpgac_crn = fwrsirg_crn
             AND EXISTS
                    (SELECT NULL
                       FROM fwrpblc
                      WHERE     fwrpblc_solc_vobo = csY
                            AND fwrpblc_publicar IS NULL
                            AND fwrpblc_crn = swrpgac_crn
                            AND fwrpblc_term_code = swrpgac_term_code)
             AND fwrsirg_coll_code = psCollCode;

      RETURN vnCantidad;
   END cursosSolVoBo;
BEGIN
   -- valida que el usuario pertenezca a la base de datos.
   IF psSiu IS NULL
   THEN
      IF PK_Login.F_ValidacionDeAcceso (PK_Login.vgsUSR) THEN RETURN; END IF;


      vsCamp := pk_objHtml.getValueCookie ('psUnive');
   ELSIF psSiu IS NOT NULL
   THEN
      IF NOT twbkwbis.F_ValidUser (global_pidm)
      THEN
         RETURN;
      END IF;

      vsCamp := 'UFT';
   END IF;

   vsTerm := pk_objHtml.getValueCookie ('psPerio');
   vsColl := pk_objHtml.getValueCookie ('psEscu');
   vsSede := pk_objhtml.getValueCookie ('psDept');

   --Llena tablas de paso para mejorar la velocidad en el reporte
   PWAAVPG (vsCamp,
            vsTerm,
            vsColl,
            vsSede);

   vsPeriodoDesc := pk_Catalogo.Periodo (vsTerm);

   HTP.
    p (
         '<html><head><title>'
      || CHR (38)
      || 'nbsp;</title>
      <script language="javascript" src="kwacnls.js"></script>
      ');

   -- la aplicacioacute;n no se guarda en el cache de la maquina.
   PK_ObjHTML.P_NoCache;

   --coacute;digo css
   PK_ObjHTML.P_CssTabs;

   HTP.p ('<script language="JavaScript"><!--');

   --fEjecuta
   HTP.
    p (
      'function fEjecuta(psCOLL,pnVAL) {
         document.frmAction.psColl.value = psCOLL;

                if(pnVAL == 1) {
                   document.frmAction.action = "kwaprmg2.siIngresoPrograma";

         } else if(pnVAL == 2) {
                   document.frmAction.action = "kwaprmg2.noIngresoPrograma";

         } else if(pnVAL == 3) {
                   document.frmAction.action = "kwaprmg2.asignaturaPublicada";

         } else if(pnVAL == 4) {
                   document.frmAction.action = "kwaprmg2.asignaturaVoBo";

         } else if(pnVAL == 5) {
                   document.frmAction.action = "kwaprmg2.asignaturaFaltante";

         }
         document.frmAction.submit();

      }');

   --fImprimeReporte
   HTP.p ('function fImprimeReporte() {
      window.focus();
      print();
      }');

   HTP.p ('--></script>');

   HTP.
    p (
      '</head><body bgcolor="#ffffff">
      <table width="1085" border="0" cellpadding="0" cellspacing="0" align="center" bordercolor="#cccccc">
             <tr><td width="145px" rowspan="4">
                     <img src="/imagenes/'
      || 'logouft.gif'
      || '" tabindex="-1" border="0" width="100pt">
                     </td>
                 <td width="'
      || (1085 - 145)
      || 'px">
                     Avance de captura de programas magisteriales</td></tr>
             <tr><td>
                     '
      || vsTerm
      || ' '
      || vsPERIODODESC
      || '</td></tr>
             <tr><td>
                     '
      || TO_CHAR (SYSDATE, 'DD/MM/YYYY HH24:MI:SS')
      || '</td></tr>
             <tr><td>'
      || CHR (38)
      || 'nbsp;</td></tr>
             <tr><td colspan="2">'
      || CHR (38)
      || 'nbsp;</td></tr>
      </table>

      <table width="1085px" border="1" cellpadding="2" cellspacing="1" align="center" bordercolor="#cccccc">
             <tr bgcolor="#efefef">
                 <th width="205px" valign="top">
                     Escuela o Facultad</th>
                 <th width="110px" valign="top">
                     Total de Maestros
                     </th>
                 <th width="110px" valign="top">
                     Maestros con programa terminado
                     </th>
                 <th width="110px" valign="top">
                     Maestros Faltantes de terminar programa
                     </th>
                 <th width="110px" valign="top">
                     % de profesores que capturaron programa
                     </th>
                 <th width="110px" valign="top">
                     Asignaturas Totales
                     </th>
                 <th width="110px" valign="top">
                     Asignaturas Publicadas
                     </th>
                 <th width="110px" valign="top">
                     Asignaturas con solicitud de Vo.Bo.
                     </th>
                 <th width="110px" valign="top">
                     Asignaturas Faltantes
                     </th>
                     </tr>');

   FOR regPrf IN cuProfesore
   LOOP
      vnPorcentajeP := 0;
      vsEscuelaDesc := pk_catalogo.colegio (regPrf.collCode);

      --- Temporal Adicional para Validar REGISTRADOS - NO REGISTRADOS
      DELETE twrprmg;

      INSERT INTO twrprmg
           SELECT fwrsirg_pidm AS sirgPidm,
                  fwrsirg_crn AS sirgCrnn,
                  NVL (
                     (SELECT cn1
                        FROM fwrpblc
                       WHERE     fwrpblc_publicar = csY
                             AND fwrpblc_crn = fwrsirg_crn
                             AND fwrpblc_term_code = vsTerm),
                     cn0)
                     esRegistrado
             FROM fwrsirg
            WHERE fwrsirg_coll_code = regPrf.collCode
         ORDER BY fwrsirg_pidm;

      vnTermYs := programasTerminados (regPrf.collCode);
      vnTermNo := programasNoTerminados (regPrf.collCode);
      vnCursos := cursos (regPrf.collCode);
      vnCursosEnd := cursosTerminados (regPrf.collCode);
      vnCursosNot := cursosNoTerminados (regPrf.collCode);
      vnCursosSolVoBo := cursosSolVoBo (regPrf.collCode);

      vnTotalEnd := vnCursosEnd + vnTotalEnd;
      vnTotalNot := vnCursosNot + vnTotalNot;
      vnTotalSolVoBo := vnCursosSolVoBo + vnTotalSolVoBo;
      vnTotalCrs := vnCursos + vnTotalCrs;

      IF vnTermYs <> 0 AND regPrf.sirgPidm <> 0
      THEN
         vnPorcentajeP := ROUND ( (vnTermYs / regPrf.sirgPidm) * 100, 2);
      END IF;

      HTP.
       p (
            '<tr '
         || PK_ObjHTML.vgsRenglon
         || '>
          <td align="left">'
         || vsEscuelaDesc
         || '</td>
          <td align="right">'
         || regPrf.sirgPidm
         || '</td>
          <td align="right">
              <a href="javascript:fEjecuta('''
         || regPrf.collCode
         || ''',1);" onMouseOver="window.status='''
         || vsEscuelaDesc
         || ' '
         || vnTermYs
         || '''; return true;" onMouseOut="window.status=''''; return true;">
              '
         || vnTermYs
         || '
              </a></td>
          <td align="right">
              <a href="javascript:fEjecuta('''
         || regPrf.collCode
         || ''',2);" onMouseOver="window.status='''
         || vsEscuelaDesc
         || ' '
         || vnTermNo
         || '''; return true;" onMouseOut="window.status=''''; return true;">
              '
         || vnTermNo
         || '
              </a></td>
          <td align="right">'
         || vnPorcentajeP
         || '%</td>
          <td align="right">'
         || vnCursos
         || '</td>
          <td align="right">
              <a href="javascript:fEjecuta('''
         || regPrf.collCode
         || ''',3);" onMouseOver="window.status='''
         || vsEscuelaDesc
         || ' '
         || vnCursosEnd
         || '''; return true;" onMouseOut="window.status=''''; return true;">
              '
         || vnCursosEnd
         || '
              </a></td>
          <td align="right">
              <a href="javascript:fEjecuta('''
         || regPrf.collCode
         || ''',4);" onMouseOver="window.status='''
         || vsEscuelaDesc
         || ' '
         || vnCursosEnd
         || '''; return true;" onMouseOut="window.status=''''; return true;">
              '
         || vnCursosSolVoBo
         || '
              </a></td>
          <td align="right">
              <a href="javascript:fEjecuta('''
         || regPrf.collCode
         || ''',5);" onMouseOver="window.status='''
         || vsEscuelaDesc
         || ' '
         || vnCursosNot
         || '''; return true;" onMouseOut="window.status=''''; return true;">
              '
         || vnCursosNot
         || '
              </a></td>
          </tr>');

      vnTotalCno := vnTotalCno + vnTermNo;
      vnTotalM := vnTotalM + regPrf.sirgPidm;
      vnTotalC := vnTotalC + vnTermYs;
   END LOOP;

   vnPorcentajeP := 0;

   IF vnTotalM <> 0 AND vnTotalC <> 0
   THEN
      vnPorcentajeP := ROUND ( (vnTotalC / vnTotalM) * 100, 2);
   END IF;

   HTP.
    p (
         '<tr bgcolor="#efefef">
      <th align="center">Total</th>
      <th align="right">'
      || vnTotalM
      || '</th>
      <th align="right">'
      || vnTotalC
      || '</th>
      <th align="right">'
      || vnTotalCno
      || '</th>
      <th align="right">'
      || vnPorcentajeP
      || '%</th>

      <th align="right">'
      || vnTotalCrs
      || '</th>
      <th align="right">'
      || vnTotalEnd
      || '</th>
      <th align="right">'
      || vnTotalSolVoBo
      || '</th>
      <th align="right">'
      || vnTotalNot
      || '</th>
      </tr></table><br/>

      <form name="frmAction" method="post">
      <input type="hidden" name="psCamp" value="'
      || vsCamp
      || '">
      <input type="hidden" name="psTerm" value="'
      || vsTerm
      || '">
      <input type="hidden" name="psColl" >
      <input type="hidden" name="psSede" >
      <input type="hidden" name="psSiu" value="'
      || psSiu
      || '">
      </form>

      </html></body>');

   ROLLBACK;
EXCEPTION
   WHEN OTHERS
   THEN
      HTP.p (SQLERRM);
END PWRAVPG;
/


DROP PUBLIC SYNONYM PWRAVPG;

CREATE PUBLIC SYNONYM PWRAVPG FOR BANINST1.PWRAVPG;


GRANT EXECUTE ON BANINST1.PWRAVPG TO WWW_USER;
DROP PROCEDURE BANINST1.PWRBAJS;

CREATE OR REPLACE PROCEDURE BANINST1.PWRBAJS
IS
    -- DECLARACION DE VARIABLES LOCALES
    curr_release        CONSTANT VARCHAR2 (10)             := '8.1.1';
    global_pidm            spriden.spriden_pidm%TYPE;
    -- DECLARACION DE CURSORES LOCALES
    -- CURSOR QUE CARGA PERIODOS
    CURSOR cTerm IS
        SELECT DISTINCT SFRSTCR_TERM_CODE AS TERM, PK_CATALOGO.PERIODO(SFRSTCR_TERM_CODE) AS TDESC
        FROM SFRSTCR
        WHERE SFRSTCR_PIDM = global_pidm
        AND SFRSTCR_RSTS_CODE IN ('RE','RW')
        AND EXISTS (SELECT 1 FROM SFRRSTS
        			WHERE SFRRSTS_RSTS_CODE = 'RS'
                    AND SFRRSTS_TERM_CODE = SFRSTCR_TERM_CODE
                    AND TRUNC(SFRRSTS_END_DATE)>= TRUNC(SYSDATE));
    -- CURSOR QUE CARGA LOS PROGRAMAS DEL ESTUDIANTE



    -- CURSOR QUE CARGA LOS TIPOS DE CERTIFICADOS
BEGIN
    IF NOT twbkwbis.f_validuser (global_pidm) THEN  RETURN; END IF;
    -- INICIALIZA LA PAGUINA
    bwckfrmt.p_open_doc ('PWRBAJS');
    twbkwbis.p_dispinfo ('PWRBAJS');

     HTP.formopen ('PWRABAJ', 'post');
     twbkfrmt.p_tableopen (
        'DATAENTRY',
        cattributes   => 'SUMMARY="' ||
                            g$_nls.get ('BWSKOTR1-0001',
                               'SQL',
                               'This entry table is used to request
                               transcript type and level'
                            ) ||
                            '."'
     );
    -- INICIAL LA TABLA PARA PONER LOS PARAMETROS QUE SE VAN A SOLICITAR
    twbkfrmt.p_tablerowopen;
    --
    -- SOLICITA EL PARAMETRO DE PERIODO
    twbkfrmt.p_tabledataopen;
    htp.formSelectOpen('psPerio', 'Periodo:   ');
    FOR x IN cTerm LOOP
        twbkwbis.p_formselectoption(x.TDESC, x.TERM);
    END LOOP;
    htp.formSelectClose;
    twbkfrmt.p_tabledataclose;
    twbkfrmt.p_tablerowclose;
    --
     twbkfrmt.p_tablerowopen ();
     twbkfrmt.p_tabledataseparator (' ', ccolspan => 11);
     twbkfrmt.p_tablerowclose;
     twbkfrmt.p_tableclose;
     HTP.formsubmit (NULL, g$_nls.get ('BWSKOTR1-0007', 'SQL', 'Submit'));
     HTP.formclose;

  twbkwbis.p_closedoc (curr_release);
  COMMIT;
END PWRBAJS;
/


DROP PUBLIC SYNONYM PWRBAJS;

CREATE PUBLIC SYNONYM PWRBAJS FOR BANINST1.PWRBAJS;


GRANT EXECUTE ON BANINST1.PWRBAJS TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRBAJS TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRBAJS TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRBAJS TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRBFIN;

CREATE OR REPLACE PROCEDURE BANINST1.PWRBFIN(psReclDesc   VARCHAR2) IS

  -- declaracin de variables:
  vnExists       INTEGER      := 0;
  vnColumnas     INTEGER      := 45;
  vgsInicioPag   VARCHAR2(30) := NULL;         -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vnIdRenglon    INTEGER      := 1;
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);

  vsTerm         SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsProgr        SARADAP.SARADAP_PROGRAM_1%TYPE       DEFAULT NULL;
  vsPropsu_ant          VARCHAR2(50) := NULL;
  vsPropsu_act          VARCHAR2(50) := NULL;
  vnTermAnt             VARCHAR2(6) := NULL;
  vnTermAct             VARCHAR2(6) := NULL;
  vnAnoEje                VARCHAR2(4) := NULL;


  -- obtiene la informacin de los alumnos:
CURSOR cuReporte ( psTerm    VARCHAR2  DEFAULT NULL,
                              psProgr   VARCHAR2  DEFAULT NULL ) IS
SELECT DISTINCT spbpers_name_suffix                                                                                   RUT,
            SPRIDEN_ID                                                                                                        ID,
            UPPER(REPLACE(REPLACE(SPRIDEN_LAST_NAME, '*', ' '), '  ', ' ' ))                                 APELLIDOS,
            UPPER(REPLACE(REPLACE(SPRIDEN_FIRST_NAME||' '||SPRIDEN_MI,'   ', ' '), '  ', ' '))    NOMBRE,
            A.SGBSTDN_STST_CODE                                                                                            STATUS,
            (SELECT STVSTST_DESC FROM STVSTST
             WHERE STVSTST_CODE=A.SGBSTDN_STST_CODE)                                                       DESC_STATUS,
            (SELECT SPRADDR_CNTY_CODE||' '||STVCNTY_DESC FROM SPRADDR, STVCNTY
            WHERE SPRADDR_ATYP_CODE = 'PR'
            AND SPRADDR_CNTY_CODE = STVCNTY_CODE
            AND SPRADDR_PIDM = A.SGBSTDN_PIDM
            AND ROWNUM = 1)                                                                                                  COMUNA_RESIDENCIA,
            (SELECT SPRADDR_STAT_CODE||' '||STVSTAT_DESC FROM SPRADDR, STVSTAT
            WHERE SPRADDR_ATYP_CODE = 'PR'
            AND SPRADDR_STAT_CODE = STVSTAT_CODE
            AND SPRADDR_PIDM = A.SGBSTDN_PIDM
            AND ROWNUM = 1)                                                                                                 REGION_RESIDENCIA,
            A.SGBSTDN_PROGRAM_1                                                                                          PROGRAMA,
            decode(TWBCNTR_STATUS_IND,'A',TWBCNTR_NUM,null)                                               CONTRATO,
            decode(TWBCNTR_STATUS_IND,'A',twbcntr_issue_date,null)                                            FECHA_CONTRATO,
            (SELECT X.SARADAP_ADMT_CODE FROM SARADAP X
            WHERE X.SARADAP_PIDM = A.SGBSTDN_PIDM
            AND X.SARADAP_TERM_CODE_ENTRY = A.SGBSTDN_TERM_CODE_EFF
            AND X.SARADAP_PROGRAM_1 = A.SGBSTDN_PROGRAM_1
            AND X.SARADAP_APPL_NO = (select max(Y.SARADAP_APPL_NO) from saradap y
            						WHERE A.SGBSTDN_PIDM = Y.SARADAP_PIDM
                                    AND A.SGBSTDN_TERM_CODE_EFF = Y. SARADAP_TERM_CODE_ENTRY
                                    AND A.SGBSTDN_PROGRAM_1 = Y.SARADAP_PROGRAM_1)
                                    AND ROWNUM=1)                                                                                   TIPO_ADMISION,
             (SELECT STVADMT_DESC FROM SARADAP X, STVADMT
            WHERE X.SARADAP_PIDM = A.SGBSTDN_PIDM
            AND X.SARADAP_ADMT_CODE = STVADMT_CODE
            AND X.SARADAP_TERM_CODE_ENTRY = A.SGBSTDN_TERM_CODE_EFF
            AND X.SARADAP_PROGRAM_1 = A.SGBSTDN_PROGRAM_1
            AND X.SARADAP_APPL_NO = (select max(Y.SARADAP_APPL_NO) from saradap y
            						WHERE A.SGBSTDN_PIDM = Y.SARADAP_PIDM
                                    AND A.SGBSTDN_TERM_CODE_EFF = Y. SARADAP_TERM_CODE_ENTRY
                                    AND A.SGBSTDN_PROGRAM_1 = Y.SARADAP_PROGRAM_1)
                                    AND ROWNUM=1) DESC_TIPO_ADMISION,
            SWVTAVI_RTYP_CODE                                                                                             VIA,
            (SELECT STVRTYP_DESC FROM STVRTYP
            WHERE STVRTYP_CODE =SWVTAVI_RTYP_CODE)                                                       DESC_VIA_INGRESO,
              (SELECT X.SARADAP_APPL_PREFERENCE FROM SARADAP X
            WHERE X.SARADAP_PIDM = A.SGBSTDN_PIDM
            AND X.SARADAP_TERM_CODE_ENTRY = A.SGBSTDN_TERM_CODE_EFF
            AND X.SARADAP_PROGRAM_1 = A.SGBSTDN_PROGRAM_1
            AND X.SARADAP_APPL_NO = (select max(Y.SARADAP_APPL_NO) from saradap y
            						WHERE A.SGBSTDN_PIDM = Y.SARADAP_PIDM
                                    AND A.SGBSTDN_TERM_CODE_EFF = Y. SARADAP_TERM_CODE_ENTRY
                                    AND A.SGBSTDN_PROGRAM_1 = Y.SARADAP_PROGRAM_1)
                                    AND ROWNUM=1) PREFERENCIA,
            F_PUNTAJES (A.SGBSTDN_PIDM, 'PEM',1,vnTermAct,null)                    PEM,
            F_PUNTAJES (A.SGBSTDN_PIDM, 'NEME',1,vnTermAct,null)                  NEME,
            F_PUNTAJES (A.SGBSTDN_PIDM, 'PSCI',2,null,vnTermAnt)                   PSCI_ANTERIOR,
       --  F_PUNTAJES (SA.SARADAP_PIDM, 'PETE',2,null,vnTermAnt)                   PETE_ANTERIOR,
            F_PUNTAJES (A.SGBSTDN_PIDM, 'PPSU',2,null,vnTermAnt)                   PPSU_ANTERIOR,
            F_PUNTAJES (A.SGBSTDN_PIDM, 'PSHC',2,null,vnTermAnt)                  PSHC_ANTERIOR,
            F_PUNTAJES (A.SGBSTDN_PIDM, 'PSLC',2,null,vnTermAnt)                   PSLC_ANTERIOR,
            F_PUNTAJES (A.SGBSTDN_PIDM, 'PSMA',2,null,vnTermAnt)                  PSMA_ANTERIOR,
            F_PUNTAJES (A.SGBSTDN_PIDM, 'PRAN',2,null,vnTermAnt)                  PRAN_ANTERIOR,
            DECODE(A.SGBSTDN_PIDM, 'LC-ACTU-10',F_PUNTAJES (A.SGBSTDN_PIDM, 'PETE',2,null,vnTermAnt),'LC-PRMC-10',F_PUNTAJES (A.SGBSTDN_PIDM, 'PEPR',2,null,vnTermAnt),NULL) PETE_ANTERIOR,
            F_PUNTAJES (A.SGBSTDN_PIDM, 'PSCI',1,vnTermAct,null)                   PSCI_ACTUAL,
            F_PUNTAJES (A.SGBSTDN_PIDM, 'PSHC',1,vnTermAct,null)                  PSHC_ACTUAL,
            F_PUNTAJES (A.SGBSTDN_PIDM, 'PSLC',1,vnTermAct,null)                   PSLC_ACTUAL,
            F_PUNTAJES (A.SGBSTDN_PIDM, 'PPSU',1,vnTermAct,null)                   PPSU_ACTUAL,
            F_PUNTAJES (A.SGBSTDN_PIDM, 'PRAN',1,vnTermAct,null)    				PRAN,
   --         F_PUNTAJES (SA.SARADAP_PIDM, 'PETE',1,vnTermAct,null)                  PETE_ACTUAL,
            F_PUNTAJES (A.SGBSTDN_PIDM, 'PSMA',1,vnTermAct,null)                  PSMA_ACTUAL,
            F_PUNTAJES (A.SGBSTDN_PIDM, 'PRAN',1,vnTermAct,null)                  PRAN_ACTUAL,
            DECODE(A.SGBSTDN_PROGRAM_1, 'LC-ACTU-10',F_PUNTAJES (A.SGBSTDN_PIDM, 'PETE',1,vnTermAct,null),'LC-PRMC-10',F_PUNTAJES (A.SGBSTDN_PIDM, 'PEPR',1,vnTermAct,null),NULL) PETE_ACTUAL,
            F_PONDERADOS (A.SGBSTDN_PIDM, A.SGBSTDN_PROGRAM_1,1,vnTermAct,null)    PONDERADO_UFT_ACTUAL,
            F_PONDERADOS (A.SGBSTDN_PIDM, A.SGBSTDN_PROGRAM_1,2,null,vnTermAnt)   PONDERADO_UFT_ANTERIOR,
            SPBPERS_SEX                                                                                                                           SEXO,
            (select UPPER(PK_CATALOGO.PREPARATORIA (SORHSCH_SBGI_CODE))
             from SORHSCH
             where SORHSCH_PIDM=A.SGBSTDN_PIDM
              and rownum=1) COLEGIO,
            (select  (SORHSCH_SBGI_CODE)
             from SORHSCH
             where SORHSCH_PIDM=A.SGBSTDN_PIDM
              and rownum=1) CODIGO_COLEGIO,
              (select  (SORBCHR_BCHR_CODE)
             from SORHSCH,SORBCHR
             where SORHSCH_PIDM=A.SGBSTDN_PIDM
             AND SORBCHR_SBGI_CODE = SORHSCH_SBGI_CODE
             AND ROWNUM =1)CODIGO_DEPENDENCIA,
             (select  STVBCHR_DESC FROM
             SORHSCH,SORBCHR, STVBCHR
             where SORHSCH_PIDM=A.SGBSTDN_PIDM
             AND SORBCHR_SBGI_CODE = SORHSCH_SBGI_CODE
             AND SORBCHR_BCHR_CODE = STVBCHR_CODE
             AND ROWNUM =1)DESC_DEPENDENCIA,
            (select SOBSBGI_STAT_CODE
             from SORHSCH,SOBSBGI
             where SORHSCH_PIDM =A.SGBSTDN_PIDM
              and SORHSCH_SBGI_CODE=SOBSBGI_SBGI_CODE
              and rownum=1) REGION_COL,
             (select SOBSBGI_CNTY_CODE
             from SORHSCH,SOBSBGI
             where SORHSCH_PIDM =A.SGBSTDN_PIDM
              and SORHSCH_SBGI_CODE=SOBSBGI_SBGI_CODE
              and rownum=1)  COMUNA_COL,
            (SELECT SUBSTR(SARQUAN_ANSWER,1,3)||','||SUBSTR(SARQUAN_ANSWER,4,2) from sarquan g, saradap X
                   where g.SARQUAN_ADMR_CODE='PPON'
                   and g.SARQUAN_PIDM=A.SGBSTDN_PIDM
                   and G.SARQUAN_PIDM = x.saradap_pidm
                   AND G.SARQUAN_TERM_CODE_ENTRY = X.SARADAP_TERM_CODE_ENTRY
                   AND X.SARADAP_APPL_NO = (select max(Y.SARADAP_APPL_NO) from saradap y
            						WHERE A.SGBSTDN_PIDM = Y.SARADAP_PIDM
                                    AND A.SGBSTDN_TERM_CODE_EFF = Y. SARADAP_TERM_CODE_ENTRY
                                    AND A.SGBSTDN_PROGRAM_1 = Y.SARADAP_PROGRAM_1)
                   and g.SARQUAN_TERM_CODE_ENTRY=A.SGBSTDN_TERM_CODE_EFF
                   and SARQUAN_APPL_NO = X.SARADAP_APPL_NO
                   and rownum=1) PPON,
                     (select SARQUAN_ANSWER
                from sarquan g, saradap x
               where g.SARQUAN_ADMR_CODE='AOA'
                   and g.SARQUAN_PIDM=A.SGBSTDN_PIDM
                   and G.SARQUAN_PIDM = x.saradap_pidm
                   AND G.SARQUAN_TERM_CODE_ENTRY = X.SARADAP_TERM_CODE_ENTRY
                   AND X.SARADAP_APPL_NO = (select max(Y.SARADAP_APPL_NO) from saradap y
            						WHERE A.SGBSTDN_PIDM = Y.SARADAP_PIDM
                                    AND A.SGBSTDN_TERM_CODE_EFF = Y. SARADAP_TERM_CODE_ENTRY
                                    AND A.SGBSTDN_PROGRAM_1 = Y.SARADAP_PROGRAM_1)
                   and SARQUAN_APPL_NO = X.SARADAP_APPL_NO
                   and rownum=1) AOA
                  ,(SELECT 'Si'
                	FROM TWBRETR
              		WHERE TWBRETR_CNTR_NUM = TWBCNTR_NUM)                    Retracto
              		,(SELECT 'Si'
                FROM SFRWDRL
              WHERE SFRWDRL_PIDM = A.SGBSTDN_PIDM
              AND SFRWDRL_TERM_CODE = A.SGBSTDN_TERM_CODE_EFF
              AND SFRWDRL_WDRL_CODE = 'R2')                     Ext
  FROM  SPRIDEN
                    ,SPBPERS
                    ,SMRPRLE
                    ,SGBSTDN A
                    ,SWVTAVI
                    ,TWBCNTR
                    ,SARAATT
                  WHERE SPRIDEN_PIDM = SPBPERS_PIDM
             AND SPRIDEN_CHANGE_IND IS NULL
             --AND SPRIDEN_PIDM = SARADAP_PIDM
             AND SPBPERS_PIDM = TWBCNTR_PIDM
             AND A.SGBSTDN_PIDM = TWBCNTR_PIDM
             AND SWVTAVI_ADMT_CODE = SGBSTDN_ADMT_CODE
             AND SWVTAVI_RTYP_CODE IN ('AR', 'AE','AC')
             AND FWATYALUFT(TWBCNTR_PIDM, TWBCNTR_TERM_CODE) = 'N'
             AND SWVTAVI_TERM_CODE = TWBCNTR_TERM_CODE
             --AND (SARAATT_ATTS_CODE = psIndSe OR psIndSe IS NULL)
             AND EXISTS (SELECT 1 FROM SARADAP
             			WHERE SARADAP_PIDM = TWBCNTR_PIDM
                        AND SARADAP_TERM_CODE_ENTRY = A.SGBSTDN_TERM_CODE_EFF
                        --AND SARADAP_APPL_NO = SARAATT_APPL_NO
			AND SARADAP_PROGRAM_1 = A.SGBSTDN_PROGRAM_1)
             AND SARAATT_TERM_CODE = TWBCNTR_TERM_CODE
             AND SARAATT_PIDM = TWBCNTR_PIDM
            --AND SARADAP_APPL_NO = SARAATT_APPL_NO
              AND TWBCNTR_TERM_CODE = psTerm
              AND SGBSTDN_TERM_CODE_EFF = psTerm
              AND A.SGBSTDN_PROGRAM_1 = SMRPRLE.SMRPRLE_PROGRAM
              AND TWBCNTR_STATUS_IND = 'A'
                AND (psProgr IS NULL OR a.SGBSTDN_PROGRAM_1 = psProgr)
                AND A.SGBSTDN_STYP_CODE IN('N','D','R') ;


---------------------------------------------------
-- bloque principal para la generacin del reporte
---------------------------------------------------
BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
   vsProgr := pk_ObjHtml.getValueCookie('psProgr');

   -- determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   -- define los encabezados de las columnas:
   tabColumna(1)  := '<center> RUT';
   tabColumna(2)  := '<center> ID';
   tabColumna(3)  := '<center> Apellidos';
   tabColumna(4)  := '<center> Nombre';
   tabColumna(5)  := '<center> Comuna <br> Residencia';
   tabColumna(6)  := '<center> Regi&oacute;n<br> Residencia';
   tabColumna(7)  := '<center> Programa';
   tabColumna(8)  := '<center> Contrato';
   tabColumna(9)  := '<center> Status';
   tabColumna(10)  := '<center> Descripci&oacute;n<br>Status';
   tabColumna(11)  := '<center> Fecha <br> Contrato';
   tabColumna(12) := '<center> Tipo <br> Admisi&oacute;n';
   tabColumna(13) := '<center> Descripci&oacute;n<br> Admisi&oacute;n';
   tabcolumna(14) := '<center> V&iacute;a <br> Admisi&oacute;n';
   tabColumna(15) :='<center> Descripci&oacute;n<br> V&iacute;a Admisi&oacute;n';
   tabColumna(16) := '<center> Preferencia';
   tabColumna(17) := '<center> PEM';
   tabColumna(18) := '<center> NEME';
   tabColumna(19) := '<center> PSCI <br> Anterior';
   tabColumna(20) := '<center> PSHC <br> Anterior';
   tabColumna(21) := '<center> PSLC <br> Anterior';
   tabColumna(22) := '<center> PSMA <br> Anterior';
   tabColumna(23) := '<center> PRAN <br> Anterior';
   tabColumna(24) := '<center> PETE<br> Anterior';
   tabColumna(25) := '<center> PSU<br> Anterior';
   tabColumna(26) := '<center> Ponderado <br> Anterior';
   tabColumna(27) := '<center> PSCI <br> Actual';
   tabColumna(28) := '<center> PSHC <br> Actual';
   tabColumna(29) := '<center> PSLC <br> Actual';
   tabColumna(30) := '<center> PSMA <br> Actual';
   tabColumna(31) := '<center> PRAN <br> Actual';
   tabColumna(32) := '<center> PETE <br> Actual';
   tabColumna(33) := '<center> PSU<br> Actual';
   tabColumna(34) := '<center> Ponderado <br> Actual';
   tabColumna(35) := '<center> Puntaje Ponderado <br> de Seleccin';
   tabColumna(36) := '<center> Ao Acadmico <br> de las pruebas';
   tabColumna(37) := '<center> Sexo';
   tabColumna(38) := '<center> C&oacute;digo Colegio';
   tabColumna(39) := '<center> Colegio';
   tabColumna(40) := '<center> Regi&oacute;n';
   tabColumna(41) := '<center> Comuna';
   tabColumna(42) := '<center> Dependencia Colegio';
   tabColumna(43) := '<center> Descipci&oacute;n <br> Dependencia Colegio';
   tabColumna(44) := '<center> Retracto';
   tabColumna(45) := '<center> Retracto Extemporneo';
      -- idetermina los parmetros con los cuales obtendr los puntajes anteriores y actuales

       begin
        select  stvterm_acyr_code
           into  vnAnoEje
        from  stvterm
        where
            stvterm_code=vsTerm;
        exception
        when no_data_found then
            vnAnoEje:=substr(vsTerm,1,4);
        when others then
            vnAnoEje:=substr(vsTerm,1,4);
    end;

   begin
        select  swvcpsu_term_code_previous,swvcpsu_term_code_present
           into  vnTermAnt,vnTermAct
        from  swvcpsu
        where
            swvcpsu_acyr_code=vnAnoEje;
        exception
        when no_data_found then
            vnTermAnt:=vsTerm;
            vnTermAct:=vsTerm;
        when others then
            vnTermAnt:=vsTerm;
            vnTermAct:=vsTerm;
   end;

   -- manipula la informacin obtenida por el cursor:
   FOR regRep IN cuReporte (vsTerm, vsProgr) LOOP

       IF vnExists = 0 THEN

          -- muestra el encabezado segn el periodo y programa seleccionados:
          IF vsProgr IS NOT NULL THEN
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||'<br>'||'Programa: &nbsp;'||vsProgr||' - '||Pk_Catalogo.Programa(vsProgr),
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
          ELSE
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||'<br>'||'Programa: &nbsp;'||'Todos ',
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
          END IF;

       END IF;

              SELECT
              CASE
                        WHEN ROUND((TO_NUMBER(REPLACE(nvl(regRep.PSLC_ANTERIOR,0) , ',', '.'))+TO_NUMBER(REPLACE(nvl(regRep.PSMA_ANTERIOR,0) , ',', '.')))/2,2) = 0
                           THEN null
                        WHEN ROUND((TO_NUMBER(REPLACE(nvl(regRep.PSLC_ANTERIOR,0) , ',', '.'))+TO_NUMBER(REPLACE(nvl(regRep.PSMA_ANTERIOR,0) , ',', '.')))/2,2) <> 0
                          THEN
                              replace(ROUND((TO_NUMBER(REPLACE(nvl(regRep.PSLC_ANTERIOR,0) , ',', '.'))+TO_NUMBER(REPLACE(nvl(regRep.PSMA_ANTERIOR,0) , ',', '.')))/2,2),'.',',')
              END,
              CASE
                        WHEN ROUND((TO_NUMBER(REPLACE(nvl(regRep.PSLC_ACTUAL,0) , ',', '.'))+TO_NUMBER(REPLACE(nvl(regRep.PSMA_ACTUAL,0) , ',', '.')))/2,2) = 0
                           THEN null
                        WHEN ROUND((TO_NUMBER(REPLACE(nvl(regRep.PSLC_ACTUAL,0) , ',', '.'))+TO_NUMBER(REPLACE(nvl(regRep.PSMA_ACTUAL,0) , ',', '.')))/2,2) <> 0
                          THEN
                              replace(ROUND((TO_NUMBER(REPLACE(nvl(regRep.PSLC_ACTUAL,0) , ',', '.'))+TO_NUMBER(REPLACE(nvl(regRep.PSMA_ACTUAL,0) , ',', '.')))/2,2),'.',',')
              END
            into vsPropsu_ant,vsPropsu_act
       from dual;

       HTP.P('<tr> <td valign="top" align="left">' ||regRep.RUT                          ||'</td>
                   <td valign="top" align="left">'       ||regRep.ID                             ||'</td>
                   <td valign="top" align="left">'       ||regRep.APELLIDOS                  ||'</td>
                   <td valign="top" align="left">'       ||regRep.NOMBRE                     ||'</td>
                   <td valign="top" align="left">'       ||regRep.COMUNA_RESIDENCIA   ||'</td>
                   <td valign="top" align="left">'       ||regRep.REGION_RESIDENCIA      ||'</td>
                   <td valign="top" align="left">'       ||regRep.PROGRAMA                    ||'</td>
                   <td valign="top" align="left">' ||regRep.CONTRATO                    ||'</td>
                   <td valign="top" align="left">' ||regRep.STATUS                    ||'</td>
                   <td valign="top" align="left">' ||regRep.DESC_STATUS                    ||'</td>
                   <td valign="top" align="left">' ||regRep.FECHA_CONTRATO          ||'</td>
                   <td valign="top" align="left">' ||regRep.TIPO_ADMISION            ||'</td>
                   <td valign="top" align="left">' ||regRep.DESC_TIPO_ADMISION     ||'</td>
                   <td valign="top" align="left">' ||regRep.VIA                               ||'</td>
                   <td valign="top" align="left">' ||regRep.DESC_VIA_INGRESO         ||'</td>
                   <td valign="top" align="left">' ||regRep.PREFERENCIA                  ||'</td>
                   <td valign="top" align="center">' ||regRep.PEM                               ||'</td>
                   <td valign="top" align="center">' ||regRep.NEME                             ||'</td>
                   <td valign="top" align="center">' ||regRep.PSCI_ANTERIOR             ||'</td>
                   <td valign="top" align="center">' ||regRep.PSHC_ANTERIOR             ||'</td>
                   <td valign="top" align="center">' ||regRep.PSLC_ANTERIOR              ||'</td>
                   <td valign="top" align="center">' ||regRep.PSMA_ANTERIOR              ||'</td>
                   <td valign="top" align="center">' ||regRep.PRAN_ANTERIOR              ||'</td>
                   <td valign="top" align="center">' ||regRep.PETE_ANTERIOR              ||'</td>
                    <td valign="top" align="center">' ||vsPropsu_ant                          ||'</td>
                    <td valign="top" align="center">' ||regRep.PONDERADO_UFT_ANTERIOR         ||'</td>
                   <td valign="top" align="center">' ||regRep.PSCI_ACTUAL                 ||'</td>
                   <td valign="top" align="center">' ||regRep.PSHC_ACTUAL                ||'</td>
                   <td valign="top" align="center">' ||regRep.PSLC_ACTUAL                 ||'</td>
                   <td valign="top" align="center">' ||regRep.PSMA_ACTUAL                ||'</td>
                   <td valign="top" align="center">' ||regRep.PRAN_ACTUAL                ||'</td>
                   <td valign="top" align="center">' ||regRep.PETE_ACTUAL             ||'</td>
                   <td valign="top" align="center">' ||vsPropsu_act                          ||'</td>
                   <td valign="top" align="center">' ||regRep.PONDERADO_UFT_ACTUAL          ||'</td>
                   <td valign="top" align="center">' ||regRep.PPON                            ||'</td>
                   <td valign="top" align="center">' ||regRep.AOA                          ||'</td>
                   <td valign="top" align="left">'     ||regRep.SEXO                            ||'</td>
                   <td valign="top" align="left">'     ||regRep.CODIGO_COLEGIO                            ||'</td>
                   <td valign="top" align="left">'     ||regRep.COLEGIO                       ||'</td>
                   <td valign="top" align="left">'     ||regRep.REGION_COL                  ||'</td>
                   <td valign="top" align="left">'     ||regRep.COMUNA_COL                 ||'</td>
                   <td valign="top" align="left">'     ||regRep.CODIGO_DEPENDENCIA                 ||'</td>
                   <td valign="top" align="left">'     ||regRep.DESC_DEPENDENCIA                 ||'</td>
                   <td valign="top" align="left">'     ||regRep.RETRACTO                 ||'</td>
                   <td valign="top" align="left">'     ||regRep.EXT                 ||'</td>
             </tr>');

       vnExists    := 1;
       vnIdRenglon := vnIdRenglon + 1;

   END LOOP;

   -- muestra el pie de reporte:
   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- omite el encabezado del reporte pero se agrega el salto de pgina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRBFIN;
/


DROP PUBLIC SYNONYM PWRBFIN;

CREATE PUBLIC SYNONYM PWRBFIN FOR BANINST1.PWRBFIN;


GRANT EXECUTE ON BANINST1.PWRBFIN TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRBFIN TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRBFIN TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRBFIN TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRBICS;

CREATE OR REPLACE PROCEDURE BANINST1.PWRBICS
(
  psReclDesc VARCHAR2
)
AS
/******************************************************************************
PROCEDIMIENTO:		PWRBICP
OBJETIVO:			Reporte Bitacora Carga Postulantes CAE
PARAMETROS:
psReclDesc			Variable estandar para la maquina de reportes custom
AUTOR:				Alejandro Gmez Mondragn
FECHA:				20131205
******************************************************************************/

	--Numero de renglones
	vnRow				PLS_INTEGER := 0;
	--Bandera para mostrar si hubo datos
	vnExists			INTEGER := 0;
	--Numero de columnas
	vnColumnas			INTEGER := 8;
	--Numero de registros
	vnRegs				INTEGER := 0;
	--Arreglo (nested table) donde se guardan los encabezados de las columnas
	tabColumna			Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
	-- la variable es una bandera que al tener el valor "imprime" no colocara
	--el salto de pgina para impresion
	vsInicoPag			VARCHAR2(10) := NULL;
	--Nmero de renglones por pgina
	vnRegsPag			PLS_INTEGER := 100;

	--Filtro de Fecha
	vdFecha				DATE;


  CURSOR cuReporte(
		pdFecha			DATE
	) IS
		SELECT
			GWBAACR_NOMBRE_ARCHIVO								AS NomArch
			,GWBAACR_TAMANO										AS Tamano
			,GWBAACR_NUM_REGISTROS								AS NumReg
			,GWBAACR_NUM_PROCESO								AS NumProc
			,GWBAACR_ACTIVITY_DATE								AS Fecha
			,GWBAACR_USER										AS Usuario
			,(SELECT
				COUNT(*)
			FROM
				TWBPCAS
			WHERE
				TWBPCAS_FILE_SEQ = GWBAACR_NUM_PROCESO
			)													AS NumOk
			,(SELECT
				COUNT(*)
			FROM
				TWRCAES
			WHERE
				TWRCAES_FILE_SEQ = GWBAACR_NUM_PROCESO
				AND TWRCAES_LOAD_STAT IN('E', 'e')
			)													AS NumErr
		FROM
			GWBAACR
		WHERE
			GWBAACR_TIPO = 'CAES'
--			AND (pdFecha IS NULL OR (GWBAACR_ACTIVITY_DATE>=pdFecha AND
--				GWBAACR_ACTIVITY_DATE < pdFecha+1))
      AND TO_DATE(GWBAACR_ACTIVITY_DATE, 'DD/MM/YYYY') = TO_DATE(pdFecha, 'DD/MM/YYYY')
		ORDER BY
			GWBAACR_ACTIVITY_DATE;

BEGIN

	--Seguridad de GWAMNUR

  IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

	--Obtengo la fecha del reporte
	vdFecha := TO_DATE(pk_objHtml.getValueCookie('psFecha'),'DD/MM/YYYY');

	-- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
	tabColumna.EXTEND(vnColumnas);

	--Guardamos los encabezados en el arreglo de columnas
	tabColumna( 1) := '<center> Archivo';
	tabColumna( 2) := '<center> Tamao';
	tabColumna( 3) := '<center> Num. Registros';
	tabColumna( 4) := '<center> Fecha';
	tabColumna( 5) := '<center> Num. Proceso';
	tabColumna( 6) := '<center> Usuario';
	tabColumna( 7) := '<center> Cargados';
	tabColumna( 8) := '<center> Rechazados';

	--Inicializamos contador de renglones
	vnRow := 0;

	FOR regReporte IN cuReporte(vdFecha) LOOP

		--Incremento el contador de renglones
		vnRow := vnRow + 1;
		vnExists := 1; --Bandera para indicar que hubo resultados

		--Si es el primer renglon de cada pgina...
		IF MOD(vnRow, vnRegsPag) = 1  THEN
			--imprimo el encabezado de reporte
			Pk_Sisrepimp.P_EncabezadoDeReporte(
				psReclDesc ,vnColumnas ,tabColumna
				,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
			);
			vsInicoPag := 'SALTO';
		END IF;

		--Comienzo a desplegar el renglon
		HTP.P('<tr>');
		HTP.P('<td>'||regReporte.NomArch||'</td>');
		HTP.P('<td>'||regReporte.Tamano||'</td>');
		HTP.P('<td>'||regReporte.NumReg||'</td>');
		HTP.P('<td>'||TO_CHAR(regReporte.Fecha, 'DD/MM/YYYY HH:MI:SS')||'</td>');
		HTP.P('<td>'||regReporte.NumProc||'</td>');
		HTP.P('<td>'||regReporte.Usuario||'</td>');
		HTP.P('<td>'||regReporte.NumOk ||'</td>');
		HTP.P('<td>'||regReporte.NumErr ||'</td>');
		--Fin del renglon
		HTP.P('</tr>');

	END LOOP;

	IF vnExists = 0 THEN
		--Ojo esta linea lo que hace es imprimir
		--NO SE ENCONTRARON DATOS o un mensaje similar
		htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
	ELSE

		-- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
		Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

		-- es omitido el encabezado del reporte pero se agrega el salto de pagina
		Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
	END IF;

	--Fin de la pagina
	htp.p('</table><br/></body></html>');
EXCEPTION
	WHEN OTHERS THEN
		--pantallazo de error.
		pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
			'PWRCRMG', NULL);
END PWRBICS;
/


DROP PUBLIC SYNONYM PWRBICS;

CREATE PUBLIC SYNONYM PWRBICS FOR BANINST1.PWRBICS;


GRANT EXECUTE ON BANINST1.PWRBICS TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRBJAC;

CREATE OR REPLACE PROCEDURE BANINST1.PWRBJAC(psReclDesc VARCHAR2) IS

/**************************************************************
           tarea:  procedimiento para el reporte de bajas
         mdulo:  registro estudiantil
           autor:  horacio martnez ramrez - hmr
           fecha:  03/sep/2010
**************************************************************/

ckNombres    owa_cookie.vc_arr;
ckValores    owa_cookie.vc_arr;
ckCount      INTEGER;
vgsInicoPag  VARCHAR2(10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
vgsUSR       VARCHAR2(500);

  vnRow         INTEGER                            := 0;
  vnExists      INTEGER                            := 0;
  vnColumnas    INTEGER                            := 8;
  tabColumna    Pk_Sisrepimp.tipoTabla             := Pk_Sisrepimp.tipoTabla(1);
  vsPerio       SIBINST.SIBINST_TERM_CODE_EFF%TYPE := NULL;
  vsUniv        VARCHAR2(20)                       := NULL;
  vsSstst       STVSTST.STVSTST_CODE%TYPE          := NULL;
  vsProgr       SMRPRLE.SMRPRLE_PROGRAM_DESC%TYPE  := NULL;
  vsPrepa       STVSBGI.STVSBGI_DESC%TYPE          := NULL;
  vsSeccion     VARCHAR2(3)                        := NULL;
  vnRegs        INTEGER                            := 0;
  vsPeriodo     VARCHAR2(20)                       := NULL;
  vsMotivo      SFRWDRL.SFRWDRL_COMMENT%TYPE       := NULL;

  CURSOR cuReporte(psPerio   VARCHAR2 DEFAULT NULL,
                            psUniv    VARCHAR2 DEFAULT NULL,
                            psProgr   VARCHAR2 DEFAULT NULL ) IS

         SELECT DISTINCT A.SGBSTDN_TERM_CODE_EFF                                       Periodo,
                NVL(A.SGBSTDN_CAMP_CODE,'S/Unive')                                     CveUniversidad,
                A.SGBSTDN_PROGRAM_1                                                    CvePrograma,
                Pk_Catalogo.PROGRAMA(A.SGBSTDN_PROGRAM_1)                              DescPrograma,
                SPRIDEN_PIDM                                                           Pidm,
                SPRIDEN_ID                                                             Id,
                Pk_Catalogo.NOMBRE(SPRIDEN_PIDM)                                       Nombre,
                SGBSTDN_STST_CODE                                                      CveBaja,
                SGBSTDN_RATE_CODE                                                      Site,
                SPBPERS_NAME_SUFFIX                                                    Rut,
                Pk_Catalogo.TIPOBAJA(SGBSTDN_STST_CODE)                                DescBaja,
                DECODE(UPPER(SPBPERS_SEX),'F','Femenino','M','Masculino',NULL)         Sexo
           FROM SGBSTDN A,
                SPRIDEN,
                SPBPERS
          WHERE SPRIDEN_PIDM            = A.SGBSTDN_PIDM
            AND A.SGBSTDN_PIDM          = SPBPERS_PIDM
            AND SPRIDEN_CHANGE_IND     IS NULL
            AND A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                             FROM SGBSTDN B
                                            WHERE B.SGBSTDN_PIDM           = A.SGBSTDN_PIDM
                                              AND B.SGBSTDN_TERM_CODE_EFF <= A.SGBSTDN_TERM_CODE_EFF
                                          )
            AND (A.SGBSTDN_TERM_CODE_EFF = psPerio OR psPerio IS NULL)
            AND (A.SGBSTDN_CAMP_CODE     = psUniv  OR psUniv  IS NULL)
            AND (A.SGBSTDN_PROGRAM_1     = psProgr OR psProgr IS NULL)
            AND SGBSTDN_STST_CODE IN ('BA', 'BC', 'BD', 'BF', 'BI', 'BP', 'BV', 'BM')
         ORDER BY PERIODO DESC, DESCPROGRAMA, NOMBRE;

  BEGIN
      /* check/update the user's web session */
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      -- son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
         FOR vnCOKIES IN 1..ckCount LOOP
             IF    ckNOMBRES(vnCOKIES) = 'psPerio' THEN
                   vsPerio := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psUnive' THEN
                   vsUniv  := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psProgr' THEN
                   vsProgr := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                   vsSeccion := ckValores(vnCOKIES);

             END IF;
         END LOOP;
      END IF;

      -- las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1) := 'ID';
      tabColumna(2) := 'Rut';
      tabColumna(3) := 'Nombre';
      tabColumna(4) := 'Sexo';
      tabColumna(5) := 'Programa';
      tabColumna(6) := 'Descripcin';
      tabColumna(7) := 'Tipo de baja';
      tabColumna(8) := 'Motivo';

      FOR regRep IN cuReporte(vsPerio, vsUniv, vsProgr) LOOP

          -- obtener motivo de baja
          BEGIN
             SELECT SFRWDRL_COMMENT
                INTO vsMotivo
               FROM SFRWDRL
              WHERE SFRWDRL_PIDM = regRep.Pidm
                  AND SFRWDRL_TERM_CODE  = regRep.Periodo;
          EXCEPTION
               WHEN NO_DATA_FOUND THEN
                        vsMotivo:= NULL;
               WHEN OTHERS THEN
                        vsMotivo:= NULL;
          END;

          IF vsPeriodo IS NULL OR vsPeriodo <> regRep.Periodo OR
             vsUniv    IS NULL OR vsUniv    <> regRep.CveUniversidad OR
             vnRow = 30 THEN

             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vgsInicoPag,'1',psSubtitulo=>'Periodo '||regRep.Periodo||'<br/>'||pk_Catalogo.fStvSite(regRep.SITE),psUsuario=>vgsUSR,psSeccion=>vsSeccion,psUniversidad=>regRep.CveUniversidad);
             vgsInicoPag := 'SALTO';

             vnRow  := 0;
          END IF;

          htp.p('<tr><td valign="top">'||regRep.ID          ||'</td>
                         <td valign="top">'||regRep.Rut          ||'</td>
                         <td valign="top">'||regRep.Nombre      ||'</td>
                         <td valign="top">'||regRep.Sexo        ||'</td>
                         <td valign="top">'||regRep.CvePrograma ||'</td>
                         <td valign="top">'||regRep.DescPrograma||'</td>
                         <td valign="top">'||regRep.DescBaja    ||'</td>
                         <td valign="top">'||vsMotivo           ||'</td></tr>'   );

          vnExists  := 1;
          vnRow     := vnRow + 1;
          vsUniv    := regRep.CveUniversidad;
          vsPeriodo := regRep.Periodo;
      END LOOP;

      IF vnExists = 0 THEN
          htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>vgsUSR, psSeccion=>vsSeccion);
      END IF;

      htp.p('</table></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           htp.p(SQLERRM);

  END PWRBJAC;
/


DROP PUBLIC SYNONYM PWRBJAC;

CREATE PUBLIC SYNONYM PWRBJAC FOR BANINST1.PWRBJAC;


GRANT EXECUTE ON BANINST1.PWRBJAC TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRBJAC TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRBJMA;

CREATE OR REPLACE PROCEDURE BANINST1.PWRBJMA(psReclDesc VARCHAR2) IS

/**************************************************************
           tarea:  procedimiento para el reporte de baja de materias
         mdulo:  seleccin de cursos
           autor:  horacio martnez ramrez - hmr
           fecha:  06/sep/2010
                   5/jun/2013 se agregan columnas(fecha modif, usuario)
                              y cambia un parmetro
**************************************************************/

  vnRow      INTEGER                := 0;
  vnExists   INTEGER                := 0;
  vnColumnas INTEGER                := 10;
  tabColumna Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vsPerio    VARCHAR2(10)           := NULL;
  vsSede     VARCHAR2(10)           := NULL;
  vsUniv     VARCHAR2(10)           := NULL;
  vsProgr    VARCHAR2(20)           := NULL;
  vsStIns    VARCHAR2(20)           := NULL;
  vsStCur    VARCHAR2(20)           := NULL;
  vsSeccion  VARCHAR2(3)            := NULL;
  vsTermCode VARCHAR2(10)           := NULL;
  vsCampCode VARCHAR2(10)           := NULL;
  vsNrc      VARCHAR2(1000)         := NULL;
  vsInicoPag VARCHAR2(10)           := NULL;
  vsEncabezado VARCHAR2(1)          := NULL;
  vbEncabezado BOOLEAN                        := TRUE;

  CURSOR cuReporte(psUniv   VARCHAR2 DEFAULT NULL,
                   psPerio  VARCHAR2 DEFAULT NULL,
                   psProgr  VARCHAR2 DEFAULT NULL,
                   psStCur  VARCHAR2 DEFAULT NULL) IS
         SELECT DISTINCT SFRSTCR_TERM_CODE                                                termCode,
                Pk_Catalogo.PERIODO(SFRSTCR_TERM_CODE)                                    Descperiodo,
                NVL(SGBSTDN_CAMP_CODE,'S/Unive')                                          campCode,
                SFBETRM_ESTS_CODE                                                         CveInscripcion,
                (SELECT STVESTS_DESC FROM STVESTS WHERE STVESTS_CODE = SFBETRM_ESTS_CODE) DescInscripcion,
                SGBSTDN_PROGRAM_1                                                         CvePrograma,
                Pk_Catalogo.PROGRAMA(SGBSTDN_PROGRAM_1)                                   DescPrograma,
                SPRIDEN_PIDM                                                              Pidm,
                SPRIDEN_ID                                                                Id,
                SPBPERS_NAME_SUFFIX                                                       Rut,
                Pk_Catalogo.NOMBRE(SPRIDEN_PIDM)                                          Nombre,
                SFRSTCR_RSTS_CODE                                                         StatNRC,
                to_char(SFRSTCR_ACTIVITY_DATE,'dd-mon-yyyy hh24:mi')                      FecModif,
                SFRSTCR_USER                                                              Usuario
           FROM SGBSTDN A,
                SPRIDEN,
                SFRSTCR,
                SFBETRM,
                SPBPERS
          WHERE SPRIDEN_PIDM            = A.SGBSTDN_PIDM
            AND SPRIDEN_CHANGE_IND     IS NULL
            AND A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                             FROM SGBSTDN B
                                            WHERE B.SGBSTDN_PIDM           = A.SGBSTDN_PIDM
                                              AND B.SGBSTDN_TERM_CODE_EFF <= SFRSTCR_TERM_CODE
                                          )
            AND SFRSTCR_PIDM            = SPRIDEN_PIDM
            AND SFRSTCR_RSTS_CODE      IN (SELECT STVRSTS_CODE
                                             FROM STVRSTS
                                            WHERE STVRSTS_CODE         = SFRSTCR_RSTS_CODE
                                              AND STVRSTS_WITHDRAW_IND = 'Y'
                                          )
            AND SFRSTCR_TERM_CODE      = SFBETRM_TERM_CODE(+)
            AND SFRSTCR_PIDM           = SFBETRM_PIDM(+)
            AND SGBSTDN_PIDM           = SPBPERS_PIDM(+)
            AND (SFRSTCR_TERM_CODE     = psPerio  OR psPerio  IS NULL)
            AND (SGBSTDN_CAMP_CODE     = psUniv   OR psUniv   IS NULL)
            AND (SGBSTDN_PROGRAM_1     = psProgr  OR psProgr  IS NULL)
            AND (SFRSTCR_RSTS_CODE     = psStCur  OR psStCur  IS NULL)
          ORDER BY termCode DESC, DESCPROGRAMA, NOMBRE;

  -- cursor para obtener los nrc's
  CURSOR cuNRC (psPerio VARCHAR2,
                psPidm  VARCHAR2,
                psStCur VARCHAR2 DEFAULT NULL) IS
         SELECT SFRSTCR_CRN AS NRC
           FROM SFRSTCR
          WHERE SFRSTCR_RSTS_CODE IN (SELECT STVRSTS_CODE
                                        FROM STVRSTS
                                       WHERE STVRSTS_CODE         = SFRSTCR_RSTS_CODE
                                         AND STVRSTS_WITHDRAW_IND = 'Y'
                                     )
              AND SFRSTCR_TERM_CODE  = psPerio
              AND SFRSTCR_PIDM       = psPidm
              and (SFRSTCR_RSTS_CODE = psStCur  OR psStCur  IS NULL);

  BEGIN
      /* check/update the user's web session */
      IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN  RETURN; END IF;

      vsUniv       := pk_ObjHtml.getValueCookie('psUnive');
      vsPerio      := pk_ObjHtml.getValueCookie('psPerio');
      vsProgr      := pk_ObjHtml.getValueCookie('psProgr');
      vsStCur      := pk_ObjHtml.getValueCookie('psStCur');
      vsEncabezado := pk_objruahtml.getValueCookie('psEnca');
      vsSeccion    := pk_ObjHtml.getValueCookie('cookSeccion');

      -- las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
            tabColumna.EXTEND(vnI);
            --tabsubcolu.extend(vni);
            tabColumna(vnI) := NULL;
            --tabsubcolu(vni) := null;
      END LOOP;



      tabColumna(1) := 'Status de inscripci&oacute;n';
      tabColumna(2) := 'Programa';
      tabColumna(3) := 'Descripci&oacute;n';
      tabColumna(4) := 'Id';
      tabColumna(5) := 'Rut';
      tabColumna(6) := 'Nombre';
      tabColumna(7) := 'Materias dadas de baja';
      tabColumna(8) := 'Status NRC';
      tabColumna(9) := 'Fecha Modificacin';
      tabColumna(10):= 'Modific Usuario';

      FOR regRep IN cuReporte(vsUniv, vsPerio, vsProgr, vsStCur) LOOP

          IF (vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
              vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR vnRow = 25) AND vbEncabezado THEN --AND vbEncabezado

              Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicoPag,'1',psSubtitulo=>'<br>Periodo '||regRep.termCode,psUsuario=>pk_login.vgsUSR,psSeccion=>vsSeccion,psUniversidad=>regRep.campCode);

              vsInicoPag := 'SALTO';
              vnRow := 0;

          END IF;

      IF vsEncabezado = 'N' THEN
         vbEncabezado := FALSE;
      END IF;

          vsNrc := NULL;

          FOR i IN cuNRC (regRep.termCode,regRep.Pidm,vsStCur) LOOP
              IF vsNrc IS NULL THEN
                  vsNrc := i.Nrc;
              ELSE
                  vsNrc := vsNrc || ', ' || i.Nrc;
              END IF;
          END LOOP;

          htp.p('<tr><td valign="top">'||regRep.DescInscripcion||'</td>
                         <td valign="top">'||regRep.CvePrograma||'</td>
                         <td valign="top">'||regRep.DescPrograma||'</td>
                         <td valign="top">'||regRep.Id||'</td>
                         <td valign="top">'||regRep.Rut||'</td>
                         <td valign="top">'||regRep.Nombre||'</td>
                         <td valign="top">'||vsNrc||'</td>
                         <td valign="top">'||regRep.StatNRC||'</td>
                         <td valign="top">'||regRep.FecModif||'</td>
                         <td valign="top">'||regRep.Usuario||'</td></tr>' );

          vnExists   := 1;
          vnRow      := vnRow + 1;
          vsTermCode := regRep.termCode;
          vsCampCode := regRep.campCode;
      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pgina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR, psSeccion=>vsSeccion);
      END IF;

      htp.p('</table></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
               HTP.P(SQLERRM);

  END PWRBJMA;
/


DROP PUBLIC SYNONYM PWRBJMA;

CREATE PUBLIC SYNONYM PWRBJMA FOR BANINST1.PWRBJMA;


GRANT EXECUTE ON BANINST1.PWRBJMA TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRBJMA TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRBLOQ;

CREATE OR REPLACE PROCEDURE BANINST1.PWRBLOQ(psReclDesc VARCHAR2) IS
/*
         Tarea: REPORTE DE BLOQUES
        Modulo: Programacin academica
         Fecha: 19/01/2006.
         Autor: GEPC

  Modificacin: 29/10/2008
                GEPC
                1. Incluir la columna "Edificio"
                2. Incluir la columna "Parte de periodo"

*/

ckNombres   owa_cookie.vc_arr;
ckValores   owa_cookie.vc_arr;
ckCount     INTEGER;
vgsInicoPag VARCHAR2(10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
vgsUSR      VARCHAR2(500);

  vnExists   INTEGER                := 0;
  vnColumnas INTEGER                := 22;
  tabColumna Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vsPerio    VARCHAR2(100)          := NULL;
  vsFacu     VARCHAR2(100)          := NULL;

  vsSeccion  VARCHAR2(3)            := NULL;
  vsBloque   VARCHAR2(10)           := NULL;

  CURSOR cuReporte(psTerm   VARCHAR2 DEFAULT NULL,
                   psFacu   VARCHAR2 DEFAULT NULL,
                   psBloque VARCHAR2 DEFAULT NULL) IS
         SELECT DISTINCT SE.SSBSECT_TERM_CODE                       PERIODO,
                NVL(SSBSECT_CAMP_CODE,'S/Univ')                     UNIVERSIDAD,
                SCBCRSE_COLL_CODE                                   CVE_ESCUELA,
                Pk_Catalogo.COLEGIO(SCBCRSE_COLL_CODE)              ESCUELA,
                SSRBLCK_BLCK_CODE                                   BLOQUE,
                SSRMEET_BLDG_CODE                                   EDIFICIO,
                SSRMEET_ROOM_CODE                                   SALON,
                SSBSECT_CRN                                         NRC,
                SCBCRSE_SUBJ_CODE                                   MATERIA,
                SCBCRSE_CRSE_NUMB                                   CURSO,
                SCBCRSE_TITLE                                       NOMBRE,
                SSBSECT_PTRM_CODE||' '||
                TO_CHAR(SSBSECT_PTRM_START_DATE,'DD/MM/YY')||' '||
                TO_CHAR(SSBSECT_PTRM_END_DATE,'DD/MM/YY')||' '||
                SSBSECT_PTRM_WEEKS                                  Ptrm,
                DECODE(SSRMEET_MON_DAY, 'M', 'Lu', SSRMEET_MON_DAY) LU,
                DECODE(SSRMEET_TUE_DAY, 'T', 'Ma', SSRMEET_TUE_DAY) MA,
                DECODE(SSRMEET_WED_DAY, 'W', 'Mi', SSRMEET_WED_DAY) MI,
                DECODE(SSRMEET_THU_DAY, 'R', 'Ju', SSRMEET_THU_DAY) JU,
                DECODE(SSRMEET_FRI_DAY, 'F', 'Vi', SSRMEET_FRI_DAY) VI,
                DECODE(SSRMEET_SAT_DAY, 'S', 'Sa', SSRMEET_SAT_DAY) SA,
                DECODE(SSRMEET_SUN_DAY, 'U', 'Do', SSRMEET_SUN_DAY) DI,
                SSRMEET_START_DATE                                  FECHA_INICIO,
                SSRMEET_END_DATE                                    FECHA_FIN,
                SUBSTR(SSRMEET_BEGIN_TIME,1,2)||':'||
                       NVL(SUBSTR(SSRMEET_BEGIN_TIME,3,2),'00')     INICIO,
                SUBSTR(SSRMEET_END_TIME,1,2)||':'||
                       NVL(SUBSTR(SSRMEET_END_TIME,3,2),'00')       FIN,
                Pk_Catalogo.STATUS_1(SSBSECT_SSTS_CODE)             STATUS,
                SSBSECT_MAX_ENRL                                    CUPO,
                SSBSECT_ENRL                                        INSCRITOS,
                SSRMEET_CATAGORY                                    CATEGORIA,
                SSRMEET_BLDG_CODE                                   bldgCode
           FROM SSBSECT SE,
                SCBCRSE SC,
                SSRBLCK SS,
                SSRMEET SR
          WHERE SCBCRSE_EFF_TERM  = (SELECT MAX(SCBCRSE_EFF_TERM)
                                       FROM SCBCRSE A
                                      WHERE A.SCBCRSE_EFF_TERM  <= SE.SSBSECT_TERM_CODE
                                        AND A.SCBCRSE_SUBJ_CODE  = SE.SSBSECT_SUBJ_CODE
                                        AND A.SCBCRSE_CRSE_NUMB  = SE.SSBSECT_CRSE_NUMB
                                    )
            AND SSBSECT_SUBJ_CODE  = SCBCRSE_SUBJ_CODE
            AND SSBSECT_CRSE_NUMB  = SCBCRSE_CRSE_NUMB
            AND SSBSECT_TERM_CODE  = SSRBLCK_TERM_CODE
            AND SSBSECT_CRN        = SSRBLCK_CRN
            AND SSBSECT_TERM_CODE  = SSRMEET_TERM_CODE
            AND SSBSECT_CRN        = SSRMEET_CRN
            AND (SSBSECT_TERM_CODE = psTerm   OR psTerm   IS NULL)
            AND (SCBCRSE_COLL_CODE = psFacu   OR psFacu   IS NULL)
            AND (SSRBLCK_BLCK_CODE = psBloque OR psBloque IS NULL)
            AND NOT EXISTS (SELECT NULL
                              FROM SWRXLST
                             WHERE SWRXLST_TERM_CODE = SSBSECT_TERM_CODE
                               AND SWRXLST_CRN       = SSBSECT_CRN
                               AND SWRXLST_TYPE      = 'S'
                           )
          ORDER BY PERIODO DESC, BLOQUE, NOMBRE;

  --  Para obtener el CRN's empalmado
  CURSOR cuCrn(psTerCod VARCHAR2 DEFAULT NULL,
               psCrn    VARCHAR2 DEFAULT NULL,
               psBloque VARCHAR2 DEFAULT NULL,
               psFacu   VARCHAR2 DEFAULT NULL,
               psCateg  VARCHAR2 DEFAULT NULL
               ) IS
         SELECT DISTINCT B.SSBSECT_CRN
           FROM SSBSECT A,
                SSRMEET C,
                (SELECT DISTINCT SE.SSBSECT_TERM_CODE,
                        SSBSECT_CRN,
                        SSRMEET_MON_DAY,
                        SSRMEET_TUE_DAY,
                        SSRMEET_WED_DAY,
                        SSRMEET_THU_DAY,
                        SSRMEET_FRI_DAY,
                        SSRMEET_SAT_DAY,
                        SSRMEET_SUN_DAY,
                        SSRMEET_BEGIN_TIME,
                        SSRMEET_END_TIME,
                        SSRMEET_START_DATE,
                        SSRMEET_END_DATE,
                        SSRMEET_CATAGORY
                   FROM SSBSECT SE,
                        SCBCRSE SC,
                        SSRBLCK SS,
                        SSRMEET SR
                  WHERE SSBSECT_TERM_CODE = psTerCod
                    AND SCBCRSE_EFF_TERM  = (SELECT MAX(SCBCRSE_EFF_TERM)
                                               FROM SCBCRSE A
                                              WHERE A.SCBCRSE_EFF_TERM  <= SE.SSBSECT_TERM_CODE
                                                AND A.SCBCRSE_SUBJ_CODE  = SE.SSBSECT_SUBJ_CODE
                                                AND A.SCBCRSE_CRSE_NUMB  = SE.SSBSECT_CRSE_NUMB
                                            )
                    AND SSBSECT_SUBJ_CODE  = SCBCRSE_SUBJ_CODE
                    AND SSBSECT_CRSE_NUMB  = SCBCRSE_CRSE_NUMB
                    AND SSBSECT_TERM_CODE  = SSRBLCK_TERM_CODE
                    AND SSBSECT_CRN        = SSRBLCK_CRN
                    AND SSBSECT_TERM_CODE  = SSRMEET_TERM_CODE
                    AND SSBSECT_CRN        = SSRMEET_CRN
                    AND (SSBSECT_TERM_CODE = psTerCod OR psTerCod IS NULL)
                    AND (SCBCRSE_COLL_CODE = psFacu   OR psFacu IS NULL)
                    AND (SSRBLCK_BLCK_CODE = psBloque OR psBloque IS NULL)
                    AND NOT EXISTS (SELECT NULL
                                      FROM SWRXLST
                                     WHERE SWRXLST_TERM_CODE = SSBSECT_TERM_CODE
                                       AND SWRXLST_CRN       = SSBSECT_CRN
                                       AND SWRXLST_TYPE      = 'S'
                                   )
                ) B
          WHERE A.SSBSECT_TERM_CODE = psTerCod
            AND A.SSBSECT_CRN = psCrn
            AND C.SSRMEET_TERM_CODE = A.SSBSECT_TERM_CODE
            AND C.SSRMEET_CRN = A.SSBSECT_CRN
            AND C.SSRMEET_CATAGORY = psCateg
            AND (
                 (B.SSBSECT_CRN <> C.SSRMEET_CRN AND B.SSRMEET_CATAGORY <> C.SSRMEET_CATAGORY)
                 OR
                 (B.SSBSECT_CRN <> C.SSRMEET_CRN)
                )
            AND (C.SSRMEET_MON_DAY = B.SSRMEET_MON_DAY OR
                 C.SSRMEET_TUE_DAY = B.SSRMEET_TUE_DAY OR
                 C.SSRMEET_WED_DAY = B.SSRMEET_WED_DAY OR
                 C.SSRMEET_THU_DAY = B.SSRMEET_THU_DAY OR
                 C.SSRMEET_FRI_DAY = B.SSRMEET_FRI_DAY OR
                 C.SSRMEET_SAT_DAY = B.SSRMEET_SAT_DAY OR
                 C.SSRMEET_SUN_DAY = B.SSRMEET_SUN_DAY
                )
            AND (
                 C.SSRMEET_BEGIN_TIME BETWEEN B.SSRMEET_BEGIN_TIME AND B.SSRMEET_END_TIME
                 OR
                 C.SSRMEET_END_TIME   BETWEEN B.SSRMEET_BEGIN_TIME AND B.SSRMEET_END_TIME
                )
            AND (
                 C.SSRMEET_START_DATE BETWEEN B.SSRMEET_START_DATE AND B.SSRMEET_END_DATE
                 OR
                 C.SSRMEET_END_DATE BETWEEN B.SSRMEET_START_DATE AND B.SSRMEET_END_DATE
                )
            AND NOT EXISTS (SELECT NULL
                              FROM SWRXLST
                             WHERE SWRXLST_TERM_CODE = A.SSBSECT_TERM_CODE
                               AND SWRXLST_CRN       = A.SSBSECT_CRN
                               AND SWRXLST_TYPE      = 'S'
                           );

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
         FOR vnCOKIES IN 1..ckCount LOOP

            IF ckNOMBRES(vnCOKIES) = 'psPerio' THEN
                   vsPerio := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                   vsFacu := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psBlock' THEN
                   vsBloque := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                   vsSeccion := ckValores(vnCOKIES);

             END IF;
         END LOOP;
      END IF;

      -- Las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := 'Escuela';
      tabColumna(2)  := 'NRC';
      tabColumna(3)  := 'Materia';
      tabColumna(4)  := 'Curso';
      tabColumna(5)  := 'Nombre';
      tabColumna(6)  := 'Parte de periodo';
      tabColumna(7)  := 'Lu';
      tabColumna(8)  := 'Ma';
      tabColumna(9)  := 'Mi';
      tabColumna(10) := 'Ju';
      tabColumna(11) := 'Vi';
      tabColumna(12) := 'Sa';
      tabColumna(13) := 'Fecha inicio';
      tabColumna(14) := 'Fecha fin';
      tabColumna(15) := 'Hora inicio';
      tabColumna(16) := 'Hora fin';
      tabColumna(17) := 'Bloque';
      tabColumna(18) := 'Empalme';
      tabColumna(19) := 'Cupo m&aacute;ximo';
      tabColumna(20) := 'Inscritos';
      tabColumna(21) := 'Edificio';
      tabColumna(22) := 'Sal&oacute;n';

      FOR regRep IN cuReporte(vsPerio, vsFacu, vsBloque) LOOP
          IF vnExists = 0 THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,vgsInicoPag,'1', psSubtitulo=>'Periodo '||regRep.Periodo, psUsuario=>vgsUSR, psSeccion=>vsSeccion, psSinLogo=>'sin');
             vgsInicoPag := 'SALTO';

          END IF;

          htp.p('<tr>
          <td valign="top" align="left">'  ||regRep.Escuela     ||'</td>
          <td valign="top" align="left">'  ||regRep.NRC         ||'</td>
          <td valign="top" align="left">'  ||regRep.Materia     ||'</td>
          <td valign="top" align="left">'  ||regRep.Curso       ||'</td>
          <td valign="top" align="left">'  ||regRep.Nombre      ||'</td>
          <td valign="top" align="left">'  ||regRep.Ptrm        ||'</td>
          <td valign="top" align="center">'||regRep.Lu          ||'</td>
          <td valign="top" align="center">'||regRep.Ma          ||'</td>
          <td valign="top" align="center">'||regRep.Mi          ||'</td>
          <td valign="top" align="center">'||regRep.Ju          ||'</td>
          <td valign="top" align="center">'||regRep.Vi          ||'</td>
          <td valign="top" align="center">'||regRep.Sa          ||'</td>
          <td valign="top" align="center">'||regRep.Fecha_Inicio||'</td>
          <td valign="top" align="center">'||regRep.Fecha_Fin   ||'</td>
          <td valign="top" align="center">'||regRep.Inicio      ||'</td>
          <td valign="top" align="center">'||regRep.Fin         ||'</td>
          <td valign="top" align="left">'  ||regRep.Bloque      ||'</td>
          <td valign="top">
          ');

          FOR regDatos IN cuCRN(regRep.Periodo,regRep.nrc,regRep.Bloque,regRep.CVE_ESCUELA,regRep.CATEGORIA) LOOP
              htp.p(regDatos.SSBSECT_CRN||'<BR>');
          END LOOP;

          htp.p('</td>
          <td valign="top">'||regRep.Cupo     ||'</td>
          <td valign="top">'||regRep.Inscritos||'</td>
          <td valign="top">'||regRep.bldgCode ||'</td>
          <td valign="top">'||regRep.Salon    ||'</td>
          </tr>
          ');

          vnExists := 1;
      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      END IF;

      htp.p('</table><br/></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           htp.p(SQLERRM);

  END PWRBLOQ;
/


DROP PUBLIC SYNONYM PWRBLOQ;

CREATE PUBLIC SYNONYM PWRBLOQ FOR BANINST1.PWRBLOQ;


GRANT EXECUTE ON BANINST1.PWRBLOQ TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRBLOQ TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCACE;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCACE(psReclDesc VARCHAR2) IS

/*
        Nombre: Reporte de calificaciones de los alumnos por criterio de evaluacin
         Fecha: 20/10/2011.
         Autor: MAC
*/

    vgsInicoPag  VARCHAR2(10) := null;

    vsNRC          VARCHAR2(10)  := NULL;
    vnExists       INTEGER       := 0;
    vnColumnas     INTEGER       := 13;
    tabColumna     PK_sisRepImp.tipoTabla := PK_sisRepImp.tipoTabla(1);

    vsCamp         VARCHAR2(10)  := NULL;
    vsTerm         VARCHAR2(10)  := NULL;
    vsCrn          VARCHAR2(10)  := NULL;
    vsAlum         VARCHAR2(10)  := NULL;
    vsCrit         VARCHAR2(10)  := NULL;
    vsEscu         VARCHAR2(10)  := NULL;
    vsNomEsc       VARCHAR2(30)  := NULL;
    vsNClave       VARCHAR2(100) := NULL;
    vsClave        VARCHAR2(10)  := NULL;
    vnID           NUMBER(8)     := 0;

    csEsp          CONSTANT      VARCHAR2(1) := ' ';
    csRE           CONSTANT      VARCHAR2(2) := 'RE';
    csRW           CONSTANT      VARCHAR2(2) := 'RW';
    csAS           CONSTANT      VARCHAR2(2) := 'AS';


  CURSOR cuReporte(psCamp   VARCHAR2,
                   psTerm   VARCHAR2,
                   psCrnAu  VARCHAR2,
                   psAlumE  NUMBER,
                   psCrit   VARCHAR2,
                   psEscu   VARCHAR2) IS
            SELECT SFRSTCR_TERM_CODE             PERIODO,
                   SFRSTCR_CAMP_CODE             UNIVERSIDAD,
                   SPRIDEN_ID                    ID,
                   SPRIDEN_LAST_NAME||csEsp||SPRIDEN_FIRST_NAME||csEsp||SPRIDEN_MI NOMBRE,
                   F_GET_RUT(SPRIDEN_PIDM)       RUT,
                   SGBSTDN_PROGRAM_1             PROGRAMA,
                   SFRSTCR_CRN                   NRC,
                   SSBSECT_SUBJ_CODE             SUBJ,
                   SSBSECT_CRSE_NUMB             COURSE,
                   SCBCRSE_TITLE                 NOMBRE_MATERIA,
                   SHRGCOM_NAME||SHRGCOM_SEQ_NO  CVE_CRITERIO,
                   SHRGCOM_SEQ_NO                SECUENCIA,
                   SHRGCOM_NAME                  CLAVE,
                   SHRMRKS_GRDE_CODE             CALIFICACION
              FROM SFRSTCR
             INNER JOIN SGBSTDN S1
                ON SGBSTDN_PIDM      =  SFRSTCR_PIDM
              LEFT JOIN SHRMRKS
                ON SHRMRKS_TERM_CODE = SFRSTCR_TERM_CODE
               AND SHRMRKS_CRN       = SFRSTCR_CRN
               AND SHRMRKS_PIDM      = SGBSTDN_PIDM
              LEFT JOIN SHRGCOM
                ON SHRGCOM_TERM_CODE = SFRSTCR_TERM_CODE
               AND SHRGCOM_CRN       = SHRMRKS_CRN
               AND SHRGCOM_ID        = SHRMRKS_GCOM_ID
             INNER JOIN SPRIDEN
                ON SPRIDEN_PIDM = SGBSTDN_PIDM
               AND SPRIDEN_CHANGE_IND IS NULL
             INNER JOIN SSBSECT
                ON SSBSECT_TERM_CODE = SFRSTCR_TERM_CODE
               AND SSBSECT_CRN       = SFRSTCR_CRN
             INNER JOIN SCBCRSE Q1
                ON SCBCRSE_SUBJ_CODE     = SSBSECT_SUBJ_CODE
               AND SCBCRSE_CRSE_NUMB     = SSBSECT_CRSE_NUMB
               AND SCBCRSE_EFF_TERM      = (SELECT MAX( Q2.SCBCRSE_EFF_TERM )
                                              FROM SCBCRSE Q2
                                             WHERE Q2.SCBCRSE_SUBJ_CODE = Q1.SCBCRSE_SUBJ_CODE
                                               AND Q2.SCBCRSE_CRSE_NUMB = Q1.SCBCRSE_CRSE_NUMB
                                           )
             WHERE SFRSTCR_TERM_CODE     = PSTERM
               AND SFRSTCR_CAMP_CODE     = PSCAMP
               AND SCBCRSE_COLL_CODE     = PSESCU
               AND SFRSTCR_RSTS_CODE    IN (csRW,csRE)
               AND SGBSTDN_TERM_CODE_EFF = (SELECT MAX(S2.SGBSTDN_TERM_CODE_EFF)
                                              FROM SGBSTDN S2
                                             WHERE S2.SGBSTDN_PIDM           = S1.SGBSTDN_PIDM
                                               AND S2.SGBSTDN_TERM_CODE_EFF <= SFRSTCR_TERM_CODE
                                           )
               AND SGBSTDN_STST_CODE     = csAS
               AND (SHRGCOM_NAME         = PSCRIT  OR PSCRIT IS NULL)
               AND (SPRIDEN_PIDM         = PSALUME OR PSALUME IS NULL)
               AND (SFRSTCR_CRN          = PSCRNAU OR PSCRNAU IS NULL)
             ORDER BY NRC, NOMBRE;

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.

      vsCamp := pk_objHtml.getValueCookie('psUnive');
      vsTerm := pk_objHtml.getValueCookie('psPerio');
      vsCrn  := pk_objHtml.getValueCookie('psCrnAu');
      vsAlum := pk_objHtml.getValueCookie('psAlumE');
      vsCrit := pk_objHtml.getValueCookie('psCrit');
      vsEscu := pk_objHtml.getValueCookie('psEscu');

      BEGIN
          SELECT spriden_pidm
            INTO vnId
            FROM spriden
           WHERE spriden_id = vsAlum
             and spriden_change_ind is null;

      EXCEPTION
          WHEN NO_DATA_FOUND THEN
          vnId := NULL;
      END;

      BEGIN
          SELECT STVCOLL_DESC
            INTO vsNomEsc
            FROM STVCOLL
           WHERE STVCOLL_CODE = vsEscu;
      EXCEPTION
          WHEN NO_DATA_FOUND THEN
          vsNomEsc := NULL;
      END;

      -- las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := 'Periodo';
      tabColumna(2)  := 'ID';
      tabColumna(3)  := 'Nombre';
      tabColumna(4)  := 'RUT';
      tabColumna(5)  := 'Programa';
      tabColumna(6)  := 'Escuela';
      tabColumna(7)  := 'NRC';
      tabColumna(8)  := 'Subj';
      tabColumna(9)  := 'Course';
      tabColumna(10)  := 'Nombre materia';
      tabColumna(11) := 'Clave criterio';
      tabColumna(12) := 'Descripci&oacute;n criterio';
      tabColumna(13) := 'Calificaci&oacute;n';


      FOR regRep IN cuReporte(vsCamp,vsTerm,vsCrn,vnId,vsCrit,vsEscu) LOOP

          IF vsNRC IS NULL THEN
              PK_sisRepImp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vgsInicoPag,'1',psSubtitulo=>'Periodo '||vsTerm,psUsuario=>pk_login.vgsUSR,psSeccion=>'3',psUniversidad=>regRep.UNIVERSIDAD);
 --             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna, vsInicoPag,'1',psSubtitulo=>'Sede: '||NVL(pk_catalogo.fstvrate(regRep.rateCode),'sin Sede')||'<br>Periodo '||regRep.termCode,psUsuario=>pk_login.vgsUSR,psSeccion=>vsSeccion,psUniversidad=>regRep.campCode);
               vgsInicoPag := 'SALTO';
          END IF;

          IF regRep.Clave <> vsClave OR vsClave IS NULL THEN
              BEGIN
                  SELECT SWVCOMP_DESC
                  INTO vsNClave
                  FROM SWVCOMP
                  WHERE SWVCOMP_CODE = regRep.Clave;
              EXCEPTION
              WHEN NO_DATA_FOUND THEN
                  vsNClave := NULL;
              END;
          END IF;

           htp.p('<tr>
            <td  width="5%"  valign="top">'||regRep.Periodo        ||'</td>
            <td  width="5%"  valign="top">'||regRep.ID             ||'</td>
            <td  width="20%" valign="top">'||regRep.Nombre         ||'</td>
            <td  width="8%"  valign="top">'||regRep.RUT            ||'</td>
            <td  width="8%"  valign="top">'||regRep.Programa       ||'</td>
            <td  width="10%" valign="top">'||vsNomEsc              ||'</td>
            <td  width="5%"  valign="top">'||regRep.NRC            ||'</td>
            <td  width="5%"  valign="top">'||regRep.Subj           ||'</td>
            <td  width="5%"  valign="top">'||regRep.Course         ||'</td>
            <td  width="15%" valign="top">'||regRep.Nombre_materia ||'</td>
            <td  width="5%"  valign="top">'||regRep.Cve_criterio   ||'</td>
            <td  width="12%" valign="top">'||vsNClave||' '||regRep.Secuencia ||'</td>
            <td  width="5%"  valign="top">'||regRep.Calificacion   ||'</td>
            </tr>');

          vnExists := 1;
          vsClave  := regRep.Clave;
          vsNRC    := regRep.NRC;

      END LOOP;


      IF vnExists = 0 THEN
          htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||PK_sisRepImp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
         PK_sisRepImp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         PK_sisRepImp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,'PIE','0',psUsuario=>pk_login.vgsUSR,psSeccion=>'3');

      END IF;

      htp.p('</table><br><br></body></html>');

  END PWRCACE;
/


DROP PUBLIC SYNONYM PWRCACE;

CREATE PUBLIC SYNONYM PWRCACE FOR BANINST1.PWRCACE;


GRANT EXECUTE ON BANINST1.PWRCACE TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCACE TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCAPP;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCAPP(psReclDesc VARCHAR2) IS

/*
          TAREA: Se clonan los reportes del CAPP de RUA a UFT
          FECHA: 14/12/2010
          AUTOR: GEPC
         MODULO:

   Modificacin:
*/


  vsOpcion VARCHAR2(1) := NULL;

  BEGIN

      IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      vsOpcion := pk_ObjHtml.getValueCookie('psCapp');

--      htp.p(
--      '<script language="javascript" src="kwacnls.js"></script>
--      <link rel="stylesheet" href="/imagenes/web_defaultappUFT.css" type="text/css">
--      ');


      IF    vsOpcion = '1' THEN
            pk_bwcksmlt.P_DispEvalGeneralReq('Requerimientos generales');

            htp.p('<script language="javascript" src="kwacnls.js"></script>');


      ELSIF vsOpcion = '2' THEN
            pk_bwcksmlt.P_DispEvalDetailReq('Requerimientos a detalle');
            htp.p('<script language="javascript" src="kwacnls.js"></script>');
      ELSIF vsOpcion = '3' THEN
            pk_bwcksncr.P_DISPEVALADDITIONAL('Informacin adcional');
            htp.p('<script language="javascript" src="kwacnls.js"></script>');
      END IF;

  END PWRCAPP;
/


DROP PUBLIC SYNONYM PWRCAPP;

CREATE PUBLIC SYNONYM PWRCAPP FOR BANINST1.PWRCAPP;


GRANT EXECUTE ON BANINST1.PWRCAPP TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCAPP TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCCSG;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCCSG(
	psReclDesc			VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:		BANINST1.PWRCCSG
OBJETIVO:			Reporte de Matricula: Nuevo Ingreso, Ligero, acumulado
PARAMETROS:
psReclDesc			Variable estandar para la maquina de reportes custom
AUTOR:				Gilberto Velazquez Hernandez
FECHA:				20110822
******************************************************************************/

	--Basicamente este es el cursor que hace el trabajo del reporte
	CURSOR cuDatos(pnNumCorte NUMBER) IS
		SELECT
			TWBDOCU_PAYM_CODE				AS MP
			,SUM(TWBDOCU_NOM_AMOUNT)		AS Monto
		FROM
			TWBDOCU
			,TWRCCMD
			,TWRCCAM
		WHERE
			TWBDOCU_SEQ_NUM = TWRCCMD_DOCU_SEQ_NUM
			AND TWRCCMD_CCAM_USER = TWRCCAM_CCAM_USER
			AND TWRCCMD_CCAM_NUM = TWRCCAM_NUM
			AND TWRCCAM_CCAS_NUM = pnNumCorte
		GROUP BY
			TWBDOCU_PAYM_CODE;

	--Cursor para obtener los datos del corte
	CURSOR cuDatosBase(pnNumCorte NUMBER) IS
		SELECT
			TWRCCAS_CCAS_USER			AS Sup
			,TWRCCAS_DATE				AS Fecha
		FROM
			TWRCCAS
		WHERE
			TWRCCAS_NUM = pnNumCorte;

	--Variable para guardar el total
	vnTotal				TWBDOCU.TWBDOCU_AMOUNT%TYPE;

	--Variable para guardar la persona que realiz el corte
	vsSup				VARCHAR2(30);
	--Variable para guardar el nombre completo del supervisor
	vsNomSup			VARCHAR2(120);
	--Variable para guardar la fecha del corte
	vdFecha				DATE;

	--El numero de corte en tipo number
	vnNumCorte			TWRCCAS.TWRCCAS_NUM%TYPE;

BEGIN

	--Seguridad de GWAMNUR
	IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

	--Obtengo el numero de corte que se desea para el usuario dado
	vnNumCorte := TO_NUMBER(pk_objHtml.getValueCookie('psNuCor'));

	--Obtengo los datos base del reporte
	OPEN cuDatosBase(vnNumCorte);
	FETCH cuDatosBase INTO vsSup, vdFecha;
	CLOSE cuDatosBase;

		--Comienzo con el reporte global
	HTP.P('<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<title> Informe de arqueo de caja de tesorer&iacute;a </title>
	</head>
	<style type="text/css">
		body{
			font-family: Arial, Helvetica, sans-serif;
			font-size: 100%;
			margin: 1cm;
			padding: 0;
			width: 18cm;
		}

		td.DatosFinis{
			width: 12cm;
			vertical-align: top;
		}

		table.DatosFinis{
			font-size: 0.7em;
		}

		td.DatosOper{
			width: 7cm;
			vertical-align: top;
		}

		table.DatosOper{
			font-size: 0.7em;
		}

		h1.Titulo{
			font-weight: bold;
			font-size: 1.2em;
			text-align: center;
		}

		.NombreCampo{
			font-weight:bold;
		}

		h2.Seccion{
			margin-top: 0.5cm;
			text-align:left;
			font-size: 0.9em;
			font-style: italic;
		}

		table.MP, table.Cajero{
			font-size: 0.7em;
			table-layout: fixed;
			border-collapse: separate;
			border-spacing: 0px;
		}

		table.MP td, table.Cajero td{

			/*border: 1px red solid;*/
			padding: 1px;
		}

		table.Cajero {
			margin-top: 0.5cm;
			margin-bottom: 0.5cm;
			width: 6cm;
		}


		tr.EncCol{
			font-weight: bold;
			text-align: center;
			overflow: hidden;
		}

		tr.Total{
			font-weight: bold;
			text-align: right;
		}

		td.EncMP{
			width: 50mm;
		}

		td.EncDCMn{
			width: 35mm;
		}

		td.Monto{
			text-align: right;
		}

		hr.LineaFirma{
			width: 6cm;
			height: 1px;
			outline: none;
			border: 0;
			color: black;
			background-color: black;
			margin-top: 3cm;
			margin-left: auto;
			margin-right: auto;
		}

		p.Firma{
			font-size: 0.7em;
			font-weight: bold;
			text-align: center;
		}

		div.SaltoPagina{
			width: 100%;
			height: 0;
			page-break-after: always;
		}

		table.Firmas{
			width:100%;
			font-size: 0.7em;
			font-weight: bold;
			text-align: center;
		}

		hr.LineaFirmaSub{
			width: 5cm;
			height: 1px;
			outline: none;
			border: 0;
			color: black;
			background-color: black;
			margin-top: 2cm;
			margin-left: auto;
			margin-right: auto;
		}

	</style>
	<body>
		<table >
			<tr>
				<td class="DatosFinis">
					<table class="DatosFinis">
						<tr><td>Universidad Finis Terrae</td></tr>
						<tr><td>Educaci&oacute;n</td></tr>
						<tr><td>70.884.700-3</td></tr>
						<tr><td>Av. Pedro de Valdivia 1509</td></tr>
						<tr><td>Providencia, Santiago</td></tr>
					</table>
				</td>
				<td class="DatosOper">
					<table class="DatosOper">
						<tr>
							<td class="NombreCampo">
								N&uacute;m. Arqueo.:
							</td>
							<td>
								'||vnNumCorte||'
							</td>
						</tr>
						<tr>
							<td class="NombreCampo">
								Responsable:
							</td>
							<td>
								'||vsSup||'
							</td>
						</tr>
						<tr>
							<td class="NombreCampo">
								Fecha/Hora Arqueo.:
							</td>
							<td>
								'||TO_CHAR(vdFecha,'DD/MM/YYYY HH24:MI:SS')||'
							</td>
						</tr>
						<tr>
							<td class="NombreCampo">
								Fecha/Hora Emisi&oacute;n:
							</td>
							<td>

								'||TO_CHAR(SYSDATE,'DD/MM/YYYY HH24:MI:SS')||'
							</td>
						</tr>
					</table>
				</td>
			</tr>
		</table>
		<h1 class="Titulo">
			Informe global de arqueo de caja de supervisor de matr&iacute;cula
		</h1>

		<table class="MP" cellspacing="0">
			<tr class="EncCol">
				<td class="EncMP">Medio de Pago</td>
				<td class="EncDCMn">Monto</td>
			</tr>');

	vnTotal := 0;

	FOR regDatos IN cuDatos(vnNumCorte) LOOP
		HTP.P('
			<tr>
				<td>'||pk_Matricula.f_existemediopago(regDatos.MP)||'</td>
				<td class="Monto">'||TO_CHAR(regDatos.Monto,'FM999G999G999G999')||'</td>
			</tr>');
		vnTotal := vnTotal + regDatos.Monto;
	END LOOP;

	HTP.P('
			<tr class="Total">
				<td>Total:</td>
				<td class="Monto">'||TO_CHAR(vnTotal,'FM999G999G999G999')||'</td>
			</tr>
		</table>

		<table class="Firmas">
			<tr>
				<td>
					Preparado por:
					<hr class="LineaFirmaSub"/>
				<td>
				<td>
					Revisado por:
					<hr class="LineaFirmaSub"/>
				<td>
			</tr>
			<tr>
				<td>
					Recibido por:
					<hr class="LineaFirmaSub"/>
				<td>
				<td>
					Fecha recepcin:
					<hr class="LineaFirmaSub"/>
				<td>
			</tr>
		</table>

		<hr class="LineaFirma"/>
		<p class="Firma">Timbre y Firma de autorizaci&oacute;n</p>');

	HTP.P('
	</body>
	<script type="text/javascript" src="kwacnls.js"></script>
</html>');
EXCEPTION
	WHEN OTHERS THEN
		--pantallazo de error.
		pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
			'PWRCCSG', NULL);

END PWRCCSG;
/


DROP PUBLIC SYNONYM PWRCCSG;

CREATE PUBLIC SYNONYM PWRCCSG FOR BANINST1.PWRCCSG;


GRANT EXECUTE ON BANINST1.PWRCCSG TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRCCSG TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRCCSG TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRCCSG TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCCSG TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCEEF;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCEEF(psReclDesc VARCHAR2) IS

/**************************************************************
           tarea:  compara los promedios entre escuelas del seprad
          mdulo:  resultados del sistema de evaluacin de la prctica docente (seprad)
           autor:  horacio martnez ramrez - hmr
           fecha:  04/nov/2010
**************************************************************/

  TYPE reg_Comp IS RECORD (rTeqaCode    VARCHAR2(40),
                           rQcodCode    VARCHAR2(40),
                           rColl        VARCHAR2(3),
                           rMedia       NUMBER,
                           rEvaluaron   INTEGER,
                           rMediaCamp   NUMBER,
                           rDesviCamp   NUMBER,
                           rMediaCateg  NUMBER,
                           rMedCampCat  NUMBER,
                           rDesCampCat  NUMBER,
                           rMedSigma    NUMBER,
                           rDesSigma    NUMBER,
                           rMedCampCatS NUMBER,
                           rDesCampCatS NUMBER,
                           rMediaVpp    NUMBER);

  TYPE tableComp IS TABLE OF reg_Comp INDEX BY BINARY_INTEGER;

  tabComp          tableComp;
  vnRow            INTEGER        := 0;
  vgnVppMedCamp    NUMBER         := 0;
  vgnVppDesCamp    NUMBER         := 0;
  vgnVppMedCampSig NUMBER         := 0;
  vgnVppDesCampSig NUMBER         := 0;
  vsTerm           VARCHAR2(6)    := NULL;
  vsUniv           VARCHAR2(5)    := NULL;
  vsEncu           VARCHAR2(30)   := NULL;
  vsPtrm           VARCHAR2(1000) := NULL;

  cn0          CONSTANT NUMBER(1)    := 0;
  cn1          CONSTANT NUMBER(1)    := 1;
  cn19         CONSTANT NUMBER(2)    := 19;
  cn18         CONSTANT NUMBER(2)    := 18;
  cn16         CONSTANT NUMBER(2)    := 16;
  csShl        CONSTANT VARCHAR2(1)  := '/';
  csGLOBAL     CONSTANT VARCHAR2(6)  := 'GLOBAL';
  vgsAmarillo  CONSTANT VARCHAR2(20) := 'bgcolor="#ffffAA"';
  vgsNaranja   CONSTANT VARCHAR2(20) := 'bgcolor="#ffCC66"';
  vgsLongCelda CONSTANT VARCHAR2(40) := 'style="width:60.0px"';

  CURSOR cuComparacion(psTerm VARCHAR2,
                       psCamp VARCHAR2,
                       psEncu VARCHAR2,
                       psPtrm VARCHAR2
                      ) IS
         SELECT SWBSEPG_TEQA_CODE             AS Teqa,
                SWBSEPG_QCOD_CODE             AS Qcod,
                SWBSEPG_COLL_CODE             AS Escuela,
                SWROENC_ORDEN                 AS OrdenEnc,
                SUM(SWBSEPG_CONTESTARON)      AS Contestaron,
                SUM(SWBSEPG_INSCRITOS)        AS Inscritos,
                SUM(SWBSEPG_MEDIA)/COUNT(cn1) AS Media
           FROM SWBSEPG,SWROENC SWR
          WHERE (    INSTR(csShl||psPtrm,csShl||SWBSEPG_PTRM_CODE||csShl) > cn0
                  OR
                     (
                       (
                           psPtrm = csShl
                        OR
                           psPtrm IS NULL
                       )
                       AND SWBSEPG_PTRM_CODE = csGLOBAL
                     )
                )
            AND SWR.SWROENC_TSSC_CODE = SWBSEPG_TSSC_CODE
            AND SWR.SWROENC_QCOD_CODE = SWBSEPG_QCOD_CODE
            AND SWBSEPG_CAMP_CODE = psCamp
            AND SWBSEPG_TSSC_CODE = psEncu
            AND SWBSEPG_TERM_CODE = psTerm
          GROUP BY SWBSEPG_TEQA_CODE,
                   SWBSEPG_QCOD_CODE,
                   SWBSEPG_COLL_CODE,
                   SWROENC_ORDEN
          ORDER BY SWBSEPG_COLL_CODE,SWROENC_ORDEN;

  -- presenta la descripcin de las escuelas
  procedure P_Escuelas is

  vnEscuelas integer := vnRow/cn19;
  vnVuelta   integer := 0;
  vnPosicion integer := 0;
  vnEvalCamp integer := 0;

  begin
      for vnI IN 1..vnEscuelas loop
          vnPosicion := 1 + (cn19 * vnVuelta);

          htp.p('<td align="center" valign="bottom" class="tdFont7" '||vgsLongCelda||'>'||pk_Seprad1.F_CollDesc(tabComp(vnPosicion).rColl)||' - '||vnPosicion||'</td>');

          vnVuelta   := vnVuelta + 1;
          vnEvalCamp := vnEvalCamp + tabComp(vnPosicion).rEvaluaron;
      end loop;

      htp.p('<td colspan="2" style="border-top:none;border-bottom:none;border-right:none;"></td></tr>
      <tr><td class="tdFont8" colspan="2" align="right"  valign="top"style="border-top:none;border-bottom:none;border-left:none;">'||'N&uacute;mero de evaluaciones'||'</td>
          <td class="tdFont8" colspan="2" align="center" valign="top">'||vnEvalCamp||'</td>');

      vnVuelta   := 0;
      vnPosicion := 0;

      for vnI in 1..vnEscuelas loop
          vnPosicion := 1 + (cn19 * vnVuelta);

          htp.p('<td class="tdFont8" align="center" valign="top">'||tabComp(vnPosicion).rEvaluaron||'</td>');

          vnVuelta := vnVuelta + 1;
      end loop;

      htp.p('
      <td colspan="2" style="border-top:none;border-right:none;"></td></tr>
      <td colspan="2" style="border-top:none;border-left:none;"></td>
      <td align="center" valign="bottom" class="tdFont7" '||vgsLongCelda||'>'||'Promedio'||' (x)</td>
      <td align="center" valign="bottom" class="tdFont7" '||vgsLongCelda||'>'||'Desviaci&oacute;n'||' (&sigma;)</td>
      ');

      for vnI IN 1..vnEscuelas loop
          htp.p('<td align="center" valign="bottom" class="tdFont7">'||'Promedio'||'</td>');
      end loop;

      htp.p('<td align="center" valign="bottom" class="tdFont7" '||vgsLongCelda||'>x-&sigma;</td>
             <td align="center" valign="bottom" class="tdFont7" '||vgsLongCelda||'>x+&sigma;</td>
      </tr>');


  end P_Escuelas;

  -- coloca la media por categora
  procedure P_MediaCategoria(pnCategoria integer) is

  vnEscuelas integer      := vnRow/cn19;
  vnVuelta   integer      := 0;
  vnPosicion integer      := 0;
  vsColor    varchar2(20) := null;

  begin
      for vnI in 1..vnEscuelas loop
          vnPosicion := pnCategoria + (cn19 * vnVuelta);

          if    round(tabComp(vnPosicion).rMediaCateg,2) <= round(tabComp(pnCategoria).rMedCampCatS,2) then
                vsColor := vgsAmarillo;
          elsif round(tabComp(vnPosicion).rMediaCateg,2) >= round(tabComp(pnCategoria).rDesCampCatS,2) then
                vsColor := vgsNaranja;
          else
                vsColor := null;
          end if;

          htp.p('<th valign="top" '||vsColor||' class="thFont8">'||TO_CHAR(ROUND(tabComp(vnPosicion).rMediaCateg,2),'90.99')||'</th>');

          vnVuelta := vnVuelta + 1;
      End loop;

  end P_MediaCategoria;

  -- muestra las medias de las escuelas por reactivo
  procedure P_PromedioEscuela(pnReactivo integer) is

  vnEscuelas integer      := vnRow/cn19;
  vnVuelta   integer      := 0;
  vnPosicion integer      := 0;
  vsColor    varchar2(20) := null;

  begin
      for vnI in 1..vnEscuelas loop
          vnPosicion := pnReactivo + (cn19 * vnVuelta);

          if    ROUND(tabComp(vnPosicion).rMedia,2) <= ROUND(tabComp(pnReactivo).rMedSigma,2) then
                vsColor := vgsAmarillo;
          elsif ROUND(tabComp(vnPosicion).rMedia,2) >= ROUND(tabComp(pnReactivo).rDesSigma,2) then
                vsColor := vgsNaranja;
          else
                vsColor := null;
          end if;

          if pnReactivo = cn19 then
             htp.p('<td align="center" valign="top" '||vsColor||' style="border-top:none;" class="tdFont8">'||TO_CHAR(ROUND(tabComp(vnPosicion).rMedia,2),'90.99')||'</td>');
          else
             htp.p('<td align="center" valign="top" '||vsColor||' style="border-bottom:none;border-top:none;" class="tdFont8">'||TO_CHAR(ROUND(tabComp(vnPosicion).rMedia,2),'90.99')||'</td>');
          end if;

          tabComp(vnI).rMediaVpp := tabComp(vnI).rMediaVpp + tabComp(vnPosicion).rMedia;

          vnVuelta := vnVuelta + 1;
      end loop;

      if pnReactivo = cn19 then
         htp.p('<td class="tdFont8" align="center" valign="top" style="border-left:solid 2px #000000;border-top:none;">'|| TO_CHAR(ROUND(tabComp(pnReactivo).rMedSigma,2),'90.99') ||'</td>');
         htp.p('<td class="tdFont8" align="center" valign="top" style="border-top:none;">'|| TO_CHAR(ROUND(tabComp(pnReactivo).rDesSigma,2),'90.99') ||'</td>');
      else
         htp.p('<td class="tdFont8" align="center" valign="top" style="border-left:solid 2px #000000;border-bottom:none;border-top:none;">'|| TO_CHAR(ROUND(tabComp(pnReactivo).rMedSigma,2),'90.99') ||'</td>');
         htp.p('<td class="tdFont8" align="center" valign="top" style="border-bottom:none;border-top:none;">'|| TO_CHAR(ROUND(tabComp(pnReactivo).rDesSigma,2),'90.99') ||'</td>');
      end if;

  end P_PromedioEscuela;

    -- vpp de las escuelas
  procedure P_VppMedia IS

  vnEscuelas integer      := vnRow/cn19;
  vsColor    varchar2(20) := null;

  begin
      for vnI in 1..vnEscuelas loop

          if tabComp(vnI).rMediaVpp > 0 then
             tabComp(vnI).rMediaVpp := tabComp(vnI).rMediaVpp/cn16;
          end if;

          if    round(tabComp(vnI).rMediaVpp,2) <= round(vgnVppMedCampSig,2) then
                vsColor := vgsAmarillo;
          elsif round(tabComp(vnI).rMediaVpp,2) >= round(vgnVppDesCampSig,2) then
                vsColor := vgsNaranja;
          else
                vsColor := null;
          end if;

          htp.p('<th class="thFont8" valign="top" '||vsColor||'>'||TO_CHAR(ROUND(tabComp(vnI).rMediaVpp,2),'90.99')||'</th>');

      end loop;

  end P_VppMedia;

  -- presenta los reactivos
  procedure P_TablaComparacion is

  vsTeqaCode   svrsdef.svrsdef_teqa_code%type := null;
  vnEscuelas   integer                        := vnRow/cn19;
  vnWidthTable integer                        := 0;

  begin
      vnWidthTable := 370 + ( (vnEscuelas+4) * 60);

      htp.p('<table border="1" cellpadding="2" cellspacing="0" bordercolor="#cccccc" bgcolor="#ffffff" style="width:'||vnWidthTable||'.0px">');

      htp.p('<tr><td colspan="2" style="border-top:none;border-bottom:none;border-left:none;"></td>
                 <td colspan="2" align="center" valign="bottom"></td>');

      P_Escuelas;

      for vnI in 1..vnRow loop
          -- es colocada la media por categora de evaluacin
          if vsTeqaCode <> tabComp(vnI).rTeqaCode or vsTeqaCode is null then
             htp.p('<tr class="trTabSepara"><th colspan="2" align="left" bgcolor="#efefef" valign="top" class="thFont7">'||pk_Seprad1.F_TeqaDesc(tabComp(vnI).rTeqaCode)||'</th>');

             htp.p('<th class="thFont8" bgcolor="#efefef" valign="top" style="border-right:none;">'||to_char(round(tabComp(vnI).rMedCampCat,2),'90.99')||'</th>');
             htp.p('<th class="thFont8" bgcolor="#efefef" valign="top" style="border-left:none;border-right:solid 2px #000000">'||to_char(round(tabComp(vnI).rDesCampCat,2),'90.99')||'</th>');

             P_MediaCategoria(vnI);

             htp.p('<th class="thFont8" valign="top" style="border-left:solid 2px #000000;">'||to_char(round(tabComp(vnI).rMedCampCatS,2),'90.99')||'</th>');
             htp.p('<th class="thFont8" valign="top">'||to_char(round(tabComp(vnI).rDesCampCatS,2),'90.99')||'</th>');

          end if;

          htp.p('<tr class="trTabSepara">
          <td class="tdFont7" style="width:20.0px"  align="right" valign="top">'||vnI||'</td>
          <td class="tdFont7" style="width:350.0px" valign="top">'||pk_Seprad1.F_QcodDesc(tabComp(vnI).rQcodCode)||'</td>');

          if vnI = cn19 then
             htp.p('<td class="tdFont8" align="center" valign="top" style="border-right:none;border-top:none;">'||to_char(round(tabComp(vnI).rMediaCamp,2),'90.99')||'</td>
                    <td class="tdFont8" align="center" valign="top" style="border-left:none; border-top:none;border-right:solid 2px #000000">'||to_char(round(tabComp(vnI).rDesviCamp,2),'90.99')||'</td>');
          else
             htp.p('<td class="tdFont8" align="center" valign="top" style="border-right:none;border-bottom:none;border-top:none;">'||to_char(round(tabComp(vnI).rMediaCamp,2),'90.99')||'</td>
                    <td class="tdFont8" align="center" valign="top" style="border-left:none; border-bottom:none;border-top:none;border-right:solid 2px #000000">'||to_char(round(tabComp(vnI).rDesviCamp,2),'90.99')||'</td>');
          end if;

          P_PromedioEscuela(vnI);

          htp.p('</tr>');

          if vnI = cn16 then
             if vgnVppMedCamp > 0 then
                vgnVppMedCamp := vgnVppMedCamp/cn16;
             end if;

             if vgnVppDesCamp > 0 then
                vgnVppDesCamp := vgnVppDesCamp/cn16;
             end if;

             if vgnVppMedCampSig > 0 then
                vgnVppMedCampSig := vgnVppMedCampSig/cn16;
             end if;

             if vgnVppDesCampSig > 0 then
                vgnVppDesCampSig := vgnVppDesCampSig/cn16;
             end if;

             htp.p('<tr class="trTabSepara">
             <th class="thFont7" colspan="2" valign="top" bgcolor="#efefef">'||'Valoraci&oacute;n Promedio del Profesor (VPP)'||'</th>
             <th class="thFont8" valign="top" bgcolor="#efefef" style="border-right:none;">'||TO_CHAR(ROUND(vgnVppMedCamp,2),'90.99')||'</th>
             <th class="thFont8" valign="top" bgcolor="#efefef" style="border-left:none;border-right:solid 2px #000000;">'||TO_CHAR(ROUND(vgnVppDesCamp,2),'90.99')||'</th>');

             P_VppMedia;

             htp.p('
             <th class="thFont8" valign="top" style="border-left:solid 2px #000000;">'||TO_CHAR(ROUND(vgnVppMedCampSig,2),'90.99')||'</th>
             <th class="thFont8" valign="top">'||TO_CHAR(ROUND(vgnVppDesCampSig,2),'90.99')||'</th>
             <tr class="trTabSepara"><td colspan="'||TO_CHAR(vnEscuelas + 6)||'" bgcolor="#ffffff" style="border-right:none;border-left:none;"></td></tr>');
          end if;

          vsTeqaCode := tabComp(vnI).rTeqaCode;

          if vnI = cn19 then
             exit;
          end if;
      end loop;

      htp.p('
      <tr class="trTabSepara"><td colspan="'||TO_CHAR(vnEscuelas + 6)||'" style="border-right:none;border-left:none;border-bottom:none;"></td></tr>
      <tr class="trTabSepara"><td style="border-right:none;border-left:none;border-bottom:none;border-top:none;" '||vgsNaranja||'></td>
          <td style="border-right:none;border-left:none;border-bottom:none;border-top:none;" class="tdFont7" colspan="'||TO_CHAR(vnEscuelas + 5)||'">'||'La Escuela o Facultad tiene un promedio significativamente superior al promedio para la Universidad'||'</td></tr>
      <tr class="trTabSepara"><td style="border-right:none;border-left:none;border-bottom:none;border-top:none;" '||vgsAmarillo||'></td>
          <td style="border-right:none;border-left:none;border-bottom:none;border-top:none;" class="tdFont7" colspan="'||TO_CHAR(vnEscuelas + 5)||'">'||'La Escuela o Facultad tiene un promedio significativamente inferior al promedio para la Universidad'||'</td></tr>
      <tr><td style="border-right:none;border-left:none;border-bottom:none;border-top:none;"></td>
          <td style="border-right:none;border-left:none;border-bottom:none;border-top:none;" class="tdFont7" colspan="'||TO_CHAR(vnEscuelas + 5)||'">'||'Nota: para la identificaci&oacute;n de promedios significativamente superiores e inferiores al promedio para la Universidad, se considera el rango  x-&sigma; a x+&sigma;, incluyendo los l&iacute;mites.'||'</td></tr>');

      htp.p('</table>');

  end P_TablaComparacion;

  -- calcula la media y desviacin del campus por reactivo
  procedure P_CalculaMediaDesvColl(pnReactivo integer) is

  vnEscuelas integer := vnRow/cn19;
  vnVuelta   integer := 0;
  vnPosicion integer := 0;
  vnTotal    integer := 0;
  vnMedia    number  := 0;
  vnDesvi    number  := 0;

  begin
      for vnI in 1..vnEscuelas loop
          vnPosicion := pnReactivo + (cn19 * vnVuelta);
          vnMedia    := vnMedia    + tabComp(vnPosicion).rMedia * tabComp(vnPosicion).rEvaluaron;
          vnTotal    := vnTotal    + tabComp(vnPosicion).rEvaluaron;
          vnVuelta   := vnVuelta   + 1;
      end loop;

      if vnMedia > 0 and vnTotal > 0 then
         vnMedia := vnMedia/vnTotal;
      end if;

      vnVuelta   := 0;
      vnPosicion := 0;

      for vnI in 1..vnEscuelas loop
          vnPosicion := pnReactivo + (cn19 * vnVuelta);
          vnDesvi    := vnDesvi    + power(tabComp(vnPosicion).rMedia - vnMedia,2) * tabComp(vnPosicion).rEvaluaron;
          vnVuelta   := vnVuelta   + 1;
      end loop;

      if vnDesvi > 0 and vnTotal > 0 then
         vnDesvi := sqrt(vnDesvi/vnTotal);
      end if;

      if pnReactivo <= cn16 then
         vgnVppMedCamp := vgnVppMedCamp + vnMedia;
         vgnVppDesCamp := vgnVppDesCamp + vnDesvi;
      end if;

      tabComp(pnReactivo).rMediaCamp := vnMedia;
      tabComp(pnReactivo).rDesviCamp := vnDesvi;

  end P_CalculaMediaDesvColl;

  -- muestra la media por categoria
  procedure P_CalculaMediaPorCategoria(psCategoria varchar2) is

  vnPreguntas number  := 0;
  vnMedia     number  := 0;
  vnRenglon   integer := 0;
  vnReactivo  integer := 0;

  begin
      for vnI in 1..vnRow loop
          vnReactivo := vnReactivo + 1;

          if tabComp(vnI).rTeqaCode = psCategoria then
             vnPreguntas := vnPreguntas + 1;

             if vnPreguntas = 1 then
                vnRenglon := vnI;
             end if;

             vnMedia := vnMedia + tabComp(vnI).rMedia;
          end if;

          if vnReactivo = cn19 then
             if vnPreguntas > 0 and vnMedia > 0 then
                vnMedia := vnMedia/vnPreguntas;
             end if;

             tabComp(vnRenglon).rMediaCateg := vnMedia;

             vnReactivo  := 0;
             vnPreguntas := 0;
             vnMedia     := 0;
             vnRenglon   := 0;
          end if;
      end loop;
  end P_CalculaMediaPorCategoria;

  -- calcula la media y la desviacin de la universidad por categora
  procedure P_CalculaMediaPorCategoriaCamp(psCategoria varchar2) is

  vnPreguntas number  := 0;
  vnMedia     number  := 0;
  vnDesvi     number  := 0;
  vnRenglon   integer := 0;

  begin
      for vnI IN 1..cn19 loop
          if tabComp(vnI).rTeqaCode = psCategoria then
             vnPreguntas := vnPreguntas + 1;

             if vnPreguntas = 1 then
                vnRenglon := vnI;
             end if;

             vnMedia := vnMedia + tabComp(vnI).rMediaCamp;
             vnDesvi := vnDesvi + tabComp(vnI).rDesviCamp;
          end if;
      end loop;

      if vnPreguntas > 0 and vnMedia > 0 then
         vnMedia := vnMedia/vnPreguntas;
      end if;

      if vnPreguntas > 0 AND vnDesvi > 0 then
         vnDesvi := vnDesvi/vnPreguntas;
      end if;

      tabComp(vnRenglon).rMedCampCat := vnMedia;
      tabComp(vnRenglon).rDesCampCat := vnDesvi;

  end P_CalculaMediaPorCategoriaCamp;

  -- calcula la media y la desviacin de la universidad por categora
  procedure P_CalculaMediaCategCampSigma(psCategoria varchar2) is

  vnPreguntas number  := 0;
  vnMedia     number  := 0;
  vnDesvi     number  := 0;
  vnRenglon   integer := 0;

  begin
      for vnI in 1..cn19 loop
          if tabComp(vnI).rTeqaCode = psCategoria then
             vnPreguntas := vnPreguntas + 1;

             if vnPreguntas = 1 then
                vnRenglon := vnI;
             end if;

             vnMedia := vnMedia + tabComp(vnI).rMedSigma;
             vnDesvi := vnDesvi + tabComp(vnI).rDesSigma;
          end if;
      end loop;

      if vnPreguntas > 0 and vnMedia > 0 then
         vnMedia := vnMedia/vnPreguntas;
      end if;

      if vnPreguntas > 0 and vnDesvi > 0 then
         vnDesvi := vnDesvi/vnPreguntas;
      end if;

      tabComp(vnRenglon).rMedCampCatS := vnMedia;
      tabComp(vnRenglon).rDesCampCatS := vnDesvi;

  end P_CalculaMediaCategCampSigma;

  -- suma y resta la media con la desviacin
  procedure P_CalculaPromedioCampus is

  begin
      for vnI in 1..cn19 loop
          tabComp(vnI).rMedSigma := tabComp(vnI).rMediaCamp-tabComp(vnI).rDesviCamp;
          tabComp(vnI).rDesSigma := tabComp(vnI).rMediaCamp+tabComp(vnI).rDesviCamp;

          if vnI <= cn16 then
             vgnVppMedCampSig := vgnVppMedCampSig + tabComp(vnI).rMedSigma;
             vgnVppDesCampSig := vgnVppDesCampSig + tabComp(vnI).rDesSigma;
          end if;
      end loop;
  end P_CalculaPromedioCampus;

  BEGIN
      -- valida que el usuario pertenezca a la base de datos
      IF pk_login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      vsUniv := pk_objHtml.getValueCookie('psSprUn');
      vsEncu := pk_objHtml.getValueCookie('psSeprd');
      vsTerm := pk_objHtml.getValueCookie('psSpTCO');
      vsPtrm := NVL(pk_objHtml.getValueCookie('psPtrmP'),'/');

      -- extrae los promedios por escuela
      FOR regCom IN cuComparacion(vsTerm, vsUniv, vsEncu, vsPtrm) LOOP
          vnRow := vnRow + 1;

          tabComp(vnRow).rTeqaCode  := regCom.Teqa;
          tabComp(vnRow).rQcodCode  := regCom.Qcod;
          tabComp(vnRow).rColl      := regCom.Escuela;
          tabComp(vnRow).rMedia     := regCom.Media;
          tabComp(vnRow).rEvaluaron := regCom.Contestaron;

          tabComp(vnRow).rMediaVpp  := 0;
      END LOOP;

      FOR vnI IN 1..cn19 LOOP
          P_CalculaMediaDesvColl(vnI);
      END LOOP;

      FOR regPreg IN pk_Seprad1.cuPreguntas LOOP
          P_CalculaMediaPorCategoria(regPreg.Categ);
      END LOOP;

      FOR regPreg IN pk_Seprad1.cuPreguntas LOOP
          P_CalculaMediaPorCategoriaCamp(regPreg.Categ);
      END LOOP;

      P_CalculaPromedioCampus;

      FOR regPreg IN pk_Seprad1.cuPreguntas LOOP
          P_CalculaMediaCategCampSigma(regPreg.Categ);
      END LOOP;

      htp.p('<html><head><title>'||psReclDesc||'</title>');

      -- la aplicacin no se guarda en el cache de la mquina
      PK_ObjHTML.P_NoCache;

      -- cdigo css
      PK_ObjHTML.P_CssTabs;

      htp.p('<script language="JavaScript"><!--');
      htp.p('function fImprimeReporte() {
      window.focus()
      print();
      }');
      htp.p('//--></script>');

      htp.p('</head><body bgcolor="#ffffff" class="bodyCeroR"><br/>');
      htp.p('<script language="javascript" src="kwacnls.js"></script><br/>');
      htp.p('<table border="0" cellpadding="2" cellspacing="1" bordercolor="#ffffff" bgcolor="#ffffff" width="100%">
      <tr class="trTabSepara">
          <td rowspan="4" width="10%" valign="top"><img src="/imagenes/logo_uft.jpg'||'" width="80" border="0"></td>
          <td colspan="2" align="left" valign="top" class="tdTitulo"><b>'||REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(psReclDesc,'~aacute','&aacute'),'~eacute','&eacute'),'~iacute','&iacute'),'~oacute','&oacute'),'~uacute','&uacute')||'</b></td>
          </tr>
      <tr class="trTabSepara"><td valign="top" width="70%">'||vsTerm||' '||pk_Seprad1.F_TermDesc(vsTerm)||'</td>
                              <td valign="top" width="30%" align="right">'||pK_Seprad1.F_Fecha||'</td></tr>
      <tr class="trTabSepara"><td colspan="2">'||pK_Seprad1.F_PtrmCodeDesc(vsTerm,
                                                                                                          psCamp=>vsUniv,
                                                                                                          psPtrm=>vsPtrm,
                                                                                                          psEncs=>vsEncu)
                                                               ||'</td></tr>
      <tr class="trTabSepara"><td colspan="2"></td></tr>
      </table><br/>');

      P_TablaComparacion;

      htp.p('<br/><br/></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           HTP.P(SQLERRM);
  END PWRCEEF;
/


DROP PUBLIC SYNONYM PWRCEEF;

CREATE PUBLIC SYNONYM PWRCEEF FOR BANINST1.PWRCEEF;


GRANT EXECUTE ON BANINST1.PWRCEEF TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCEEF TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCENS;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCENS (
    psReclDesc            VARCHAR2
) IS

    --Numero de renglones
    vnRow                PLS_INTEGER := 0;
    --Bandera para mostrar si hubo datos
    vnExists                  INTEGER := 0;
    --Numero de columnas
    vnColumnas            INTEGER := 18;
    --Numero de registros
    vnRegs                   INTEGER := 0;
    --Arreglo (nested table) donde se guardan los encabezados de las columnas
    tabColumna            Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
    -- la variable es una bandera que al tener el valor "imprime" no colocara
    --el salto de pgina para impresion
    vsInicoPag            VARCHAR2(10) := NULL;
    --Nmero de renglones por pgina
    vnRegsPag            PLS_INTEGER := 25000;
    --Variable para guardar el periodo deseado
    vsPerio                STVTERM.STVTERM_CODE%TYPE;
    --Variable para guardar la decisin
    vsApdd             SARAPPD.SARAPPD_APDC_CODE%TYPE;
    --Variable para guardar el programa deseado
    vsProgr                SMRPRLE.SMRPRLE_PROGRAM%TYPE;
    --Variable para guardar la Preferencia
    vsPref              VARCHAR2(50);
    --Variable para guardar la Va de Admisin
    vsViaAd            VARCHAR2(50);
    --Fecha del reporte
    vdFecha                DATE;
    -- Indicador Semestral
    vsIndSem             VARCHAR2(5);


    CURSOR cuReporte(
         psPerio    VARCHAR2
         ,psProgr   VARCHAR2
         ,psPref     VARCHAR2
         ,psViaAd   VARCHAR2
         ,psApdd    VARCHAR2
     ) IS

        SELECT DISTINCT F_GET_RUT(SPRIDEN_PIDM) RUT,
                    SPRIDEN_ID                                        ID,
                    DECODE(INSTR(SPRIDEN_FIRST_NAME,' '), 0, SPRIDEN_FIRST_NAME,
                                 SUBSTR(SPRIDEN_FIRST_NAME, 1,INSTR(SPRIDEN_FIRST_NAME,' ')))  NOMBRE,
                    SPRIDEN_LAST_NAME                          APELLIDOS,
                    SPBPERS_SEX SEXO,
                    (SELECT STVRTYP_DESC FROM STVRTYP, SWVTAVI
            		WHERE STVRTYP_CODE = SWVTAVI_RTYP_CODE
            		AND SWVTAVI_ADMT_CODE = SARADAP_ADMT_CODE
            		AND SWVTAVI_TERM_CODE = SARADAP_TERM_CODE_ENTRY
                    AND ROWNUM= 1) VIA,
                    (SELECT STVADMT_DESC FROM STVADMT WHERE STVADMT_CODE = SARADAP_ADMT_CODE) TIPO,
                   (SELECT SPRTELE_PHONE_AREA||''||SPRTELE_PHONE_NUMBER    TELEFONO FROM SPRTELE
                    WHERE SPRTELE_PIDM = SARADAP_PIDM
                    AND SPRTELE_TELE_CODE = 'TMPA'
                    AND ROWNUM = 1) TELEFONO,
                    SARADAP_PROGRAM_1                        PROGRAMA,
                    PK_CATALOGO.CARRERA(SUBSTR(SARADAP_PROGRAM_1,4,4))         DESCRIPCION_CARRERA,
                    SARADAP_APPL_PREFERENCE                PREFERENCIA,
                    (SELECT MAX(SORTEST_TESC_CODE)
                        FROM SORTEST, SWBPRCT
                      WHERE SWBPRCT_TESC_CODE_POND  = SORTEST_TESC_CODE
                          AND SARADAP_PROGRAM_1             =SWBPRCT_PROGRAM
                          and saradap_pidm = sortest_pidm)                          PUNTAJE_PONDERADO,
                    (SELECT MAX(SORTEST_TEST_SCORE)
                        FROM SORTEST, SWBPRCT
                       WHERE SWBPRCT_TESC_CODE_POND = SORTEST_TESC_CODE
                            AND SARADAP_PROGRAM_1 =SWBPRCT_PROGRAM
                            AND SARADAP_PIDM = SORTEST_PIDM)                          VALOR_PONDERADO_UFT,
                    F_BECAAUT (SARADAP_PIDM, SARADAP_TERM_CODE_ENTRY, SARADAP_PROGRAM_1) BECA_PSU,
                    F_BECACOL (SARADAP_PIDM, SARADAP_TERM_CODE_ENTRY, SARADAP_PROGRAM_1) BECA_COLEGIO,
                    F_BECAREG (SARADAP_PIDM, SARADAP_TERM_CODE_ENTRY, sorhsch_SBGI_CODE)     BECA_REGIONAL,
                    F_BECAPOS (SARADAP_PIDM, SARADAP_TERM_CODE_ENTRY, SARADAP_PROGRAM_1)                                BECA_POS,
                    (
                    SELECT TWBCNTR_NUM FROM TWBCNTR
                    WHERE TWBCNTR_PIDM = SARADAP_PIDM
                    AND TWBCNTR_TERM_CODE = SARADAP_TERM_CODE_ENTRY
                    AND TWBCNTR_STATUS_IND = 'A'
                    ) CONTRATO,
                    DECODE(INSTR(SPRIDEN_FIRST_NAME,' '), 0, SPRIDEN_FIRST_NAME,
                                 SUBSTR(SPRIDEN_FIRST_NAME, 1,INSTR(SPRIDEN_FIRST_NAME,' '))) ||' '|| ',Felicidades quedaste Convocado para'||' '|| PK_CATALOGO.CARRERA(SUBSTR(SARADAP_PROGRAM_1,4,4))||' '||'en la FINIS TERRAE'||' '|| DECODE(SPBPERS_SEX,'M','Bienvenido', 'F', 'Bienvenida')||' '||'te esperamos para matricularte maana a las 8 a.m.' MENSAJE
           FROM SARADAP, SPRIDEN, SPBPERS, SORHSCH, SARAPPD
          WHERE SARADAP_PIDM = SPRIDEN_PIDM
               AND SARADAP_PIDM = SORHSCH_PIDM(+)
               AND SARADAP_PIDM = SPBPERS_PIDM
            --   AND SARADAP_SESS_CODE IN ('D', 'L')
               AND SPRIDEN_CHANGE_IND IS NULL
               AND (SARADAP_TERM_CODE_ENTRY =  psPerio  OR psPerio is null)--'201310'
               AND (SARADAP_APPL_PREFERENCE   =  TO_NUMBER(substr(psPref,1,2)) or psPref is null)   --preferencia
               AND (SARADAP_PROGRAM_1 = psProgr  or psProgr is null) --programa
               AND (SARADAP_ADMT_CODE = psViaAd   or psViaAd is null)--via adm.
               AND SARAPPD_PIDM         = SARADAP_PIDM
               AND SARADAP_APPL_NO   = SARAPPD_APPL_NO
               AND SARAPPD_TERM_CODE_ENTRY = SARADAP_TERM_CODE_eNTRY
               AND SARAPPD_APDC_CODE = psApdd;   --desicin

BEGIN
    --Seguridad de GWAMNUR
    IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;
--HTP.P('PARAMETROS ');
    --Obtengo el numero de corte que se desea para el usuario dado
    vsPerio := pk_objHtml.getValueCookie('psPerio');

    vsApdd := pk_objHtml.getValueCookie('psApdd');

    vsPref := pk_objHtml.getValueCookie('psPref');

    vsViaAd := pk_objHtml.getValueCookie('psViaAd');

    --Obtenemos el programa
    vsProgr := pk_objHtml.getValueCookie('psProgr');
    --Obtenemos la decisin de admisin


 --HTP.P('PARAMETROS periodo:'||psPerio||' escu:'||vsProg);
 --HTP.P('PARAMETROS'||vnRetractosDia||'-'||vnRetractosAcum||'-'||);

    -- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
    tabColumna.EXTEND(vnColumnas);

    --Guardamos los encabezados en el arreglo de columnas
    tabColumna(1) := 'RUT';
    tabColumna(2) := 'ID';
    tabColumna(3) := 'Nombre';
    tabColumna(4) := 'Apellidos';
    tabColumna(5) := 'Sexo';
    tabColumna(6) := 'Telfono';
    tabColumna(7) := 'Tipo de Admisin';
    tabColumna(8) := 'Va de Admisin';
    tabColumna(9) := 'Programa';
    tabColumna(10) := 'Descripcin Carrera';
    tabColumna(11) := 'Preferencia';
    tabColumna(12) := 'Puntaje Ponderado';
    tabColumna(13) := 'Valor Ponderado';
    tabColumna(14) := 'Beca PSU';
    tabColumna(15) := 'Beca COLEGIO';
    tabColumna(16) := 'Beca REGIONAL';
    tabColumna(17) := 'Beca Postula';
    tabColumna(18) := 'Contrato';


    --Inicializamos contador de renglones
    vnRow := 0;


    FOR regReporte IN cuReporte(vsPerio, vsProgr,vsPref,vsViaAd, vsApdd) LOOP

        --Incremento el contador de renglones
        vnRow := vnRow + 1;
        vnExists := 1; --Bandera para indicar que hubo resultados

        --Si es el primer renglon de cada pgina...
        IF MOD(vnRow, vnRegsPag) = 1  THEN
            --imprimo el encabezado de reporte
            Pk_Sisrepimp.P_EncabezadoDeReporte(
                psReclDesc ,vnColumnas ,tabColumna
                ,vsInicoPag ,'1' , psSubtitulo   => 'Periodo: &nbsp;'||vsPerio||' - '||Pk_Catalogo.PERIODO(vsPerio),psUsuario=>pk_login.vgsUSR,
                psUniversidad => 'UFT'
            );
            vsInicoPag := 'SALTO';
        END IF;

        --Comienzo a desplegar el renglon
        HTP.P('<tr>');
        HTP.P('<td>'||regReporte.RUT||'</td>');
        HTP.P('<td>'||regReporte.ID||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.NOMBRE ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.APELLIDOS ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.SEXO ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.TELEFONO ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.TIPO ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.VIA ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.PROGRAMA ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.DESCRIPCION_CARRERA ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.PREFERENCIA ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.PUNTAJE_PONDERADO ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.VALOR_PONDERADO_UFT ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.BECA_PSU ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.BECA_COLEGIO ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.BECA_REGIONAL ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.BECA_POS ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.CONTRATO ||'</td>');



        --Fin del renglon
        HTP.P('</tr>');

    END LOOP;

    IF vnExists = 0 THEN
        --Ojo esta linea lo que hace es imprimir
        --NO SE ENCONTRARON DATOS o un mensaje similar
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
    ELSE

        -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pagina
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psSubtitulo   => 'Periodo: &nbsp;'||vsPerio||' - '||Pk_Catalogo.PERIODO(vsPerio),psUsuario=>pk_login.vgsUSR,psUniversidad => 'UFT');
    END IF;

    --Fin de la pagina
    htp.p('</table><br/></body></html>');
EXCEPTION
    WHEN OTHERS THEN
        --pantallazo de error.
        pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
            'PWRCENS', NULL);
END PWRCENS;
/


DROP PUBLIC SYNONYM PWRCENS;

CREATE PUBLIC SYNONYM PWRCENS FOR BANINST1.PWRCENS;


GRANT EXECUTE ON BANINST1.PWRCENS TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRCENS TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRCENS TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRCENS TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCENV;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCENV (
    psReclDesc            VARCHAR2
) IS
/*************************************************************************************
PROCEDIMIENTO:  PWRCENV
OBJETIVO:            Consulta para Envos - Entrega Puntajes
PARAMETROS:       Prdo_NRC     psPerio
                            Programa     psProgr
                            Va de Admision psViaAd
psReclDesc            Variable estandar para la maquina de reportes custom
AUTOR:                Alejandra Mungua
FECHA:                2012-11-20
***************************************************************************************/
    --Numero de renglones
    vnRow                PLS_INTEGER := 0;
    --Bandera para mostrar si hubo datos
    vnExists                  INTEGER := 0;
    --Numero de columnas
    vnColumnas            INTEGER := 15;
    --Numero de registros
    vnRegs                   INTEGER := 0;
    --Arreglo (nested table) donde se guardan los encabezados de las columnas
    tabColumna            Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
    -- la variable es una bandera que al tener el valor "imprime" no colocara
    --el salto de pgina para impresion
    vsInicoPag            VARCHAR2(10) := NULL;
    --Nmero de renglones por pgina
    vnRegsPag            PLS_INTEGER := 25000;
    --Variable para guardar el periodo deseado
    vsPerio                STVTERM.STVTERM_CODE%TYPE;
    --Variable para guardar EL PROGRAMA DESEADO
    vsProgr                SMRPRLE.SMRPRLE_PROGRAM%TYPE;
    --Fecha del reporte
    vdFecha                DATE;
    -- Indicador Semestral
    vsIndSem             VARCHAR2(5);
    -- Va de Admisin
    vsViaAd                  VARCHAR2(30);

    CURSOR cuReporte(
         psPerio   VARCHAR2
        ,psProgr   VARCHAR2
        ,psViaAd    VARCHAR2
     ) IS

        SELECT DISTINCT F_GET_RUT(SPRIDEN_PIDM)      RUT,
                SPRIDEN_ID                                                  ID,
                DECODE(INSTR(SPRIDEN_FIRST_NAME,' '), 0, SPRIDEN_FIRST_NAME,
                                 SUBSTR(SPRIDEN_FIRST_NAME, 1,INSTR(SPRIDEN_FIRST_NAME,' ')))  NOMBRE,
                SPRTELE_PHONE_AREA                                  CODIGO_TELEFONO,
                SPBPERS_SEX                                               SEXO,
                SPRTELE_PHONE_NUMBER                              NUMERO,
                SPRTELE_PHONE_AREA||''||SPRTELE_PHONE_NUMBER TELEFONO,
                SARADAP_PROGRAM_1                                   PROGRAMA,
                PK_CATALOGO.CARRERA(SUBSTR(SARADAP_PROGRAM_1,4,4)) DESCRIPCION_CARRERA,
                (SELECT MAX(SORTEST_TEST_SCORE)
                  FROM SORTEST, SWBPRCT
                WHERE SWBPRCT_TESC_CODE_POND = SORTEST_TESC_CODE
                   AND SARADAP_PROGRAM_1            =SWBPRCT_PROGRAM
                   --AND SARADAP_TERM_CODE_ENTRY = SORTEST_TERM_CODE_ENTRY
                   AND SARADAP_PIDM = SORTEST_PIDM)                                       PUNTAJE_PONDERADO,
                F_BECAAUT (SARADAP_PIDM, SARADAP_TERM_CODE_ENTRY, SARADAP_PROGRAM_1) BECA_PSU,
                F_BECACOL (SARADAP_PIDM, SARADAP_TERM_CODE_ENTRY, SARADAP_PROGRAM_1) BECA_COLEGIO,
                F_BECAREG (SARADAP_PIDM, SARADAP_TERM_CODE_ENTRY, sorhsch_SBGI_CODE)     BECA_REGIONAL,
                (SELECT TWRBPOS_MIN_SCORE
                   FROM TWRBPOS
                  WHERE TWRBPOS_PROGRAM = SARADAP_PROGRAM_1
                    AND TWRBPOS_TERM_CODE = SARADAP_TERM_CODE_ENTRY)                PREFERENCIA_MIN,
                (SELECT TWRBPOS_MAX_SCORE
                   FROM TWRBPOS
                  WHERE TWRBPOS_PROGRAM = SARADAP_PROGRAM_1
                    AND TWRBPOS_TERM_CODE = SARADAP_TERM_CODE_ENTRY)                PREFERENCIA_MAX,
                 DECODE(INSTR(SPRIDEN_FIRST_NAME,' '), 0, SPRIDEN_FIRST_NAME,
                                 SUBSTR(SPRIDEN_FIRST_NAME, 1,INSTR(SPRIDEN_FIRST_NAME,' '))) ||' '|| ',postula a'||' '||PK_CATALOGO.CARRERA(SUBSTR(SARADAP_PROGRAM_1,4,4))  ||' '||
                'en la FINIS TERRAE entre'||' '|| (SELECT TWRBPOS_MIN_SCORE
                                                     FROM TWRBPOS
                                                    WHERE TWRBPOS_PROGRAM = SARADAP_PROGRAM_1
                                                      AND TWRBPOS_TERM_CODE = SARADAP_TERM_CODE_ENTRY)||' y '||
                                                   (SELECT TWRBPOS_MAX_SCORE
                                                      FROM TWRBPOS
                                                     WHERE TWRBPOS_PROGRAM = SARADAP_PROGRAM_1
                                                       AND TWRBPOS_TERM_CODE = SARADAP_TERM_CODE_ENTRY)||' '||
                                                                         'preferencia y tu Matrcula ser de $0' MENSAJE
           FROM SARADAP, SPRIDEN, SPBPERS,
                     SORHSCH, SARAPPD,
                     (SELECT *
                         FROM SPRTELE
                        WHERE SPRTELE_TELE_CODE = 'TMPA'
                        AND ROWNUM = 1
                        ) SPRTELE
          WHERE SARADAP_PIDM = SPRIDEN_PIDM
            AND SARADAP_PIDM   = SORHSCH_PIDM(+)
            AND SARADAP_PIDM   = SPRTELE_PIDM(+)
            AND SARADAP_PIDM   = SPBPERS_PIDM
            AND SPRIDEN_CHANGE_IND IS NULL
            AND (SARADAP_TERM_CODE_ENTRY = psPerio OR psPerio IS NULL) --'201310'
            AND (SARADAP_ADMT_CODE = psViaAd OR psViaAd IS NULL)
            AND (SARADAP_PROGRAM_1 = psProgr OR psProgr IS NULL)
            AND SARAPPD_PIDM   = SARADAP_PIDM
            AND SARADAP_APPL_NO = SARAPPD_APPL_NO
            AND SARAPPD_TERM_CODE_ENTRY = SARADAP_TERM_CODE_ENTRY
            AND SARAPPD_APDC_CODE = 'AC'
            order by spriden_id;

BEGIN
    --Seguridad de GWAMNUR
    IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;
--HTP.P('PARAMETROS ');
    --Obtengo el numero de corte que se desea para el usuario dado
    vsPerio := pk_objHtml.getValueCookie('psPerio');

    --Obtengo de las cookies el de la Va de Admisin
    vsViaAd := pk_objHtml.getValueCookie('psViaAd');

    --Obtenemos el programa
    vsProgr := pk_objHtml.getValueCookie('psProgr');

  --HTP.P('PARAMETROS'||vnRetractosDia||'-'||vnRetractosAcum||'-'||);

    -- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
    tabColumna.EXTEND(vnColumnas);

    --Guardamos los encabezados en el arreglo de columnas
    tabColumna( 1) := 'RUT';
    tabColumna( 2) := 'ID';
    tabColumna( 3) := 'Nombre';
    tabColumna( 4) := 'Telfono';
    tabColumna( 5) := 'Programa';
    tabColumna( 6) := 'Descripcin Carrera';
    tabColumna( 7) := 'Puntaje Ponderado';
    tabColumna( 8) := 'Beca PSU';
    tabColumna( 9) := 'Beca COLEGIO';
    tabColumna(10) := 'Beca REGIONAL';
    tabColumna(11) := 'Preferencia MIN';
    tabColumna(12) := 'Preferencia MAX';
    tabColumna(13) := 'Mensaje';

    --Inicializamos contador de renglones
    vnRow := 0;

    FOR regReporte IN cuReporte(vsPerio, vsProgr,vsViaAd) LOOP

        --Incremento el contador de renglones
        vnRow := vnRow + 1;
        vnExists := 1; --Bandera para indicar que hubo resultados

        --Si es el primer renglon de cada pgina...
        IF MOD(vnRow, vnRegsPag) = 1  THEN
            --imprimo el encabezado de reporte
            Pk_Sisrepimp.P_EncabezadoDeReporte(
                psReclDesc ,vnColumnas ,tabColumna
                ,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
            );
            vsInicoPag := 'SALTO';
        END IF;

        --Comienzo a desplegar el renglon
        HTP.P('<tr>');

        HTP.P('<td>'||regReporte.RUT||'</td>');
        HTP.P('<td>'||regReporte.ID||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.NOMBRE ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.TELEFONO ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.PROGRAMA ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.DESCRIPCION_CARRERA ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.PUNTAJE_PONDERADO ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.BECA_PSU ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.BECA_COLEGIO ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.BECA_REGIONAL ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.PREFERENCIA_MIN ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.PREFERENCIA_MAX ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.MENSAJE ||'</td>');

        --Fin del renglon
        HTP.P('</tr>');

    END LOOP;

    IF vnExists = 0 THEN
        --Ojo esta linea lo que hace es imprimir
        --NO SE ENCONTRARON DATOS o un mensaje similar
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
    ELSE

        -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pagina
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
    END IF;

    --Fin de la pagina
    htp.p('</table><br/></body></html>');
EXCEPTION
    WHEN OTHERS THEN
        --pantallazo de error.
        pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
            'PWRCENV', NULL);
END PWRCENV;
/


DROP PUBLIC SYNONYM PWRCENV;

CREATE PUBLIC SYNONYM PWRCENV FOR BANINST1.PWRCENV;


GRANT EXECUTE ON BANINST1.PWRCENV TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCEN2;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCEN2 (
    psReclDesc            VARCHAR2
) IS
/*************************************************************************************
PROCEDIMIENTO:  PWRCEN2
OBJETIVO:            Consulta para envos - entrega seleccionados
PARAMETROS:      'psPerio', 'Periodo'
                            'psApdc', 'Decisin'
                            'psProgr', 'Programa'
                            'psPref', 'Preferencia'
                            'psViaAd', 'Va de Admisin'
psReclDesc            Variable estandar para la maquina de reportes custom
AUTOR:                Alejandra Mungua
FECHA:                2012-11-20
***************************************************************************************/
    --Numero de renglones
    vnRow                PLS_INTEGER := 0;
    --Bandera para mostrar si hubo datos
    vnExists                  INTEGER := 0;
    --Numero de columnas
    vnColumnas            INTEGER := 15;
    --Numero de registros
    vnRegs                   INTEGER := 0;
    --Arreglo (nested table) donde se guardan los encabezados de las columnas
    tabColumna            Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
    -- la variable es una bandera que al tener el valor "imprime" no colocara
    --el salto de pgina para impresion
    vsInicoPag            VARCHAR2(10) := NULL;
    --Nmero de renglones por pgina
    vnRegsPag            PLS_INTEGER := 25000;
    --Variable para guardar el periodo deseado
    vsPerio                STVTERM.STVTERM_CODE%TYPE;
    --Variable para guardar la decisin
    vsApdc                VARCHAR2(50);
    --Variable para guardar el programa deseado
    vsProgr                SMRPRLE.SMRPRLE_PROGRAM%TYPE;
    --Variable para guardar la Preferencia
    vsPref              VARCHAR2(50);
    --Variable para guardar la Va de Admisin
    vsViaAd            VARCHAR2(50);
    --Fecha del reporte
    vdFecha                DATE;
    -- Indicador Semestral
    vsIndSem             VARCHAR2(5);

    CURSOR cuReporte(
         psPerio    VARCHAR2
         ,psApdc   VARCHAR2
         ,psProgr   VARCHAR2
         ,psPref     VARCHAR2
         ,psViaAd   VARCHAR2
     ) IS

        SELECT DISTINCT F_GET_RUT(SPRIDEN_PIDM) RUT,
                    SPRIDEN_ID                                        ID,
                    DECODE(INSTR(SPRIDEN_FIRST_NAME,' '), 0, SPRIDEN_FIRST_NAME,
                                 SUBSTR(SPRIDEN_FIRST_NAME, 1,INSTR(SPRIDEN_FIRST_NAME,' ')))  NOMBRE,
                    SPRIDEN_LAST_NAME                          APELLIDOS,
                    SPBPERS_SEX SEXO,
                    (SELECT SPRTELE_PHONE_AREA||''||SPRTELE_PHONE_NUMBER    TELEFONO FROM SPRTELE
                    WHERE SPRTELE_PIDM = SARADAP_PIDM
                    AND SPRTELE_TELE_CODE = 'TMPA'
                    AND ROWNUM = 1) TELEFONO,
                    SARADAP_PROGRAM_1                        PROGRAMA,
                    PK_CATALOGO.CARRERA(SUBSTR(SARADAP_PROGRAM_1,4,4))         DESCRIPCION_CARRERA,
                    SARADAP_APPL_PREFERENCE                PREFERENCIA,
                    (SELECT SORTEST_TESC_CODE
                        FROM SORTEST, SWBPRCT
                      WHERE SWBPRCT_TESC_CODE_POND  = SORTEST_TESC_CODE
                          AND SARADAP_PROGRAM_1             =SWBPRCT_PROGRAM
                          and saradap_pidm = sortest_pidm
                          AND SARADAP_TERM_CODE_ENTRY   = SORTEST_TERM_CODE_ENTRY
                          AND ROWNUM =1)                          PUNTAJE_PONDERADO,
                    (SELECT SORTEST_TEST_SCORE
                        FROM SORTEST, SWBPRCT
                       WHERE SWBPRCT_TESC_CODE_POND = SORTEST_TESC_CODE
                            AND SARADAP_PROGRAM_1 =SWBPRCT_PROGRAM
                            AND SARADAP_PIDM = SORTEST_PIDM
                            AND SARADAP_TERM_CODE_ENTRY = SORTEST_TERM_CODE_ENTRY
                            AND ROWNUM =1)                          VALOR_PONDERADO_UFT,
                    F_BECAAUT (SARADAP_PIDM, SARADAP_TERM_CODE_ENTRY, SARADAP_PROGRAM_1) BECA_PSU,
                    F_BECACOL (SARADAP_PIDM, SARADAP_TERM_CODE_ENTRY, SARADAP_PROGRAM_1) BECA_COLEGIO,
                    F_BECAREG (SARADAP_PIDM, SARADAP_TERM_CODE_ENTRY, sorhsch_SBGI_CODE)     BECA_REGIONAL,
                    DECODE(INSTR(SPRIDEN_FIRST_NAME,' '), 0, SPRIDEN_FIRST_NAME,
                                 SUBSTR(SPRIDEN_FIRST_NAME, 1,INSTR(SPRIDEN_FIRST_NAME,' '))) ||' '|| ',Felicidades quedaste Convocado para'||' '|| PK_CATALOGO.CARRERA(SUBSTR(SARADAP_PROGRAM_1,4,4))||' '||'en la FINIS TERRAE'||' '|| DECODE(SPBPERS_SEX,'M','Bienvenido', 'F', 'Bienvenida')||' '||'te esperamos para matricularte maana a las 8 a.m.' MENSAJE
           FROM SARADAP, SPRIDEN, SPBPERS, SORHSCH, SARAPPD
          WHERE SARADAP_PIDM = SPRIDEN_PIDM
               AND SARADAP_PIDM = SORHSCH_PIDM(+)
               AND SARADAP_PIDM = SPBPERS_PIDM
               AND SARADAP_SESS_CODE = 'D'
               AND SPRIDEN_CHANGE_IND IS NULL
               AND (SARADAP_TERM_CODE_ENTRY =  psPerio  OR psPerio is null)--'201310'
               AND (SARADAP_APPL_PREFERENCE   =  TO_NUMBER(substr(psPref,1,2)) or psPref is null)   --preferencia
               AND (SARADAP_PROGRAM_1 = psProgr  or psProgr is null) --programa
               AND (SARADAP_ADMT_CODE = psViaAd   or psViaAd is null)--via adm.
               AND SARAPPD_PIDM         = SARADAP_PIDM
               AND SARADAP_APPL_NO   = SARAPPD_APPL_NO
               AND SARAPPD_TERM_CODE_ENTRY = SARADAP_TERM_CODE_eNTRY
               AND SARAPPD_APDC_CODE = 'CO';  --desicin

BEGIN
    --Seguridad de GWAMNUR
    IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;
--HTP.P('PARAMETROS ');
    --Obtengo el numero de corte que se desea para el usuario dado
    vsPerio := pk_objHtml.getValueCookie('psPerio');

    vsApdc := pk_objHtml.getValueCookie('psApdc');

    vsPref := pk_objHtml.getValueCookie('psPref');

    vsViaAd := pk_objHtml.getValueCookie('psViaAd');

    --Obtenemos el programa
    vsProgr := pk_objHtml.getValueCookie('psProgr');

 --HTP.P('PARAMETROS periodo:'||psPerio||' escu:'||vsProg);
 --HTP.P('PARAMETROS'||vnRetractosDia||'-'||vnRetractosAcum||'-'||);

    -- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
    tabColumna.EXTEND(vnColumnas);

    --Guardamos los encabezados en el arreglo de columnas
    tabColumna( 1) := 'RUT';
    tabColumna( 2) := 'ID';
    tabColumna( 3) := 'Nombre';
    tabColumna( 4) := 'Apellidos';
    tabColumna( 5) := 'Sexo';
    tabColumna( 6) := 'Telfono';
    tabColumna( 7) := 'Programa';
    tabColumna(8) := 'Descripcin Carrera';
    tabColumna(9) := 'Preferencia';
    tabColumna(10) := 'Puntaje Ponderado';
    tabColumna(11) := 'Valor Ponderado';
    tabColumna(12) := 'Beca PSU';
    tabColumna(13) := 'Beca COLEGIO';
    tabColumna(14) := 'Beca REGIONAL';
    tabColumna(15) := 'Mensaje';

    --Inicializamos contador de renglones
    vnRow := 0;


    FOR regReporte IN cuReporte(vsPerio, vsApdc, vsProgr,vsPref,vsViaAd) LOOP

        --Incremento el contador de renglones
        vnRow := vnRow + 1;
        vnExists := 1; --Bandera para indicar que hubo resultados

        --Si es el primer renglon de cada pgina...
        IF MOD(vnRow, vnRegsPag) = 1  THEN
            --imprimo el encabezado de reporte
            Pk_Sisrepimp.P_EncabezadoDeReporte(
                psReclDesc ,vnColumnas ,tabColumna
                ,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
            );
            vsInicoPag := 'SALTO';
        END IF;

        --Comienzo a desplegar el renglon
        HTP.P('<tr>');

        HTP.P('<td>'||regReporte.RUT||'</td>');
        HTP.P('<td>'||regReporte.ID||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.NOMBRE ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.APELLIDOS ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.SEXO ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.TELEFONO ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.PROGRAMA ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.DESCRIPCION_CARRERA ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.PREFERENCIA ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.PUNTAJE_PONDERADO ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.VALOR_PONDERADO_UFT ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.BECA_PSU ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.BECA_COLEGIO ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.BECA_REGIONAL ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.MENSAJE ||'</td>');

        --Fin del renglon
        HTP.P('</tr>');

    END LOOP;

    IF vnExists = 0 THEN
        --Ojo esta linea lo que hace es imprimir
        --NO SE ENCONTRARON DATOS o un mensaje similar
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
    ELSE

        -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pagina
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
    END IF;

    --Fin de la pagina
    htp.p('</table><br/></body></html>');
EXCEPTION
    WHEN OTHERS THEN
        --pantallazo de error.
        pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
            'PWRCEN2', NULL);
END PWRCEN2;
/


DROP PUBLIC SYNONYM PWRCEN2;

CREATE PUBLIC SYNONYM PWRCEN2 FOR BANINST1.PWRCEN2;


GRANT EXECUTE ON BANINST1.PWRCEN2 TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCERT;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCERT( psReclDesc  VARCHAR2 )   IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de articulo 29
        mdulo: admisiones - uft.

*******************************************************************************/

  -- declaracin de variables:
  global_pidm           SPRIDEN.SPRIDEN_PIDM%TYPE;
  vsPeriodoT           VARCHAR2(10)   := NULL;
  vnCert                 INTEGER            := 0;
  vsProg                 VARCHAR2(20)   := NULL;
  vsExp                  VARCHAR2(10)   := NULL;
  vsHoldPdim           VARCHAR2(400)  := NULL;



  function f_TieneHolds ( pnPidm     VARCHAR2,
                                 pnPeriodo  VARCHAR2 ) RETURN VARCHAR2 IS

    lsClasstd    VARCHAR2(500)         := NULL;
    lnMatPer     INTEGER               := 0;
    lsCompl      VARCHAR2(17)          := 'tiene adeudo de ';
    lsMatP       CONSTANT VARCHAR2(67) := 'NO cuenta con registro curricular en el periodo seleccionado - ';
    lsHold       CONSTANT VARCHAR2(65) := '*** NO se pueden mostrar datos por que el alumno ';
    csSalLocal   VARCHAR2(300)         := NULL;

  -- verifica los holds invlidos para impresin del certificado:
  CURSOR cuHold IS

         SELECT SPRHOLD_HLDD_CODE, STVHLDD_DESC||'- '    dHold
           FROM SPRHOLD,
                STVHLDD
          WHERE SPRHOLD_PIDM            = global_pidm
            AND SPRHOLD_HLDD_CODE       = STVHLDD_CODE
            AND STVHLDD_TRANS_HOLD_IND IS NOT NULL
            AND TRUNC(SYSDATE)BETWEEN TRUNC(SPRHOLD_FROM_DATE) AND TRUNC(SPRHOLD_TO_DATE);

  BEGIN


     FOR vhold IN cuHold LOOP
         lsClasstd := lsClasstd||vhold.dHold;
     END LOOP;

     IF (lsClasstd IS NOT NULL) THEN lsClasstd := lsHold ||''||lsCompl||lsClasstd||' ***'; END IF;

     RETURN lsClasstd;

  EXCEPTION
     WHEN NO_DATA_FOUND THEN
          lsClasstd := 'NO DATA';
          RETURN NULL;
     WHEN OTHERS THEN
          lsClasstd := '***';
          RETURN NULL;
  END;


BEGIN

    IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

            vsExp      := pk_objHtml.getValueCookie('psExped');
            vsProg     := pk_objHtml.getValueCookie('psPgm');
            vnCert     := pk_objHtml.getValueCookie('psTraCe');
            vsPeriodoT := pk_objHtml.getValueCookie('psPerio');

            global_pidm := f_get_pidm(vsExp);

            vsHoldPdim := f_TieneHolds(global_pidm, vsPeriodoT);


        IF (vsHoldPdim IS NOT NULL) THEN
            HTP.P('<html>
                <head>
                <title> New Document </title>
                <meta name="Generator" content="EditPlus">
                <meta name="Author" content="">
                <meta name="Keywords" content="">
                <meta name="Description" content="">

               <script type="text/javascript" >
                        function fgeneracertificados()
                        {
                            document.f.action="PWRHOLD";
                            document.f.submit();
                        }
                 </script>
                </head>

                <body>
                        <form name="f" method="get">
                        <table>');
                            HTP.P('<tr><td>El certificado <b>'||vsHoldPdim||' </b> .</td></tr>');
                            HTP.P('</table>
                                      <input type="button" name="aceptar" value="Aceptar"  onclick="fgeneracertificados();">
                                       </form>
                                       <script type="text/javascript" src="kwacnls.js"></script>
                                       </body>
                                       </html>');
        ELSE
            PWRHOLD;
        END IF;

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRCERT;
/


DROP PUBLIC SYNONYM PWRCERT;

CREATE PUBLIC SYNONYM PWRCERT FOR BANINST1.PWRCERT;


GRANT EXECUTE ON BANINST1.PWRCERT TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCERT TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCERT2;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCERT2 (
   psProg     SHRDGMR.SHRDGMR_PROGRAM%TYPE DEFAULT NULL,
   psTraCe    VARCHAR2 DEFAULT NULL,
   psPerio    VARCHAR2 DEFAULT NULL)
IS
   /*******************************************************************************
      tarea: GENERACIN DE CERTIFICADOS.
     propsito: SE TOMO COPIAL PWARCERT PARA CLONARCE Y PASARLO A AUTOSERVICIOS
       GENERAR PARA IMPRESIN LOS DIVERSOS CERTIFICADOS QUE SE OTORGAN
       A LOS ALUMNOS.
     mdulo: REGISTRO CURRICULAR - UFT.
      fecha: 30/MAYO/2012
      autor: EAMM

   *******************************************************************************/

   ckNombres             OWA_COOKIE.vc_arr;
   ckValores             OWA_COOKIE.vc_arr;
   ckCount               INTEGER;
   vgsUSR                VARCHAR2 (500);
   global_pidm           SPRIDEN.SPRIDEN_PIDM%TYPE;

   TYPE reg_Student IS RECORD
   (
      rPdim           NUMBER (8),
      rNombreLeg      VARCHAR2 (70),
      rSufix          VARCHAR2 (40),
      rClaseStdn      VARCHAR2 (10),
      rAoGenRep     VARCHAR2 (4),
      rCarrera        VARCHAR2 (70),
      rEscuela        VARCHAR2 (70),
      rApplDate       VARCHAR2 (40),
      rClaseStdnIni   VARCHAR2 (10),
      rClaseStdnFin   VARCHAR2 (10),
      rPerIniStdn     VARCHAR2 (40),
      rPerFinStdn     VARCHAR2 (40)
   );

   TYPE tableStudent IS TABLE OF reg_Student
                           INDEX BY BINARY_INTEGER;

   tabStudent            tableStudent;

   vsProg                VARCHAR2 (20) := NULL;
   vnCert                INTEGER := 0;
   vnRow                 INTEGER := 0;
   vsDesDocto            VARCHAR2 (50) := NULL;
   vnTotTextos           INTEGER := 0;
   vnEsdeDerecho         INTEGER := 0;
   vsImpTexto            VARCHAR2 (1000) := NULL;
   vsPasoTexto           VARCHAR2 (1200) := NULL;
   vsBanExito            VARCHAR2 (1) := NULL;
   vsPeriodoT            VARCHAR2 (10) := NULL;
   vsError               VARCHAR2 (500) := NULL;
   vsNombre              VARCHAR2 (100) := NULL;
   vsRut                 VARCHAR2 (20) := NULL;
   vsAno                 VARCHAR2 (4) := NULL;
   vsClasstdn            VARCHAR2 (300) := NULL;
   vsHoldPdim            VARCHAR2 (300) := NULL;
   vsSchool              VARCHAR2 (50) := NULL;
   vsCarrera             VARCHAR2 (50) := NULL;
   vnConsecNo            NUMBER (15) := 0;
   vsCode                VARCHAR2 (10) := NULL;
   vsLevel               VARCHAR2 (10) := NULL;
   vsPeriodo             VARCHAR2 (10) := NULL;
   vsEscuela             VARCHAR2 (2) := 0;

   vsImprime             VARCHAR2 (1500) := NULL;
   vsFecImprime          VARCHAR2 (100) := NULL;
   vnValida              INTEGER := 0;
   vnLinHtp              INTEGER := 0;
   vsCodHtp              VARCHAR2 (5) := NULL;
   vsFecEgreso           VARCHAR (30) := NULL;
   vsFacultad            VARCHAR (30) := NULL;
   vsStatCong            VARCHAR2 (2) := NULL;
   vsNomSpriden          VARCHAR2 (100) := NULL;
   vsEsAlumno            VARCHAR2 (20) := NULL;
   vsFueAlumno           VARCHAR2 (20) := NULL;
   vsElAlumno            VARCHAR2 (20) := NULL;
   vsSexo                VARCHAR2 (20) := NULL;
   vsStdn1               VARCHAR2 (8) := NULL;
   vsStdn2               VARCHAR2 (8) := NULL;
   vsMesAnoStdn1         VARCHAR2 (40) := NULL;
   vsMesAnoStdn2         VARCHAR2 (40) := NULL;
   vs1erClaseStdn        VARCHAR2 (10) := NULL;
   vs1erAnoStdn          VARCHAR2 (10) := NULL;
   vsUltClaseStdn        VARCHAR2 (10) := NULL;
   vsUltAnoStdn          VARCHAR2 (10) := NULL;
   psReclDesc            VARCHAR2 (60) := 'Impresion de CERTIFICADOS';

   cnModRep     CONSTANT INTEGER := 28;
   cnLinPag     CONSTANT INTEGER := 32;
   csY          CONSTANT VARCHAR2 (1) := 'Y';
   csN          CONSTANT VARCHAR2 (1) := 'N';
   cn0          CONSTANT INTEGER := 0;
   csParam      CONSTANT VARCHAR2 (7) := 'psTraCe';
   csTRAbre     CONSTANT VARCHAR2 (43) := '<tr bgcolor="#ffffff">';
   csTRCierra   CONSTANT VARCHAR2 (5) := '</tr>';
   csH1         CONSTANT VARCHAR2 (91) := '<SPAN class="fontH1">';
   csH2         CONSTANT VARCHAR2 (91) := '<SPAN class="fontH2">';
   csTX         CONSTANT VARCHAR2 (93) := '<SPAN class="fontTX">';
   csER         CONSTANT VARCHAR2 (93) := '<SPAN class="fontER">';
   csNM         CONSTANT VARCHAR2 (93) := '<SPAN class="fontNM">';
   csNMB        CONSTANT VARCHAR2 (93) := '<SPAN class="fontNMB">';
   csT8         CONSTANT VARCHAR2 (93) := '<SPAN class="fontT8">';
   csT10        CONSTANT VARCHAR2 (93) := '<SPAN class="fontT10">';
   csFF         CONSTANT VARCHAR2 (7) := '</SPAN>';

   csLBlanco    CONSTANT VARCHAR2 (49)
                            := '<tr><td class="fontNM">&nbsp;</td></tr>' ;
   csCenter     CONSTANT VARCHAR2 (6) := 'CENTER';
   csLeft       CONSTANT VARCHAR2 (4) := 'LEFT';
   csRight      CONSTANT VARCHAR2 (5) := 'RIGHT';

   cnEspEP      CONSTANT VARCHAR2 (5) := 'RIGHT';
   cnEspPF      CONSTANT VARCHAR2 (5) := 'RIGHT';
   cnEspFF      CONSTANT VARCHAR2 (5) := 'RIGHT';

   cnEspMsE     CONSTANT INTEGER := 3;
   cnEspMsE18   CONSTANT INTEGER := 2;


   -- obtiene las leyendas del certificado:
   CURSOR cu_Texto (
      pnTexto INTEGER)
   IS
        SELECT SWRRLEY_DOCTO_CODE rDocto,
               SWRRLEY_CONSEC rConsec,
               SWRRLEY_DESC_LEY rDesc,
               SWRRLEY_TYPE_JUST rJustif,
               SWRRLEY_TYPE_FONT rFont
          FROM SWRRLEY
         WHERE     SWRRLEY_TYPE_PARA = csParam
               AND SWRRLEY_RECMCODE = cnModRep
               AND SWRRLEY_DOCTO_CODE = pnTexto
      ORDER BY SWRRLEY_CONSEC;


   FUNCTION f_ImprimeReporte (pnDocto INTEGER)
      RETURN VARCHAR2
   IS
      vsRegreso   VARCHAR2 (1) := NULL;
   BEGIN
      SELECT COUNT (SWRRLEY_DOCTO_CODE)
        INTO vnValida
        FROM SWRRLEY
       WHERE     SWRRLEY_TYPE_PARA = csParam
             AND SWRRLEY_RECMCODE = cnModRep
             AND SWRRLEY_DOCTO_CODE = pnDocto;

      IF (vnValida > cn0)
      THEN
         vsRegreso := csY;
      ELSE
         vsRegreso := csN;
      END IF;

      RETURN (vsRegreso);
   END;

   FUNCTION f_checaStudent (pnPdim NUMBER, psProg VARCHAR2)
      RETURN VARCHAR2
   IS
      vscarre1   VARCHAR2 (100) := NULL;
      vscarre2   VARCHAR2 (100) := NULL;
      vsCode1    VARCHAR2 (10) := NULL;
   BEGIN
      -- VERIFICA QUE EL PROGRAMA ESTE ASOCIADO A LA CARRERA DEL ESTUDIANTE O MUESTRA LEYENDA DE CARRERA NO VLIDA.
      BEGIN
         SELECT DISTINCT SGBSTDN_MAJR_CODE_1
           INTO vsCode1
           FROM sgbstdn a
          WHERE a.sgbstdn_pidm = pnPdim AND a.sgbstdn_program_1 = psProg;
      -- and a.sgbstdn_term_code_eff = vsperiodo
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            vsCode1 := NULL;
            vscarre1 :=
               '<br/><br/><P ALIGN="center" CLASS="csER">EL ALUMNO NO PERTENECE A ESE PROGRAMA.</P>';
         WHEN OTHERS
         THEN
            vsCode1 := NULL;
            vscarre1 :=
               '<br/><br/><P ALIGN="center" CLASS="csER">EL ALUMNO NO PERTENECE A ESE PROGRAMA.</P>';
      END;

      IF (vscarre1 IS NULL)
      THEN
         vscarre1 := vscarre2;
      END IF;

      RETURN vscarre1;
   END;


   FUNCTION f_TieneMaterias
      RETURN VARCHAR2
   IS
      vsRegresa         VARCHAR2 (300) := NULL;
      lnMatPer          INTEGER := 0;
      lsMatP   CONSTANT VARCHAR2 (80)
         := 'NO cuenta con registro curricular en el periodo seleccionado - '
            || vsPeriodo ;
   BEGIN
      -- verifica si tiene materias del periodo:
      SELECT COUNT (sftregs_crn)
        INTO lnmatper
        FROM sftregs
       WHERE sftregs_pidm = global_pidm
             AND (sftregs_term_code = vsPeriodo OR vsPeriodo IS NULL);

      -- verifica en shacrse:
      IF (lnMatPer = 0)
      THEN
         SELECT COUNT (shrtckn_crn)
           INTO lnmatper
           FROM shrtckn
          WHERE shrtckn_pidm = global_pidm
                AND (shrtckn_term_code = vsPeriodo OR vsPeriodo IS NULL);

         IF (lnMatPer = 0)
         THEN
            vsRegresa := lsMatP;
         END IF;
      END IF;

      RETURN vsRegresa;
   END f_TieneMaterias;


   FUNCTION f_TieneHolds (pnPidm VARCHAR2, pnPeriodo VARCHAR2)
      RETURN VARCHAR2
   IS
      lsClasstd         VARCHAR2 (500) := NULL;
      lnMatPer          INTEGER := 0;
      lsCompl           VARCHAR2 (17) := 'tiene adeudo de ';
      lsMatP   CONSTANT VARCHAR2 (67)
         := 'NO cuenta con registro curricular en el periodo seleccionado - ' ;
      lsHold   CONSTANT VARCHAR2 (65)
         := '*** NO se pueden mostrar datos por que el alumno ' ;
      csSalLocal        VARCHAR2 (300) := NULL;

      -- verifica los holds invlidos para impresin del certificado:
      CURSOR cuHold
      IS
         SELECT SPRHOLD_HLDD_CODE, STVHLDD_DESC || '- ' dHold
           FROM SPRHOLD, STVHLDD
          WHERE SPRHOLD_PIDM = global_pidm
                AND SPRHOLD_HLDD_CODE = STVHLDD_CODE
                -- AND STVHLDD_TRANS_HOLD_IND IS NOT NULL
                AND SPRHOLD_HLDD_CODE IN
                       ('MA', 'AA', 'AR', 'BI', 'LF', 'PF', 'RE')
                AND TRUNC (SYSDATE) BETWEEN TRUNC (SPRHOLD_FROM_DATE)
                                        AND TRUNC (SPRHOLD_TO_DATE);
   -- and sprhold_hldd_code in ('ma','lf','bi')

   BEGIN
      -- barre los holds:
      FOR vhold IN cuHold
      LOOP
         lsClasstd := lsClasstd || vhold.dHold;
      END LOOP;

      IF (lsClasstd IS NOT NULL)
      THEN
         lsClasstd := lsHold || '' || lsCompl || lsClasstd || ' ***';
      END IF;

      RETURN lsClasstd;
   EXCEPTION
      WHEN NO_DATA_FOUND
      THEN
         lsClasstd := 'NO DATA';
         RETURN NULL;
      WHEN OTHERS
      THEN
         lsClasstd := '***';
         RETURN NULL;
   END;

   PROCEDURE p_RegistraCertificado
   IS
      vsClasstd   VARCHAR2 (300) := NULL;
   BEGIN

      -- obtiene el nombre legal:
      BEGIN
         SELECT NVL (REPLACE (SPBPERS_LEGAL_NAME, '*', ' '),
                     'Sin Nombre Legal')
                   Nombre,
                SPBPERS_NAME_SUFFIX Suffix,
                TO_CHAR (SYSDATE, 'YYYY') ImpAno
           INTO vsNombre, vsRut, vsAno
           FROM SPBPERS
          WHERE SPBPERS_PIDM = global_pidm;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            vsNombre := '**********';
            vsRut := '**********';
            vsAno := '****';
      END;

      -- verifica que no tenga holds

      vsClasstd := f_TieneHolds (global_pidm, vsPeriodo);

      IF (vsClasstd IS NULL)
      THEN
         IF (SUBSTR (vsPeriodo, 5, 2) = '25')
         THEN
            vsClasstd := '1er. semestre';
            vsAno := SUBSTR (vsPeriodo, 1, 4);
         ELSIF (SUBSTR (vsPeriodo, 5, 2) = '75')
         THEN
            vsClasstd := '2do. semestre';
            vsAno := SUBSTR (vsPeriodo, 1, 4);
         ELSIF (SUBSTR (vsPeriodo, 5, 2) = '10')
         THEN
            vsClasstd := 'periodo anual';
            vsAno := SUBSTR (vsPeriodo, 1, 4);
         END IF;
      END IF;

      vsClasstdn := vsClasstd;

      -- obtiene la descripcin de la escuela:
      BEGIN
         SELECT STVCOLL_DESC
           INTO vsSchool
           FROM STVCOLL
          WHERE STVCOLL_CODE = vsEscuela;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            vsSchool := '**********';
      END;

      -- obtiene la descripcin de la carrera:
      BEGIN
         SELECT STVMAJR_DESC
           INTO vsCarrera
           FROM STVMAJR
          WHERE STVMAJR_CODE = vsCode;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            vsCarrera := '**********';
      END;

      -- obtiene la fecha de egreso:
      BEGIN
         SELECT NVL (TO_CHAR (MAX (SHRDGMR_APPL_DATE), 'month'), '*********')
                || ' de '
                || NVL (TO_CHAR (MAX (SHRDGMR_APPL_DATE), 'YYYY'), '****')
           INTO vsFecEgreso
           FROM SHRDGMR
          WHERE     SHRDGMR_PIDM = global_pidm
                AND SHRDGMR_PROGRAM = vsProg
                AND SHRDGMR_LEVL_CODE = vsLevel
                AND SHRDGMR_MAJR_CODE_1 = vsCode;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            vsFecEgreso := '**********';
      END;

      -- obtiene la descripcin de la facultad:
      BEGIN
         SELECT STVCAMP_DESC
           INTO vsFacultad
           FROM STVCAMP
          WHERE STVCAMP_CODE = vsFacultad;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            vsFacultad := '**********';
      END;

      -- determina si es la carrera de derecho:
      BEGIN
         SELECT COUNT (STVMAJR_CODE)
           INTO vnEsdeDerecho
           FROM STVMAJR
          WHERE UPPER (STVMAJR_DESC) LIKE 'DERECHO%'
                AND STVMAJR_CODE = vsCode;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            vnEsdeDerecho := '**********';
      END;

      -- obtiene el nombre del alumno:
      BEGIN
         SELECT DISTINCT
                (   REPLACE (SPRIDEN_LAST_NAME, '*', ' ')
                 || ' '
                 || SPRIDEN_FIRST_NAME)
           INTO vsNomSpriden
           FROM SPRIDEN
          WHERE SPRIDEN_CHANGE_IND IS NULL
            AND SPRIDEN_PIDM = global_pidm;
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            vsNomSpriden := '**********';
      END;

      -- determina las palabras de acuerdo al sexo del alumno:
      vsSexo := FWRSEXO (global_pidm);

      SELECT DECODE (vsSexo,
                     'Masculino', 'es alumno ',
                     'Femenino', 'es alumna ',
                     'es ****** ')
        INTO vsEsAlumno
        FROM DUAL;

      SELECT DECODE (vsSexo,
                     'Masculino', 'fue alumno ',
                     'Femenino', 'fue alumna ',
                     'es ****** ')
        INTO vsFueAlumno
        FROM DUAL;

      SELECT DECODE (vsSexo,
                     'Masculino', 'el alumno ',
                     'Femenino', 'la alumna ',
                     'es ****** ')
        INTO vsElAlumno
        FROM DUAL;

      -- obtiene las fechas de inicio y de trmino de la carrera:
      SELECT    TO_CHAR (STVTERM_START_DATE, 'month')
             || ' de '
             || TO_CHAR (STVTERM_START_DATE, 'YYYY')
        INTO vsMesAnoStdn1
        FROM STVTERM
       WHERE STVTERM_CODE = vsStdn1;

      SELECT    TO_CHAR (STVTERM_START_DATE, 'month')
             || ' de '
             || TO_CHAR (STVTERM_START_DATE, 'YYYY')
        INTO vsMesAnoStdn2
        FROM STVTERM
       WHERE STVTERM_CODE = vsStdn2;

      -- obtiene las fechas de suspensin de la carrera:
      SELECT CASE
                WHEN TO_NUMBER (TO_CHAR (STVTERM_START_DATE, 'mm')) <= 6
                THEN
                   '1er'
                ELSE
                   '2do'
             END,
             TO_CHAR (STVTERM_START_DATE, 'YYYY')
        INTO vs1erClaseStdn, vs1erAnoStdn
        FROM STVTERM
       WHERE STVTERM_CODE = vsStdn1;

      SELECT CASE
                WHEN TO_NUMBER (TO_CHAR (STVTERM_START_DATE, 'mm')) <= 6
                THEN
                   '1er'
                ELSE
                   '2do'
             END,
             TO_CHAR (STVTERM_START_DATE, 'YYYY')
        INTO vsUltClaseStdn, vsUltAnoStdn
        FROM STVTERM
       WHERE STVTERM_CODE = vsStdn2;

      vsBanExito := 'N';

      -- registra en la bitcora de impresiones:
      BEGIN
         SELECT NVL (MAX (SWRSCRT_ID_CONSEC), 0) + 1
           INTO vnConsecNo
           FROM SWRSCRT
          WHERE SWRSCRT_TYPE_PARA = csParam
                AND SWRSCRT_TERM_CODE = NVL (vsPeriodo, '999999');

         INSERT INTO SWRSCRT (SWRSCRT_TYPE_PARA,
                              SWRSCRT_TERM_CODE,
                              SWRSCRT_ID_CONSEC,
                              SWRSCRT_RECMCODE,
                              SWRSCRT_DOCTO_CODE,
                              SWRSCRT_PIDM,
                              SWRSCRT_NOMBRE,
                              SWRSCRT_RUT,
                              SWRSCRT_CLAS_STDN,
                              SWRSCRT_SCHO_STDN)
              VALUES (csParam,
                      NVL (vsPeriodo, '999999'),
                      vnConsecNo,
                      cnModRep,
                      vnCert,
                      global_pidm,
                      vsNombre,
                      vsRut,
                      SUBSTR (vsClasstdn, 0, 29),
                      vsSchool);

         COMMIT;
         vsBanExito := 'Y';
      EXCEPTION
         WHEN OTHERS
         THEN
            vsError := SUBSTR (SQLERRM, 1, 500);
            vsBanExito := 'N';
      END;

      vsFecImprime :=
            TO_CHAR (SYSDATE, 'DD')
         || ' de '
         || TO_CHAR (SYSDATE, 'month')
         || ' de '
         || TO_CHAR (SYSDATE, 'YYYY');
   END p_RegistraCertificado;
-------------------------------------------------------
-- bloque principal para la generacin del certificado
-------------------------------------------------------

BEGIN
   -- valida que el usuario tenga acceso a la base de datos:
   --   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;
   IF NOT twbkwbis.f_validuser (global_pidm) THEN  RETURN;  END IF;

   -- son buscados los valores de las cookies para asignar los valores del filtro del query:
   vsProg := psProg;
   vnCert := psTraCe;
   vsPeriodoT := psPerio;
   vsPeriodo := vsPeriodoT;

   -- obtiene el nombre o descripcin del certificado:
   BEGIN
      SELECT GWBTIPO_DESC
        INTO vsDesDocto
        FROM GWBTIPO
       WHERE GWBTIPO_CODE = csParam AND TO_NUMBER (GWBTIPO_TYPE) = vnCert;
   EXCEPTION
      WHEN OTHERS
      THEN
         NULL;
   END;

   -- informacin bsica del estudiante y situacin actual:
   BEGIN
      SELECT SGBSTDN_MAJR_CODE_1,
             SGBSTDN_LEVL_CODE,
             SGBSTDN_CAMP_CODE,
             SGBSTDN_STST_CODE,
             SGBSTDN_COLL_CODE_1
        INTO vsCode,
             vsLevel,
             vsFacultad,
             vsStatCong,
             vsEscuela
        FROM SGBSTDN
       WHERE SGBSTDN_PIDM = global_pidm AND SGBSTDN_PROGRAM_1 = vsProg
             AND SGBSTDN_TERM_CODE_EFF =
                    (SELECT MAX (SGBSTDN_TERM_CODE_EFF)
                       FROM SGBSTDN
                      WHERE SGBSTDN_PIDM = global_pidm
                            AND SGBSTDN_PROGRAM_1 = vsProg);
   EXCEPTION
      WHEN OTHERS
      THEN
         NULL;
   END;

   -- obtiene los periodos inicio y final del estudiante y carrera:
   BEGIN
      SELECT MIN (SGBSTDN_TERM_CODE_EFF) FMin,
             MAX (SGBSTDN_TERM_CODE_EFF) FMax
        INTO vsStdn1, vsStdn2
        FROM SGBSTDN
       WHERE SGBSTDN_PIDM = global_pidm AND SGBSTDN_PROGRAM_1 = vsprog;
   EXCEPTION
      WHEN OTHERS
      THEN
         NULL;
   END;

   -- verifica que no tenga holds:
   vsHoldPdim := f_TieneHolds (global_pidm, vsPeriodo);

   -- renglones disponibles para impresin:
   vnValida := (cnLinPag - vnValida);

   -- desactiva ventana de "espere ...":
   HTP.p ('<script language="javascript" src="kwacnls.js"></script>');

   -- inicializa la pgina html:
   HTP.
    p (
      '<html><head><title>' || psReclDesc
      || 'Untitled Page</title>
    <style type="text/css">
       p   {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10pt; font-weight: normal; font-style: normal; color: #000000;}
       p.pER  {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10pt; font-weight: normal; font-style: normal; color: #FF0000; text-align: center;}
       td   {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10pt; font-weight: normal; font-style: normal; color: #000000;}
       td.tdER  {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10pt; font-weight: normal; font-style: normal; color: #FF0000; text-align: center;}
       span   {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10pt; font-weight: normal; font-style: normal; color: #000000;}
       span.fontH1 {font-family: Times New Roman, verdana, helvetica; sans-serif; font-size: 13pt; font-weight: bold;  font-style: normal; color: #000000;}
       span.fontH2 {font-family: Times New Roman, verdana, helvetica; sans-serif; font-size: 13pt; font-weight: bold;  font-style: normal; color: #000000;}
       span.fontTX {font-family: Times New Roman, verdana, helvetica; sans-serif; font-size: 13pt; font-weight: normal; font-style: normal; color: #000000;}
       span.fontER {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10pt; font-weight: bold;  font-style: normal; color: #FF0000; text-align: center;}
       span.fontNM {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10t; font-weight: normal; font-style: normal; color: #000000;}
       span.fontNMB {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10pt; font-weight: bold;  font-style: normal; color: #000000;}
       span.fontT8 {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 8pt; font-weight: normal; font-style: normal; color: #000000;}
       span.fontT10 {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10pt; font-weight: normal; font-style: normal; color: #000000;}
    </style>
    <script language="JavaScript"><!--
      function fImprimeReporte() {
         window.focus()
         print();}
    //--></script>
    </head><body>');


   -- EAMM se pone marca de agua
   HTP.p ('<style type="text/css"><!--
  body {background-image: url(/imagenes/sinValidez.gif);}
  -->
  </style>
 ');

   -- inicia tabla de despliegue:
   HTP.p ('<table width="70%" border="0" align="center">');

   -- verifica si el documento ya est disponible para su impresin:
   IF (f_ImprimeReporte (vnCert) = csY)
   THEN
      IF (vsHoldPdim IS NULL)
      THEN
         -- verifica si tiene materias:
         --IF (f_TieneMaterias IS NULL) THEN
         -- verifica el estado del estudiante:
         IF (f_checaStudent (global_pidm, vsProg) IS NULL)
         THEN
            -- agrega a bitcora de impresin y obtiene informacin del detalle de las leyendas:
            p_RegistraCertificado;
            IF (vsBanExito = 'N')
            THEN
               HTP.
                p (
                  '<TR/><TD CLASS="tdER"><b>*** ERROR *** AL OBTENER EL FOLIO DEL CERTIFICADO.</b>... '
                  || vsError
                  || '</TD></TR>');
            ELSIF (vnCert = 6 AND vnEsdeDerecho = 0)
            THEN
               HTP.
                p (
                  '<TR/><TD CLASS="tdER"><b>EL CERTIFICADO &nbsp;"'
                  || UPPER (vsDesDocto)
                  || '"&nbsp; S&Oacute;LO ES V&Aacute;LIDO PARA DERECHO.</b></TD></TR>');
            ELSIF (vnCert = 12 AND vsStatCong != 'IS')
            THEN
               HTP.
                p (
                  '<TR/><TD CLASS="tdER"><b>EL CERTIFICADO &nbsp;"'
                  || UPPER (vsDesDocto)
                  || '"&nbsp; S&Oacute;LO ES V&Aacute;LIDO PARA EL ESTATUS DE CONGELADO.</b></TD></TR>');
            ELSIF (INSTR ('25|75|10', SUBSTR (vsPeriodo, 5, 2)) = 0)
            THEN
               HTP.
                p (
                  '<TR/><TD CLASS="tdER"><b>EL PERIODO ES INV&Aacute;LIDO PARA IMPRESI&OAacute;N DE CERTIFICADOS.</b></TD></TR>');
            ELSE
               -- verifica si es certificado "sin impedimentos":
               IF vnCert = 18
               THEN
                  -- determina el espacio entre el mrgen superior y el encabezado:
                  FOR vnI IN 1 .. cnEspMsE18
                  LOOP
                     HTP.p (csLBlanco);
                  END LOOP;
               ELSE
                  -- determina el espacio entre el mrgen superior y el encabezado:
                  FOR vnI IN 1 .. cnEspMsE
                  LOOP
                     HTP.p (csLBlanco);
                  END LOOP;
               END IF;

               FOR reg_Texto IN cu_Texto (vnCert)
               LOOP
                  -- inicia impresin de la pgina:
                  HTP.p (csTRAbre);

                  vsImprime :=
                     CASE
                        WHEN reg_Texto.rJustif = 'JUSTIFY'
                        THEN
                           '<TD class="fontT10">'
                        ELSE
                              '<TD class="fontT10" align="'
                           || reg_texto.rjustif
                           || '" >'
                     END;

                  vsPasoTexto := reg_Texto.rDesc;

                  -- reemplaza valores de variables:
                  IF INSTR (vsPasoTexto, '||esAlumno') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto, '||esAlumno', vsEsAlumno)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||fueAlumno') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto, '||fueAlumno', vsfueAlumno)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||elAlumno') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto, '||elAlumno', vsElAlumno)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||Nombre') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto,
                                     '||Nombre',
                                     UPPER (vsNombre))
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||RutSuffix') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto,
                                     '||RutSuffix',
                                     UPPER (vsRut))
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||ClaseSTDN') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto, '||ClaseSTDN', vsClasstdn)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||AnoGenRep') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto,
                                     '||AnoGenRep',
                                     UPPER (vsAno))
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||carrera') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto, '||carrera', vsCarrera)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||escuela') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto, '||escuela', vsSchool)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||FechaImprime') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto,
                                     '||FechaImprime',
                                     vsFecImprime)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||FolDocto') > 0
                  THEN
                     SELECT REPLACE (
                               vsPasoTexto,
                               '||FolDocto',
                               '<B>' || LPAD (vnConsecNo, 6, '0') || '</B>')
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||FecEgreso') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto, '||FecEgreso', vsFecEgreso)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||Facultad') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto, '||Facultad', vsFacultad)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||NomSpriden') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto,
                                     '||NomSpriden',
                                     vsNomSpriden)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||mesAno1erStdn') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto,
                                     '||mesAno1erStdn',
                                     vsMesAnoStdn1)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||mesAnoUltStdn') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto,
                                     '||mesAnoUltStdn',
                                     vsMesAnoStdn2)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||1erClaseStdn') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto,
                                     '||1erClaseStdn',
                                     vs1erClaseStdn)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||1erAnoStdn') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto,
                                     '||1erAnoStdn',
                                     vs1erAnoStdn)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||UltClaseStdn') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto,
                                     '||UltClaseStdn',
                                     vsUltClaseStdn)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||UltAnoStdn') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto,
                                     '||UltAnoStdn',
                                     vsUltAnoStdn)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  -- if instr(vspasotexto,'||styleh1')   > 0 then select replace(vspasotexto,'la ||styleh1','<br>la '||csh1)       into vspasotexto from dual; end if;
                  IF INSTR (vsPasoTexto, '||styleH1') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto,
                                     'La ||styleH1',
                                     ' La ' || csH1)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||styleH2') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto, '||styleH2', csH2)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||styleTX') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto, '||styleH2', csTX)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||styleNM') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto, '||styleH2', csNM)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||styleNMB') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto, '||styleH2', csNMB)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||styleT8') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto, '||styleH2', cst8)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||styleH10') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto, '||styleH2', csT10)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  IF INSTR (vsPasoTexto, '||styleFF') > 0
                  THEN
                     SELECT REPLACE (vsPasoTexto, '||styleFF', csFF)
                       INTO vsPasoTexto
                       FROM DUAL;
                  END IF;

                  -- arma cadena a imprimir en el formato:
                  vsImprime :=
                     vsImprime
                     || CASE
                           WHEN reg_Texto.rFont = 'HH1'
                           THEN
                              csH1 || vsPasoTexto || csFF || '</TD>'
                           WHEN reg_Texto.rFont = 'HH2'
                           THEN
                              csH2 || vsPasoTexto || csFF || '</TD>'
                           WHEN reg_Texto.rFont = 'HH2A'
                           THEN
                              csTX || vsPasoTexto || csFF || '</TD>'
                           WHEN reg_Texto.rFont = 'FM1'
                           THEN
                              csTX || vsPasoTexto || csFF || '</TD>'
                           WHEN reg_Texto.rFont = 'FT1'
                           THEN
                              csTX || vsPasoTexto || csFF || '</TD>'
                           WHEN reg_Texto.rFont = 'TX1'
                           THEN
                                 '<P align="'
                              || reg_Texto.rJustif
                              || '">'
                              || csTX
                              || vsPasoTexto
                              || csFF
                              || '</P></TD>'
                           ELSE
                              '</TD>'
                        END;

                  -- determina el espacio entre las lneas del encabezado:
                  IF (SUBSTR (reg_Texto.rFont, 1, 2) = 'HH'
                      AND (vscodhtp IS NULL OR SUBSTR (vscodhtp, 1, 2) = 'HH'))
                  THEN
                     HTP.p (csLBlanco);
                     HTP.p (csLBlanco);
                     vnLinhtp := vnLinhtp + 1;
                  END IF;

                  -- verifica si es certificado "estudios foliados":
                  IF vncert = 19
                  THEN
                     -- determina el espacio entre el encabezado y el primer prrafo:
                     IF (SUBSTR (reg_Texto.rFont, 1, 2) = 'TX')
                     THEN
                        IF (vnLinHtp < 6)
                        THEN                                        -- cnespep
                           vnLinHtp := vnLinHtp + 1;

                           FOR vnJ IN vnLinHtp .. 6
                           LOOP
                              HTP.p (csLBlanco);
                              vnLinHtp := vnLinHtp + 1;
                           END LOOP;

                           vnLinHtp := 6;
                        ELSE
                           HTP.p (csLBlanco);
                           vnLinHtp := vnLinHtp + 1;
                        END IF;
                     END IF;

                     -- determina el espacio entre el ltimo prrafo y la firma:
                     IF (SUBSTR (reg_Texto.rFont, 1, 2) = 'FM')
                     THEN
                        IF (vnLinHtp < 4)
                        THEN                                        -- cnesppf
                           vnLinHtp := vnLinHtp + 1;

                           FOR vnJ IN vnLinHtp .. 4
                           LOOP
                              HTP.p (csLBlanco);
                              vnLinHtp := vnLinHtp + 1;
                           END LOOP;

                           vnLinHtp := 4;
                        END IF;
                     END IF;

                     -- determina el espacio entre la firma y la fecha:
                     IF (SUBSTR (reg_Texto.rFont, 1, 2) = 'FT')
                     THEN
                        IF (vnLinHtp < 18)
                        THEN                                        -- cnespff
                           vnLinHtp := vnLinHtp + 1;

                           FOR vnJ IN vnLinHtp .. 18
                           LOOP
                              HTP.p (csLBlanco);
                              vnLinHtp := vnLinHtp + 1;
                           END LOOP;

                           vnLinHtp := 18;
                        END IF;
                     END IF;
                  ELSE
                     -- determina el espacio entre el encabezado y el primer prrafo:  (original)
                     IF (SUBSTR (reg_Texto.rFont, 1, 2) = 'TX')
                     THEN
                        IF (vnLinHtp < 8)
                        THEN                                        -- cnespep
                           vnLinHtp := vnLinHtp + 1;

                           FOR vnJ IN vnLinHtp .. 8
                           LOOP
                              HTP.p (csLBlanco);
                              vnLinHtp := vnLinHtp + 1;
                           END LOOP;

                           vnLinHtp := 8;
                        ELSE
                           HTP.p (csLBlanco);
                           vnLinHtp := vnLinHtp + 1;
                        END IF;
                     END IF;

                     -- determina el espacio entre el ltimo prrafo y la firma:  (original)
                     IF (SUBSTR (reg_Texto.rFont, 1, 2) = 'FM')
                     THEN
                        IF (vnLinHtp < 18)
                        THEN                                        -- cnesppf
                           vnLinHtp := vnLinHtp + 1;

                           FOR vnJ IN vnLinHtp .. 18
                           LOOP
                              HTP.p (csLBlanco);
                              vnLinHtp := vnLinHtp + 1;
                           END LOOP;

                           vnLinHtp := 18;
                        END IF;
                     END IF;

                     -- determina el espacio entre la firma y la fecha:  (original)
                     IF (SUBSTR (reg_Texto.rFont, 1, 2) = 'FT')
                     THEN
                        IF (vnLinHtp < 24)
                        THEN                                        -- cnespff
                           vnLinHtp := vnLinHtp + 1;

                           FOR vnJ IN vnLinHtp .. 24
                           LOOP
                              HTP.p (csLBlanco);
                              vnLinHtp := vnLinHtp + 1;
                           END LOOP;

                           vnLinHtp := 24;
                        END IF;
                     END IF;
                  END IF;

                  HTP.p (vsImprime);
                  HTP.p (csTRCierra);

                  vsCodHtp := reg_Texto.rFont;
                  vnLinHtp := vnLinHtp + 1;
               END LOOP;
            END IF;                                   -- if (vsbanexito = 'n')
         ELSE
            HTP.
             p (
                  '<TR/><TD class="tdER">ESTATUS ... <B>'
               || f_checaStudent (global_pidm, vsProg)
               || '.</B></TD></TR>');
         END IF;                     -- if (f_checastudent(global_pidm,vsprog)
      --   ELSE
      --   htp.p('<TR/><TD class="tdER">ESTATUS ... <B>'||f_TieneMaterias||'.</B></TD></TR>');
      --   END IF;  -- if (f_tienematerias)
      ELSE
         HTP.
          p (
               '<TR/><TD class="tdER">El certificado <b>'
            || vsHoldPdim
            || ' </b> .</TD></TR>');
      END IF;                                       -- if (vsholdpdim is null)
   ELSE
      HTP.
       p (
         '<TR/><TD class="tdER">El certificado <b>' || vsDesDocto
         || ' </b> NO EST&Aacute; DISPONIBLE para su impresi&oacute;n.</TD></TR>');
   END IF;                                     -- if (f_imprimereporte(vncert)

   HTP.p ('</TABLE><br/></body></html>');
EXCEPTION
   WHEN OTHERS
   THEN
      vsError := SUBSTR (SQLERRM, 1, 500);
      HTP.
       p (
            '<P class="pER">GENERACI&Oacute;N DE CERTIFICADOS ESCOLARES --> '
         || vsError
         || ' </P>');
END PWRCERT2;
/


DROP PUBLIC SYNONYM PWRCERT2;

CREATE PUBLIC SYNONYM PWRCERT2 FOR BANINST1.PWRCERT2;


GRANT EXECUTE ON BANINST1.PWRCERT2 TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRCERT2 TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRCERT2 TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRCERT2 TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCERT2 TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCERT3;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCERT3
IS
	-- DECLARACION DE VARIABLES LOCALES
	curr_release		CONSTANT VARCHAR2 (10)             := '8.1.1';
	global_pidm			spriden.spriden_pidm%TYPE;
	-- DECLARACION DE CURSORES LOCALES
	-- CURSOR QUE CARGA PERIODOS
	CURSOR cTerm IS
		SELECT DISTINCT SFRSTCR_TERM_CODE AS TERM, PK_CATALOGO.PERIODO(SFRSTCR_TERM_CODE) AS TDESC
		FROM SFRSTCR
 ORDER BY 1,2;
		--WHERE SFRSTCR_PIDM = global_pidm;
	-- CURSOR QUE CARGA LOS PROGRAMAS DEL ESTUDIANTE
	CURSOR cProg IS
		SELECT DISTINCT PK_CATALOGO.PROGRAMA(SGBSTDN_PROGRAM_1) AS DESCR, SGBSTDN_PROGRAM_1
		FROM SGBSTDN
		WHERE SGBSTDN_PIDM = global_pidm;
	-- CURSOR QUE CARGA LOS TIPOS DE CERTIFICADOS
	CURSOR cCert IS
		SELECT GWBTIPO_TYPE,
				GWBTIPO_DESC  AS DESCR
--				GWBTIPO_DEFAULT cDefl
		FROM GWBTIPO
		WHERE GWBTIPO_CODE = 'psTraCe'
		  AND GWBTIPO_TYPE IN ('3', '4')
		ORDER By TO_NUMBER(GWBTIPO_TYPE);
BEGIN
	IF NOT twbkwbis.f_validuser (global_pidm) THEN
		RETURN;
	END IF;
	-- INICIALIZA LA PAGUINA
	bwckfrmt.p_open_doc ('PWRCERT3');
	twbkwbis.p_dispinfo ('PWRCERT3');

	 HTP.formopen ('PWRCERT2', 'post');
	 twbkfrmt.p_tableopen (
		'DATAENTRY',
		cattributes   => 'SUMMARY="' ||
							g$_nls.get ('BWSKOTR1-0001',
							   'SQL',
							   'This entry table is used to request
							   transcript type and level'
							) ||
							'."'
	 );
	-- INICIAL LA TABLA PARA PONER LOS PARAMETROS QUE SE VAN A SOLICITAR
	twbkfrmt.p_tablerowopen;
	--
	-- SOLICITA EL PARAMETRO DE PERIODO
	twbkfrmt.p_tabledataopen;
	htp.formSelectOpen('psPerio', 'Periodo:   ');
	FOR x IN cTerm LOOP
		twbkwbis.p_formselectoption(x.TDESC, x.TERM);
	END LOOP;
	htp.formSelectClose;
	twbkfrmt.p_tabledataclose;
	twbkfrmt.p_tablerowclose;
	--
    -- SOLICITA EL PARAMETRO DE PROGRAMA
	twbkfrmt.p_tabledataopen;
	htp.formSelectOpen('psProg', 'Programa:   ');
	FOR x IN cProg LOOP
		twbkwbis.p_formselectoption(x.DESCR, x.SGBSTDN_PROGRAM_1);
	END LOOP;
	htp.formSelectClose;
	twbkfrmt.p_tabledataclose;
	twbkfrmt.p_tablerowclose;
	--
    -- SOLICITA EL PARAMETRO DE TIPO DE CERTIFICADO
	twbkfrmt.p_tabledataopen;
	htp.formSelectOpen('psTraCe', 'Tipo CERT:   ');
	FOR x IN cCert LOOP
		twbkwbis.p_formselectoption(x.DESCR, x.GWBTIPO_TYPE);
	END LOOP;
	htp.formSelectClose;
	twbkfrmt.p_tabledataclose;
	twbkfrmt.p_tablerowclose;

	 twbkfrmt.p_tablerowopen ();
	 twbkfrmt.p_tabledataseparator (' ', ccolspan => 11);
	 twbkfrmt.p_tablerowclose;
	 twbkfrmt.p_tableclose;
	 HTP.formsubmit (NULL, g$_nls.get ('BWSKOTR1-0007', 'SQL', 'Submit'));
	 HTP.formclose;

  twbkwbis.p_closedoc (curr_release);
  COMMIT;
END PWRCERT3;
/


DROP PUBLIC SYNONYM PWRCERT3;

CREATE PUBLIC SYNONYM PWRCERT3 FOR BANINST1.PWRCERT3;


GRANT EXECUTE ON BANINST1.PWRCERT3 TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRCERT3 TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRCERT3 TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRCERT3 TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCERT3 TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCICO;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCICO (psReclDesc   VARCHAR2) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de Diferencia de Programas y Registro Estudiantil
         mdulo: reportes - uft.
         autor: AGM - Alejandro Gmez Mondragn
         fecha: 15/Ago/2013.
*******************************************************************************/

  -- declaracin de variables:
  vnExists              INTEGER      := 0;
  vnColumnas            INTEGER      := 12;
  vgsInicioPag          VARCHAR2(30) := NULL;         -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vnIdRenglon           INTEGER      := 1;
  tabColumna            Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);

   vsPerio              VARCHAR2(30) := NULL;
   vsEscu               VARCHAR2(30) := NULL;


  -- obtiene la informacin de los alumnos:
  -- Estudiantes Titulados SIES
  CURSOR cuReporte (psPerio VARCHAR2  DEFAULT NULL,
                                psEscu        VARCHAR2  DEFAULT NULL
                        ) IS

        -- Consulta para obtener el reporte
        -- Claves Impresiones y Correos
        SELECT  DISTINCT
        SPRIDEN_ID                                                          ID,
        UPPER(REPLACE(SPRIDEN_LAST_NAME,'*',' '))                           Apellidos,
        UPPER(TRIM(SPRIDEN_FIRST_NAME||' '||SPRIDEN_MI))                    Nombres,
        SPBPERS_NAME_SUFFIX                                                 RUT,
        STDN1.SGBSTDN_TERM_CODE_ADMIT                                       periodoIngreso,
        SMRPRLE_PROGRAM_DESC                                                descripcionPrograma,
        STVCOLL_DESC                                                        descripcionEscuela,
        (SELECT STVSTST_DESC FROM STVSTST
        WHERE STVSTST_CODE = stdn1.sgbstdn_stst_code)                       statusAlumno,
        (SELECT STVSTYP_DESC FROM STVSTYP
        WHERE STVSTYP_CODE = stdn1.sgbstdn_styp_code)                       tipoAlumno,
        (SELECT SPRADDR_STREET_LINE1||' '||SPRADDR_STREET_LINE2
        FROM SPRADDR  WHERE SPRADDR_ATYP_CODE = 'MA'
        AND ROWNUM = 1
        AND     SPRADDR_PIDM = SPRIDEN_PIDM)                              Impresion,
        (SELECT  GOREMAL_EMAIL_ADDRESS
                 FROM  GOREMAL
                              WHERE  GOREMAL_PIDM = SPRIDEN_PIDM
                              AND GOREMAL_EMAL_CODE = 'UFT' )               correoUFT,
        (SELECT  REPLACE(REPLACE(GOREMAL_EMAIL_ADDRESS, 'Cl@ve_inicial.:',''),'cl@ve_inicial.:','')
                 FROM  GOREMAL
                              WHERE  GOREMAL_PIDM = SPRIDEN_PIDM
                              AND GOREMAL_EMAL_CODE = '0001' )               contrasenaCorreo

        FROM     SPRIDEN
                ,SPBPERS
                ,SGBSTDN STDN1
                ,SMRPRLE
                ,STVCOLL
                ,TWBCNTR
                ,SPRADDR
        WHERE  STDN1.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(STDN2.SGBSTDN_TERM_CODE_EFF)
                                                  FROM  SGBSTDN STDN2
                                                  WHERE STDN2.SGBSTDN_PIDM = STDN1.SGBSTDN_PIDM
                                                  AND STDN2.SGBSTDN_TERM_CODE_EFF <= TWBCNTR_TERM_CODE )
            AND SMRPRLE_PROGRAM            = STDN1.SGBSTDN_PROGRAM_1
            AND STVCOLL_CODE               = STDN1.SGBSTDN_COLL_CODE_1
            AND SPRIDEN_PIDM               = STDN1.SGBSTDN_PIDM
            AND SPRIDEN_CHANGE_IND         IS NULL
            AND SPBPERS_PIDM(+)            = SPRIDEN_PIDM
            AND TWBCNTR_PIDM               = SPRIDEN_PIDM
            AND SPRADDR_PIDM(+)                = SPRIDEN_PIDM
            AND (STDN1.SGBSTDN_COLL_CODE_1 =  psEscu  OR psEscu IS NULL)
            AND (TWBCNTR_TERM_CODE = psPerio OR psPerio IS NULL)
            AND STDN1.SGBSTDN_STST_CODE IN('AS', 'EG', 'AL')
            AND STDN1.SGBSTDN_STYP_CODE IN('A', 'N', 'D', 'C')
            ;

---------------------------------------------------
-- bloque principal para la generacin del reporte
---------------------------------------------------
BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsPerio   := pk_ObjHtml.getValueCookie('psPerio');
   vsEscu    := pk_ObjHtml.getValueCookie('psEscu');


--   htp.p('<br>');
--   htp.p('vsPerio:'||vsPerio);
--   htp.p('<br>');
--   htp.p('vsEscur:'||vsEscu);





   -- determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   -- define los encabezados de las columnas:
   tabColumna(1)   := '<center> ID';
   tabColumna(2)   := '<center> Apellidos';
   tabColumna(3)   := '<center> Nombres';
   tabColumna(4)   := '<center> RUT';
   tabColumna(5)   := '<center> Per&iacute;odo Ingreso';
   tabColumna(6)   := '<center> Descripci&oacute;n Programa';
   tabColumna(7)   := '<center> Descripci&oacute;n Escuela';
   tabColumna(8)   := '<center> Estatus';
   tabColumna(9)   := '<center> Tipo Alumno';
   tabColumna(10)  := '<center> Clave de Impresi&oacute;n';
   tabColumna(11)  := '<center> Correo UFT';
   tabColumna(12)  := '<center> Contrasea de Correo';


   -- manipula la informacin obtenida por el cursor:
   FOR regRep IN cuReporte (vsPerio, vsEscu) LOOP

       IF vnExists = 0 THEN
          -- muestra el encabezado segn el periodo y programa seleccionados:
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsPerio||' - '||Pk_Catalogo.PERIODO(vsPerio)||'<br>'||'Escuela: &nbsp;'||vsEscu||' - '||Pk_Catalogo.Colegio(vsEscu),
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
       END IF;

       -- muestra los valores para cada registro:
       HTP.P('<tr> <td valign="top" align="center">'  ||regRep.ID ||'</td>
                   <td valign="top" align="left">'   ||regRep.Apellidos ||'</td>
                   <td valign="top" align="left">'   ||regRep.Nombres ||'</td>
                   <td valign="top" align="center">'   ||regRep.RUT ||'</td>
                   <td valign="top" align="left">'   ||regRep.periodoIngreso ||'</td>
                   <td valign="top" align="left">'   ||regRep.descripcionPrograma ||'</td>
                   <td valign="top" align="left">'   ||regRep.descripcionEscuela ||'</td>
                   <td valign="top" align="left">'   ||regRep.statusAlumno ||'</td>
                   <td valign="top" align="left">'   ||regRep.tipoAlumno ||'</td>
                   <td valign="top" align="left">'   ||regRep.Impresion ||'</td>
                   <td valign="top" align="left">'   ||regRep.correoUFT ||'</td>
                   <td valign="top" align="left">'   ||regRep.contrasenaCorreo ||'</td>
             </tr>');
       vnExists    := 1;
       vnIdRenglon := vnIdRenglon + 1;
   END LOOP;

   -- muestra el pie de reporte:
   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- omite el encabezado del reporte pero se agrega el salto de pgina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRCICO;
/


DROP PUBLIC SYNONYM PWRCICO;

CREATE PUBLIC SYNONYM PWRCICO FOR BANINST1.PWRCICO;


GRANT EXECUTE ON BANINST1.PWRCICO TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCLAS;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCLAS(psReclDesc VARCHAR2) IS
  vnRow        INTEGER                          := 0;
  vnExists     INTEGER                          := 0;
  vnColumnas   INTEGER                          := 1;
  vnSaltoPag   INTEGER                          := 30; --la variables utilizada para determinar la cantidad de registros que tiene una tabla para dar un salto de pagina
  tabColumna   Pk_Sisrepimp.tipoTabla          := Pk_Sisrepimp.tipoTabla(1);
  tabSubColu   Pk_Sisrepimp.tipoTabla          := Pk_Sisrepimp.tipoTabla(1);
  vsClase       VARCHAR2(50)                    := NULL;
  vsSeccion     VARCHAR2(3)                     := NULL;
  vgsUSR       VARCHAR2(500);
  vgsUsuario   VARCHAR2(300) := NULL;
  ckCount      INTEGER;
  ckNombres    owa_cookie.vc_arr;
  ckValores    owa_cookie.vc_arr;
  vgsInicoPag  VARCHAR2(10)  := NULL;       -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pagina para impresion
CURSOR cObjetos (psClase  VARCHAR2 DEFAULT NULL) IS
              SELECT gtvclas_class_code CLASE
                FROM gtvclas
              WHERE (gtvclas_class_code = psClase OR psClase IS NULL)
               ORDER BY 1;

BEGIN
   /* check/update the user's web session */
   IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

   --son buscadas los valores de las cookies para asignar los valores del filtro del query.
   ckCount := 0;
   owa_cookie.get_all(ckNombres,ckValores,ckCount);

   IF ckCount != 0 THEN
       FOR vnCOKIES IN 1..ckCount LOOP

             IF ckNOMBRES(vnCOKIES) = 'psClas' THEN
                 vsClase   := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'cookUsuario' THEN
                      vgsUsuario := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                      vsSeccion := ckValores(vnCOKIES);

             END IF;

       END LOOP;
   END IF;

   -- las instrucciones determinan el largo de la tabla
   FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabSubColu.EXTEND(vnI);
          tabColumna(vnI) := NULL;
          tabSubColu(vnI) := NULL;
   END LOOP;

   tabSubColu(1) := 'Clase ';

   FOR regRep IN cObjetos(vsClase) LOOP
          IF (vnRow = 0 OR vnRow = 30) THEN
              Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vgsInicoPag,'1','#000000',psUsuario=>vgsUSR,psSeccion=>vsSeccion);
              vgsInicoPag := 'SALTO';
              vnRow := 0;
              -- el procedimiento muestra sub titulos del reporte
              --p_Columnas(vnColumnas,tabSubColu);
              IF tabSubColu IS NOT NULL THEN
                Pk_Sisrepimp.vgsColor := tabSubColu(1);
              END IF;

              htp.p('<tr bgcolor="'||Pk_Sisrepimp.vgsColor||'">');
              FOR vnI IN 1..vnColumnas LOOP
                htp.p('<th class="h3" align="left" valign="bottom" bgcolor="#b1c9e1">'||tabSubColu(vnI)||'</th>');  --"#ffcc99"
              END LOOP;
              htp.p('</tr>');
          END IF;

          -- imprime los registros
          htp.p('<tr><td valign="top">'||regRep.Clase||'</td>');
          vnExists := 1;
          vnRow    := vnRow + 1;
          vsClase := regRep.clase;
   END LOOP;

   -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
   Pk_Sisrepimp.vgsSaltoImp := 'Imprime';
   vgsInicoPag:= 'PIE';

   -- es omitido el encabezado del reporte pero se agrega el salto de pgina
   Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vgsInicoPag,'0', psUsuario=>vgsUSR, psSeccion=>vsSeccion);

   IF vnExists = 0 THEN
       htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   END IF;

   htp.p('</table></body></html>');

EXCEPTION
   WHEN OTHERS THEN
            HTP.P(SQLERRM);

END PWRCLAS;
/


DROP PUBLIC SYNONYM PWRCLAS;

CREATE PUBLIC SYNONYM PWRCLAS FOR BANINST1.PWRCLAS;


GRANT EXECUTE ON BANINST1.PWRCLAS TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRCLAS TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRCLAS TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRCLAS TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCLAS TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCNAN;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCNAN (psReclDesc VARCHAR2)
IS
/******************************************************************************
PROCEDIMIENTO:          BANINST1.PWRCNAN
OBJETIVO:               Reporte de Contratos Anulados
AUTORES:                Guillermo Almazan Ibaez
FECHA:                  29/12/2010
******************************************************************************/
   vnRow         INTEGER := 0;
   vnExists      INTEGER := 0;
   vnColumnas    INTEGER := 11;
   tabColumna    Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla (1);
   vsPrograma    sgbstdn.sgbstdn_program_1%type;
   vsUniDe      twbelim.twbelim_sbgd_code%type;
   vsPeriodo     twbelim.twbelim_term_code%type;
   vsContrato    twbelim.twbelim_cntr_num%type;
   vsInicioPag   VARCHAR2 (10) := NULL;
   vsHold        VARCHAR2(5):= NULL;
   -- CURSOR DE GENERA LOS DATOS DEL REPORTE
   CURSOR cuReporte(vsPrograma in sgbstdn.sgbstdn_program_1%type,
					vsUniDe   in twbelim.twbelim_sbgd_code%type,
					vsPeriodo  in twbelim.twbelim_term_code%type,
					vsContrato in twbelim.twbelim_cntr_num%type)
   IS
select cont, monto, fcon, fecha, observ, rut, nomb, prog, dprog, univ_cod, univ, motivo
from (
select twbelim_cntr_num                                                                                         cont
	 , to_char(pk_matricula.f_MontoContrato(twbelim_cntr_num), pk_contrato.constglformato)                      monto
	 , twbcntr_issue_date                                                                                       fcon
	 --, twbcntr_activity_date                                                                                    fecha
	 , twbelim_activity_date                                                                                    fecha
	 , pk_matricula.f_comecont(twbcntr_num)                                                                     observ
	 , f_get_rut(twbelim_pidm)                                                                                  rut
	 , f_get_nombre(twbelim_pidm)                                                                               nomb
	 , twbelim_term_code                                                                                        per
	 , f_get_programa(twbelim_pidm, twbelim_term_code)                                                          prog
	 , pk_catalogo.programa(f_get_programa(twbelim_pidm, twbelim_term_code))                                    dprog
	 , twbelim_sbgd_code                                                                                        univ_cod
	 , sovsbgv_desc                                                                                             univ
	 , stvwrsn_desc                                                                                             motivo
from twbelim
   , twbcntr
   , sovsbgv
   , stvwrsn
where twbcntr_pidm = twbelim_pidm
  and twbcntr_term_code = twbelim_term_code
  and twbcntr_num = twbelim_cntr_num
  and sovsbgv_code(+) = twbelim_sbgd_code
  and stvwrsn_code(+) = twbelim_motivo
  and not exists (select 1
                    from twbretr
                    where twbretr_cntr_num = twbcntr_num)
  and twbcntr_status_ind = 'C')
where (vsPrograma = prog or vsPrograma is null)
  and (vsUniDe = univ_cod or vsUniDe is null)
  and (vsPeriodo = per or vsPeriodo is null)
  and (vsContrato = cont or vsContrato is null);

BEGIN

   IF Pk_Login.F_ValidacionDeAcceso (pk_login.vgsUSR)
   THEN
	  RETURN;
   END IF;

   /* Parmetros */
   --Se busca el valor de la cookie (parmetro) para asignarlo al filtro del query.
   vsPrograma := pk_ObjHtml.getValueCookie ('psProgr');
   vsUniDe   := pk_ObjHtml.getValueCookie ('psUniDe');
   vsPeriodo  := pk_ObjHtml.getValueCookie ('psPerio');
   vsContrato := pk_ObjHtml.getValueCookie ('psId');

  -- Nmero de columnas de la tabla --
   FOR vnI IN 1 .. vnColumnas
   LOOP
	  tabColumna.EXTEND (vnI);
	  tabColumna (vnI) := NULL;
   END LOOP;

   /* Encabezado de las columnas */
   tabColumna (1) := 'Contrato';
   tabColumna (2) := 'Monto';
   tabColumna (3) := 'Fecha<br>Contrato';
   tabColumna (4) := 'Fecha<br>anulacion';
   tabColumna (5) := 'Observacion';
   tabColumna (6) := 'Rut Alumno';
   tabColumna (7) := 'Alumno';
   tabColumna (8) := 'Programa';
   tabColumna (9) := 'Descripcin';
   tabColumna (10) := 'Universidad<br>Destino';
   tabColumna (11) := 'Motivo';

	  FOR regRep IN cuReporte(vsPrograma, vsUniDe, vsPeriodo, vsContrato) LOOP
		  IF vnRow = 0 THEN
			 Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag, psUsuario=>pk_login.vgsUSR);
			 vsInicioPag := 'SALTO';
			 vnRow  := 0;
		  END IF;

		  htp.p(
		  '<tr>
		  <td valign="top">' || regRep.CONT   ||'</td>
		  <td valign="top">' || regRep.monto   ||'</td>
		  <td valign="top">' || regRep.FCON  ||'</td>
		  <td valign="top">' || regRep.FECHA ||'</td>
		  <td valign="top">' || regRep.OBSERV  ||'</td>
		  <td valign="top">' || regRep.RUT  ||'</td>
		  <td valign="top">' || regRep.NOMB ||'</td>
		  <td valign="top">' || regRep.PROG ||'</td>
		  <td valign="top">' || regRep.DPROG ||'</td>
		  <td valign="top">' || regRep.UNIV ||'</td>
		  <td valign="top">' || regRep.MOTIVO ||'</td>
		  </tr>');

		  vnExists   := 1;
		  vnRow      := vnRow + 1;
	  END LOOP;

   IF vnExists = 0 THEN
	  HTP.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
	  -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
	  Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

	  -- es omitido el encabezado del reporte pero se agrega el salto de pagina
	  Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
   END IF;

   HTP.p ('</table><br/></body></html>');
EXCEPTION
   WHEN OTHERS
   THEN
	  HTP.P (SQLERRM);
END PWRCNAN;
/


DROP PUBLIC SYNONYM PWRCNAN;

CREATE PUBLIC SYNONYM PWRCNAN FOR BANINST1.PWRCNAN;


GRANT EXECUTE ON BANINST1.PWRCNAN TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRCNAN TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRCNAN TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRCNAN TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCNAN TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCNCP;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCNCP(psReclDesc VARCHAR2) IS
/*
         Tarea: REPORTE DE CURSOS QUE NO CUMPLEN CON EL PLAN DE ESTUDIOS
        Modulo: Programacin academica
         Autor: GEPC

  Modificacin: 12/11/2008
                AMR
                1. Agregar la columna "Parte de periodo", despus de la columna "Escuela"
                2. Agregar la columna "Alumnos inscritos", despus de la columna "Mtodo instruccional"

  Modificacin: 25/11/2009
                CCR
                Se agrego la tabla SSBOVRR al cursor para obtener bien el filtro de la escuela

  Modificacion: 14/12/2009
                EAMM
                Se agrego el manejo de las escuelas para el filtro de las mismas

*/

  vgsUSR          VARCHAR2(500);
  ckCount         INTEGER;
  ckNombres       owa_cookie.vc_arr;
  ckValores       owa_cookie.vc_arr;
  vgsInicioPag    VARCHAR2(10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion

  vnExists        INTEGER                          := 0;
  vnColumnas      INTEGER                          := 13;
  tabColumna      Pk_Sisrepimp.tipoTabla           := Pk_Sisrepimp.tipoTabla(1);
  vsPerio         VARCHAR2(100)                    := NULL;
  vsFacu          VARCHAR2(100)                    := NULL;
  vsSeccion       VARCHAR2(3)                      := NULL;
  vsStatus        VARCHAR2(50)                     := NULL;
  vsMetodo        VARCHAR2(50)                     := NULL;

  CURSOR cuReporte(psTerm       VARCHAR2 DEFAULT NULL,
                   psStat       VARCHAR2 DEFAULT NULL,
                   psFacu       VARCHAR2 DEFAULT NULL,
                   psMetod      VARCHAR2 DEFAULT NULL) IS
         SELECT SS.SSBSECT_TERM_CODE                               PERIODO,
                NVL(SS.SSBSECT_CAMP_CODE,'S/Univ')                 UNIVERSIDAD,
                Pk_Catalogo.UNIVERSIDAD(SSBSECT_CAMP_CODE)         DESC_UNIVERSIDAD,
                --Pk_Catalogo.COLEGIO(SCBCRSE_COLL_CODE)             ESCUELA,
                Pk_Catalogo.COLEGIO(DECODE (SR.SSBOVRR_COLL_CODE, NULL, SCBCRSE_COLL_CODE, SR.SSBOVRR_COLL_CODE )) ESCUELA,
                SSBSECT_PTRM_CODE||' '||SSBSECT_PTRM_START_DATE||' '||SSBSECT_PTRM_END_DATE||' '||SSBSECT_PTRM_WEEKS PARTEPER,
                SSBSECT_CRN                                        NRC,
                SCBCRSE_SUBJ_CODE                                  SUBJ,
                SCBCRSE_CRSE_NUMB                                  CURSO,
                SCBCRSE_TITLE                                      NOMBRE,
                SUM(SSRMEET_HRS_WEEK)                              HRS_PROG,
                SCBCRSE_CONT_HR_LOW                                HRS_PLAN,
                Pk_Catalogo.STATUS_1(SSBSECT_SSTS_CODE)            STATUS,
                SSRXLST_XLST_GROUP                                 LISTA_CRUZADA,
                DECODE(SWRXLST_TYPE,'M','Master','S','Simultneo','Independiente') TIPO_LISTA,
                Pk_Catalogo.INSTMETH(SSBSECT_INSM_CODE)            METODO,
                SSBSECT_ENRL                                       ALUMNOS_INSC
           FROM SSBSECT SS,
                SCBCRSE,
                SSRMEET,
                SWRXLST,
                SSRXLST,
                SSBOVRR SR
          WHERE SSBSECT_SUBJ_CODE    = SCBCRSE_SUBJ_CODE
            AND SSBSECT_CRSE_NUMB    = SCBCRSE_CRSE_NUMB
            AND SSBSECT_CRN          = SSRMEET_CRN
            AND SSBSECT_TERM_CODE    = SSRMEET_TERM_CODE
            AND SCBCRSE_EFF_TERM     = (SELECT MAX(SB.SCBCRSE_EFF_TERM)
                                          FROM SCBCRSE SB
                                         WHERE SB.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                           AND SB.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB
                                           AND SB.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE)
            AND SSBSECT_TERM_CODE    = SSRXLST_TERM_CODE(+)
            AND SSBSECT_CRN          = SSRXLST_CRN(+)
            AND SSRXLST_TERM_CODE    = SWRXLST_TERM_CODE(+)
            AND SSRXLST_CRN          = SWRXLST_CRN(+)
            AND SSRXLST_XLST_GROUP   = SWRXLST_XLST_GROUP(+)
            AND SS.SSBSECT_CRN       = SR.SSBOVRR_CRN (+)
            AND SS.SSBSECT_TERM_CODE = SR.SSBOVRR_TERM_CODE (+)
            AND (SSBSECT_TERM_CODE   = psTerm  OR psTerm  IS NULL)
            AND (SSBSECT_SSTS_CODE   = psStat  OR psStat  IS NULL)
            AND (DECODE(SR.SSBOVRR_COLL_CODE, NULL, SCBCRSE_COLL_CODE, SR.SSBOVRR_COLL_CODE ) = psFacu  OR psFacu  IS NULL)
            AND (SSBSECT_INSM_CODE   = psMetod OR psMetod IS NULL)
         HAVING SCBCRSE_CONT_HR_LOW <> SUM(SSRMEET_HRS_WEEK)
       GROUP BY SS.SSBSECT_TERM_CODE,
                SS.SSBSECT_CAMP_CODE,
                --Pk_Catalogo.COLEGIO(SCBCRSE_COLL_CODE),
                Pk_Catalogo.COLEGIO(DECODE (SR.SSBOVRR_COLL_CODE, NULL, SCBCRSE_COLL_CODE, SR.SSBOVRR_COLL_CODE )),
                SSBSECT_PTRM_CODE||' '||SSBSECT_PTRM_START_DATE||' '||SSBSECT_PTRM_END_DATE||' '||SSBSECT_PTRM_WEEKS,
                SSBSECT_CRN,
                SCBCRSE_SUBJ_CODE,
                SCBCRSE_CRSE_NUMB,
                SCBCRSE_TITLE,
                SCBCRSE_CONT_HR_LOW,
                Pk_Catalogo.STATUS_1(SSBSECT_SSTS_CODE),
                SSRXLST_XLST_GROUP,
                DECODE(SWRXLST_TYPE,'M','Master','S','Simultneo','Independiente'),
                Pk_Catalogo.INSTMETH(SSBSECT_INSM_CODE),
                SSBSECT_ENRL
       ORDER BY PERIODO DESC, DESC_UNIVERSIDAD, ESCUELA, NOMBRE;

  BEGIN
      /* Check/update the user's web session */
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
         FOR vnCOKIES IN 1..ckCount LOOP
                 IF ckNOMBRES(vnCOKIES) = 'psPerio' THEN
                 vsPerio := ckValores(vnCOKIES);
             ELSIF ckNOMBRES(vnCOKIES) = 'psStat1' THEN
                 vsStatus := ckValores(vnCOKIES);
             ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                 vsFacu := ckValores(vnCOKIES);
             ELSIF ckNOMBRES(vnCOKIES) = 'psMetod' THEN
                 vsMetodo := ckValores(vnCOKIES);
             ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                 vsSeccion := ckValores(vnCOKIES);
             END IF;
         END LOOP;
      END IF;

-- Las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := 'Escuela';
      tabColumna(2)  := 'Parte Periodo';
      tabColumna(3)  := 'NRC';
      tabColumna(4)  := 'Materia';
      tabColumna(5)  := 'Curso';
      tabColumna(6)  := 'Nombre';
      tabColumna(7)  := 'Horas programadas';
      tabColumna(8)  := 'Horas plan';
      tabColumna(9)  := 'Status';
      tabColumna(10)  := 'Lista cruzada';
      tabColumna(11) := 'Tipo de curso';
      tabColumna(12) := 'M&eacute;todo instruccional';
      tabColumna(13) := 'Alumnos Inscritos';

      FOR regRep IN cuReporte(vsPerio, vsStatus, vsFacu, vsMetodo) LOOP

          IF vnExists = 0 THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,vgsInicioPag,'1',psSubtitulo=>'Periodo '||regRep.Periodo,psUsuario=>vgsUSR,psSeccion=>vsSeccion, psSinLogo=>'sin');
             vgsInicioPag := 'SALTO';
          END IF;

          htp.p('<tr><td valign="top">'  ||regRep.Escuela ||'</td>
          <td valign="top" align="left">'||regRep.PARTEPER||'</td>
          <td valign="top" align="left">'||regRep.NRC     ||'</td>
          <td valign="top" align="left">'||regRep.Subj    ||'</td>
          <td valign="top" align="left">'||regRep.Curso   ||'</td>
          <td valign="top" align="left">'||regRep.Nombre  ||'</td>
          <td valign="top" align="left">'||regRep.Hrs_prog||'</td>
          <td valign="top" align="left">'||regRep.Hrs_plan||'</td>
          <td valign="top" align="left">'||regRep.Status  ||'</td>
          <td valign="top" align="left">'||regRep.Lista_cruzada||'</td>
          <td valign="top" align="left">'||regRep.Tipo_lista   ||'</td>
          <td valign="top" align="left">'||regRep.Metodo       ||'</td>
          <td valign="top" align="left">'||regRep.ALUMNOS_INSC ||'</td></tr>');

          vnExists := 1;

      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      END IF;

      htp.p('</table></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           htp.p( SQLERRM);

  END PWRCNCP;
/


DROP PUBLIC SYNONYM PWRCNCP;

CREATE PUBLIC SYNONYM PWRCNCP FOR BANINST1.PWRCNCP;


GRANT EXECUTE ON BANINST1.PWRCNCP TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCNCP TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCNOT;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCNOT(psReclDesc VARCHAR2) IS

/*
         Tarea: Impresin de Concentracin de NOTAS UFT --- Adicional de CERTIFICADOS
        Modulo: Historia Academica
         Fecha: 14/06/2012.
         Autor: MAC

        - Se Implemento funcion JSCRIPT  -  fImprimeReporte() -  para poder Imprimirse

*/

  ckNombres   owa_cookie.vc_arr;
  ckValores   owa_cookie.vc_arr;
  ckCount     INTEGER;
  vgsUSR      VARCHAR2(500);
  global_pidm SPRIDEN.SPRIDEN_PIDM%TYPE;


  vsExp                  VARCHAR2(10)        := NULL;
  vsProg                 VARCHAR2(20)        := NULL;
  vnCert                 INTEGER             := 0;
  vnRow                  INTEGER             := 0;
  vsDesDocto             VARCHAR2(50)        := NULL;
  vnTotTextos            INTEGER             := 0;
  vnEsdeDerecho          INTEGER             := 0;
  vsImpTexto             VARCHAR2(1000)      := NULL;
  vsPasoTexto            VARCHAR2(1200)      := NULL;
  vsBanExito             VARCHAR2(1)         := NULL;
  vsPeriodoT             VARCHAR2(10)        := NULL;
  vsError                VARCHAR2(500)       := NULL;

  vsNombre               VARCHAR2(100)       := NULL;
  vsRut                  VARCHAR2(20)        := NULL;
  vsAno                  VARCHAR2(4)         := NULL;
  vsClasstdn             VARCHAR2(300)       := NULL;
  vsHoldPdim             VARCHAR2(300)       := NULL;
  vsSchool               VARCHAR2(50)        := NULL;
  vsCarrera              VARCHAR2(50)        := NULL;
  vnConsecNo             NUMBER(15)          := 0;
  vsCode                 VARCHAR2(10)        := NULL;
  vsLevel                VARCHAR2(10)        := NULL;
  vsPeriodo              VARCHAR2(10)        := NULL;
  vsEscuela              VARCHAR2(2)         := 0;
  vsTitReporte           VARCHAR2(100)       := NULL;

  vnRegistros            Integer             := 0;

  vsImprime              VARCHAR2(1500)      := NULL;
  vsFecImprime           VARCHAR2(100)       := NULL;
  vnValida               INTEGER             := 0;
  vnLinHtp               Integer             := 0;
  vsCodHtp               VARCHAR2(5)         := NULL;
  vsFecEgreso            VARCHAR(30)         := NULL;
  vsFacultad             VARCHAR(30)         := NULL;
  vsStatCong             VARCHAR2(2)         := NULL;
  vsNomSpriden           VARCHAR2(100)       := NULL;
  vsEsAlumno             VARCHAR2(20)        := NULL;
  vsFueAlumno            VARCHAR2(20)        := NULL;
  vsElAlumno             VARCHAR2(20)        := NULL;
  vsSexo                 VARCHAR2(20)        := NULL;
  vsStdn1                VARCHAR2(8)         := NULL;
  vsStdn2                VARCHAR2(8)         := NULL;
  vsMesAnoStdn1          VARCHAR2(40)        := NULL;
  vsMesAnoStdn2          VARCHAR2(40)        := NULL;
  vs1erClaseStdn         VARCHAR2(10)        := NULL;
  vs1erAnoStdn           VARCHAR2(10)        := NULL;
  vsUltClaseStdn         VARCHAR2(10)        := NULL;
  vsUltAnoStdn           VARCHAR2(10)        := NULL;
  vsBeca                   VARCHAR2(5)            := NULL;

  vsBecadef             INTEGER                :=0;
  vnAprobNota            INTEGER             := 0;
  vnAprobSNota           INTEGER             := 0;
  vnReprobado            INTEGER             := 0;
  vnReprobadoSN          INTEGER             := 0;
  vnConvalidSN           INTEGER             := 0;
  vnHomologa            INTEGER             := 0; -- Se agrega variable para definir homologados
  vnConvalidCN           INTEGER             := 0; --aigui 30/05/2011: se agrega variable para los COnvalidados C/Notas
  vnConocReleva          INTEGER             := 0;
  vnPendientes           INTEGER             := 0;
  vnPromGralPon          NUMBER              := 0;
  vnCreditos             INTEGER             := 0;
  vnTblCalif             INTEGER             := 0;
  vnTblCred              INTEGER             := 0;
  vnTamReg               INTEGER             := 0;

  vnTotRegHD             INTEGER             := 0;
  vnTotRegBD             INTEGER             := 0;
  vnTotRegFT             INTEGER             := 0;
  vnTotBDY               INTEGER             := 0;
  vnSpaces               INTEGER             := 0;
  vnTabBD                INTEGER             := 0;
  vnCuantosBD            INTEGER             := 0;
  vnTotalBDY             INTEGER             := 0;
  vnTotPag               INTEGER             := 0;
  vnPagAct               INTEGER             := 0;
  cnCredit               INTEGER             := 0;

  vnLocSpac              INTEGER             := 0;
  vnLocSpac1             INTEGER             := 0;
  vnLocSpac2             INTEGER             := 0;
  vnValCert              INTEGER             := NULL;

  cnLinPag               INTEGER          := 40;

  cnModRep      CONSTANT    INTEGER          := 28;
  csY           CONSTANT    VARCHAR2(1)      := 'Y';
  csN           CONSTANT    VARCHAR2(1)      := 'N';
  cn0           CONSTANT    INTEGER          := 0;
  csParam       CONSTANT    VARCHAR2(7)      := 'psTraNt';
  csTRAbre      CONSTANT    VARCHAR2(43)     := '<tr bgcolor="#ffffff">';
  csTRCierra    CONSTANT    VARCHAR2(5)      := '</tr>';
  csH1          CONSTANT    VARCHAR2(91)     := '<FONT class="fontH1">';
  csH2          CONSTANT    VARCHAR2(91)     := '<FONT class="fontH2">';
  csTX          CONSTANT    VARCHAR2(93)     := '<FONT class="fontTX">';
  csER          CONSTANT    VARCHAR2(93)     := '<FONT class="fontER">';
  csNM          CONSTANT    VARCHAR2(93)     := '<FONT class="fontNM">';
  csNMB         CONSTANT    VARCHAR2(93)     := '<FONT class="fontNMB">';
  csT8          CONSTANT    VARCHAR2(93)     := '<FONT class="fontT8">';
  csT10         CONSTANT    VARCHAR2(93)     := '<FONT class="fontT10">';
  csFF          CONSTANT    VARCHAR2(7)      := '</FONT>'  ;

  csLBlanco     CONSTANT    VARCHAR2(49)     := '<tr><td class="fontNM" >&nbsp;</td></tr>';
  csLBlancoC    CONSTANT    VARCHAR2(69)     := '<tr><td class="fontNM" ><B>CREDITOS :</B></td></tr>';
  csLBlancoH    CONSTANT    VARCHAR2(49)     := '<tr><td class="fontH2" >&nbsp;</td></tr>';
  csCenter      CONSTANT    VARCHAR2(6)      := 'CENTER';
  csLeft        CONSTANT    VARCHAR2(4)      := 'LEFT';
  csRight       CONSTANT    VARCHAR2(5)      := 'RIGHT';

  CURSOR cu_Texto (pnTexto  Integer, psTipoD VARCHAR2 ) IS
        SELECT  SWRRLEY_DOCTO_CODE      rDocto,
                SWRRLEY_CONSEC          rConsec,
                SWRRLEY_DESC_LEY        rDesc,
                SWRRLEY_TYPE_JUST       rJustif,
                SWRRLEY_TYPE_FONT       rFont,
                SWRRLEY_PART_DOCTO      rPDocto
          FROM  SWRRLEY
         WHERE  SWRRLEY_TYPE_PARA  = csParam
           AND  SWRRLEY_RECMCODE   = cnModRep
           AND  SWRRLEY_DOCTO_CODE = pnTexto
           AND  SWRRLEY_PART_DOCTO = psTipoD
      ORDER BY  SWRRLEY_CONSEC;

  CURSOR cuTABLACALIF ( pnPdim  NUMBER,psTipoD Integer,psBecadef Integer ) IS
            SELECT  CODIGO, ASIGNATURA, NOTA, CREDITO, RESULTADO, SEMANO, PERIODO
              FROM (
                    SELECT  SHRTCKN_CRSE_NUMB                                   AS  CODIGO,
                                SHRTCKN_CRSE_TITLE                                  AS  ASIGNATURA,
                                SHRTCKG_GRDE_CODE_FINAL                        AS  NOTA,
                                SHRTCKG_CREDIT_HOURS                                AS  CREDITO,
                            CASE
                                WHEN INSTR(SHRTCKG_GRDE_CODE_FINAL,',') > 0 THEN
                                   CASE
                                      WHEN TO_NUMBER(NVL(TRIM(REPLACE(SHRTCKG_GRDE_CODE_FINAL, ',', '.')),0),'9999.99') BETWEEN 4 AND 7 THEN 'APROBADO'
                                      WHEN TO_NUMBER(NVL(TRIM(REPLACE(SHRTCKG_GRDE_CODE_FINAL, ',', '.')),0),'9999.99') BETWEEN 0 AND 3.9 THEN 'REPROBADO'
                                      ELSE '********'
                                   END
                                WHEN INSTR(SHRTCKG_GRDE_CODE_FINAL,',') = 0 THEN
                                   CASE WHEN SHRTCKG_GRDE_CODE_FINAL = 'AC' THEN 'APROBADO S/N'
                                        WHEN SHRTCKG_GRDE_CODE_FINAL = 'P'  THEN 'PENDIENTE'
                                        WHEN SHRTCKG_GRDE_CODE_FINAL = 'C'  THEN 'CONVALIDADO'
                                        WHEN SHRTCKG_GRDE_CODE_FINAL = 'AD' THEN 'REPROBADO S/N'
                                        --aigui 31/05/2012: RE debe decir reprobado, no *********
                                        when SHRTCKG_GRDE_CODE_FINAL = 'RE' THEN 'REPROBADO'
                                   ELSE '*********'
                                   END
                                 END                                            AS  RESULTADO,
                            CASE
                                WHEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),5,2) = '25' THEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),1,4)||'-1'
                                WHEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),5,2) = '75' THEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),1,4)||'-2'
                                WHEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),5,2) = '10' THEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),1,4)
                                WHEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),5,2) = '05' THEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),1,4)||'-3'
                                WHEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),5,2) = '50' THEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),1,4)||'-4'
                                ELSE  '******'
                            END                                                 AS  SEMANO ,
                            SHRTCKN_TERM_CODE                        AS  PERIODO
                      FROM  SHRTCKN, SHRTCKG A, SHRTCKL
                      WHERE SHRTCKN_PIDM         = pnPdim
                        AND (SHRTCKN_TERM_CODE   = vsPeriodo  OR vsPeriodo IS NULL)
                        AND SHRTCKG_PIDM         = SHRTCKN_PIDM
                        AND SHRTCKN_SEQ_NO       = SHRTCKG_TCKN_SEQ_NO
                        AND SHRTCKN_TERM_CODE    = SHRTCKG_TERM_CODE
                        AND SHRTCKN_PIDM         = SHRTCKL_PIDM
                        AND SHRTCKN_TERM_CODE    = SHRTCKL_TERM_CODE
                        AND SHRTCKG_TCKN_SEQ_NO  = SHRTCKL_TCKN_SEQ_NO
                          AND A.SHRTCKG_SEQ_NO = (SELECT MAX(B.SHRTCKG_SEQ_NO) FROM SHRTCKG B
                                                                WHERE A.SHRTCKG_PIDM = B.SHRTCKG_PIDM
                                                                AND A.SHRTCKG_TERM_CODE = B.SHRTCKG_TERM_CODE
                                                                AND A.SHRTCKG_TCKN_SEQ_NO = B.SHRTCKG_TCKN_SEQ_NO)
                        AND SHRTCKL_LEVL_CODE    = vsLevel
                        --aigui 31/05/2012: n deben aparecer los NV en el reporte
                        and SHRTCKG_GRDE_CODE_FINAL <> 'NV'
                        and 1=psBecadef --no usados
                      union
                      SELECT  SHRTCKN_CRSE_NUMB                                   AS  CODIGO,
                                SHRTCKN_CRSE_TITLE                                  AS  ASIGNATURA,
                                SHRTCKG_GRDE_CODE_FINAL                        AS  NOTA,
                                SHRTCKG_CREDIT_HOURS                                AS  CREDITO,
                            CASE
                                WHEN INSTR(SHRTCKG_GRDE_CODE_FINAL,',') > 0 THEN
                                   CASE
                                      WHEN TO_NUMBER(NVL(TRIM(REPLACE(SHRTCKG_GRDE_CODE_FINAL, ',', '.')),0),'9999.99') BETWEEN 4 AND 7 THEN 'APROBADO'
                                      WHEN TO_NUMBER(NVL(TRIM(REPLACE(SHRTCKG_GRDE_CODE_FINAL, ',', '.')),0),'9999.99') BETWEEN 0 AND 3.9 THEN 'REPROBADO'
                                      ELSE '********'
                                   END
                                WHEN INSTR(SHRTCKG_GRDE_CODE_FINAL,',') = 0 THEN
                                   CASE WHEN SHRTCKG_GRDE_CODE_FINAL = 'AC' THEN 'APROBADO S/N'
                                        WHEN SHRTCKG_GRDE_CODE_FINAL = 'P'  THEN 'PENDIENTE'
                                        WHEN SHRTCKG_GRDE_CODE_FINAL = 'C'  THEN 'CONVALIDADO'
                                        WHEN SHRTCKG_GRDE_CODE_FINAL = 'AD' THEN 'REPROBADO S/N'
                                        --aigui 31/05/2012: RE debe decir reprobado, no *********
                                        when SHRTCKG_GRDE_CODE_FINAL = 'RE' THEN 'REPROBADO'
                                   ELSE '*********'
                                   END
                                 END                                            AS  RESULTADO,
                            CASE
                                WHEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),5,2) = '25' THEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),1,4)||'-1'
                                WHEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),5,2) = '75' THEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),1,4)||'-2'
                                WHEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),5,2) = '10' THEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),1,4)
                                WHEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),5,2) = '05' THEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),1,4)||'-3'
                                WHEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),5,2) = '50' THEN SUBSTR(TO_CHAR(SHRTCKN_TERM_CODE),1,4)||'-4'
                                ELSE  '******'
                            END                                                 AS  SEMANO ,
                            SHRTCKN_TERM_CODE                        AS  PERIODO
                      FROM  SHRTCKN, SHRTCKG A, SHRTCKL
                      WHERE SHRTCKN_PIDM         = pnPdim
                        AND (SHRTCKN_TERM_CODE   = vsPeriodo  OR vsPeriodo IS NULL)
                        AND exists (SELECT 1 FROM SMRDOUS
                                                    WHERE SMRDOUS_PIDM = SHRTCKN_PIDM
                                                        AND SMRDOUS_TERM_CODE = SHRTCKN_TERM_CODE
                                                        AND SMRDOUS_CRN = SHRTCKN_CRN
                                                        AND SMRDOUS_SUBJ_CODE = SMRDOUS_SUBJ_CODE
                                                        AND SMRDOUS_CRSE_NUMB = SMRDOUS_CRSE_NUMB)
                        AND SHRTCKG_PIDM         = SHRTCKN_PIDM
                        AND SHRTCKN_SEQ_NO       = SHRTCKG_TCKN_SEQ_NO
                        AND SHRTCKN_TERM_CODE    = SHRTCKG_TERM_CODE
                        AND SHRTCKN_PIDM         = SHRTCKL_PIDM
                        AND SHRTCKN_TERM_CODE    = SHRTCKL_TERM_CODE
                        AND SHRTCKG_TCKN_SEQ_NO  = SHRTCKL_TCKN_SEQ_NO
                          AND A.SHRTCKG_SEQ_NO = (SELECT MAX(B.SHRTCKG_SEQ_NO) FROM SHRTCKG B
                                                                WHERE A.SHRTCKG_PIDM = B.SHRTCKG_PIDM
                                                                AND A.SHRTCKG_TERM_CODE = B.SHRTCKG_TERM_CODE
                                                                AND A.SHRTCKG_TCKN_SEQ_NO = B.SHRTCKG_TCKN_SEQ_NO)
                        AND SHRTCKL_LEVL_CODE    = vsLevel
                        --aigui 31/05/2012: n deben aparecer los NV en el reporte
                        and SHRTCKG_GRDE_CODE_FINAL <> 'NV'
                        and 2=psBecadef --usados
                   )
             WHERE (RESULTADO like CASE WHEN (psTipoD = 2 OR psTipoD = 4) THEN '%APROBADO%' END
                         OR psTipoD IS NULL )
          ORDER By  SEMANO--PERIODO DESC aigui 01/06/2012: se solicita que el ordenamiento sea natural y no descendente
          , CODIGO ASC;

  function f_ImprimeReporte ( pnDocto   INTEGER) RETURN VARCHAR2 IS

  vsRegreso     varchar2(1) := NULL;

  begin

     SELECT COUNT(SWRRLEY_DOCTO_CODE)
       INTO vnValida
     FROM SWRRLEY
    WHERE SWRRLEY_TYPE_PARA  = csParam
      AND SWRRLEY_RECMCODE   = cnModRep
      AND SWRRLEY_DOCTO_CODE = pnDocto;

    IF (vnValida > cn0)  THEN vsRegreso := csY; ELSE vsRegreso := csN; END IF;
    RETURN(vsRegreso);

  end ;

  function f_checaStudent ( pnPdim  NUMBER, psProg VARCHAR2) RETURN VARCHAR2 IS

  vscarre1   VARCHAR2(100)  := NULL;
  vscarre2   VARCHAR2(100)  := NULL;
  vsCode1    VARCHAR2(10)   := NULL;
  lnMatPer   Integer       := 0;

  begin
      --- Verifica que el Programa este Asociado a la Carrera del Estudiante  muestra leyenda de Carrera NO Valida.

         begin
            SELECT DISTINCT SGBSTDN_MAJR_CODE_1
                   INTO VSCODE1
              FROM SGBSTDN A
             WHERE A.SGBSTDN_PIDM          = pnPdim
               AND A.SGBSTDN_PROGRAM_1     = psProg;
         exception
              when no_data_found then
                   vsCode1   := null;
                   vscarre1  := '<br/><br/><P ALIGN="center" CLASS="csER">EL ALUMNO NO PERTENECE A ESE PROGRAMA.</P>';
              when others then
                   vsCode1   := null;
                   vscarre1  := '<br/><br/><P ALIGN="center" CLASS="csER">EL ALUMNO NO PERTENECE A ESE PROGRAMA.</P>';
         end;

      IF ( vscarre1 IS NULL) THEN vscarre1 := vscarre2; END IF;

      RETURN vscarre1;
  end;

  function f_TieneMaterias RETURN VARCHAR2 IS

  vsRegresa       VARCHAR2(300) := NULL;
  lnMatPer        Integer       := 0;
  lsMatP          CONSTANT    VARCHAR2(80)     := 'NO cuenta con registro curricular en el periodo seleccionado - '||vsPeriodo;

  begin

    -- Verifica si Tiene Materias del Periodo
    select count(sftregs_crn)
     into  lnmatper
     from  sftregs
    where  sftregs_pidm      = global_pidm
      and  (sftregs_term_code = vsPeriodo or vsPeriodo IS NULL) ;

    --- Verifica en SHACRSE
    if (lnMatPer = 0 ) then
        select count(shrtckn_crn)
          into lnmatper
          from shrtckn
         where shrtckn_pidm = global_pidm
           and  (shrtckn_term_code = vsPeriodo or vsPeriodo IS NULL) ;

            if (lnMatPer = 0 ) then vsRegresa:= lsMatP; end if;
    end if;

    return vsRegresa;

  end f_TieneMaterias;

  function f_TieneHolds (pnPeriodo VARCHAR2) RETURN VARCHAR2 IS

    lsClasstd       VARCHAR2(500)  := NULL;
    lnMatPer        Integer       := 0;
    lsCompl         VARCHAR2(17)  := 'tiene adeudo de ';
    lsMatP          CONSTANT    VARCHAR2(67)     := 'NO cuenta con registro curricular en el periodo seleccionado - ';
    lsHold          CONSTANT    VARCHAR2(65)     := '*** NO se pueden mostrar datos por que el alumno ';
    csSalLocal      VARCHAR2(300) := NULL;

  -- Verifica los HOLDS INVALIDOS, para impresin del Certificado
  CURSOR cuHold IS
        SELECT SPRHOLD_HLDD_CODE , STVHLDD_DESC||'- ' dHold
         FROM SPRHOLD, STVHLDD
         WHERE SPRHOLD_PIDM             = global_pidm
           AND SPRHOLD_HLDD_CODE        = STVHLDD_CODE
           AND STVHLDD_TRANS_HOLD_IND   IS NOT NULL
           AND TRUNC(SYSDATE)      BETWEEN TRUNC(SPRHOLD_FROM_DATE) AND TRUNC(SPRHOLD_TO_DATE) ;

  BEGIN

--    -- Verifica si Tiene Materias del Periodo
--    SELECT COUNT(SFTREGS_CRN)
--     INTO  lnMatPer
--     FROM  SFTREGS
--    WHERE  SFTREGS_PIDM      = global_pidm
--      AND  (SFTREGS_TERM_CODE = pnPeriodo or pnPeriodo IS NULL) ;
--
--    IF ( lnMatPer = 0) THEN
--       csSalLocal :=  lsHold||lsMatP;
--    END IF;

   --- Barre los HOLDS
    FOR vhold IN cuHold LOOP
      lsClasstd  :=  lsClasstd||vhold.dHold;
    END LOOP;
    IF (lsClasstd IS NOT NULL) THEN lsClasstd := lsHold ||''||lsCompl||lsClasstd||' ***'; END IF;

    RETURN lsClasstd;

    EXCEPTION
            WHEN no_data_found THEN
                lsClasstd := 'NO DATA';
                RETURN NULL;
            WHEN others        THEN
                lsClasstd := '***';
                RETURN NULL;

  END;

  procedure p_llenaEspacios ( pnEspacios  INTEGER) IS

  begin

    FOR vnJ IN  1..pnEspacios LOOP
       vnRegistros := vnRegistros +1;
       htp.p(csLBlanco);
    END LOOP;
  end p_llenaEspacios;

  procedure p_RegistraCertificado  IS

  vsClasstd  varchar2(300)  := null;

  begin
    --_____________________________________
     --- Nombre Legal
     BEGIN
         SELECT     NVL(REPLACE(SPBPERS_LEGAL_NAME,'*',' '),'Sin Nombre Legal')             Nombre,
                    SPBPERS_NAME_SUFFIX                             Suffix,
                    TO_CHAR(sysdate,'YYYY')                         ImpAno
            INTO vsNombre,       vsRut,      vsAno
            FROM SPBPERS
           WHERE SPBPERS_PIDM = global_pidm;
     EXCEPTION
         WHEN no_data_found THEN
          vsNombre  := '**********';
          vsRut     := '**********';
          vsAno     := '****';
     END;
    --_____________________________________
     -- Class_Code_Stdn
    --__ Vrifica que NO tenga HOLDS

    vsClasstd := f_TieneHolds( vsPeriodo);
    IF (vsClasstd IS NULL) THEN
       IF    ( SUBSTR(vsPeriodo,5,2) = '25') THEN
          vsClasstd := '1er Semestre';
          vsAno     :=  SUBSTR(vsPeriodo,1,4);
       ELSIF ( SUBSTR(vsPeriodo,5,2) = '75') THEN
          vsClasstd := '2do Semestre';
          vsAno     :=  SUBSTR(vsPeriodo,1,4);
       ELSIF ( SUBSTR(vsPeriodo,5,2) = '10') THEN
          vsClasstd := 'periodo anual';
          vsAno     :=  SUBSTR(vsPeriodo,1,4);
       ELSE
          vsClasstd := '*************';
          vsAno     :=  '****';
       END IF;
    END IF;

    vsClasstdn  := vsClasstd;
    --_____________________________________
     ---  Escuela
     BEGIN
         SELECT STVCOLL_DESC
           INTO vsSchool
          FROM STVCOLL
         WHERE STVCOLL_CODE  = vsEscuela;
     EXCEPTION
         WHEN no_data_found THEN
          vsSchool  := '**********';
     END;
    --_____________________________________
     ---  Carrera
     BEGIN
        SELECT STVMAJR_DESC
          INTO  vsCarrera
          FROM STVMAJR
         WHERE STVMAJR_CODE = vsCode;
     EXCEPTION
         WHEN no_data_found THEN
          vsCarrera  := '**********';
     END;
    --_____________________________________
     ---  Fecha de Egreso
     BEGIN
         SELECT NVL(TO_CHAR(MAX(SHRDGMR_APPL_DATE),'month'),'*********')||' de '||NVL(TO_CHAR(MAX(SHRDGMR_APPL_DATE),'YYYY'),'****')
           INTO vsFecEgreso
           FROM SHRDGMR
          WHERE SHRDGMR_PIDM        = global_pidm
            AND SHRDGMR_PROGRAM     = vsProg
            AND SHRDGMR_LEVL_CODE   = vsLevel
            AND SHRDGMR_MAJR_CODE_1 = vsCode;
     EXCEPTION
         WHEN no_data_found THEN
          vsFecEgreso  := '**********';
     END;
    --_____________________________________
     ---  Nombre de la Facultad
     BEGIN
         SELECT STVCAMP_DESC
           INTO vsFacultad
           FROM STVCAMP
          WHERE STVCAMP_CODE = vsFacultad;
     EXCEPTION
         WHEN no_data_found THEN
          vsFacultad  := '**********';
     END;
    --_____________________________________
     ---  Si Es la Carrera de Derecho
     BEGIN
         SELECT COUNT(STVMAJR_CODE)
           INTO vnEsdeDerecho
           FROM STVMAJR
          WHERE UPPER(STVMAJR_DESC) LIKE 'DERECHO%'
            AND STVMAJR_CODE = vsCode;
     EXCEPTION
         WHEN no_data_found THEN
          vnEsdeDerecho  := '**********';
     END;
    --_____________________________________
     ---  Nombre de Spriden
     BEGIN
         SELECT DISTINCT(REPLACE(SPRIDEN_LAST_NAME,'*',' ')||' '||SPRIDEN_FIRST_NAME)
           INTO  vsNomSpriden
           FROM SPRIDEN
          WHERE SPRIDEN_PIDM = global_pidm
              AND SPRIDEN_CHANGE_IND IS NULL;
     EXCEPTION
         WHEN no_data_found THEN
          vsNomSpriden  := '**********';
     END;
    --_______________________________________________________
      --- Palabras deacuerdo al Sexo del Estudiante
      vsSexo      := FWRSEXO(global_pidm);
      SELECT DECODE(vsSexo, 'Masculino','es alumno ' ,'Femenino','es alumna ' , 'es ****** ') INTO vsEsAlumno  FROM DUAL;
      SELECT DECODE(vsSexo, 'Masculino','fue alumno ','Femenino','fue alumna ', 'es ****** ') INTO vsFueAlumno FROM DUAL;
      SELECT DECODE(vsSexo, 'Masculino','el alumno ' ,'Femenino','la alumna ' , 'es ****** ') INTO vsElAlumno  FROM DUAL;
    --_______________________________________________________
     --- Fechas Inicio - Termino Carrera
     SELECT TO_CHAR(STVTERM_START_DATE,'month')||' de '||TO_CHAR(STVTERM_START_DATE,'YYYY')
       INTO vsMesAnoStdn1
       FROM STVTERM WHERE STVTERM_CODE =   vsStdn1;
     SELECT TO_CHAR(STVTERM_START_DATE,'month')||' de '||TO_CHAR(STVTERM_START_DATE,'YYYY')
       INTO vsMesAnoStdn2
       FROM STVTERM WHERE STVTERM_CODE =   vsStdn2;
    --_______________________________________________________
     -- Fechas Suspencion de Carrera
     SELECT CASE WHEN TO_NUMBER(TO_CHAR(STVTERM_START_DATE,'mm')) <= 6 THEN '1er' ELSE '2do' END,
            TO_CHAR(STVTERM_START_DATE,'YYYY')
       INTO vs1erClaseStdn, vs1erAnoStdn
       FROM STVTERM WHERE STVTERM_CODE =   vsStdn1;
     SELECT CASE WHEN TO_NUMBER(TO_CHAR(STVTERM_START_DATE,'mm')) <= 6 THEN '1er' ELSE '2do' END,
            TO_CHAR(STVTERM_START_DATE,'YYYY')
       INTO vsUltClaseStdn, vsUltAnoStdn
       FROM STVTERM WHERE STVTERM_CODE =   vsStdn2;

     vsBanExito  := 'N';
    --_______________________________________________________
     -- Transaccin de Bitacora de Impresiones --
     -- Obtiene Folio por Tipo de Modulo de Impresin ----
     BEGIN
         SELECT NVL(MAX(SWRSCRT_ID_CONSEC),0) + 1
           INTO vnConsecNo
           FROM SWRSCRT
          WHERE SWRSCRT_TYPE_PARA   = csParam
            AND SWRSCRT_DOCTO_CODE  = vnCert
            AND SWRSCRT_TERM_CODE   = NVL(vsPeriodo,'999999');

         INSERT INTO SWRSCRT (  SWRSCRT_TYPE_PARA,
                                SWRSCRT_TERM_CODE,      SWRSCRT_ID_CONSEC,      SWRSCRT_RECMCODE,
                                SWRSCRT_DOCTO_CODE,     SWRSCRT_PIDM,           SWRSCRT_NOMBRE,
                                SWRSCRT_RUT,            SWRSCRT_CLAS_STDN,      SWRSCRT_SCHO_STDN)
                     VALUES  (  csParam,
                                NVL(vsPeriodo,'999999'),vnConsecNo,             cnModRep,
                                vnCert,                 global_pidm,            vsNombre,
                                vsRut,               SUBSTR(vsClasstdn,0,29),   vsSchool
                             );
         COMMIT;
         vsBanExito := 'Y';
     EXCEPTION
        WHEN OTHERS THEN
               vsError := SUBSTR(SQLERRM,1,500);
               vsBanExito := 'N';
     END;

     vsFecImprime :=  TO_CHAR(sysdate,'DD')||' de '||TO_CHAR(sysdate,'month')||' de '||TO_CHAR(sysdate,'YYYY');

  end p_RegistraCertificado;

  function  p_ArmaLinea  ( psLinea  VARCHAR2) RETURN VARCHAR2  IS

  vsRegreso         VARCHAR2(1200)   := NULL;

  begin

     IF ( INSTR(psLinea,'||') > 0 ) THEN
        vsRegreso  := psLinea;

        ---  Remplaza Valores de Variables
        IF INSTR(vsRegreso,'||esAlumno')     > 0 THEN SELECT REPLACE(vsRegreso,'||esAlumno',vsEsAlumno)                             INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||fueAlumno')    > 0 THEN SELECT REPLACE(vsRegreso,'||fueAlumno',vsfueAlumno)                           INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||elAlumno')     > 0 THEN SELECT REPLACE(vsRegreso,'||elAlumno',vsElAlumno)                             INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||Nombre')       > 0 THEN SELECT REPLACE(vsRegreso,'||Nombre',UPPER(vsNombre))                          INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||RutSuffix')    > 0 THEN SELECT REPLACE(vsRegreso,'||RutSuffix',UPPER(vsRut))                          INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||ClaseSTDN')    > 0 THEN SELECT REPLACE(vsRegreso,'||ClaseSTDN',UPPER(vsClasstdn))                     INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||AnoGenRep')    > 0 THEN SELECT REPLACE(vsRegreso,'||AnoGenRep',UPPER(vsAno))                          INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||carrera')      > 0 THEN SELECT REPLACE(vsRegreso,'||carrera',UPPER(vsCarrera))                        INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||escuela')      > 0 THEN SELECT REPLACE(vsRegreso,'||escuela',UPPER(vsSchool))                         INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||FechaImprime') > 0 THEN SELECT REPLACE(vsRegreso,'||FechaImprime',vsFecImprime)                       INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||FolDocto')     > 0 THEN SELECT REPLACE(vsRegreso,'||FolDocto','<B>'||LPAD(vnConsecNo,6,'0')||'</B>')  INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||FecEgreso')    > 0 THEN SELECT REPLACE(vsRegreso,'||FecEgreso',vsFecEgreso)                           INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||Facultad')     > 0 THEN SELECT REPLACE(vsRegreso,'||Facultad',UPPER(vsFacultad))                      INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||NomSpriden')   > 0 THEN SELECT REPLACE(vsRegreso,'||NomSpriden',UPPER(vsNomSpriden))                  INTO vsRegreso FROM DUAL; END IF;

        IF INSTR(vsRegreso,'||mesAno1erStdn')> 0 THEN SELECT REPLACE(vsRegreso,'||mesAno1erStdn',vsMesAnoStdn1)                     INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||mesAnoUltStdn')> 0 THEN SELECT REPLACE(vsRegreso,'||mesAnoUltStdn',vsMesAnoStdn2)                     INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||1erClaseStdn') > 0 THEN SELECT REPLACE(vsRegreso,'||1erClaseStdn',vs1erClaseStdn)                     INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||1erAnoStdn')   > 0 THEN SELECT REPLACE(vsRegreso,'||1erAnoStdn',vs1erAnoStdn)                         INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||UltClaseStdn') > 0 THEN SELECT REPLACE(vsRegreso,'||UltClaseStdn',vsUltClaseStdn)                     INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||UltAnoStdn')   > 0 THEN SELECT REPLACE(vsRegreso,'||UltAnoStdn',vsUltAnoStdn)                         INTO vsRegreso FROM DUAL; END IF;

        IF INSTR(vsRegreso,'||styleH1')   > 0 THEN SELECT REPLACE(vsRegreso,'||styleH1',csH1)                                       INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||styleH2')   > 0 THEN SELECT REPLACE(vsRegreso,'||styleH2',csH2)                                       INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||styleTX')   > 0 THEN SELECT REPLACE(vsRegreso,'||styleH2',csTX)                                       INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||styleNM')   > 0 THEN SELECT REPLACE(vsRegreso,'||styleH2',csNM)                                       INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||styleNMB')  > 0 THEN SELECT REPLACE(vsRegreso,'||styleH2',csNMB)                                      INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||styleT8')   > 0 THEN SELECT REPLACE(vsRegreso,'||styleH2',cst8)                                       INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||styleH10')  > 0 THEN SELECT REPLACE(vsRegreso,'||styleH2',csT10)                                      INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||styleFF')   > 0 THEN SELECT REPLACE(vsRegreso,'||styleFF',csFF)                                       INTO vsRegreso FROM DUAL; END IF;

        IF INSTR(vsRegreso,'||paginaAct')   > 0 THEN SELECT REPLACE(vsRegreso,'||paginaAct',LPAD(vnPagAct,2,'0'))                   INTO vsRegreso FROM DUAL; END IF;
        IF INSTR(vsRegreso,'||paginaTot')   > 0 THEN SELECT REPLACE(vsRegreso,'||paginaTot',LPAD(vnTotPag,2,'0'))                   INTO vsRegreso FROM DUAL; END IF;

     ELSE
       vsRegreso  := psLinea;
     END IF;

    return vsRegreso;

  end  p_ArmaLinea;

  --- Imprime el Encabezado del Documento
  procedure p_headerDocto IS

  CURSOR cu_Header  IS
        SELECT  SWRRLEY_DOCTO_CODE      rDocto,
                SWRRLEY_CONSEC          rConsec,
                SWRRLEY_DESC_LEY        rDesc,
                SWRRLEY_TYPE_JUST       rJustif,
                SWRRLEY_TYPE_FONT       rFont,
                SWRRLEY_PART_DOCTO      rPDocto
          FROM  SWRRLEY
         WHERE  SWRRLEY_TYPE_PARA  = csParam
           AND  SWRRLEY_RECMCODE   = cnModRep
           AND  SWRRLEY_DOCTO_CODE = vnCert
           AND  SWRRLEY_PART_DOCTO = 'HD'
      ORDER BY  SWRRLEY_CONSEC;

    csHD    CONSTANT        VARCHAR(2)      := 'HD';
    csPasoTexto             VARCHAR2(1500)  := NULL;

  begin

     vnRegistros := vnRegistros +1;
     htp.p(csLBlanco);
     FOR reg_Header IN cu_Header   LOOP

        htp.p(csLBlancoH);
        -- Contador de Registros del Reporte
        vnRegistros := vnRegistros +2;
        --  Arma Linea con los Valores Requeridos
        csPasoTexto  :=  p_ArmaLinea(reg_Header.rDesc);

        htp.p(csTRAbre);
        vsImprime    := case
                        when reg_Header.rJustif = 'JUSTIFY' THEN  '<TD class="fontT10">'
                                                           ELSE  '<TD class="fontT10" align="'||reg_Header.rJustif||'" >'
                      end;
            --- Arma Cadena a Imprimir en el Formato
        vsImprime    := vsImprime||case
                                   when reg_Header.rFont = 'HH1'  THEN csH1||csPasoTexto||csFF||'</TD>'
                                   when reg_Header.rFont = 'HH2'  THEN csH2||csPasoTexto||csFF||'</TD>'
                                   when reg_Header.rFont = 'HH2A' THEN csTX||csPasoTexto||csFF||'</TD>'
                                   when reg_Header.rFont = 'FM1'  THEN csTX||csPasoTexto||csFF||'</TD>'
                                   when reg_Header.rFont = 'FT1'  THEN csTX||csPasoTexto||csFF||'</TD>'
                                   when reg_Header.rFont = 'TX1'  THEN '<P align="'||reg_Header.rJustif||'">'||csTX||csPasoTexto||csFF||'</P></TD>'
                                   else '</TD>'
                                 end;
        htp.p(vsImprime);
        htp.p(csTRCierra);

     END LOOP;   ----  FOR reg_Texto

  end p_headerDocto;

  procedure p_footerDocto IS
--aigui 01/0672012:
--en el registro del conteo de las paginas, agregue un -1 ya que siempre
--informaba qu la cantidad de paginas es una mas que las reales, espero algun
--da no tengan problemas por que les indica que hay 0 paginas, jajajaja

  CURSOR cu_Footer  IS
        SELECT  SWRRLEY_DOCTO_CODE      rDocto,
                SWRRLEY_CONSEC          rConsec,
                SWRRLEY_DESC_LEY        rDesc,
                SWRRLEY_TYPE_JUST       rJustif,
                SWRRLEY_TYPE_FONT       rFont,
                SWRRLEY_PART_DOCTO      rPDocto
          FROM  SWRRLEY
         WHERE  SWRRLEY_TYPE_PARA  = csParam
           AND  SWRRLEY_RECMCODE   = cnModRep
           AND  SWRRLEY_DOCTO_CODE = vnCert
           AND  SWRRLEY_PART_DOCTO = 'FT'
      ORDER BY  SWRRLEY_CONSEC;

    csHD    CONSTANT        VARCHAR(2)      := 'HD';
    csPasoTexto             VARCHAR2(1500)  := NULL;

  begin
     vnRegistros := vnRegistros +1;
     htp.p(csLBlanco);
     p_llenaEspacios ((cnLinPag - vnTotRegFT-2) - vnRegistros);

     FOR reg_Footer IN cu_Footer   LOOP

        -- Contador de Registros del Reporte
        vnRegistros := vnRegistros +1;
        --  Arma Linea con los Valores Requeridos
        csPasoTexto  :=  p_ArmaLinea(reg_Footer.rDesc);

        htp.p(csTRAbre);
        vsImprime    := case
                        when reg_Footer.rJustif = 'JUSTIFY' THEN  '<TD class="fontT10">'
                                                           ELSE  '<TD class="fontT10" align="'||reg_Footer.rJustif||'" >'
                      end;
            --- Arma CAdena a Imprimir en el Formato
        vsImprime    := vsImprime||case
                                   when reg_Footer.rFont = 'HH1'  THEN csH1||csPasoTexto||csFF||'</TD>'
                                   when reg_Footer.rFont = 'HH2'  THEN csH2||csPasoTexto||csFF||'</TD>'
                                   when reg_Footer.rFont = 'HH2A' THEN csTX||csPasoTexto||csFF||'</TD>'
                                   when reg_Footer.rFont = 'FM1'  THEN csTX||csPasoTexto||csFF||'</TD>'
                                   when reg_Footer.rFont = 'FT1'  THEN csTX||csPasoTexto||csFF||'</TD>'
                                   when reg_Footer.rFont = 'TX1'  THEN '<P align="'||reg_Footer.rJustif||'">'||csTX||csPasoTexto||csFF||'</P></TD>'
                                   else '</TD>'
                                 end;
        htp.p(vsImprime);
        htp.p(csTRCierra);

     END LOOP;   ----  FOR reg_Texto
     htp.p('</TABLE>');

  end p_footerDocto;

  procedure p_encCALIF IS

  begin

        htp.p(csTRAbre);
        htp.p('<TD>');
        htp.p('<TABLE BORDER="2" WIDTH="100%" ALIGN="CENTER" CELLSPACING="2" CELLPADDING="2"><TR>');
        htp.p('<TD align="center" width="10%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><b>CODIGO</b></TD>');
        htp.p('<TD align="left"   width="40%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><b>ASIGNATURA</b></TD>');
        htp.p('<TD align="center" width="10%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><b>NOTA</b></TD>');
        htp.p('<TD align="center" width="10%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><b>CREDITO</b></TD>');
        htp.p('<TD align="left"   width="20%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><b>RESULTADO</b></TD>');
        htp.p('<TD align="left"   width="10%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><b>AO/SEM</b></TD></TR>');

  end p_encCALIF;

  procedure p_encCREDNOTA IS

  CURSOR cuOtros  IS
          SELECT SHRTCKG_GMOD_CODE, COUNT(SHRTCKG_GMOD_CODE) TOTAL
        FROM SHRTCKG
        WHERE SHRTCKG_GMOD_CODE IN ('X','C','H')
          AND SHRTCKG_PIDM       = global_pidm
          AND ( SHRTCKG_TERM_CODE = vsPeriodo OR vsPeriodo IS NULL)
        GROUP BY SHRTCKG_GMOD_CODE;

  begin
     ---  Marcas Adicionales
     BEGIN
         FOR regOt IN cuOtros LOOP
           IF (regOt.SHRTCKG_GMOD_CODE = 'X')  THEN
               vnConocReleva  := regOt.TOTAL;
           ELSIF (regOt.SHRTCKG_GMOD_CODE = 'C')  THEN
               vnConvalidSN   := regOt.TOTAL;
           ELSIF (regOt.SHRTCKG_GMOD_CODE = 'H')  THEN
               vnHomologa   := regOt.TOTAL;
           END IF;

         END LOOP;
     EXCEPTION
         WHEN OTHERS THEN NULL;
     END;
     --- Crditos de la Carrera
--     BEGIN
--         SELECT DISTINCT SMBPGEN_REQ_CREDITS_OVERALL
--           INTO vnCreditos
--           FROM SMBPGEN
--          WHERE  SMBPGEN_PROGRAM       = vsProg
--            AND  SMBPGEN_ACTIVE_IND = 'Y';
--     EXCEPTION
--        WHEN OTHERS THEN NULL;
--     END;

     BEGIN
         IF ( vsPeriodo IS NULL) THEN
              SELECT DISTINCT (PromAcum)
                INTO vnPromGralPon
                FROM (
                     SELECT (SUM(SHRTGPA_QUALITY_POINTS) / SUM(SHRTGPA_GPA_HOURS)) PromAcum
                       FROM SHRTGPA, SHRGPAL
                      WHERE SHRTGPA_PIDM            = global_pidm
                        AND SHRTGPA_LEVL_CODE       = vsLevel
                        AND SHRTGPA_PIDM            = SHRGPAL_PIDM
                        AND SHRGPAL_LEVL_CODE       = SHRTGPA_LEVL_CODE
                        AND SHRGPAL_GPA_TYPE_IND    = SHRTGPA_GPA_TYPE_IND
--                   ORDER BY SHRTGPA_TERM_CODE
                     );
         ELSE
                 SELECT DISTINCT SHRTGPA_GPA
                   INTO vnPromGralPon
                   FROM SHRTGPA, SHRGPAL
                  WHERE SHRTGPA_PIDM            = global_pidm
                    AND SHRTGPA_LEVL_CODE       = vsLevel
                    AND SHRTGPA_PIDM            = SHRGPAL_PIDM
                    AND SHRGPAL_LEVL_CODE       = SHRTGPA_LEVL_CODE
                    AND SHRGPAL_GPA_TYPE_IND    = SHRTGPA_GPA_TYPE_IND
                    AND SHRTGPA_TERM_CODE       = vsPeriodo
               ORDER BY SHRTGPA_TERM_CODE;
         END IF;
     EXCEPTION
        WHEN OTHERS THEN NULL;
     END;

        htp.p(csLBlanco);
        htp.p(csLBlancoC);
        htp.p(csTRAbre);
        htp.p('<TD>');
        htp.p('<TABLE BORDER="2" WIDTH="100%" ALIGN="CENTER" CELLSPACING="2" CELLPADDING="2"><TR>');
        htp.p('<TD align="center" width="100%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center">');
        htp.p('<TABLE BORDER="0" WIDTH="100%" ALIGN="CENTER" CELLSPACING="2" CELLPADDING="2">');
        htp.p('<TR>');
        htp.p('<TD align="left" width="25%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center">Aprobados     [C/Notas] :</TD>');
        htp.p('<TD align="left" width="10%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><B>'||LPAD(vnAprobNota,2,'0')||'</B></TD>');
        htp.p('<TD align="left" width="25%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center">Homologados :        [S/Notas] :</TD>');
        htp.p('<TD align="left" width="10%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><B>'||LPAD(vnHomologa,2,'0')||'</B></TD>');
        htp.p('<TD align="left" width="20%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center">Pendientes       :</TD>');
        htp.p('<TD align="left" width="10%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><B>'||LPAD(vnPendientes,2,'0')||'</B></TD>');
        htp.p('</TR>');
        htp.p('<TR>');
        htp.p('<TD align="left" width="25%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center">Aprobados     [S/Notas] :</TD>');
        htp.p('<TD align="left" width="10%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><B>'||LPAD(vnAprobSNota,2,'0')||'</B></TD>');
        htp.p('<TD align="left" width="20%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center">&nbsp;</TD>');
        htp.p('<TD align="left" width="10%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center">&nbsp;</TD>');
        htp.p('<TD align="left" width="25%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center">Conoc. Relevantes         :</TD>');
        htp.p('<TD align="left" width="10%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><B>'||LPAD(vnConocReleva,2,'0')||'</B></TD>');

--        htp.p('<TD align="left" width="25%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center">Convalid.        [C/Notas] :</TD>');
--        htp.p('<TD align="left" width="10%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><B>'||LPAD(99,2,'0')||'</B></TD>');
        htp.p('</TR>');

        htp.p('<TR>');
        IF ( ( vnCert = 2) OR ( vnCert = 4) ) THEN
            htp.p('<TD align="left" colspan="4" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center">&nbsp;</TD>');
        ELSE
            htp.p('<TD align="left" width="25%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center">Reprobados   [C/Notas] :</TD>');
            htp.p('<TD align="left" width="10%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><B>'||LPAD(vnReprobado,2,'0')||'</B></TD>');
            htp.p('<TD align="left" width="25%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center">Reprobados   [S/Notas] :</TD>');
            htp.p('<TD align="left" width="10%" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><B>'||LPAD(vnReprobadoSN,2,'0')||'</B></TD>');
        END IF;
        htp.p('<TD align="left" colspan="2" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center">&nbsp;</TD>');
        htp.p('</TR>');

        htp.p('<TR>');
        htp.p('<TD align="left" colspan="6" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center">&nbsp;</TD>');
        htp.p('</TR>');
        htp.p('<TR>');
        htp.p('<TD align="left" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center">Promedio General de Notas   :</TD>');
        htp.p('<TD align="left"  colspan="2" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><B>'||to_char(vnPromGralPon,'90D90')||'</B></TD>');
        htp.p('<TD align="left" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center">Total Crditos    :</TD>');
        htp.p('<TD align="left"  colspan="2" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><B>'||to_char(vnCreditos,'9990')||'</B></TD>');
        htp.p('</TR>');
        htp.p('<TR>');
        htp.p('<TD align="left" colspan="6" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center">&nbsp;</TD>');
        htp.p('</TR>');
        htp.p('<TR>');
        htp.p('<TD align="left" colspan="6" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><b>La escala de notas es de 1.0 a 7.0 y la nota mnima de aprobacin es 4.0.</b></TD>');
        htp.p('</TR>');
        htp.p('<TR>');
        htp.p('<TD align="left" colspan="6" style="border-left:none;border-top:none;border-right:none;" class="tdFont7" valign="center"><b>El Promedio General de Notas se calcula en base al cumplimiento de avance de grado respectivo plan de estudio.</b></TD>');
        htp.p('</TR>');
        htp.p('</TABLE>');
        htp.p('</TD></TR>');
        htp.p('</TABLE></TD></TR>');

        vnRegistros := vnRegistros + cnCredit;

  end p_encCREDNOTA;

  procedure p_HTM IS

  begin
    -- desactiva ventana de espere ...
    htp.p('<script language="javascript" src="kwacnls.js"></script>');
    -- Inicializa la Pagina HTML
    htp.p('<html><head><title>'||vsTitReporte||'</title>
                <style type="text/css">
                    p   {font-family: Arial Narrow,verdana, helvetica; sans-serif;font-size: 8pt; font-weight: normal;font-style: normal;color: #000000;}
                    p.pER {font-family: Arial Narrow,verdana, helvetica; sans-serif;font-size: 8pt;font-weight: normal;  font-style: normal;color: #FF0000; text-align: center;}
                    td   {font-family: Arial Narrow,verdana, helvetica; sans-serif;font-size: 8pt; font-weight: normal;font-style: normal;color: #000000;}
                    td.tdER {font-family: Arial Narrow,verdana, helvetica; sans-serif;font-size: 8pt;font-weight: normal;  font-style: normal;color: #FF0000; text-align: center;}
                    font {font-family: Arial Narrow,verdana, helvetica; sans-serif;font-size: 8pt; font-weight: normal;font-style: normal;color: #000000;}
                    font.fontH1 {font-family: Arial Narrow,verdana, helvetica; sans-serif;font-size: 11pt;font-weight: bold;  font-style: normal;color: #000000;}
                    font.fontH2 {font-family: Arial Narrow,verdana, helvetica; sans-serif;font-size: 9pt;font-weight: bold;  font-style: normal;color: #000000;}
                    font.fontTX {font-family: Arial Narrow,verdana, helvetica; sans-serif;font-size: 8pt;font-weight: normal;font-style: normal;color: #000000;}
                    font.fontER {font-family: Arial Narrow,verdana, helvetica; sans-serif;font-size: 8pt;font-weight: bold;  font-style: normal;color: #FF0000; text-align: center;}
                    font.fontNM {font-family: Arial Narrow,verdana, helvetica; sans-serif;font-size: 10t;font-weight: normal;font-style: normal;color: #000000;}
                   font.fontNMB {font-family: Arial Narrow,verdana, helvetica; sans-serif;font-size: 10pt;font-weight: bold;  font-style: normal;color: #000000;}
                    font.fontT8 {font-family: Arial Narrow,verdana, helvetica; sans-serif;font-size: 8pt; font-weight: normal;font-style: normal;color: #000000;}
                   font.fontT10 {font-family: Arial Narrow,verdana, helvetica; sans-serif;font-size: 10pt;font-weight: normal;font-style: normal;color: #000000;}
                </style>
                <script language="JavaScript"><!--
                function fImprimeReporte() {
                              window.focus()
                              print();}
                //--></script>
          </head><body>');
  end p_HTM;

 function f_regresaBD (psBecadef Integer) retuRN INTEGER IS

   vnTotal     integer  := 0;
 begin

    if psBecadef=1 then

         SELECT COUNT(*)
          INTO  vnTotal
          FROM  SHRTCKN, SHRTCKG
         WHERE SHRTCKN_PIDM         = global_pidm
           AND (SHRTCKN_TERM_CODE   = vsPeriodo  OR vsPeriodo IS NULL)
           AND SHRTCKG_PIDM         = SHRTCKN_PIDM
           AND SHRTCKN_SEQ_NO       = SHRTCKG_TCKN_SEQ_NO
           AND SHRTCKN_TERM_CODE    = SHRTCKG_TERM_CODE
           --aigui 31/05/2012: n deben aparecer los NV en el reporte
           and SHRTCKG_GRDE_CODE_FINAL <> 'NV'
           AND
            CASE
                WHEN INSTR(SHRTCKG_GRDE_CODE_FINAL,',') > 0 THEN
                   CASE
                      WHEN TO_NUMBER(NVL(TRIM(REPLACE(SHRTCKG_GRDE_CODE_FINAL, ',', '.')),0),'9999.99') BETWEEN 4 AND 7 THEN 'APROBADO'
                      WHEN TO_NUMBER(NVL(TRIM(REPLACE(SHRTCKG_GRDE_CODE_FINAL, ',', '.')),0),'9999.99') BETWEEN 0 AND 3.9 THEN 'REPROBADO'
                      ELSE '********'
                   END
                WHEN INSTR(SHRTCKG_GRDE_CODE_FINAL,',') = 0 THEN
                   CASE WHEN SHRTCKG_GRDE_CODE_FINAL = 'AC' THEN 'APROBADO S/N'
                        WHEN SHRTCKG_GRDE_CODE_FINAL = 'P'  THEN 'PENDIENTE'
                        WHEN SHRTCKG_GRDE_CODE_FINAL = 'C'  THEN 'CONVALIDADO'
                        WHEN SHRTCKG_GRDE_CODE_FINAL = 'AD' THEN 'REPROBADO S/N'
                        --aigui 31/05/2012: RE debe decir reprobado, no *********
                        when SHRTCKG_GRDE_CODE_FINAL = 'RE' THEN 'REPROBADO'
                   ELSE '*********'
                   END
                 END  =    CASE WHEN (vnCert = 2 OR vnCert = 4) THEN 'APROBADO'
                                ELSE
                                    CASE
                                        WHEN INSTR(SHRTCKG_GRDE_CODE_FINAL,',') > 0 THEN
                                           CASE
                                              WHEN TO_NUMBER(NVL(TRIM(REPLACE(SHRTCKG_GRDE_CODE_FINAL, ',', '.')),0),'9999.99') BETWEEN 4 AND 7 THEN 'APROBADO'
                                              WHEN TO_NUMBER(NVL(TRIM(REPLACE(SHRTCKG_GRDE_CODE_FINAL, ',', '.')),0),'9999.99') BETWEEN 0 AND 3.9 THEN 'REPROBADO'
                                              ELSE '********'
                                           END
                                        WHEN INSTR(SHRTCKG_GRDE_CODE_FINAL,',') = 0 THEN
                                           CASE WHEN SHRTCKG_GRDE_CODE_FINAL = 'AC' THEN 'APROBADO S/N'
                                                WHEN SHRTCKG_GRDE_CODE_FINAL = 'P'  THEN 'PENDIENTE'
                                                WHEN SHRTCKG_GRDE_CODE_FINAL = 'C'  THEN 'CONVALIDADO'
                                                WHEN SHRTCKG_GRDE_CODE_FINAL = 'AD' THEN 'REPROBADO S/N'
                                                --aigui 31/05/2012: RE debe decir reprobado, no *********
                                                when SHRTCKG_GRDE_CODE_FINAL = 'RE' THEN 'REPROBADO'
                                           ELSE '*********'
                                           END
                                      END
                            END ;
       else

                SELECT COUNT(*)
          INTO  vnTotal
          FROM  SHRTCKN, SHRTCKG
         WHERE SHRTCKN_PIDM         = global_pidm
           AND (SHRTCKN_TERM_CODE   = vsPeriodo  OR vsPeriodo IS NULL)
           AND exists (SELECT 1 FROM SMRDOUS
                                                    WHERE SMRDOUS_PIDM = SHRTCKN_PIDM
                                                        AND SMRDOUS_TERM_CODE = SHRTCKN_TERM_CODE
                                                        AND SMRDOUS_CRN = SHRTCKN_CRN
                                                        AND SMRDOUS_SUBJ_CODE = SMRDOUS_SUBJ_CODE
                                                        AND SMRDOUS_CRSE_NUMB = SMRDOUS_CRSE_NUMB)
           AND SHRTCKG_PIDM         = SHRTCKN_PIDM
           AND SHRTCKN_SEQ_NO       = SHRTCKG_TCKN_SEQ_NO
           AND SHRTCKN_TERM_CODE    = SHRTCKG_TERM_CODE
           --aigui 31/05/2012: n deben aparecer los NV en el reporte
           and SHRTCKG_GRDE_CODE_FINAL <> 'NV'
           AND
            CASE
                WHEN INSTR(SHRTCKG_GRDE_CODE_FINAL,',') > 0 THEN
                   CASE
                      WHEN TO_NUMBER(NVL(TRIM(REPLACE(SHRTCKG_GRDE_CODE_FINAL, ',', '.')),0),'9999.99') BETWEEN 4 AND 7 THEN 'APROBADO'
                      WHEN TO_NUMBER(NVL(TRIM(REPLACE(SHRTCKG_GRDE_CODE_FINAL, ',', '.')),0),'9999.99') BETWEEN 0 AND 3.9 THEN 'REPROBADO'
                      ELSE '********'
                   END
                WHEN INSTR(SHRTCKG_GRDE_CODE_FINAL,',') = 0 THEN
                   CASE WHEN SHRTCKG_GRDE_CODE_FINAL = 'AC' THEN 'APROBADO S/N'
                        WHEN SHRTCKG_GRDE_CODE_FINAL = 'P'  THEN 'PENDIENTE'
                        WHEN SHRTCKG_GRDE_CODE_FINAL = 'C'  THEN 'CONVALIDADO'
                        WHEN SHRTCKG_GRDE_CODE_FINAL = 'AD' THEN 'REPROBADO S/N'
                        --aigui 31/05/2012: RE debe decir reprobado, no *********
                        when SHRTCKG_GRDE_CODE_FINAL = 'RE' THEN 'REPROBADO'
                   ELSE '*********'
                   END
                 END  =    CASE WHEN (vnCert = 2 OR vnCert = 4) THEN 'APROBADO'
                                ELSE
                                    CASE
                                        WHEN INSTR(SHRTCKG_GRDE_CODE_FINAL,',') > 0 THEN
                                           CASE
                                              WHEN TO_NUMBER(NVL(TRIM(REPLACE(SHRTCKG_GRDE_CODE_FINAL, ',', '.')),0),'9999.99') BETWEEN 4 AND 7 THEN 'APROBADO'
                                              WHEN TO_NUMBER(NVL(TRIM(REPLACE(SHRTCKG_GRDE_CODE_FINAL, ',', '.')),0),'9999.99') BETWEEN 0 AND 3.9 THEN 'REPROBADO'
                                              ELSE '********'
                                           END
                                        WHEN INSTR(SHRTCKG_GRDE_CODE_FINAL,',') = 0 THEN
                                           CASE WHEN SHRTCKG_GRDE_CODE_FINAL = 'AC' THEN 'APROBADO S/N'
                                                WHEN SHRTCKG_GRDE_CODE_FINAL = 'P'  THEN 'PENDIENTE'
                                                WHEN SHRTCKG_GRDE_CODE_FINAL = 'C'  THEN 'CONVALIDADO'
                                                WHEN SHRTCKG_GRDE_CODE_FINAL = 'AD' THEN 'REPROBADO S/N'
                                                --aigui 31/05/2012: RE debe decir reprobado, no *********
                                                when SHRTCKG_GRDE_CODE_FINAL = 'RE' THEN 'REPROBADO'
                                           ELSE '*********'
                                           END
                                      END
                            END ;
       end if;
     return vnTotal;
 end f_regresaBD;

 procedure p_detPAgina (psBecadef integer) IS

   CURSOR cuAdicional  IS
        SELECT  SWRRLEY_DESC_LEY   rDetalle
          FROM  SWRRLEY
         WHERE  SWRRLEY_TYPE_PARA  = csParam
           AND  SWRRLEY_RECMCODE   = cnModRep
           AND  SWRRLEY_DOCTO_CODE = vnCert
           AND  SWRRLEY_PART_DOCTO = 'BD'
           AND  SWRRLEY_DESC_LEY NOT IN ('||TABLACREDNOTA','||TABLACALIF');

  vnLocaliza    integer         := 0;
  vnLocaliza1   integer         := 0;
  vnLocaliza2   integer         := 0;
  vnValor       integer         := 0;
  vnCSon        integer         := 0;
  vsDetPaso     varchar2(1200)  := null;
  vbBandera     boolean         := true;
  vsError       varchar2(500)   := null;

 BEGIN
    -- Verifica que Documento y Asigna el Tamao de la Pagina
    IF ( ( vnCert = 3) OR ( vnCert = 4) ) THEN cnLinPag := 48; ELSE cnLinPag := 45;--42; aigui 01/06/2012: el tamao correcto del papel carta es 45
    END IF;

    --- Obtiene el numero de Registros del HD y FT Para delimitar la Hoja
    SELECT  (COUNT(SWRRLEY_PART_DOCTO) * 2) + 1
      INTO  vnTotRegHD
      FROM  SWRRLEY
     WHERE  SWRRLEY_TYPE_PARA  = csParam
       AND  SWRRLEY_RECMCODE   = cnModRep
       AND  SWRRLEY_DOCTO_CODE = vnCert
       AND  SWRRLEY_PART_DOCTO = 'HD';
    SELECT  (COUNT(SWRRLEY_PART_DOCTO)+ 1)
      INTO  vnTotRegFT
      FROM  SWRRLEY
     WHERE  SWRRLEY_TYPE_PARA  = csParam
       AND  SWRRLEY_RECMCODE   = cnModRep
       AND  SWRRLEY_DOCTO_CODE = vnCert
       AND  SWRRLEY_PART_DOCTO = 'FT';
    SELECT  COUNT(SWRRLEY_PART_DOCTO)
      INTO  vnTotRegBD
      FROM  SWRRLEY
     WHERE  SWRRLEY_TYPE_PARA  = csParam
       AND  SWRRLEY_RECMCODE   = cnModRep
       AND  SWRRLEY_DOCTO_CODE = vnCert
       AND  SWRRLEY_PART_DOCTO = 'BD'
       AND  SWRRLEY_DESC_LEY NOT IN ('||TABLACREDNOTA','||TABLACALIF');
    SELECT  COUNT(SWRRLEY_PART_DOCTO)
      INTO  vnTblCalif
      FROM  SWRRLEY
     WHERE  SWRRLEY_TYPE_PARA  = csParam
       AND  SWRRLEY_RECMCODE   = cnModRep
       AND  SWRRLEY_DOCTO_CODE = vnCert
       AND  SWRRLEY_PART_DOCTO = 'BD'
       AND  INSTR( SWRRLEY_DESC_LEY,'||TABLACALIF') > 0;
    SELECT  COUNT(SWRRLEY_PART_DOCTO)
      INTO  vnTblCred
      FROM  SWRRLEY
     WHERE  SWRRLEY_TYPE_PARA  = csParam
       AND  SWRRLEY_RECMCODE   = cnModRep
       AND  SWRRLEY_DOCTO_CODE = vnCert
       AND  SWRRLEY_PART_DOCTO = 'BD'
       AND  INSTR( SWRRLEY_DESC_LEY,'||TABLACREDNOTA') > 0;

    -- Verifica Lineas Adicionales a considerar en Tot de Hojas
    FOR regSpace IN cuAdicional LOOP

       vsDetPaso   := UPPER(regSpace.rDetalle);
       vnLocaliza  := INSTR(vsDetPaso,'SPACE(');
       vnLocaliza1 := INSTR(vsDetPaso,'<TABLE');

       --- Verifica los Espacios en Detalle - lineas en blanco
       IF ( vnLocaliza > 0 ) THEN
           vsDetPaso    := SUBSTR(vsDetPaso,(vnLocaliza + 6));
           vnLocaliza2  := INSTR(vsDetPaso,')');
--           htp.p('** '||vnLocaliza2||'--espaces--- '|| SUBSTR(vsDetPaso,1,(vnLocaliza2-1) )||' --');
           vnValor      := SUBSTR(vsDetPaso,1,(vnLocaliza2-1) );
           vnSpaces     := vnSpaces + vnValor;
       --  Verifica siHay tablas y Cuantos Renglones
       ELSIF ( vnLocaliza1 > 0 ) THEN
          WHILE ( vbBandera ) LOOP
             vnLocaliza2  := INSTR(vsDetPaso,'</TR>',vnLocaliza1);
             IF (vnLocaliza2 > 0 ) THEN
                vnCSon     := vnCSon +1;
                vsDetPaso  := SUBSTR(vsDetPaso,(vnLocaliza2 + 5));
             ELSE
              vbBandera := FALSE;
             END IF;
          END LOOP;
          vnTabBD   := vnTabBD +  vnCSon;
       END IF;
    END LOOP;
--    vnTabBD := vnTabBD - 1;

    IF ( vnTblCalif > 0 ) THEN

      --- Obtiene los registros a procesar
      vnTotalBDY  := f_regresaBD(psBecadef);

      IF ( vnTotalBDY >= (cnLinPag - ( vnTotRegHD + vnTotRegFT ) )  ) THEN
          vnTotalBDY  := vnTotalBDY +  ( (vnTotalBDY / (cnLinPag - ( vnTotRegHD + vnTotRegFT ) )) *  vnTotRegHD );
      END IF;
    END IF;

    if (vnTblCred > 0) THEN
       cnCredit := 8;
    END IF;

    --- Calcula el total de lineas a imprimir -- para determinar el total de hojas a Imprimir
    vnTamReg  := vnTotRegHD + vnTotRegFT + vnTotRegBD + vnTotalBDY + cnCredit + vnTabBD + vnTabBD ;
    --- Determina las Hojas a Imprimir
    vnTotPag  := CEIL( vnTamReg / cnLinPag);
    vnTotPag  := vnTotPag -1;
    --- Renglones Disponibles para Impresin
    --aigui 31/05/2012: pongo 30 para que solo imprima 27 lineas en el cuadro
    --son 27 mas 1 de cabeseros mas 2 de lineas
    vnTotBDY     :=  35;--(cnLinPag - ( vnTotRegHD + vnTotRegFT ) );
  EXCEPTION
     WHEN OTHERS THEN
        vsError := SUBSTR(SQLERRM,1,500);
        htp.p('Error al Determinar las Caracteristicas de la Pgina...'||vsError);
        RETURN;
  END p_detPAgina;

  procedure p_nuevaPAGINA IS

  begin
   htp.p('<table width="95%"   border="0" align="center">');
   vnPagAct  := vnPagAct  + 1;
   if (vnPagAct > 1) then htp.p(csLBlanco); end if;
  end p_nuevaPAGINA;

 ---___________________________________________________
 ---  INICIA PROCESO DE IMPRESION DEL CERTIFICADO
 ---___________________________________________________
  BEGIN
      /* Check/update the user's web session */
    IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
    vsExp       := pk_objHtml.getValueCookie('psExped');
    vsProg      := pk_objHtml.getValueCookie('psPgm');
    vnCert      := pk_objHtml.getValueCookie('psTraNt');
    vsPeriodoT  := pk_objHtml.getValueCookie('psPerio');
    vsBeca    := pk_objHTML.getValueCookie('psSoBec');
    -- Obtiene el Pidm
    global_pidm := f_get_pidm(vsExp);

    IF vsBeca = 'true' THEN vsBecadef:=2; --usados
    ELSE
     vsBecadef:=1; --no usados
    END IF;

    vsPeriodo   := vsPeriodoT;
    IF ( ( vnCert = 2) OR ( vnCert = 4) ) THEN vnValCert := vnCert; ELSE vnValCert := NULL; END IF;

    -- Obtiene el Nombre del Documento como referencia
    BEGIN
         SELECT GWBTIPO_DESC
           INTO vsDesDocto
           FROM GWBTIPO
          WHERE GWBTIPO_CODE = csParam
            AND TO_NUMBER(GWBTIPO_TYPE) = vnCert;
    EXCEPTION
        WHEN OTHERS THEN  NULL;
    END;
    vsTitReporte   := vsDesDocto;
    ---Informacin Bsica del Estudiante y Situacin Actual
    BEGIN
        SELECT     SGBSTDN_MAJR_CODE_1, SGBSTDN_LEVL_CODE,      SGBSTDN_CAMP_CODE,
                   SGBSTDN_STST_CODE, SGBSTDN_COLL_CODE_1
          INTO  vsCode, vsLevel, vsFacultad , vsStatCong, vsEscuela
          FROM  SGBSTDN
         WHERE SGBSTDN_PIDM          = global_pidm
           AND SGBSTDN_PROGRAM_1     = vsProg
           AND SGBSTDN_TERM_CODE_EFF = (SELECT MAX(SGBSTDN_TERM_CODE_EFF)
                                         FROM  SGBSTDN
                                        WHERE SGBSTDN_PIDM          = global_pidm
                                          AND SGBSTDN_PROGRAM_1     = vsProg);
    EXCEPTION
        WHEN OTHERS THEN  NULL;
    END;

    -- Obtiene los Periodos Inicio y Final del Estudiante y Carrera
    BEGIN
         SELECT  MIN(SGBSTDN_TERM_CODE_EFF) FMin, MAX(SGBSTDN_TERM_CODE_EFF) FMax
           INTO  vsStdn1, vsStdn2
           FROM  SGBSTDN
          WHERE SGBSTDN_PIDM          = global_pidm
            AND SGBSTDN_PROGRAM_1     = vsprog;
    EXCEPTION
        WHEN OTHERS THEN  NULL;
    END;

    -- Verifica que NO tenga HOLD
    vsHoldPdim:= f_TieneHolds(vsPeriodo);

     -- Obtiene los valores de la PAgina, CABECERO, BODY, FOOTER y No de PAginas
     p_detPAgina(vsBecadef);
     ---  Java Script Code requerido
     p_HTM;
     ---  Inicia Tabla de Dspliegue
     p_nuevaPAGINA;

    ----- Verifica si el Documento ya esta disponible para su Impresin
    IF (f_ImprimeReporte(vnCert) = csY ) THEN
       IF ( vsHoldPdim IS NULL) THEN
         -- Verifica si Tiene Materias
         IF ( f_TieneMaterias IS NULL) THEN
          -- Verifica el Estado del Estudiante
           IF (f_checaStudent(global_pidm,vsProg ) IS NULL) THEN
             --- Agrega a Bitacora Impresion y Obtiene Informacin del Detalle de las Leyendas
             p_RegistraCertificado;
             ---  Verifica Validaciones Principales de Impresion y Visualizacin
             IF ( vsBanExito = 'N' ) THEN
                 htp.p('<TR/><TD CLASS="tdER"><b>*** ERROR *** AL OBTENER EL FOLIO DEL CERTIFICADO.</b>... '||vsError||'</TD></TR>');
             ELSE
                  --__________ Inicia Impresin de la Pgina ___________
                  --______________________________________________________________

                 --- **  Imprime el Encabezado del Documento
                 p_headerDocto;
                 vnCuantosBD  := vnRegistros;

                --- **  Imprime el Body del Documento, Tablas, Leyendas, Tetos, etc.
                 FOR reg_Texto IN cu_Texto(vnCert,'BD')   LOOP
                    -- Contador de Registros del Reporte
                    vnRegistros := vnRegistros +1;
                    ---  Obtiene la Linea a Imprimir
                    vsPasoTexto  :=  reg_Texto.rDesc;

                    ---  Si es la Tabla de CALIFICACIONES Y MATERIAS
                    IF ( (vsPasoTexto = '||TABLACALIF')) THEN
                        htp.p(csLBlanco);
                        p_encCALIF;
                        vnCreditos := 0;

                        FOR regCAL IN cuTABLACALIF(global_pidm,vnValCert,vsBecadef) LOOP
                            --  Contabiliza los Registros del Formato
                            vnRegistros := vnRegistros +1;

                            IF (vnRegistros > (vnTotBDY + vnTotRegHD))  THEN
                                htp.p('</TABLE></TD></TR>');
                                 --- **  Imprime el Footer del Documento
                                 p_footerDocto;
                                 htp.p('<br class="brNuevaPag"/>');
                                 ---  Inicia Tabla de Dspliegue
                                 p_nuevaPAGINA;
                                 --- **  Imprime el Encabezado del Documento
                                 p_headerDocto;
                                 htp.p(csLBlanco);
                                 p_encCALIF;
                                 vnRegistros := vnCuantosBD;
                            END IF;
                                ---  Contadores para Tabla de Crditos
                                if ( regCAL.RESULTADO = 'APROBADO'    )  THEN vnAprobNota   := vnAprobNota    +1; END IF;
                                if ( regCAL.RESULTADO = 'APROBADO S/N')  THEN vnAprobSNota  := vnAprobSNota   +1; END IF;
                                if ( regCAL.RESULTADO = 'REPROBADO'   )  THEN vnReprobado   := vnReprobado    +1; END IF;
                                if ( regCAL.RESULTADO = 'REPROBADO S/N') THEN vnReprobadoSN := vnReprobadoSN  +1; END IF;
                                --aigui 31/05/2012: se cambia PENDIENTES por PENDIENTE
                                if ( regCAL.RESULTADO = 'PENDIENTE'  )  THEN vnPendientes  := vnPendientes   +1; END IF;

                                htp.p('<TR><TD align="center" style="border-left:none;border-top:none;border-right:none;border-bottom:none">'||regCAL.CODIGO||'</TD>');
                                htp.p('<TD align="left" style="border-left:none;border-top:none;border-right:none;border-bottom:none">'||regCAL.ASIGNATURA||'</TD>');
                                htp.p('<TD align="center" style="border-left:none;border-top:none;border-right:none;border-bottom:none">'||regCAL.NOTA||'</TD>');
                                htp.p('<TD align="center" style="border-left:none;border-top:none;border-right:none;border-bottom:none">['||LPAD(regCAL.CREDITO,2,' ')||']</TD>');
                                htp.p('<TD align="left" style="border-left:none;border-top:none;border-right:none;border-bottom:none">'||regCAL.RESULTADO||'</TD>');
                                htp.p('<TD align="left" style="border-left:none;border-top:none;border-right:none;border-bottom:none">'||regCAL.SEMANO||'</TD></TR>');

                                vnCreditos := vnCreditos + regCAL.CREDITO;
                        END LOOP;
                        htp.p('</TABLE></TD></TR>');

                    ---  SI ES LA TABLA DE CREDITOS
                    ELSIF  ( (vsPasoTexto = '||TABLACREDNOTA') )  THEN
                        IF (  (cnCredit + vnRegistros) >=  (cnLinPag - vnTotRegFT) ) THEN
                             p_llenaEspacios ((cnLinPag - vnTotRegFT) - vnRegistros);
                             --- **  Imprime el Footer del Documento
                             p_footerDocto;
                             htp.p('<br class="brNuevaPag"/>');
                             ---  Inicia Tabla de Dspliegue
                             p_nuevaPAGINA;
                             --- **  Imprime el Encabezado del Documento
                             p_headerDocto;
                             htp.p(csLBlanco);
                             vnRegistros := vnCuantosBD;
                             p_encCREDNOTA;
                        ELSE
                            p_encCREDNOTA;
                        END IF;
                    ---  SI HAY QUE SALTAR ESPACIOS ADICIONALES
                    ELSIF  ( INSTR(vsPasoTexto,'||SPACE(') > 0  )  THEN
                        vnLocSpac  := INSTR(vsPasoTexto,'||SPACE(');
                        vsPasoTexto:= SUBSTR(vsPasoTexto,(vnLocSpac+8));
                        vnLocSpac1 := INSTR(vsPasoTexto,')') -1;
                        vnLocSpac2 := SUBSTR(vsPasoTexto,0,vnLocSpac1 );

                        IF ( (vnRegistros + vnLocSpac2) > (cnLinPag - vnTotRegFT) ) THEN
                             p_llenaEspacios ((cnLinPag - vnTotRegFT) - (vnRegistros) );
                             --- **  Imprime el Footer del Documento
                             p_footerDocto;
                             htp.p('<br class="brNuevaPag"/>');
                             ---  Inicia Tabla de Dspliegue
                             p_nuevaPAGINA;
                             --- **  Imprime el Encabezado del Documento
                             p_headerDocto;
                             htp.p(csLBlanco);
                             vnRegistros := vnCuantosBD;
                             p_llenaEspacios(vnLocSpac2);
                         ELSE
                             p_llenaEspacios(vnLocSpac2);
                         END IF;
                    ELSE    ---  SI ES UNA LINEA NORMAL
                        IF ( vnRegistros >= (cnLinPag - vnTotRegFT) ) THEN
                             p_llenaEspacios ((cnLinPag - vnTotRegFT) - (vnRegistros ) );
                             --- **  Imprime el Footer del Documento
                             p_footerDocto;
                             htp.p('<br class="brNuevaPag"/>');
                             ---  Inicia Tabla de Dspliegue
                             p_nuevaPAGINA;
                             --- **  Imprime el Encabezado del Documento
                             p_headerDocto;
                             htp.p(csLBlanco);
                             vnRegistros := vnCuantosBD;
                        END IF;

                        ---  Arma el Detalle de la Linea a Imprimir
                        vsPasoTexto  :=  p_ArmaLinea(vsPasoTexto);
                        vsImprime    := case
                                        when reg_Texto.rJustif = 'JUSTIFY' THEN  '<TD class="fontT10">'
                                                                           ELSE  '<TD class="fontT10" align="'||reg_Texto.rJustif||'" >'
                                      end;
                        --- Arma CAdena a Imprimir en el Formato
                        vsImprime    := vsImprime||case
                                                   when reg_Texto.rFont = 'HH1'  THEN csH1||vsPasoTexto||csFF||'</TD>'
                                                   when reg_Texto.rFont = 'HH2'  THEN csH2||vsPasoTexto||csFF||'</TD>'
                                                   when reg_Texto.rFont = 'HH2A' THEN csTX||vsPasoTexto||csFF||'</TD>'
                                                   when reg_Texto.rFont = 'FM1'  THEN csTX||vsPasoTexto||csFF||'</TD>'
                                                   when reg_Texto.rFont = 'FT1'  THEN csTX||vsPasoTexto||csFF||'</TD>'
                                                   when reg_Texto.rFont = 'TX1'  THEN '<P align="'||reg_Texto.rJustif||'">'||csTX||vsPasoTexto||csFF||'</P></TD>'
                                                   else '</TD>'
                                                 end;

                        vnRegistros  := vnRegistros + 1;
                        htp.p(csLBlanco);
                        htp.p(csTRAbre);
                        htp.p(vsImprime);
                        htp.p(csTRCierra);
                    END IF;  ----  IF ( (vsPasoTexto

                    vsCodHtp    := reg_Texto.rFont;
                    vnLinHtp    := vnLinHtp + 1;
                 END LOOP;
                 --- **  Imprime el Footer del Documento
                 p_footerDocto;
             END IF;  ---  IF ( vsBanExito = 'N' )
           ELSE
              htp.p('<TR/><TD class="tdER">STATUS ... <B>'||f_checaStudent(global_pidm,vsProg )||'.</B></TD></TR>');
           END IF;  --- IF (f_checaStudent(global_pidm,vsProg )
         ELSE
             htp.p('<TR/><TD class="tdER">STATUS ... <B>'||f_TieneMaterias||'.</B></TD></TR>');
         END IF;   ---  IF ( f_TieneMaterias
       ELSE
          htp.p('<TR/><TD class="tdER"> <b>'||vsHoldPdim||' </b> .</TD></TR>');
       END IF;  ---   IF ( vsHoldPdim IS NULL)
    ELSE
         htp.p('<TR/><TD class="tdER">El certificado <b>'||vsDesDocto||' </b> NO ESTA DISPONIBLE para su impresion.</TD></TR>');
    END IF;   ---  IF (f_ImprimeReporte(vnCert)

    htp.p('<br/></body></html>');
  EXCEPTION
      WHEN OTHERS THEN
            vsError := SUBSTR(SQLERRM,1,500);
           htp.p('<P class="pER">GENERACION DE CERTIFICADOS ESCOLARES --> '||vsError||' </P>');
  END PWRCNOT;
/


DROP PUBLIC SYNONYM PWRCNOT;

CREATE PUBLIC SYNONYM PWRCNOT FOR BANINST1.PWRCNOT;


GRANT EXECUTE ON BANINST1.PWRCNOT TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCNOT TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCOLP;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCOLP (psReclDesc   VARCHAR2)  IS

/**************************************************************
           tarea:  procedimiento que genera el reporte
                   de colegios de procedencia
          mdulo:  admisiones
           autor:  horacio martnez ramrez - hmr
           fecha:  02/mar/2011
**************************************************************/

  vnExists       INTEGER := 0;
  vnColumnas     INTEGER := 28;
  vgsInicioPag   VARCHAR2(30) := NULL;           -- bandera que al tener el valor "imprime", no colocar el salto de pgina para impresin
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vnIdRenglon    INTEGER := 1;
  vsTerm         SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsProgr        SARADAP.SARADAP_PROGRAM_1%TYPE DEFAULT NULL;
  vsTipoA        VARCHAR2(5);

  CURSOR cuReporte ( psTerm    VARCHAR2  DEFAULT NULL,
                     psTipoA   VARCHAR2  DEFAULT NULL )  IS

     SELECT COLEGIO,
            NOMBRE,
            DEP_EDUC,
            REGION,
            COMUNA,
            IND_LEGION,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'AC')         ESC_ACTUAC,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'AR')         ESC_ARQUI,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'AV')         ESC_ART_VIS,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'CF')         ESC_CIEN_FAM,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'CS')         ESC_PER_HIST,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'DE')         ESC_DERECHO,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'DI')         ESC_DISEO,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'EB')         ESC_EDU_BAS,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'EM')         ESC_EDU_MED,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'EN')         ESC_ENFERM,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'EP')         ESC_EDU_PARV,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'HI')         ESC_HISTORIA,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'IC')         ESC_ING_COMER,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'KI')         ESC_KINES,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'LI')         ESC_LITER,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'MD')         ESC_MEDICINA,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'NU')         ESC_NUT_DIET,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'OD')         ESC_ODONTO,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'PE')         ESC_PERIOD,
            BANINST1.F_ING_COLEGIOS (psTerm, COLEGIO, 'PR')         ESC_PED_REL,
            BANINST1.F_ING_COLEGIOS_TOT (psTerm, COLEGIO)           TOT_COL_NUM,
            NVL(BANINST1.F_ING_COLEGIOS_PROM (PSTERM, COLEGIO),'0') TOT_COL_PRO_PSU
       FROM ( SELECT CH.SORHSCH_SBGI_CODE                                 COLEGIO,
                     UPPER(GI.STVSBGI_DESC)                               NOMBRE,
                     UPPER(HR.STVBCHR_DESC)                               DEP_EDUC,
                     BS.SOBSBGI_STAT_CODE                                 REGION,
                     BS.SOBSBGI_CNTY_CODE                                 COMUNA,
                     ( SELECT DISTINCT(UPPER(B.STVBCHR_DESC))
                         FROM SORBCHR A, STVBCHR B
                        WHERE A.SORBCHR_BCHR_CODE = B.STVBCHR_CODE
                          AND A.SORBCHR_SBGI_CODE = CH.SORHSCH_SBGI_CODE
                          AND B.STVBCHR_CODE = 'L' )                      IND_LEGION
                FROM SORLCUR  SR,
                     SORHSCH  CH,
                     STVSBGI  GI,
                     SORBCHR  RB,
                     STVBCHR  HR,
                     SOBSBGI  BS
               WHERE SR.SORLCUR_TERM_CODE = psTerm
                 AND SR.SORLCUR_TERM_CODE = SR.SORLCUR_TERM_CODE_ADMIT
--                 and sr.sorlcur_admt_code = 'ad'
                 AND (SR.SORLCUR_ADMT_CODE = psTipoA OR psTipoA IS NULL)
                 AND SR.SORLCUR_CACT_CODE = 'ACTIVE'
                 AND SR.SORLCUR_PIDM = CH.SORHSCH_PIDM
                 AND CH.SORHSCH_SBGI_CODE = GI.STVSBGI_CODE
                 AND CH.SORHSCH_SBGI_CODE = RB.SORBCHR_SBGI_CODE
                 AND RB.SORBCHR_BCHR_CODE = HR.STVBCHR_CODE
                 AND HR.STVBCHR_CODE <> 'L'
                 AND CH.SORHSCH_SBGI_CODE = BS.SOBSBGI_SBGI_CODE
               GROUP BY CH.SORHSCH_SBGI_CODE, GI.STVSBGI_DESC, HR.STVBCHR_DESC, BS.SOBSBGI_STAT_CODE, BS.SOBSBGI_CNTY_CODE
               ORDER BY GI.STVSBGI_DESC );

  BEGIN

     -- valida que el usuario pertenezca a la base de datos:
     IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

     -- son buscados los valores de las cookies para asignar los valores del filtro del query:
     vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
     vsTipoA := pk_ObjHtml.getValueCookie('psTipoA');

     -- se determina el largo de la tabla:
     FOR vnI IN 1..vnColumnas LOOP
         tabColumna.EXTEND(vnI);
         tabColumna(vnI) := NULL;
     END LOOP;

     tabColumna(1)  := '<center> Colegio de <br> procedencia <br> <br>Cdigo';
     tabColumna(2)  := '<center> Colegio de <br> procedencia <br> <br>Nombre';
     tabColumna(3)  := '<center> Colegio de <br> procedencia <br> <br>Depend. educacional';
     tabColumna(4)  := '<center> Colegio de <br> procedencia <br> <br>Regin';
     tabColumna(5)  := '<center> Colegio de <br> procedencia <br> <br>Comuna';
     tabColumna(6)  := '<center> Indicador <br> de la <br> legin';
     tabColumna(7)  := '<center> Escuela <br> de <br> Actuacin';
     tabColumna(8)  := '<center> Escuela <br> de <br> Arquitectura';
     tabColumna(9)  := '<center> Escuela <br> de <br> Artes <br> Visuales';
     tabColumna(10) := '<center> Escuela de<br> Ciencias<br>de la Familia';
     tabColumna(11) := '<center> Escuela <br> de <br> Periodismo <br> e Historia';
     tabColumna(12) := '<center> Escuela <br> de <br> Derecho';
     tabColumna(13) := '<center> Escuela <br> de <br> Diseo';
     tabColumna(14) := '<center> Escuela <br> de <br> Educacin <br> Bsica';
     tabColumna(15) := '<center> Escuela <br> de <br> Educacin <br> Media';
     tabColumna(16) := '<center> Escuela <br> de <br> Enfermera';
     tabColumna(17) := '<center> Escuela <br> de <br> Educacin <br> Parvularia';
     tabColumna(18) := '<center> Escuela <br> de <br> Historia';
     tabColumna(19) := '<center> Escuela <br> de <br> Ingeniera <br> Comercial';
     tabColumna(20) := '<center> Escuela <br> de <br> Kinesiologa';
     tabColumna(21) := '<center> Escuela <br> de <br> Literatura';
     tabColumna(22) := '<center> Escuela <br> de <br> Medicina';
     tabColumna(23) := '<center> Escuela <br> de <br> Nutricin<br>y Diett.';
     tabColumna(24) := '<center> Escuela <br> de <br> Odotologa';
     tabColumna(25) := '<center> Escuela <br> de <br> Periodismo';
     tabColumna(26) := '<center> Escuela de <br> Pedagoga, <br> Religin <br> y MC';
     tabColumna(27) := '<center> Total <br> colegio <br> <br> No.';
     tabColumna(28) := '<center> Total <br> colegio <br> Promedio <br> PSU';

     FOR regRep IN cuReporte (vsTerm, vsTipoA) LOOP

         IF vnExists = 0 THEN
--            pk_sisrepimp.p_encabezadodereporte(psrecldesc, vncolumnas, tabcolumna, vgsiniciopag, '1', pssubtitulo=>'periodo: '||vsterm||'  '||pk_catalogo.periodo(vsterm), psuniversidad=>'uft');

            -- selecciona encabezado segn tipo de admisin:
            IF vsTipoA IS NOT NULL THEN
               Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||', &nbsp&nbsp&nbsp'||'Tipo de admisin: '||vsTipoA||' - '||Pk_Catalogo.Admision(vsTipoA), psUniversidad=>'UFT');
            ELSE
               Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||', &nbsp&nbsp&nbsp'||'Tipo de admisin: '||'Todos', psUniversidad=>'UFT');
            END IF;

            vgsInicioPag := 'SALTO';
         END IF;


         HTP.P('<tr> <td valign="top" align="center">' ||regRep.COLEGIO          ||'</td>
                     <td valign="top" align="left">'   ||regRep.NOMBRE           ||'</td>
                     <td valign="top" align="left">'   ||regRep.DEP_EDUC         ||'</td>
                     <td valign="top" align="center">' ||regRep.REGION           ||'</td>
                     <td valign="top" align="center">' ||regRep.COMUNA           ||'</td>
                     <td valign="top" align="left">'   ||regRep.IND_LEGION       ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_ACTUAC       ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_ARQUI        ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_ART_VIS      ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_CIEN_FAM     ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_PER_HIST     ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_DERECHO      ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_DISEO       ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_EDU_BAS      ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_EDU_MED      ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_ENFERM       ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_EDU_PARV     ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_HISTORIA     ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_ING_COMER    ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_KINES        ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_LITER        ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_MEDICINA     ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_NUT_DIET     ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_ODONTO       ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_PERIOD       ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_PED_REL      ||'</td>
                     <td valign="top" align="center">' ||regRep.TOT_COL_NUM      ||'</td>
                     <td valign="top" align="center">' ||regRep.TOT_COL_PRO_PSU  ||'</td>
               </tr>');

         vnExists    := 1;
         vnIdRenglon := vnIdRenglon + 1;

     END LOOP;

     IF vnExists = 0 THEN
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
     ELSE
        -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pgina:
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR);
     END IF;

     htp.p('</table><br/></body></html>');

  EXCEPTION
     WHEN OTHERS THEN
          htp.p(SQLERRM);

  END PWRCOLP;
/


DROP PUBLIC SYNONYM PWRCOLP;

CREATE PUBLIC SYNONYM PWRCOLP FOR BANINST1.PWRCOLP;


GRANT EXECUTE ON BANINST1.PWRCOLP TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCOLP TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCOMD;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCOMD(psReclDesc VARCHAR2,
                                  psSiu      VARCHAR2 DEFAULT NULL) IS

/**************************************************************
           tarea:  obtiene los comentarios hacia el profesor por parte de alumnos
          mdulo:  resultados del sistema de evaluacin de la prctica docente (seprad)
           autor:  horacio martnez ramrez - hmr
           fecha:  04/nov/2010
**************************************************************/

  global_pidm SPRIDEN.SPRIDEN_PIDM%TYPE;

  vsTerm      VARCHAR2(6)  := NULL;
  vsEncu      VARCHAR2(30) := NULL;
  vsUniv      VARCHAR2(5)  := NULL;
  vnPidm      NUMBER       := NULL;
  vsColl      VARCHAR2(3)  := NULL;

  vnRow      INTEGER                           := 0;
  vsNCom     INTEGER                           := 0;
  vsPidmP    SVBTESD.SVBTESD_FACULTY_PIDM%TYPE := NULL;
  vsPidmPAnt SVBTESD.SVBTESD_FACULTY_PIDM%TYPE := '000';
  vsCrn      SVBTESD.svbtesd_crn%TYPE          := NULL;
  vsCrnAnt   SVBTESD.svbtesd_crn%TYPE          := '000';
  vsComm     SVBTESD.svbtesd_open_answer%TYPE  := NULL;
  vsTCom     SVBTESD.svbtesd_qcod_code%TYPE    := NULL;
  vsTComAnt  SVBTESD.svbtesd_qcod_code%TYPE    := 'NUEVO';
  vsTitulo   SCBCRSE.SCBCRSE_TITLE%TYPE        := null;
  vsNombre   VARCHAR(80)                       := NULL;
  vsSubjc    VARCHAR2(5)                       := NULL;
  vsCrse     VARCHAR2(5)                       := NULL;
  vsPtrm     VARCHAR2(1000)                    := NULL;
  vsCommPos  VARCHAR2(9)                       := NULL;
  vsCommNeg  VARCHAR2(9)                       := NULL;

  cn0          CONSTANT NUMBER(1)    := 0;
  csI          CONSTANT VARCHAR2(1)  := 'I';
  csL          CONSTANT VARCHAR2(1)  := 'L';
  csF          CONSTANT VARCHAR2(1)  := 'F';
  csShl        CONSTANT VARCHAR2(1)  := '/';
  csCOMENT     CONSTANT VARCHAR2(6)  := 'COMENT';
  csPLANEACION CONSTANT VARCHAR2(10) := 'PLANEACIN';


  CURSOR cuComentarios(psTerm VARCHAR2,
                       pnPidm NUMBER DEFAULT NULL,
                       psCamp VARCHAR2,
                       psColl VARCHAR2,
                       psEncu VARCHAR2,
                       psPtrm VARCHAR2 DEFAULT NULL) IS
         SELECT SWBSEPR_TERM_CODE                         Term,
                SWBSEPR_CRN                               Crn,
                SWBSEPR_CAMP_CODE                         Camp,
                SWBSEPR_COLL_CODE                         Coll,
                pk_Seprad1.F_NameProfesor(Resultado.PIDM) NOMBRE,
                (SELECT DISTINCT SWRSEPR_TITLE
                   FROM SWRSEPR
                  WHERE SWRSEPR_QCOD_CODE IN (SELECT SWROENC_QCOD_CODE
                                                FROM SWROENC
                                               WHERE SWROENC_TEQA_CODE = csPLANEACION
                                                 AND SWROENC_TSSC_CODE = psEncu
                                              )
                    AND SWRSEPR_CRN        = SWBSEPR_CRN
                    AND SWRSEPR_PIDM       = SWBSEPR_PIDM
                    AND SWRSEPR_TEQA_CODE  = csPLANEACION
                    AND SWRSEPR_TIPO_CRN  IN (csL,csI)
                    AND SWRSEPR_TSSC_CODE  = psEncu
                    AND SWRSEPR_TERM_CODE  = psTerm
                )                                         Titulo,
                Resultado.PIDM                            PIDM,
                Resultado.TSSC                            TSSC,
                Resultado.QCOD                            QCOD,
                Resultado.ANS                             ANS
           FROM SWBSEPR,
                (SELECT SV.SVBTESD_TERM_CODE    Term,
                        SV.SVBTESD_CRN          CRN,
                        SV.SVBTESD_FACULTY_PIDM Pidm,
                        SV.SVBTESD_TSSC_CODE    TSSC,
                        SV.SVBTESD_QCOD_CODE    QCOD,
                        SV.SVBTESD_OPEN_ANSWER  ANS
                   FROM SVBTESD SV
                  WHERE SVBTESD_TERM_CODE      = psTerm
                    AND (SVBTESD_FACULTY_PIDM  = pnPidm OR pnPidm IS NULL)
                    AND SVBTESD_QCOD_CODE     IN (SELECT SWROENC_QCOD_CODE
                                                    FROM SWROENC
                                                   WHERE SWROENC_TIPO_2    = csF
                                                     AND SWROENC_TEQA_CODE = csCOMENT
                                                     AND SWROENC_TSSC_CODE = psEncu
                                                 )
                    AND SVBTESD_TEQA_CODE      = csCOMENT
                    AND SVBTESD_TSSC_CODE      = psEncu
                    AND SVBTESD_TERM_CODE      = psTerm
                ) Resultado
          WHERE SWBSEPR_PIDM      = Resultado.Pidm
            AND SWBSEPR_CRN       = Resultado.Crn
            AND SWBSEPR_TERM_CODE = Resultado.Term
            AND (INSTR(csShl||psPtrm,csShl||SWBSEPR_PTRM_CODE||csShl) > cn0 OR psPtrm = csShl OR psPtrm IS NULL)
            AND (SWBSEPR_PIDM = pnPidm OR pnPidm IS NULL)
            AND SWBSEPR_COLL_CODE = psColl
            AND SWBSEPR_CAMP_CODE = psCamp
            AND SWBSEPR_TERM_CODE = psTerm
            AND SWBSEPR_TSSC_CODE = psEncu
          ORDER BY NOMBRE, Resultado.Crn,  Resultado.QCOD;

  BEGIN
      -- valida que el usuario pertenezca a la base de datos
      IF psSiu IS NULL THEN
          IF pk_login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;
      ELSE
          IF NOT twbkwbis.F_ValidUser(global_pidm) THEN
              RETURN;
          END IF;
      END IF;

      vsUniv := pk_objHtml.getValueCookie('psSprUn');
      vsEncu := pk_objHtml.getValueCookie('psSeprd');
      vsTerm := pk_objHtml.getValueCookie('psSprTP');
      vsColl := pk_objHtml.getValueCookie('psSColP');
      vnPidm := pk_objHtml.getValueCookie('psSprPd');
      vsPtrm := pk_objHtml.getValueCookie('psPtrmP');

      vsCommPos := FWRTCMM(vsEncu, csCOMENT, 'P', 'F');
      vsCommNeg := FWRTCMM(vsEncu, csCOMENT, 'N', 'F');

      -- el uso de la variable es por el uso de la seleccin mltiple de la parte de periodo
      vsPtrm := NVL(vsPtrm,csShl);

      htp.p('<html><head><title>Comentarios positivos y negativos hacia el profesor</title>');

      -- la aplicacin no se guarda en el cache de la mquina
      PK_ObjHTML.P_NoCache;

      -- cdigo css
      PK_ObjHTML.P_CssTabs;

      htp.p('<script language="JavaScript"><!--');
      htp.p('function fImprimeReporte() {
      window.focus()
      print();
      }');

      htp.p('//--></script>');

      htp.p('<script language="javascript" src="kwacnls.js"></script>');

      htp.p('</head><body bgcolor="#ffffff" class="bodyCeroR"><br/>');

      htp.p('<table border="0" cellpadding="2" cellspacing="1" bordercolor="#ffffff" bgcolor="#ffffff" width="100%">
      <tr class="trTabSepara">
          <td width="10%" rowspan="7" valign="top"><img src="/imagenes/logo_uft.jpg'||'" width="80" border="0"></td>
          <td width="70%" class="tdTitulo" align="left"><b>'||REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(psReclDesc,'~aacute','&aacute'),'~eacute','&eacute'),'~iacute','&iacute'),'~oacute','&oacute'),'~uacute','&uacute')||':</b>&nbsp;'||pk_Seprad1.F_CollDesc(vsColl)||'</b></td>
          <td width="20%" class="tdFont8">'||TO_CHAR(SYSDATE,'DD/MM/YYYY HH24:MI:SS')||'</td></tr>
      <tr class="trTabSepara">
          <th align="left">'||pk_Seprad1.F_CollDesc(vsColl)||'</th>
          <td></td></tr>
      <tr class="trTabSepara">
          <td align="left" class="tdFont8">'||vsTerm||'&nbsp;'||pk_Seprad1.F_TermDesc(vsTerm)||'</td>
          <td></td></tr>
      <tr class="trTabSepara">
          <td align="left" class="tdFont8" colspan="2">'||pK_Seprad1.F_PtrmCodeDesc(vsTerm,
                                                                                                                 psColl=>vsColl,
                                                                                                                 psCamp=>vsUniv,
                                                                                                                 pnPidm=>vnPidm,
                                                                                                                 psPtrm=>vsPtrm,
                                                                                                                 psEncs=>vsEncu )
                                                                       ||'</td>
          </tr>
      </table><br/>');

      FOR regCom IN cuComentarios(vsTerm, vnPidm, vsUniv, vsColl, vsEncu, vsPtrm) LOOP
          vnRow    := vnRow  + 1;
          vsNCom   := vsNCom + 1;
          vsPidmP  := regCom.PIDM;
          vsNombre := regCom.Nombre;
          vsCrn    := regCom.CRN;
          vsComm   := regCom.ANS;
          vsTCom   := regCom.QCOD;
          vsTitulo := regCom.Titulo;

          IF vsPidmP <> vsPidmPAnt OR  vsPidmPAnt = '000' THEN
             htp.p('</table><br/>');
             htp.p('<table border="1" cellpadding="0" cellspacing="0" width="100%" bordercolor="#efefef" bgcolor="#ffffff">');
             htp.p(
             '<tr class="trTabSepara" bgcolor="#dddddd">
                        <td class="tdFont8" width="08%" align="right" style="border-bottom:none;border-right:none;" colspan="2"><b>'||'Profesor'||':&nbsp;</b></td>
                        <td class="tdFont8" width="92%" align="left"  style="border-left:none;border-bottom:none;">&nbsp;'||pk_seprad1.F_IdProfesor(vsPidmP)||'&nbsp;&nbsp;'||vsNombre||'</td></tr>
              <tr class="trTabSepara" bgcolor="#dddddd">
                        <td class="tdFont8" width="08%" align="right" style="border-bottom:none;border-right:none;" colspan="2"><b>'||'RUT'||':&nbsp;</b></td>
                        <td class="tdFont8" width="92%" align="left"  style="border-left:none;border-bottom:none;">&nbsp;'||F_get_rut(vsPidmP)||'</td></tr>
             ');

             vsTComAnt := 'NUEVO';
          END IF;

          IF vsCrn <> vsCrnAnt  OR vsCrnAnt = '000' THEN
             htp.p('
             <tr class="trTabSepara" bgcolor="#efefef">
                 <td class="tdFont8" width="08%" align="right" style="border-top:none;border-right:none;" colspan="2"><b>'||'Materia'||':&nbsp;</b></td>
                 <td class="tdFont8" width="92%" align="left"  style="border-top:none;border-left:none;" >&nbsp;'||vsCrn||'&nbsp;&nbsp;'||vsTitulo||'</td>
             </tr>
             ');

             vsTComAnt := 'NUEVO';
          END IF;

          IF vsTCom <> vsTComAnt OR vsTComAnt = 'NUEVO' THEN
             htp.p('<tr class="trTabSepara">');
             htp.p(' <td class="tdFont8" width="02%" style="border-right:none;"></td>');

             IF    vsTCom = vsCommPos THEN
                   htp.p(' <td class="tdFont8" width="98%" style="border-left:none;color:#0000CC" align="left" colspan="2">'||'Comentarios Positivos'||'</td></tr>');
             ELSIF vsTCom = vsCommNeg THEN
                   htp.p(' <td class="tdFont8" width="98%" style="border-left:none;color:#990000" align="left" colspan="2">'||'Comentarios Negativos'||'</td></tr>');
             END IF;

             vsNCom := 1;
          END IF;

          htp.p('
          <tr class="trTabSepara">
              <td class="tdFont8" width="02%" align="right" valign="top" style="border-right:none;">'||vsNCom||')</td>
              <td class="tdFont8" width="98%" align="left"  valign="top" style="border-left:none;" colspan="2">&nbsp;'||vsComm||'</td>
          </tr>
          ');

          vsPidmPAnt := vsPidmP;
          vsCrnAnt   := vsCrn;
          vsTComAnt  := vsTCom;
      END LOOP;

      IF vnRow = 0 THEN
         htp.p('<tr><th><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      END IF;

      htp.p('</table><br/></body></html>');

  END PWRCOMD;
/


DROP PUBLIC SYNONYM PWRCOMD;

CREATE PUBLIC SYNONYM PWRCOMD FOR BANINST1.PWRCOMD;


GRANT EXECUTE ON BANINST1.PWRCOMD TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCOMD TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCORR;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCORR IS
/*******************************************************************************
Nombre            PK_ADMEMAIL2
Autor            Socorro Cardenas
Fecha            16 de Agosto de 2012
*********************************************************************************/
-- DECLARACION DE CONSTANTES
gv_CodeMail        CONSTANT    GOREMAL.GOREMAL_EMAL_CODE%TYPE := PK_UTIL.f_ObtieneParam('MAIL', 'code');
gv_Codeserv        CONSTANT    GOREMAL.GOREMAL_EMAIL_ADDRESS%TYPE := PK_UTIL.f_ObtieneParam('MAIL', 'serv');
PRAGMA AUTONOMOUS_TRANSACTION;
-- DECLARACION DE VARIABLE LOCALES
vvNuevoEmail    GOREMAL.GOREMAL_EMAIL_ADDRESS%TYPE:=NULL;
psPidm             NUMBER;

cursor correos is
SELECT SIBINST_PIDM  pidm FROM SIBINST
WHERE SIBINST_TERM_CODE_EFF IN ('201210','201225','201275')
AND NOT EXISTS (SELECT * FROM GOREMAL
                                WHERE GOREMAL_PIDM = SIBINST_PIDM
                                AND GOREMAL_EMAL_CODE = 'UFT')
union all
SELECT SGBSTDN_PIDM pidm FROM SGBSTDN
WHERE SGBSTDN_TERM_CODE_ADMIT IN ('201210')
AND NOT EXISTS  (SELECT * FROM GOREMAL
                                WHERE GOREMAL_PIDM = SGBSTDN_PIDM
                                AND GOREMAL_EMAL_CODE = 'UFT');

-- FUNCION QUE BUSQUEDA DEL PIDM SI EXISTE
FUNCTION f_ExistePidm (
    psPidm        IN        NUMBER)
    RETURN NUMBER IS
--- DECLARACION DE VARIABLES LOCALES
vnExiste        NUMBER(2):=0;
BEGIN
    -- query qie valida que el PIdm enviando existe
    SELECT COUNT(*)
      INTO vnExiste
      FROM GWBMAIL
     WHERE GWBMAIL_PIDM = psPidm;
    -- REGRESA EL VALOR OBTENIDO
    RETURN vnExiste;
EXCEPTION
    WHEN OTHERS THEN
        RETURN 0;
END f_ExistePidm;

-- GENERA Y VALIDA EL EMAIL
PROCEDURE p_genmail(
    psPidm        IN        NUMBER,
    psEmail        IN OUT    GOREMAL.GOREMAL_EMAIL_ADDRESS%TYPE) IS
-- DECLARACION DE VARIABLES LOCALES
vvEmail        GOREMAL.GOREMAL_EMAIL_ADDRESS%TYPE;
vnExiste    NUMBER(3):=0;
BEGIN
    -- GENERA EL FORMATO DE LA CUENTA DE EMAIL
    SELECT
        REPLACE(
        TRANSLATE(
        LOWER(
        SUBSTR(SPRIDEN_FIRST_NAME, 1, 1) ||
        SUBSTR(SPRIDEN_LAST_NAME, 1, (INSTR(SPRIDEN_LAST_NAME, '*') -1) ) ||
        SUBSTR(SPRIDEN_LAST_NAME, (INSTR(SPRIDEN_LAST_NAME, '*') + 1 ), 1 )
        ),
        '', 'aeiouaeiouaoaeiooaeioun')
        , ' ', NULL) AS EMAIL
     INTO vvEmail
     FROM SPRIDEN
    WHERE SPRIDEN_PIDM = psPidm
      AND SPRIDEN_CHANGE_IND IS NULL;
    -- VALIDA SI EL MAIL EXISTE REPETIDO PARA GENERAR UN CONSECUTIVO
    SELECT COUNT(*)
      INTO vnExiste
      FROM GWBMAIL
     WHERE INSTR(LOWER(GWBMAIL_EMAIL), vvEmail) > 0;
    -- VALIDACION SE ENCONTRO INFORMACION O GENERA SECUENCIA
    IF (vnExiste > 0) THEN
        psEmail := vvEmail || vnExiste;
    ELSE
        psEmail := vvEmail;
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        psEmail := 'NO HAY';
END p_genmail;

-- FUNCION DE VALIDACION DE EXISTENCIA DE MAIL EN GOREMAL GENERAL
FUNCTION f_ExisteMail(
    psPidm        IN        NUMBER)
    RETURN NUMBER IS
--- DECLARACION DE VARIABLES LOCALES
vnExiste        NUMBER(2):=0;
BEGIN
    -- query qie valida que el PIdm enviando existe
    SELECT COUNT(*)
      INTO vnExiste
      FROM GOREMAL
     WHERE GOREMAL_PIDM = psPidm
       AND GOREMAL_EMAL_CODE = gv_CodeMail;
    -- REGRESA EL VALOR OBTENIDO
    RETURN vnExiste;
EXCEPTION
    WHEN OTHERS THEN
        RETURN 0;
END f_ExisteMail;

-- PROCESO DE VALIDACION EL EMAIL
PROCEDURE p_valmail(
    psPidm        IN        NUMBER,
    psEmail        IN        GOREMAL.GOREMAL_EMAIL_ADDRESS%TYPE) IS
-- DECLARACION DE VARIABLES LOCALES
vvEmail        GOREMAL.GOREMAL_EMAIL_ADDRESS%TYPE;
vnExiste    NUMBER(3):=0;
BEGIN
    -- VALIDA SI EL MAIL EXISTE REPETIDO PARA GENERAR UN CONSECUTIVO
    SELECT COUNT(*)
      INTO vnExiste
      FROM GOREMAL
     WHERE GOREMAL_PIDM = psPidm
       AND GOREMAL_EMAL_CODE = gv_CodeMail
       AND INSTR(LOWER(GOREMAL_EMAIL_ADDRESS), psEmail) > 0;
    -- VALIDACION SE ENCONTRO INFORMACION O GENERA SECUENCIA
    IF (vnExiste = 0) THEN
        -- ACTUALIZA EL CAMPO ENCONTRADO
        UPDATE GENERAL.GOREMAL
        SET GOREMAL_EMAIL_ADDRESS = psEmail || gv_Codeserv
        WHERE GOREMAL_PIDM = psPidm
          AND GOREMAL_EMAL_CODE = gv_CodeMail;
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        NULL;
END p_valmail;

-- PROCESO DE INSERTADO DE MAIL GENERAL
PROCEDURE p_insmail(
    psPidm        IN        NUMBER,
    psEmail        IN        GOREMAL.GOREMAL_EMAIL_ADDRESS%TYPE) IS
BEGIN
    -- INSERTA INFORMACION DEL MAIL GENERAL
    INSERT INTO GENERAL.GOREMAL
        (GOREMAL_PIDM, GOREMAL_EMAL_CODE, GOREMAL_EMAIL_ADDRESS, GOREMAL_STATUS_IND, GOREMAL_PREFERRED_IND, GOREMAL_ACTIVITY_DATE, GOREMAL_USER_ID, GOREMAL_DISP_WEB_IND)
    VALUES
        (psPidm, gv_CodeMail, psEmail || gv_Codeserv, 'A', 'Y', SYSDATE, USER, 'Y');
END p_insmail;

-- FUNCION QUE VALIDA QUE TENGA EL FORMATO DE STANDAR EL NOMBRE DEL ALUMNO
FUNCTION f_valnombre(
    psPidm        IN        NUMBER)
    RETURN VARCHAR2 IS
-- DECLARACION DE VARIABLES LOCALES
vnExiste            NUMBER(2):=0;
BEGIN
    -- BUSCA SI TIENE EL ESTANDAR DEL ASTERISCO
    SELECT COUNT(*)
      INTO vnExiste
      FROM SPRIDEN
     WHERE SPRIDEN_PIDM = psPidm
       AND INSTR(SPRIDEN_LAST_NAME, '*') > 0;
    -- VALIDA LO ENCONTRADO
    IF (vnExiste = 0) THEN
        RETURN 'N';
    ELSE
        RETURN 'Y';
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RETURN 'N';
END;

BEGIN
    -- VALIDA SI EL PIDM NO ENVIADO EXISTE
    for reg in correos loop
           psPidm:=reg.pidm;
    IF ( f_ExistePidm (psPidm) = 0 AND (f_valnombre(psPidm) = 'Y') ) THEN
        -- ARMAN EL MAIL NUEVO
        p_genmail(psPidm, vvNuevoEmail);
        -- INSERTA EL NUEVO MAIL EN TABLA DE MAIL
        INSERT INTO GWBMAIL (GWBMAIL_PIDM, GWBMAIL_EMAIL, GWBMAIL_PASSW, GWBMAIL_USER, GWBMAIL_ACTIVITY_DATE)
        VALUES(psPidm, vvNuevoEmail, DBMS_RANDOM.STRING('X', 8), USER, SYSDATE);
        -- VALIDA SI SE ENCUENTRA EN MAIL GENERAL
        IF (f_ExisteMail(psPidm) = 0 ) THEN
            -- INSERTA EL NUEVO MAIL
            p_insmail(psPidm, vvNuevoEmail);
        ELSE
            -- VALIDA SI CUMPLE CON EL STANDAR PARA ACTUALIZARLO
            p_valmail(psPidm, vvNuevoEmail);
        END IF;
        -- CONSOLIDA LA INFORMACION GENERADA
        COMMIT;
    END IF;
    end loop;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        DBMS_OUTPUT.PUT_LINE('PIDM CON ERROR  ' || psPidm);
END PWRCORR;
/


DROP PUBLIC SYNONYM PWRCORR;

CREATE PUBLIC SYNONYM PWRCORR FOR BANINST1.PWRCORR;


GRANT EXECUTE ON BANINST1.PWRCORR TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRCORR TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRCORR TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRCORR TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCPOS;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCPOS (psReclDesc   VARCHAR2) IS

/**************************************************************
           tarea:  procedimiento que genera el reporte de la carga de postulaciones
          mdulo:  admisiones
           autor:  horacio martnez ramrez - hmr
           fecha:  21/dic/2010
**************************************************************/

  vnExists       INTEGER  := 0;
  vnColumnas     INTEGER  := 4;
  vgsInicioPag   VARCHAR2(30)  := NULL;           -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vnIdRenglon    INTEGER  := 1;
  vsTerm         SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;


  CURSOR cuReporte IS

     SELECT TU.SABNSTU_ID                       ID_WEB,
            PE.SPBPERS_NAME_SUFFIX              RUT,
            UPPER(REPLACE(REPLACE (REPLACE(SP.SPRIDEN_LAST_NAME,'*',' '),'XYZ',''),'  ',' '))  APELLIDOS,
            UPPER(SP.SPRIDEN_FIRST_NAME)        NOMBRE
       FROM SABNSTU TU, SPBPERS PE, SPRIDEN SP, SABIDEN DE
      WHERE TU.SABNSTU_AIDM = DE.SABIDEN_AIDM
        AND TU.SABNSTU_ID   = SP.SPRIDEN_ID
        AND DE.SABIDEN_PIDM = SP.SPRIDEN_PIDM
        AND DE.SABIDEN_PIDM = PE.SPBPERS_PIDM
      ORDER BY TU.SABNSTU_ID;

  BEGIN

     -- valida que el usuario pertenezca a la base de datos:
     IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

     -- son buscados los valores de las cookies para asignar los valores del filtro del query:
     --vsterm  := pk_objhtml.getvaluecookie('psterm');

     -- se determina el largo de la tabla:
     FOR vnI IN 1..vnColumnas LOOP
         tabColumna.EXTEND(vnI);
         tabColumna(vnI) := NULL;
     END LOOP;

     tabColumna(1) := 'ID_WEB';
     tabColumna(2) := 'RUT';
     tabColumna(3) := 'Apellidos';
     tabColumna(4) := 'Nombre';

     FOR regRep IN cuReporte LOOP

         IF vnExists = 0 THEN

            Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psUsuario=>pk_login.vgsUsr, psUniversidad=>'UFT');
            vgsInicioPag := 'SALTO';

         END IF;

         HTP.P('<tr> <td valign="top" align="left">' ||regRep.ID_WEB      ||'</td>
                     <td valign="top" align="left">' ||regRep.RUT         ||'</td>
                     <td valign="top" align="left">' ||regRep.APELLIDOS   ||'</td>
                     <td valign="top" align="left">' ||regRep.NOMBRE      ||'</td>
                </tr>');

            vnExists      := 1;
            vnIdRenglon := vnIdRenglon + 1;

     END LOOP;

     IF vnExists = 0 THEN
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');

     ELSE
        -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pgina:
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
     END IF;

     htp.p('</table><br/></body></html>');

  EXCEPTION
     WHEN OTHERS THEN
          htp.p(SQLERRM);

  END PWRCPOS;
/


DROP PUBLIC SYNONYM PWRCPOS;

CREATE PUBLIC SYNONYM PWRCPOS FOR BANINST1.PWRCPOS;


GRANT EXECUTE ON BANINST1.PWRCPOS TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCPOS TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCRBO;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCRBO (
	psReclDesc			VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:		PWRCRBO
OBJETIVO:			Reporte de Control de Boletas y pagars por contrato
PARAMETROS:
psReclDesc			Variable estandar para la maquina de reportes custom
AUTOR:				Gilberto Velazquez Hernandez
FECHA:				20121009
******************************************************************************/

	--Numero de renglones
	vnRow				PLS_INTEGER := 0;
	--Bandera para mostrar si hubo datos
	vnExists			INTEGER := 0;
	--Numero de columnas
	vnColumnas			INTEGER := 6;
	--Numero de registros
	vnRegs				INTEGER := 0;
	--Arreglo (nested table) donde se guardan los encabezados de las columnas
	tabColumna			Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
	-- la variable es una bandera que al tener el valor "imprime" no colocara
	--el salto de pgina para impresion
	vsInicoPag			VARCHAR2(10) := NULL;
	--Nmero de renglones por pgina
	vnRegsPag			PLS_INTEGER := 4000;

	--Filtro de fecha de inicio
	vdIni				DATE;
	--Filtro de fecha de fin
	vdFin				DATE;
	--Filtro Periodo
	vsPerio				VARCHAR2(6);
	--Filtro de Operador
	vsOper				VARCHAR2(30);

	--El reporte en si, es una "babosada" :P
	CURSOR cuReporte(
		pdIni			DATE
		,pdFin			DATE
		,psOper			VARCHAR2
		,psPerio		VARCHAR2
	) IS
	 SELECT
            TO_CHAR(TWBCNTR_ISSUE_DATE,'DD/MM/YYYY')                AS Fecha
            ,TWBCNTR_ISSUE_USER                                        AS Operador
            ,TWBCNTR_NUM                                            AS NumCntr
            ,pk_Matricula.f_MontoContrato(TWBCNTR_NUM)                AS Monto
            --,NVL(TWBCNTR_INVOICE_NUM,'N/D')                            AS Boleta
            ,NVL(TO_CHAR(TWBBOLE_BOL_NUM) ,'N/D')                                        As Boleta
            --,TWBBOLE_BOL_NUM
            ,NVL(TWBCNTR_PROM_NOTE_NUM,'N/D')                        AS Pagare
        FROM
            TWBCNTR,TWBBOLE
        WHERE
            TWBCNTR_STATUS_IND <> 'C'
            AND (pdIni IS NULL OR TWBCNTR_ISSUE_DATE >= pdIni)
            AND (pdFin IS NULL OR TWBCNTR_ISSUE_DATE < (pdFin + 1))
            AND (psOper IS NULL OR UPPER(psOper) = UPPER(TWBCNTR_ISSUE_USER))
            AND (psPerio IS NULL OR TWBCNTR_TERM_CODE = psPerio)
            AND TWBBOLE_CNTR_NUM = TWBCNTR_NUM
        ORDER BY
            TWBCNTR_NUM;
BEGIN

	--Seguridad de GWAMNUR
	IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

	--Obtengo los parametros de fechas
	vdIni := TO_DATE(pk_objHtml.getValueCookie('psIni'),'DD/MM/YYYY');
	vdFin := TO_DATE(pk_objHtml.getValueCookie('psFin'),'DD/MM/YYYY');

	--Obtengo el operador
	vsOper := pk_objHtml.getValueCookie('psOper');
	--Obtengo el periodo
	vsPerio := pk_objHtml.getValueCookie('psPerio');
	--Obtengo el tipo de

	-- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
	tabColumna.EXTEND(vnColumnas);

	--Guardamos los encabezados en el arreglo de columnas
	tabColumna( 1) := 'Fecha';
	tabColumna( 2) := 'Matriculador';
	tabColumna( 3) := 'Num. Contrato';
	tabColumna( 4) := 'Monto';
	tabColumna( 5) := 'Num. Boleta';
	tabColumna( 6) := 'Num. Pagare';

	--Inicializamos contador de renglones
	vnRow := 0;

	FOR regReporte IN cuReporte(vdIni, vdFin, vsOper, vsPerio) LOOP

		--Incremento el contador de renglones
		vnRow := vnRow + 1;
		vnExists := 1; --Bandera para indicar que hubo resultados

		--Si es el primer renglon de cada pgina...
		IF MOD(vnRow, vnRegsPag) = 1  THEN
			--imprimo el encabezado de reporte
			Pk_Sisrepimp.P_EncabezadoDeReporte(
				psReclDesc ,vnColumnas ,tabColumna
				,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
			);
			vsInicoPag := 'SALTO';
		END IF;

		--Comienzo a desplegar el renglon
		HTP.P('<tr>');
		HTP.P('<td>'||regReporte.Fecha||'</td>');
		HTP.P('<td>'||regReporte.Operador||'</td>');
		HTP.P('<td>'||regReporte.NumCntr||'</td>');
		HTP.P('<td>'||TO_CHAR(regReporte.Monto,'999G999G999G999')||'</td>');
		HTP.P('<td>'||regReporte.Boleta||'</td>');
		HTP.P('<td>'||regReporte.Pagare||'</td>');
		--Fin del renglon
		HTP.P('</tr>');

	END LOOP;

	IF vnExists = 0 THEN
		--Ojo esta linea lo que hace es imprimir
		--NO SE ENCONTRARON DATOS o un mensaje similar
		htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
	ELSE

		-- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
		Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

		-- es omitido el encabezado del reporte pero se agrega el salto de pagina
		Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
	END IF;

	--Fin de la pagina
	htp.p('</table><br/></body></html>');
EXCEPTION
	WHEN OTHERS THEN
		--pantallazo de error.
		pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
			'PWRCRBO', NULL);
END PWRCRBO;
/


DROP PUBLIC SYNONYM PWRCRBO;

CREATE PUBLIC SYNONYM PWRCRBO FOR BANINST1.PWRCRBO;


GRANT EXECUTE ON BANINST1.PWRCRBO TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRCRBO TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRCRBO TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRCRBO TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCRCF;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCRCF(psReclDesc VARCHAR2,
                                                                         psReclProc VARCHAR2 DEFAULT 'PK_REGCALICOCALF.P_CORRECCIONCALF') IS

/**************************************************************
           tarea:  generar acta de correccin de calificaciones
         mdulo:  consulta al registro de calificaciones
           autor:  horacio martnez ramrez - hmr
           fecha:  12/oct/2010
**************************************************************/

  TYPE t_ActaCorreccion IS REF CURSOR;
  TYPE regALUM IS RECORD (rID    VARCHAR2(9),
                          rName  VARCHAR2(300),
                          rFolio VARCHAR2(15),
                          rCRN   VARCHAR2(15),
                          rCrseT VARCHAR2(30),
                          rSubj  VARCHAR2(04),
                          rCrseN VARCHAR2(05),
                          rGrde  VARCHAR2(06),
                          rUltC  VARCHAR2(06),
                          rUser  VARCHAR2(30),
                          rFMod  DATE,
                          rClve  VARCHAR2(02),
                          rCamp  VARCHAR2(6)
                         );

  TYPE tableAlum IS TABLE OF regAlum INDEX BY BINARY_INTEGER;

  ckNombres   owa_cookie.vc_arr;
  ckValores   owa_cookie.vc_arr;
  ckCount     INTEGER;
  vgsUSR      VARCHAR2(500);

  vnHoja      INTEGER       := 1;
  vnRow       INTEGER       := 1;
  vnRegsxHoja INTEGER       := 21;
  vnRenglon   INTEGER       := 0;
  vnTotHojas  INTEGER       := 0;
  vsColorBco  VARCHAR2(8)   := '#FFFFFF';
  vsColorGris VARCHAR2(8)   := '#EEEEEE';
  vsColor     VARCHAR2(8)   := NULL;
  psSaltoPag  VARCHAR2(10)  := NULL;
  vsSaltoImp  VARCHAR2(10)  := NULL;
  vsClave     VARCHAR2(2)   := NULL;
  vsTitulo1   VARCHAR2(350) := NULL;

  vsGchg      VARCHAR2(3)   := NULL;
  vsTerm      VARCHAR2(6)   := NULL;
  vsColl      VARCHAR2(6)   := NULL;
  vsModRC     VARCHAR2(6)   := NULL;
  vsCRN       VARCHAR2(6)   := NULL;
--  vscamp      varchar2(6)   := f_contexto();
  vsEstilo    VARCHAR2(100) := 'style="border-bottom:none;border-top:none;border-left:none;border-right:none"';

  cuActCor    t_ActaCorreccion;
  cuAlumno    t_ActaCorreccion;
  tabAlum     tableAlum;

  function F_PidmDire(psColl VARCHAR2,
                      psTerm VARCHAR2 ) return number is

  vnPidmDire number := 0;

  begin
         select sirnist_pidm
           into vnPidmDire
           from sirnist
          where sirnist_coll_code = psColl
            and sirnist_term_code = psTerm
            and sirnist_nist_code = 'DIRE';

         return vnPidmDire;

  exception
      when others then
           return vnPidmDire;
  end F_PidmDire;

  function f_Cursor(psCursor VARCHAR2) return t_ActaCorreccion is

  begin
      if    psCursor = 'CA' then
            open cuAlumno for
                 select f_get_id(shrtckn_pidm)                                                      id,
                        pk_catalogo.nombre(shrtckn_pidm)                                            nombre,
                        pk_regcaliacta.f_folio_acta(vsterm, shn.shrtckn_crn)                        folio,
                        sfrstcr_crn                                                                 crn,
                        shrtckn_crse_title                                                          materia,
                        shrtckn_subj_code                                                           subj,
                        shrtckn_crse_numb                                                           crse,
                        f_get_calif_oe(shrtckn_pidm, vsterm, shrtckg_tckn_seq_no)  calf,
                        shg.shrtckg_grde_code_final                                                 ultc,
                        shg.shrtckg_final_grde_chg_user                                             usuario,
                        shg.shrtckg_final_grde_chg_date                                             fecham,
                        shg.shrtckg_gchg_code                                                       clave,
                        shrtckn_camp_code camp
                   from sfrstcr,
                        shrtckn shn,
                        shrtckg shg,
                        shrgrde she,
                        scbcrse scb
                  where shn.shrtckn_pidm      = sfrstcr_pidm
                    and shn.shrtckn_term_code = sfrstcr_term_code
                    and shn.shrtckn_crn       = sfrstcr_crn
                    and shn.shrtckn_subj_code = scbcrse_subj_code
                    and shn.shrtckn_crse_numb = scbcrse_crse_numb
                    and scb.scbcrse_eff_term  = (select max(b.scbcrse_eff_term)
                                                   from scbcrse b
                                                  where b.scbcrse_subj_code = scb.scbcrse_subj_code
                                                    and b.scbcrse_crse_numb = scb.scbcrse_crse_numb
                                                    and b.scbcrse_eff_term <= vsterm
                                                )
                    and shn.shrtckn_seq_no    = (select max(shn1.shrtckn_seq_no)
                                                   from shrtckn  shn1
                                                  where shn1.shrtckn_term_code = shn.shrtckn_term_code
                                                    and shn1.shrtckn_pidm      = shn.shrtckn_pidm
                                                    and shn1.shrtckn_crn       = shn.shrtckn_crn
                                                )
                    and shg.shrtckg_pidm        = shn.shrtckn_pidm
                    and shg.shrtckg_term_code   = shn.shrtckn_term_code
                    and shg.shrtckg_tckn_seq_no = shn.shrtckn_seq_no
                    and shg.shrtckg_seq_no      = (select max(shg1.shrtckg_seq_no)
                                                     from shrtckg  shg1
                                                    where shg.shrtckg_pidm        = shg1.shrtckg_pidm
                                                      and shg.shrtckg_term_code   = shg1.shrtckg_term_code
                                                      and shg.shrtckg_tckn_seq_no = shg1.shrtckg_tckn_seq_no
                                                  )
                    and she.shrgrde_code                    = shg.shrtckg_grde_code_final
                    and nvl(she.shrgrde_levl_code, sfrstcr_levl_code) = nvl(sfrstcr_levl_code, she.shrgrde_levl_code)
                    and she.shrgrde_term_code_effective = (select max(she1.shrgrde_term_code_effective)
                                                             from shrgrde she1
                                                            where she.shrgrde_code                  = she1.shrgrde_code
                                                              and she.shrgrde_levl_code             = she1.shrgrde_levl_code
                                                              and she1.shrgrde_term_code_effective <= shg.shrtckg_term_code
                                                          )
                    and (shn.shrtckn_crn       = vscrn or vscrn is null)
                    and (   (shg.shrtckg_gchg_code = vsgchg
                             and
                             vsgchg is not null
                            )
                         or
                            (vsgchg is null
                             and
                             shg.shrtckg_gchg_code in ('CA', 'CO', 'DO', 'IN')
                            )
                        )
                    and sfrstcr_term_code      = vsterm
                    and scb.scbcrse_coll_code  = vscoll
                    and (shg.shrtckg_gmod_code = vsmodrc or vsmodrc is null)
--                    and shn.shrtckn_camp_code  = vscamp
                  order by nombre;

      elsif psCursor = 'IA' then

            open cualumno for
                 select f_get_id(shrtckn_pidm)                      id,
                        pk_catalogo.nombre(shrtckn_pidm)                     nombre,
                        pk_regcaliacta.f_folio_acta(vsterm, shn.shrtckn_crn) folio,
                        shn.shrtckn_crn                                      crn,
                        shrtckn_crse_title                                   materia,
                        shrtckn_subj_code                                    subj,
                        shrtckn_crse_numb                                    crse,
                        sfrstcr_grde_code                                    calf,
                        shg.shrtckg_grde_code_final                          ultc,
                        shg.shrtckg_final_grde_chg_user                      usuario,
                        shg.shrtckg_final_grde_chg_date                      fecham,
                        shg.shrtckg_gchg_code                                clave,
                        shrtckn_camp_code camp
                   from sfrstcr,
                        shrtckn shn,
                        shrtckg shg,
                        scbcrse scb
                  where shn.shrtckn_pidm        = sfrstcr_pidm(+)
                    and shn.shrtckn_term_code   = sfrstcr_term_code(+)
                    and shn.shrtckn_crn         = sfrstcr_crn(+)
                    and shn.shrtckn_seq_no      = (select max(shn1.shrtckn_seq_no)
                                                   from shrtckn  shn1
                                                  where shn1.shrtckn_pidm      = shn.shrtckn_pidm
                                                    and shn1.shrtckn_term_code = shn.shrtckn_term_code
                                                    and shn1.shrtckn_subj_code = shn.shrtckn_subj_code
                                                    and shn1.shrtckn_crse_numb = shn.shrtckn_crse_numb
                                                  )
                    and shg.shrtckg_pidm        = shn.shrtckn_pidm
                    and shg.shrtckg_term_code   = shn.shrtckn_term_code
                    and shg.shrtckg_tckn_seq_no = shn.shrtckn_seq_no
                    and shg.shrtckg_seq_no      = (select max(shg1.shrtckg_seq_no)
                                                     from shrtckg  shg1
                                                    where shg.shrtckg_pidm        = shg1.shrtckg_pidm
                                                      and shg.shrtckg_term_code   = shg1.shrtckg_term_code
                                                      and shg.shrtckg_tckn_seq_no = shg1.shrtckg_tckn_seq_no
                                                  )
                    and shn.shrtckn_subj_code   = scbcrse_subj_code
                    and shn.shrtckn_crse_numb   = scbcrse_crse_numb
                    and scb.scbcrse_eff_term    = (select max(b.scbcrse_eff_term)
                                                     from scbcrse b
                                                    where b.scbcrse_subj_code = scb.scbcrse_subj_code
                                                      and b.scbcrse_crse_numb = scb.scbcrse_crse_numb
                                                      and b.scbcrse_eff_term <= vsterm
                                                  )
--                    and shn.shrtckn_camp_code   = vscamp
                    and shg.shrtckg_gchg_code   = pscursor
                    and scb.scbcrse_coll_code   = vscoll
                    and shn.shrtckn_term_code   = vsterm
                  order by nombre;

      end if;

      return cuAlumno;

  end f_Cursor;

  procedure p_Encabezado(psTerm     varchar2,
                         psColl     varchar2,
                         psModRC    varchar2 default null,
                         psSaltoPag varchar2 default null) is

  vsModeDesc  varchar2(100) := null;
  vsNombreAud varchar2(100) := null;
  vsImagen    varchar2(50)  := null;
  vsTitulo    varchar2(150) := null;
  vsTipo      varchar2(150) := null;
  vsTitFolio  varchar2(350) := null;

  cursor cuAuditor IS
         SELECT PK_CATALOGO.NOMBRE(S1.SERSSGP_PIDM)  NOMBRE
           FROM SERSSGP S1
          WHERE S1.SERSSGP_SSGP_CODE = 'AUDI'
            AND S1.SERSSGP_TERM_CODE_EFF  <= psTerm;

  begin
      BEGIN
          SELECT DECODE(psModRC,'N','Ordinario',PK_CATALOGO.GRADEMODE(psModRC))
            INTO vsModeDesc
            FROM DUAL;

          FOR regAudi IN cuAuditor LOOP
              vsNombreAud := regAudi.NOMBRE;
          END LOOP;

      EXCEPTION
          WHEN OTHERS THEN
               NULL;
      END;

--      select decode(pk_configregistroelectronico.vgscontxant,'uan','log_anahuac_inst.gif',f_logotipo),
      SELECT DECODE(vsClave,'CA','ACTA DE CORRECI&Oacute;N DE CALIFICACI&Oacute;N FINAL','ACTA DE CALIFICACIONES FINALES ALUMNOS DE INTERCAMBIO'),
                 DECODE(vsClave,'CA',vsModeDesc,'ORDINARIO'),
                 DECODE(vsClave,'CA','<td class="tdFont7" width="13%" bgcolor="#CCCCCC" align="center"><b>Folio</b></td>',NULL)
--         into vsimagen,vstitulo,vstipo,vstitfolio
         INTO vsTitulo,vsTipo,vsTitFolio
        FROM DUAL;

      IF psSaltoPag IS NULL THEN
          htp.p('<html><head><title>'||vsTitulo1||'</title>');

          -- la aplicacin no se guarda en el cache de la mquina.
          PK_ObjHTML.P_NoCache;

          htp.p('<style type="text/css"><!--');
          htp.p('br.brNuevaPag   {page-break-before:always}');
          htp.p(' --></style>');

          -- codigo css
          PK_ObjHTML.P_CssTabs;

          htp.p('<script language="JavaScript"><!--');
          htp.p('function fImprimeReporte() {
          window.focus()
          print();
          }');

          htp.p('
          //--></script>
          </head><body bgcolor="#ffffff" class="bodyCeroR">
          ');
      END IF;


      IF psSaltoPag IS NULL OR psSaltoPag = 'Salto' THEN
         IF psSaltoPag = 'Salto' THEN
            htp.p('
            <tr class="trTabSepara">
            <td colspan="13" align="center" class="tdFont7" '||vsEstilo||'>**********NADA V&Aacute;LIDO DESPU&Eacute;S DE ESTA L&Iacute;NEA**********
            </td></tr>
            </table><br/>
            ');

            --- pie del documento - firmas del acta
            IF vsClave = 'CA' THEN
               htp.p('
               <table width="80%" border="1" cellpadding="0" cellspacing="0" align="center">
               <tr class="trSeparador" >
                   <td class="tdFont7" style="border-bottom:none;" width="100%" align="left" valign="top">CA Correcci&oacute;n por Auditor&iacute;a</td></tr>
               <tr class="trSeparador">
                   <td class="tdFont7" style="border-bottom:none;border-top:none" width="100%" align="left" valign="top">IN    Invalidar Nota</td></tr>
               <tr class="trSeparador">
                   <td class="tdFont7" style="border-bottom:none;border-top:none" boder-top="none" width="100%" align="left" valign="top">DO    Dictamen Oficial</td></tr>
               <tr class="trSeparador">
                   <td class="tdFont7" style="border-top:none" width="100%" align="left" valign="top">CO    Correcci&oacute;n de error</td>
               </tr></table>');

            END IF;

            htp.p('
            <table width="50%" border="0" cellpadding="0" cellspacing="0" align="center">
                   <tr class="trTabSepara" >
                       <td class="tdFont8" width="45%" align="center" height="90" valign="bottom">__________________________</td>
                       <td class="tdFont8" width="10%"></td>
                       <td class="tdFont8" width="45%" align="center" valign="bottom">__________________________</td></tr>
                   <tr class="trTabSepara">
                       <td class="tdFont7" width="45%" align="center">Sello de la escuela o departamento</td>
                       <td class="tdFont7" width="10%"></td>
                       <td class="tdFont7" width="45%" align="center">Sello de Administraci&oacute;n Escolar</td></tr>
            </table>
            ');

            IF vsSaltoImp IS NULL THEN
               htp.p('<br class="brNuevaPag">');
            END IF;
         END IF;

         IF vsSaltoImp IS NULL THEN
             htp.p('
             <table width="90%" border="1" cellpadding="2" cellspacing="0" align="center">
                    <tr class="trTabSepara">
                        <td width="40%" rowspan="5" align="center" valign="top" '||vsEstilo||'>
                            <img src="/imagenes/logo_uft.jpg'||'" width="100"  border="0"></td>
                        <td class="tdFont8" width="03%" rowspan="06" '||vsEstilo||'></td>
                        <td colspan="3" '||vsEstilo||'>
                            <table width="100%" border="0" cellpadding="0" cellspacing="0" >
                                   <tr><td class="tdFont8" width="80%" align="left"></td>
                                       <td class="tdFont8" width="20%" align="right">Hoja '||vnHoja||' de '||vnTotHojas||
                                       '</td></tr>
                                   </table></td></tr>
                    <tr class="trTabSepara"><td class="tdFont8" colspan="3" '||vsEstilo||'><B>'||vsTitulo||'</B></td></tr>
                    <tr class="trTabSepara"><td class="tdFont8" colspan="3" height="08" '||vsEstilo||'></td></tr>
                    <tr class="trTabSepara">
                        <td class="tdFont8" colspan="3">TIPO:'||vsTipo||'&nbsp;&nbsp;&nbsp;PERIODO: '||psTerm||'   '||PK_CATALOGO.PERIODO(psTerm)||'</td></tr>
                    <tr class="trTabSepara">
                        <td class="tdFont8" colspan="3" height="08" '||vsEstilo||' ></td></tr>
                    <tr class="trTabSepara">
                        <td class="tdFont8" >FECHA DE EMISI&Oacute;N : '||TO_CHAR(SYSDATE,'DD/MM/YYYY')||'</td>
                        <td class="tdFont8" colspan="3" >ESCUELA O DEPARTAMENTO RESPONSABLE: '||pk_catalogo.colegio(psColl)||'</td></tr>
                    <tr class="trTabSepara">
                        <td class="tdFont8" colspan="4" height="08" '||vsEstilo||'></td></tr>
                    <tr class="trTabSepara">
                        <td class="tdFont8" colspan="4" height="08" '||vsEstilo||'></td></tr>
                    <tr class="trTabSepara">
                        <td colspan="4" width="100%" '||vsEstilo||'>
                            <table width="100%" border="1" cellpadding="0" cellspacing="0" align="center">
                                   <tr>
                                       <td width="10%" '||vsEstilo||'> </td>
                                       <td width="35%" class="tdFont7" valign="top" align="left" height="70">Director: '||PK_CATALOGO.nombre(F_PidmDire(psColl, psTerm))||'</td>
                                       <td width="10%" '||vsEstilo||'> </td>
                                       <td width="35%" class="tdFont7" valign="top" align="left" height="70">Auditoria Escolar :'||vsNombreAud||' </td>
                                       <td width="10%" '||vsEstilo||'> </td>
                                    </tr>
                            </table>
                        </td>
                    </tr>
             </table><br/>
             ');

             -- encabezado de la lista de alumnos
             htp.p('
             <table width="100%" border="1" cellpadding="2" cellspacing="0" align="center">
                    <tr class="trTabSepara">
                        <td class="tdFont7" width="02%" bgcolor="#CCCCCC" align="center"><b>No.              </b></td>
                        <td class="tdFont7" width="04%" bgcolor="#CCCCCC" align="center"><b>Expediente       </b></td>
                        <td class="tdFont7" width="18%" bgcolor="#CCCCCC" align="center"><b>Nombre del Alumno</b></td>
                        <td class="tdFont7" width="12%" bgcolor="#CCCCCC" align="center"><b>Carrera          </b></td>'||
             vsTitFolio||
                       '<td class="tdFont7" width="04%" bgcolor="#CCCCCC" align="center"><b>NRC    </b></td>
                        <td class="tdFont7" width="04%" bgcolor="#CCCCCC" align="center"><b>SUBJ   </b></td>
                        <td class="tdFont7" width="04%" bgcolor="#CCCCCC" align="center"><b>CRSE   </b></td>
                        <td class="tdFont7" width="17%" bgcolor="#CCCCCC" align="center"><b>Materia</b></td>
             ');

             IF vsClave = 'CA' THEN
                htp.p('
                <td class="tdFont7" width="05%" bgcolor="#CCCCCC" align="center"><b>Modific&oacute; en sistema</b></td>
                <td class="tdFont7" width="09%" bgcolor="#CCCCCC" align="center"><b>Fecha Mod.                </b></td>
                <td class="tdFont7" width="02%" bgcolor="#CCCCCC" align="center"><b>Clave                     </b></td>
                <td class="tdFont7" width="03%" bgcolor="#CCCCCC" align="center"><b>Cal. Original             </b></td>
                <td class="tdFont7" width="03%" bgcolor="#CCCCCC" align="center"><b>Cal. Modif.               </b></td></tr>
                ');
             ELSE
                htp.p('
                <td class="tdFont7" width="10%" bgcolor="#CCCCCC" align="center"><b>Fecha Alta </b></td>
                <td class="tdFont7" width="10%" bgcolor="#CCCCCC" align="center"><b>Calif Final</b></td></tr>
                ');
             END IF;
         END IF;

      END IF;

  end p_Encabezado;


  BEGIN
      -- valida que el usuario pertenezca a la base de datos.
      IF PK_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
         FOR vnCOKIES IN 1..ckCount LOOP
             IF ckNOMBRES(vnCOKIES) = 'psPerio' THEN
                   vsTerm := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psEsST' THEN
                      vsColl := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psModRC' THEN
                      vsModRC  := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psTCrnI' THEN
                      vsCRN   := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psGchg' THEN
                      vsGchg   := ckValores(vnCOKIES);

             END IF;
         END LOOP;
      END IF;


--      insert into sysvpdi(sysvpdi_userid) values(user);
--      commit;

      SELECT DECODE(UPPER(psReclProc),'PK_REGCALICOCALF.P_CORRECCIONCALF','CA','IA'),
                 DECODE(UPPER(psReclProc),'PK_REGCALICOCALF.P_CORRECCIONCALF','Correcion de Calificaciones Finales','Acta de alumnos de intercambios')
         INTO vsClave,
                 vsTitulo1
        FROM DUAL;

      cuActCor := f_Cursor(vsClave);

      LOOP
           EXIT WHEN cuActCor%NOTFOUND;
           FETCH cuActCor INTO tabAlum(vnRow).rID,
                               tabAlum(vnRow).rName,
                               tabAlum(vnRow).rFolio,
                               tabAlum(vnRow).rCRN,
                               tabAlum(vnRow).rCrseT,
                               tabAlum(vnRow).rSubj,
                               tabAlum(vnRow).rCrseN,
                               tabAlum(vnRow).rGrde,
                               tabAlum(vnRow).rUltC,
                               tabAlum(vnRow).rUser,
                               tabAlum(vnRow).rFMod,
                               tabAlum(vnRow).rClve,
                               tabAlum(vnRow).rCamp;
           EXIT WHEN cuActCor%NOTFOUND;

           vnRow := vnRow + 1;

      END LOOP;
      CLOSE cuActCor;

--      delete sysvpdi where sysvpdi_userid = user;
--      commit;

      vnRow      := vnRow - 1;
      vnTotHojas := TRUNC(vnRow /vnRegsxHoja);

      IF vnTotHojas = 0 THEN
         vnTotHojas := 1;
      END IF;

      IF MOD(vnRow , vnRegsxHoja) > 0 AND vnRow > vnRegsxHoja THEN
         vnTotHojas := vnTotHojas +1;
      END IF;

      FOR vnC IN 1..vnRow  LOOP
          IF vnRenglon = 0 OR vnRenglon = vnRegsxHoja THEN
             p_Encabezado(vsTerm, vsColl, vsModRC,psSaltoPag);

             psSaltoPag := 'Salto';
             vnHoja    := vnHoja + 1;
             vnRenglon := 0;
          END IF;

          vnRenglon := vnRenglon + 1;

          SELECT DECODE(MOD(vnRenglon,2),0,vsColorGris,vsColorBco)
            INTO vsColor
            FROM DUAL;

          htp.p('
          <tr class="trTabSepara" bgcolor="'||vsColor||'">
          <td class="tdFont7" align="center" valign="top">'||vnRenglon          ||'</td>
          <td class="tdFont7" align="center" valign="top">'||tabAlum(vnC).rid   ||'</td>
          <td class="tdFont7" align="left"   valign="top">'||tabAlum(vnC).rName ||'</td>
          <td class="tdFont7" align="left"   valign="top">'||pk_catalogo.PROGRAMA(f_get_programa(f_get_pidm(tabAlum(vnC).rid),vsTerm))||'</td>');

          IF vsClave = 'CA' THEN
             HTP.P('<td class="tdFont7" align="center" valign="top">'||tabAlum(vnC).rFolio||'</td>');
          END IF;

          htp.p('
          <td class="tdFont7" align="center" valign="top">'||tabAlum(vnC).rCRN  ||'</td>
          <td class="tdFont7" align="center" valign="top">'||tabAlum(vnC).rSubj ||'</td>
          <td class="tdFont7" align="center" valign="top">'||tabAlum(vnC).rCrseN||'</td>
          <td class="tdFont7" align="left" valign="top">'  ||tabAlum(vnC).rCrseT||'</td>
          ');

          IF vsClave = 'CA' THEN
             htp.p('
             <td class="tdFont7" align="center" valign="top">'||tabAlum(vnC).rUser||'</td>
             <td class="tdFont7" align="center" valign="top">'||tabAlum(vnC).rFMod||'</td>
             <td class="tdFont7" align="center" valign="top">'||tabAlum(vnC).rClve||'</td>
             <td class="tdFont7" align="center" valign="top">'||tabAlum(vnC).rGrde||'</td>
             <td class="tdFont7" align="center" valign="top">'||tabAlum(vnC).rUltC||'</td>
             </tr>');
          ELSE
             htp.p('
             <td class="tdFont7" align="center" valign="top">'||tabAlum(vnC).rFMod||'</td>
             <td class="tdFont7" align="center" valign="top">'||tabAlum(vnC).rUltC||'</td>
             </tr>');
          END IF;


      END LOOP;

      vsSaltoImp := 'Imprime';
      p_Encabezado(vsTerm, vsColl, vsModRC,psSaltoPag);

      IF vnRow = 0 THEN
          htp.p('<center><font color="#ff0000">'||PK_sisRepImp.vgsResultado||'</center>');
      END IF;

      htp.p('<br/></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
               htp.p(SQLERRM);

  END PWRCRCF;
/


DROP PUBLIC SYNONYM PWRCRCF;

CREATE PUBLIC SYNONYM PWRCRCF FOR BANINST1.PWRCRCF;


GRANT EXECUTE ON BANINST1.PWRCRCF TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCRCF TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCRCU;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCRCU ( psReclDesc   VARCHAR2 ) IS

/*******************************************************************************
         tarea: procedimiento para generar el reporte de cursos por cupo.
        mdulo: programacin acadmica.
         autor: hmr - horacio martnez ramrez.
         fecha: 10/09/2010.

  modificacin: hmr - 13/05/2011.
                se eliminaron las columnas de das y horarios, validando
                que el docente sea el principal "sirasgn_primary_ind = 'y'"
                para evitar duplicidad en los crns.
                se estandariz el encabezado y el pie de pgina.
*******************************************************************************/

  ckNombres     owa_cookie.vc_arr;
  ckValores     owa_cookie.vc_arr;
  ckCount       INTEGER;
  vgsInicioPag  VARCHAR2(10) := NULL;  -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vgsUSR        VARCHAR2(500);
  vnExists      INTEGER                := 0;
  vnColumnas    INTEGER                := 15;
  tabColumna    Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vsPerio       VARCHAR2(6)            := NULL;
  vsFacu        VARCHAR2(6)            := NULL;
  vsTipo        VARCHAR2(50)           := NULL;
  vsUnive       VARCHAR2(50)           := NULL;
  vsSeccion     VARCHAR2(3)            := NULL;
  vsCupo        VARCHAR2(50)           := NULL;
  vsStatu       VARCHAR2(50)           := NULL;

  CURSOR cuReporte ( psUnive  VARCHAR2  DEFAULT NULL,
                     psTerm   VARCHAR2  DEFAULT NULL,
                     psFacu   VARCHAR2  DEFAULT NULL,
                     psTipo   VARCHAR2  DEFAULT NULL,
                     psCupo   VARCHAR2  DEFAULT NULL,
                     psStatu  VARCHAR2  DEFAULT NULL ) IS

     SELECT DISTINCT SS.SSBSECT_TERM_CODE                          PERIODO,
            NVL(SSBSECT_CAMP_CODE,'S/UNIV.')                       UNIVERSIDAD,
            Pk_Catalogo.UNIVERSIDAD(SSBSECT_CAMP_CODE)             DESC_UNIVERSIDAD,
            UPPER(Pk_Catalogo.COLEGIO(DECODE(SR.SSBOVRR_COLL_CODE,
                  NULL,SCBCRSE_COLL_CODE,SR.SSBOVRR_COLL_CODE)))   ESCUELA,
            SCBCRSE_SUBJ_CODE                                      SUBJ,
            SCBCRSE_CRSE_NUMB                                      CURSO,
            SCBCRSE_TITLE                                          MATERIA,
            SSBSECT_CRN                                            CRN,
            SSBSECT_PTRM_CODE||' '||SSBSECT_PTRM_START_DATE
                             ||' '||SSBSECT_PTRM_END_DATE
                             ||' '||SSBSECT_PTRM_WEEKS             PTRM,
            UPPER(STVSESS_DESC)                                    SESION,
            SSRXLST_XLST_GROUP                                     LISTA_CRUZADA,
            DECODE(SWRXLST_TYPE, 'M', 'MASTER', 'S', 'SIMULTNEO',
                                 'INDEPENDIENTE')                  TIPO_LISTA,
            UPPER(Pk_Catalogo.STATUS_1(SSBSECT_SSTS_CODE))         ESTATUS,
            SPRIDEN_ID                                             ID,
            SPBPERS_NAME_SUFFIX                                    RUT,
            PROFESOR.PIDM                                          PIDM,
            UPPER(Pk_Catalogo.NOMBRE(SPRIDEN_PIDM))                DOCENTE,
            SSBSECT_MAX_ENRL                                       CUPO,
            SSBSECT_ENRL                                           INSCRITOS
--            profesor.lu                                            lu,
--            profesor.ma                                            ma,
--            profesor.mi                                            mi,
--            profesor.ju                                            ju,
--            profesor.vi                                            vi,
--            profesor.sa                                            sa,
--            profesor.di                                            di,
--            profesor.inicio                                        inicio,
--            profesor.fin                                           fin
       FROM SSBSECT SS,
            SCBCRSE,
            ( SELECT SIRASGN_PIDM                                        PIDM,
                     SSRMEET_TERM_CODE                                   PERIODO,
                     SSRMEET_CRN                                         CRN,
                     SSRMEET_CATAGORY                                    CATEGORIA
--                     ssrmeet_hrs_week                                    horas_sem
--                     decode(ssrmeet_mon_day, 'm', 'lu', ssrmeet_mon_day) lu,
--                     decode(ssrmeet_tue_day, 't', 'ma', ssrmeet_tue_day) ma,
--                     decode(ssrmeet_wed_day, 'w', 'mi', ssrmeet_wed_day) mi,
--                     decode(ssrmeet_thu_day, 'r', 'ju', ssrmeet_thu_day) ju,
--                     decode(ssrmeet_fri_day, 'f', 'vi', ssrmeet_fri_day) vi,
--                     decode(ssrmeet_sat_day, 's', 'sa', ssrmeet_sat_day) sa,
--                     decode(ssrmeet_sun_day, 'u', 'do', ssrmeet_sun_day) di,
--                     substr(ssrmeet_begin_time,1,2)||':'||
--                     nvl(substr(ssrmeet_begin_time,3,2),'00')            inicio,
--                     substr(ssrmeet_end_time,1,2)||':'||
--                     nvl(substr(ssrmeet_end_time,3,2),'00')              fin
                FROM SSRMEET,
                     SIRASGN
               WHERE SSRMEET_TERM_CODE = SIRASGN_TERM_CODE(+)
                 AND SSRMEET_CRN       = SIRASGN_CRN(+)
                 AND SSRMEET_CATAGORY  = SIRASGN_CATEGORY(+)
                 AND SIRASGN_PRIMARY_IND = 'Y'                                            -- hmr
               GROUP BY SIRASGN_PIDM, SSRMEET_TERM_CODE, SSRMEET_CRN, SSRMEET_CATAGORY    -- hmr
                     ) PROFESOR,
            SPRIDEN,
            SWRXLST,
            SSRXLST,
            SSBOVRR SR,
            SPBPERS,
            STVSESS
      WHERE SSBSECT_TERM_CODE = PROFESOR.PERIODO(+)
        AND SSBSECT_CRN       = PROFESOR.CRN(+)
        AND SPRIDEN_PIDM      = SPBPERS_PIDM(+)
        AND SSBSECT_SUBJ_CODE = SCBCRSE_SUBJ_CODE
        AND SSBSECT_CRSE_NUMB = SCBCRSE_CRSE_NUMB
        AND SCBCRSE_EFF_TERM = ( SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                   FROM SCBCRSE SC
                                  WHERE SC.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                    AND SC.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                    AND SC.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB )
        AND PROFESOR.PIDM        = SPRIDEN_PIDM(+)
        AND SPRIDEN_CHANGE_IND   IS NULL
        AND SSBSECT_TERM_CODE    = SSRXLST_TERM_CODE(+)
        AND SSBSECT_CRN          = SSRXLST_CRN(+)
        AND SSRXLST_TERM_CODE    = SWRXLST_TERM_CODE(+)
        AND SSRXLST_CRN          = SWRXLST_CRN(+)
        AND SSRXLST_XLST_GROUP   = SWRXLST_XLST_GROUP(+)
        AND SS.SSBSECT_CRN       = SR.SSBOVRR_CRN (+)
        AND SS.SSBSECT_TERM_CODE = SR.SSBOVRR_TERM_CODE (+)
        AND (DECODE(SR.SSBOVRR_COLL_CODE ,NULL,SCBCRSE_COLL_CODE,SR.SSBOVRR_COLL_CODE ) = psFacu  OR psFacu  IS NULL)
        AND (SSBSECT_CAMP_CODE   = psUnive OR psUnive IS NULL)
        AND (SSBSECT_TERM_CODE   = psTerm  OR psTerm IS NULL)
        AND (SWRXLST_TYPE        = psTipo  OR psTipo IS NULL)
        AND ( (SSBSECT_MAX_ENRL  = 0  AND psCupo = '0') OR
              (SSBSECT_MAX_ENRL >= 40 AND psCupo = '40') OR
              (psCupo IS NULL) )
        AND (SSBSECT_SSTS_CODE = psStatu OR psStatu IS NULL)
        AND SSBSECT_SESS_CODE = STVSESS_CODE
      ORDER BY PERIODO DESC, DESC_UNIVERSIDAD, ESCUELA, MATERIA, CRN;


BEGIN
   -- valida que el usuario pertenezca a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- son buscados los valores de las cookies para asignar los valores del filtro del query:
   ckCount := 0;
   owa_cookie.get_all(ckNombres, ckValores, ckCount);

   IF ckCount != 0 THEN
      FOR vnCOKIES IN 1..ckCount LOOP
          IF ckNOMBRES(vnCOKIES) = 'psUnive' THEN
             vsUnive := ckValores(vnCOKIES);

          ELSIF ckNOMBRES(vnCOKIES) = 'psPerio' THEN
                vsPerio := ckValores(vnCOKIES);

          ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                vsFacu := ckValores(vnCOKIES);

          ELSIF ckNOMBRES(vnCOKIES) = 'psTipol' THEN
                vsTipo := ckValores(vnCOKIES);

          ELSIF ckNOMBRES(vnCOKIES) = 'psCupo' THEN
                vsCupo := ckValores(vnCOKIES);

          ELSIF ckNOMBRES(vnCOKIES) = 'psStat1' THEN
                vsStatu := ckValores(vnCOKIES);

          ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                vsSeccion := ckValores(vnCOKIES);

          END IF;
      END LOOP;
   END IF;

   -- se determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   tabColumna(1)  := '<center> Escuela';
   tabColumna(2)  := '<center> Materia';
   tabColumna(3)  := '<center> Curso';
   tabColumna(4)  := '<center> Nombre';
   tabColumna(5)  := '<center> NRC';
   tabColumna(6)  := '<center> Lista cruzada';
   tabColumna(7)  := '<center> Tipo de curso';
   tabColumna(8)  := '<center> Sesin';
   tabColumna(9)  := '<center> Estatus';
   tabColumna(10) := '<center> ID';
   tabColumna(11) := '<center> RUT';
   tabColumna(12) := '<center> Docente';
   tabColumna(13) := '<center> Cupo';
   tabColumna(14) := '<center> Parte de periodo';
   tabColumna(15) := '<center> Inscritos';

--   tabcolumna(15) := 'lu';
--   tabcolumna(16) := 'ma';
--   tabcolumna(17) := 'mi';
--   tabcolumna(18) := 'ju';
--   tabcolumna(19) := 'vi';
--   tabcolumna(20) := 'sa';
--   tabcolumna(21) := 'hora inicio';
--   tabcolumna(22) := 'hora fin';


   FOR regRep IN cuReporte(vsUnive, vsPerio, vsFacu, vsTipo, vsCupo, vsStatu) LOOP
       IF vnExists = 0 THEN
          Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||regRep.Periodo||' - '||Pk_Catalogo.PERIODO(regRep.Periodo), psUsuario=>vgsUsr, psSeccion=>vsSeccion, psUniversidad=>'UFT');
          vgsInicioPag := 'SALTO';
       END IF;

       htp.p('<tr> <td valign="top" align="left">'   ||regRep.ESCUELA       ||'</td>
                   <td valign="top" align="left">'   ||regRep.SUBJ          ||'</td>
                   <td valign="top" align="left">'   ||regRep.CURSO         ||'</td>
                   <td valign="top" align="left">'   ||regRep.MATERIA       ||'</td>
                   <td valign="top" align="center">' ||regRep.CRN           ||'</td>
                   <td valign="top" align="center">' ||regRep.LISTA_CRUZADA ||'</td>
                   <td valign="top" align="left">'   ||regRep.TIPO_LISTA    ||'</td>
                   <td valign="top" align="left">'   ||regRep.SESION        ||'</td>
                   <td valign="top" align="left">'   ||regRep.ESTATUS       ||'</td>
                   <td valign="top" align="left">'   ||regRep.ID            ||'</td>
                   <td valign="top" align="left">'   ||regRep.RUT           ||'</td>
                   <td valign="top" align="left">'   ||regRep.DOCENTE       ||'</td>
                   <td valign="top" align="center">' ||regRep.CUPO          ||'</td>
                   <td valign="top" align="center">' ||regRep.PTRM          ||'</td>
                   <td valign="top" align="center">' ||regRep.INSCRITOS     ||'</td> </tr>');

--                   <td valign="top" align="center">' ||regrep.lu            ||'</td>
--                   <td valign="top" align="center">' ||regrep.ma            ||'</td>
--                   <td valign="top" align="center">' ||regrep.mi            ||'</td>
--                   <td valign="top" align="center">' ||regrep.ju            ||'</td>
--                   <td valign="top" align="center">' ||regrep.vi            ||'</td>
--                   <td valign="top" align="center">' ||regrep.sa            ||'</td>
--                   <td valign="top" align="center">' ||regrep.inicio        ||'</td>
--                   <td valign="top" align="center">' ||regrep.fin           ||'</td>

      vnExists := 1;

   END LOOP;

   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';
      -- es omitido el encabezado del reporte pero se agrega el salto de pgina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR);
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRCRCU;
/


DROP PUBLIC SYNONYM PWRCRCU;

CREATE PUBLIC SYNONYM PWRCRCU FOR BANINST1.PWRCRCU;


GRANT EXECUTE ON BANINST1.PWRCRCU TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCRCU TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCRED;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCRED(psReclDesc VARCHAR2,
                                  psSiu      VARCHAR2 DEFAULT NULL) IS

/**************************************************************
           tarea:  obtiene concentrado de resultados de la evaluacin docente
          mdulo:  resultados del sistema de evaluacin de la prctica docente (seprad)
           autor:  horacio martnez ramrez - hmr
           fecha:  05/nov/2010
**************************************************************/

  global_pidm SPRIDEN.SPRIDEN_PIDM%TYPE;

  TYPE reg_Mate IS RECORD (rSubj       VARCHAR2(5),
                           rCrse       VARCHAR2(5),
                           rTitle      VARCHAR2(300),
                           rCrn        NUMBER(8),
                           rMedia      NUMBER,
                           rDesviacion NUMBER,
                           rInscritos  INTEGER,
                           rEvaluaron  INTEGER);

  TYPE tableMate IS TABLE OF reg_Mate INDEX BY BINARY_INTEGER;

  TYPE reg_Conc IS RECORD (rPidm       NUMBER,
                           rId         VARCHAR2(10),
                           rNombre     VARCHAR2(300),
                           rCursos     INTEGER,
                           rMedia      NUMBER,
                           rDesvi      NUMBER,
                           rPercentil  NUMBER,
                           rCuartil    INTEGER,
                           rLugar      INTEGER,
                           tabMaterias tableMate,
                           rMaterias   INTEGER);

  TYPE tableConc IS TABLE OF reg_Conc INDEX BY BINARY_INTEGER;

  tabConcent       tableConc;
  vgnCantidadMedia INTEGER        := 0;
  vgnMediaCero     INTEGER        := 0;
  vsCamp           VARCHAR2(6)    := NULL;
  vsEncu           VARCHAR2(30)   := NULL;
  vsTerm           VARCHAR2(6)    := NULL;
  vsColl           VARCHAR2(2)    := NULL;
  vsPtrm           VARCHAR2(1000) := NULL;
  vnMedia          NUMBER         := 0;
  vnDesviacion     NUMBER         := 0;

  cn0   CONSTANT NUMBER(1)   := 0;
  cn1   CONSTANT NUMBER(1)   := 1;
  cn2   CONSTANT NUMBER(1)   := 2;
  csI   CONSTANT VARCHAR2(1) := 'I';
  csL   CONSTANT VARCHAR2(1) := 'L';
  csShl CONSTANT VARCHAR2(1) := '/';

  CURSOR cuConcentrado(psCamp VARCHAR2,
                       psTerm VARCHAR2,
                       psColl VARCHAR2,
                       psEncu VARCHAR2,
                       psPtrm VARCHAR2
                      ) IS
         SELECT VPP.Pidm                                                                                    AS Pidm,
                pk_Seprad1.F_IdProfesor(VPP.Pidm)                                                           AS Id,
                pk_Seprad1.F_NameProfesor(VPP.Pidm)                                                         AS Nombre,
                cn0                                                                                         AS Cursos,
                DECODE(SUM(vpp.Media),cn0,cn0,SUM(vpp.Media)/SUM(DECODE(vpp.Media,cn0,cn0,cn1))) AS Media,
                DECODE(SUM(vpp.Media),cn0,cn0,SUM(vpp.Desvi)/SUM(DECODE(vpp.Media,cn0,cn0,cn1))) AS Desviacion
           FROM (SELECT prom.Qcod    Qcod,
                        prom.Pidm    Pidm,
                        prom.Media   Media,
                        prom.Desvi   Desvi
                   FROM (SELECT SWRSEPR_PIDM                             Pidm,
                                SWRSEPR_QCOD_CODE                        Qcod,
                                SUM(SWRSEPR_CONTESTARON)                 Contestaron,
                                swrsepr_crn                              Crn,
                                DECODE(SUM(SWRSEPR_MEDIA     *SWRSEPR_CONTESTARON),cn0,cn0,SUM(SWRSEPR_MEDIA     *SWRSEPR_CONTESTARON)/SUM(SWRSEPR_CONTESTARON)) Media,
                                DECODE(SUM(SWRSEPR_DESVIACION*SWRSEPR_CONTESTARON),cn0,cn0,SUM(SWRSEPR_DESVIACION*SWRSEPR_CONTESTARON)/SUM(SWRSEPR_CONTESTARON)) Desvi
                           FROM SWRSEPR B
                          WHERE SWRSEPR_TSSC_CODE  = psEncu
                            AND SWRSEPR_TERM_CODE  = psTerm
                            AND SWRSEPR_COLL_CODE  = psColl
                            AND SWRSEPR_CAMP_CODE  = psCamp
                            AND SWRSEPR_TEQA_CODE <> PK_Seprad1.cgsVgc
                            AND SWRSEPR_TEQA_CODE <> PK_Seprad1.cgsVgp
                            AND SWRSEPR_TIPO_CRN  IN (csI,csL)
                            AND (INSTR(csShl||psPtrm,csShl||SWRSEPR_PTRM_CODE||csShl) > cn0 OR psPtrm = csShl OR psPtrm IS NULL)
                            AND cn0 < (SELECT SUM(A.SWRSEPR_MEDIA)
                                         FROM SWRSEPR A
                                        WHERE A.SWRSEPR_CRN        = B.SWRSEPR_CRN
                                          AND A.SWRSEPR_PIDM       = B.SWRSEPR_PIDM
                                          AND A.SWRSEPR_QCOD_CODE  = B.SWRSEPR_QCOD_CODE
                                          AND A.SWRSEPR_TIPO_CRN  IN (csI,csL)
                                          AND A.SWRSEPR_CAMP_CODE  = psCamp
                                          AND A.SWRSEPR_COLL_CODE  = psColl
                                          AND A.SWRSEPR_TSSC_CODE  = psEncu
                                          AND A.SWRSEPR_TERM_CODE  = psTerm
                                      )
                          GROUP BY SWRSEPR_PIDM,
                                   SWRSEPR_QCOD_CODE,
                                   swrsepr_crn
                        ) prom
                   ) VPP
          GROUP BY VPP.Pidm
          ORDER BY Media DESC, Desviacion DESC;

  CURSOR cuCursos(psCamp VARCHAR2,
                  psTerm VARCHAR2,
                  psColl VARCHAR2,
                  psEncu VARCHAR2,
                  pnPidm NUMBER,
                  psPtrm VARCHAR2
                 ) IS
         SELECT COUNT(DISTINCT SWRSEPR_CRN) Grupos
           FROM SWRSEPR
          WHERE SWRSEPR_TSSC_CODE = psEncu
            AND SWRSEPR_TERM_CODE = psTerm
            AND SWRSEPR_COLL_CODE = psColl
            AND SWRSEPR_CAMP_CODE = psCamp
            AND SWRSEPR_PIDM      = pnPidm
            AND (INSTR(csShl||psPtrm,csShl||SWRSEPR_PTRM_CODE||csShl) > cn0 OR psPtrm = csShl OR psPtrm IS NULL)
            AND SWRSEPR_TIPO_CRN IN (csI,csL);

  -- es calculado el percentil
  procedure P_CalculaPercentil(psCamp varchar2,
                               psTerm varchar2,
                               psColl varchar2,
                               psEncu varchar2,
                               psPtrm varchar2 default null) is

  vnMediaI        number  := null;
  vnMediaJ        number  := null;
  vnMediaRepetida integer := 0;
  vnMediaMenor    integer := 0;
  vnCursos        integer := 0;
  vnPercentil     number  := null;
  vnCuartil       integer := null;
  vnLugar         integer := null;
  vnAnteriorLugar integer := null;

  cursor cuPromedio(pnPidm number) is
         select swrsepr_subj_code          Subj,
                swrsepr_crse_numb          Crse,
                swrsepr_title              Titl,
                swrsepr_crn                Crn,
                decode(sum(swrsepr_media),cn0,cn0,sum(swrsepr_media)/sum(decode(swrsepr_media,cn0,cn0,cn1)))      Media,
                decode(sum(swrsepr_media),cn0,cn0,sum(swrsepr_desviacion)/sum(decode(swrsepr_media,cn0,cn0,cn1))) Desvi,
                swrsepr_inscritos     Inscr,
                swrsepr_contestaron   Evalu
           from swrsepr b
          where swrsepr_pidm       = pnPidm
            and swrsepr_term_code  = psTerm
            and swrsepr_tssc_code  = psEncu
            and swrsepr_camp_code  = psCamp
            and swrsepr_coll_code  = psColl
            and (INSTR(csShl||psPtrm,csShl||swrsepr_ptrm_code||csShl) > cn0 OR psPtrm = csShl OR psPtrm IS NULL)
            and swrsepr_teqa_code <> pk_seprad1.cgsVGC
            and swrsepr_teqa_code <> pk_seprad1.cgsVGP
            and swrsepr_tipo_crn  in (csI,csL)
          group by swrsepr_subj_code,
                   swrsepr_crse_numb,
                   swrsepr_title,
                   swrsepr_crn,
                   swrsepr_inscritos,
                   swrsepr_contestaron;

  begin
      for vnI in 1..vgnCantidadMedia loop
          vnMediaRepetida := 0;
          vnMediaMenor    := 0;
          vnPercentil     := 0;
          vnCuartil       := 0;
          vnLugar         := 0;
          vnCursos        := 0;
          vnMediaI        := tabConcent(vnI).rMedia * 100;

          if vnMediaI > 0 then
             for vnJ in 1..vgnCantidadMedia loop
                 vnMediaJ := tabConcent(vnJ).rMedia * 100;

                 -- obtiene la cantidad de veces que se repite una media
                 if (vnMediaJ = vnMediaI) and (vnI <> vnJ) and (vnMediaJ > 0) then
                    vnMediaRepetida := vnMediaRepetida + 1;
                 end if;

                 -- obtiene la cantidad de medias menores
                 if (vnMediaJ < vnMediaI) and (vnI <> vnJ) and (vnMediaJ > 0) then
                    vnMediaMenor := vnMediaMenor + 1;
                 end if;
             end loop;

             vnPercentil := vnMediaMenor + (0.5 * vnMediaRepetida);

             -- es calculado el percentil
             if vnPercentil > 0 then
                vnPercentil := (vnPercentil/(vgnCantidadMedia-vgnMediaCero)) * 100;
             end if;

             -- clculo de el cuartil
             if    vnPercentil between  0 and 24.9 then
                   vnCuartil := 1;
             elsif vnPercentil between 25 and 49.9 then
                   vnCuartil := 2;
             elsif vnPercentil between 50 and 74.9 then
                   vnCuartil := 3;
             elsif vnPercentil between 75 and 100 then
                   vnCuartil := 4;
             end if;

             -- clculo de el lugar de el profesor
             if vnI > 1 then
                if tabConcent(vnI - 1).rMedia = tabConcent(vnI).rMedia then
                   if vnAnteriorLugar is null then
                      vnLugar         := vnI - 1;
                      vnAnteriorLugar := vnLugar;
                   else
                      vnLugar         := vnAnteriorLugar;
                   end if;
                else
                   vnLugar         := vnI;
                   vnAnteriorLugar := null;
                end if;
             else
                vnLugar := vnI;
             end if;

             tabConcent(vnI).rPercentil := vnPercentil;
             tabConcent(vnI).rCuartil   := vnCuartil;
             tabConcent(vnI).rLugar     := vnLugar;
          end if;

          for regPorm in cuPromedio(tabConcent(vnI).rPidm) loop
              vnCursos := vnCursos + 1;

              tabConcent(vnI).tabMaterias(vnCursos).rSubj       := regPorm.Subj;
              tabConcent(vnI).tabMaterias(vnCursos).rCrse       := regPorm.Crse;
              tabConcent(vnI).tabMaterias(vnCursos).rTitle      := regPorm.Titl;
              tabConcent(vnI).tabMaterias(vnCursos).rCrn        := regPorm.Crn;
              tabConcent(vnI).tabMaterias(vnCursos).rMedia      := regPorm.Media;
              tabConcent(vnI).tabMaterias(vnCursos).rDesviacion := regPorm.Desvi;
              tabConcent(vnI).tabMaterias(vnCursos).rInscritos  := regPorm.Inscr;
              tabConcent(vnI).tabMaterias(vnCursos).rEvaluaron  := regPorm.Evalu;
          end loop;

          tabConcent(vnI).rMaterias := vnCursos;

      end loop;

  end P_CalculaPercentil;

  -- presenta el listado del concentrado
  procedure P_TablaConcentrado is

  vnRow     integer := 0;
  vnRowspan integer := 0;

  begin
      htp.p('<table border="1" cellpadding="2" cellspacing="0" width="100%" bordercolor="#ffffff" bgcolor="#ffffff">');

      htp.p('
      <tr bgcolor="#efefef" class="trTabSepara">
          <th width="4%"></th>
          <th width="6%" class="thFont7" valign="bottom">' ||'Profesor'||'</th>
          <th width="6%" class="thFont7" valign="bottom">' ||'RUT'   ||'</th>
          <th width="13%" class="thFont7" valign="bottom">'||'Nombre'||'</th>
          <th width="5%" class="thFont7" valign="bottom">' ||'N&uacute;mero<br/>de Cursos'||'</th>
          <th width="5%" class="thFont7" valign="bottom">' ||'Promedio'||'<br/>'||'Global'||'</th>
          <th width="5%" class="thFont7" valign="bottom">' ||'Desviaci&oacute;n'||'<br/>'||'Global'||'</th>
          <th width="5%" class="thFont7" valign="bottom">' ||'Percentil'||'<br/>'||'Global'||'</th>
          <th width="5%" class="thFont7" valign="bottom">' ||'Cuartil<br/>Global'||'</th>
          <th width="5%" class="thFont7" valign="bottom">' ||'Lugar'||'<br/>'||'Global'||'</th>
          <th width="5%" class="thFont7" valign="bottom">' ||'SUBJ'||'</th>
          <th width="4%" class="thFont7" valign="bottom">' ||'CRSE'||'</th>
          <th width="12%" class="thFont7" valign="bottom">'||'Titulo'||'</th>
          <th width="4%" class="thFont7" valign="bottom">' ||'CRN'||'</th>
          <th width="4%" class="thFont7" valign="bottom">' ||'Promedio'||'<br/>'||'Materia'||'</th>
          <th width="4%" class="thFont7" valign="bottom">' ||'Desviaci&oacute;n'||'<br/>'||'Materia'||'</th>
          <th width="4%" class="thFont7" valign="bottom">' ||'Inscritos'||'</th>
          <th width="4%" class="thFont7" valign="bottom">' ||'Evaluaron'||'</th>
      </tr>');

      for vnI in 1..vgnCantidadMedia loop
          vnRow     := vnRow + 1;
          vnRowspan := tabConcent(vnI).rMaterias;--rCursos;

          htp.p('<tr class="trTabSepara" bordercolor="#efefef">
          <td class="tdFont7" rowspan="'||vnRowspan||'" valign="top" align="right">' ||vnRow                                           ||'</td>
          <td class="tdFont7" rowspan="'||vnRowspan||'" valign="top" align="right">' ||tabConcent(vnI).rId                             ||'</td>
          <td class="tdFont7" rowspan="'||vnRowspan||'" valign="top" align="right">' ||f_get_rut(tabConcent(vnI).rPidm)                ||'</td>
          <td class="tdFont7" rowspan="'||vnRowspan||'" valign="top" align="left">'  ||tabConcent(vnI).rNombre                         ||'</td>
          <td class="tdFont7" rowspan="'||vnRowspan||'" valign="top" align="center">'||vnRowspan                                       ||'</td>
          <td class="tdFont7" rowspan="'||vnRowspan||'" valign="top" align="center">'||TO_CHAR(tabConcent(vnI).rMedia,'90.99')         ||'</td>
          <td class="tdFont7" rowspan="'||vnRowspan||'" valign="top" align="center">'||TO_CHAR(ROUND(tabConcent(vnI).rDesvi,2),'90.99')||'</td>');

          if tabConcent(vnI).rMedia = 0 then
             htp.p('<td class="tdFont7" rowspan="'||vnRowspan||'" valign="top" align="center">-</td>
                    <td class="tdFont7" rowspan="'||vnRowspan||'" valign="top" align="center">-</td>
                    <td class="tdFont7" rowspan="'||vnRowspan||'" valign="top" align="center">-</td>');
          else

                 htp.p('<td class="tdFont7" rowspan="'||vnRowspan||'" valign="top" align="center">'||TO_CHAR(ROUND(tabConcent(vnI).rPercentil,2),'90.99')||'</td>
                    <td class="tdFont7" rowspan="'||vnRowspan||'" valign="top" align="center">'||tabConcent(vnI).rCuartil                            ||'</td>
                    <td class="tdFont7" rowspan="'||vnRowspan||'" valign="top" align="center">'||tabConcent(vnI).rLugar                              ||'</td>');
          end if;

             for vnJ in 1..tabConcent(vnI).rMaterias loop
                 if vnJ > 1 then
                    htp.p('<tr class="trTabSepara" bordercolor="#efefef">');
                 end if;

                 htp.p('
                 <td class="tdFont7" align="center" valign="top">'||tabConcent(vnI).tabMaterias(vnJ).rSubj                                ||'</td>
                 <td class="tdFont7" align="center" valign="top">'||tabConcent(vnI).tabMaterias(vnJ).rCrse                                ||'</td>
                 <td class="tdFont7" valign="top">'||tabConcent(vnI).tabMaterias(vnJ).rTitle                                              ||'</td>
                 <td class="tdFont7" align="center" valign="top">'||tabConcent(vnI).tabMaterias(vnJ).rCrn                                 ||'</td>
                 <td class="tdFont7" align="center" valign="top">'||TO_CHAR(tabConcent(vnI).tabMaterias(vnJ).rMedia,'90.99')     ||'</td>
                 <td class="tdFont7" align="center" valign="top">'||TO_CHAR(ROUND(tabConcent(vnI).tabMaterias(vnJ).rDesviacion,2),'90.99')||'</td>
                 <td class="tdFont7" align="center" valign="top">'||tabConcent(vnI).tabMaterias(vnJ).rInscritos                           ||'</td>
                 <td class="tdFont7" align="center" valign="top">'||tabConcent(vnI).tabMaterias(vnJ).rEvaluaron                           ||'</td>
                 </tr>');

             end loop;

--<td class="tdFont7" align="center" valign="top">'||TO_CHAR(ROUND(tabConcent(vnI).tabMaterias(vnJ).rMedia,2),'90.99')     ||'</td>
      end loop;

      htp.p('</table>');

  end P_TablaConcentrado;


  BEGIN
      -- valida que el usuario pertenezca a la base de datos
      IF psSiu IS NULL THEN
         IF pk_login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;
      ELSE
         IF NOT twbkwbis.F_ValidUser(global_pidm) THEN
            RETURN;
         END IF;
      END IF;

      vsCamp := pk_objHtml.getValueCookie('psSprUn');
      vsEncu := pk_objHtml.getValueCookie('psSeprd');
      vsTerm := pk_objHtml.getValueCookie('psSprTD');
      vsColl := pk_objHtml.getValueCookie('psSprCo');
      vsPtrm := NVL(pk_objHtml.getValueCookie('psPtrmP'),'/');

      FOR regConc IN cuConcentrado(vsCamp, vsTerm, vsColl, vsEncu, vsPtrm) LOOP
          vgnCantidadMedia := vgnCantidadMedia + 1;

          IF regConc.Media = 0 THEN
             vgnMediaCero := vgnMediaCero + 1;
          END IF;

          tabConcent(vgnCantidadMedia).rPidm      := regConc.Pidm;
          tabConcent(vgnCantidadMedia).rId        := regConc.Id;
          tabConcent(vgnCantidadMedia).rNombre    := regConc.Nombre;
          tabConcent(vgnCantidadMedia).rCursos    := regConc.Cursos;
          tabConcent(vgnCantidadMedia).rMedia     := regConc.Media;  --aqui
          tabConcent(vgnCantidadMedia).rDesvi     := regConc.Desviacion;
          tabConcent(vgnCantidadMedia).rPercentil := NULL;
          tabConcent(vgnCantidadMedia).rCuartil   := NULL;
          tabConcent(vgnCantidadMedia).rLugar     := NULL;
          tabConcent(vgnCantidadMedia).rMaterias  := NULL;

          FOR regGrupo IN cuCursos(vsCamp, vsTerm, vsColl, vsEncu, regConc.Pidm, vsPtrm) LOOP
              tabConcent(vgnCantidadMedia).rCursos := regGrupo.Grupos;
          END LOOP;
      END LOOP;

      P_CalculaPercentil(vsCamp, vsTerm, vsColl, vsEncu);

      FOR regPrm IN pk_Seprad1.cuMediaEscuela(vsTerm, vsColl, vsCamp, vsEncu, vsPtrm) LOOP
          IF regPrm.Teqa NOT IN (pk_Seprad1.cgsVgp, pk_Seprad1.cgsVgc) THEN
             vnMedia      := vnMedia      + regPrm.Media;
             vnDesviacion := vnDesviacion + regPrm.Desvi;
          END IF;
      END LOOP;

      IF vnMedia > 0 THEN
         vnMedia := vnMedia/16;
      END IF;

      IF vnDesviacion > 0 THEN
         vnDesviacion := vnDesviacion/16;
      END IF;

      htp.p('<html><head><title>'||psReclDesc||'</title>');

      -- la aplicacin no se guarda en el cache de la mquina
      PK_ObjHTML.P_NoCache;

      -- cdigo css
      PK_ObjHTML.P_CssTabs;

      htp.p('<script language="JavaScript"><!--');
      htp.p('function fImprimeReporte() {
      window.focus()
      print();
      }');
      htp.p('//--></script>');

      htp.p('</head><body bgcolor="#ffffff" class="bodyCeroR"><br/>');
      htp.p('<script language="javascript" src="kwacnls.js"></script><br/>');
      htp.p('<table border="0" cellpadding="2" cellspacing="1" bordercolor="#ffffff" bgcolor="#ffffff" width="100%">
      <tr class="trTabSepara">
          <td rowspan="4" width="10%" valign="top"><img src="/imagenes/logo_uft.jpg'||'" width="80" border="0"></td>
          <td colspan="2" align="left" valign="top" class="tdTitulo"><b>'||REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(psReclDesc,'~aacute','&aacute'),'~eacute','&eacute'),'~iacute','&iacute'),'~oacute','&oacute'),'~uacute','&uacute')||':</b>&nbsp;'||pk_Seprad1.F_CollDesc(vsColl)||'</td>
          </tr>
      <tr class="trTabSepara"><td valign="top" width="70%">'||vsTerm||' '||PK_Seprad1.F_TermDesc(vsTerm)||'</td>
                              <td valign="top" width="30%" align="right">'||pk_Seprad1.F_Fecha||'</td></tr>
      <tr class="trTabSepara"><td colspan="2">'||pK_Seprad1.F_PtrmCodeDesc(vsTerm,
                                                                           psColl=>vsColl,
                                                                           psCamp=>vsCamp,
                                                                           psPtrm=>vsPtrm,
                                                                           psEncs=>vsEncu )
                                                               ||'</td></tr>
      <tr class="trTabSepara"><td colspan="2"></td></tr>
      </table><br/>

      <table border="1" cellpadding="2" cellspacing="0" bordercolor="#ffffff" bgcolor="#ffffff" width="40%">
             <tr class="trTabSepara" bgcolor="#efefef">
                 <th class="thFont7" valign="bottom" width="20%">Promedio de la Escuela o Facultad</th>
                 <th class="thFont7" valign="bottom" width="20%">Desviaci&oacute;n de la Escuela o Facultad</th></tr>
             <tr class="trTabSepara" bordercolor="#efefef">
                 <td class="tdFont7" align="center" valign="top">'||TO_CHAR(ROUND(vnMedia,2),'90D99')     ||'</td>
                 <td class="tdFont7" align="center" valign="top">'||TO_CHAR(ROUND(vnDesviacion,2),'90G99')||'</td></tr>
      </table><br/>
      ');

      P_TablaConcentrado;

      htp.p('<br/></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           htp.p(SQLERRM);
  END PWRCRED;
/


DROP PUBLIC SYNONYM PWRCRED;

CREATE PUBLIC SYNONYM PWRCRED FOR BANINST1.PWRCRED;


GRANT EXECUTE ON BANINST1.PWRCRED TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCRED TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCRGM;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCRGM (
	psReclDesc			VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:		PWRCRGM
OBJETIVO:			Reporte de Carga de Archivos de Matricula a Detalle
PARAMETROS:
psReclDesc			Variable estandar para la maquina de reportes custom
AUTOR:				Gilberto Velazquez Hernandez
FECHA:				20120711
******************************************************************************/

	--Numero de renglones
	vnRow				PLS_INTEGER := 0;
	--Bandera para mostrar si hubo datos
	vnExists			INTEGER := 0;
	--Numero de columnas
	vnColumnas			INTEGER := 4;
	--Numero de registros
	vnRegs				INTEGER := 0;
	--Arreglo (nested table) donde se guardan los encabezados de las columnas
	tabColumna			Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
	-- la variable es una bandera que al tener el valor "imprime" no colocara
	--el salto de pgina para impresion
	vsInicoPag			VARCHAR2(10) := NULL;
	--Nmero de renglones por pgina
	vnRegsPag			PLS_INTEGER := 4000;


	--Filtro de numero de carga
	vnNumProc			NUMBER;
	--Filtro de tipo de dato
	vsTipo				VARCHAR2(1);
	--Filtro de tipo de carga
	vsTcgm				VARCHAR2(4);

	CURSOR cuReporte(
		pnNumProc		NUMBER
		,psTipo			VARCHAR2
		,psTipoCrg		VARCHAR2
	) IS
		SELECT
			TWRAACP_RECORD_NUM					AS NumLinea
			,TWRAACP_RECORD						AS Contenido
			,TWRAACP_RESULT						AS Resultado
			,TWRAACP_MSG						AS Mensaje
		FROM
			TWRAACP
		WHERE
			TWRAACP_FILE_TYPE = psTipoCrg
			AND TWRAACP_FILE_NUM = pnNumProc
			AND (
				psTipo = 'T'
				OR (psTipo = 'N' AND TWRAACP_RESULT IN ('W','R','E') )
				OR (TWRAACP_RESULT = psTipo)
			)
		ORDER BY
			TWRAACP_RECORD_NUM;

BEGIN


	--Seguridad de GWAMNUR
	IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

	--Obtengo el numero de proceso
	vnNumProc := pk_objHtml.getValueCookie('psNum');
	--Obtengo el tipo de registro
	vsTipo := pk_objHtml.getValueCookie('psRgRes');
	--Obtengo el tipo de carga/archivo
	vsTcgm := pk_objHtml.getValueCookie('psTcgm');

	-- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
	tabColumna.EXTEND(vnColumnas);

	--Guardamos los encabezados en el arreglo de columnas
	tabColumna( 1) := '#';
	tabColumna( 2) := 'Contenido';
	tabColumna( 3) := 'Resultado';
	tabColumna( 4) := 'Comentario';

	--Inicializamos contador de renglones
	vnRow := 0;

	FOR regReporte IN cuReporte(vnNumProc,vsTipo,vsTcgm) LOOP

		--Incremento el contador de renglones
		vnRow := vnRow + 1;
		vnExists := 1; --Bandera para indicar que hubo resultados

		--Si es el primer renglon de cada pgina...
		IF MOD(vnRow, vnRegsPag) = 1  THEN
			--imprimo el encabezado de reporte
			Pk_Sisrepimp.P_EncabezadoDeReporte(
				psReclDesc ,vnColumnas ,tabColumna
				,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
			);
			vsInicoPag := 'SALTO';
		END IF;

		--Comienzo a desplegar el renglon
		HTP.P('<tr>');
		HTP.P('<td>'||regReporte.NumLinea||'</td>');
		HTP.P('<td>'||regReporte.Contenido||'</td>');
		HTP.P('<td>'||regReporte.Resultado||'</td>');
		HTP.P('<td>'||regReporte.Mensaje||'</td>');
		--Fin del renglon
		HTP.P('</tr>');

	END LOOP;

	IF vnExists = 0 THEN
		--Ojo esta linea lo que hace es imprimir
		--NO SE ENCONTRARON DATOS o un mensaje similar
		htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
	ELSE

		-- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
		Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

		-- es omitido el encabezado del reporte pero se agrega el salto de pagina
		Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
	END IF;

	--Fin de la pagina
	htp.p('</table><br/></body></html>');
EXCEPTION
	WHEN OTHERS THEN
		--pantallazo de error.
		pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
			'PWRCRGM', NULL);
END PWRCRGM;
/


DROP PUBLIC SYNONYM PWRCRGM;

CREATE PUBLIC SYNONYM PWRCRGM FOR BANINST1.PWRCRGM;


GRANT EXECUTE ON BANINST1.PWRCRGM TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRCRGM TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRCRGM TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRCRGM TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCRMD;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCRMD (
	psReclDesc			VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:		PWRCRMD
OBJETIVO:			Reporte de Carga de Archivos de CRM a Nivel Detalle
PARAMETROS:
psReclDesc			Variable estandar para la maquina de reportes custom
AUTOR:				Gilberto Velazquez Hernandez
FECHA:				20120613
******************************************************************************/

	--Numero de renglones
	vnRow				PLS_INTEGER := 0;
	--Bandera para mostrar si hubo datos
	vnExists			INTEGER := 0;
	--Numero de columnas
	vnColumnas			INTEGER := 4;
	--Numero de registros
	vnRegs				INTEGER := 0;
	--Arreglo (nested table) donde se guardan los encabezados de las columnas
	tabColumna			Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
	-- la variable es una bandera que al tener el valor "imprime" no colocara
	--el salto de pgina para impresion
	vsInicoPag			VARCHAR2(10) := NULL;
	--Nmero de renglones por pgina
	vnRegsPag			PLS_INTEGER := 4000;

	--Filtro de numero de carga
	vnNumProc			NUMBER;
	--Filtro de tipo de dato
	vsTipo				VARCHAR2(1);

	CURSOR cuReporte(
		pnNumProc		NUMBER
		,psTipo			VARCHAR2
	) IS
		SELECT
			SWRRCRM_NUM_LINEA						AS NumLinea
			,SWRRCRM_CONTENIDO						AS Contenido
			,SWRRCRM_RESULTADO						AS Resultado
			,SWRRCRM_MENSAJE						AS Mensaje
		FROM
			SWRRCRM
		WHERE
			SWRRCRM_NUM_PROCESO = pnNumProc
			AND (
				psTipo = 'T'
				OR (psTipo = 'N' AND SWRRCRM_RESULTADO IN ('W','R','E') )
			  	OR (SWRRCRM_RESULTADO = psTipo)
			)
		ORDER BY
			SWRRCRM_NUM_LINEA;

BEGIN


	--Seguridad de GWAMNUR
	IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

	--Obtengo el numero de proceso
	vnNumProc := pk_objHtml.getValueCookie('psNum');
	--Obtengo el tipo de registro
	vsTipo := pk_objHtml.getValueCookie('psRgRes');

	-- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
	tabColumna.EXTEND(vnColumnas);

	--Guardamos los encabezados en el arreglo de columnas
	tabColumna( 1) := '#';
	tabColumna( 2) := 'Contenido';
	tabColumna( 3) := 'Resultado';
	tabColumna( 4) := 'Comentario';

	--Inicializamos contador de renglones
	vnRow := 0;

	FOR regReporte IN cuReporte(vnNumProc,vsTipo) LOOP

		--Incremento el contador de renglones
		vnRow := vnRow + 1;
		vnExists := 1; --Bandera para indicar que hubo resultados

		--Si es el primer renglon de cada pgina...
		IF MOD(vnRow, vnRegsPag) = 1  THEN
			--imprimo el encabezado de reporte
			Pk_Sisrepimp.P_EncabezadoDeReporte(
				psReclDesc ,vnColumnas ,tabColumna
				,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
			);
			vsInicoPag := 'SALTO';
		END IF;

		--Comienzo a desplegar el renglon
		HTP.P('<tr>');
		HTP.P('<td>'||regReporte.NumLinea||'</td>');
		HTP.P('<td>'||regReporte.Contenido||'</td>');
		HTP.P('<td>'||regReporte.Resultado||'</td>');
		HTP.P('<td>'||regReporte.Mensaje||'</td>');
		--Fin del renglon
		HTP.P('</tr>');

	END LOOP;

	IF vnExists = 0 THEN
		--Ojo esta linea lo que hace es imprimir
		--NO SE ENCONTRARON DATOS o un mensaje similar
		htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
	ELSE

		-- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
		Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

		-- es omitido el encabezado del reporte pero se agrega el salto de pagina
		Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
	END IF;

	--Fin de la pagina
	htp.p('</table><br/></body></html>');
EXCEPTION
	WHEN OTHERS THEN
		--pantallazo de error.
		pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
			'PWRCRMD', NULL);
END PWRCRMD;
/


DROP PUBLIC SYNONYM PWRCRMD;

CREATE PUBLIC SYNONYM PWRCRMD FOR BANINST1.PWRCRMD;


GRANT EXECUTE ON BANINST1.PWRCRMD TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRCRMD TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRCRMD TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRCRMD TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCRMG;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCRMG (
	psReclDesc			VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:		PWRCRMG
OBJETIVO:			Reporte Global de Carga de Archivos de CRM
PARAMETROS:
psReclDesc			Variable estandar para la maquina de reportes custom
AUTOR:				Gilberto Velazquez Hernandez
FECHA:				20120606
******************************************************************************/

	--Numero de renglones
	vnRow				PLS_INTEGER := 0;
	--Bandera para mostrar si hubo datos
	vnExists			INTEGER := 0;
	--Numero de columnas
	vnColumnas			INTEGER := 8;
	--Numero de registros
	vnRegs				INTEGER := 0;
	--Arreglo (nested table) donde se guardan los encabezados de las columnas
	tabColumna			Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
	-- la variable es una bandera que al tener el valor "imprime" no colocara
	--el salto de pgina para impresion
	vsInicoPag			VARCHAR2(10) := NULL;
	--Nmero de renglones por pgina
	vnRegsPag			PLS_INTEGER := 100;

	--Filtro de Fecha
	vdFecha				DATE;

	CURSOR cuReporte(
		pdFecha			DATE
	) IS
		SELECT
			GWBAACR_NOMBRE_ARCHIVO								AS NomArch
			,GWBAACR_TAMANO										AS Tamano
			,GWBAACR_NUM_REGISTROS								AS NumReg
			,GWBAACR_NUM_PROCESO								AS NumProc
			,GWBAACR_ACTIVITY_DATE								AS Fecha
			,GWBAACR_USER										AS Usuario
			,(SELECT
				COUNT(*)
			FROM
				SWRRCRM
			WHERE
				SWRRCRM_NUM_PROCESO = GWBAACR_NUM_PROCESO
				AND SWRRCRM_RESULTADO = 'A'
			)													AS NumOk
			,(SELECT
				COUNT(*)
			FROM
				SWRRCRM
			WHERE
				SWRRCRM_NUM_PROCESO = GWBAACR_NUM_PROCESO
				AND SWRRCRM_RESULTADO <> 'A'
			)													AS NumErr
		FROM
			GWBAACR
		WHERE
			GWBAACR_TIPO = 'CRM'
			AND (pdFecha IS NULL OR (GWBAACR_ACTIVITY_DATE>=pdFecha AND
				GWBAACR_ACTIVITY_DATE < pdFecha+1)
			)
		ORDER BY
			GWBAACR_ACTIVITY_DATE;

BEGIN

	--Seguridad de GWAMNUR
	IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

	--Obtengo la fecha del reporte
	vdFecha := TO_DATE(pk_objHtml.getValueCookie('psFecha'),'DD/MM/YYYY');

	-- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
	tabColumna.EXTEND(vnColumnas);

	--Guardamos los encabezados en el arreglo de columnas
	tabColumna( 1) := 'Archivo';
	tabColumna( 2) := 'Tamao';
	tabColumna( 3) := 'Num. Registros';
	tabColumna( 4) := 'Fecha';
	tabColumna( 5) := 'Num. Proceso';
	tabColumna( 6) := 'Usuario';
	tabColumna( 7) := 'Cargados';
	tabColumna( 8) := 'No Cargados';

	--Inicializamos contador de renglones
	vnRow := 0;

	FOR regReporte IN cuReporte(vdFecha) LOOP

		--Incremento el contador de renglones
		vnRow := vnRow + 1;
		vnExists := 1; --Bandera para indicar que hubo resultados

		--Si es el primer renglon de cada pgina...
		IF MOD(vnRow, vnRegsPag) = 1  THEN
			--imprimo el encabezado de reporte
			Pk_Sisrepimp.P_EncabezadoDeReporte(
				psReclDesc ,vnColumnas ,tabColumna
				,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
			);
			vsInicoPag := 'SALTO';
		END IF;

		--Comienzo a desplegar el renglon
		HTP.P('<tr>');
		HTP.P('<td>'||regReporte.NomArch||'</td>');
		HTP.P('<td>'||regReporte.Tamano||'</td>');
		HTP.P('<td>'||regReporte.NumReg||'</td>');
		HTP.P('<td>'||TO_CHAR(regReporte.Fecha, 'DD/MM/YYYY HH:MI:SS')||'</td>');
		HTP.P('<td>'||regReporte.NumProc||'</td>');
		HTP.P('<td>'||regReporte.Usuario||'</td>');
		HTP.P('<td>'||regReporte.NumOk ||'</td>');
		HTP.P('<td>'||regReporte.NumErr ||'</td>');
		--Fin del renglon
		HTP.P('</tr>');

	END LOOP;

	IF vnExists = 0 THEN
		--Ojo esta linea lo que hace es imprimir
		--NO SE ENCONTRARON DATOS o un mensaje similar
		htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
	ELSE

		-- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
		Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

		-- es omitido el encabezado del reporte pero se agrega el salto de pagina
		Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
	END IF;

	--Fin de la pagina
	htp.p('</table><br/></body></html>');
EXCEPTION
	WHEN OTHERS THEN
		--pantallazo de error.
		pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
			'PWRCRMG', NULL);
END PWRCRMG;
/


DROP PUBLIC SYNONYM PWRCRMG;

CREATE PUBLIC SYNONYM PWRCRMG FOR BANINST1.PWRCRMG;


GRANT EXECUTE ON BANINST1.PWRCRMG TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRCRMG TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRCRMG TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRCRMG TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRCTSF;

CREATE OR REPLACE PROCEDURE BANINST1.PWRCTSF(psReclDesc VARCHAR2) IS
/*
         Tarea: Obtener un listado de las caractersticas de los salones por edificio
         Fecha: 14/05/2007.
         Autor: RMR

  Modificacin: 08/10/2008
                GEPC
                El parametro de periodo se actualizo como no obligatorio.


*/

ckNombres   owa_cookie.vc_arr;
ckValores   owa_cookie.vc_arr;
ckCount     INTEGER;
vgsInicoPag VARCHAR2(10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
vgsUSR      VARCHAR2(500);

  vnColumnas INTEGER                        := 8;
  vnExists   INTEGER                        := 0;
  vsTerm     STVTERM.STVTERM_CODE%TYPE      := NULL;
  vsEscu     STVCOLL.STVCOLL_CODE%TYPE      := NULL;
  vsUniv     VARCHAR2(5)                    := NULL;
  vsEdif     SLBRDEF.SLBRDEF_BLDG_CODE%TYPE := NULL;
  vsSeccion  VARCHAR2(3)                    := NULL;
  tabColumna Pk_Sisrepimp.tipoTabla         := Pk_Sisrepimp.tipoTabla(1);

  CURSOR cuComentarios(
                       psTerm VARCHAR2,
                       psEscu VARCHAR2,
                       psEdif VARCHAR2) IS
         SELECT SLBRDEF_TERM_CODE_EFF                  Term,
                STVBLDG_DESC                           Edif,
                SLBRDEF_ROOM_NUMBER                    Room,
                SLBRDEF_DESC                           Descripcion,
                SLBRDEF_CAPACITY                       CapMin,
                SLBRDEF_MAXIMUM_CAPACITY               CapMax,
                PK_CATALOGO.Colegio(SLBRDEF_COLL_CODE) CollDesc,
                STVRMST_DESC                           StatDesc
           FROM SLBRDEF A,
                STVRMST,
                STVBLDG
          WHERE (SLBRDEF_BLDG_CODE     = psEdif OR psEdif IS NULL)
            AND (SLBRDEF_TERM_CODE_EFF = psTerm OR psTerm IS NULL)
            AND (SLBRDEF_COLL_CODE     = psEscu OR psEscu IS NULL)
            AND SLBRDEF_RMST_CODE      = STVRMST_CODE(+)
            AND SLBRDEF_BLDG_CODE      = STVBLDG_CODE
--            AND SLBRDEF_TERM_CODE_EFF  = (SELECT MAX(B.SLBRDEF_TERM_CODE_EFF)
--                                            FROM SLBRDEF B
--                                           WHERE B.SLBRDEF_BLDG_CODE   = A.SLBRDEF_BLDG_CODE
--                                             AND B.SLBRDEF_ROOM_NUMBER = A.SLBRDEF_ROOM_NUMBER
--                                             AND B.SLBRDEF_VPDI_CODE   = A.SLBRDEF_VPDI_CODE
--                                         )
          ORDER BY  SLBRDEF_TERM_CODE_EFF, SLBRDEF_BLDG_CODE, SLBRDEF_ROOM_NUMBER;

  BEGIN
      /* Check/update the user's web session */
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
         FOR vnCOKIES IN 1..ckCount LOOP
             IF ckNOMBRES(vnCOKIES) = 'psPerio' THEN
                   vsTerm := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psEscu' THEN
                   vsEscu := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psEdifi' THEN
                   vsEdif := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                   vsSeccion := ckValores(vnCOKIES);
             END IF;

         END LOOP;
      END IF;

      -- Las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1) := 'Periodo';
      tabColumna(2) := 'Edificio';
      tabColumna(3) := 'Sal&oacute;n';
      tabColumna(4) := 'Descripci&oacute;n';
      tabColumna(5) := 'Capacidad';
      tabColumna(6) := 'Capacidad m&aacute;xima';
      tabColumna(7) := 'Escuela que administra';
      tabColumna(8) := 'Status';

      FOR regBldg IN cuComentarios(vsTerm, vsEscu , vsEdif) LOOP
          IF vnExists = 0  THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,vgsInicoPag,'1', psSubtitulo=>'Periodo '||regBldg.Term, psUsuario=>vgsUSR, psSeccion=>vsSeccion, psSinLogo=>'sin');
             vgsInicoPag := 'SALTO';

          END IF;

          htp.p('<tr>
          <td valign="top">'||regBldg.Term       ||'</td>
          <td valign="top">'||regBldg.Edif       ||'</td>
          <td valign="top">'||regBldg.Room       ||'</td>
          <td valign="top">'||regBldg.Descripcion||'</td>
          <td valign="top">'||regBldg.CapMin     ||'</td>
          <td valign="top">'||regBldg.CapMax     ||'</td>
          <td valign="top">'||regBldg.CollDesc   ||'</td>
          <td valign="top">'||regBldg.StatDesc   ||'</td>
          </tr>');

          vnExists := vnExists + 1;
      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
         NULL;
--         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
--         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

--         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
--         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>vgsUSR, psSeccion=>vsSeccion);
      END IF;

      htp.p('</table><br></body></html>');

 END PWRCTSF;
/


DROP PUBLIC SYNONYM PWRCTSF;

CREATE PUBLIC SYNONYM PWRCTSF FOR BANINST1.PWRCTSF;


GRANT EXECUTE ON BANINST1.PWRCTSF TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRCTSF TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRDCAT;

CREATE OR REPLACE PROCEDURE BANINST1.PWRDCAT(psReclDesc VARCHAR2) IS

/**************************************************************
           tarea:  paquete para el reporte de alumnos
         mdulo:  registro estudiantil
           autor:  horacio martnez ramrez - hmr
           fecha:  14/sep/2010
**************************************************************/

  vgsInicoPag   VARCHAR2(10)                      := NULL;   -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vnRow         INTEGER                                := 0;
  vnExists      INTEGER                                 := 0;
  vnColumnas    INTEGER                               := 13;
  tabColumna    Pk_Sisrepimp.tipoTabla             := Pk_Sisrepimp.tipoTabla(1);
  vsPerio       SIBINST.SIBINST_TERM_CODE_EFF%TYPE := NULL;
  vsUniv        VARCHAR2(20)                       := NULL;
  vsSstst       STVSTST.STVSTST_CODE%TYPE          := NULL;
  vsProgr       SMRPRLE.SMRPRLE_PROGRAM_DESC%TYPE  := NULL;
  vsPrepa       STVSBGI.STVSBGI_DESC%TYPE          := NULL;
  vsSeccion     VARCHAR2(3)                          := NULL;
  vsTermCode    VARCHAR2(6)                        := NULL;
  vsCampCode    VARCHAR2(6)                        := NULL;
  vsAcadstan    STVASTD.STVASTD_DESC%TYPE     := NULL;
  vsEstandar    STVASTD.STVASTD_DESC%TYPE      := NULL;
  vbEnca        BOOLEAN                            := TRUE;
  vsEnca        VARCHAR2(500)                       := NULL;
  vsID          VARCHAR2(10)                       := NULL;
  vsRut         VARCHAR2(15)                       := NULL;
  vsExpediente  VARCHAR2(10)                    := NULL;
  vsNombre      VARCHAR2(100)                   := NULL;
  vsSatus       VARCHAR2(10)                      := NULL;
  vsDescProg    VARCHAR2(100)                   := NULL;
  vsDescTipoAd  VARCHAR2(100)                  := NULL;
  vsPeriodoAnt  VARCHAR2(10)                     := NULL;

  CURSOR cuReporte(psPerio VARCHAR2 DEFAULT NULL,
                            psUniv  VARCHAR2 DEFAULT NULL,
                            psProgr VARCHAR2 DEFAULT NULL ) IS
        SELECT NVL(A.SGBSTDN_CAMP_CODE,'SIN CVE')                          campCode,
               SFBETRM_TERM_CODE                                           termCode,
               A.SGBSTDN_PIDM                                              PIDM,
               SPRIDEN_ID                                                  Id,
               SPBPERS_NAME_SUFFIX                                   Rut,
               REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME,'*',' ') ALUMNO,
               Pk_Catalogo.STASTST(A.SGBSTDN_STST_CODE)                    STATUS,
               SGBSTDN_PROGRAM_1                                           CVEPROGRAMA,
               Pk_Catalogo.PROGRAMA(A.SGBSTDN_PROGRAM_1)                   DESCPROGRAMA,
               SGBSTDN_ADMT_CODE                                           TIPOADMISION,
               SGBSTDN_RATE_CODE                                           Site,
               Pk_Catalogo.ADMISION(A.SGBSTDN_ADMT_CODE)                   DESCTIPOADMISION,
               Pk_Catalogo.NOMBRE(SGRADVR.PIDM_ASESOR)                     ASESOR,
               SGBUSER.ULTPER                                              ULTPER,
               SGBUSER.INGLES                                              INGLES,
               SGBUSER.MATERIAS                                            MATERIAS
          FROM SGBSTDN A,
               (SELECT SGBUSER_PIDM       PIDM,
                       SGBUSER_SUDA_CODE  ULTPER,
                       SGBUSER_SUDB_CODE  INGLES,
                       SGBUSER_SUDC_CODE  MATERIAS
                  FROM SGBUSER
                 WHERE SGBUSER_TERM_CODE  = psPerio) SGBUSER,
               (SELECT SGRADVR_TERM_CODE_EFF   PERIODO,
                       SGRADVR_PIDM            PIDM,
                       SGRADVR_ADVR_PIDM       PIDM_ASESOR,
                       SGRADVR_ADVR_CODE       ASESOR
                  FROM SGRADVR
                 WHERE SGRADVR_TERM_CODE_EFF  = (SELECT MAX(SG.SGRADVR_TERM_CODE_EFF)
                                                   FROM SGRADVR SG
                                                  WHERE SG.SGRADVR_PIDM = SGRADVR_PIDM
                                                )
               ) SGRADVR,
               SPRIDEN,
               SFBETRM,
               SPBPERS
         WHERE A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                            FROM SGBSTDN B
                                           WHERE B.SGBSTDN_PIDM           = A.SGBSTDN_PIDM
                                             AND B.SGBSTDN_TERM_CODE_EFF <= SFBETRM_TERM_CODE
                                         )
           AND A.SGBSTDN_STST_CODE     = 'AS'
           AND A.SGBSTDN_PIDM          = SGBUSER.PIDM(+)
           AND A.SGBSTDN_PIDM          = SGRADVR.PIDM(+)
           AND A.SGBSTDN_PIDM          = SPRIDEN_PIDM
           AND A.SGBSTDN_PIDM          = SPBPERS_PIDM(+)
           AND SPRIDEN_CHANGE_IND     IS NULL
           AND A.SGBSTDN_PIDM          = SFBETRM_PIDM
           AND SFBETRM_ESTS_CODE       = 'EL'
           AND EXISTS (SELECT NULL
                         FROM SFRSTCR
                        WHERE SFRSTCR_TERM_CODE  = SFBETRM_TERM_CODE
                          AND SFRSTCR_PIDM       = SFBETRM_PIDM
                          AND SFRSTCR_RSTS_CODE IN ('RE','RW')
                      )
           AND (A.SGBSTDN_CAMP_CODE = psUniv  OR psUniv  IS NULL)
           AND (A.SGBSTDN_PROGRAM_1 = psProgr OR psProgr IS NULL)
           AND (SFBETRM_TERM_CODE   = psPerio OR psPerio IS NULL)
         ORDER BY campCode, termCode DESC, CVEPROGRAMA, ALUMNO;

  -- obtiene los atributos del alumno
  CURSOR cuAtributos(psPerio  VARCHAR2,
                     psPidm   VARCHAR2) IS
         SELECT SGRSATT_ATTS_CODE                       CVEATRIBUTO,
                Pk_Catalogo.ProgEspe(SGRSATT_ATTS_CODE) DESCATRIBUTO
           FROM SGRSATT
          WHERE SGRSATT_TERM_CODE_EFF = psPerio
            AND SGRSATT_PIDM    = psPidm;

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(Pk_Login.vgsUSR) THEN RETURN; END IF;

      -- son buscadas los valores de las cookies para asignar los valores del filtro del query.
      vsPerio   := pk_objHTML.getValueCookie('psPerio');
      vsUniv    := pk_objHTML.getValueCookie('psUnive');
      vsProgr   := pk_objHTML.getValueCookie('psProgr');
      vsSeccion := pk_objHTML.getValueCookie('cookSeccion');
      vsEnca    := pk_objHTML.getValueCookie('psEnca');
--      vsrate    := pk_objhtml.getvaluecookie('psrate');

      -- las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := 'Id';
      tabColumna(2)  := 'Rut';
      tabColumna(3)  := 'Nombre';
      tabColumna(4)  := 'Status';
      tabColumna(5)  := 'Programa';
      tabColumna(6)  := 'Tipo de admisi&oacute;n';
      tabColumna(7)  := 'Atributos';
      tabColumna(8)  := 'Asesor acad&eacute;mico';
      tabColumna(9)  := 'Periodo';
      tabColumna(10) := 'Nivel de ingl&eacute;s';
      tabColumna(11) := 'Materias reprobadas';
      tabColumna(12) := 'Est&aacute;ndar acad&eacute;mico';
      tabColumna(13) := 'Sobrepaso Est&aacute;ndar acad&eacute;mico';

      FOR regRep IN cuReporte(vsPerio, vsUniv, vsProgr) LOOP

         IF (vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
             vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR vnRow = 25) AND vbEnca THEN

            Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vgsInicoPag,'1',psSubtitulo=>'Periodo '||regRep.termCode||'<br/>'||pk_Catalogo.fStvSite(regRep.SITE),psUsuario=>Pk_Login.vgsUSR,psSeccion=>vsSeccion,psUniversidad=>regRep.campCode);
            vgsInicoPag := 'SALTO';

            vnRow  := 0;
         END IF;

         IF vsEnca = 'N' THEN
             vbEnca := FALSE;
         END IF;

         -- query para determinar el perido anterior semestral
         SELECT (CASE
                       WHEN SUBSTR(regRep.termCode,5,2) = '10' THEN
                                SUBSTR(regRep.termCode,1,3)||to_char(to_number(SUBSTR(regRep.termCode,4,1) -1))||'60'
                       WHEN SUBSTR(regRep.termCode,5,2) = '60' THEN
                                SUBSTR(regRep.termCode,1,4)||'10'
                      END)
         INTO vsPeriodoAnt
         FROM DUAL;

         vsExpediente := regRep.ID;
         vsRut           := regRep.Rut;
         vsNombre     := regRep.Alumno;
         vsSatus       := regRep.Status;
         vsDescProg   := regRep.DescPrograma;
         vsDescTipoAd := regRep.DescTipoAdmision;

         IF vsID = regRep.ID THEN
             vsRut           := NULL;
             vsExpediente := NULL;
             vsNombre     := NULL;
             vsSatus      := NULL;
             vsDescProg   := NULL;
             vsDescTipoAd := NULL;
         END IF;

         htp.p('<tr><td valign="top">'||vsExpediente||'</td>
                        <td valign="top">'||vsRut          ||'</td>
                        <td valign="top">'||vsNombre     ||'</td>
                        <td valign="top">'||vsSatus       ||'</td>
                        <td valign="top">'||vsDescProg   ||'</td>
                        <td valign="top">'||vsDescTipoAd||'</td>
                        <td valign="top">');

         -- atributos
         FOR regAtr IN cuAtributos (regRep.termCode, regRep.pidm) loop
               htp.p(regAtr.DescAtributo ||'<BR>');
         END LOOP;

         htp.p('</td><td valign="top">'||regRep.Asesor  ||'</td>
                          <td valign="top">'||regRep.Ultper  ||'</td>
                          <td valign="top">'||regRep.Ingles  ||'</td>
                          <td valign="top">'||regRep.Materias||'</td>');

         -- estado acadmico
         vsEstandar := F_EstandarAdemico(regRep.Pidm, vsPeriodoAnt);

         -- sobrepaso estado acadmico
         vsAcadstan := F_SobrepasoEstandarAdemico(regRep.Pidm, regRep.termCode);

         htp.p('<td valign="top">'||vsEstandar||'</td>
                  <td valign="top">'||vsAcadstan||'</td></tr>');

         vnExists     := 1;
         vnRow        := vnRow + 1;
         vsEstandar   := NULL;
         vsAcadstan   := NULL;
         vsPeriodoAnt := NULL;
         vsCampCode   := regRep.campCode;
         vsTermCode   := regRep.termCode;
         vsID         := regRep.ID;
      END LOOP;

      IF vnExists = 0 THEN
          htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>Pk_Login.vgsUSR, psSeccion=>vsSeccion);
      END IF;

      htp.p('</table></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           HTP.P(SQLERRM);

  END PWRDCAT;
/


DROP PUBLIC SYNONYM PWRDCAT;

CREATE PUBLIC SYNONYM PWRDCAT FOR BANINST1.PWRDCAT;


GRANT EXECUTE ON BANINST1.PWRDCAT TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRDCAT TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRDEHO;

CREATE OR REPLACE PROCEDURE BANINST1.PWRDEHO(psReclDesc VARCHAR2) IS
/*
         Tarea: REPORTE: docentes con empalmes de horario
         Fecha: 19/01/2006.
         Autor: GEPC

  Modificacin: 13/10/2008
                GEPC
                * Agregar la columna "Parte de periodo", despus de la columna "Nombre materia"

*/

ckNombres   owa_cookie.vc_arr;
ckValores   owa_cookie.vc_arr;
ckCount     INTEGER;
vgsInicoPag VARCHAR2(10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
vgsUSR      VARCHAR2(500);

  vnExists   INTEGER                := 0;
  vnColumnas INTEGER                := 22;
  tabColumna Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vsPerio    VARCHAR2(100)          := NULL;
  vsFacu     VARCHAR2(100)          := NULL;

  vsSeccion  VARCHAR2(3)            := NULL;

  CURSOR cuReporte(psTerm  VARCHAR2 DEFAULT NULL,
                   psFacu  VARCHAR2 DEFAULT NULL) IS
         SELECT DISTINCT SSB.SSBSECT_TERM_CODE                      termCode,
                NVL(SSBSECT_CAMP_CODE,'S/Univ')                     campCode,
                Pk_Catalogo.COLEGIO(SCBCRSE_COLL_CODE)              ESCUELA,
                Pk_Catalogo.COLEGIO(ESCUELA.ESC_SEDE)               ESCUELA_SEDE,
                PROFESOR.ID                                         ID,
                PROFESOR.PIDM                                       PIDM,
                PROFESOR.NOMBRE                                     DOCENTE,
                SSBSECT_CRN                                         NRC,
                SCBCRSE_SUBJ_CODE                                   SUBJ,
                SCBCRSE_CRSE_NUMB                                   CURSO,
                SCBCRSE_TITLE                                       Title,
                SSBSECT_PTRM_CODE||' '||
                TO_CHAR(SSBSECT_PTRM_START_DATE,'DD/MM/YYYY')||'-'||
                TO_CHAR(SSBSECT_PTRM_END_DATE,  'DD/MM/YYYY')||
                SSBSECT_PTRM_WEEKS       Ptrm,
                DECODE(SSRMEET_MON_DAY, 'M', 'Lu', SSRMEET_MON_DAY) LU,
                DECODE(SSRMEET_TUE_DAY, 'T', 'Ma', SSRMEET_TUE_DAY) MA,
                DECODE(SSRMEET_WED_DAY, 'W', 'Mi', SSRMEET_WED_DAY) MI,
                DECODE(SSRMEET_THU_DAY, 'R', 'Ju', SSRMEET_THU_DAY) JU,
                DECODE(SSRMEET_FRI_DAY, 'F', 'Vi', SSRMEET_FRI_DAY) VI,
                DECODE(SSRMEET_SAT_DAY, 'S', 'Sa', SSRMEET_SAT_DAY) SA,
                DECODE(SSRMEET_SUN_DAY, 'U', 'Do', SSRMEET_SUN_DAY) DI,
                SUBSTR(SSRMEET_BEGIN_TIME,1,2)||':'||
                NVL(SUBSTR(SSRMEET_BEGIN_TIME,3,2),'00')            INICIO,
                SUBSTR(SSRMEET_END_TIME,1,2)||':'||
                NVL(SUBSTR(SSRMEET_END_TIME,3,2),'00')              FIN,
                SSRMEET_BLDG_CODE                                   EDIFICIO,
                SSRMEET_ROOM_CODE                                   SALON,
                SSRXLST_XLST_GROUP                                  LISTA_CRUZADA,
                DECODE(SWRXLST_TYPE,'M','Master','S','Simultneo','Independiente') TIPO_LISTA
           FROM SSBSECT SSB,
                SCBCRSE,
                (SELECT SPRIDEN_ID              ID,
                        SPRIDEN_PIDM            PIDM,
                        REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME,'*',' ') NOMBRE,
                        SIRASGN_TERM_CODE       TERM,
                        SIRASGN_CRN             CRN,
                        SIRASGN_CATEGORY        CATEGORY
                   FROM SPRIDEN,
                        SIRASGN
                  WHERE SIRASGN_PIDM        = SPRIDEN_PIDM
                    AND SPRIDEN_CHANGE_IND IS NULL
                ) PROFESOR,
                (SELECT SIRDPCL_TERM_CODE_EFF   PERIODO,
                        SIRDPCL_PIDM            PIDM,
                        SIRDPCL_COLL_CODE       ESC_SEDE
                   FROM SIRDPCL A
                  WHERE SIRDPCL_HOME_IND      = 'Y'
                    AND SIRDPCL_TERM_CODE_EFF = (SELECT MAX(SI.SIRDPCL_TERM_CODE_EFF)
                                                   FROM SIRDPCL SI
                                                  WHERE SI.SIRDPCL_PIDM           =  A.SIRDPCL_PIDM
                                                    AND (SI.SIRDPCL_TERM_CODE_EFF <= psTerm OR psTerm IS NULL)
                                                )
                ) ESCUELA,
                SSRMEET SR,
                SWRXLST,
                SSRXLST
          WHERE PROFESOR.TERM(+)     = SSBSECT_TERM_CODE
            AND PROFESOR.CRN(+)      = SSBSECT_CRN
            AND SCBCRSE_SUBJ_CODE    = SSBSECT_SUBJ_CODE
            AND SCBCRSE_CRSE_NUMB    = SSBSECT_CRSE_NUMB
            AND SCBCRSE_EFF_TERM     = (SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                          FROM SCBCRSE SC
                                         WHERE SC.SCBCRSE_EFF_TERM <= SSB.SSBSECT_TERM_CODE
                                           AND SC.SCBCRSE_SUBJ_CODE = SSB.SSBSECT_SUBJ_CODE
                                           AND SC.SCBCRSE_CRSE_NUMB = SSB.SSBSECT_CRSE_NUMB
                                       )
            AND PROFESOR.PIDM        = ESCUELA.PIDM(+)
            AND SSBSECT_CRN          = SSRMEET_CRN
            AND SSBSECT_TERM_CODE    = SSRMEET_TERM_CODE
            AND PROFESOR.CATEGORY    = SR.SSRMEET_CATAGORY
            AND SSBSECT_TERM_CODE    = SSRXLST_TERM_CODE(+)
            AND SSBSECT_CRN          = SSRXLST_CRN(+)
            AND SSRXLST_TERM_CODE    = SWRXLST_TERM_CODE(+)
            AND SSRXLST_CRN          = SWRXLST_CRN(+)
            AND SSRXLST_XLST_GROUP   = SWRXLST_XLST_GROUP(+)
            AND EXISTS (SELECT SS.SSRMEET_CRN
                          FROM SSRMEET SS,
                               SIRASGN SI,
                               SSBSECT SB
                         WHERE SS.SSRMEET_CRN       <> SR.SSRMEET_CRN
                           AND SS.SSRMEET_TERM_CODE  = SR.SSRMEET_TERM_CODE
                           AND SS.SSRMEET_CATAGORY   = SI.SIRASGN_CATEGORY
                           AND SS.SSRMEET_CRN        = SB.SSBSECT_CRN
                           AND SS.SSRMEET_TERM_CODE  = SB.SSBSECT_TERM_CODE
                           AND SI.SIRASGN_TERM_CODE  = SB.SSBSECT_TERM_CODE
                           AND SI.SIRASGN_CRN        = SB.SSBSECT_CRN
                           AND SI.SIRASGN_PIDM       = PROFESOR.PIDM
                           AND (   SS.SSRMEET_MON_DAY = SR.SSRMEET_MON_DAY
                                OR SS.SSRMEET_SUN_DAY = SR.SSRMEET_SUN_DAY
                                OR SS.SSRMEET_TUE_DAY = SR.SSRMEET_TUE_DAY
                                OR SS.SSRMEET_WED_DAY = SR.SSRMEET_WED_DAY
                                OR SS.SSRMEET_THU_DAY = SR.SSRMEET_THU_DAY
                                OR SS.SSRMEET_FRI_DAY = SR.SSRMEET_FRI_DAY
                                OR SS.SSRMEET_SAT_DAY = SR.SSRMEET_SAT_DAY
                               )
                           AND (SS.SSRMEET_START_DATE BETWEEN SR.SSRMEET_START_DATE AND SR.SSRMEET_END_DATE
                                OR
                                SS.SSRMEET_END_DATE   BETWEEN SR.SSRMEET_START_DATE AND SR.SSRMEET_END_DATE
                               )
                           AND (SS.SSRMEET_BEGIN_TIME BETWEEN SR.SSRMEET_BEGIN_TIME AND SR.SSRMEET_END_TIME
                                OR
                                SS.SSRMEET_END_TIME   BETWEEN SR.SSRMEET_BEGIN_TIME AND SR.SSRMEET_END_TIME
                               )
                       )
            AND NOT EXISTS (SELECT NULL
                              FROM SWRXLST
                             WHERE SWRXLST_TERM_CODE = SSBSECT_TERM_CODE
                               AND SWRXLST_CRN       = SSBSECT_CRN
                               AND SWRXLST_TYPE      = 'S'
                           )
            AND (INSTR(psTerm,SSBSECT_TERM_CODE) > 0     OR psTerm IS NULL)
            AND (ESCUELA.ESC_SEDE              = psFacu  OR psFacu IS NULL)
          ORDER BY termCode DESC, campCode, ESCUELA, DOCENTE, NRC;

  /* CURSOR QUE VERIFICA QUE CLASE NO SE EMPALME CON OTRAS */
  CURSOR cuEmpalme(psTerCod VARCHAR2,
                   psCrn    VARCHAR2,
                   psPidm   VARCHAR2) IS
         SELECT DISTINCT A.SSBSECT_CRN CRN_EMPALME
           FROM SSBSECT A, SSRMEET C, SIRASGN D, SPRIDEN E,
                (SELECT SSBSECT_TERM_CODE,
                        SSBSECT_CRN,
                        SSBSECT_PTRM_CODE,
                        SSRMEET_START_DATE,
                        SSRMEET_END_DATE,
                        SSRMEET_SUN_DAY,
                        SSRMEET_MON_DAY,
                        SSRMEET_TUE_DAY,
                        SSRMEET_WED_DAY,
                        SSRMEET_THU_DAY,
                        SSRMEET_FRI_DAY,
                        SSRMEET_SAT_DAY,
                        SSRMEET_BEGIN_TIME,
                        SSRMEET_END_TIME,
                        SPRIDEN_ID
                   FROM SSBSECT,
                        SSRMEET,
                        SIRASGN,
                        SPRIDEN
                  WHERE SSBSECT_TERM_CODE = psTerCod
                    AND SSBSECT_CRN       = psCrn
                    AND SSRMEET_TERM_CODE = SSBSECT_TERM_CODE
                    AND SSRMEET_CRN       = SSBSECT_CRN
                    AND SIRASGN_TERM_CODE = SSRMEET_TERM_CODE
                    AND SIRASGN_CRN       = SSRMEET_CRN
                    AND SPRIDEN_PIDM      = SIRASGN_PIDM
                    AND SSRMEET_CATAGORY  = SIRASGN_CATEGORY
                    AND SPRIDEN_PIDM      = psPidm
                    AND SPRIDEN_CHANGE_IND IS NULL
                ) B
          WHERE A.SSBSECT_TERM_CODE = B.SSBSECT_TERM_CODE
            AND A.SSBSECT_CRN NOT IN B.SSBSECT_CRN
            AND C.SSRMEET_TERM_CODE = A.SSBSECT_TERM_CODE
            AND C.SSRMEET_CRN       = A.SSBSECT_CRN
            AND D.SIRASGN_TERM_CODE = C.SSRMEET_TERM_CODE
            AND D.SIRASGN_CRN       = C.SSRMEET_CRN
            AND E.SPRIDEN_PIDM      = D.SIRASGN_PIDM
            AND C.SSRMEET_CATAGORY  = D.SIRASGN_CATEGORY
            AND E.SPRIDEN_ID IN B.SPRIDEN_ID
            AND E.SPRIDEN_CHANGE_IND IS NULL
            AND NOT EXISTS (SELECT NULL
                              FROM SWRXLST
                             WHERE SWRXLST_TERM_CODE = A.SSBSECT_TERM_CODE
                               AND SWRXLST_CRN       = A.SSBSECT_CRN
                               AND SWRXLST_TYPE      = 'S'
                           )
            AND (   C.SSRMEET_MON_DAY = B.SSRMEET_MON_DAY
                 OR C.SSRMEET_SUN_DAY = B.SSRMEET_SUN_DAY
                 OR C.SSRMEET_TUE_DAY = B.SSRMEET_TUE_DAY
                 OR C.SSRMEET_WED_DAY = B.SSRMEET_WED_DAY
                 OR C.SSRMEET_THU_DAY = B.SSRMEET_THU_DAY
                 OR C.SSRMEET_FRI_DAY = B.SSRMEET_FRI_DAY
                 OR C.SSRMEET_SAT_DAY = B.SSRMEET_SAT_DAY
                )
            AND (C.SSRMEET_START_DATE BETWEEN B.SSRMEET_START_DATE AND B.SSRMEET_END_DATE
                 OR
                 C.SSRMEET_END_DATE   BETWEEN B.SSRMEET_START_DATE AND B.SSRMEET_END_DATE
                )
            AND (C.SSRMEET_BEGIN_TIME BETWEEN B.SSRMEET_BEGIN_TIME AND B.SSRMEET_END_TIME
                 OR
                 C.SSRMEET_END_TIME   BETWEEN B.SSRMEET_BEGIN_TIME AND B.SSRMEET_END_TIME
                 );

  BEGIN
      /* Check/update the user's web session */
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
         FOR vnCOKIES IN 1..ckCount LOOP
               IF ckNOMBRES(vnCOKIES) = 'psPeriM' THEN
                   vsPerio := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                   vsFacu := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                   vsSeccion := ckValores(vnCOKIES);

             END IF;
         END LOOP;
      END IF;

      -- Las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := 'Periodo';
      tabColumna(2)  := 'Escuela sede';
      tabColumna(3)  := 'ID';
      tabColumna(4)  := 'Docente';
      tabColumna(5)  := 'NRC';
      tabColumna(6)  := 'Materia';
      tabColumna(7)  := 'Curso';
      tabColumna(8)  := 'Nombre materia';
      tabColumna(9)  := 'Parte de periodo';
      tabColumna(10) := 'Lu';
      tabColumna(11) := 'Ma';
      tabColumna(12) := 'Mi';
      tabColumna(13) := 'Ju';
      tabColumna(14) := 'Vi';
      tabColumna(15) := 'Sa';
      tabColumna(16) := 'Hora inicio';
      tabColumna(17) := 'Hora fin';
      tabColumna(18) := 'Edificio';
      tabColumna(19) := 'Sal&oacute;n';
      tabColumna(20) := 'Lista cruzada';
      tabColumna(21) := 'Tipo de curso';
      tabColumna(22) := 'NRC empalme';

      FOR regRep IN cuReporte(vsPerio, vsFacu) LOOP
          IF vnExists = 0 THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,vgsInicoPag,'1', psSubtitulo=>'Periodo '||regRep.termCode, psUsuario=>vgsUSR, psSeccion=>vsSeccion, psSinLogo=>'sin');
             vgsInicoPag := 'SALTO';

          END IF;

          htp.p('<tr>
          <td valign="top" align="left">'  ||regRep.termCode     ||'</td>
          <td valign="top" align="left">'  ||regRep.Escuela_sedE ||'</td>
          <td valign="top" align="left">'  ||regRep.ID           ||'</td>
          <td valign="top" align="left">'  ||regRep.Docente      ||'</td>
          <td valign="top" align="left">'  ||regRep.NRC          ||'</td>
          <td valign="top" align="left">'  ||regRep.Subj         ||'</td>
          <td valign="top" align="left">'  ||regRep.Curso        ||'</td>
          <td valign="top" align="left">'  ||regRep.Title        ||'</td>
          <td valign="top" align="left">'  ||regRep.Ptrm         ||'</td>
          <td valign="top" align="center">'||regRep.Lu           ||'</td>
          <td valign="top" align="center">'||regRep.Ma           ||'</td>
          <td valign="top" align="center">'||regRep.Mi           ||'</td>
          <td valign="top" align="center">'||regRep.Ju           ||'</td>
          <td valign="top" align="center">'||regRep.Vi           ||'</td>
          <td valign="top" align="center">'||regRep.Sa           ||'</td>
          <td valign="top" align="center">'||regRep.Inicio       ||'</td>
          <td valign="top" align="center">'||regRep.Fin          ||'</td>
          <td valign="top" align="left">'  ||regRep.Edificio     ||'</td>
          <td valign="top" align="left">'  ||regRep.Salon        ||'</td>
          <td valign="top" align="left">'  ||regRep.Lista_cruzada||'</td>
          <td valign="top" align="left">'  ||regRep.Tipo_lista   ||'</td>
          <td valign="top">
          ');

          FOR regEmp IN cuEmpalme(regRep.termCode, regRep.nrc, regRep.pidm) LOOP
              htp.p(regEmp.CRN_EMPALME || '<br>');
          END LOOP;

          htp.p('</td></tr>');

          vnExists := 1;
      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      END IF;

      htp.p('</table><br></body></html>');

  EXCEPTION
      WHEN OTHERS THEN htp.p( SQLERRM);

  END PWRDEHO;
/


DROP PUBLIC SYNONYM PWRDEHO;

CREATE PUBLIC SYNONYM PWRDEHO FOR BANINST1.PWRDEHO;


GRANT EXECUTE ON BANINST1.PWRDEHO TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRDEHO TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRDFRE;

CREATE OR REPLACE PROCEDURE BANINST1.PWRDFRE(psReclDesc VARCHAR2,
                                  psSiu      VARCHAR2 DEFAULT NULL,
                                  psCamp     VARCHAR2 DEFAULT NULL,
                                  psColl     VARCHAR2 DEFAULT NULL,
                                  psTerm     VARCHAR2 DEFAULT NULL,
                                  psCrn      VARCHAR2 DEFAULT NULL,
                                  psEncs     VARCHAR2 DEFAULT NULL,
                                  pnPidm     NUMBER   DEFAULT NULL,
                                  psTipo     VARCHAR2 DEFAULT NULL,
                                  psPtrm     VARCHAR2 DEFAULT NULL) IS

/**************************************************************
           tarea:  obtiene la distribucin de frecuencias del seprad
          mdulo:  resultados del sistema de evaluacin de la prctica docente (seprad)
           autor:  horacio martnez ramrez - hmr
           fecha:  01/nov/2010
**************************************************************/

  global_pidm SPRIDEN.SPRIDEN_PIDM%TYPE;

  TYPE reg_Frec IS RECORD (rTeqaCode VARCHAR2(40),
                           rTeqaDesc VARCHAR2(500),
                           rQcodCode VARCHAR2(40),
                           rQcodDesc VARCHAR2(500),
                           rMedia    NUMBER,
                           rDesvi    NUMBER,
                           rFrec1    INTEGER,
                           rFrec2    INTEGER,
                           rFrec3    INTEGER,
                           rFrec4    INTEGER,
                           rFrec5    INTEGER,
                           rTotal    INTEGER,
                           rNoAplica INTEGER,
                           rMedCat   NUMBER,
                           rDesCat   NUMBER);

  TYPE reg_mediaEscuela IS RECORD (rMedColl    NUMBER,
                                   rDesColl    NUMBER,
                                   rMedCollCat NUMBER,
                                   rDesCollCat NUMBER,
                                   rTeqaCode   VARCHAR2(40),
                                   rQcodCode   VARCHAR2(40));

  TYPE tableFrec    IS TABLE OF reg_Frec         INDEX BY BINARY_INTEGER;
  TYPE tableMedColl IS TABLE OF reg_mediaEscuela INDEX BY BINARY_INTEGER;

  tabMediaColl  tableMedColl;
  tabFrecuencia tableFrec;
  vnPromedio    NUMBER         := 0;
  vnVppMedColl  NUMBER         := 0;
  vnVppDesColl  NUMBER         := 0;
  vgnMedia      NUMBER         := 0;
  vgnDesvi      NUMBER         := 0;
  vnPidm        NUMBER         := NULL;
  vnRow         INTEGER        := 0;
  vnRowColl     INTEGER        := 0;
  vnSalto       INTEGER        := 0;
  vnCategoria   INTEGER        := 0;
  vnVpp         INTEGER        := 16;
  vnMinNoApli   INTEGER        := 0;
  vnTab         INTEGER        := 0;
  vnCrn         VARCHAR2(8)    := NULL;
  vsPtrm        VARCHAR2(1000) := NULL;
  vsPper        VARCHAR2(6)    := NULL;
  vsTipo        VARCHAR2(3)    := NULL;
  vsTerm        VARCHAR2(6)    := NULL;
  vsEncu        VARCHAR2(30)   := NULL;
  vsColl        VARCHAR2(3)    := NULL;
  vsUniv        VARCHAR2(5)    := NULL;
  vsEscuela     VARCHAR2(2)    := NULL;
  vsId          VARCHAR2(10)   := NULL;
  vsNombre      VARCHAR2(300)  := NULL;
  vsSubjc       VARCHAR2(5)    := NULL;
  vsCrse        VARCHAR2(5)    := NULL;
  vsTitulo      VARCHAR2(300)  := NULL;
  vsInscritos   VARCHAR2(3)    := NULL;
  vsContestar   VARCHAR2(3)    := NULL;
  vsTamCelda    VARCHAR2(2)    := '57';
  vsGrupoXlst   VARCHAR2(5)    := NULL;
  vsTeqaCode    VARCHAR2(20)   := NULL;

  vsBK    VARCHAR2(20)   := NULL;

  csPLANEACION CONSTANT VARCHAR2(10) := 'PLANEACION';
  csPosgrado   CONSTANT VARCHAR2(8)  := 'EPDP-ALU';
  csPosgrad2   CONSTANT VARCHAR2(8)  := 'EPDP-AL2';
  csPosgrad3   CONSTANT VARCHAR2(8)  := 'EPP-ALU2';

  CURSOR cuDistribucion(psTerm VARCHAR2,
                        pnCrn  NUMBER,
                        pnPidm NUMBER,
                        psCamp VARCHAR2,
                        psTipo VARCHAR2,
                        psEncu VARCHAR2) IS
         SELECT SWRSEPR_TEQA_CODE                        AS teqaCode,
                pk_Seprad1.F_TeqaDesc(SWRSEPR_TEQA_CODE) AS teqaDesc,
                SWRSEPR_QCOD_CODE                        AS qcodCode,
                pk_Seprad1.F_QcodDesc(SWRSEPR_QCOD_CODE) AS qcodDesc,
                SWRSEPR_MEDIA                            AS Media,
                SWRSEPR_DESVIACION                       AS Desviacion,
                SWRSEPR_FRECUENCIA1                      AS Frecuencia1,
                SWRSEPR_FRECUENCIA2                      AS Frecuencia2,
                SWRSEPR_FRECUENCIA3                      AS Frecuencia3,
                SWRSEPR_FRECUENCIA4                      AS Frecuencia4,
                SWRSEPR_FRECUENCIA5                      AS Frecuencia5,
                SWRSEPR_CONTESTARON                      AS Contestaron,
                SWRSEPR_NO_APLICA                        AS NoAplica,
                SWRSEPR_SUBJ_CODE                        AS Subj,
                SWRSEPR_CRSE_NUMB                        AS Crse,
                SWRSEPR_TITLE                            AS Title,
                SWRSEPR_PIDM                             AS Pidm,
                SWRSEPR_INSCRITOS                        AS Inscritos,
                SWROENC_ORDEN                            AS OrdenEnc
           FROM SWRSEPR, SWROENC
          WHERE SWRSEPR_TSSC_CODE = psEncu
            AND SWRSEPR_TERM_CODE = psTerm
            AND SWRSEPR_CRN       = pnCrn
            AND SWRSEPR_PIDM      = pnPidm
            AND SWRSEPR_CAMP_CODE = psCamp
            AND SWRSEPR_TIPO_CRN  = psTipo
            AND SWROENC_TSSC_CODE = SWRSEPR_TSSC_CODE
            AND SWROENC_QCOD_CODE = SWRSEPR_QCOD_CODE
          ORDER BY SWROENC_ORDEN;

  CURSOR cuProfesor(psTerm VARCHAR2,
                    pnPidm VARCHAR2,
                    psTipo VARCHAR2,
                    psGrpo VARCHAR2) IS
         SELECT cursos.Tipo                                 Tipo,
                cursos.Grupo                                Grupo,
                cursos.Crn                                  Crn,
                (SELECT STVCOLL_DESC
                   FROM STVCOLL
                  WHERE STVCOLL_CODE = A.SCBCRSE_COLL_CODE) Escuela,
                cursos.Inscritos                            Inscritos,
                NVL((SELECT SUM(SWRSEPR_CONTESTARON)
                       FROM SWRSEPR
                      WHERE SWRSEPR_TERM_CODE = cursos.Term
                        AND SWRSEPR_CRN       = cursos.Crn
                        AND SWRSEPR_PIDM      = pnPidm
                        AND SWRSEPR_TIPO_CRN  = cursos.Tipo
                        AND SWRSEPR_TEQA_CODE = csPLANEACION
                        AND SWRSEPR_QCOD_CODE IN (SELECT  SWROENC_QCOD_CODE
                                                    FROM SWROENC
                                                   WHERE SWROENC_TEQA_CODE = csPLANEACION
                                                     AND SWROENC_TEQA_CODE IS NOT NULL
                                                  )
                     ),0)   Evaluaron,
                DECODE(cursos.Tipo,'M',1,'S',2,'L',3)       Orden
           FROM SCBCRSE A,SSBSECT SS,
                (SELECT SIRASGN_TERM_CODE                                 Term,
                        SIRASGN_CRN                                       Crn,
                        NVL((SELECT SWRXLST_TYPE
                               FROM SWRXLST
                              WHERE SWRXLST_TERM_CODE = SIRASGN_TERM_CODE
                                AND SWRXLST_CRN       = SIRASGN_CRN),'I') Tipo,
                        (SELECT SWRXLST_XLST_GROUP
                           FROM SWRXLST
                          WHERE SWRXLST_TERM_CODE = SIRASGN_TERM_CODE
                            AND SWRXLST_CRN       = SIRASGN_CRN)          Grupo,
                        COUNT(DISTINCT SFRSTCR_PIDM)                      Inscritos
                   FROM SIRASGN,
                        SFRSTCR
                  WHERE SIRASGN_TERM_CODE = SFRSTCR_TERM_CODE
                    AND SIRASGN_CRN       = SFRSTCR_CRN
                    AND SIRASGN_PIDM      = pnPidm
                    AND SIRASGN_TERM_CODE = psTerm
                    AND SFRSTCR_RSTS_CODE IN ('RE','RW')
                  GROUP BY SIRASGN_TERM_CODE,SIRASGN_CRN
                  UNION ALL
                 SELECT lista.Term                              Term,
                        lista.Crn                               Crn,
                        lista.Tipo                              Tipo,
                        lista.Grupo                             Grupo,
                        SUM(lista.Inscritos)                    Inscritos
                   FROM (SELECT SIRASGN_TERM_CODE                                     Term,
                                PK_Seprad1.F_CrnMaster(SIRASGN_TERM_CODE,SIRASGN_CRN) Crn,
                                DECODE(SWRXLST_TYPE,'M','L','S','L')                  Tipo,
                                SWRXLST_XLST_GROUP                                    Grupo,
                                COUNT(DISTINCT SFRSTCR_PIDM)                          Inscritos
                           FROM SIRASGN,SWRXLST,SFRSTCR
                          WHERE SIRASGN_PIDM      = pnPidm
                            AND SIRASGN_TERM_CODE = psTerm
                            AND SWRXLST_TERM_CODE = SIRASGN_TERM_CODE
                            AND SWRXLST_CRN       = SIRASGN_CRN
                            AND SWRXLST_TYPE     IN ('M','S')
                            AND SIRASGN_TERM_CODE = SFRSTCR_TERM_CODE
                            AND SIRASGN_CRN       = SFRSTCR_CRN
                            AND SFRSTCR_RSTS_CODE IN ('RE','RW')
                            AND SWRXLST_TERM_CODE = SFRSTCR_TERM_CODE
                            AND SWRXLST_CRN       = SFRSTCR_CRN
                          GROUP BY SIRASGN_TERM_CODE,SIRASGN_CRN,SWRXLST_TYPE,SWRXLST_XLST_GROUP
                        ) lista
                  GROUP BY lista.Term,lista.Crn,lista.Tipo,lista.Grupo
                  ) cursos
            WHERE A.SCBCRSE_SUBJ_CODE  = SS.SSBSECT_SUBJ_CODE
              AND A.SCBCRSE_CRSE_NUMB  = SS.SSBSECT_CRSE_NUMB
              AND A.SCBCRSE_EFF_TERM   = (SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                            FROM SCBCRSE SC
                                           WHERE SC.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                             AND SC.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                             AND SC.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB
                                         )
              AND SS.SSBSECT_TERM_CODE = cursos.Term
              AND SS.SSBSECT_CRN       = cursos.Crn
              AND cursos.Tipo         <> 'I'
              AND cursos.Grupo         = psGrpo
            ORDER BY Orden,Grupo,Crn;

  CURSOR cuNoAplicaMini(psTerm VARCHAR2,
                        pnCrn  NUMBER,
                        pnPidm NUMBER,
                        psCamp VARCHAR2,
                        psTipo VARCHAR2,
                        psEncu VARCHAR2) IS
         SELECT MIN(SWRSEPR_NO_APLICA) minNoAplica
           FROM SWRSEPR
          WHERE SWRSEPR_TSSC_CODE = psEncu
            AND SWRSEPR_TERM_CODE = psTerm
            AND SWRSEPR_CRN       = pnCrn
            AND SWRSEPR_PIDM      = pnPidm
            AND SWRSEPR_CAMP_CODE = psCamp
            AND SWRSEPR_TIPO_CRN  = psTipo;

  CURSOR cuGrupo(psTerm VARCHAR2,
                 pnCrn  NUMBER) IS
         SELECT SWRXLST_XLST_GROUP
           FROM SWRXLST
          WHERE SWRXLST_TERM_CODE = psTerm
            AND SWRXLST_CRN       = pnCrn;

  -- muestra la media y la desviacin por categora
  procedure P_MediaPorCategoria(psCategoria varchar2,
                                pnRegistros integer) is

  vnPreguntas number  := 0;
  vnMedia     number  := 0;
  vnDesvi     number  := 0;
  vnRenglon   integer := 0;
  vnMedCero   integer := 0;

  begin
      for vnI in 1..pnRegistros loop
          if tabFrecuencia(vnI).rTeqaCode = psCategoria then
             vnPreguntas := vnPreguntas + 1;

             if vnPreguntas = 1 then
                vnRenglon := vnI;
             end if;

             if tabFrecuencia(vnI).rMedia = 0 then
                vnMedCero := vnMedCero + 1;
             end if;

             vnMedia := vnMedia + tabFrecuencia(vnI).rMedia;
             vnDesvi := vnDesvi + tabFrecuencia(vnI).rDesvi;
          end if;
      end loop;

      if vnPreguntas > 0 and vnMedia > 0 then
         vnMedia := vnMedia/(vnPreguntas-vnMedCero);
      end if;

      if vnPreguntas > 0 and vnDesvi > 0 then
         vnDesvi := vnDesvi/(vnPreguntas-vnMedCero);
      end if;

      tabFrecuencia(vnRenglon).rMedCat := vnMedia;
      tabFrecuencia(vnRenglon).rDesCat := vnDesvi;
  end P_MediaPorCategoria;

  -- procedimiento para los ttulos de inicio del reporte
  procedure P_FormatoMediaDesvia(pnPreguntas integer,
                                 psColumna   varchar2,
                                 psPropiedad varchar2) is

  vsTeqaCode svrsdef.svrsdef_teqa_code%type := null;
  vnColumna  integer                        := 0;

  begin
      for vnI IN 1..pnPreguntas loop
          if  tabFrecuencia(vnI).rTeqaCode not in (pk_Seprad1.cgsVgp, pk_Seprad1.cgsVgc) then
              if vsTeqaCode <> tabFrecuencia(vnI).rTeqaCode or vsTeqaCode is null then
                 vnColumna := vnColumna + 1;

                 if vnColumna in (3,4,5) then
                    htp.p('<td colspan="2" '||psPropiedad||' class="tdFont7">');
                 else
                    htp.p('<td '||psPropiedad||' class="tdFont7">');
                 end if;

                 if    psColumna = 'DESC' then
                       htp.p(tabFrecuencia(vnI).rTeqaDesc);

                 elsif psColumna = 'MED' then
                       htp.p(TO_CHAR(ROUND(tabFrecuencia(vnI).rMedCat,2),'90.99'));

                 elsif psColumna = 'DES' then
                       htp.p(TO_CHAR(ROUND(tabFrecuencia(vnI).rDesCat,2),'90.99'));

                 end if;

                 htp.p('</td>');

              end if;

              vsTeqaCode := tabFrecuencia(vnI).rTeqaCode;
          end if;
      end loop;

  end P_FormatoMediaDesvia;

  -- muestra la media y la desviacin por categora de la escuela
  procedure P_MediaPorCategoriaColl(psCategoria varchar2,
                                    pnRegistros integer,
                                    pnCategoria integer) is

  vnPreguntas number  := 0;
  vnMedia     number  := 0;
  vnDesvi     number  := 0;
  vnRenglon   integer := 0;

  begin
      for vnI in 1..pnRegistros loop
          if tabMediaColl(vnI).rTeqaCode = psCategoria then
             vnPreguntas := vnPreguntas + 1;

             if vnPreguntas = 1 then
                vnRenglon := vnI;
             end if;

             vnMedia     := vnMedia + tabMediaColl(vnI).rMedColl;
             vnDesvi     := vnDesvi + tabMediaColl(vnI).rDesColl;
          end if;
      end loop;

      if vnPreguntas > 0 and vnMedia > 0 then
         vnMedia := vnMedia/vnPreguntas;
      end if;

      if vnPreguntas > 0 and vnDesvi > 0 then
         vnDesvi := vnDesvi/vnPreguntas;
      end if;

      tabMediaColl(pnCategoria).rMedCollCat := vnMedia;
      tabMediaColl(pnCategoria).rDesCollCat := vnDesvi;
  end P_MediaPorCategoriaColl;

  BEGIN
      -- valida que el usuario pertenezca a la base de datos
      IF psSiu IS NULL THEN
         IF pk_login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;
      ELSE
         IF NOT twbkwbis.F_ValidUser(global_pidm) THEN RETURN; END IF;
      END IF;

      vsUniv := pk_objHtml.getValueCookie('psSprUn');
      vsEncu := pk_objHtml.getValueCookie('psSeprd');
      vsTerm := pk_objHtml.getValueCookie('psSprTD');
      vsColl := pk_objHtml.getValueCookie('psSprCD');
      vnPidm := pk_objHtml.getValueCookie('psSprPi');
      vnCrn  := pk_objHtml.getValueCookie('psSprCr');
      vsPtrm := pk_objHtml.getValueCookie('psPtrmP');

      IF psCamp IS NOT NULL THEN
         vsUniv := psCamp;
         vsColl := psColl;
         vsTerm := psTerm;
         vnCrn  := psCrn;
         vsEncu := psEncs;
         vnPidm := pnPidm;
         vsTipo := psTipo;
         vsPtrm := psPtrm;
      END IF;

      -- el uso de la variable es por el uso de la seleccin mltiple de la parte de periodo
      vsPtrm := NVL(vsPtrm,'/');

      IF INSTR(vnCrn,',') > 0 THEN
         vsTipo := SUBSTR(vnCrn,1,INSTR(vnCrn,',')-1);
         vnCrn  := SUBSTR(vnCrn,  INSTR(vnCrn,',')+1);
      END IF;

      IF vsTipo <> 'I' THEN
         FOR regGrp IN cuGrupo(vsTerm,vnCrn) LOOP
             vsGrupoXlst := regGrp.SWRXLST_XLST_GROUP;
         END LOOP;
      END IF;

      vsBK := 'bk0001';

      vsEscuela := pk_Seprad1.F_EscuelaMateria(vsTerm, vnCrn);

      pk_Seprad1.P_IdNameProfesor(vnPidm, vsId, vsNombre);

      FOR regCat IN cuDistribucion(vsTerm, vnCrn, vnPidm, vsUniv, vsTipo, vsEncu) LOOP
          vnRow := vnRow + 1;

          tabFrecuencia(vnRow).rTeqaCode := regCat.teqaCode;
          tabFrecuencia(vnRow).rTeqaDesc := regCat.teqaDesc;
          tabFrecuencia(vnRow).rQcodCode := regCat.qcodCode;
          tabFrecuencia(vnRow).rQcodDesc := regCat.qcodDesc;
          tabFrecuencia(vnRow).rMedia    := regCat.Media;
          tabFrecuencia(vnRow).rDesvi    := regCat.Desviacion;
          tabFrecuencia(vnRow).rFrec1    := regCat.Frecuencia1;
          tabFrecuencia(vnRow).rFrec2    := regCat.Frecuencia2;
          tabFrecuencia(vnRow).rFrec3    := regCat.Frecuencia3;
          tabFrecuencia(vnRow).rFrec4    := regCat.Frecuencia4;
          tabFrecuencia(vnRow).rFrec5    := regCat.Frecuencia5;
          tabFrecuencia(vnRow).rTotal    := regCat.Contestaron;
          tabFrecuencia(vnRow).rNoAplica := regCat.NoAplica;

          vsSubjc     := regCat.Subj;
          vsCrse      := regCat.Crse;
          vsTitulo    := regCat.Title;
          vsInscritos := regCat.Inscritos;
          vsContestar := regCat.Contestaron;

          IF regCat.teqaCode NOT IN (pk_Seprad1.cgsVgp, pk_Seprad1.cgsVgc) THEN
             IF regCat.Media = 0 THEN
                vnVpp := vnVpp - 1;
             END IF;

             vgnMedia := vgnMedia + regCat.Media;
             vgnDesvi := vgnDesvi + regCat.Desviacion;
          END IF;
      END LOOP;

      vsBK := 'bk0002';

      -- obtener el mnimo no aplica
      FOR regNoApli IN cuNoAplicaMini(vsTerm, vnCrn, vnPidm, vsUniv, vsTipo, vsEncu) LOOP
          vnMinNoApli := regNoApli.minNoAplica;
      END LOOP;

      FOR regPreg IN pk_Seprad1.cuPreguntas LOOP
          P_MediaPorCategoria(regPreg.Categ, vnRow);
      END LOOP;

      vsBK := 'bk0003';

      IF vgnMedia > 0 THEN
         vgnMedia := ROUND(vgnMedia/vnVpp,2);
      END IF;

      IF vgnDesvi > 0 THEN
         vgnDesvi := ROUND(vgnDesvi/vnVpp,2);
      END IF;

      -- el uso de la variable es por el uso de la seleccin mltiple de la parte de periodo
      FOR regColl IN PK_Seprad1.cuMediaEscuela (vsTerm, vsEscuela, vsUniv, vsEncu, vsPtrm) LOOP
          IF regColl.Teqa NOT IN (PK_Seprad1.cgsVgc,PK_Seprad1.cgsVgp) THEN
             vnRowColl := vnRowColl + 1;

             tabMediaColl(vnRowColl).rMedColl  := regColl.Media;
             tabMediaColl(vnRowColl).rDesColl  := regColl.Desvi;
             tabMediaColl(vnRowColl).rTeqaCode := regColl.Teqa;
             tabMediaColl(vnRowColl).rQcodCode := regColl.Qcod;

             vnVppMedColl := vnVppMedColl + regColl.Media;
             vnVppDesColl := vnVppDesColl + regColl.Desvi;
          END IF;
      END LOOP;

      vsBK := 'bk0004';

      FOR regPreg IN pk_Seprad1.cuPreguntas LOOP
          vnCategoria := vnCategoria + 1;
          P_MediaPorCategoriaColl(regPreg.Categ,vnRowColl,vnCategoria);
      END LOOP;

      IF vnVppMedColl > 0 THEN
         vnVppMedColl := ROUND(vnVppMedColl/16,2);
      END IF;

      IF vnVppDesColl > 0 THEN
         vnVppDesColl := ROUND(vnVppDesColl/16,2);
      END IF;

      vsBK := 'bk0005';

      htp.p('<html><head><title>'||psReclDesc||'</title>');

      -- la aplicacin no se guarda en el cache de la mquina
      PK_ObjHTML.P_NoCache;

      -- cdigo css
      PK_ObjHTML.P_CssTabs;

      htp.p('<script language="JavaScript"><!--');
      htp.p('function fImprimeReporte() {
      window.focus()
      print();
      }');
      htp.p('//--></script>');

      htp.p('</head><body bgcolor="#ffffff" class="bodyCeroR"><br/>');
      htp.p('<script language="javascript" src="kwacnls.js"></script><br/>');
      htp.p('<table border="0" cellpadding="2" cellspacing="1" bordercolor="#FFFFFF" bgcolor="#ffffff" width="100%">
      <tr class="trTabSepara">
          <td rowspan="11" width="10%" valign="top"><img src="/imagenes/logo_uft.jpg'||'" width="80" border="0"></td>
          <th colspan="3" align="left">'||REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(psReclDesc,'~aacute','&aacute'),'~eacute','&eacute'),'~iacute','&iacute'),'~oacute','&oacute'),'~uacute','&uacute')||'</th>
          <td class="tdFont7">'||TO_CHAR(SYSDATE,'DD/MON/YYYY')||'</td></tr>
      <tr class="trTabSepara"><td colspan="4"></td></tr>
      <tr class="trTabSepara">
          <th class="thFont7" width="10%" align="right" bgcolor="#efefef">'||'Expediente'||'</th>
          <td class="tdFont7" width="20%">'||vsId||'</td>
          <th class="thFont7" width="25%" align="right" bgcolor="#efefef">'||'Periodo'||'</th>
          <td class="tdFont7" width="25%">'||vsTerm||' '||pk_Seprad1.F_TermDesc(vsTerm)||'</td></tr>
       <tr class="trTabSepara">
          <th class="thFont7" align="right" bgcolor="#efefef">RUT</th>
          <td class="tdFont7" >'||F_GET_RUT(vnPidm)||'</td>
          <th class="thFont7"></th>
          <td class="tdFont7" ></td></tr>
      <tr class="trTabSepara">
          <th class="thFont7" align="right" bgcolor="#efefef">'||'Profesor'||'</th>
          <td class="tdFont7" >'||vsNombre||'</td>
          <th class="thFont7" align="right" bgcolor="#efefef">'||'Escuela o Facultad'||'</th>
          <td class="tdFont7" >'||pk_Seprad1.F_CollDesc(vsEscuela)||'</td></tr>
      <tr class="trTabSepara">
          <th class="thFont7" align="right" bgcolor="#efefef">'||'Materia'||'</th>
          <td class="tdFont7" >'||vsSubjc||' '||vsCrse||'</td>
          <th class="thFont7" align="right" bgcolor="#efefef" valign="top">'||'Parte de periodo'/*parte de periodo*/||'</th>
          <td class="tdFont7" >'||pK_Seprad1.F_PtrmCodeDesc(vsTerm,
                                                                                   vnCrn,
                                                                                   pnPidm=>vnPidm,
                                                                                   psReprt=>'PWRDFRE',
                                                                                   psPtrm=>vsPtrm,
                                                                                   psEncs=>vsEncu )
                                        ||'</td></tr>
      <tr class="trTabSepara"> ');

      IF vsTipo IS NOT NULL AND vsTipo <> 'I' THEN
         htp.p('<th class="thFont7" valign="top" rowspan="6" colspan="2">');
         htp.p('<table border="0" cellpadding="2" cellspacing="1" width="100%" bordercolor="#ffffff" bgcolor="#ffffff">
         <th class="thFont7" valign="bottom" bgcolor="#efefef" width="20%">'||'CRN'||'</th>
         <th class="thFont7" valign="bottom" bgcolor="#efefef" width="40%">'||'Escuela o Facultad'||'</th>
         <th class="thFont7" valign="bottom" bgcolor="#efefef" width="20%">'||'Inscritos'||'</th>
         <th class="thFont7" valign="bottom" bgcolor="#efefef" width="20%">'||'Cuestionarios respondidos'||'</th>');

         FOR regPro IN cuProfesor(vsTerm, vnPidm, vsTipo, vsGrupoXlst) LOOP
             htp.p('<tr><td class="tdFont7" align="center">');

             IF vsTipo = regPro.Tipo AND vnCrn = regPro.Crn THEN
                htp.p('<table border="1" cellpadding="1" cellspacing="0" bgcolor="#ffffff" bordercolor="#000000">
                <tr class="trTabSepara"><td class="tdFont7">'
                ||regPro.Tipo||'-'||regPro.Grupo||'-'||regPro.Crn||
                '</td></tr></table>');
             ELSE
                htp.p(''||regPro.Tipo||'-'||regPro.Grupo||'-'||regPro.Crn||'');
             END IF;

             htp.p('</td>
             <td class="tdFont7">'||regPro.Escuela  ||'</td>
             <td class="tdFont7" align="center">'||regPro.Inscritos||'</td>
             <td class="tdFont7" align="center">'||regPro.Evaluaron||'</td>
             </tr>');
         END LOOP;

         htp.p('</table>');
         htp.p('</th>
         <th class="thFont7" align="right" bgcolor="#efefef" valign="top">'||'N&uacute;mero de alumnos inscritos'||'</th>
         <td class="tdFont7" valign="top">'||vsInscritos||'</td></tr>
         <tr><td></td><td></td></tr>
         <tr><td></td><td></td></tr>
         <tr><td></td><td></td></tr>');

         htp.p('
         <tr class="trTabSepara">
             <th class="thFont7" align="right" bgcolor="#efefef" valign="top">'||'N&uacute;mero de cuestionarios respondidos'||'</th>
             <td class="tdFont7" valign="top">'||vsContestar||'</td></tr>
         <tr class="trTabSepara">
             <th class="thFont7" align="right" bgcolor="#efefef">'||'Materia'||'</th>
             <td class="tdFont7">'||vsTitulo||'</td></tr>
         </table><br/>
         ');

      ELSE
         htp.p('<th class="thFont7" valign="top" align="right" bgcolor="#efefef">'||'CRN'||'</th>
         <td valign="top" class="tdFont7">'||vnCrn||'</td>
         <th class="thFont7" align="right" bgcolor="#efefef" valign="top">'||'N&uacute;mero de alumnos inscritos'||'</th>
         <td class="tdFont7" valign="top">'||vsInscritos||'</td></tr>
         <tr class="trTabSepara">
            <th class="thFont7" align="right" bgcolor="#efefef">'||'Materia'||'</th>
            <td class="tdFont7">'||vsTitulo||'</td>
            <th class="thFont7" align="right" bgcolor="#efefef" valign="top">'||'N&uacute;mero de cuestionarios respondidos'||'</th>
            <td class="tdFont7" valign="top">'||vsContestar||'</td></tr>
         ');
      END IF;

      htp.p('<table border="1" cellpadding="2" cellspacing="0" width="100%" bordercolor="#cccccc" bgcolor="#ffffff">
      <tr class="trTabSepara"><td colspan="3" style="border-left:none;border-top:none;"></td>');

      -- ttulos de las categoras
      P_FormatoMediaDesvia(vnRow,'DESC','valign="bottom"');

      --### epdp-alu  #### posgrado
      IF vsEncu IN (csPosgrado,csPosgrad2,csPosgrad3) THEN
          vsTamCelda := '52';
          htp.p('<td colspan="3" valign="bottom" align="center" class="tdFont7">'||'Valoraci&oacute;n Promedio del Profesor (VPP)'||'</td></tr>');
      ELSE
          htp.p('<td colspan="2" valign="bottom" align="center" class="tdFont7">'||'Valoraci&oacute;n Promedio del Profesor (VPP)'||'</td></tr>');
      END IF;

      htp.p('
      <tr class="trTabSepara">
          <td class="tdFont7" colspan="2" rowspan="2" align="right">'||'Materia'||'</td>
          <td class="tdFont7" align="right"  style="border-bottom:none;">'||'Promedio'||'</td>');

      -- media de las categoras
      P_FormatoMediaDesvia(vnRow,'MED','valign="top" align="center" style="border-bottom:none;"');

      --### epdp-alu  #### posgrado
      IF vsEncu IN (csPosgrado,csPosgrad2,csPosgrad3) THEN
         htp.p('<td colspan="3" align="center" class="tdFont7" style="border-bottom:none;">'||TO_CHAR(vgnMedia,'90.99')||'</td></tr>');
      ELSE
         htp.p('<td colspan="2" align="center" class="tdFont7" style="border-bottom:none;">'||TO_CHAR(vgnMedia,'90.99')||'</td></tr>');
      END IF;

      htp.p('<tr class="trTabSepara"><td align="right" class="tdFont7"  style="border-top:none;">'||'Desviaci&oacute;n'||'</td>');

      -- desviacin estandar de las categoras
      P_FormatoMediaDesvia(vnRow,'DES','valign="top" align="center" style="border-top:none;"');

      --### epdp-alu  #### posgrado
      IF vsEncu IN (csPosgrado,csPosgrad2,csPosgrad3) THEN
         htp.p('<td colspan="3" align="center" class="tdFont7" style="border-top:none;">'||TO_CHAR(vgnDesvi,'90.99')||'</td></tr>');
      ELSE
         htp.p('<td colspan="2" align="center" class="tdFont7" style="border-top:none;">'||TO_CHAR(vgnDesvi,'90.99')||'</td></tr>');
      END IF;

      htp.p('<tr class="trTabSepara"><td colspan="2" rowspan="2" align="right" class="tdFont7">'||'Escuela o Facultad'||'</td>
                  <td align="right" class="tdFont7"  style="border-bottom:none;">'||'Promedio'||'</td>');

      -- media de la escuela
      FOR vnI IN 1..5 LOOP
          IF vnI IN (3,4,5) THEN
             htp.p('<td colspan="2" align="center" class="tdFont7" style="border-bottom:none;">');
          ELSE
             htp.p('<td align="center" class="tdFont7" style="border-bottom:none;">');
          END IF;

          htp.p(TO_CHAR(ROUND(tabMediaColl(vnI).rMedCollCat,2),'90.99')||'</td>');
      END LOOP;

      --### epdp-alu  #### posgrado
      IF vsEncu IN (csPosgrado,csPosgrad2,csPosgrad3) THEN
         htp.p('<td colspan="3" align="center" class="tdFont7" style="border-bottom:none;">'||TO_CHAR(vnVppMedColl,'90.99')||'</td></tr>');
      ELSE
         htp.p('<td colspan="2" align="center" class="tdFont7" style="border-bottom:none;">'||TO_CHAR(vnVppMedColl,'90.99')||'</td></tr>');
      END IF;

      htp.p('
      <tr class="trTabSepara"><td align="right" class="tdFont7" style="border-top:none;">'||'Desviaci&oacute;n'||'</td>');

      -- desviacin de la escuela
      FOR vnI IN 1..5 LOOP
          IF vnI IN (3,4,5) THEN
             htp.p('<td colspan="2" align="center" class="tdFont7" style="border-top:none;">');
          ELSE
             htp.p('<td align="center" class="tdFont7" style="border-top:none;">');
          END IF;

          htp.p(TO_CHAR(ROUND(tabMediaColl(vnI).rDesCollCat,2),'90.99')||'</td>');
      END LOOP;

      -- ### epdp-alu  #### posgrado
      IF vsEncu IN (csPosgrado,csPosgrad2,csPosgrad3) THEN
         htp.p('<td colspan="3" align="center" class="tdFont7" style="border-top:none;">'||TO_CHAR(vnVppDesColl,'90.99')||'</td></tr>');
      ELSE
         htp.p('<td colspan="2" align="center" class="tdFont7" style="border-top:none;">'||TO_CHAR(vnVppDesColl,'90.99')||'</td></tr>');
      END IF;

      htp.p('
      <tr class="trTabSepara">
          <td rowspan="2" style="border-left:none;border-right:none;"></td>
          <td rowspan="2" style="border-left:none;border-right:none;" width="20%"></td>
          <td rowspan="2" style="border-left:none;border-right:none;" width="17%"></td>
          <td rowspan="2" style="border-left:none;border-right:none;" width="10%"></td>
          <td rowspan="2" style="border-left:none;border-right:none;" width="10%"></td>
          <td colspan="2" style="border-bottom:none;"></td>
          <th colspan="5" class="thFont7" style="border-bottom:none;">'||'Distribuci&oacute;n de frecuencias'||'</th>');

      -- ### epdp-alu  #### posgrado
      IF vsEncu IN (csPosgrado,csPosgrad2,csPosgrad3) THEN
         htp.p('<td align="center" class="tdFont7" colspan="2">'||'Total Respuestas'||'</td>');
      ELSE
         htp.p('<td rowspan="2" align="center" class="tdFont7">'||'Total Respuestas'||'</td>');
      END IF;

      htp.p('
      <tr class="trTabSepara">
          <td align="center" class="tdFont7" style="border-right:none;border-top:none;">'||'Promedio'||'</td>
          <td align="center" class="tdFont7" style="border-left:none;border-top:none;">' ||'Desviaci&oacute;n'||'</td>
          <th class="thFont7" style="border-right:none;border-top:none;">1</th>
          <th class="thFont7" style="border-left:none;border-right:none;border-top:none;">2</th>
          <th class="thFont7" style="border-left:none;border-right:none;border-top:none;">3</th>
          <th class="thFont7" style="border-left:none;border-right:none;border-top:none;">4</th>
          <th class="thFont7" style="border-left:none;border-top:none;">5</th>');

      -- ### epdp-alu  #### posgrado
      IF vsEncu IN (csPosgrado,csPosgrad2,csPosgrad3) THEN
         htp.p('<td align="center" class="tdFont7" valign="bottom">'||'V&aacute;lidas'||'</td>');
         htp.p('<td align="center" class="tdFont7" valign="bottom">'||'No aplica'||'</td></tr>');
      ELSE
         htp.p('</tr>');
      END IF;

      vsTeqaCode := NULL;

      FOR vnI IN 1..vnRow LOOP
          IF pk_seprad1.cgsVgp = tabFrecuencia(vnI).rTeqaCode AND vnSalto = 0 THEN
             htp.p('<tr class="trTabSepara" bgcolor="#efefef">
                        <th colspan="5" class="thFont7" style="border-right:none;">'||'Valoraci&oacute;n Promedio del Profesor (VPP)'||'</th>
                        <th class="thFont7" style="border-left:none;border-right:none;">'||TO_CHAR(vgnMedia,'90.99')||'</th>
                        <th class="thFont7" style="border-left:none;border-right:none;">'||TO_CHAR(vgnDesvi,'90.99')||'</th>');

             -- ### epdp-alu  #### posgrado
             IF vsEncu IN (csPosgrado,csPosgrad2,csPosgrad3) THEN
                htp.p('<td class="tdFont7" colspan="7" style="border-left:none;"></td></tr>');
                htp.p('<tr class="trTabSepara"><td colspan="14" bgcolor="#ffffff" style="border-right:none;border-left:none;"></td></tr>');
             ELSE
                htp.p('<td class="tdFont7" colspan="6" style="border-left:none;"></td></tr>');
                htp.p('<tr class="trTabSepara"><td colspan="13" bgcolor="#ffffff" style="border-right:none;border-left:none;"></td></tr>');
             END IF;


             vnSalto := 1;
          END IF;

          IF vsTeqaCode <> tabFrecuencia(vnI).rTeqaCode OR vsTeqaCode IS NULL THEN
             htp.p('<tr  class="trTabSepara" bgcolor="#efefef">
                        <th class="thFont7" align="left" colspan="5" style="border-right:none;">'||tabFrecuencia(vnI).rTeqaDesc||'</th>
                        <th class="thFont7" style="border-left:none;border-right:none;">'||TO_CHAR(ROUND(tabFrecuencia(vnI).rMedCat,2),'90.99')||'</th>
                        <th class="thFont7" style="border-left:none;border-right:none;">'||TO_CHAR(ROUND(tabFrecuencia(vnI).rDesCat,2),'90.99')||'</th>');

             -- ### epdp-alu  #### posgrado
             IF vsEncu IN (csPosgrado,csPosgrad2,csPosgrad3) THEN
                 htp.p('<td colspan="7" style="border-left:none;"></td></tr>');
             ELSE
                 htp.p('<td colspan="6" style="border-left:none;"></td></tr>');
             END IF;

          END IF;

          htp.p('<tr class="trTabSepara">
          <td class="tdFont7" width="3%" align="right" style="border-right:none;" valign="top" >'||vnI||')</td>
          <td class="tdFont7" valign="top" width="'||vsTamCelda||'%" align="left"  style="border-left:none;" colspan="4">'||tabFrecuencia(vnI).rQcodDesc||'</td>
          <td class="tdFont7" valign="top" width="5%"  align="center" style="border-right:none;">'||TO_CHAR(ROUND(tabFrecuencia(vnI).rMedia,2),'90.99')||'</td>
          <td class="tdFont7" valign="top" width="5%"  align="center" style="border-left:none;">'||TO_CHAR(ROUND(tabFrecuencia(vnI).rDesvi,2),'90.99')||'</td>
          <td class="tdFont7" valign="top" width="5%"  align="center" style="border-right:none;">'||tabFrecuencia(vnI).rFrec1||'</td>
          <td class="tdFont7" valign="top" width="5%"  align="center" style="border-left:none;border-right:none;">'||tabFrecuencia(vnI).rFrec2||'</td>
          <td class="tdFont7" valign="top" width="5%"  align="center" style="border-left:none;border-right:none;">'||tabFrecuencia(vnI).rFrec3||'</td>
          <td class="tdFont7" valign="top" width="5%"  align="center" style="border-left:none;border-right:none;">'||tabFrecuencia(vnI).rFrec4||'</td>
          <td class="tdFont7" valign="top" width="5%"  align="center" style="border-left:none;">'||tabFrecuencia(vnI).rFrec5||'</td>');

          -- ### epdp-alu  #### posgrado
          IF vsEncu IN (csPosgrado,csPosgrad2,csPosgrad3) THEN
             htp.p('<td class="tdFont7" valign="top" width="5%"  align="center">'||(tabFrecuencia(vnI).rFrec1+tabFrecuencia(vnI).rFrec2+tabFrecuencia(vnI).rFrec3+tabFrecuencia(vnI).rFrec4+tabFrecuencia(vnI).rFrec5)||'</td>');

             IF tabFrecuencia(vnI).rNoAplica <> vnMinNoApli THEN
                tabFrecuencia(vnI).rNoAplica := tabFrecuencia(vnI).rNoAplica-vnMinNoApli;
             END IF;

             htp.p('<td class="tdFont7" valign="top" width="5%"  align="center">'||tabFrecuencia(vnI).rNoAplica||'</td>');
          ELSE
             htp.p('<td class="tdFont7" valign="top" width="5%"  align="center">'||(tabFrecuencia(vnI).rFrec1+tabFrecuencia(vnI).rFrec2+tabFrecuencia(vnI).rFrec3+tabFrecuencia(vnI).rFrec4+tabFrecuencia(vnI).rFrec5)||'</td>');
          END IF;

          htp.p('</tr>');
          vsTeqaCode := tabFrecuencia(vnI).rTeqaCode;
      END LOOP;

      htp.p('</table><br/></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           htp.p(vsBK||': '||SQLERRM);

  END PWRDFRE;
/


DROP PUBLIC SYNONYM PWRDFRE;

CREATE PUBLIC SYNONYM PWRDFRE FOR BANINST1.PWRDFRE;


GRANT EXECUTE ON BANINST1.PWRDFRE TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRDFRE TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRDOMN;

CREATE OR REPLACE PROCEDURE BANINST1.PWRDOMN ( psReclDesc    VARCHAR2,
                                               psInicio      VARCHAR2  DEFAULT NULL,
                                               psFin         VARCHAR2  DEFAULT NULL,
                                               psHrI         VARCHAR2  DEFAULT NULL,
                                               psHrF         VARCHAR2  DEFAULT NULL,
                                               psDias        VARCHAR2  DEFAULT NULL,
                                               psNombre      VARCHAR2  DEFAULT NULL,
                                               psCollDesc    VARCHAR2  DEFAULT NULL,
                                               psSubj        VARCHAR2  DEFAULT NULL,
                                               psCrseNum     VARCHAR2  DEFAULT NULL,
                                               psTit         VARCHAR2  DEFAULT NULL,
                                               psLista       VARCHAR2  DEFAULT NULL,
                                               psTipoLista   VARCHAR2  DEFAULT NULL,
                                               psDetalle     VARCHAR2  DEFAULT NULL ) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de ocupacin de salones
                por da (domino).
     propsito: obtener informacin de las clases y eventos que estn asignados,
                en un horario y fecha especficos, a cada una de las salas de
                los edificios de la universidad.
        mdulo: programacin acadmica - uft.
         autor: hmr - horacio martnez ramrez.
         fecha: 15/12/2010.

  modificacin: 05/07/2011 - hmr.
                se ajustaron los querys de varios cursores que obtienen
                informacin, se ajust la presentacin visual de algunos datos
                y se agregaron sentencias para limpiar variables globales y de
                objetos tipo tabla.
*******************************************************************************/

  vgsInicoPag   VARCHAR2(10) := NULL;    -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin

  tabColumna    PK_sisRepImp.tipoTabla := PK_sisRepImp.tipoTabla(1);
  vsHrI         SSRMEET.SSRMEET_BEGIN_TIME%TYPE := NULL;
  vsCollCode    STVCOLL.STVCOLL_CODE%TYPE       := NULL;
  vsCollCodeEv  STVCOLL.STVCOLL_CODE%TYPE       := NULL;
  vsTitl        SCBCRSE.SCBCRSE_TITLE%TYPE      := NULL;
  vsSubj        SCBCRSE.SCBCRSE_SUBJ_CODE%TYPE  := NULL;
  vsCrse        SCBCRSE.SCBCRSE_CRSE_NUMB%TYPE  := NULL;
  vsCollDesc    STVCOLL.STVCOLL_DESC%TYPE       := NULL;
  vsCollDescEv  STVCOLL.STVCOLL_DESC%TYPE       := NULL;
  vsSalonDes    SLBRDEF.SLBRDEF_DESC%TYPE       := NULL;
  vsLista       SWRXLST.SWRXLST_XLST_GROUP%TYPE := NULL;
  vsTipoLista   VARCHAR2(30)  := NULL;
  vsNombre      VARCHAR2(300) := NULL;
  vsDias        VARCHAR2(100) := NULL;
  vsRoomCode    VARCHAR2(50)  := NULL;
  vsRoomDesc    VARCHAR2(50)  := NULL;
  vsDateRoom    VARCHAR2(10)  := NULL;
  vsSeccion     VARCHAR2(3)   := NULL;
  vnHrMax       INTEGER       := NULL;
  vnHoraI       INTEGER       := 0;
  vnHoraF       INTEGER       := 0;
  vsDiaSemana   VARCHAR2(10)  := NULL;
  vnIncremento  INTEGER       := 30;
  vnEvento      INTEGER       := 0;
  vnCampo       INTEGER       := 0;
  vnNrc         INTEGER       := 0;
  vnExists      INTEGER       := 0;

  TYPE reg_Room IS RECORD ( rCrnn    VARCHAR2(10),
                            rTerm    VARCHAR2(10),
                            rHIni    VARCHAR2(10),
                            rHFin    VARCHAR2(10),
                            rDays    VARCHAR2(10) );

  TYPE reg_Slon IS RECORD ( rRoomCode    VARCHAR2(40),
                            rRoomDesc    VARCHAR2(50) );

  TYPE tableRoom IS TABLE OF reg_Room INDEX BY BINARY_INTEGER;
  TYPE tableSlon IS TABLE OF reg_Slon INDEX BY BINARY_INTEGER;

  tabRoom       tableRoom;
  tabSlon       tableSlon;
  vsSalon       VARCHAR2(40) := NULL;


  -- obtiene los salones (ocupados y desocupados) de un edificio:
  CURSOR cuSalones ( psRoomCode   VARCHAR2 ) IS

     SELECT SL.SLBRDEF_ROOM_NUMBER  RoomCode,
            SL.SLBRDEF_DESC         RoomDesc
       FROM SLBRDEF SL
      WHERE SL.SLBRDEF_BLDG_CODE = psRoomCode
        AND SL.SLBRDEF_ROOM_NUMBER IS NOT NULL
        AND SL.SLBRDEF_PRIORITY IS NOT NULL
        AND SL.SLBRDEF_RMST_CODE = 'AC'
        AND SL.SLBRDEF_ROOM_TYPE = 'C'
        AND SL.SLBRDEF_TERM_CODE_EFF = ( SELECT MAX(B.SLBRDEF_TERM_CODE_EFF)
                                           FROM SLBRDEF B
                                          WHERE B.SLBRDEF_ROOM_NUMBER = SL.SLBRDEF_ROOM_NUMBER
                                            AND B.SLBRDEF_ROOM_NUMBER IS NOT NULL
                                            AND B.SLBRDEF_PRIORITY IS NOT NULL
                                            AND B.SLBRDEF_RMST_CODE = 'AC'
                                            AND B.SLBRDEF_ROOM_TYPE = 'C' )
      ORDER BY SLBRDEF_ROOM_NUMBER;


  -- muestra una ventana con informacin de los cursos:
  PROCEDURE p_DetalleCurso ( psInicio      VARCHAR2  DEFAULT NULL,
                             psFin         VARCHAR2  DEFAULT NULL,
                             psHrI         VARCHAR2  DEFAULT NULL,
                             psHrF         VARCHAR2  DEFAULT NULL,
                             psDias        VARCHAR2  DEFAULT NULL,
                             psNombre      VARCHAR2  DEFAULT NULL,
                             psCollDesc    VARCHAR2  DEFAULT NULL,
                             psSubj        VARCHAR2  DEFAULT NULL,
                             psCrseNum     VARCHAR2  DEFAULT NULL,
                             psTit         VARCHAR2  DEFAULT NULL,
                             psLista       VARCHAR2  DEFAULT NULL,
                             psTipoLista   VARCHAR2  DEFAULT NULL ) IS

  BEGIN
     htp.p('<html><head><title>&nbsp;</title>');

     pk_ObjHTML.p_noCache;

     pk_ObjHTML.P_EstiloFuncionalidad;

     htp.p('</head><body bgcolor="#ffffff"><br/>');

     -- muestra los datos de cada sesin dentro de la ventana:
     htp.p('<table border="0" width="90%" align="center" bgcolor="#ffffee">
            <tr><th colspan="2">DATOS DE LA SESI&Oacute;N : </th></tr>
            <tr><td widht="20%"></td><td widht="70%"></td></tr>
            <tr><th align="left" valign="top">Fecha inicio: </th><td valign="top">'||psInicio ||'</td></tr>
            <tr><th align="left" valign="top">Fecha t&eacute;rmino: </th><td valign="top">'||psFin ||'</td></tr>
            <tr><th align="left" valign="top">Hora inicio: </th><td valign="top">'||SUBSTR(psHrI,1,2)||':'||SUBSTR(psHrI,3,2)||' hrs.'||'</td></tr>
            <tr><th align="left" valign="top">Hora t&eacute;rmino: </th><td valign="top">'||SUBSTR(psHrF,1,2)||':'||SUBSTR(psHrF,3,2)||' hrs.'||'</td></tr>
            <tr><th align="left" valign="top">D&iacute;as: </th><td valign="top">'||psDias ||'</td></tr>
            <tr><th align="left" valign="top">Nombre: </th><td valign="top">'||psNombre ||'</td></tr>
            <tr><th align="left" valign="top">Subj: </th><td valign="top">'||psSubj ||'</td></tr>
            <tr><th align="left" valign="top">Curso: </th><td valign="top">'||psCrseNum ||'</td></tr>
            <tr><th align="left" valign="top">T&iacute;tulo: </th><td valign="top">'||psTit ||'</td></tr>
            <tr><th align="left" valign="top">Lista cruzada: </th><td valign="top">'||psLista ||'</td></tr>
            <tr><th align="left" valign="top">Tipo de curso: </th><td valign="top">'||psTipoLista||'</td></tr>
            <tr><th align="left" valign="top">Escuela: </th><td valign="top">'||psCollDesc ||'</td></tr>
            </table>');

     htp.p('</body></html>');

  END p_DetalleCurso;


  -- obtiene los datos del crn:
  PROCEDURE p_ObtieneDatosCrn ( pnIndex    INTEGER ) IS

  BEGIN
     BEGIN

        SELECT SCBCRSE_TITLE,
               SCBCRSE_SUBJ_CODE,
               SCBCRSE_CRSE_NUMB
          INTO vstitl,
               vssubj,
               vscrse
          FROM SCBCRSE A,
               SSBSECT SS
         WHERE SSBSECT_SUBJ_CODE = SCBCRSE_SUBJ_CODE
           AND SSBSECT_CRSE_NUMB = SCBCRSE_CRSE_NUMB
           AND SCBCRSE_EFF_TERM = ( SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                      FROM SCBCRSE SC
                                     WHERE SC.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                       AND SC.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                       AND SC.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB )
           AND SS.SSBSECT_TERM_CODE = tabRoom(pnIndex).rTerm
           AND ( (SS.SSBSECT_CRN = tabRoom(pnIndex).rCrnn)
                 OR
                 SS.SSBSECT_CRN = ( SELECT UPPER(SLBEVNT_DESC)
                                      FROM SLBEVNT
                                     WHERE SLBEVNT_CRN = tabRoom(pnIndex).rcrnn ) );

     EXCEPTION
        WHEN NO_DATA_FOUND THEN
             vsTitl := NULL;
             vsSubj := NULL;
             vsCrse := NULL;
        WHEN OTHERS THEN
             vsTitl := NULL;
             vsSubj := NULL;
             vsCrse := NULL;
     END;

  END p_ObtieneDatosCrn;


  -- muestra la informacin de las clases y eventos:
  PROCEDURE P_InformacionCurso ( psInicio   VARCHAR2  DEFAULT NULL,
                                 psFin      VARCHAR2  DEFAULT NULL,
                                 psHrI      VARCHAR2  DEFAULT NULL,
                                 psHrF      VARCHAR2  DEFAULT NULL,
                                 psDias     VARCHAR2  DEFAULT NULL ) IS

  BEGIN
     htp.prn ( ''''||
               psInicio ||''','''||
               psFin ||''','''||
               psHrI ||''','''||
               psHrF ||''','''||
               psDias ||''','''||
               vsNombre ||''','''||
               vsSubj ||''','''||
               vsCrse ||''','''||
               vsTitl ||''','''||
               vsLista ||''','''||
               vsTipoLista ||''','''||
               vsCollDesc||vsCollDescEv ||'''' );

  END P_InformacionCurso;


  -- muestra informacin del curso al sobrepasar el cursor del mouse:
  PROCEDURE P_ToolTipText ( psInicio   VARCHAR2  DEFAULT NULL,
                            psFin      VARCHAR2  DEFAULT NULL,
                            psHrI      VARCHAR2  DEFAULT NULL,
                            psHrF      VARCHAR2  DEFAULT NULL,
                            psDias     VARCHAR2  DEFAULT NULL ) IS

  BEGIN

     -- muestra la informacin de ayuda del nrc:
     htp.p('&nbsp;Fecha inicio:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'||psInicio);
     htp.p('&nbsp;Fecha t&eacute;rmino:&nbsp;&nbsp;'||psFin);
     htp.p('&nbsp;Hora inicio:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'||SUBSTR(psHrI,1,2)||':'||SUBSTR(psHrI,3,2)||' hrs.');
     htp.p('&nbsp;Hora t&eacute;rmino:&nbsp;&nbsp;&nbsp;&nbsp;'||SUBSTR(psHrF,1,2)||':'||SUBSTR(psHrF,3,2)||' hrs.');
     htp.p('&nbsp;D&iacute;as:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'||vsDiaSemana);
     -- muestra la informacin de la clase:
     htp.p('&nbsp;Nombre: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'||vsNombre||'&nbsp;');
     htp.p('&nbsp;Saln: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'||vsSalonDes);
     htp.p('&nbsp;Subj: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'||vsSubj);
     htp.p('&nbsp;Crse: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'||vsCrse);
     htp.p('&nbsp;T&iacute;tulo: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'||vsTitl||'&nbsp;');
     htp.p('&nbsp;Lista cruzada: &nbsp;&nbsp;'||vsLista);
     htp.p('&nbsp;Tipo de curso: &nbsp;&nbsp;'||vsTipoLista);
     -- muestra la descripcin, ya sea de la clase o del evento:
     htp.p('&nbsp;Escuela: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'||vscolldesc||vscolldescev||'&nbsp;">');

  END P_ToolTipText;


  -- obtiene los datos de la lista cruzada del crn:
  PROCEDURE p_ObtieneLista ( pnIndex  INTEGER ) IS

  BEGIN
     BEGIN
        SELECT SWRXLST_XLST_GROUP,
               DECODE(SWRXLST_TYPE, 'M', 'Master', 'S', 'Simultneo', 'Independiente')
          INTO vsLista,
               vsTipoLista
          FROM SWRXLST
         WHERE SWRXLST_TERM_CODE = tabRoom(pnIndex).rTerm
           AND SWRXLST_CRN = tabRoom(pnIndex).rCrnn;

     EXCEPTION
        WHEN NO_DATA_FOUND THEN
             vsLista := NULL;
             vsTipoLista := NULL;
        WHEN OTHERS THEN
             vsLista := NULL;
             vsTipoLista := NULL;
     END;
  END p_ObtieneLista;


  -- obtiene la descripcin del saln:
  FUNCTION F_ObtieneSalon ( psRoomCode   VARCHAR2 ) RETURN VARCHAR2 IS

  BEGIN
     BEGIN
        SELECT SLBRDEF_DESC
          INTO vsSalonDes
          FROM SLBRDEF A
         WHERE A.SLBRDEF_ROOM_NUMBER = psRoomCode
           AND A.SLBRDEF_TERM_CODE_EFF = ( SELECT MAX(B.SLBRDEF_TERM_CODE_EFF)
                                             FROM SLBRDEF B
                                            WHERE B.SLBRDEF_ROOM_NUMBER = A.SLBRDEF_ROOM_NUMBER );

     EXCEPTION
        WHEN NO_DATA_FOUND THEN
             vsSalonDes := NULL;
        WHEN TOO_MANY_ROWS THEN
             vsSalonDes := 'Ms de una descripcin para el saln';
        WHEN OTHERS THEN
             vsSalonDes := NULL;
     END;

     RETURN NULL;

  END F_ObtieneSalon;


  -- obtiene la descripcin de la escuela en donde se imparte la clase:
  FUNCTION F_CollCodeDesc ( pnIndex    INTEGER ) RETURN VARCHAR2 IS

  BEGIN
     BEGIN

        SELECT DECODE(SSBOVRR_COLL_CODE, NULL, SCBCRSE_COLL_CODE, SSBOVRR_COLL_CODE)
          INTO vsCollCode
          FROM SCBCRSE A,
               SSBSECT,
               SSBOVRR
         WHERE A.SCBCRSE_SUBJ_CODE = SSBSECT_SUBJ_CODE
           AND A.SCBCRSE_CRSE_NUMB = SSBSECT_CRSE_NUMB
           AND A.SCBCRSE_EFF_TERM = ( SELECT MAX(B.SCBCRSE_EFF_TERM)
                                        FROM SCBCRSE B
                                       WHERE B.SCBCRSE_SUBJ_CODE = A.SCBCRSE_SUBJ_CODE
                                         AND B.SCBCRSE_CRSE_NUMB = A.SCBCRSE_CRSE_NUMB )
           AND SSBSECT_TERM_CODE = SSBOVRR_TERM_CODE(+)
           AND SSBSECT_CRN = SSBOVRR_CRN(+)
           AND SSBSECT_TERM_CODE = tabRoom(pnIndex).rTerm
           AND SSBSECT_CRN = tabRoom(pnIndex).rCrnn;

        SELECT STVCOLL_DESC
          INTO vsCollDesc
          FROM STVCOLL
         WHERE STVCOLL_CODE = vsCollCode;

     EXCEPTION
        WHEN NO_DATA_FOUND THEN
             vsCollDesc := NULL;
             vsCollCode := NULL;
        WHEN OTHERS THEN
             vsCollDesc := NULL;
             vsCollCode := NULL;

     END;

     RETURN NULL;

  END F_CollCodeDesc;


  -- obtiene la descripcin de la escuela del evento:
  FUNCTION F_CollCodeDescEv ( pnIndex    INTEGER ) RETURN VARCHAR2 IS

  BEGIN
     BEGIN

        SELECT SLBEVNT_COLL_CODE
          INTO vsCollCodeEv
          FROM SLBEVNT
         WHERE SLBEVNT_CRN = tabRoom(pnIndex).rCrnn;

        SELECT STVCOLL_DESC
          INTO vsCollDescEv
          FROM STVCOLL
         WHERE STVCOLL_CODE = vsCollCodeEv;

     EXCEPTION
        WHEN NO_DATA_FOUND THEN
             vsCollDescEv := '< Sin Escuela >';
        WHEN OTHERS THEN
             vsCollDescEv := NULL;

     END;

     RETURN NULL;

  END F_CollCodeDescEv;


  -- obtiene y muestra la informacin adicional cuando se trata de una clase:
  PROCEDURE P_Info ( pnIndex           INTEGER,
                     psSalon           VARCHAR2,
                     psHorarioInicio   NUMBER,
                     psHorarioFin      NUMBER ) IS

  CURSOR cuInfo IS

     SELECT TO_CHAR(SS.SSRMEET_START_DATE,'DD-MON-RRRR')                      INICIO,
            TO_CHAR(SS.SSRMEET_END_DATE,'DD-MON-RRRR')                        FIN,
            SS.SSRMEET_BEGIN_TIME                                             HORAI,
            SS.SSRMEET_END_TIME                                               HORAF,
            DECODE(SS.SSRMEET_MON_DAY,'M','Lunes ',    SS.SSRMEET_MON_DAY)||
            DECODE(SS.SSRMEET_TUE_DAY,'T','Martes ',   SS.SSRMEET_TUE_DAY)||
            DECODE(SS.SSRMEET_WED_DAY,'W','Mircoles ',SS.SSRMEET_WED_DAY)||
            DECODE(SS.SSRMEET_THU_DAY,'R','Jueves ',   SS.SSRMEET_THU_DAY)||
            DECODE(SS.SSRMEET_FRI_DAY,'F','Viernes ',  SS.SSRMEET_FRI_DAY)||
            DECODE(SS.SSRMEET_SAT_DAY,'S','Sbado ',   SS.SSRMEET_SAT_DAY)    DIAS,
            SSRMEET_ROOM_CODE                                                 DESSALON
       FROM SSRMEET SS
      WHERE SS.SSRMEET_BLDG_CODE = vsRoomCode
        AND SS.SSRMEET_ROOM_CODE = psSalon
        AND SS.SSRMEET_CRN = tabRoom(pnIndex).rCrnn
        AND TRUNC(TO_DATE(vsDateRoom,'DDMMRRRR')) BETWEEN TRUNC(SS.SSRMEET_START_DATE) AND TRUNC(SS.SSRMEET_END_DATE)
        AND ( psHorarioInicio + 10 BETWEEN TO_NUMBER(SS.SSRMEET_BEGIN_TIME) AND TO_NUMBER(SS.SSRMEET_END_TIME)
              OR
              psHorarioFin - 10 BETWEEN TO_NUMBER(SS.SSRMEET_BEGIN_TIME) AND TO_NUMBER(SS.SSRMEET_END_TIME) )
        AND SS.SSRMEET_MEET_NO = ( SELECT SSRMEET_MEET_NO
                                     FROM SSRMEET S
                                    WHERE S.SSRMEET_CRN = SS.SSRMEET_CRN
                                      AND S.SSRMEET_ROOM_CODE = SS.SSRMEET_ROOM_CODE
                                      AND S.SSRMEET_BLDG_CODE = SS.SSRMEET_BLDG_CODE
                                      AND NVL(S.SSRMEET_SUN_DAY,0) = NVL(SS.SSRMEET_SUN_DAY,0)
                                      AND NVL(S.SSRMEET_MON_DAY,0) = NVL(SS.SSRMEET_MON_DAY,0)
                                      AND NVL(S.SSRMEET_TUE_DAY,0) = NVL(SS.SSRMEET_TUE_DAY,0)
                                      AND NVL(S.SSRMEET_WED_DAY,0) = NVL(SS.SSRMEET_WED_DAY,0)
                                      AND NVL(S.SSRMEET_THU_DAY,0) = NVL(SS.SSRMEET_THU_DAY,0)
                                      AND NVL(S.SSRMEET_FRI_DAY,0) = NVL(SS.SSRMEET_FRI_DAY,0)
                                      AND NVL(S.SSRMEET_SAT_DAY,0) = NVL(SS.SSRMEET_SAT_DAY,0)
                                      AND S.SSRMEET_BEGIN_TIME = SS.SSRMEET_BEGIN_TIME
                                      AND S.SSRMEET_START_DATE = SS.SSRMEET_START_DATE
                                      AND S.SSRMEET_END_DATE = SS.SSRMEET_END_DATE
                                      AND S.SSRMEET_TERM_CODE = SS.SSRMEET_TERM_CODE
                                      AND (SSRMEET_TERM_CODE = tabRoom(pnIndex).rTerm OR tabRoom(pnIndex).rTerm IS NULL) )
        AND (SSRMEET_TERM_CODE = tabRoom(pnIndex).rTerm OR tabRoom(pnIndex).rTerm IS NULL);

  BEGIN

    -- obtiene los datos generales del crn:
    p_ObtieneDatosCrn(pnIndex);

    -- obtiene los datos de la lista cruzada del crn:
    p_ObtieneLista(pnIndex);

    -- asigna un valor a la lista cruzada:
    IF vsTipoLista IS NULL THEN
       vsTipoLista := 'Independiente';
    END IF;

    FOR regInf IN cuInfo LOOP

        -- obtiene la descripcin de la escuela de la clase:
        htp.p(F_CollCodeDesc(pnIndex));

        vsDias := regInf.DIAS;

        -- obtiene la descripcin del saln:
        htp.p(F_ObtieneSalon(reginf.DESSALON));

        htp.prn('<a href="javascript:fMuestraDiv(');

                -- obtiene informacin de la clase:
                P_InformacionCurso ( regInf.INICIO, regInf.FIN, regInf.HORAI, regInf.HORAF, regInf.DIAS );   -- probablemente no trae informacin

        htp.prn(');" onMouseOver="window.status=''''; return true;" onMouseOut="window.status=''''; return true;">');

        -- muestra el encabezado de la ayuda de cada clase:
        htp.p('<font title="DATOS DE LA SESI&Oacute;N (Clase) : ');
        htp.p(' ');

        -- muestra el "tooltip" (ayuda) de cada celda:
        P_ToolTipText ( regInf.INICIO, regInf.FIN, regInf.HORAI, regInf.HORAF, regInf.DIAS );

     END LOOP;

  END P_Info;


  -- obtiene y muestra la informacin adicional cuando se trata de un evento:
  PROCEDURE P_Evento ( pnIndex           INTEGER,
                       psSalon           VARCHAR2,
                       psHorarioInicio   NUMBER,
                       psHorarioFin      NUMBER ) IS

  -- obtiene los datos de los eventos del saln:
  CURSOR cuEvento IS

     SELECT TO_CHAR(SS.SSRMEET_START_DATE,'DD-MON-RRRR')                      INICIO,
            TO_CHAR(SS.SSRMEET_END_DATE,'DD-MON-RRRR')                        FIN,
            SS.SSRMEET_BEGIN_TIME                                             HORAI,
            SS.SSRMEET_END_TIME                                               HORAF,
            DECODE(SS.SSRMEET_MON_DAY,'M','Lunes ',    SS.SSRMEET_MON_DAY)||
            DECODE(SS.SSRMEET_TUE_DAY,'T','Martes ',   SS.SSRMEET_TUE_DAY)||
            DECODE(SS.SSRMEET_WED_DAY,'W','Mircoles ',SS.SSRMEET_WED_DAY)||
            DECODE(SS.SSRMEET_THU_DAY,'R','Jueves ',   SS.SSRMEET_THU_DAY)||
            DECODE(SS.SSRMEET_FRI_DAY,'F','Viernes ',  SS.SSRMEET_FRI_DAY)||
            DECODE(SS.SSRMEET_SAT_DAY,'S','Sbado ',   SS.SSRMEET_SAT_DAY)    DIAS,
            SSRMEET_ROOM_CODE                                                 DESSALON
       FROM SSRMEET SS
      WHERE SS.SSRMEET_BLDG_CODE = vsRoomCode
        AND SS.SSRMEET_ROOM_CODE = psSalon
        AND SS.SSRMEET_CRN = tabRoom(pnIndex).rCrnn
        AND SS.SSRMEET_BEGIN_TIME = tabRoom(pnIndex).rHini
        AND SS.SSRMEET_END_TIME = tabRoom(pnIndex).rHfin
        AND SS.SSRMEET_MON_DAY||SS.SSRMEET_TUE_DAY||SS.SSRMEET_WED_DAY||
            SS.SSRMEET_THU_DAY||SS.SSRMEET_FRI_DAY||SS.SSRMEET_SAT_DAY = tabRoom(pnIndex).rDays
        AND TRUNC(TO_DATE(vsDateRoom,'DDMMRRRR')) BETWEEN TRUNC(SS.SSRMEET_START_DATE) AND TRUNC(SS.SSRMEET_END_DATE)
        AND DECODE(SS.SSRMEET_MON_DAY,'M','Lunes ',    SS.SSRMEET_MON_DAY)||
            DECODE(SS.SSRMEET_TUE_DAY,'T','Martes ',   SS.SSRMEET_TUE_DAY)||
            DECODE(SS.SSRMEET_WED_DAY,'W','Mircoles ',SS.SSRMEET_WED_DAY)||
            DECODE(SS.SSRMEET_THU_DAY,'R','Jueves ',   SS.SSRMEET_THU_DAY)||
            DECODE(SS.SSRMEET_FRI_DAY,'F','Viernes ',  SS.SSRMEET_FRI_DAY)||
            DECODE(SS.SSRMEET_SAT_DAY,'S','Sbado ',   SS.SSRMEET_SAT_DAY) LIKE '%'||vsDiaSemana||'%'
        AND ( psHorarioInicio + 10 BETWEEN TO_NUMBER(SS.SSRMEET_BEGIN_TIME) AND TO_NUMBER(SS.SSRMEET_END_TIME)
              OR
              psHorarioFin - 10 BETWEEN TO_NUMBER(SS.SSRMEET_BEGIN_TIME) AND TO_NUMBER(SS.SSRMEET_END_TIME) )
        AND NVL(SS.SSRMEET_MEET_NO,0) = ( SELECT NVL(SSRMEET_MEET_NO,0)
                                            FROM SSRMEET S
                                           WHERE S.SSRMEET_CRN = SS.SSRMEET_CRN
                                             AND S.SSRMEET_ROOM_CODE = SS.SSRMEET_ROOM_CODE
                                             AND S.SSRMEET_BLDG_CODE = SS.SSRMEET_BLDG_CODE
                                             AND NVL(S.SSRMEET_SUN_DAY,0) = NVL(SS.SSRMEET_SUN_DAY,0)
                                             AND NVL(S.SSRMEET_MON_DAY,0) = NVL(SS.SSRMEET_MON_DAY,0)
                                             AND NVL(S.SSRMEET_TUE_DAY,0) = NVL(SS.SSRMEET_TUE_DAY,0)
                                             AND NVL(S.SSRMEET_WED_DAY,0) = NVL(SS.SSRMEET_WED_DAY,0)
                                             AND NVL(S.SSRMEET_THU_DAY,0) = NVL(SS.SSRMEET_THU_DAY,0)
                                             AND NVL(S.SSRMEET_FRI_DAY,0) = NVL(SS.SSRMEET_FRI_DAY,0)
                                             AND NVL(S.SSRMEET_SAT_DAY,0) = NVL(SS.SSRMEET_SAT_DAY,0)
                                             AND S.SSRMEET_BEGIN_TIME = SS.SSRMEET_BEGIN_TIME
                                             AND S.SSRMEET_START_DATE = SS.SSRMEET_START_DATE
                                             AND S.SSRMEET_END_DATE = SS.SSRMEET_END_DATE
                                             AND S.SSRMEET_TERM_CODE = SS.SSRMEET_TERM_CODE
                                             AND (SSRMEET_TERM_CODE = tabRoom(pnIndex).rTerm or tabRoom(pnIndex).rTerm IS NULL) )
        AND (SSRMEET_TERM_CODE = tabRoom(pnIndex).rTerm OR tabRoom(pnIndex).rTerm IS NULL);


  BEGIN

     -- obtiene los datos generales del crn:
     p_ObtieneDatosCrn(pnIndex);

     FOR regEve IN cuEvento LOOP

         -- obtiene la descripcin de la escuela del evento:
         htp.p(F_CollCodeDescEv(pnIndex));

         vsDias := regEve.Dias;

         -- obtiene la descripcin del saln:
         htp.p(F_ObtieneSalon(regEve.DESSALON));

         htp.prn('<a href="javascript:fMuestraDiv(');

                 -- obtiene informacin del evento:
                 P_InformacionCurso(regEve.INICIO, regEve.FIN, regEve.HORAI, regEve.HORAF, regEve.DIAS);

         htp.prn(');" onMouseOver="window.status=''''; return true;" onMouseOut="window.status=''''; return true;">');

         -- muestra el encabezado de la ayuda de cada evento:
         htp.p('<font title="DATOS DE LA SESI&Oacute;N (Evento) : ');
         htp.p(' ');

         -- muestra el "tooltip" (ayuda) de cada celda:
         P_ToolTipText ( regEve.INICIO, regEve.FIN, regEve.HORAI, regEve.HORAF, regEve.DIAS);

     END LOOP;

  END P_Evento;


  -- obtiene el nrc para el cual se realiz el apartado de la sala, puede ser una una clase o un evento:
  FUNCTION F_CURSOS RETURN VARCHAR2 IS

  CURSOR cuNrcTerm IS

     -- obtiene informacin slo de clases, no de eventos:
     SELECT DISTINCT SSRMEET_CRN    CRNN,
            SSRMEET_TERM_CODE       TERM
       FROM SSRMEET
      WHERE SSRMEET_BLDG_CODE = vsRoomCode
        AND SSRMEET_ROOM_CODE = vsSalon
        AND TO_DATE(vsDateRoom,'DDMMYYYY') >= TRUNC(SSRMEET_START_DATE)
        AND TO_DATE(vsDateRoom,'DDMMYYYY') <= TRUNC(SSRMEET_END_DATE)
        AND INSTR(SSRMEET_SUN_DAY||
                  SSRMEET_MON_DAY||
                  SSRMEET_TUE_DAY||
                  SSRMEET_WED_DAY||
                  SSRMEET_THU_DAY||
                  SSRMEET_FRI_DAY||
                  SSRMEET_SAT_DAY,
                  SUBSTR('MTWRFSU',TO_CHAR(TO_DATE(vsDateRoom,'DDMMYYYY'),'D'),1)) > 0
        AND ( (vnHoraI+10 BETWEEN SSRMEET_BEGIN_TIME AND SSRMEET_END_TIME)
              OR
              (vnHoraF-10 BETWEEN SSRMEET_BEGIN_TIME AND SSRMEET_END_TIME) )
        AND EXISTS (SELECT NULL       -- verifica que el nrc tenga clase asignada, sin importar si tiene o no alumnos inscritos
                      FROM SSBSECT
                     WHERE SSBSECT_TERM_CODE = SSRMEET_TERM_CODE
                       AND SSBSECT_CRN = SSRMEET_CRN);

  CURSOR cuNrc IS

     -- obtiene informacin slo de eventos, no de clases:
     SELECT DISTINCT SSRMEET_CRN  CRNN,
            SSRMEET_TERM_CODE     TERM,
            SSRMEET_BEGIN_TIME    HINI,
            SSRMEET_END_TIME      HFIN,
            SSRMEET_SUN_DAY||
            SSRMEET_MON_DAY||
            SSRMEET_TUE_DAY||
            SSRMEET_WED_DAY||
            SSRMEET_THU_DAY||
            SSRMEET_FRI_DAY||
            SSRMEET_SAT_DAY       DAYS
       FROM SSRMEET
      WHERE SSRMEET_BLDG_CODE = vsRoomCode
        AND SSRMEET_ROOM_CODE = vsSalon
        AND TO_DATE(vsDateRoom,'DDMMYYYY') >= TRUNC(SSRMEET_START_DATE)
        AND TO_DATE(vsDateRoom,'DDMMYYYY') <= TRUNC(SSRMEET_END_DATE)
        AND INSTR(SSRMEET_SUN_DAY||
                  SSRMEET_MON_DAY||
                  SSRMEET_TUE_DAY||
                  SSRMEET_WED_DAY||
                  SSRMEET_THU_DAY||
                  SSRMEET_FRI_DAY||
                  SSRMEET_SAT_DAY,
                  SUBSTR('MTWRFSU',TO_CHAR(TO_DATE(vsDateRoom,'DDMMYYYY'),'D'),1)) > 0
        AND ( (vnHoraI+10 BETWEEN SSRMEET_BEGIN_TIME AND SSRMEET_END_TIME)
              OR
              (vnHoraF-10 BETWEEN SSRMEET_BEGIN_TIME AND SSRMEET_END_TIME) )
        AND EXISTS ( SELECT NULL       -- verifica que el nrc tenga evento asignado
                       FROM SLBEVNT
                      WHERE SLBEVNT_CRN = SSRMEET_CRN );

  BEGIN

     tabRoom(1).rCrnn := NULL;
     tabRoom(1).rTerm := NULL;
     tabRoom(1).rHIni := NULL;
     tabRoom(1).rHFin := NULL;
     tabRoom(1).rDays := NULL;

     vnNrc := 0;

     FOR regCTm IN cuNrcTerm LOOP
         vnNrc := vnNrc + 1;

         tabRoom(vnNrc).rCrnn := regCTm.Crnn;
         tabRoom(vnNrc).rTerm := regCTm.Term;
     END LOOP;

     IF tabRoom(1).rCrnn IS NULL THEN
        FOR regCrn IN cuNrc LOOP
            vnNrc := vnNrc + 1;

            tabRoom(vnNrc).rCrnn := regCrn.Crnn;
            tabRoom(vnNrc).rTerm := regCrn.Term;
            tabRoom(vnNrc).rHIni := regCrn.HIni;
            tabRoom(vnNrc).rHFin := regCrn.HFin;
            tabRoom(vnNrc).rDays := regCrn.Days;
        END LOOP;
     END IF;

     RETURN NULL;

  EXCEPTION
     WHEN OTHERS THEN
          RETURN SQLERRM;

  END F_CURSOS;


  -- si es un evento no existe un registro en ssbsect:
  FUNCTION F_BuscaEvento ( pnIndex   INTEGER ) RETURN INTEGER IS

  BEGIN
     SELECT 1
       INTO vnEvento
       FROM SSBSECT
      WHERE SSBSECT_CRN = tabRoom(pnIndex).rCrnn
        AND SSBSECT_TERM_CODE = tabRoom(pnIndex).rTerm;

     RETURN NULL;

  EXCEPTION
     WHEN NO_DATA_FOUND THEN
          RETURN NULL;
     WHEN OTHERS THEN
          RETURN NULL;

  END F_BuscaEvento;


  -- retorna el nombre del profesor de la materia:
  FUNCTION F_NombreProfesor ( pnIndex   INTEGER ) RETURN VARCHAR2 IS

  BEGIN
     SELECT INITCAP(REPLACE(SPRIDEN_FIRST_NAME||' '||SPRIDEN_LAST_NAME,'*',' '))
       INTO vsNombre
       FROM SPRIDEN, SIRASGN
      WHERE SPRIDEN_PIDM = SIRASGN_PIDM
        AND SPRIDEN_CHANGE_IND IS NULL
        AND SIRASGN_CRN = tabRoom(pnIndex).rCrnn
        AND SIRASGN_TERM_CODE = tabRoom(pnIndex).rTerm
        AND SIRASGN_PRIMARY_IND = 'Y';

     RETURN NULL;

  EXCEPTION
     WHEN NO_DATA_FOUND THEN
          RETURN NULL;
     WHEN OTHERS THEN
          RETURN NULL;

  END F_NombreProfesor;


  -- retorna el nombre del evento:
  FUNCTION F_NombreEvento ( pnIndex    INTEGER ) RETURN VARCHAR2 IS

  BEGIN
     SELECT INITCAP(SLBEVNT_DESC)
       INTO vsNombre
       FROM SLBEVNT
      WHERE SLBEVNT_CRN = tabRoom(pnIndex).rCrnn;

     RETURN NULL;

  EXCEPTION
     WHEN NO_DATA_FOUND THEN
          RETURN NULL;
     WHEN OTHERS THEN
          RETURN NULL;

  END F_NombreEvento;


---------------------------------------------------
-- bloque principal para la generacin del reporte
---------------------------------------------------
BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF PK_Login.F_ValidacionDeAcceso(PK_Login.vgsUSR) THEN RETURN; END IF;

   -- limpia variables:
   tabRoom.DELETE;
   tabSlon.DELETE;

   vsRoomCode := NULL;
   vsDateRoom := NULL;
   vsSeccion  := NULL;

   vsDiaSemana := '';

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsRoomCode := pk_objHtml.getValueCookie('psEdifi');
   vsDateRoom := REPLACE(pk_objHtml.getValueCookie('psFecha'), '/', NULL);
   vsSeccion  := pk_objHtml.getValueCookie('cookSeccion');

   -- obtiene la descripcin del edificio:
   BEGIN
      SELECT STVBLDG_DESC CDESC
        INTO vsRoomDesc
        FROM STVBLDG
       WHERE STVBLDG_CODE = vsRoomCode
       ORDER BY STVBLDG_CODE;

   EXCEPTION
      WHEN OTHERS THEN
           vsRoomDesc := '';
   END;

   -- obtiene el da de la semana a partir del parmetro de fecha:
   BEGIN
      SELECT RTRIM(TO_CHAR(TO_DATE(vsDateRoom,'DD/MM/YYYY'),'Day'),' ')
        INTO vsDiaSemana
        FROM DUAL;

   EXCEPTION
      WHEN OTHERS THEN
           vsDiaSemana := '';
   END;

   IF psDetalle IS NOT NULL THEN

      p_DetalleCurso ( psinicio, psfin, pshri, pshrf, vsDiaSemana, psnombre,
                       pscolldesc, pssubj, pscrsenum, pstit, pslista, pstipolista );
      RETURN;

   END IF;

   -- muestra los encabezados con el nombre de las salas:
   FOR regSal IN cuSalones(vsRoomCode) LOOP
       vnCampo  := vnCampo + 1;
       vnExists := 1;

       tabSlon(vnCampo).rRoomCode := regSal.RoomCode;
       tabSlon(vnCampo).rRoomDesc := regSal.RoomDesc;

   END LOOP;

   IF vnExists = 0 THEN
      htp.p('<tr><th><font color="#ff0000">'||PK_sisRepImp.vgsResultado||'</font></th></tr>');

   ELSE
      IF vnExists = 1 THEN

         -- muestra el encabezado del reporte:
         PK_sisRepImp.P_EncabezadoDeReporte ( psReclDesc, 0,tabColumna, vgsInicoPag, '1', psTitulo=>'Universidad Finis Terrae', psSubtitulo=>'Edificio: &nbsp;'||vsRoomCode||' - '||vsRoomDesc||'<br>'||
                                              'Fecha: &nbsp;'||vsDiaSemana||' - '||TO_CHAR(TO_DATE(vsDateRoom,'DD/MM/YYYY'),'DD/MM/YYYY'), psUsuario=>PK_Login.vgsUSR, psSeccion=>vsSeccion);
         vgsInicoPag := 'SALTO';
         vnExists := 2;

      END IF;

      htp.p(' </table>
              <table border="1" bordercolor="#cccccc">
              <tr><th bgcolor="#ffffff"></th><th bgcolor="#ccffcc">SALA</th> ');

      -- coloca el color en el primer rengln del encabezado verde:
      FOR vnI IN 1..(vnCampo-1) LOOP
          htp.p('<td bgcolor="#ccffcc"></td>');
      END LOOP;

      htp.p('</tr><tr><th bgcolor="#ccccff">HORA</th>');

      -- muestra en el encabezado los nombres de los salones que tienen al menos una hora programada:
      FOR vnI IN 1..vnCampo LOOP
          htp.p('<th align="center" bgcolor="#ccffcc" title="'||tabSlon(vnI).rRoomDesc||'">'||tabSlon(vnI).rRoomCode||'</th>');
      END LOOP;

      htp.p('</tr>');

      -- establece los lmites de las horas a desplegar (7:00 am a 10:00 pm):
      vnHoraI := 700;
      vnHrMax := 2157;

      -- genera los nrc para cada bloque de media hora:
      WHILE vnHoraI < vnHrMax LOOP

            -- incrementa el horario en media hora:
            IF (SUBSTR(TO_CHAR(vnHoraI + vnIncremento,'9999'),4,2) >= '60') THEN
               vnHoraF := vnHoraI + 70;
            ELSE
               vnHoraF := vnHoraI + 30;
            END IF;

            -- muestra los rangos de horas:
            htp.p('<tr><th valign="top" bgcolor="#ccccff">'||SUBSTR(TO_CHAR(vnHoraI,'0009'),2,2)||':'||SUBSTR(TO_CHAR(vnHoraI,'0009'),4,2)||'-'
                                                           ||SUBSTR(TO_CHAR(vnHoraF,'0009'),2,2)||':'||SUBSTR(TO_CHAR(vnHoraF,'0009'),4,2)||'</th>');

            -- obtiene el crn asignado por cada uno de los salones:
            FOR vnI IN 1..vnCampo LOOP
                vsHrI        := NULL;
                vsCollCode   := NULL;
                vsCollCodeEv := NULL;
                vsTitl       := NULL;
                vsSubj       := NULL;
                vsCrse       := NULL;
                vsCollDesc   := NULL;
                vsCollDescEv := NULL;
                vsSalonDes   := NULL;
                vsLista      := NULL;
                vsTipoLista  := NULL;
                vsNombre     := NULL;
                vsDias       := NULL;
                vnEvento     := 0;
                vsSalon      := tabSlon(vnI).rRoomCode;

                htp.p(F_CURSOS);

                -- antepone un cero si la hora es de tres dgitos:
                IF vnHoraI < 1000 THEN
                   vsHrI := '0'||TO_CHAR(vnHoraI);
                END IF;

                -- alnea los datos de cada celda:
                htp.p('<td valign="top" align="center">');

                FOR vnN IN 1..vnNrc LOOP

                    -- si es un evento no existe un registro en ssbsect:
                    htp.p(F_BuscaEvento(vnN));
                    vsDias := NULL;

                    -- si es un evento, se obtiene la informacin adicional:
                    IF vnEvento = 0 THEN

                       -- obtiene el nombre del evento:
                       htp.p(F_NombreEvento(vnn));

                       -- obtiene la descripcin de la escuela:
                       htp.p(F_CollCodeDescEv(vnn));

                       -- si no se encontr en la tabla de eventos, busca si es un docente:
                       IF vsNombre IS NULL THEN
                          htp.p(F_NombreProfesor(vnN));
                       END IF;

                       P_Evento(vnN, tabSlon(vnI).rRoomcode, vnHoraI, vnHoraF);

                       -- si existe un nrc y es una clase se ejecuta el siguiente bloque de cdigo:
                    ELSIF tabRoom(vnN).rCrnn IS NOT NULL AND vnEvento = 1 THEN

                       -- obtiene el nombre del profesor:
                       htp.p(F_NombreProfesor(vnN));
                       p_Info(vnN, tabSlon(vnI).rRoomCode, vnHoraI, vnHoraF);

                    END IF;

                    -- despliega la escuela y el crn en cada celda del detalle:
                    htp.prn(vsCollCode||vsCollCodeEv||' '||tabRoom(vnn).rCrnn||'</font></a><br/>');

                END LOOP;

            END LOOP;

            htp.p('</td></tr>');
            vnHoraI := vnHoraF;

      END LOOP;


      htp.p('</table> <table width="100%" border="0">');

      -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      PK_sisRepImp.vgsSaltoImp := 'Imprime';

      -- omite el encabezado del reporte pero agrega el salto de pgina:
      PK_sisRepImp.P_EncabezadoDeReporte ( psReclDesc, 0, tabColumna, 'PIE', '0', psUsuario=>PK_Login.vgsUSR, psSeccion=>vsSeccion );

      htp.p('</table>');
      htp.p('<script language="JavaScript"><!--');

      htp.p('function fIniciarVentana(){
      frmLOVcur = window.open("","winCursos","toolbar=no,menubar=no,directories=no,status=no,resizable=no,location=no,scrollbars=no,width=0,height=0");

      frmLOVcur.resizeTo(10,10)
      frmLOVcur.moveTo(0,0);

      if (frmLOVcur.opener == null) {
      frmLOVcur.opener = self;
      }

      frmLOVcur.close();
      }');

      htp.p('function fMuestraDiv(psInicio, psFin, psHrI, psHrF, psDias, psNombre, psSubj, psCrseNum, psTit, psLista, psTipoLista, psCollDesc){
      document.frmInforma.psInicio.value = psInicio;
      document.frmInforma.psFin.value = psFin;
      document.frmInforma.psHrI.value = psHrI;
      document.frmInforma.psHrF.value = psHrF;
      document.frmInforma.psDias.value = psDias;
      document.frmInforma.psNombre.value = psNombre;
      document.frmInforma.psCollDesc.value = psCollDesc;
      document.frmInforma.psSubj.value = psSubj;
      document.frmInforma.psCrseNum.value = psCrseNum;
      document.frmInforma.psTit.value = psTit;
      document.frmInforma.psLista.value = psLista;
      document.frmInforma.psTipoLista.value = psTipoLista;

      frmLOVcur.close();

      frmLOVcur = window.open("","winCursos","toolbar=no,menubar=no,directories=no,status=no,resizable=no,location=no,scrollbars=no,screenX=0,screenY=0,width=300,height=300");

      if (frmLOVcur.opener == null) {
      frmLOVcur.opener = self;
      }

      window.status = "";
      frmLOVcur.moveTo(0,0);

      // establece el tiempo en que estar activo el "tooltip" con informacin del crn:
      setTimeout("fMuestraInf()",10000);

      }');

      -- despliega la informacin de ayuda del crn:
      htp.p('function fMuestraInf() {
      document.frmInforma.submit();
      }

      fIniciarVentana();
      ');

      htp.p('//--></script>');

      htp.p('<form name="frmInforma" action="PWRDOMN" method="post" target="winCursos">
                   <input type="hidden" name="psReclDesc" value="'||psReclDesc||'" />
                   <input type="hidden" name="psInicio" />
                   <input type="hidden" name="psFin" />
                   <input type="hidden" name="psHrI" />
                   <input type="hidden" name="psHrF" />
                   <input type="hidden" name="psDias" />
                   <input type="hidden" name="psNombre" />
                   <input type="hidden" name="psCollDesc" />
                   <input type="hidden" name="psSubj" />
                   <input type="hidden" name="psCrseNum" />
                   <input type="hidden" name="psTit" />
                   <input type="hidden" name="psLista" />
                   <input type="hidden" name="psTipoLista" />
                   <input type="hidden" name="psDetalle" value="X" />
             </form>
             </body></html>');

   END IF;

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRDOMN;
/


DROP PUBLIC SYNONYM PWRDOMN;

CREATE PUBLIC SYNONYM PWRDOMN FOR BANINST1.PWRDOMN;


GRANT EXECUTE ON BANINST1.PWRDOMN TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRDOMN TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRDRFY;

CREATE OR REPLACE PROCEDURE BANINST1.PWRDRFY( psReclDesc   VARCHAR2 ) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte del directorio de
                profesores.
     propsito: obtener la informacin general de los profesores activos en
                un periodo determinado.
        mdulo: profesores - uft.
         autor: hmr - horacio martnez ramrez.
         fecha: 20/09/2010.

  modificacin: 27/07/2011 - hmr.
                se elimin el parmetro universidad y la columna de fecha de
                nacimiento, se cambi el nombre del parmetro tipo por tipo
                de personal, se agregaron los valores de los parmetros en el
                encabezado, se aplic el estndar para los reportes de uft y
                se configur la opcin para el envo a excel.
modificacin:   08/11/2013 - agm.
*******************************************************************************/


  -- declaracin de variables:
  vnRow          INTEGER      := 0;
  vnExists       INTEGER      := 0;
  vnColumnas     INTEGER      := 22;
  vnEmailPr      INTEGER      := 0;
  tabColumna     PK_sisRepImp.tipoTabla         := PK_sisRepImp.tipoTabla(1);
  vsTipo         SIBINST.SIBINST_FSTP_CODE%TYPE := NULL;
  vsEscu         SIRDPCL.SIRDPCL_COLL_CODE%TYPE := NULL;
  vsPerio        VARCHAR2(6)  := NULL;
  vsSeccion      VARCHAR2(3)  := NULL;
  vsUnive        VARCHAR2(6)  := NULL;
  vsPeriodo      VARCHAR2(6)  := NULL;
  vsID           VARCHAR2(10) := NULL;
  vsEncabezado   VARCHAR2(1)  := NULL;
  vsSede         VARCHAR2(10) := NULL;
  vsInicioPag    VARCHAR2(10) := NULL;
  vbEncabezado   BOOLEAN      := TRUE;


  -- obtiene informacin de los profesores:
  CURSOR cuReporte( psUnive  VARCHAR2  DEFAULT NULL,
                    psPerio  VARCHAR2  DEFAULT NULL,
                    psEscu   VARCHAR2  DEFAULT NULL,
                    psTipo   VARCHAR2  DEFAULT NULL,
                    psSede   VARCHAR2  DEFAULT NULL ) IS

         SELECT A.SIBINST_TERM_CODE_EFF                                                      CVEPERIODO,
                NVL(EsclSede.CVEESCUELA,'SE')                                                CVEESCUELA,
                PK_Catalogo.Colegio(EsclSede.CVEESCUELA)                                     DESCESCUELA,
                A.SIBINST_PIDM                                                               PIDM,
                DECODE(A.SIBINST_SCHD_IND, 'Y', 'Y')                                          DOCENTE,
                DECODE(A.SIBINST_ADVR_IND, 'Y', 'Y')                                          ASESOR,
                (SELECT STVFCTG_DESC FROM STVFCTG WHERE SIBINST_FCTG_CODE = STVFCTG_CODE)      CATEGORIA,
                (SELECT STVFSTP_DESC FROM STVFSTP WHERE SIBINST_FSTP_CODE = STVFSTP_CODE)    TIPO_PERSONAL,
                SPRIDEN_ID                                                                   ID,
                F_GET_RUT(SPRIDEN_PIDM)                                                      RUT,
                REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME,'*',' ')                  NOMBRE,
                DECODE(SPBPERS_SEX,'F','FEMENINO','M','MASCULINO','N','NO DEFINIDO')         SEXO,
                SPBPERS_MRTL_CODE                                                            CVEESTADOCIVIL,
                UPPER(PK_Catalogo.EdoCivil(SPBPERS_MRTL_CODE))                               DESCESTADOCIVIL,
                 (SELECT STVCOLL_DESC FROM STVCOLL,SIRDPCL WHERE SIRDPCL_COLL_CODE = STVCOLL_CODE
                AND SIRDPCL_PIDM = SIBINST_PIDM
                AND SIRDPCL_HOME_IND = 'Y'
                AND ROWNUM = 1) ESCUELA,
                  (SELECT MIN(B.SIBINST_TERM_CODE_EFF) FROM SIBINST B
               WHERE B.SIBINST_PIDM = A.SIBINST_PIDM) PERIODO_INGRESO,
               (SELECT STVFCST_DESC FROM STVFCST
               WHERE SIBINST_FCST_CODE = STVFCST_CODE) STATUS,
                (SELECT STVETHN_DESC FROM STVETHN WHERE STVETHN_CODE = SPBPERS_ETHN_CODE)    NACIONALIDAD,
                SPBPERS_BIRTH_DATE                                                             NACIMIENTO,
                (SELECT  REPLACE(GOREMAL_EMAIL_ADDRESS, 'Cl@ve_inicial.:','')
                 FROM  GOREMAL
                              WHERE  GOREMAL_PIDM = SPRIDEN_PIDM
                              AND GOREMAL_EMAL_CODE = '0001')                                      claveInicial,
                REPLACE(SPRADDR_STREET_LINE2, 'Clave de Impresin:', '')                            CALLE,
--                (SELECT SPRADDR_STREET_LINE1 FROM SPRADDR
--               WHERE SPRADDR_PIDM = SPRIDEN_PIDM AND SPRADDR_ATYP_CODE = 'PR')               Direccion,
                (SELECT SPRADDR_STREET_LINE1 FROM SPRADDR
                WHERE SPRADDR_PIDM = SPRIDEN_PIDM AND SPRADDR_ATYP_CODE = 'PR'
                AND ROWNUM = 1)                                                              Direccion,
                REPLACE(PK_Catalogo.CNTY((SELECT SPRADDR_CNTY_CODE FROM SPRADDR
                WHERE SPRADDR_PIDM = SPRIDEN_PIDM
                AND SPRADDR_ATYP_CODE = 'PR' AND ROWNUM = 1)),'*',' * ')                       MUNICIPIO,
                REPLACE(PK_Catalogo.Estado((SELECT SPRADDR_STAT_CODE FROM SPRADDR
                WHERE SPRADDR_PIDM = SPRIDEN_PIDM
                AND SPRADDR_ATYP_CODE = 'PR' AND ROWNUM = 1)),'*',' * ')                     REGION,
                (SELECT SPRADDR_ZIP FROM SPRADDR
                    WHERE SPRADDR_PIDM = SPRIDEN_PIDM
                    AND SPRADDR_ATYP_CODE = 'PR'
                    AND SPRADDR_ZIP IS NOT NULL AND ROWNUM = 1)                             CP,
                SPRADDR_NATN_CODE                                                            CVEPAIS,
                UPPER(PK_Catalogo.Pais(SPRADDR_NATN_CODE))                                   DESCPAIS,
                NVL( ( SELECT COUNT(1)
                         FROM SPRADDR E
                        WHERE E.SPRADDR_PIDM        = A.SIBINST_PIDM
                        --and e.spraddr_atyp_code  in ('pr','bu','fi')
                          AND E.SPRADDR_STATUS_IND IS NULL
                          AND E.SPRADDR_SEQNO       = (SELECT MAX(F.SPRADDR_SEQNO)
                                                         FROM SPRADDR F
                                                        WHERE F.SPRADDR_PIDM        = E.SPRADDR_PIDM
                                                          AND F.SPRADDR_ATYP_CODE   = E.SPRADDR_ATYP_CODE
                                                          AND F.SPRADDR_STATUS_IND IS NULL) ),
                    1 )                                                                      DIRECCIONES
           FROM SIBINST A,
                SPRADDR C,
                SPBPERS D,
                ( SELECT SIRDPCL_PIDM        AS PIDM,
                         SIRDPCL_COLL_CODE   AS CVEESCUELA,
                         SIRDPCL_DEPT_CODE   AS deptSede
                    FROM SIRDPCL A
                   WHERE SIRDPCL_HOME_IND      = 'Y'
                     AND SIRDPCL_TERM_CODE_EFF = (SELECT MAX(SI.SIRDPCL_TERM_CODE_EFF)
                                                   FROM SIRDPCL SI
                                                  WHERE SI.SIRDPCL_PIDM = A.SIRDPCL_PIDM)
                )                                                                            EsclSede,
                SPRIDEN
          WHERE A.SIBINST_TERM_CODE_EFF  = ( SELECT MAX(SB.SIBINST_TERM_CODE_EFF)
                                               FROM SIBINST SB
                                              WHERE SB.SIBINST_PIDM           = A.SIBINST_PIDM
                                                AND SB.SIBINST_TERM_CODE_EFF <= psPerio )
            AND A.SIBINST_FCST_CODE      = 'AC'
            AND A.SIBINST_PIDM           = C.SPRADDR_PIDM(+)
            AND C.SPRADDR_ATYP_CODE     IN ('MA')
            AND C.SPRADDR_STATUS_IND    IS NULL
            AND A.SIBINST_PIDM           = D.SPBPERS_PIDM(+)
            AND A.SIBINST_PIDM           = EsclSede.PIDM(+)
            AND A.SIBINST_PIDM           = SPRIDEN_PIDM
            AND SPRIDEN_CHANGE_IND      IS NULL
             AND (EsclSede.CVEESCUELA     = psEscu OR psEscu IS NULL)
            AND (A.SIBINST_FSTP_CODE     = psTipo OR psTipo IS NULL)
            AND (EsclSede.deptSede       = psSede OR psSede IS NULL)
          ORDER BY CVEPERIODO DESC, DESCESCUELA, NOMBRE;

  -- cursor de correos: --Correo Electrnico
  CURSOR cuEmailPR(pnPidm  NUMBER) IS

         SELECT GOREMAL_EMAIL_ADDRESS    CORREO
           FROM GOREMAL
          WHERE GOREMAL_PIDM           = pnPidm
            AND GOREMAL_EMAL_CODE     IN ('UFT','PERS')
            AND GOREMAL_STATUS_IND     = 'A'
            AND GOREMAL_EMAIL_ADDRESS IS NOT NULL;

  -- cursor de correos:
  CURSOR cuEmail(pnPidm NUMBER) IS

         SELECT A.GOREMAL_EMAIL_ADDRESS    CORREO
           FROM GOREMAL A
          WHERE A.GOREMAL_PIDM           = pnPidm
            AND A.GOREMAL_EMAL_CODE     IN ('UFT','PERS')
            AND A.GOREMAL_STATUS_IND     = 'A'
            AND A.GOREMAL_EMAIL_ADDRESS IS NOT NULL
            AND A.GOREMAL_ACTIVITY_DATE  = ( SELECT MAX(B.GOREMAL_ACTIVITY_DATE)
                                               FROM GOREMAL B
                                              WHERE B.GOREMAL_PIDM       = pnPidm
                                                AND B.GOREMAL_EMAL_CODE IN ('UFT','PERS')
                                                AND B.GOREMAL_STATUS_IND = 'A' );

  -- cursor de telfonos:
  CURSOR cuTelfn(pnPidm NUMBER) IS

         SELECT SPRTELE_PHONE_AREA||' '||SPRTELE_PHONE_NUMBER||' '||SPRTELE_PHONE_EXT           AS TELEFONO_ANT,
                DECODE(SPRTELE_PHONE_AREA, NULL, '', '('||SPRTELE_PHONE_AREA||') ')||
                SPRTELE_PHONE_NUMBER||
                DECODE(SPRTELE_PHONE_EXT, NULL, '', (' EXT. '||SPRTELE_PHONE_EXT) )             AS TELEFONO
           FROM SPRTELE A
          WHERE A.SPRTELE_PIDM          = pnPidm
--          and a.sprtele_tele_code    in ('pr','bu','fi')
            AND A.SPRTELE_STATUS_IND   IS NULL
            AND A.SPRTELE_PHONE_NUMBER IS NOT NULL;


---------------------------------------------------
-- bloque principal para la generacin del reporte
---------------------------------------------------
BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF PK_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsUnive      := pk_objhtml.getValueCookie('psUnive');
   vsPerio      := pk_objhtml.getValueCookie('psPerio');
   vsEscu       := pk_objhtml.getValueCookie('psEscu');
   vsTipo       := pk_objhtml.getValueCookie('psType');
   vsEncabezado := pk_objhtml.getValueCookie('psEnca');
   vsSeccion    := pk_objhtml.getValueCookie('cookSeccion');
   vsSede       := pk_objhtml.getValueCookie('psDept');

   -- determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   -- define los encabezados de las columnas:
   tabColumna(1)   := '<center><font size="1"> ID </font>';
   tabColumna(2)   := '<center> <font size="1">RUT </font>';
   tabColumna(3)   := '<center> <font size="1">Profesor </font>';
   tabColumna(4)   := '<center> <font size="1">Sexo </font>';
   tabColumna(5)   := '<center> <font size="1">Nacionalidad </font>';
   tabColumna(6)   := '<center> <font size="1">Estado civil </font>';
   tabColumna(7)   := '<center> <font size="1">Fecha Nacimiento</font>';
   tabColumna(8)   := '<center> <font size="1">Tel&eacute;fono</font>';
   tabColumna(9)   := '<center> <font size="1">Correo electr&oacute;nico</font>';
   tabColumna(10)  := '<center><font size="1"> Claves Correo e Impresi&oacute;n</font>';
   tabColumna(11)  := '<center><font size="1"> Direcci&oacute;n</font>';
   tabColumna(12)  := '<center><font size="1"> Comuna</font>';
   tabColumna(13)  := '<center> <font size="1">Regi&oacute;n</font>';
   tabColumna(14)  := '<left><font size="1"> C&oacute;digo Postal</font>';
   tabColumna(15)  := '<center> <font size="1">Pa&iacute;s</font>';
   tabColumna(16)  := '<center> <font size="1">Descripci&oacute;n Escuela</font>';
   tabColumna(17)  := '<center> <font size="1">Periodo Ingreso</font>';
   tabColumna(18)  := '<center> <font size="1">Estatus</font>';
   tabColumna(19)  := '<center> <font size="1">Docente</font>';
   tabColumna(20)  := '<center> <font size="1">Asesor</font>';
   tabColumna(21)  := '<center> <font size="1">Categor&iacute;a</font>';
   tabColumna(22)  := '<center> <font size="1">Tipo de Personal</font>';

   -- manipula la informacin obtenida por el cursor:
   FOR regRep IN cuReporte( vsUnive, vsPerio, vsEscu, vsTipo, vsSede ) LOOP

       -- muestra el encabezado segn el periodo y escuela seleccionados:
       IF (vsPeriodo IS NULL OR vsPeriodo <> regRep.CVEPERIODO OR vnRow = 15) AND vbEncabezado THEN

          IF vsEscu IS NOT NULL THEN
             IF vsTipo IS NOT NULL THEN
                PK_sisRepImp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vsInicioPag, '1',
                                                   psSubtitulo  =>'Periodo: &nbsp;'||vsPerio||' - '||Pk_Catalogo.Periodo(vsPerio)||'<br>'||'Escuela: &nbsp;'||vsEscu||' - '||Pk_Catalogo.Colegio(vsEscu)||' &nbsp; &nbsp; '||'Tipo: &nbsp;'||vsTipo||' - '||Pk_Catalogo.Tipo(vsTipo),
                                                   psUsuario    =>pk_login.vgsUSR,
                                                   psSeccion    =>vsSeccion,
                                                   psUniversidad=>'UFT');
             ELSE
                PK_sisRepImp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vsInicioPag, '1',
                                                   psSubtitulo  =>'Periodo: &nbsp;'||vsPerio||' - '||Pk_Catalogo.Periodo(vsPerio)||'<br>'||'Escuela: &nbsp;'||vsEscu||' - '||Pk_Catalogo.Colegio(vsEscu)||' &nbsp; &nbsp; '||'Tipo: &nbsp;'||'Todos',
                                                   psUsuario    =>pk_login.vgsUSR,
                                                   psSeccion    =>vsSeccion,
                                                   psUniversidad=>'UFT');
             END IF;
          ELSE
             IF vsTipo IS NOT NULL THEN
                PK_sisRepImp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vsInicioPag, '1',
                                                   psSubtitulo  =>'Periodo: &nbsp;'||vsPerio||' - '||Pk_Catalogo.Periodo(vsPerio)||'<br>'||'Escuela: &nbsp;'||'Todas'||' &nbsp; &nbsp; '||'Tipo: &nbsp;'||vsTipo||' - '||Pk_Catalogo.Tipo(vsTipo),
                                                   psUsuario    =>pk_login.vgsUSR,
                                                   psSeccion    =>vsSeccion,
                                                   psUniversidad=>'UFT');
             ELSE
                PK_sisRepImp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vsInicioPag, '1',
                                                   psSubtitulo  =>'Periodo: &nbsp;'||vsPerio||' - '||Pk_Catalogo.Periodo(vsPerio)||'<br>'||'Escuela: &nbsp;'||'Todas'||' &nbsp; &nbsp; '||'Tipo: &nbsp;'||'Todos',
                                                   psUsuario    =>pk_login.vgsUSR,
                                                   psSeccion    =>vsSeccion,
                                                   psUniversidad=>'UFT');
             END IF;
          END IF;

          vsInicioPag := 'SALTO';
          vnRow := 0;

       END IF;

       IF vsEncabezado = 'N' THEN
          vbEncabezado := FALSE;
       END IF;

       -- muestra los valores para cada registro:
       IF vsID IS NULL OR vsID <> regRep.ID THEN
          htp.p('<tr><td valign="top" valign="'||regRep.DIRECCIONES||'"><font size="1">'||regRep.ID||'</font></td>
                     <td valign="top" valign="'||regRep.DIRECCIONES||'"><font size="1">'||regRep.RUT||'</font></td>
                     <td valign="top" valign="'||regRep.DIRECCIONES||'"><font size="1">'||regRep.NOMBRE||'</font></td>
                     <td valign="top" valign="'||regRep.DIRECCIONES||'"><font size="1">'||regRep.SEXO||'</font></td>
                     <td valign="top" valign="'||regRep.DIRECCIONES||'"><font size="1">'||regRep.NACIONALIDAD||'</font></td>
                     <td valign="top" valign="'||regRep.DIRECCIONES||'"><font size="1">'||regRep.DESCESTADOCIVIL||'</font></td>
                     <td valign="top" valign="'||regRep.DIRECCIONES||'"><font size="1">'||regRep.NACIMIENTO||'</font></td>
                     <td valign="top" valign="'||regRep.DIRECCIONES||'"><font size="1">');

          FOR regTel IN cuTelfn(regRep.PIDM) LOOP
              htp.p(regTel.TELEFONO||'<br>');
          END LOOP;

          htp.p('</font>');

          htp.p( '<td valign="top" valign="'||regRep.DIRECCIONES||'"><font size="1">' );

          FOR regEmail IN cuEmailPR(regRep.PIDM) LOOP
              htp.p(regEmail.CORREO||'<br>');
              vnEmailPr := 1;
          END LOOP;

          htp.p('</font>');

          IF vnEmailPr = 0 THEN
             FOR regEmail IN cuEmail(regRep.PIDM) LOOP
                 htp.p(regEmail.CORREO||'<br>');
             END LOOP;
          END IF;

          htp.p('</td>');
          htp.p('<td valign="top" ><font size="1">'||regRep.claveInicial|| '<br>' ||regRep.CALLE||'</font></td>
              <td valign="top"><font size="1">'||regRep.Direccion||'</font></td>
              <td valign="top"><font size="1">'||regRep.MUNICIPIO||'</font></td>
              <td valign="top"><font size="1">'||regRep.REGION||'</font></td>
              <td valign="top" align="left"><font size="1">'||regRep.CP||'</font></td>
              <td valign="top"><font size="1">'||regRep.DESCPAIS||'</font></td>
              <td valign="top"><font size="1">'||regRep.ESCUELA||'</font></td>
              <td valign="top"><font size="1">'||regRep.PERIODO_INGRESO||'</font></td>
              <td valign="top"><font size="1">'||regRep.STATUS||'</font></td>
              <td valign="top"><font size="1">'||regRep.DOCENTE||'</font></td>
              <td valign="top"><font size="1">'||regRep.ASESOR||'</font></td>
              <td valign="top"><font size="1">'||regRep.CATEGORIA||'</font></td>
              <td valign="top"><font size="1">'||regRep.TIPO_PERSONAL||'</font></td>
              </tr>');

       ELSE
          htp.p('<tr>');
             htp.p('<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
              <td valign="top" ><font size="1">'||regRep.claveInicial|| '<br>' ||regRep.CALLE||'</font></td>
              <td valign="top"><font size="1">'||regRep.Direccion||'</font></td>
              <td valign="top"><font size="1">'||regRep.MUNICIPIO||'</font></td>
              <td valign="top"><font size="1">'||regRep.REGION||'</font></td>
              <td valign="top" align="left"><font size="1">'||regRep.CP||'</font></td>
              <td valign="top"><font size="1">'||regRep.DESCPAIS||'</font></td>
              <td valign="top"><font size="1">'||regRep.ESCUELA||'</font></td>
              <td valign="top"><font size="1">'||regRep.PERIODO_INGRESO||'</font></td>
              <td valign="top"><font size="1">'||regRep.STATUS||'</font></td>
              <td valign="top"><font size="1">'||regRep.DOCENTE||'</font></td>
              <td valign="top"><font size="1">'||regRep.ASESOR||'</font></td>
              <td valign="top"><font size="1">'||regRep.CATEGORIA||'</font></td>
              <td valign="top"><font size="1">'||regRep.TIPO_PERSONAL||'</font></td>
              </tr>');

       END IF;

       vnExists  := 1;
       vnRow     := vnRow + 1;
       vnEmailPr := 0;
       vsID      := regRep.ID;
       vsPeriodo := regRep.CVEPERIODO;

   END LOOP;

   -- muestra el pie del reporte:
   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||PK_sisRepImp.vgsResultado||'</font></th></tr>');
   ELSE
      -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      PK_sisRepImp.vgsSaltoImp := 'Imprime';

      -- omite el encabezado del reporte pero se agrega el salto de pgina:
      PK_sisRepImp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR, psSeccion=>vsSeccion);
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);
        htp.p('<br>');
        htp.p(DBMS_UTILITY.format_error_backtrace);
        htp.p('<br>');
        htp.p('<br>');
END PWRDRFY;
/


DROP PUBLIC SYNONYM PWRDRFY;

CREATE PUBLIC SYNONYM PWRDRFY FOR BANINST1.PWRDRFY;


GRANT EXECUTE ON BANINST1.PWRDRFY TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRDRFY TO WWW2_USER;
DROP PROCEDURE BANINST1.PWREPEG;

CREATE OR REPLACE PROCEDURE BANINST1.PWREPEG (
    psReclDesc            VARCHAR2
) IS
/*************************************************************************************
PROCEDIMIENTO:  PWREPEG
OBJETIVO:            Reporte de Egresados
PARAMETROS:      'psUnive', 'Universidad'
                            'psPerio', 'Periodo'
                            'psEscu', 'Escuela'
psReclDesc            Variable estandar para la maquina de reportes custom
AUTOR:                Alejandra Mungua
FECHA:                2012-12-11
***************************************************************************************/
    --Numero de renglones
    vnRow                PLS_INTEGER := 0;
    --Bandera para mostrar si hubo datos
    vnExists                  INTEGER := 0;
    --Numero de columnas
    vnColumnas            INTEGER := 12;
    --Numero de registros
    vnRegs                   INTEGER := 0;
    --Arreglo (nested table) donde se guardan los encabezados de las columnas
    tabColumna            Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
    -- la variable es una bandera que al tener el valor "imprime" no colocara
    --el salto de pgina para impresion
    vsInicoPag            VARCHAR2(10) := NULL;
    --Nmero de renglones por pgina
    vnRegsPag            PLS_INTEGER := 25;
    --Variable para guardar el periodo deseado
    vsPerio                STVTERM.STVTERM_CODE%TYPE;
    --Variable para guardar la escuela
    vsEscu               VARCHAR2(50);
    --Variable para guardar el programa deseado
    vsUnive              VARCHAR2(50);
     --Fecha del reporte
    vdFecha                DATE;
    -- Indicador Semestral
    vsIndSem             VARCHAR2(5);

    CURSOR cuReporte(
         psUnive  VARCHAR2 DEFAULT 'UFT'
         ,psPerio  VARCHAR2 DEFAULT NULL
         ,psEscu   VARCHAR2 DEFAULT NULL
      ) IS

SELECT DISTINCT(SPBPERS_NAME_SUFFIX)             RUT
                    ,SPRIDEN_ID                              ID
                    ,SPBPERS_LEGAL_NAME              NOMBRE_COMPLETO
                    ,SGBSTDN_TERM_CODE_ADMIT   PERIODO_ADMISION
                    ,SGBSTDN_MAJR_CODE_1              CARRERA
                    ,SGBSTDN_PROGRAM_1                 PLAN_DE_ESTUDIOS
                    ,A.SGBSTDN_TERM_CODE_EFF       PERIODO_DE_EGRESO
                     ,( select round(NVL(sum(a.shrtgpa_gpa*shrtgpa_gpa_hours) / NULLIF (sum(shrtgpa_gpa_hours),0),0),2)
            from shrtgpa a
           where a.shrtgpa_pidm    = sgbstdn_pidm
             and shrtgpa_levl_code = substr(sgbstdn_program_1,1,2)
                    ) PGA
                    ,SGBSTDN_STST_CODE              STATUS
                    ,SGBSTDN_STYP_CODE              TIPO_ALUMNO
                    ,SPBPERS_BIRTH_DATE              FECHA_NACIMIENTO
                    ,SPBPERS_SEX                           SEXO
          FROM SPBPERS, SPRIDEN, SGBSTDN A
        WHERE SPBPERS_PIDM           = SPRIDEN_PIDM
             AND SPBPERS_PIDM           = SGBSTDN_PIDM
             AND SPRIDEN_CHANGE_IND IS NULL
             AND A.SGBSTDN_STST_CODE             = 'EG'
             AND (A.SGBSTDN_CAMP_CODE            = psUnive OR psUnive IS NULL)
             AND (A.SGBSTDN_TERM_CODE_EFF =  psPerio OR psPerio IS NULL)
             AND (A.SGBSTDN_COLL_CODE_1                = psEscu OR psEscu IS NULL)
--             AND A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF) FROM SGBSTDN B
--             								WHERE A.SGBSTDN_PIDM = B.SGBSTDN_PIDM)
    ORDER BY 1,2,3,4,5,6,7,8,9,10,11;

BEGIN
    --HTP.P('PARAMETROS ');
    --Seguridad de GWAMNUR
    IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

    --Obtenemos la Universidad
    vsUnive := pk_objHtml.getValueCookie('psUnive');

    --Obtengo el numero de periodo que se desea para el usuario dado
    vsPerio := pk_objHtml.getValueCookie('psPerio');

    --Obtenemos la escuela
    vsEscu := pk_objHtml.getValueCookie('psEscu');
  --HTP.P('universidad:'||vsUnive||'*periodo:'||vsPerio||'*escu:'||vsEscu);

-- HTP.P('PARAMETROS periodo:'||vsPerio||' escu:'||vsEscu);

 --HTP.P('*periodo:'||psPerio||'*escu:'||psEscu);

    -- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
    tabColumna.EXTEND(vnColumnas);

    --Guardamos los encabezados en el arreglo de columnas
    tabColumna( 1) := 'RUT';
    tabColumna( 2) := 'ID';
    tabColumna( 3) := 'NOMBRE COMPLETO';
    tabColumna( 4) := 'PERIODO ADMISION';
    tabColumna( 5) := 'CARRERA';
    tabColumna( 6) := 'PLAN DE ESTUDIOS';
    tabColumna( 7) := 'PERIODO DE EGRESO';
    tabColumna( 8) := 'PROMEDIO PGA (CAPP)';
    tabColumna( 9) := 'STATUS';
    tabColumna(10) := 'TIPO ALUMNO';
    tabColumna(11) := 'FECHA NACIMIENTO';
    tabColumna(12) := 'SEXO';

    --Inicializamos contador de renglones
    vnRow := 0;

    FOR regReporte IN cuReporte(vsUnive, vsPerio, vsEscu) LOOP

        --Incremento el contador de renglones
        vnRow := vnRow + 1;
        vnExists := 1; --Bandera para indicar que hubo resultados

        --Si es el primer renglon de cada pgina...
        IF MOD(vnRow, vnRegsPag) = 1  THEN
            --imprimo el encabezado de reporte
            Pk_Sisrepimp.P_EncabezadoDeReporte(
                psReclDesc ,vnColumnas ,tabColumna
                ,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
            );
            vsInicoPag := 'SALTO';
        END IF;

        --Comienzo a desplegar el renglon
        HTP.P('<tr>');

        HTP.P('<td>'||regReporte.RUT||'</td>');
        HTP.P('<td>'||regReporte.ID||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.NOMBRE_COMPLETO ||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.PERIODO_ADMISION ||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.CARRERA ||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.PLAN_DE_ESTUDIOS ||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.PERIODO_DE_EGRESO ||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.PGA ||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.STATUS ||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.TIPO_ALUMNO ||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.FECHA_NACIMIENTO ||'</td>');
        HTP.P('<td style="text-align:left;">'||regReporte.SEXO ||'</td>');

        --Fin del renglon
        HTP.P('</tr>');

    END LOOP;

    IF vnExists = 0 THEN
        --Ojo esta linea lo que hace es imprimir
        --NO SE ENCONTRARON DATOS o un mensaje similar
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
    ELSE

        -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pagina
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
    END IF;

    --Fin de la pagina
    htp.p('</table><br/></body></html>');
EXCEPTION
    WHEN OTHERS THEN
        --pantallazo de error.
        pk_UtilWeb.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),'PWREPEG', NULL);
END PWREPEG;
/


DROP PUBLIC SYNONYM PWREPEG;

CREATE PUBLIC SYNONYM PWREPEG FOR BANINST1.PWREPEG;


GRANT EXECUTE ON BANINST1.PWREPEG TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWREPEG TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWREPEG TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWREPEG TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRESTC;

CREATE OR REPLACE PROCEDURE BANINST1.PWRESTC (psReclDesc  VARCHAR2) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte estadstico por carrera
                y por colegio.
     propsito: obtener informacin totalizada de postulantes, clasificados
                por colegio y por carrera.
        mdulo: admisiones - uft.
         autor: hmr - horacio martnez ramrez.
         fecha: 20/12/2010.

  modificacin: hmr - 13/09/2011.
                se condicion la obtencin de la dependencia del colegio con
                el ao del periodo selecionado para que no se obtenga ms de
                un registro.
*******************************************************************************/

  -- declaracin de variables:
  vnExists       INTEGER       := 0;
  vnColumnas     INTEGER       := 12;
  vgsInicioPag   VARCHAR2(10)  := NULL;     -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vnIdRenglon    INTEGER       := 1;
  vsColegioAnt   VARCHAR2(200) := NULL;
  vnTotalPostul  INTEGER       := 0 ;
  vnAceptados    INTEGER       := 0 ;
  vnPendientes   INTEGER       := 0 ;
  vnRechazados   INTEGER       := 0 ;
  vnIngConHold   INTEGER       := 0 ;
  vnIngSinHold   INTEGER       := 0 ;
  vsPorcentIng   VARCHAR2(8)   := NULL;

  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);

  vsTerm         SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsCole         SORHSCH.SORHSCH_SBGI_CODE%TYPE       DEFAULT NULL;
  vsTipoA        SARADAP.SARADAP_ADMT_CODE%TYPE       DEFAULT NULL;


  -- obtiene la informacin de los colegios y carreras:
  CURSOR cuReporte ( psTerm   VARCHAR2  DEFAULT NULL,
                     psCole   VARCHAR2  DEFAULT NULL,
                     psTipoA  VARCHAR2  DEFAULT NULL ) IS

     SELECT COLEGIO,
            COMUNA_COL,
            REGION_COL,
            DEPEND_COL,
            CARRERA,
            TOTAL_POSTUL,
            ACEPTADOS,
            PENDIENTES,
            RECHAZADOS,
            ING_CON_HOLD,
            ING_SIN_HOLD,
            TO_CHAR(DECODE(TOTAL_POSTUL,0,'0',TO_CHAR(ROUND((ING_SIN_HOLD*100)/TOTAL_POSTUL, 2))))||' %'   PORCENT_ING
       FROM (SELECT COLEGIO,
                    COMUNA_COL,
                    REGION_COL,
                    DEPEND_COL,
                    CARRERA,
                    SUM(TOTAL_POSTUL)    TOTAL_POSTUL,
                    SUM(ACEPTADOS)       ACEPTADOS,
                    SUM(PENDIENTES)      PENDIENTES,
                    SUM(RECHAZADOS)      RECHAZADOS,
                    SUM(ING_CON_HOLD)    ING_CON_HOLD,
                    SUM(ING_SIN_HOLD)    ING_SIN_HOLD
               FROM ( SELECT UPPER(PK_CATALOGO.PREPARATORIA(CH.SORHSCH_SBGI_CODE))       COLEGIO,
                             (SELECT SUBSTR( STVCNTY_DESC, 7, LENGTH(STVCNTY_DESC))
                                FROM SOBSBGI, STVCNTY
                               WHERE SOBSBGI_CNTY_CODE = STVCNTY_CODE
                                 AND SOBSBGI_SBGI_CODE = CH.SORHSCH_SBGI_CODE)           COMUNA_COL,
                             (SELECT SOBSBGI_STAT_CODE FROM SOBSBGI
                               WHERE SOBSBGI_SBGI_CODE = CH.SORHSCH_SBGI_CODE)           REGION_COL,
                             (SELECT UPPER(ST.STVBCHR_DESC)
                                FROM SORBCHR HR, STVBCHR ST
                               WHERE HR.SORBCHR_BCHR_CODE = ST.STVBCHR_CODE
                                 AND HR.SORBCHR_SBGI_CODE = CH.SORHSCH_SBGI_CODE
                                 AND HR.SORBCHR_DEMO_YEAR = SUBSTR(psTerm,1,4)
                                 AND ST.STVBCHR_CODE <> 'L' )                            DEPEND_COL,
                             SA.SARADAP_PROGRAM_1                                        CARRERA,
                             SA.SARADAP_ADMT_CODE                                        TIPO_ADMISION,
                             (SELECT COUNT(*) FROM SARAPPD
                               WHERE SARAPPD_TERM_CODE_ENTRY = psTerm
                                 AND SARAPPD_PIDM = CH.SORHSCH_PIDM)                     TOTAL_POSTUL,
                             (SELECT COUNT(*) FROM SARAPPD
                               WHERE SARAPPD_TERM_CODE_ENTRY = psTerm
                                 AND SARAPPD_APDC_CODE = 'AC'
                                 AND SARAPPD_PIDM = CH.SORHSCH_PIDM)                     ACEPTADOS,
                             (SELECT COUNT(*) FROM SARAPPD
                               WHERE SARAPPD_TERM_CODE_ENTRY = psTerm
                                 AND SARAPPD_APDC_CODE = 'PE'
                                 AND SARAPPD_PIDM = CH.SORHSCH_PIDM)                     PENDIENTES,
                             (SELECT COUNT(*) FROM SARAPPD
                               WHERE SARAPPD_TERM_CODE_ENTRY = psTerm
                                 AND SARAPPD_APDC_CODE = 'RE'
                                 AND SARAPPD_PIDM = CH.SORHSCH_PIDM)                     RECHAZADOS,
                             (SELECT COUNT(*) FROM SARAPPD, SPRHOLD HD
                               WHERE SARAPPD_TERM_CODE_ENTRY = psTerm
                                 AND SARAPPD_APDC_CODE = 'IN'
                                 AND SARAPPD_PIDM = CH.SORHSCH_PIDM
                                 AND HD.SPRHOLD_HLDD_CODE = 'MA'
                                 AND SARAPPD_PIDM = HD.SPRHOLD_PIDM)                     ING_CON_HOLD,
                             (SELECT COUNT(*) FROM SARAPPD, SPRHOLD HD
                               WHERE SARAPPD_TERM_CODE_ENTRY = psTerm
                                 AND SARAPPD_APDC_CODE = 'IN'
                                 AND SARAPPD_PIDM = CH.SORHSCH_PIDM
                                 AND HD.SPRHOLD_HLDD_CODE <> 'MA'
                                 AND SARAPPD_PIDM = HD.SPRHOLD_PIDM)                     ING_SIN_HOLD
                        FROM SPRIDEN  SP,
                             SARADAP  SA,
                             SORHSCH  CH,
                             SARAPPD  PD
                       WHERE SP.SPRIDEN_CHANGE_IND IS NULL
                         AND SP.SPRIDEN_PIDM = SA.SARADAP_PIDM
                         AND SA.SARADAP_PIDM = PD.SARAPPD_PIDM
                         AND SA.SARADAP_PIDM = CH.SORHSCH_PIDM
                         AND SA.SARADAP_APPL_NO = (SELECT MAX(SARADAP_APPL_NO)
                                                     FROM SARADAP
                                                    WHERE SARADAP_PIDM = SA.SARADAP_PIDM)
                         AND SA.SARADAP_TERM_CODE_ENTRY = psTerm
                         AND (CH.SORHSCH_SBGI_CODE = psCole or psCole IS NULL)
                         AND (SA.SARADAP_ADMT_CODE = psTipoA OR psTipoA IS NULL) )
              GROUP BY COLEGIO, COMUNA_COL, REGION_COL, DEPEND_COL, CARRERA
              ORDER BY COLEGIO, COMUNA_COL, REGION_COL, DEPEND_COL, CARRERA );


---------------------------------------------------
-- bloque principal para la generacin del reporte
---------------------------------------------------
BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
   vsCole  := pk_ObjHtml.getValueCookie('psCole');
   vsTipoA := pk_ObjHtml.getValueCookie('psTipoA');

   -- determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   -- define los encabezados de las columnas:
   tabColumna(1)  := '<center> Nombre colegio';
   tabColumna(2)  := '<center> Comuna colegio';
   tabColumna(3)  := '<center> Regi&oacute;n colegio';
   tabColumna(4)  := '<center> Dependencia colegio';
   tabColumna(5)  := '<center> Carrera';
   tabColumna(6)  := '<center> Total postulantes';
   tabColumna(7)  := '<center> Aceptados';
   tabColumna(8)  := '<center> Pendientes';
   tabColumna(9)  := '<center> Rechazados';
   tabColumna(10) := '<center> Ingresados con hold';
   tabColumna(11) := '<center> Ingresados sin hold';
   tabColumna(12) := '<center> Ingresados sin hold <br> respecto a postulantes ( % )';

   -- manipula la informacin obtenida por el cursor:
   FOR regRep IN cuReporte (vsTerm, vsCole, vsTipoA) LOOP

       IF vnExists = 0 THEN

          -- muestra el encabezado segn el periodo y tipo de admisin:
          IF vsTipoA IS NOT NULL THEN
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||', &nbsp; &nbsp;'||'Tipo de admisin: &nbsp;'||vsTipoA||' - '||Pk_Catalogo.Admision(vsTipoA),
                                                psUniversidad => 'UFT');
          ELSE
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||', &nbsp; &nbsp;'||'Tipo de admisin: &nbsp;'||'Todos',
                                                psUniversidad => 'UFT');
          END IF;

          vgsInicioPag := 'SALTO';
          vsColegioAnt := regRep.COLEGIO;

       END IF;

       IF (vsColegioAnt <> regRep.COLEGIO) OR (vsColegioAnt IS NOT NULL AND regRep.COLEGIO IS NULL) THEN

          -- muestra el registro de totales por colegio:
          htp.p('<tr bgcolor="darkgray">
                    <font color="#ff6666">
                         <b><td valign="center" colspan="5" align="left"><b> &nbsp; &nbsp; '||'T O T A L '||'&nbsp; [ &nbsp;'||vsColegioAnt||'&nbsp; ] &nbsp; : &nbsp;</b></td>
                            <td valign="center" align="center"><b>'||vnTotalPostul||'</b></td>
                            <td valign="center" align="center"><b>'||vnAceptados  ||'</b></td>
                            <td valign="center" align="center"><b>'||vnPendientes ||'</b></td>
                            <td valign="center" align="center"><b>'||vnRechazados ||'</b></td>
                            <td valign="center" align="center"><b>'||vnIngConHold ||'</b></td>
                            <td valign="center" align="center"><b>'||vnIngSinHold ||'</b></td>
                            <td valign="center" align="center"><b>'||vsPorcentIng ||'</b></td>
                         </b>
                    </font>
                 </tr>');

          vnTotalPostul := 0;
          vnAceptados   := 0;
          vnPendientes  := 0;
          vnRechazados  := 0;
          vnIngConHold  := 0;
          vnIngSinHold  := 0;

      END IF;

      -- muestra los valores para cada registro:
      htp.p('<tr><td valign="top" align="left">'  ||regRep.COLEGIO     ||'</td>
                 <td valign="top" align="left">'  ||regRep.COMUNA_COL  ||'</td>
                 <td valign="top" align="left">'  ||regRep.REGION_COL  ||'</td>
                 <td valign="top" align="left">'  ||regRep.DEPEND_COL  ||'</td>
                 <td valign="top" align="left">'  ||regRep.CARRERA     ||'</td>
                 <td valign="top" align="center">'||regRep.TOTAL_POSTUL||'</td>
                 <td valign="top" align="center">'||regRep.ACEPTADOS   ||'</td>
                 <td valign="top" align="center">'||regRep.PENDIENTES  ||'</td>
                 <td valign="top" align="center">'||regRep.RECHAZADOS  ||'</td>
                 <td valign="top" align="center">'||regRep.ING_CON_HOLD||'</td>
                 <td valign="top" align="center">'||regRep.ING_SIN_HOLD||'</td>
                 <td valign="top" align="center">'||regRep.PORCENT_ING ||'</td>
             </tr>');

      -- incrementa los contadores:
      vnTotalPostul := vnTotalPostul + regRep.TOTAL_POSTUL;
      vnAceptados   := vnAceptados   + regRep.ACEPTADOS;
      vnPendientes  := vnPendientes  + regRep.PENDIENTES;
      vnRechazados  := vnRechazados  + regRep.RECHAZADOS;
      vnIngConHold  := vnIngConHold  + regRep.ING_CON_HOLD;
      vnIngSinHold  := vnIngSinHold  + regRep.ING_SIN_HOLD;

      IF vnIngSinHold = 0 THEN
         vsPorcentIng := '0 %';
      ELSE
         vsPorcentIng := TO_CHAR(ROUND(((vnIngSinHold*100)/vnTotalPostul),2))||' %';
      END IF;

      vsColegioAnt := regrep.COLEGIO;
      vnExists     := 1;
      vnIdRenglon  := vnIdRenglon + 1;

   END LOOP;

   IF vnIdRenglon > 1 THEN

      -- muestra el registro de totales por colegio (ltimo registro):
      htp.p('<tr bgcolor="darkgray">
                <font color="#ff6666">
                     <b><td valign="center" colspan="5" align="left"><b> &nbsp; &nbsp; '||'T O T A L '||'&nbsp; [ &nbsp;'||vsColegioAnt||'&nbsp; ] &nbsp; : &nbsp;</b></td>
                        <td valign="center" align="center"><b>'||vnTotalPostul||'</b></td>
                        <td valign="center" align="center"><b>'||vnAceptados  ||'</b></td>
                        <td valign="center" align="center"><b>'||vnPendientes ||'</b></td>
                        <td valign="center" align="center"><b>'||vnRechazados ||'</b></td>
                        <td valign="center" align="center"><b>'||vnIngConHold ||'</b></td>
                        <td valign="center" align="center"><b>'||vnIngSinHold ||'</b></td>
                        <td valign="center" align="center"><b>'||vsPorcentIng ||'</b></td>
                     </b>
                </font>
             </tr>');
   END IF;

   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- omite el encabezado del reporte pero se agrega el salto de pgina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0',
                                         psUsuario => pk_login.vgsUSR );
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRESTC;
/


DROP PUBLIC SYNONYM PWRESTC;

CREATE PUBLIC SYNONYM PWRESTC FOR BANINST1.PWRESTC;


GRANT EXECUTE ON BANINST1.PWRESTC TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRESTC TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRESTD;

CREATE OR REPLACE PROCEDURE BANINST1.PWRESTD ( psReclDesc    VARCHAR2 ) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte del directorio de alumnos
                por periodo.
     propsito: obtener informacin personal de los alumnos de un periodo
                determinado.
        mdulo: registro estudiantil - uft.
         autor: hmr - horacio martnez ramrez.
         fecha: 06/09/2010.

  modificacin: 08/07/2011 - hmr.
                se agregaron dos campos (sexo y edad), se separ el nombre del
                alumno, se cambi la lista y nombre del parmetro preparatoria
                por colegio, se elimin el parmetro de universidad, se aplic
                el estandar para los reportes de uft y se configur la opcin
                para el envo a excel.
*******************************************************************************/

  vgsInicioPag  VARCHAR2(10)                       := NULL;   -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vnRow         INTEGER                            := 0;
  vnExists      INTEGER                            := 0;
  vnColumnas    INTEGER                            := 15;
  tabColumna    Pk_Sisrepimp.tipoTabla             := Pk_Sisrepimp.tipoTabla(1);
  vsPerio       SIBINST.SIBINST_TERM_CODE_EFF%TYPE := NULL;
  vsProgr       SMRPRLE.SMRPRLE_PROGRAM_DESC%TYPE  := NULL;
  vsColegio     STVSBGI.STVSBGI_DESC%TYPE          := NULL;
  vsTipoAdm     STVADMT.STVADMT_CODE%TYPE          := NULL;
  vsBeca        VARCHAR2(5)                        := NULL;
  vsTitRep      VARCHAR2(50)                       := NULL;
  vsSstst       STVSTST.STVSTST_CODE%TYPE          := NULL;
  vsSeccion     VARCHAR2(3)                        := NULL;
  vsID          VARCHAR2(10)                       := NULL;


  -- obtiene la informacin de los alumnos:
  CURSOR cuReporte ( psPerio    VARCHAR2 DEFAULT NULL,
                     psProgr    VARCHAR2 DEFAULT NULL,
                     psCole     VARCHAR2 DEFAULT NULL,
                     psTipAdm   VARCHAR2 DEFAULT NULL,
                     psBeca     VARCHAR2 DEFAULT NULL ) IS

         SELECT SFBETRM_TERM_CODE                                                       PERIODO,
                A.SGBSTDN_PIDM                                                          PIDM,
                A.SGBSTDN_PROGRAM_1                                                     PROGRAMA,
                UPPER(PK_Catalogo.PROGRAMA(A.SGBSTDN_PROGRAM_1))                        DESPROGRAMA,
                SPRIDEN_ID                                                              ID,
                SPBPERS_NAME_SUFFIX                                                     RUT,
                UPPER(REPLACE(REPLACE(SPRIDEN_LAST_NAME,'*',' * '),'  ',' '))           APE_ALUM,
                UPPER(REPLACE(REPLACE(SPRIDEN_FIRST_NAME||' '||SPRIDEN_MI,
                                      '*',' '),'  ',' '))                               NOM_ALUM,
                DECODE(SPBPERS_SEX,'F','FEMENINO','M','MASCULINO', NULL)                SEXO,
                FLOOR(MONTHS_BETWEEN(SYSDATE,SPBPERS_BIRTH_DATE)/12)                    EDAD,
                Direccion.CALLE                                                         CALLE,
                Direccion.MUNICIPIO                                                     MUNICIPIO,
                Direccion.REGION                                                        REGION,
                Direccion.CODIGO                                                        CODIGO,
                Direccion.PAIS                                                          PAIS,
                A.SGBSTDN_ADMT_CODE                                                     TIPO,
                ( SELECT DISTINCT 'true'
                    FROM TBBESTU
                   WHERE TBBESTU_PIDM = A.SGBSTDN_PIDM )                                BECA,
                NVL(( SELECT COUNT(1)
                        FROM SPRADDR E
                       WHERE E.SPRADDR_SEQNO = ( SELECT MAX(F.SPRADDR_SEQNO)
                                                   FROM SPRADDR F
                                                  WHERE F.SPRADDR_PIDM      = A.SGBSTDN_PIDM
                                                    AND F.SPRADDR_ATYP_CODE = E.SPRADDR_ATYP_CODE
                                                    AND F.SPRADDR_STATUS_IND IS NULL )
                         AND E.SPRADDR_ATYP_CODE IN ('DP', 'AP', 'CA', 'CM',
                                                     'CP', 'CS', 'DA', 'DC',
                                                     'DP', 'EM', 'PM', 'PP',
                                                     'PR', 'PS', 'P1', 'PS',
                                                     'P3', 'P4', 'P5')
                         AND E.SPRADDR_STATUS_IND IS NULL
                         AND E.SPRADDR_PIDM = A.SGBSTDN_PIDM ),1)                       DOMICILIOS
           FROM SGBSTDN A,
                SORHSCH,
                SPRIDEN,
                ( SELECT SPRADDR_PIDM,
                         UPPER('['||SPRADDR_ATYP_CODE||'] '||
                               SPRADDR_STREET_LINE1||' '||
                               SPRADDR_STREET_LINE2||' '||
                               SPRADDR_STREET_LINE3)                               CALLE,
                         REPLACE(PK_Catalogo.CNTY(SPRADDR_CNTY_CODE),'*',' * ')    MUNICIPIO,
                         REPLACE(PK_Catalogo.ESTADO(SPRADDR_STAT_CODE),'*',' * ')  REGION,
                         DECODE(SPRADDR_ZIP,'0','00000',SPRADDR_ZIP)               CODIGO,
                         UPPER(PK_Catalogo.PAIS(SPRADDR_NATN_CODE))                PAIS
                    FROM SPRADDR C
                   WHERE C.SPRADDR_SEQNO = ( SELECT MAX(D.SPRADDR_SEQNO)
                                               FROM SPRADDR D
                                              WHERE D.SPRADDR_PIDM      = C.SPRADDR_PIDM
                                                AND D.SPRADDR_ATYP_CODE = C.SPRADDR_ATYP_CODE
                                                AND D.SPRADDR_STATUS_IND IS NULL )
                     AND C.SPRADDR_ATYP_CODE IN ( 'DP', 'AP', 'CA', 'CM', 'CP',
                                                  'CS', 'DA', 'DC', 'DP', 'EM',
                                                  'PM', 'PP', 'PR', 'PS', 'P1',
                                                  'PS', 'P3', 'P4', 'P5' )
                     AND C.SPRADDR_STATUS_IND IS NULL )                                 DIRECCION,
                SFBETRM,
                SPBPERS
          WHERE EXISTS ( SELECT NULL
                           FROM SFRSTCR
                          WHERE SFRSTCR_TERM_CODE = SFBETRM_TERM_CODE
                            AND SFRSTCR_PIDM      = SFBETRM_PIDM
                            AND SFRSTCR_RSTS_CODE IN ('RE','RW') )
            AND SFBETRM_ESTS_CODE = 'EL'
            AND A.SGBSTDN_TERM_CODE_EFF = ( SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                              FROM SGBSTDN B
                                             WHERE B.SGBSTDN_PIDM = A.SGBSTDN_PIDM )
            AND SFBETRM_PIDM          = A.SGBSTDN_PIDM
            AND A.SGBSTDN_PIDM        = SPRIDEN_PIDM
            AND SPRIDEN_CHANGE_IND    IS NULL
            AND A.SGBSTDN_PIDM        = SORHSCH_PIDM(+)
            AND A.SGBSTDN_STST_CODE   = 'AS'
            AND A.SGBSTDN_PIDM        = Direccion.SPRADDR_PIDM(+)
            AND ( SFBETRM_TERM_CODE   = psPerio  OR psPerio  IS NULL )
            AND ( A.SGBSTDN_PROGRAM_1 = psProgr  OR psProgr  IS NULL )
            AND ( SORHSCH_SBGI_CODE   = psCole   OR psCole   IS NULL )
            AND ( A.SGBSTDN_ADMT_CODE = psTipadm OR psTipadm IS NULL )
            AND A.SGBSTDN_PIDM        = SPBPERS_PIDM(+)
          ORDER BY PROGRAMA, APE_ALUM, NOM_ALUM;


  -- obtiene los distintos correos electrnicos de cada alumno:
  CURSOR cuEmail ( pnPidm   NUMBER ) IS
         SELECT DISTINCT GOREMAL_EMAIL_ADDRESS       EMAIL
           FROM GOREMAL
          WHERE GOREMAL_PIDM          = pnPidm
            AND GOREMAL_EMAL_CODE     IN ('PR', 'PERS', 'INST', 'UFT')
            AND GOREMAL_STATUS_IND    = 'A'
            AND GOREMAL_EMAIL_ADDRESS IS NOT NULL;


---------------------------------------------------
-- bloque principal para la generacin del reporte
---------------------------------------------------
BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(Pk_Login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsPerio   := pk_objHTML.getValueCookie('psPerio');
   vsProgr   := pk_objHTML.getValueCookie('psProgr');
   vsColegio := pk_objHTML.getValueCookie('psCole');
   vsTipoAdm := pk_objHTML.getValueCookie('psTipoA');
   vsBeca    := pk_objHTML.getValueCookie('psSoBec');
   vsSeccion := pk_objHTML.getValueCookie('cookSeccion');

   -- complementa el ttulo del reporte:
   IF vsBeca = 'true' THEN
      vsTitRep := psReclDesc||' '||'( con Beca )';
   ELSE
      vsTitRep := psReclDesc;
   END IF;

   -- determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   -- define los encabezados de las columnas:
   tabColumna(1)  := '<center> Programa';
   tabColumna(2)  := '<center> Descripci&oacute;n';
   tabColumna(3)  := '<center> ID';
   tabColumna(4)  := '<center> RUT';
   tabColumna(5)  := '<center> Apellidos';
   tabColumna(6)  := '<center> Nombre';
   tabColumna(7)  := '<center> Sexo';
   tabColumna(8)  := '<center> Edad';
   tabColumna(9)  := '<center> Tel&eacute;fono';
   tabColumna(10) := '<center> Correo electr&oacute;nico';
   tabColumna(11) := '<center> Direcci&oacute;n';
   tabColumna(12) := '<center> Comuna';
   tabColumna(13) := '<center> Regi&oacute;n';
   tabColumna(14) := '<center> C&oacute;digo postal';
   tabColumna(15) := '<center> Pa&iacute;s';

   -- manipula la informacin obtenida por el cursor:
   FOR regRep IN cuReporte( vsPerio, vsProgr, vsColegio, vsTipoAdm, vsBeca ) LOOP

       -- muestra el encabezado segn los parmetros seleccionados:
       IF vnRow = 0 THEN

          IF vsColegio IS NOT NULL THEN
             IF vsTipoAdm IS NOT NULL THEN
                Pk_Sisrepimp.P_EncabezadoDeReporte( vsTitRep, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||regRep.Periodo||' - '||PK_catalogo.Periodo(regRep.Periodo)||'<BR>'||'Colegio: '||vsColegio||' - '||PK_catalogo.Preparatoria(vsColegio)||' &nbsp; &nbsp; '||'Tipo de Admisin: '||vsTipoAdm||' - '||PK_catalogo.Admision(vsTipoAdm), psUsuario=>Pk_Login.vgsUSR, psSeccion=>vsSeccion, psUniversidad=>'UFT');
                vgsInicioPag := 'SALTO';
             ELSE
                Pk_Sisrepimp.P_EncabezadoDeReporte( vsTitRep, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||regRep.Periodo||' - '||PK_catalogo.Periodo(regRep.Periodo)||'<BR>'||'Colegio: '||vsColegio||' - '||PK_catalogo.Preparatoria(vsColegio)||' &nbsp; &nbsp; '||'Tipo de Admisin: '||'Todos ', psUsuario=>Pk_Login.vgsUSR, psSeccion=>vsSeccion, psUniversidad=>'UFT');
                vgsInicioPag := 'SALTO';
             END IF;
          ELSE
             IF vsTipoAdm IS NOT NULL THEN
                Pk_Sisrepimp.P_EncabezadoDeReporte( vsTitRep, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||regRep.Periodo||' - '||PK_catalogo.periodo(regRep.Periodo)||'<BR>'||'Colegio: '||' Todos '||' &nbsp; &nbsp; '||'Tipo de Admisin: '||vsTipoAdm||' - '||PK_catalogo.Admision(vsTipoAdm), psUsuario=>Pk_Login.vgsUSR, psSeccion=>vsSeccion, psUniversidad=>'UFT');
                vgsInicioPag := 'SALTO';
             ELSE
                Pk_Sisrepimp.P_EncabezadoDeReporte( vsTitRep, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||regRep.Periodo||' - '||PK_catalogo.periodo(regRep.Periodo)||'<BR>'||'Colegio: '||' Todos '||' &nbsp; &nbsp; '||'Tipo de Admisin: '||'Todos ', psUsuario=>Pk_Login.vgsUSR, psSeccion=>vsSeccion, psUniversidad=>'UFT');
                vgsInicioPag := 'SALTO';
             END IF;
          END IF;

       END IF;

       -- despliega los valores para cada registro:
       IF regRep.Beca IS NULL AND vsBeca = 'true' THEN
          NULL;

       ELSE
          IF vsID IS NULL OR vsID <> regRep.ID THEN
             htp.p('<tr><td valign="top" rowspan="'||regRep.Domicilios||'">'||regRep.PROGRAMA     ||'</td>
                        <td valign="top" rowspan="'||regRep.Domicilios||'">'||regRep.DESPROGRAMA  ||'</td>
                        <td valign="top" rowspan="'||regRep.Domicilios||'">'||regRep.ID           ||'</td>
                        <td valign="top" rowspan="'||regRep.Domicilios||'">'||regRep.RUT          ||'</td>
                        <td valign="top" rowspan="'||regRep.Domicilios||'">'||regRep.APE_ALUM     ||'</td>
                        <td valign="top" rowspan="'||regRep.Domicilios||'">'||regRep.NOM_ALUM     ||'</td>
                        <td valign="top" rowspan="'||regRep.Domicilios||'">'||regRep.SEXO         ||'</td>
                        <td valign="top" align="center" rowspan="'||regRep.Domicilios||'">'||regRep.EDAD  ||'</td>
                        <td valign="top" rowspan="'||regRep.Domicilios||'">'||FWATATR(regRep.PIDM)||'</td>
                        <td valign="top" rowspan="'||regRep.Domicilios||'">');

             FOR regEml IN cuEmail(regRep.Pidm) LOOP
                 htp.p(regEml.EMAIL||'<BR>');
             END LOOP;

             htp.p('</td>');

          ELSE
             htp.p('<tr>');
          END IF;

          htp.p( '<td valign="top">'||regRep.CALLE    ||'</td>
                  <td valign="top">'||regRep.MUNICIPIO||'</td>
                  <td valign="top">'||regRep.REGION   ||'</td>
                  <td valign="top">'||regRep.CODIGO   ||'</td>
                  <td valign="top">'||regRep.PAIS     ||'</td>
                  </tr>' );

          vnExists := 1;
       END IF;

       vsTipoAdm := regRep.Tipo;
       vsID      := regRep.ID;
       vnRow     := 1;

   END LOOP;

   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');

   ELSE
      -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- omite el encabezado del reporte pero agrega el salto de pgina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>Pk_Login.vgsUSR, psSeccion=>vsSeccion);
   END IF;

   htp.p('</table></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRESTD;
/


DROP PUBLIC SYNONYM PWRESTD;

CREATE PUBLIC SYNONYM PWRESTD FOR BANINST1.PWRESTD;


GRANT EXECUTE ON BANINST1.PWRESTD TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRESTD TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRETDI;

CREATE OR REPLACE PROCEDURE BANINST1.PWRETDI (psReclDesc VARCHAR2)
IS
   vnRow         INTEGER := 0;
   vnExists      INTEGER := 0;
   vnColumnas    INTEGER := 2;
   vsIni        twbretr.TWBRETR_DATE%TYPE;
   vsFin        twbretr.TWBRETR_DATE%TYPE;
   vsPerio      TWBCNTR.TWBCNTR_TERM_CODE%type;
   conta_num    number;
   conta_por    number;
   tabColumna   Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla (1);
   vsInicioPag   VARCHAR2 (10) := NULL;
CURSOR cuABCDE (vsIni  in twbretr.TWBRETR_DATE%TYPE,
                vsFin  in twbretr.TWBRETR_DATE%TYPE)
  IS
  select to_char(TWBRETR_DATE, 'dd/mm/yyyy') fecha, count(*) cantidad
  from twbretr
  where (trunc(TWBRETR_DATE) >= trunc(vsIni) or vsIni is null)
    and (trunc(TWBRETR_DATE) <= trunc(vsFin) or vsFin is null)
    and exists (select 1
                from twbcntr
                where TWBCNTR_TERM_CODE = vsPerio
                and TWBCNTR_NUM = TWBRETR_CNTR_NUM)
  group by to_char(TWBRETR_DATE, 'dd/mm/yyyy')
  order by fecha;

BEGIN

   IF Pk_Login.F_ValidacionDeAcceso (pk_login.vgsUSR)
   THEN
      RETURN;
   END IF;

    /* Parmetros */
    --Se busca el valor de la cookie (parmetro) para asignarlo al filtro del query.
    vsIni   := pk_ObjHtml.getValueCookie ('pdIni');
    vsFin   := pk_ObjHtml.getValueCookie ('pdFin');
    vsPerio   := pk_ObjHtml.getValueCookie ('psPerio');

  -- Nmero de columnas de la tabla --
   FOR vnI IN 1 .. vnColumnas
   LOOP
      tabColumna.EXTEND (vnI);
      tabColumna (vnI) := NULL;
   END LOOP;

   /* Encabezado de las columnas */
   tabColumna (1) := 'Da';
   tabColumna (2) := 'Cantidad';
   conta_num := 0;
   conta_por := 0;

      FOR regRep IN cuABCDE(vsIni, vsFin) LOOP
          IF vnRow = 0 THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag);
             vsInicioPag := 'SALTO';
             vnRow  := 0;
          END IF;

          htp.p(
          '<tr>
          <td valign="top">'||regRep.fecha||'</td>
          <td valign="top">'||regRep.cantidad||'</td>
          ');
          conta_num := conta_num + regRep.cantidad;
          vnExists   := 1;
          vnRow      := vnRow + 1;
      END LOOP;
      htp.p('<tr>
             <td valign="top"><B>'||'T O T A L'||'</B></td>
             <td valign="top"><B>'||conta_num||'</B></td>
             ');
   IF vnExists = 0
   THEN
      HTP.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- es omitido el encabezado del reporte pero se agrega el salto de pagina
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
   END IF;

   HTP.p ('</table><br/></body></html>');
EXCEPTION
   WHEN OTHERS
   THEN
      HTP.P (SQLERRM);
END PWRETDI;
/


DROP PUBLIC SYNONYM PWRETDI;

CREATE PUBLIC SYNONYM PWRETDI FOR BANINST1.PWRETDI;


GRANT EXECUTE ON BANINST1.PWRETDI TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRETDI TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRETDI TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRETDI TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRETDI TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRETRA;

CREATE OR REPLACE PROCEDURE BANINST1.PWRETRA (psReclDesc VARCHAR2)
IS
/******************************************************************************
PROCEDIMIENTO:          BANINST1.PWRETRA
OBJETIVO:               Reporte de Retractos
AUTORES:                Guillermo Almazan Ibaez
FECHA:                  13/01/2011
******************************************************************************/
   vnRow         INTEGER := 0;
   vnExists      INTEGER := 0;
   vnColumnas    INTEGER := 14;
   vsTerm        STVTERM.STVTERM_CODE%TYPE;
   vsProg        sgbstdn.sgbstdn_program_1%TYPE;
   vsIni         twbretr.twbretr_date%TYPE;
   vsFin         twbretr.twbretr_date%TYPE;
   --vsUni        twbretr.twbretr_univ%TYPE;
   tabColumna    Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla (1);
   vsInicioPag   VARCHAR2 (10) := NULL;
CURSOR cuABCDE (vsProg in smrprle.smrprle_program_desc%TYPE,
				vsIni  in twbretr.twbretr_date%TYPE,
				vsFin  in twbretr.twbretr_date%TYPE,
                vsTerm in STVTERM.STVTERM_CODE%TYPE)
  IS
  select periodo, id_al, alumno, rut_al, sovsbgv_desc col_descripcion, programa, pro_descripcion, sum(f.por) cre_uft_por, psu_ponderado
	   , uni_destino, pro_destino, moti_desc, comentario, trunc(fecha_retracto) fecha_retracto, trunc(fecha_matricula) fecha_matricula
  from (select pidm, periodo, id_al, alumno, rut_al
			 , case
				  when (pre_origen is null and col_origen is not null) then col_origen
				  when (col_origen is null and pre_origen is not null ) then pre_origen
				  when (col_origen is null and pre_origen is null) then null
				  when (pre_origen is not null and col_origen is not null) then pre_origen
			   end colegio
			 , programa, pro_descripcion, psu_ponderado, uni_destino, uni_tipo, pro_destino, moti_desc, comentario, fecha_retracto, fecha_matricula
		from (select TWBCNTR_PIDM                                                             pidm
				   , TWBCNTR_TERM_CODE														periodo
				   , f_get_id(TWBCNTR_PIDM)                                                   id_al
				   , f_get_nombre(TWBCNTR_PIDM)                                               alumno
				   , f_get_rut(TWBCNTR_PIDM)                                                  rut_al
				   , sorhsch_sbgi_code                                                        pre_origen
				   , sorhsch_activity_date                                                    pre_fecha
				   , sorpcol_sbgi_code                                                        col_origen
				   , sorpcol_activity_date                                                    col_fecha
				   , f_get_programa(TWBCNTR_PIDM, TWBCNTR_TERM_CODE)                          programa
				   , pk_catalogo.programa(f_get_programa(TWBCNTR_PIDM, TWBCNTR_TERM_CODE))    pro_descripcion
				   , pk_AdMat.f_get_PSU_pond(TWBCNTR_PIDM, TWBCNTR_TERM_CODE)             psu_ponderado
				   , S1.SARADAP_WRSN_CODE                                                     uni_destino_code
				   , stvsbgi_desc                                                             uni_destino
				   , stvsbgi_type_ind                                                         uni_tipo
				   , S1.SARADAP_WRSN_CODE                                                     pro_destino
				   , stvwrsn_desc                                                             moti_desc
				   , twbretr_comm                                                             comentario
				   , twbretr_date                                                             fecha_retracto
				   , twbcntr_issue_date                                                       fecha_matricula
			  from twbcntr
				 , twbretr
				 , stvwrsn
				 , sorhsch
				 , sorpcol
				 , stvsbgi
				 , SARADAP S1
			  where TWBRETR_CNTR_NUM = TWBCNTR_NUM
				and stvwrsn_code = S1.SARADAP_WRSN_CODE
				and sorhsch_pidm(+) = TWBCNTR_PIDM
				and sorpcol_pidm(+) = TWBCNTR_PIDM
				and stvsbgi_code(+) = S1.SARADAP_SBGI_CODE
				AND S1.SARADAP_PIDM = TWBCNTR_PIDM
				AND S1.SARADAP_TERM_CODE_ENTRY =
						( SELECT MAX(S2.SARADAP_TERM_CODE_ENTRY)
							FROM SARADAP S2
							WHERE S2.SARADAP_PIDM = S1.SARADAP_PIDM
								AND S2.SARADAP_TERM_CODE_ENTRY <= TWBCNTR_TERM_CODE
								AND S2.SARADAP_WRSN_CODE IS NOT NULL)
				AND S1.SARADAP_WRSN_CODE IS NOT NULL
				AND S1.SARADAP_SBGI_CODE IS NOT NULL  ) a
		where (pre_fecha = (select max(sorhsch_activity_date)
							from sorhsch
							where sorhsch_pidm = a.pidm)
			   or pre_fecha is null)
		  and (col_origen = (select max(x.sorpcol_sbgi_code)
							 from sorpcol x
							 where x.sorpcol_pidm = a.pidm
							   and x.sorpcol_activity_date = (select max(b.sorpcol_activity_date)
															  from sorpcol b
															  where b.sorpcol_pidm = a.pidm))
			   or col_origen is null)
		  and (uni_tipo = 'C' or uni_tipo is null))G,
	   /*****Credito UFT*****/
	   (select TWRCUFT_NUM credit, TWRCUFT_TERM_CODE per, f_get_programa(TWRCUFT_PIDM, TWRCUFT_TERM_CODE) prog, TWRCUFT_PIDM pidm,
			   pk_MatCreUFT.f_montocobercred(TWRCUFT_NUM) monto, TWRCUFT_PERCENT por, decode(TWRCUFT_DOCU_SEQ_NUM, null, null,'A') stat
		from TWRCUFT
		where TWRCUFT_DOCU_SEQ_NUM is not null)F,
	   sovsbgv
  where f.pidm(+) = g.pidm
	and sovsbgv_code(+) = colegio
	and (programa = vsProg or vsProg is null)
    AND (periodo = vsTerm OR vsTerm IS NULL)
	and (trunc(fecha_retracto) >= trunc(vsIni) or vsIni is null)
	and (trunc(fecha_retracto) <= trunc(vsFin) or vsFin is null)
  group by periodo, id_al, alumno, rut_al, sovsbgv_desc, programa, pro_descripcion, psu_ponderado, uni_destino, pro_destino, moti_desc, comentario, fecha_retracto, fecha_matricula;

BEGIN

   IF Pk_Login.F_ValidacionDeAcceso (pk_login.vgsUSR)
   THEN
	  RETURN;
   END IF;

	/* Parmetros */
	--Se busca el valor de la cookie (parmetro) para asignarlo al filtro del query.
	vsProg  := pk_ObjHtml.getValueCookie ('psProgr');
	vsIni   := pk_ObjHtml.getValueCookie ('pdIni');
	vsFin   := pk_ObjHtml.getValueCookie ('pdFin');
    vsTerm  := pk_ObjHtml.getValueCookie ('psPerio');

  -- Nmero de columnas de la tabla --
   FOR vnI IN 1 .. vnColumnas
   LOOP
	  tabColumna.EXTEND (vnI);
	  tabColumna (vnI) := NULL;
   END LOOP;

   /* Encabezado de las columnas */
   tabColumna (1) := 'Id Alumno';
   tabColumna (2) := 'Alumno';
   tabColumna (3) := 'RUT Alumno';
   tabColumna (4) := 'Escuela Origen';
   tabColumna (5) := 'Programa';
   tabColumna (6) := 'Descripcin Programa';
   tabColumna (7) := 'Beca UFT';
   tabColumna (8) := 'PSU Ponderado';
   tabColumna (9) := 'Universidad Destino';
   tabColumna (10) := 'Programa Destino';
   tabColumna (11) := 'Motivo Retracto';
   tabColumna (12) := 'Comentario';
   tabColumna (13) := 'Fecha Retracto';
   tabColumna (14) := 'Fecha de Matrcula';
   tabColumna (15) := 'vsIni';
   tabColumna (16) := 'vsFin';

	  FOR regRep IN cuABCDE(vsProg, vsIni, vsFin, vsTerm) LOOP
		  IF vnRow = 0 THEN
			 Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag);
			 vsInicioPag := 'SALTO';
			 vnRow  := 0;
		  END IF;

		  htp.p(
		  '<tr>
		  <td valign="top">'||regRep.id_al||'</td>
		  <td valign="top">'||regRep.alumno||'</td>
		  <td valign="top">'||regRep.rut_al||'</td>
		  <td valign="top">'||regRep.col_descripcion||'</td>
		  <td valign="top">'||regRep.programa||'</td>
		  <td valign="top">'||regRep.pro_descripcion||'</td>
		  <td valign="top">'||regRep.cre_uft_por||'</td>
		  <td valign="top">'||regRep.psu_ponderado||'</td>
		  <td valign="top">'||regRep.uni_destino||'</td>
		  <td valign="top">'||regRep.pro_destino||'</td>
		  <td valign="top">'||regRep.moti_desc||'</td>
		  <td valign="top">'||regRep.comentario||'</td>
		  <td valign="top">'||regRep.fecha_retracto||'</td>
		  <td valign="top">'||regRep.fecha_matricula||'</td>
		  ');

		  vnExists   := 1;
		  vnRow      := vnRow + 1;
	  END LOOP;

   IF vnExists = 0
   THEN
	  HTP.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
	  -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
	  Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

	  -- es omitido el encabezado del reporte pero se agrega el salto de pagina
	  Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
   END IF;

   HTP.p ('</table><br/></body></html>');
EXCEPTION
   WHEN OTHERS
   THEN
	  HTP.P (SQLERRM);
END PWRETRA;
/


DROP PUBLIC SYNONYM PWRETRA;

CREATE PUBLIC SYNONYM PWRETRA FOR BANINST1.PWRETRA;


GRANT EXECUTE ON BANINST1.PWRETRA TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRETRA TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRETRA TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRETRA TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRETRA TO WWW2_USER;
DROP PROCEDURE BANINST1.PWREVHS;

CREATE OR REPLACE PROCEDURE BANINST1.PWREVHS(psReclDesc VARCHAR2,
                                             psSiu      VARCHAR2 DEFAULT NULL) IS

/**************************************************************
           tarea:  generar el resumen de evaluacin histrica
          mdulo:  resultados del sistema de evaluacin de la prctica docente (seprad)
           autor:  horacio martnez ramrez - hmr
           fecha:  03/nov/2010
      diseo de variables: para un mejor mantenimiento se deben considerar estas claves, buscar el cdigo respectivo
                +---------------------------------------------------------------------------------------------+
                |                      | periodo            | prom del periodo |  ....|           promedio           |
                +---------------------------------------------------------------------------------------------+
                |       categoria   | mediacatperiodo  | mediacat_promper |  ... | medcatprom  | desvcatprom|
                +----------------------------------------------------------------------------------------------
                |reacitvo 1cn18,19-23 | mediareaperiodo  | mediarea_promper |  ... | medreaprom  | desvreaprom|
                +----------------------------------------------------------------------------------------------
                |valoracion promprof| mediavalperiodo | mediaval_promper |  ... | medvalprom   | desvvalprom|
                +----------------------------------------------------------------------------------------------
**************************************************************/

  ckNombres     owa_cookie.vc_arr;
  ckValores     owa_cookie.vc_arr;
  ckCount       INTEGER;
  vgsUSR        VARCHAR2(500);
  global_pidm   SPRIDEN.SPRIDEN_PIDM%TYPE;

  TYPE reg_Encu IS RECORD ( rEncuesta    VARCHAR2(20),
                            rInicia      NUMBER(4),
                            rFin         NUMBER(4),
                            rPeriodos    NUMBER(2),
                            rNoCrn       NUMBER(3));

  TYPE reg_Prom IS RECORD (rEncuesta    VARCHAR2(20),
                           rTermCode    VARCHAR2(06),
                           rTeqaCode    VARCHAR2(40),
                           rQcodCode    VARCHAR2(40),
                           rMedia       NUMBER,
                           rDesvi       NUMBER,
                           rCrn         NUMBER,
                           rTitle       VARCHAR2(300),
                           rContestaron INTEGER,
                           rInscritos   INTEGER,
                           rMedCat      NUMBER,
                           rMedProm     NUMBER,
                           rDesProm     NUMBER,
                           rMediaZero   INTEGER);

  TYPE tableProm  IS TABLE OF reg_Prom INDEX BY BINARY_INTEGER;
  TYPE T_PROM_Val IS TABLE OF NUMBER   INDEX BY BINARY_INTEGER; -- variable para promediar 5 categorias
  TYPE T_EncuT    IS TABLE OF reg_Encu INDEX BY BINARY_INTEGER; -- variable tener el arreglo de las encuestas a aplicar

  tabPromCrn        tableProm;
  tabMain           tableProm;
  tabMedValPP       T_PROM_Val; -- guarda la suma de promedio del periodo para obtener el promedio las primeras 5 categoras
  tabVal            T_PROM_Val; -- guarda los promedio del periodo de cada categora para valoracin
  tabEncues         T_EncuT;    -- guarda la relacin de las encuestas encontradas en la bsqueda

  vsColl         VARCHAR2(2)   := NULL;
  vsEncu         VARCHAR2(30)  := NULL;
  vsUniv         VARCHAR2(3)   := NULL;
  rTermAnt       VARCHAR2(6)   := NULL;
  vsLongCelda    VARCHAR2(100) := ' style="width:60.0px" ';
  vgColl         VARCHAR(5)    := NULL;
  vnPidm         NUMBER        := NULL;
  vnTotPromPer   NUMBER        := 0;
  vnTGpoPromPer  NUMBER        := 0;
  vnTotEvaProm   NUMBER        := 0;
  vnTotEva18     NUMBER        := 0;
  vnMedReaPP     NUMBER        := 0;
  vnMediaValProm NUMBER        := 0;
  vnMediaTot18   NUMBER        := 0;
  vnDesvValProm  NUMBER        := 0;
  vnCursos       NUMBER(4)     := 0;
  vnEvaluaron    INTEGER       := 0;
  vnEvalPos      INTEGER       := 0;
  vnInscritos    INTEGER       := 0;
  vnRow          INTEGER       := 0;
  vnPromedio     INTEGER       := 0;
  vnCat          INTEGER       := 1;
  vnTotEva       INTEGER       := 0;
  vnTotEvaTerm   INTEGER       := 0;
  vnTotEvaluac   INTEGER       := 0;
  vnNumPer       INTEGER       := 0;
  vsTitEnc       VARCHAR2(500) := NULL;
  vnTxtGde       INTEGER       := 0;
  vnMatGde       INTEGER       := 0;
  vnAdicSp       INTEGER       := 0;
  vsEncuD        VARCHAR2(20)  := 'Inicio';
  vnencont       INTEGER       := 0;
  vnInicio       INTEGER       := 0;
  vnFinal        INTEGER       := 0;
  vnTotCrn       INTEGER       := 0;
  vsCrnP         VARCHAR2(6)   := NULL;
  vnPerTot       INTEGER       := 0;
  vsEsEncBase      VARCHAR2(1)    := NULL;
  vnAnidaEncu      NUMBER(2)      := 0;

  csI            CONSTANT       VARCHAR2(1)   := 'I';
  csL            CONSTANT       VARCHAR2(1)   := 'L';
  cnN            CONSTANT       VARCHAR2(1)   := 'N';
  cn0            CONSTANT       NUMBER(1)     := 0;
  cn1            CONSTANT       NUMBER(1)     := 1;
  cn2            CONSTANT       NUMBER(1)     := 2;
  cn3            CONSTANT       NUMBER(1)     := 3;
  cn4            CONSTANT       NUMBER(1)     := 4;
  cn5            CONSTANT       NUMBER(1)     := 5;
  cn6            CONSTANT       NUMBER(1)     := 6;
  cn7            CONSTANT       NUMBER(1)     := 7;
  cn16           CONSTANT       NUMBER(2)     := 16;
  cn19           CONSTANT       NUMBER(2)     := 19;
  cnPor          CONSTANT       VARCHAR2(1)   := '%';
  cs90p99        CONSTANT       VARCHAR2(5)   := '90.99';
  csS            CONSTANT       VARCHAR2(1)   := 'S';
  csN            CONSTANT       VARCHAR2(1)   := 'N';

  CURSOR cuPromedio(psColl VARCHAR2,
                    pnPidm NUMBER ,
                    psCamp VARCHAR2,
                    psEncu VARCHAR2) IS
         SELECT SWrSEPR_TSSC_CODE           Encuesta,
                SWRSEPR_TERM_CODE           termCode,
                SWRSEPR_TEQA_CODE           teqaCode,
                SWRSEPR_QCOD_CODE           qcodCode,
                SWRSEPR_CRN                 Crn,
                SWROENC_ORDEN               OrdenEnc,
                Encuesta.EncPrinc           EncPrinc,
                SWRSEPR_MEDIA               Media,
                SWRSEPR_DESVIACION          Desviacion,
                SWRSEPR_CONTESTARON         Contestaron,
                SWRSEPR_TITLE               Title,
                SWRSEPR_INSCRITOS           Inscritos
           FROM SWRSEPR, (SELECT SWRCENC_TSSC_CODE EncuCode,SWRCENC_PRINCIPAL EncPrinc
                               FROM SWRCENC
                              WHERE SWRCENC_TSSC_CODE = psEncu
                                AND SWRCENC_PRINCIPAL = vsEsEncBase
                            UNION ALL
                            SELECT SWRCENC_TSSC_CODE EncuCode,SWRCENC_PRINCIPAL EncPrinc
                               FROM SWRCENC
                              WHERE SWRCENC_TSSC_CODE <> psEncu
                                AND SWRCENC_PRINCIPAL = cnN
                                AND SWRCENC_ASOCIA = vnAnidaEncu
                         ) Encuesta,
                 SWROENC
          WHERE SWRSEPR_TERM_CODE IN (SELECT SWBSEPR_TERM_CODE
                                        FROM SWBSEPR
                                       WHERE SWBSEPR_PIDM      = pnPidm
                                         AND SWBSEPR_COLL_CODE = psColl
                                         AND SWBSEPR_CAMP_CODE = psCamp
                                         AND SWBSEPR_TSSC_CODE IN ( SELECT SWRCENC_TSSC_CODE
                                                                       FROM SWRCENC
                                                                      WHERE SWRCENC_TSSC_CODE = psEncu
                                                                        AND SWRCENC_PRINCIPAL = vsEsEncBase
                                                                    UNION ALL
                                                                    SELECT SWRCENC_TSSC_CODE
                                                                       FROM SWRCENC
                                                                      WHERE SWRCENC_TSSC_CODE <> psEncu
                                                                        AND SWRCENC_PRINCIPAL = cnN
                                                                        AND SWRCENC_ASOCIA = vnAnidaEncu
                                                                   )
                                     )
            AND SWRSEPR_TIPO_CRN IN (csI,csL)
            AND SWRSEPR_PIDM      = pnPidm
            AND SWRSEPR_COLL_CODE = psColl
            AND SWRSEPR_CAMP_CODE = psCamp
            AND SWRSEPR_TSSC_CODE = Encuesta.EncuCode
            AND SWROENC_TSSC_CODE = SWRSEPR_TSSC_CODE
            AND SWROENC_QCOD_CODE = SWRSEPR_QCOD_CODE
          ORDER BY EncPrinc DESC, Encuesta,termCode,Crn,OrdenEnc,qcodCode;

  -- esta funcin decide si la columna correspondiente al promedio del periodo debe pintarse
  function f_PintaColumnaPromedio(vnPosicion integer,
                                  vnVuelta integer) return boolean is

  vbPintaColProm boolean := false;
  vnPosicionSig  integer := cn1 + (cn19 * (vnVuelta+cn1));

  begin
      if tabPromCrn.count > vnPosicionSig THEN
         vbPintaColProm := FALSE;
      else
         vbPintaColProm := TRUE;
      end if;

      if vbPintaColProm = FALSE then
         if tabPromCrn(vnPosicion).rTermCode <> tabPromCrn(vnPosicionSig).rTermCode then
            vbPintaColProm := true;
         else
            vbPintaColProm := false;
         end if;
      end if;

      return vbPintaColProm;

  EXCEPTION
      WHEN OTHERS THEN
           HTP.P('ERROR EN LA CONSULTA AL CONTRUIR REPORTE'||SQLERRM||'-..-'||SQLCODE);

  end f_PintaColumnaPromedio;

  function f_DatosCurso(pnOpcion integer) return varchar2 is

  vnVuelta       INTEGER        := 0;
  vnPosicion     INTEGER        := 0;
  vbPintaColProm BOOLEAN        := false;
  vnEvaProm      INTEGER        := 0;
  vnInsProm      INTEGER        := 0;
  vnTotIns       INTEGER        := 0;
  vsEncLoc       VARCHAR2(20)   := NULL;
  csColum        VARCHAR2(20)   := '<td align="center" ';

  begin

      vsEncLoc   := tabPromCrn(cn1).rEncuesta;
      for vnI in cn1..vnCursos loop
          vnPosicion := cn1 + (cn19 * vnVuelta);

          if    pnOpcion = cn0 then   --periodo
               ----  consideracin para nuevas encuestas
               IF ( vsEncLoc != tabPromCrn(vnPosicion).rEncuesta ) THEN
                 htp.p('<td colspan="2" width="320" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7" valign="top">'||'Periodo'||'</td>');
               END IF;
                htp.prn(csColum||'class="tdFont7"  valign="top">');
                htp.p(tabPromCrn(vnPosicion).rTermCode);
          elsif pnOpcion = cn1 then
               IF ( vsEncLoc != tabPromCrn(vnPosicion).rEncuesta ) THEN
                 htp.p('<td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7" valign="top">'||'Materia'||'</td>');
               END IF;
                htp.prn(csColum||'class="tdFont7" style="width:60.0px;border-top:none;border-bottom:none;" valign="top">');
                htp.p(tabPromCrn(vnPosicion).rTitle);
          elsif pnOpcion = cn2 then
               IF ( vsEncLoc != tabPromCrn(vnPosicion).rEncuesta ) THEN
                 htp.p('<td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7" valign="top">'||'N&uacute;mero de evaluadores'||'</td>');
               END IF;
                htp.prn(csColum||'class="tdFont7" style="width:60.0px;border-top:none;border-bottom:none;">');
                htp.p(tabPromCrn(vnPosicion).rContestaron);
                vnEvaluaron := vnEvaluaron + tabPromCrn(vnPosicion).rContestaron;
          elsif pnOpcion = cn3 then
               IF ( vsEncLoc != tabPromCrn(vnPosicion).rEncuesta ) THEN
                 htp.p('<td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7" valign="top">'||'N&uacute;mero de alumnos inscritos'||'</td>');   --hmr
               END IF;
                htp.prn(csColum||'class="tdFont7" style="width:60.0px;border-top:none;border-bottom:none;">');
                htp.p(tabPromCrn(vnPosicion).rInscritos);
                vnInscritos := vnInscritos + tabPromCrn(vnPosicion).rInscritos;
          elsif pnOpcion = cn4 then
               IF ( vsEncLoc != tabPromCrn(vnPosicion).rEncuesta ) THEN
                 htp.p('<td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7" valign="top">'||'Escuela o Facultad'||'</td>');
               END IF;
                htp.prn(csColum||'class="tdFont7" style="width:60.0px;border-top:none;border-bottom:none;" valign="top">');
                htp.p(pk_Seprad1.F_CollDesc(vgColl));
          elsif pnOpcion = cn5 then
               IF ( vsEncLoc != tabPromCrn(vnPosicion).rEncuesta ) THEN
                 htp.p('<td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7" valign="top">'||'CRN'||'</td>');
               END IF;
                htp.prn(csColum||'class="tdFont7" style="width:60.0px;border-top:none;border-bottom:none;" valign="top">');
                htp.p(tabPromCrn(vnPosicion).rCrn);
          elsif pnOpcion = cn6 then
               IF ( vsEncLoc != tabPromCrn(vnPosicion).rEncuesta ) THEN
                 htp.p('<td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7" valign="top">'||'N&uacute;mero de grupos'||'</td>');
               END IF;
                htp.prn(csColum||'class="tdFont7" style="width:60.0px;border-top:none;">1');
                vnTGpoPromPer  := vnTGpoPromPer + cn1;
          end if;

          htp.p('</td>');

          vbPintaColProm := f_PintaColumnaPromedio(vnPosicion, vnVuelta) ;
          vnEvaProm      := vnEvaProm + tabPromCrn(vnPosicion).rContestaron;
          vnInsProm      := vnInsProm + tabPromCrn(vnPosicion).rInscritos;


          if vbPintaColProm = true then
             if    pnOpcion = cn0 then   --periodo
                      htp.p('<td class="tdFont7" bgcolor="#efefef" style="width:60.0px;border-bottom:none;" valign="top" align="center">'||'Promedio del Periodo'||' '||tabPromCrn(vnPosicion).rTermCode||'</td>');
             elsif pnOpcion = cn3 then
                   htp.p('<td class="tdFont7" bgcolor="#efefef" valign="center" align="center" style="width:60.0px;border-top:none;border-bottom:none;">'||vnInsProm||'</td>');
                   vnTotIns  := vnTotIns  + vnInsProm;
                   vnInsProm := cn0;
             elsif pnOpcion = cn2 then
                   htp.p('<td class="tdFont7" bgcolor="#efefef" valign="center" align="center" style="width:60.0px;border-top:none;border-bottom:none;">'||vnEvaProm||'</td>');
                   vnTotEva  := vnTotEva  + vnEvaProm;
                   vnEvaProm :=cn0 ;
             elsif pnOpcion = cn6 then
                   htp.p('<td class="tdFont7" bgcolor="#efefef" valign="center" align="center" style="width:60.0px;border-top:none;border-bottom:none;">'||vnTGpoPromPer||'</td>');
                   vnTGpoPromPer := cn0;
             else
                   htp.p('<td class="tdFont7" bgcolor="#efefef"  style="width:60.0px;border-top:none;border-bottom:none;"></td>');
             end if;

          end if;

          vsEncLoc   := tabPromCrn(vnPosicion).rEncuesta;
          vnVuelta := vnVuelta + cn1;

      end loop;

      if    pnOpcion = cn0 then
            htp.p('<td align="center" bgcolor="#CCCCCC" class="tdFont8" style="width:60.0px;">'||'Promedio'||'</td>');
            htp.p('<td align="center" bgcolor="#CCCCCC" class="tdFont8" style="width:60.0px;">'||'Desviaci&oacute;n'||'</td>');
      elsif pnOpcion = cn2 then
            htp.p('<td colspan="2" align="center" valign="center" bgcolor="#CCCCCC" class="tdFont8" style="border-bottom:none;border-top:none;"><b>'||vnTotEva||'</b></td>');
      elsif pnOpcion = cn3 then
            htp.p('<td colspan="2" align="center" valign="center" bgcolor="#CCCCCC" class="tdFont8" style="border-top:none;"><b>'||vnTotIns||'</b></td>');
            vnTotIns := cn0;
      elsif pnOpcion = cn6 then
            htp.p('<td colspan="2" align="center" valign="center" bgcolor="#CCCCCC" class="tdFont8" style="border-top:none;"><b>'||vnCursos||'</b></td>');
      elsif pnOpcion in ( cn1, cn4, cn5)then
            htp.p('<td colspan="2" align="center" valign="center"  bgcolor="#CCCCCC" class="tdFont8" style="width:60.0px;border-bottom:none;border-top:none;"></td>');
      end if;

            return null;
  end f_DatosCurso;

  -- media y desviacin por categora de evaluacin
  function f_MediaCategoria(pnCategoria INTEGER) return varchar2 is

  vnVuelta       INTEGER := 0;
  vnPosicion     INTEGER := 0;
  vnMediaCatProm NUMBER  := 0;
  vnDesviCatProm NUMBER  := 0;
  vbPintaColProm BOOLEAN := false;
  vnMediaPromPer NUMBER  := 0;
  vnEvaPromPer   NUMBER  := 0;
  vnMedCatPP     NUMBER  := 0;
  vsEncLoc       VARCHAR2(20) := NULL;

  begin
      vsEncLoc  := tabPromCrn(cn1).rEncuesta;
      vnEvalPos := 0;
      for vnI in cn1..vnCursos loop
          vnPosicion := pnCategoria + (cn19 * vnVuelta);

          IF (vsEncLoc != tabPromCrn(vnPosicion).rEncuesta ) THEN
             htp.p('<th colspan="2" align="left" class="thFont7">'||pk_Seprad1.F_TeqaDesc(tabPromCrn(vnPosicion).rTeqaCode)||'</th>');
          END IF;

          htp.p('<th valign="top" '||vsLongCelda||' class="thFont8" align="center">'||TO_CHAR(ROUND(tabPromCrn(vnPosicion).rMedCat,cn2),cs90p99)||'</th>');--mediacatperiodo

       --- si es postgrado y media cero no se cuenta el evaluador
          if ( vnAnidaEncu > cn1) then
             if (tabPromCrn(vnPosicion).rMedCat = cn0  ) then
                vnEvalPos     := vnEvalPos  + tabPromCrn(vnPosicion).rContestaron;
             end if;
          end if;

          vbPintaColProm   := f_PintaColumnaPromedio(vnPosicion, vnVuelta);
          vnMediaPromPer   := vnMediaPromPer + (tabPromCrn(vnPosicion).rMedCat*tabPromCrn(vnPosicion).rContestaron);

          --- si es postgrado y media cero no se cuenta el evaluador
          if ( vnAnidaEncu > cn1) then
             if (tabPromCrn(vnPosicion).rMedCat = cn0  ) then
                vnEvaPromPer     := vnEvaPromPer   + cn0;
             else
                vnEvaPromPer     := vnEvaPromPer   + tabPromCrn(vnPosicion).rContestaron;
             end if;
          else
             vnEvaPromPer     := vnEvaPromPer   + tabPromCrn(vnPosicion).rContestaron;
          end if;

          if vbPintaColProm = true then
             if  vnEvaPromPer > cn0 then -- previene la division entre cero
                 vnMedCatPP := vnMediaPromPer/vnEvaPromPer;
             else
                 vnMedCatPP := cn0;
             end if;

             htp.p('<th  valign="top" '||vsLongCelda||' class="thFont8" align="center">'||TO_CHAR(ROUND((vnMedCatPP),cn2),cs90p99)||'</th>'); --mediacat_promper

             vnMediaPromPer := cn0;
             vnEvaPromPer   := cn0;
             vnMedCatPP     := cn0;
          END IF;

          tabPromCrn(vnVuelta+cn1).rMedProm := tabPromCrn(vnVuelta+1).rMedProm + tabPromCrn(vnPosicion).rMedCat;
          vnMediaCatProm                  := vnMediaCatProm + tabPromCrn(vnPosicion).rMedCat * tabPromCrn(cn1 + (cn19 * vnVuelta)).rContestaron;
          vnVuelta                        := vnVuelta + cn1;
          vsEncLoc                        := tabPromCrn(vnPosicion).rEncuesta;

      end loop;

      if vnMediaCatProm > cn0 and vnEvaluaron > cn0 then
         vnMediaCatProm := vnMediaCatProm/(vnEvaluaron-vnEvalPos);
      end if;

--          htp.p('-->'||to_char(vnmediacatprom)||'-->'||to_char(vnevaluaron)||'-->'||to_char(vnevalpos));

      -- calcular la desviacin estandard de la categora
      for vnI in cn1..vnCursos loop
          vnDesviCatProm  := vnDesviCatProm + (POWER(tabPromCrn(pnCategoria+ (cn19 * (vnI-cn1))).rMedCat  - vnMediaCatProm ,cn2) * tabPromCrn(pnCategoria+ (cn19 * (vnI-cn1))).rContestaron);
      end loop;

      vnDesviCatProm := sqrt(vnDesviCatProm / (vnTotEva-vnEvalPos));

      htp.p('<th valign="top" '||vsLongCelda||' class="thFont8" bgcolor="#CCCCCC">'||TO_CHAR(ROUND(vnMediaCatProm,cn2),cs90p99)||'</th>'); --medcatprom
      htp.p('<th valign="top" '||vsLongCelda||' class="thFont8" bgcolor="#CCCCCC">'||TO_CHAR(ROUND(vnDesviCatProm,cn2),cs90p99)||'</th>'); --desvcatprom

      return null;

  end f_MediaCategoria;

  -- media y desviacin por reactivo de la evaluacin
  function f_MediaReactivo(pnRectivo INTEGER) return varchar2 is

  vnVuelta        integer      := 0;
  vnEvalua        integer      := 0;
  vnPosicion      integer      := 0;
  vnMediaReacProm number       := 0;
  vnDesviReacProm number       := 0;
  vbPintaColProm  boolean      := false;
  vsStyle         varchar(300) := ' style="width:60.0px;border-top:none;border-bottom:none;" ';
  vsEncLoc        varchar2(20) := NULL;

  begin
      vnCat := cn1;

      if pnRectivo = cn19 then
         vsStyle := ' style="width:60.0px;border-top:none; "';
      end if;
      vnEvalPos := 0;
      vsEncLoc :=tabPromCrn(cn1).rEncuesta;
      for vnI in 1..vnCursos loop
          vnPosicion   := pnRectivo    + (cn19 * vnVuelta);
          vnTotPromPer := vnTotPromPer + (tabPromCrn(vnPosicion).rContestaron * tabPromCrn(vnPosicion).rMedia);
       --- si es postgrado y media cero no se cuenta el evaluador
          if ( vnAnidaEncu > cn1) then
             if (tabPromCrn(vnPosicion).rMedia = cn0  ) then
                vnEvalPos     := vnEvalPos  + tabPromCrn(vnPosicion).rContestaron;
             end if;
          end if;

          IF (vsEncLoc !=tabPromCrn(vnPosicion).rEncuesta) THEN
            htp.p('<td style="border-right:none;width:20.0px" class="tdFont7" valign="top" align="right">'||(vnPosicion-(cn19 * vnVuelta))||')</td>
                  <td style="border-left:none;width:320px" class="tdFont7" valign="top" >'||pk_Seprad1.F_QcodDesc(tabPromCrn(vnPosicion).rQcodCode)||'</td>');
          END IF;

          if tabPromCrn(vnPosicion).rMedia > cn0 then
                vnEvalua     := vnEvalua     + tabPromCrn(vnPosicion).rContestaron;
                vnTotEvaProm := vnTotEvaProm + tabPromCrn(vnPosicion).rContestaron;
          elsif tabPromCrn(vnPosicion).rMedia = cn0 then
                tabPromCrn(vnI).rMediaZero := tabPromCrn(vnI).rMediaZero + cn1;

          end if;

          -- detalle del ractivo
          htp.p('<td align="center" valign="top" '||vsStyle||' class="tdFont8">'||TO_CHAR(ROUND(tabPromCrn(vnPosicion).rMedia,cn2),cs90p99)||'</td>');--mediareaperiodo

          -- decide si pinta la columna del promedio del periodo
          vbPintaColProm := f_PintaColumnaPromedio(vnPosicion, vnVuelta);

          if vbPintaColProm = true then
             if vnTotEvaProm > cn0 then  -- prviene el error de dividir entre cero
                vnMedReaPP :=(vnTotPromPer/(vnTotEvaProm));
             else
                vnMedReaPP   := cn0;
                vnTotEvaTerm := vnTotEvaTerm + cn1;
             end if;

             tabMedValPP(vnCat):= tabMedValPP(vnCat) + vnMedReaPP;

             htp.p('<th valign="top" '||vsStyle||' bgcolor="#efefef" class="thFont8">'||TO_CHAR(ROUND(vnMedReaPP,cn2),cs90p99)||'</th>'); --mediarea_promper

             vnCat        := vnCat + cn1;
             vnTotPromPer := cn0;
             vnTotEvaProm := cn0;
          end if;

          vnMediaReacProm := vnMediaReacProm + tabPromCrn(vnPosicion).rMedia * tabPromCrn(vnPosicion).rContestaron;

          vnVuelta := vnVuelta + cn1;
          vsEncLoc :=tabPromCrn(vnPosicion).rEncuesta;
      end loop;

      if vnMediaReacProm > cn0 and vnEvalua > cn0 then
         vnMediaReacProm := vnMediaReacProm/(vnEvalua);
      end if;

      -- calcular la desviacin estandard del reacitvo
      for vnI in cn1..vnCursos loop
          vnDesviReacProm  := vnDesviReacProm + (POWER(tabPromCrn(pnRectivo+ (cn19 * (vnI-cn1))).rMedia  - vnMediaReacProm ,cn2) * tabPromCrn(pnRectivo+ (cn19 * (vnI-cn1))).rContestaron);
      end loop;

      vnDesviReacProm := sqrt(vnDesviReacProm / (vnTotEva));

      if pnRectivo <= cn16 then
         if vnMediaReacProm = cn0 then
            vnTotEvaluac := vnTotEvaluac + cn1;
         end if;

         vnMediaValProm   := vnMediaValProm + vnMediaReacProm;
         vnDesvValProm    := vnDesvValProm  + vnDesviReacProm;
      end if;

      htp.p('<td align="center" valign="top" '||vsStyle||' bgcolor="#CCCCCC" class="tdFont8">'||TO_CHAR(ROUND(vnMediaReacProm,cn2),cs90p99)||'</td>'); -- medreaprom
      htp.p('<td align="center" valign="top" '||vsStyle||' bgcolor="#CCCCCC" class="tdFont8">'||TO_CHAR(ROUND(vnDesviReacProm,cn2),cs90p99)||'</td>'); --desvreaprom

      return null;

  end f_MediaReactivo;

  -- presenta los reactivos de la encuesta
  procedure P_ReactivosEncuesta IS

  vsTeqaCode     SVRSDEF.SVRSDEF_TEQA_CODE%TYPE := NULL;
  vnVuelta          INTEGER     := 0;
  vbPintaColProm    boolean     := false;
  vnMedValProm      NUMBER(10,2)  := 0;
  vnWidthTable      INTEGER     := 0;
  vnCuantosPen      NUMBER(4)   := 0;
  vsEncLoc          VARCHAR2(20):= NULL;
  vnLocaliza        number(5)   := 0;
  vnB               number(5)   := 0;
  cnAcEnc           NUMBER(5)   := 0;
  csEnc             VARCHAR2(1) := NULL;
  vnCual            NUMBER(5)   := 0;
  cn300          CONSTANT       NUMBER(3)     := 500;
  cn60           CONSTANT       NUMBER(3)     := 60;
  cn120          CONSTANT       NUMBER(3)     := 120;

  BEGIN
      vnCursos     := vnRow/cn19;
      vnWidthTable := (cn300*vnencont) +  ((vnTotCrn+ vnPerTot) * cn60) + cn120;
      htp.p('<table border="1" cellpadding="2" cellspacing="0" bordercolor="#CCCCCC" width="'||vnWidthTable||'" bgcolor="#ffffff" style="width:'||vnWidthTable||'.0px">');

      -- agrega el cabecero de las encuestas al reporte de las siguientes encuestas
      htp.p('<TR class="trTabSepara">');
      FOR vnJ IN cn1..vnencont LOOP
         IF (vnJ = vnencont) THEN
            vnCuantosPen    := (tabEncues(vnJ).rPeriodos + tabEncues(vnJ).rNoCrn) + cn4;
         ELSE
            vnCuantosPen    := (tabEncues(vnJ).rPeriodos + tabEncues(vnJ).rNoCrn) + cn2;
         END IF;
         vsTitEnc := tabEncues(vnJ).rEncuesta||' - '||pk_Seprad1.F_Encuesta(tabEncues(vnJ).rEncuesta);
         htp.p('<td colspan="'||to_char(vnCuantosPen)||'" align="left" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7" valign="top"><b>'||vsTitEnc||'</b></td>');
      END LOOP;

      htp.p('</TR>');

      htp.p('<tr class="trTabSepara"><td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7" valign="top">'||'Periodo'||'</td>');
      htp.p(f_DatosCurso(cn0));

      htp.p('</tr><tr class="trTabSepara"><td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7" valign="top">'||'CRN'||'</td>');
      htp.p(f_DatosCurso(cn5));

      htp.p('</tr><tr class="trTabSepara"><td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7" valign="top">'||'Materia'||'</td>');
      htp.p(f_DatosCurso(cn1));

      htp.p('</tr><tr class="trTabSepara"><td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7" valign="top">'||'Escuela o Facultad'||'</td>');
      htp.p(f_DatosCurso(cn4));

      htp.p('</tr><tr class="trTabSepara"><td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7">'||'N&uacute;mero de evaluadores'||'</td>');
      htp.p(f_DatosCurso(cn2));

      htp.p('</tr><tr class="trTabSepara"><td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7">'||'N&uacute;mero de alumnos inscritos'||'</td>');
      htp.p(f_DatosCurso(cn3));

      htp.p('</tr><tr class="trTabSepara"><td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7">'||'N&uacute;mero de grupos'||'</td>');
      htp.p(f_DatosCurso(cn6));

      -- inicializa arreglo de promedios por periodo para el proedio de las 5 categoras  y pinta nmero de cursos

      FOR vnI in cn1..vnCursos loop
        tabMedValPP(vnI) := cn0;
        vbPintaColProm   := f_PintaColumnaPromedio(cn1, vnI);
      END LOOP;

      FOR vnI IN cn1..vnRow LOOP
           -- es colocada la media por categora de evaluacin
          IF vsTeqaCode <> tabPromCrn(vnI).rTeqaCode OR vsTeqaCode IS NULL THEN
             htp.p('<tr bgcolor="#efefef" class="trTabSepara"><th colspan="2" width="320" valign="top" align="left" class="thFont7">'||pk_Seprad1.F_TeqaDesc(tabPromCrn(vnI).rTeqaCode)||'</th>');
             htp.p(f_MediaCategoria(vnI));
             htp.p('</tr>');
          END IF;

          --es colocada la descripcin de los reactivos
          htp.p('<tr class="trTabSepara">
                     <td style="border-right:none;width:20.0px" class="tdFont7" valign="top" align="right">'||vnI||')</td>
                     <td style="border-left:none;width:320.0px" class="tdFont7" valign="top">'||pk_Seprad1.F_QcodDesc(tabPromCrn(vnI).rQcodCode)||'</td>');

          -- es colocada el promedio d.e y la media de los reactivos
          htp.p(f_MediaReactivo(vnI));
          htp.p('</tr>');

          -- es colocado el promedio de los reactivos de las 5 primeras categoras
          IF vnI = cn16 THEN
             htp.p('<tr bgcolor="#efefef" class="trTabSepara"><th colspan="2" valign="top" width="320" class="thFont7" style="border-right:none;">'||'Valoraci&oacute;n Promedio del Profesor (VPP)'||'</th>');

             vnCat := cn1;


             FOR vnJ IN 1..vnCursos LOOP
                vnLocaliza :=  vnJ + (cn19 * vnVuelta);

                vnMedValProm := 0;

                 FOR vnB IN cn1..vnI LOOP
                     vnMedValProm := vnMedValProm + tabPromCrn(vnB+(cn19*vnVuelta)).rMedia;
                 END LOOP;

                 IF vnMedValProm > cn0 AND (vnI-tabPromCrn(vnJ).rMediaZero) > cn0 THEN
                    vnMedValProm := vnMedValProm / (vnI-tabPromCrn(vnJ).rMediaZero);
                 ELSE
                    vnMedValProm := cn0;
                 END IF;

                 IF (tabEncues.count = 1) THEN vnCual := 0; END IF;

                -- consideracin para nuevas encuestas
                 FOR vnB IN cn1..vnencont LOOP
                      IF (cnAcEnc >= vnJ) THEN
                        csEnc:= csN;
                        EXIT;
                      ELSE
                        csEnc:= csS;
                        vnCual := vnCual+cn1;

                        cnAcEnc:= cnAcEnc+tabEncues(vnCual).rNoCrn;

                        IF (vnCual > cn1) THEN EXIT; END IF;
                      END IF;
                 END LOOP;

                 IF (csEnc = csS AND vnCual > cn1 ) THEN
                    htp.p('<th colspan="2" class="thFont7" style="border-right:none;">'||'Valoraci&oacute;n Promedio del Profesor (VPP)'||'</th>');
                 END IF;

                 tabVal(vnJ)  := vnMedValProm;
                 htp.p('<th valign="top" style="width:60.0px;" class="thFont8">'||TO_CHAR(ROUND(vnMedValProm,cn2),cs90p99)||'</th>'); --mediavalperiodo
                 vbPintaColProm := f_PintaColumnaPromedio((cn1+ (cn19 * (vnVuelta))),vnVuelta);

                 IF vbPintaColProm = TRUE THEN
                     vnMediaTot18 := vnMediaTot18 + ROUND(tabMedValPP(vnCat)/(vnI-vnTotEvaTerm),2);
                     vnTotEva18   := vnTotEva18 + cn1;
                     htp.p('<th valign="top" style="width:60.0px;" class="thFont8">'||TO_CHAR(ROUND(tabMedValPP(vnCat)/(vnI-vnTotEvaTerm),cn2),cs90p99)||'</th>'); --mediaval_promper
                     vnTotEvaTerm := cn0;
                     vnCat := vnCat + cn1;
                 END IF;
                 vnVuelta := vnVuelta + cn1;
             END LOOP;

             htp.p('<th valign="top" bgcolor="#CCCCCC" style="width:60.0px;" class="thFont8">'||TO_CHAR(ROUND(vnMediaValProm/(vnI-vnTotEvaluac),cn2),cs90p99)||'</th>'); --medvalprom
             vnDesvValProm :=cn0;

             FOR vnJ IN cn1..tabMedValPP.count LOOP
                 vnDesvValProm := vnDesvValProm + (power(tabVal(vnJ)- vnMediaValProm/(vnI-vnTotEvaluac),cn2)*tabPromCrn(cn1 + (cn19 * (vnJ-cn1))).rContestaron);
             END LOOP;

             vnDesvValProm := vnDesvValProm/vnTotEva;
             vnDesvValProm := sqrt(vnDesvValProm);

             htp.p('<th valign="top" bgcolor="#CCCCCC" style="width:60.0px;" class="thFont8">'||TO_CHAR(ROUND(vnDesvValProm,cn2),cs90p99)||'</th>'); --desvvalprom

             -- lnea en blanco
             htp.p('</tr><tr class="trTabSepara"><td colspan="'||TO_CHAR((vnCursos * cn2) + cn6)||'" bgcolor="#ffffff" style="border-right:none;border-left:none;"></td></tr>');
          END IF;

          vnVuelta   :=  cn0;
          vsTeqaCode := tabPromCrn(vnI).rTeqaCode;

          IF vnI = cn19 THEN
             EXIT;
          END IF;

      END LOOP;

      htp.p('</table>');

  EXCEPTION
      WHEN OTHERS THEN
           HTP.P('ERROR EN LA CONSULTA A LA BASE DE DATOS P_ReactivosEncuesta'||SQLERRM);
  END P_ReactivosEncuesta;

  -- muestra la media y la desviacin por categoria
  procedure P_MediaPorCategoria(psCategoria VARCHAR2,
                                pnRegistros INTEGER) IS

  vnPreguntas NUMBER  := 0;
  vnMedia     NUMBER  := 0;
  vnDesvi     NUMBER  := 0;
  vnRenglon   INTEGER := 0;
  vnReactivo  INTEGER := 0;
  vnMedCero   INTEGER := 0; --es un contador cuando una media es cero, en el caso de posgrado cuando todos los alumnos evaluaron un reactivo con no aplica

  BEGIN
      FOR vnI IN cn1..pnRegistros LOOP
          vnReactivo := vnReactivo + cn1;

          IF tabPromCrn(vnI).rTeqaCode = psCategoria THEN
             vnPreguntas := vnPreguntas + cn1;

             --las instrucciones son agregradas para contemplar la evaluacin de posgrado
             --la media es igual a cero cuando todos los alumnos evaluaron con no aplica
             IF tabPromCrn(vnI).rMedia = cn0 THEN
                vnMedCero := vnMedCero + cn1;
             END IF;

             IF vnPreguntas = cn1 THEN
                vnRenglon := vnI;
             END IF;

             vnMedia := vnMedia + tabPromCrn(vnI).rMedia;
             vnDesvi := vnDesvi + tabPromCrn(vnI).rDesvi;
          END IF;

          IF vnReactivo = cn19 THEN
             IF pK_Seprad1.cgsPlaneacion = psCategoria THEN
                vnPromedio := vnPromedio + cn1;
             END IF;

             IF vnPreguntas > cn0 AND vnMedia > cn0 THEN
                BEGIN
                    SELECT vnMedia/(vnPreguntas-vnMedCero)
                      INTO vnMedia
                      FROM DUAL;
                EXCEPTION
                    WHEN ZERO_DIVIDE THEN
                         SELECT vnMedia/vnPreguntas
                           INTO vnMedia
                           FROM DUAL;
                END;
             END IF;

             IF vnPreguntas > cn0 AND vnDesvi > cn0 THEN
                BEGIN
                    SELECT vnDesvi/(vnPreguntas-vnMedCero)
                      INTO vnDesvi
                      FROM DUAL;
                EXCEPTION
                    WHEN ZERO_DIVIDE THEN
                         SELECT vnDesvi/vnPreguntas
                           INTO vnDesvi
                           FROM DUAL;
                END;
             END IF;

             tabPromCrn(vnRenglon).rMedCat := vnMedia;

             vnReactivo  := cn0;
             vnPreguntas := cn0;
             vnMedia     := cn0;
             vnDesvi     := cn0;
             vnRenglon   := cn0;
             vnMedCero   := cn0;
          END IF;
      END LOOP;

  EXCEPTION
      WHEN OTHERS THEN
           HTP.P('ERROR EN LA CONSULTA ALA BASE DE DATOS P_MediaPorCategoria('||vnPreguntas||'-'||vnMedCero||')'||SQLERRM);
  END P_MediaPorCategoria;

  BEGIN

      -- valida que el usuario pertenezca a la base de datos.
      IF psSiu IS NULL THEN
         IF PK_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;
      ELSE
         IF NOT twbkwbis.F_ValidUser(global_pidm) THEN RETURN; END IF;
      END IF;


      -- son buscados los valores de las cookies para asignar los valores del filtro del query
      vsUniv := pk_objHtml.getValueCookie('psSprUn');
      vsEncu := pk_objHtml.getValueCookie('psSeprd');
      vsColl := pk_objHtml.getValueCookie('psSprCH');
      vnPidm := pk_objHtml.getValueCookie('psSprPd');

      -- obtiene el valor si es una encuesta base, para mostrar las adicionales
      SELECT MAX(SWRCENC_PRINCIPAL), MAX(SWRCENC_ASOCIA)
        INTO vsEsEncBase, vnAnidaEncu
        FROM SWRCENC
       WHERE SWRCENC_TSSC_CODE = vsEncu;

      htp.p('<html><head><title>'||psReclDesc||'</title>');

      -- la aplicaci&oacute;n no se guarda en el cache de la mquina.
      PK_ObjHTML.P_NoCache;

      -- c&oacute;digo css
      PK_ObjHTML.P_CssTabs;
      htp.p('<script language="JavaScript"><!--');
      htp.p('function fImprimeReporte() {
                window.focus()
                print();}');
      htp.p('//--></script>');
      htp.p('</head><body bgcolor="#ffffff" class="bodyCeroR"><br/>');
      htp.p('<script language="javascript" src="kwacnls.js"></script>');

      vgColl := vsColl;
      tabEncues(cn1).rInicia   := cn1;
      FOR regPro IN cuPromedio(vsColl, vnPidm, vsUniv, vsEncu) LOOP
          vnRow := vnRow + cn1;

          tabPromCrn(vnRow).rEncuesta    := regPro.Encuesta;
          tabPromCrn(vnRow).rTermCode    := regPro.termCode;
          tabPromCrn(vnRow).rTeqaCode    := regPro.teqaCode;
          tabPromCrn(vnRow).rQcodCode    := regPro.qcodCode;
          tabPromCrn(vnRow).rCRN         := regPro.Crn;
          tabPromCrn(vnRow).rMedia       := regPro.Media;
          tabPromCrn(vnRow).rDesvi       := regPro.Desviacion;
          tabPromCrn(vnRow).rTitle       := regPro.Title;
          tabPromCrn(vnRow).rContestaron := regPro.Contestaron;
          tabPromCrn(vnRow).rInscritos   := regPro.Inscritos;
          tabPromCrn(vnRow).rMedProm     := cn0;
          tabPromCrn(vnRow).rDesProm     := cn0;
          tabPromCrn(vnRow).rMediaZero   := cn0;

          IF  tabPromCrn(vnRow).rEncuesta <>  vsEncuD THEN
             IF (vsEncuD != 'Inicio' ) THEN
                tabEncues(vnencont).rFin   := vnRow + cn1  ;
                tabEncues(vnencont).rNoCrn := vnTotCrn  ;
                vnNumPer  := cn0;
                vnTotCrn  := cn0;
             END IF;
             vnencont := vnencont + cn1;
             tabEncues(vnencont).rEncuesta := tabPromCrn(vnRow).rEncuesta;
             IF (tabEncues(vnencont).rInicia IS NULL) THEN
                tabEncues(vnencont).rInicia   := vnRow;
             END IF;
          END IF;

          IF (vsCrnP != tabPromCrn(vnRow).rCRN  OR vsCrnP IS NULL )  THEN
             vnTotCrn := vnTotCrn + cn1;
          END IF;

          IF tabPromCrn(vnRow).rTermCode  <> rTermAnt or rTermAnt IS NULL THEN
             vnNumPer := vnNumPer + cn1;
             tabEncues(vnencont).rPeriodos  := vnNumPer;
          END IF;

         vsEncuD  := tabPromCrn(vnRow).rEncuesta;
         rTermAnt := tabPromCrn(vnRow).rTermCode;
         vsCrnP   := tabPromCrn(vnRow).rCRN;
      END LOOP;
      tabEncues(vnencont).rFin   := vnRow;
      tabEncues(vnencont).rNoCrn := vnTotCrn  ;

      FOR regPreg IN pk_Seprad1.cuPreguntas LOOP
          P_MediaPorCategoria(regPreg.Categ, vnRow);
      END LOOP;


      FOR vnJ IN cn1..tabEncues.count LOOP
        vnPerTot := vnPerTot + tabEncues(vnJ).rPeriodos;
        vnTotCrn := vnTotCrn + tabEncues(vnJ).rNoCrn;
      END LOOP;

      IF vnRow > cn0 THEN
          htp.p('
              <table border="0" cellpadding="2" cellspacing="1" bordercolor="#ffffff" bgcolor="#ffffff" width="100%">
                <tr class="trTabSepara">
                  <td rowspan="4" width="10%" valign="top"><img src="/imagenes/logo_uft.jpg'||'" width="80" border="0"></td>
                  <td colspan="2" width="90%" align="left" valign="top" class="tdTitulo"><b>'||REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(psReclDesc,'~aacute','&aacute'),'~eacute','&eacute'),'~iacute','&iacute'),'~oacute','&oacute'),'~uacute','&uacute')||'. '||'Profesor'||': </b>&nbsp;'||pK_Seprad1.F_NameProfesor(vnPidm)||' ('||pK_Seprad1.F_IdProfesor(vnPidm)||')</td>
                </tr>
                <tr>
                  <td width="70%" valign="top" >'||'Evaluaciones de la escuela de '||' '||pk_Seprad1.F_CollDesc(vsColl)||'</td>
                  <td width="30%" valign="top" align="right">'||pK_Seprad1.F_Fecha||'</td>
                </tr>
                <tr>
                  <td colspan="3"></td>
                </tr>
               </table><br/>');

          P_ReactivosEncuesta();

          htp.p('<br/></body></html>');
      ELSE
         HTP.P('No hay datos que mostrar dados los filtros de la consulta ');
      END IF;

  EXCEPTION
      WHEN NO_DATA_FOUND THEN
           HTP.P('- NO Hay Informacin para los Filtros Seleccionados -');
      WHEN OTHERS THEN
           htp.p('ERROR EN LA CONSULTA ALA BASE DE DATOS PromedioPorCurso'||SQLERRM);

  END PWREVHS;
/


DROP PUBLIC SYNONYM PWREVHS;

CREATE PUBLIC SYNONYM PWREVHS FOR BANINST1.PWREVHS;


GRANT EXECUTE ON BANINST1.PWREVHS TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWREVHS TO WWW2_USER;
DROP PROCEDURE BANINST1.PWREVXS;

CREATE OR REPLACE PROCEDURE BANINST1.PWREVXS(psReclDesc VARCHAR2) IS

/*
    Nombre: Eventos por Saln
    Fecha: 05/10/2009
    Autor: MAC


*/

  vgsUSR           VARCHAR2(500);
  ckCount          INTEGER;
  ckNombres        owa_cookie.vc_arr;
  ckValores        owa_cookie.vc_arr;
  vgsInicoPag      VARCHAR2(10)                     := NULL;

  vnRow            INTEGER                          := 0;
  vnRegs           INTEGER                          := 0;
  vnExists         INTEGER                          := 0;
  vnColumnas       INTEGER                          := 17;
  vnSaltoPag       INTEGER                          := 28; --La variables utilizada para determinar la cantidad de registros que tiene una tabla para dar un salto de pgina
  tabColumna       Pk_Sisrepimp.tipoTabla          := Pk_Sisrepimp.tipoTabla(1);
  tabSubColu       Pk_Sisrepimp.tipoTabla          := Pk_Sisrepimp.tipoTabla(1);
  tabPeriodo       Pk_Sisrepimp.tipoTabla          := Pk_Sisrepimp.tipoTabla(1);
  vsPerio          VARCHAR2(100)                    := NULL;
  vsFacu           VARCHAR2(100)                    := NULL;
  psInicioPagina   VARCHAR2(10)                     := NULL;
  vsPeriodo        VARCHAR2(50)                     := NULL;
  vsTipo           VARCHAR2(50)                     := NULL;
  vsUnive          VARCHAR2(50)                     := NULL;
  vsSeccion        VARCHAR2(3)                      := NULL;
  vsBlanco         VARCHAR2(5)                      := NULL;
  vsDesde          VARCHAR2(50)                     := NULL;
  vsHasta          VARCHAR2(50)                     := NULL;
  vsEdifi          VARCHAR2(50)                     := NULL;
  vsSalon          VARCHAR2(50)                     := NULL;

  CURSOR cuReporte(psUnive    VARCHAR2 DEFAULT NULL,
                   psTerm     VARCHAR2 DEFAULT NULL,
                   psFacu     VARCHAR2 DEFAULT NULL) IS
         SELECT *
           FROM (SELECT DISTINCT NVL(slbevnt_camp_code,'S/Univ')            universidad,
                        ssrmeet_term_code                                   periodo,
                        pk_catalogo.colegio(slbevnt_coll_code)              escuela,
                        ssrmeet_bldg_code                                   edificio,
                        ssrmeet_room_code                                   salon,
                        slbevnt_crn                                         crn,
                        slbevnt_desc                                        descripcion,
                        slbevnt_etyp_code                                   tipo_evento,
                        ssrmeet_start_date                                  inicio,
                        ssrmeet_end_date                                    fin,
                        DECODE(ssrmeet_mon_day, 'M', 'Lu', ssrmeet_mon_day) lu,
                        DECODE(ssrmeet_tue_day, 'T', 'Ma', ssrmeet_tue_day) ma,
                        DECODE(ssrmeet_wed_day, 'W', 'Mi', ssrmeet_wed_day) mi,
                        DECODE(ssrmeet_thu_day, 'R', 'Ju', ssrmeet_thu_day) ju,
                        decode(ssrmeet_fri_day, 'F', 'Vi', ssrmeet_fri_day) vi,
                        decode(ssrmeet_sat_day, 'S', 'Sa', ssrmeet_sat_day) sa,
                        substr(ssrmeet_begin_time,1,2)||':'||
                        nvl(substr(ssrmeet_begin_time,3,2),'00')            hora_inicio,
                        substr(ssrmeet_end_time,1,2)||':'||
                        nvl(substr(ssrmeet_end_time,3,2),'00')              hora_fin
                   from slbevnt,
                        ssrmeet,
                        (select stvterm_code,
                                stvterm_start_date,
                                stvterm_end_date
                           from stvterm
                          where (stvterm_code = psterm  or psterm is null)
                        ) stvterm
                  where slbevnt_crn                 = ssrmeet_crn
                    and ssrmeet_term_code           = stvterm_code(+)
                    and (slbevnt_camp_code          = psunive or psunive is null)
                    and (slbevnt_coll_code          = psfacu  or psfacu is null)
                    union all
                 select distinct nvl(ssbsect_camp_code,'S/Univ')            universidad,
                        se.ssbsect_term_code                                periodo,
                        pk_catalogo.colegio(scbcrse_coll_code)              escuela,
                        ssrmeet_bldg_code                                   edificio,
                        ssrmeet_room_code                                   salon,
                        ssbsect_crn                                         crn,
                        scbcrse_title                                       descripcion,
                        'Curso'                                             tipo_evento,
                        ssrmeet_start_date                                  inicio,
                        ssrmeet_end_date                                      fin,
                        decode(ssrmeet_mon_day, 'M', 'Lu', ssrmeet_mon_day) lu,
                        decode(ssrmeet_tue_day, 'T', 'Ma', ssrmeet_tue_day) ma,
                        decode(ssrmeet_wed_day, 'W', 'Mi', ssrmeet_wed_day) mi,
                        decode(ssrmeet_thu_day, 'R', 'Ju', ssrmeet_thu_day) ju,
                        decode(ssrmeet_fri_day, 'F', 'Vi', ssrmeet_fri_day) vi,
                        decode(ssrmeet_sat_day, 'S', 'Sa', ssrmeet_sat_day) sa,
                        substr(ssrmeet_begin_time,1,2)||':'||
                         nvl(substr(ssrmeet_begin_time,3,2),'00')            hora_inicio,
                        substr(ssrmeet_end_time,1,2)||':'||
                        nvl(substr(ssrmeet_end_time,3,2),'00')              hora_fin
                   from ssbsect se,
                        scbcrse,
                        ssrmeet sr
                  where scbcrse_eff_term           = (select max(scbcrse_eff_term)
                                                        from scbcrse a
                                                       where a.scbcrse_eff_term  <= se.ssbsect_term_code
                                                         and a.scbcrse_subj_code  = se.ssbsect_subj_code
                                                         and a.scbcrse_crse_numb  = se.ssbsect_crse_numb
                                                     )
                    and ssbsect_subj_code           = scbcrse_subj_code
                    and ssbsect_crse_numb           = scbcrse_crse_numb
                    and ssbsect_term_code           = ssrmeet_term_code
                    and ssbsect_crn                 = ssrmeet_crn
                    and (ssbsect_camp_code          = psunive or psunive is null)
                    and (ssbsect_term_code          = psterm  or psterm is null)
                    and (scbcrse_coll_code          = psfacu  or psfacu is null)
                )
          order by periodo desc, escuela, descripcion, crn, lu, ma, mi, ju, vi, sa, hora_inicio;

  CURSOR cuComentarios (psCRN  slbevnt.slbevnt_crn%TYPE ) IS
        SELECT st.slrecmt_comments    Comentario
          FROM slrecmt st
         WHERE st.slrecmt_crn = psCRN
         ORDER BY st.slrecmt_seqno;

  BEGIN
      /* Check/update the user's web session */
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
          ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);


      IF ckCount != 0 THEN
          FOR vnCOKIES IN 1..ckCount LOOP
              IF ckNOMBRES(vnCOKIES) = 'psUnive' THEN
                  vsUnive := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psPerio' THEN
                  vsPerio := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                  vsFacu := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                  vsSeccion := ckValores(vnCOKIES);

              END IF;
          END LOOP;
      END IF;

      -- Las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := 'Escuela';
      tabColumna(2)  := 'Edificio';
      tabColumna(3)  := 'Sal&oacute;n';
      tabColumna(4)  := 'Nmero de reservacin o NRC';
      tabColumna(5)  := 'Descripcin del evento o nombre de la materia';
      tabColumna(6)  := 'Tipo de evento';
      tabColumna(7)  := 'Fecha inicio';
      tabColumna(8)  := 'Fecha fin';
      tabColumna(9)  := 'Lu';
      tabColumna(10) := 'Ma';
      tabColumna(11) := 'Mi';
      tabColumna(12) := 'Ju';
      tabColumna(13) := 'Vi';
      tabColumna(14) := 'Sa';
      tabColumna(15) := 'Hora inicio';
      tabColumna(16) := 'Hora fin';
      tabColumna(17) := 'Comentario';

      FOR regRep IN cuReporte(vsUnive, vsPerio, vsFacu) LOOP

          IF vsPeriodo IS NULL OR regRep.Periodo <> vsPeriodo OR
             vsUnive IS NULL OR regRep.Universidad <> vsUnive THEN --OR vnRow = 0 OR vnRow = 30 THEN

              Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,vgsInicoPag,'1','#000000', psSubtitulo=>'Periodo '||regRep.Periodo, psUsuario=>vgsUSR, psSeccion=>vsSeccion, psUniversidad=> regRep.Universidad);
              vgsInicoPag := 'SALTO';
              vnRow := 0;

          END IF;

          vsUnive    := regRep.Universidad;
          vsPeriodo  := regRep.Periodo;

          htp.p('<tr><td valign="top">'           ||regRep.Escuela     ||'</td>
                 <td valign="top">'               ||regRep.Edificio    ||'</td>
                 <td valign="top">'               ||regRep.Salon       ||'</td>
                 <td valign="top">'               ||regRep.CRN         ||'</td>
                 <td valign="top">'               ||regRep.Descripcion ||'</td>
                 <td valign="top">'               ||regRep.Tipo_evento ||'</td>
                 <td valign="top">'               ||regRep.Inicio      ||'</td>
                 <td valign="top">'               ||regRep.Fin         ||'</td>
                 <td valign="top" align="center">'||regRep.Lu          ||'</td>
                 <td valign="top" align="center">'||regRep.Ma          ||'</td>
                 <td valign="top" align="center">'||regRep.Mi          ||'</td>
                 <td valign="top" align="center">'||regRep.Ju          ||'</td>
                 <td valign="top" align="center">'||regRep.Vi          ||'</td>
                 <td valign="top" align="center">'||regRep.Sa          ||'</td>
                 <td valign="top" align="center">'||regRep.Hora_Inicio ||'</td>
                 <td valign="top" align="center">'||regRep.Hora_Fin    ||'</td>
                 <td valign="top" align="center">');


          FOR regComent IN cuComentarios(regRep.CRN ) LOOP

              htp.p( regComent.Comentario|| '<br>');

          END LOOP;

          htp.p('</td></tr>');

          vnExists := 1;
          vnRow    := vnRow + 1;

      END LOOP;

      -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- es omitido el encabezado del reporte pero se agrega el salto de pagina
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>vgsUSR, psSeccion=>vsSeccion);

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      END IF;

      htp.p('</table></body></html>');
  EXCEPTION
      WHEN OTHERS THEN htp.p( SQLERRM);

  END PWREVXS;

-- REPORTE DE BLOQUES
/


DROP PUBLIC SYNONYM PWREVXS;

CREATE PUBLIC SYNONYM PWREVXS FOR BANINST1.PWREVXS;


GRANT EXECUTE ON BANINST1.PWREVXS TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWREVXS TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRFICU;

CREATE OR REPLACE PROCEDURE BANINST1.PWRFICU(
	psPidm				VARCHAR2
	,psPerio			VARCHAR2 DEFAULT NULL
	,psAcTr				VARCHAR2 DEFAULT NULL
	,psUser				VARCHAR2 DEFAULT USER
) IS

	--Variable apuntador a cursor para el cursor del reporte
	vcCuDocs			pk_Matricula.t_CurFichaCuenta;
	--Tipo de tabla (arreglo) para almacenar la salida del cursor
	TYPE t_TblDocs is TABLE OF pk_Matricula.t_RegFichaCuenta;
	--El arreglo en si
	vtDocs				t_TblDocs;

	--Cursor para los datos base del alumno
	CURSOR cuDatosBase(pnPidm NUMBER) IS
		SELECT
			SPRIDEN_ID									AS IdAlum
			,SPBPERS_NAME_SUFFIX						AS RutAlum
			,REPLACE(SPRIDEN_FIRST_NAME||' '||SPRIDEN_MI
				||' '||SPRIDEN_LAST_NAME,'*',' ')		AS NomAlum
		FROM
			SPBPERS
			,SPRIDEN
		WHERE
			SPBPERS_PIDM(+) = SPRIDEN_PIDM
			AND SPRIDEN_PIDM = pnPidm
			AND SPRIDEN_CHANGE_IND IS NULL;

	--Una variable del tipo de renglon del cursor
	vrDatosBase			cuDatosBase%ROWTYPE;

	--Contador comun y corriente
	vni					PLS_INTEGER;

	--una bandera bien pirata, sirve para saber si hubo documentos
	--del estado especificado
	vbBandera			BOOLEAN := FALSE;

BEGIN

	--Abro el cursor y extraigo la info
	pk_Matricula.p_CurFichaCuenta(vcCuDocs, psPidm, psPerio, psAcTr );
	FETCH vcCuDocs BULK COLLECT INTO vtDocs;
	CLOSE vcCuDocs;

	--Si la coleccion esta vacia ... mandamos al usuario a la guerra de corea
	-- :p
	IF vtDocs.COUNT < 1 THEN
		HTP.P('No se encontraron documentos para este contrato');
		RETURN;
	END IF;

	--Obtengo los datos base del alumno
	OPEN cuDatosBase(TO_NUMBER(psPidm));
	FETCH cuDatosBase INTO vrDatosBase;
	CLOSE cuDatosBase;

	--Aqui comienzo el trazado del estado de cuenta
	HTP.P('
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<title> Estado de Cuenta (Ficha Cuenta) del Alumno </title>
	</head>
	<style type="text/css">
		body{
			font-family: Arial, Helvetica, sans-serif;
			margin: 15px;
			width:780px;
			padding: 0;
		}

		td.DatosFinis{
			width: 70%;
			vertical-align: top;
		}

		table.DatosFinis{
			font-size: 12px;
		}

		td.DatosOper{
			width: 30%;
			vertical-align: top;
		}

		table.DatosOper{
			font-size: 9px;
		}

		h1.Titulo{
			font-weight: bold;
			font-size: 19px;
			text-align: center;
		}

		table.DatosCntr{
			font-size: 12px;
			width: 400px;
		}

		table.DatosCntr td.NombreCampo{
			width: 120px;
		}

		.NombreCampo{
			font-weight:bold;
		}

		h2.Seccion{
			margin-top: 15px;
			text-align: left;
			font-size: 14px;
			font-style: italic;
		}

		table.Docs{
			font-size: 10px;
			/*table-layout: fixed;*/
			border-collapse: collapse;
			border-spacing: 0px;
		}

		table.Docs td{
			padding: 3px;
			/*border: 1px solid black;*/
		}

		tr.EncCol{
			font-weight: bold;
			text-align: center;
			overflow: hidden;
			background-color: #CCCCCC;
		}

		tr.Par{
			background-color: #EEEEEE;
		}

		tr.Impar{
			background-color: #FFFFFF;
		}

		td.EncDCPe{
			width: 8%;
		}

		td.EncDCCn{
			width: 8%;
		}

		td.EncDCMP{
			width: 14%;
		}

		td.EncDCND{
			width: 8%;
		}

		td.EncDCFV{
			width: 9%;
		}

		td.EncDCMn{
			width: 9%;
		}

		td.Monto{
			text-align: right;
		}

		td.Fecha{
			text-align: center;
		}

	</style>
	<body>
		<table >
			<tr>
				<td class="DatosFinis">
					<table class="DatosFinis">
						<tr><td>Universidad Finis Terrae</td></tr>
						<tr><td>Educaci&oacute;n</td></tr>
						<tr><td>70.884.700-3</td></tr>
						<tr><td>Av. Pedro de Valdivia 1509</td></tr>
						<tr><td>Providencia, Santiago</td></tr>
					</table>
				</td>
				<td class="DatosOper">
					<table class="DatosOper">
						<tr>
							<td class="NombreCampo">
								Operador:
							</td>
							<td>
								'||psUser||'
							</td>
						</tr>
						<tr>
							<td class="NombreCampo">
								Fecha/Hora Emisi&oacute;n:
							</td>
							<td>
								'||TO_CHAR(SYSDATE,'DD/MM/YYYY HH24:MI:SS')||'
							</td>
						</tr>
					</table>
				</td>
			</tr>
		</table>

		<h1 class="Titulo">'
	);
	--En base a la forma en que fue invocado el reporte, cambio el titulo
	IF psAcTr IS NULL THEN
		HTP.P('Ficha cuenta del alumno');
	ELSE
		HTP.P('Listado de documentos vigentes');
	END IF;
	HTP.P('</h1>

		<table class="DatosCntr">
			<tr>
				<td class="NombreCampo">
					Alumno
				</td>
				<td>
					'||vrDatosBase.NomAlum||' ('||vrDatosBase.IdAlum||')
				</td>
			</tr>
			<tr>
				<td class="NombreCampo">
					RUT Alumno:
				</td>
				<td>
					'||vrDatosBase.RutAlum||'
				</td>
			</tr>
		</table>

		<h2 class="Seccion">
			Documentos, compromisos y pagos:
		</h2>

		<table class="Docs" cellspacing="0">
			<tr class="EncCol">
				<td class="EncDCPe">Periodo</td>
				<td class="EncDCCn">Contrato</td>
				<td class="EncDCMP">Medio <br/>de Pago</td>
				<td class="EncDCND">N&uacute;mero<br/>Documento</td>
				<td class="EncDCMn">Monto <br/>Nominal</td>
				<td class="EncDCMn">Monto</td>
				<td class="EncDCMn">Otros <br/>Cargos</td>
				<td class="EncDCFV">Fecha <br/>Ingreso</td>
				<td class="EncDCFV">Fecha <br/>Vencimiento</td>
				<td class="EncDCFV">Fecha <br/>Pago</td>
				<td>Estado</td>
			</tr>');

	FOR vni IN 1..vtDocs.COUNT LOOP
		HTP.P('
			<tr class="'||CASE MOD(vni,2) WHEN '0' THEN 'Par' ELSE 'Impar' END||'">
				<td>'||vtDocs(vni).Perio||'</td>
				<td>'||vtDocs(vni).Cntr||'</td>
				<td>'||vtDocs(vni).DescMP||'</td>
				<td>'||vtDocs(vni).NumDoc||'</td>
				<td class="Monto">'||TO_CHAR(vtDocs(vni).Monto,'FM999G999G999')||'</td>
				<td class="Monto">'||TO_CHAR(vtDocs(vni).MontoNom,'FM999G999G999')||'</td>
				<td class="Monto">'||TO_CHAR(vtDocs(vni).CargosExt,'FM999G999G999')||'</td>
				<td class="Fecha">'||TO_CHAR(vtDocs(vni).FechaEnt,'DD/MM/YYYY')||'</td>
				<td class="Fecha">'||TO_CHAR(vtDocs(vni).FechaVig,'DD/MM/YYYY')||'</td>
				<td class="Fecha">'||TO_CHAR(vtDocs(vni).FechaPag,'DD/MM/YYYY')||'</td>
				<td class="Fecha">'||vtDocs(vni).DescStatus||'</td>
			</tr>');
	END LOOP;
	HTP.P('
		</table>
	</body>
</html>');

END PWRFICU;
/


DROP PUBLIC SYNONYM PWRFICU;

CREATE PUBLIC SYNONYM PWRFICU FOR BANINST1.PWRFICU;


GRANT EXECUTE ON BANINST1.PWRFICU TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRFICU TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRFICU TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRFICU TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRFICU TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRGEST;

CREATE OR REPLACE PROCEDURE BANINST1.PWRGEST (
    psReclDesc            VARCHAR2
) IS
/*************************************************************************************
PROCEDIMIENTO:        PWRGEST
OBJETIVO:            Reporte General Estudiantes
PARAMETROS:
psReclDesc            Variable estandar para la maquina de reportes custom
AUTOR:                Alejandra Mungua
FECHA:                20120828
***************************************************************************************/
    --Numero de renglones
    vnRow                PLS_INTEGER := 0;
    --Bandera para mostrar si hubo datos
    vnExists                INTEGER := 0;
    --Numero de columnas
    vnColumnas         INTEGER := 30;
    --Numero de registros
    vnRegs                INTEGER := 0;
    --Arreglo (nested table) donde se guardan los encabezados de las columnas
    tabColumna            Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
    -- la variable es una bandera que al tener el valor "imprime" no colocara
    --el salto de pgina para impresion
    vsInicoPag            VARCHAR2(10) := NULL;
    --Nmero de renglones por pgina
    vnRegsPag            PLS_INTEGER := 25;

    --Variable para guardar el periodo deseado
    vsPerio                STVTERM.STVTERM_CODE%TYPE;

    --Variable para guardar EL PROGRAMA DESEADO
    vsEscu                STVCOLL.STVCOLL_CODE%TYPE;
    --Fecha del reporte
    vdFecha                DATE;
    -- Indicador Semestral
    vsIndSem             VARCHAR2(5);
    --Anexa variables para condicionar si se quiere imprimir el encabezado o no
    vsEnca     VARCHAR2(1)            := NULL;
    vbEnca     BOOLEAN                := TRUE;

    CURSOR cuReporte(
        psPerio    VARCHAR2
        ,psEscu        VARCHAR2
     ) IS

        SELECT  SPBPERS_NAME_SUFFIX                                         RUT
                        ,SPRIDEN_ID                                                              ID
                         ,TRIM(SPRIDEN_FIRST_NAME||' '||SPRIDEN_MI) Nombre
                        ,replace(SPRIDEN_LAST_NAME,'*',' ')                      Apellidos
                        ,SPBPERS_SEX                                                         Sexo
                        ,SPBPERS_BIRTH_DATE                                         Fecha_Nacimiento
                        ,(SELECT  GOREMAL_EMAIL_ADDRESS
                             FROM  GOREMAL
                           WHERE  GOREMAL_PIDM = SPRIDEN_PIDM
                                AND GOREMAL_EMAL_CODE = 'UFT' )         Correo_UFT
                        ,addr1.spraddr_street_line1             Calle_Lnea_1
                        ,addr1.spraddr_street_line2             Calle_Lnea_2
                        ,addr1.spraddr_city                         Ciudad
                        ,addr1.spraddr_stat_code                EstadoProvincia
                        ,stvcnty_desc                                   Comuna
                        ,stdn1.sgbstdn_stst_code                  Status_Alumno
                        ,stdn1.sgbstdn_styp_code                Tipo_Alumno
                        ,stdn1.sgbstdn_admt_code               Tipo_Admision
                        ,stdn1.sgbstdn_term_code_admit      Periodo_Admision
                        ,(SELECT  stvsbgi_desc
                            FROM   STVSBGI
                                        ,SORHSCH
                            WHERE STVSBGI_CODE = SORHSCH_SBGI_CODE
                                 AND SORHSCH_PIDM = SPRIDEN_PIDM
                                 AND rownum = 1    )            Colegio
                        ,twbcntr_term_code                       Periodo_Matricula
                        ,stdn1.sgbstdn_term_code_matric Periodo_Matriculacin
                        ,stdn1.sgbstdn_program_1           Programa
                        ,smrprle_program_desc               Desc_Programa
                        ,stdn1.sgbstdn_coll_code_1          Escuela
                        ,stvcoll_desc                                 Desc_Escuela
                        ,ssbsect_term_code                      Periodo_NRC
                        ,ssbsect_crn                                 NRC
                        ,nvl(ssbsect_crse_title
                       ,(SELECT crse1.scbcrse_title
                                from  scbcrse crse1
                            where   crse1.scbcrse_subj_code = ssbsect_subj_code
                                and crse1.scbcrse_crse_numb = ssbsect_crse_numb
                                and crse1.SCBCRSE_EFF_TERM = (SELECT MAX(crse2.SCBCRSE_EFF_TERM)
                                                                                               FROM  scbcrse crse2
                                                                                            WHERE   crse2.scbcrse_subj_code = crse1.scbcrse_subj_code
                                                                                                   and crse2.scbcrse_crse_numb = crse1.scbcrse_crse_numb
                                                                                                   and crse2.scbcrse_eff_term <= ssbsect_term_code )  )   )     Titulo_Materia
                        ,ssbsect_subj_code                      Materia
                        ,ssbsect_crse_numb                      Curso
                        ,SSBSECT_SEQ_NUMB           Seccin
                         ,SSBSECT_SESS_CODE         Sesin
        FROM     SPRIDEN
                        ,SPBPERS
                        ,STVCNTY
                        ,SPRADDR addr1
                        ,SGBSTDN STDN1
                        ,SMRPRLE
                        ,STVCOLL
                        ,TWBCNTR
                        ,SFRSTCR
                        ,SSBSECT
        WHERE  STDN1.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(STDN2.SGBSTDN_TERM_CODE_EFF)
                                                                                              FROM  SGBSTDN STDN2
                                                                                            WHERE STDN2.SGBSTDN_PIDM = STDN1.SGBSTDN_PIDM
                                                                                                AND STDN2.SGBSTDN_TERM_CODE_EFF <= TWBCNTR_TERM_CODE )
            AND SMRPRLE_PROGRAM = STDN1.SGBSTDN_PROGRAM_1
            AND STVCOLL_CODE        = STDN1.SGBSTDN_COLL_CODE_1
            AND SPRIDEN_PIDM            = STDN1.SGBSTDN_PIDM
            AND SPRIDEN_CHANGE_IND IS NULL
            AND SPBPERS_PIDM(+)     = SPRIDEN_PIDM
            AND TWBCNTR_PIDM        = SPRIDEN_PIDM
            AND (STDN1.SGBSTDN_COLL_CODE_1 = psEscu  OR psEscu IS NULL)
--            AND TWBCNTR_TERM_CODE = psPerio
            and TWBCNTR_status_ind  <> 'C'
            AND addr1.SPRADDR_pidm(+) = spriden_pidm
            and addr1.spraddr_atyp_code = 'PR'
            and addr1.SPRADDR_SEQNO = ( select  max(addr2.spraddr_seqno)
                                                                      from  spraddr addr2
                                                                   where  addr2.spraddr_pidm = addr1.spraddr_pidm
                                                                       and addr2.spraddr_atyp_code = addr1.spraddr_atyp_code )
            and stvcnty_code            = addr1.spraddr_cnty_code
            and sfrstcr_pidm              = spriden_pidm
            and sfrstcr_term_code     = psPerio
            and sfrstcr_rsts_code      in ('RE','RW')
            and ssbsect_term_code  = sfrstcr_term_code
            and ssbsect_crn             = sfrstcr_crn;

BEGIN

    --Seguridad de GWAMNUR
    IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;
--HTP.P('PARAMETROS ');
    --Obtengo el numero de corte que se desea para el usuario dado
    vsPerio := pk_objHtml.getValueCookie('psPerio');

    --Obtengo de las cookies el valor fechas de corte de caja
    vsEscu := pk_objHtml.getValueCookie('psEscu');

   -- obtengo el encabezado
   vsEnca    := pk_ObjHtml.getValueCookie('psEnca');

    --Obtenemos la fecha
    vdFecha := NVL(TO_DATE(pk_objHtml.getValueCookie('psFecha'),'DD/MM/YYYY'),SYSDATE);

--HTP.P('PARAMETROS periodo:'||vsPerio||' escu:'||vsProg);
 --HTP.P('PARAMETROS'||vnRetractosDia||'-'||vnRetractosAcum||'-'||);
 IF vsEscu = 'ZZ' then
 vsEscu := NULL;
 END IF;
    -- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
    tabColumna.EXTEND(vnColumnas);

    --Guardamos los encabezados en el arreglo de columnas
    tabColumna( 1) := 'RUT';
    tabColumna( 2) := 'ID';
    tabColumna( 3) := 'Nombre';
    tabColumna( 4) :=  'Apellidos';
    tabColumna( 5) :=  'Sexo';
    tabColumna( 6) := 'Fecha Nacimiento';
    tabColumna( 7) := 'Correo UFT';
    tabColumna( 8) := 'Direccin 1';
    tabColumna( 9) := 'Direccin 2';
    tabColumna(10) := 'Ciudad';
    tabColumna(11) := 'Estado Provincia';
    tabColumna(12) := 'Comuna';
    tabColumna(13) := 'Status Alumno';
    tabColumna(14) := 'Tipo Alumno';
    tabColumna(15) := 'Tipo Admision';
    tabColumna(16) := 'Colegio';
    tabColumna(17) := 'Periodo Matricula';
    tabColumna(18) := 'Periodo Matriculacin';
    tabColumna(19) := 'Programa';
    tabColumna(20) := 'Desc Programa';
    tabColumna(21) := 'Periodo Ingreso';
    tabColumna(22) := 'Escuela';
    tabColumna(23) := 'Desc Escuela';
    tabColumna(24) := 'Periodo NRC';
    tabColumna(25) := 'NRC';
    tabColumna(26) := 'Titulo Materia';
    tabColumna(27) := 'Materia';
    tabColumna(28) := 'Curso';
    tabColumna(29) := 'Seccin';
    tabColumna(30) := 'Sesin';

    --Inicializamos contador de renglones
    vnRow := 0;

    FOR regReporte IN cuReporte(vsPerio, vsEscu) LOOP

        --Incremento el contador de renglones
        vnRow := vnRow + 1;
        vnExists := 1; --Bandera para indicar que hubo resultados

      --IF para poner o quitar encabezados

        --Si es el primer renglon de cada pgina...
            IF MOD(vnRow, vnRegsPag) = 1  and vbEnca THEN
                --imprimo el encabezado de reporte
                Pk_Sisrepimp.P_EncabezadoDeReporte(
                    psReclDesc ,vnColumnas ,tabColumna
                    ,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
                );
                vsInicoPag := 'SALTO';
            END IF;

       IF vsEnca = 'N' THEN
             vbEnca := FALSE;
      end if;




        --Comienzo a desplegar el renglon
        HTP.P('<tr>');

        HTP.P('<td>'||regReporte.RUT||'</td>');
        HTP.P('<td>'||regReporte.ID||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Nombre ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Apellidos ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Sexo ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Fecha_Nacimiento ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Correo_UFT ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Calle_Lnea_1 ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Calle_Lnea_2 ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Ciudad ||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.EstadoProvincia||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Comuna||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Status_Alumno||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Tipo_Alumno||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Tipo_Admision||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Colegio||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Periodo_Matricula||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Periodo_Matriculacin||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Programa||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Desc_Programa||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Periodo_Admision||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Escuela||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Desc_Escuela||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Periodo_NRC||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.NRC||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Titulo_Materia||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Materia||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Curso||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Seccin||'</td>');
        HTP.P('<td style="text-align:right;">'||regReporte.Sesin||'</td>');

        --Fin del renglon
        HTP.P('</tr>');

    END LOOP;



    IF vnExists = 0 THEN
        --Ojo esta linea lo que hace es imprimir
        --NO SE ENCONTRARON DATOS o un mensaje similar
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
    ELSE

        -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pagina
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
    END IF;

    --Fin de la pagina
    htp.p('</table><br/></body></html>');
EXCEPTION
    WHEN OTHERS THEN
        --pantallazo de error.
        pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
            'PWRGEST', NULL);
END PWRGEST;
/


DROP PUBLIC SYNONYM PWRGEST;

CREATE PUBLIC SYNONYM PWRGEST FOR BANINST1.PWRGEST;


GRANT EXECUTE ON BANINST1.PWRGEST TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRHACA;

CREATE OR REPLACE PROCEDURE BANINST1.PWRHACA (psReclDesc   VARCHAR2) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de historia acadmica
        mdulo: admisiones - uft.
         autor: hmr - socorro crdenas.
         fecha:13/07/2012.


*******************************************************************************/

  -- declaracin de variables:
  vnExists       INTEGER      := 0;
  vnColumnas     INTEGER      := 18;
  vgsInicioPag   VARCHAR2(30) := NULL;         -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vnIdRenglon    INTEGER      := 1;
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);

  vsTerm        SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE	DEFAULT NULL;
  vsEscu	SGBSTDN.SGBSTDN_COLL_CODE_1%TYPE	DEFAULT NULL;
  vsExped       SPRIDEN.SPRIDEN_ID%TYPE		DEFAULT NULL;

  -- obtiene la informacin de los alumnos:
  CURSOR cuReporte (	psTerm		VARCHAR2  DEFAULT NULL,
                        psEscu		VARCHAR2  DEFAULT NULL,
                        psExped		VARCHAR2  DEFAULT NULL ) IS
        SELECT
                SPRIDEN_ID					as ID,
                SPBPERS_NAME_SUFFIX				as RUT,
                SPRIDEN_FIRST_NAME				as NOMBRES,
                SPRIDEN_LAST_NAME				as APELLIDOS,
                SGBSTDN_PROGRAM_1				as PROGRAMA,
                SGBSTDN_COLL_CODE_1				as ESCUELA ,
                SGBSTDN_TERM_CODE_ADMIT				as PRDO_INGRESO,
                PK_CATALOGO.TipoAlumno(SGBSTDN_STYP_CODE) as DTipolumno,
                PK_CATALOGO.STASTST	(SGBSTDN_STST_CODE) as DStatus,
                SGBSTDN_STYP_CODE 				as TipoAlumno,
                SGBSTDN_STST_CODE				as Status,
                COUNT(SFRSTCR_CRN)				as NO_ASIG_INSCRITAS,
                REPROBADAS_PERIODO.TOTAL_REPROBADAS_PERIODO	as REPROBADAS,
                to_char(round(PPERIODO.PGPA,2),'999.99')				as PROMEDIO_PERIODO,
                 X.SMBPOGN_ACT_PROGRAM_GPA PGA,
                to_char(A.PONDERADO,'999.99')					as PP_Acumulado,
                REPROBADAS.TOTAL_REPROBADAS			as No_Asig_Rep_Acum,
                APROBADAS.TOTAL_APROBADAS			as No_Asig_Aprob_Acum
                 FROM
                  (SELECT * FROM SFRSTCR WHERE SFRSTCR_TERM_CODE = psTerm and SFRSTCR_RSTS_CODE IN ('RE', 'RW')),
                  SGBSTDN S,
                  SPRIDEN,
                  SPBPERS,
                  (SELECT * FROM SMBPOGN Z
                   WHERE Z.SMBPOGN_REQUEST_NO = (SELECT MAX(Y.SMBPOGN_REQUEST_NO) FROM SMBPOGN Y
                    							WHERE z.SMBPOGN_PIDM = Y.SMBPOGN_PIDM)) X,
                  (SELECT SHRTGPA_PIDM, SHRTGPA_LEVL_CODE, ROUND(DECODE(SUM(SHRTGPA_QUALITY_POINTS), 0, 0,SUM(SHRTGPA_QUALITY_POINTS) / SUM(SHRTGPA_GPA_HOURS)),2) PONDERADO
                   FROM SHRTGPA GROUP BY SHRTGPA_PIDM,SHRTGPA_LEVL_CODE) A,
                  (SELECT SHRTGPA_PIDM PPIDM, SHRTGPA_TERM_CODE, SHRTGPA_GPA PGPA FROM SHRTGPA WHERE SHRTGPA_TERM_CODE = psTerm)  PPERIODO,
                  (SELECT N.SHRTCKN_PIDM PIDM, COUNT(N.SHRTCKN_CRN) TOTAL_APROBADAS
                             FROM SHRTCKN N, SHRTCKG G
                     WHERE G.SHRTCKG_PIDM = N.SHRTCKN_PIDM
                       AND N.SHRTCKN_TERM_CODE <= psTerm
                       AND G.SHRTCKG_TERM_CODE = N.SHRTCKN_TERM_CODE
                       AND G.SHRTCKG_TCKN_SEQ_NO = N.SHRTCKN_SEQ_NO
                        AND G.SHRTCKG_SEQ_NO =
                      (SELECT MAX (G1.SHRTCKG_SEQ_NO) nl
                         FROM SHRTCKG G1
                        WHERE G1.SHRTCKG_PIDM = G.SHRTCKG_PIDM
                          AND G1.SHRTCKG_TERM_CODE = G.SHRTCKG_TERM_CODE
                          AND G1.SHRTCKG_TCKN_SEQ_NO = G.SHRTCKG_TCKN_SEQ_NO)
                        AND (SHRTCKG_GRDE_CODE_FINAL >= '4,0')
                        AND (SHRTCKG_GRDE_CODE_FINAL <> 'NV')
                        GROUP BY SHRTCKN_PIDM)                                       APROBADAS,
                  (SELECT N.SHRTCKN_PIDM RPIDM, COUNT(N.SHRTCKN_CRN) TOTAL_REPROBADAS
                    FROM SHRTCKN N, SHRTCKG G
                     WHERE G.SHRTCKG_PIDM = N.SHRTCKN_PIDM
                            AND N.SHRTCKN_TERM_CODE <= psTerm
                            AND G.SHRTCKG_TERM_CODE = N.SHRTCKN_TERM_CODE
                            AND G.SHRTCKG_TCKN_SEQ_NO = N.SHRTCKN_SEQ_NO
                            AND G.SHRTCKG_SEQ_NO =
                      (SELECT MAX (G1.SHRTCKG_SEQ_NO)
                         FROM SHRTCKG G1
                        WHERE G1.SHRTCKG_PIDM = G.SHRTCKG_PIDM
                          AND G1.SHRTCKG_TERM_CODE = G.SHRTCKG_TERM_CODE
                          AND G1.SHRTCKG_TCKN_SEQ_NO = G.SHRTCKG_TCKN_SEQ_NO)
                         AND (SHRTCKG_GRDE_CODE_FINAL <= '3,9')
                         AND (SHRTCKG_GRDE_CODE_FINAL <> 'NV')
                     GROUP BY SHRTCKN_PIDM)                                         REPROBADAS,
                  (SELECT N.SHRTCKN_PIDM RPIDM, COUNT(N.SHRTCKN_CRN) TOTAL_REPROBADAS_PERIODO
                        FROM SHRTCKN N, SHRTCKG G
                     WHERE G.SHRTCKG_PIDM = N.SHRTCKN_PIDM
                         AND G.SHRTCKG_TERM_CODE = N.SHRTCKN_TERM_CODE
                         AND G.SHRTCKG_TCKN_SEQ_NO = N.SHRTCKN_SEQ_NO
                         AND G.SHRTCKG_SEQ_NO =
                      (SELECT MAX (G1.SHRTCKG_SEQ_NO)
                         FROM SHRTCKG G1
                        WHERE G1.SHRTCKG_PIDM = G.SHRTCKG_PIDM
                          AND G1.SHRTCKG_TERM_CODE = G.SHRTCKG_TERM_CODE
                          AND G1.SHRTCKG_TCKN_SEQ_NO = G.SHRTCKG_TCKN_SEQ_NO)
                          AND (SHRTCKG_GRDE_CODE_FINAL <= '3,9')
                           AND (SHRTCKG_GRDE_CODE_FINAL <> 'NV')
                         AND SHRTCKN_TERM_CODE = psTerm
                         GROUP BY SHRTCKN_PIDM) REPROBADAS_PERIODO
                where SPRIDEN_ID=nvl(psExped,SPRIDEN_ID)
                AND s.SGBSTDN_COLL_CODE_1=nvl(psEscu,s.SGBSTDN_COLL_CODE_1)
		AND SGBSTDN_PIDM = SPRIDEN_PIDM
                AND SGBSTDN_PIDM = SPBPERS_PIDM
                AND SGBSTDN_PIDM = APROBADAS.PIDM(+)
                AND SGBSTDN_PIDM = REPROBADAS.RPIDM(+)
                AND SGBSTDN_PIDM = REPROBADAS_PERIODO.RPIDM(+)
                AND SGBSTDN_PIDM = X.SMBPOGN_PIDM(+)
                AND S.SGBSTDN_PROGRAM_1    = X.SMBPOGN_PROGRAM(+)
                AND SPRIDEN_CHANGE_IND IS NULL
                and S.SGBSTDN_PIDM = SFRSTCR_PIDM(+)
                AND S.SGBSTDN_PIDM = A.SHRTGPA_PIDM(+)
                AND S.SGBSTDN_LEVL_CODE = A.SHRTGPA_LEVL_CODE(+)
                AND S.SGBSTDN_PIDM = PPERIODO.PPIDM(+)
                AND S.SGBSTDN_TERM_CODE_EFF =
                                      (SELECT MAX (SS.SGBSTDN_TERM_CODE_EFF)
                                         FROM SGBSTDN SS
                                        WHERE SGBSTDN_PIDM = S.SGBSTDN_PIDM)
            GROUP BY SPRIDEN_ID,
                SPBPERS_NAME_SUFFIX,
                SPRIDEN_FIRST_NAME,
                SPRIDEN_LAST_NAME,
                SGBSTDN_PROGRAM_1,
                SGBSTDN_COLL_CODE_1,
                SGBSTDN_TERM_CODE_ADMIT,
                SGBSTDN_STYP_CODE,
                SGBSTDN_STST_CODE,
                A.PONDERADO,
                X.SMBPOGN_ACT_PROGRAM_GPA,
                PPERIODO.PGPA,
                REPROBADAS.TOTAL_REPROBADAS,
                APROBADAS.TOTAL_APROBADAS,
                REPROBADAS_PERIODO.TOTAL_REPROBADAS_PERIODO  ;
---------------------------------------------------
-- bloque principal para la generacin del reporte
---------------------------------------------------
BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
   vsEscu := pk_ObjHtml.getValueCookie('psEscu');
   vsExped := pk_ObjHtml.getValueCookie('psExped');


   -- determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   -- define los encabezados de las columnas:
   tabColumna(1)  := '<left> ID';
   tabColumna(2)  := '<left> RUT';
   tabColumna(3)  := '<left> Nombres';
   tabColumna(4)  := '<left> Apellidos';
   tabColumna(5)  := '<left> Programa';
   tabColumna(6)  := '<leftr> Escuela';
   tabColumna(7)  := '<left> Periodo Ingreso';
   tabColumna(8)  := '<left> Estatus  al periodo <br/> de consulta';
   tabColumna(9)  := '<left> Descripci&oacute;n Estatus';
   tabColumna(10)  := '<left> Tipo del alumno al periodo  <br/> de consulta';
   tabColumna(11)  := '<left> Descripci&oacute;n Tipo de Alumno';
   tabColumna(12)  := '<left> Asignaturas Inscritas <br/> al periodo de consulta';
   tabColumna(13)  := '<left> Asignaturas Reprobadas<br/> al periodo de consulta';
   tabColumna(14)  := '<left> Promedio Ponderado Periodo';
   tabColumna(15) := '<left>  Promedio Ponderado Acumulado <br/>(todas las asignaturas del historial)';
   tabcolumna(16) := '<left> Asignaturas Reprobadas Acumuladas';
   tabColumna(17) := '<left> Asignaturas Aprobadas Acumuladas';
   tabColumna(18) := '<left> Promedio acumulado ponderado <br/>(asignaturas acreditas de la malla)';


   -- manipula la informacin obtenida por el cursor:
   FOR regRep IN cuReporte (vsTerm,vsEscu,vsExped) LOOP

       IF vnExists = 0 THEN

          -- muestra el encabezado segn el periodo y programa seleccionados:
          IF vsEscu IS NOT NULL THEN
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||'<br>'||'Escuela: &nbsp;'||vsEscu||' - '||Pk_Catalogo.Colegio(vsEscu),
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
          ELSE
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||'<br>'||'Escuela: &nbsp;'||'Todos ',
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
          END IF;

       END IF;

       -- muestra los valores para cada registro:
       HTP.P('<tr> <td valign="top" align="right">'   ||regRep.ID              ||'</td>
                   <td valign="top" align="left">'   ||regRep.RUT               ||'</td>
                   <td valign="top" align="left">'   ||regRep.Nombres        ||'</td>
                   <td valign="top" align="left">'   ||regRep.Apellidos           ||'</td>
                   <td valign="top" align="left">'   ||regRep.PROGRAMA		||'</td>
                   <td valign="top" align="left">'   ||regRep.ESCUELA		||'</td>
                   <td valign="top" align="right">'   ||regRep.PRDO_INGRESO      ||'</td>
                   <td valign="top" align="right">'   ||regRep.STATUS       ||'</td>
                   <td valign="top" align="right">'   ||regRep.DStatus    ||'</td>
                   <td valign="top" align="right">'   ||regRep.TIPOALUMNO      ||'</td>
                   <td valign="top" align="right">'   ||regRep.DTipolumno      ||'</td>
		            <td valign="top" align="right">'  ||regRep.NO_ASIG_INSCRITAS ||'</td>
                   <td valign="top" align="right">' ||regRep.REPROBADAS        ||'</td>
                   <td valign="top" align="right">' ||regRep.PROMEDIO_PERIODO  ||'</td>
                   <td valign="top" align="right">' ||regRep.PP_Acumulado      ||'</td>
                   <td valign="top" align="right">' ||regRep.No_Asig_Rep_Acum  ||'</td>
                   <td valign="top" align="right">' ||regRep.No_Asig_Aprob_Acum ||'</td>
                   <td valign="top" align="right">' ||regRep.PGA ||'</td>
             </tr>');

       vnExists    := 1;
       vnIdRenglon := vnIdRenglon + 1;
   -- END IF;
   END LOOP;

   -- muestra el pie de reporte:
   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- omite el encabezado del reporte pero se agrega el salto de pgina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRHACA;
/


DROP PUBLIC SYNONYM PWRHACA;

CREATE PUBLIC SYNONYM PWRHACA FOR BANINST1.PWRHACA;


GRANT EXECUTE ON BANINST1.PWRHACA TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRHACA TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRHACA TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRHACA TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRHDPH;

CREATE OR REPLACE PROCEDURE BANINST1.PWRHDPH(psReclDesc VARCHAR2,
                                             psTerm     VARCHAR2 DEFAULT NULL,
                                             psEscu     VARCHAR2 DEFAULT NULL,
                                             psTipo     VARCHAR2 DEFAULT NULL,
                                             pnPidm     NUMBER   DEFAULT NULL,
                                             psPtrm     VARCHAR2 DEFAULT NULL,
                                             psType     VARCHAR2 DEFAULT NULL,
                                             psUser     VARCHAR2 DEFAULT NULL,
                                             psPlaHon   VARCHAR2 DEFAULT 'HON'
                                           ) IS

/*
   Modificacion: 08/04/2010
                 CCR
                 Se agrego el parametro psUser que le haca falta para generar correctamente el
                 reporte

*/

  vgsUSR VARCHAR2(500);

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      PWRHRAS(psReclDesc, psTerm, psEscu, psTipo, pnPidm, psPtrm, psType, vgsUSR, 'PWRHDPH', psPlaHon);
      htp.p('<script language="javascript" src="kwacnls.js"></script>');
  END PWRHDPH;
/


DROP PUBLIC SYNONYM PWRHDPH;

CREATE PUBLIC SYNONYM PWRHDPH FOR BANINST1.PWRHDPH;


GRANT EXECUTE ON BANINST1.PWRHDPH TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRHDPH TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRHDPL;

CREATE OR REPLACE PROCEDURE BANINST1.PWRHDPL(psReclDesc VARCHAR2,
                                             psTerm     VARCHAR2 DEFAULT NULL,
                                             psEscu     VARCHAR2 DEFAULT NULL,
                                             psTipo     VARCHAR2 DEFAULT NULL,
                                             pnPidm     NUMBER   DEFAULT NULL,
                                             psPtrm     VARCHAR2 DEFAULT NULL,
                                             psType     VARCHAR2 DEFAULT NULL,
                                             psUser     VARCHAR2 DEFAULT NULL,
                                             psPlaHon   VARCHAR2 DEFAULT 'PLA'
                                           ) IS
/*
   Modificacion: 08/04/2010
                 CCR
                 Se agrego el parametro psUser que le haca falta para generar correctamente el
                 reporte

*/

  vgsUSR VARCHAR2(500);

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      PWRHRAS(psReclDesc, psTerm, psEscu, psTipo, pnPidm, psPtrm, psType, vgsUSR, 'PWRHDPL', psPlaHon);
 htp.p('<script language="javascript" src="kwacnls.js"></script>');
  END PWRHDPL;
/


DROP PUBLIC SYNONYM PWRHDPL;

CREATE PUBLIC SYNONYM PWRHDPL FOR BANINST1.PWRHDPL;


GRANT EXECUTE ON BANINST1.PWRHDPL TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRHDPL TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRHIAC;

CREATE OR REPLACE PROCEDURE BANINST1.PWRHIAC ( psReclDesc  VARCHAR2,
											   psCopia	   VARCHAR2	 DEFAULT NULL )	IS

/*******************************************************************************
		 tarea:	procedimiento que genera el	reporte	de historia	acadmica.
	 propsito:	obtener	informacin	de la historia acadmica de	un alumno
				determinado.
		mdulo:	historia acadmica - uft.
	   reporte:	historia acadmica v.2.
		 autor:	Pablo serratos
		 fecha:	28/02/2012.
*******************************************************************************/

  TYPE reg_History IS RECORD ( AreaCode	  VARCHAR2(60),
							   Orden	  VARCHAR2(15),
							   Grup		  VARCHAR2(15),
							   Subj		  VARCHAR2(15),
							   Crse		  VARCHAR2(15),
							   AreaDesc	  VARCHAR2(200),
							   Title	  VARCHAR2(300),
							   Clave	  VARCHAR2(10),
							   Creditos	  VARCHAR2(5),
							   GrdeFinal  VARCHAR2(5),
							   Periodo	  VARCHAR2(8),
							   campCode	  VARCHAR2(5),
							   GmodCode	  VARCHAR2(5),
							   Crnn		  VARCHAR2(5),
							   Grupo	  VARCHAR2(5),
							   Prio		  VARCHAR2(5),
							   Requ		  VARCHAR2(3),
							   Term		  VARCHAR2(6)
							  );

  TYPE tableHistory	IS TABLE OF	reg_History	INDEX BY BINARY_INTEGER;

  tabHist		 tableHistory;

  vnRow			 INTEGER						   := 0;
  vnRows		 INTEGER						   := 0;
  vnExists		 INTEGER						   := 0;
  vnColumnas	 INTEGER						   := 12;
  vnNumPagina	 INTEGER						   := 1;
  vnTotPagina	 INTEGER						   := 0;
  vnReprobadas	 INTEGER						   := 0;
  vnReprobada2	 INTEGER						   := 0;
  vnMaterias	 NUMBER							   := 0;
  vnPromArit	 NUMBER							   := 0;
  vnLastPidm	 NUMBER							   := 0;
  vnTotalCre	 NUMBER							   := 0;
  vnTotAcred	 NUMBER							   := 0;
  vnPorcCred	 NUMBER							   := 0;
  vnPidm		 NUMBER							   := 0;
  vnValida		 NUMBER							   := 0;
  tabColumna	 Pk_Sisrepimp.tipoTabla			   := Pk_Sisrepimp.tipoTabla(1);
  vsSeccion		 VARCHAR2(3)					   := '3';
  vsSinPiePag	 VARCHAR2(1)					   := NULL;
  vsBackGround	 VARCHAR2(25)					   := NULL;
  vsBloqueDesc	 VARCHAR2(1000)						:= NULL;
  vsProgCode	 VARCHAR2(25)					   := NULL;
  vsRUT		VARCHAR2(25)					  := NULL;
  vsBreakPoint	 VARCHAR2(10)					   := NULL;
  vsInicoPag	 VARCHAR2(10)					   := NULL;
  vsGrdeCode	 smrdocn.smrdocn_grde_code%type	   := NULL;
  vsSeppCode	 VARCHAR2(10)					   := NULL;
  vsSinValidez	 VARCHAR2(1)					   := psCopia;
  vsDocSinVald	 VARCHAR2(30)					   := NULL;
  vnCred		 swbprog.swbprog_num_creditos%type := NULL;
  vbBloqueE		 BOOLEAN						   := TRUE;

  csOtros		 CONSTANT VARCHAR2(5)  := 'OTROS';
  csSinDecs		 CONSTANT VARCHAR2(15) := 'SIN DESCRIPCION';
  csBloqueElc	 CONSTANT VARCHAR2(15) := 'OTROS';
  csBloque		 CONSTANT VARCHAR2(6)  := 'BLOQUE';
  csN			 CONSTANT VARCHAR2(1)  := 'N';
  csOU			 CONSTANT VARCHAR2(2)  := 'OU';
  csAC			 CONSTANT VARCHAR2(2)  := 'AC';
  csX			 CONSTANT VARCHAR2(1)  := 'X';
  csCampus		 CONSTANT VARCHAR2(6)  := f_Contexto();
  csMAJOR		 CONSTANT VARCHAR2(5)  := 'MAJOR';
  csAst			 CONSTANT VARCHAR2(1)  := '*';
  csEsp			 CONSTANT VARCHAR2(1)  := '	';
  csS			 CONSTANT VARCHAR2(1)  := 'S';
  csT			 CONSTANT VARCHAR2(1)  := 'T';
  csC			 CONSTANT VARCHAR2(1)  := 'C';
  csA			 CONSTANT VARCHAR2(1)  := 'A';
  csF			 CONSTANT VARCHAR2(1)  := 'F';
  csY			 CONSTANT VARCHAR2(1)  := 'Y';
  csV			 CONSTANT VARCHAR2(1)  := 'V';
  csR			 CONSTANT VARCHAR2(1)  := 'R';
  csRM			 CONSTANT VARCHAR2(2)  := 'RM';
  csP			 CONSTANT VARCHAR2(1)  := 'P';
  csCN			 CONSTANT VARCHAR2(2)  := 'CN';
  csNV			 CONSTANT VARCHAR2(2)  := 'NV';
  csER			 CONSTANT VARCHAR2(2)  := 'ER';
  cn0			 CONSTANT INTEGER	   := 0;
  cn1			 CONSTANT INTEGER	   := 1;
  cn2			 CONSTANT INTEGER	   := 2;
  cn3			 CONSTANT INTEGER	   := 3;
  cn4			 CONSTANT INTEGER	   := 4;
  cn5			 CONSTANT INTEGER	   := 5;
  cn6			 CONSTANT INTEGER	   := 6;
  cn7			 CONSTANT INTEGER	   := 7;
  cn8			 CONSTANT INTEGER	   := 8;
  vnExisteExt	 NUMBER				   := 0;
  -- cucumplimiento
  CURSOR cuCumplimiento	( pnPidm  NUMBER ) IS
		 SELECT	areas.Area	 AS	AreaCode,
				areas.Prio	 AS	Orden,
				areas.Grup	 AS	Grup,
				areas.Subj	 AS	Subj,
				areas.Crse	 AS	Crse,
				LTRIM(
				DECODE(areas.Area,
				csOtros,
				csOtros,
				csBloque,
				csBloqueElc,
				NVL(
				(SELECT	C.SMRACMT_TEXT
				   FROM	SMRACMT	C
				  WHERE	(C.SMRACMT_TERM_CODE_EFF,C.SMRACMT_TEXT_SEQNO) = (SELECT MAX(D.SMRACMT_TERM_CODE_EFF),MAX(D.SMRACMT_TEXT_SEQNO)
																			FROM SMRACMT D
																		   WHERE D.SMRACMT_AREA	= C.SMRACMT_AREA
																		  )
					AND	C.SMRACMT_AREA								   = areas.Area
				  GROUP	BY C.SMRACMT_TEXT
				)
				,csSinDecs||areas.Area)
				)) AS AreaDesc,
				NVL(
					(SELECT	LTRIM(C.SCRSYLN_LONG_COURSE_TITLE)
					   FROM	SCRSYLN	C
					  WHERE	C.SCRSYLN_TERM_CODE_EFF	= (SELECT MAX(D.SCRSYLN_TERM_CODE_EFF)
														 FROM SCRSYLN D
														WHERE D.SCRSYLN_SUBJ_CODE	   = areas.Subj
														  AND D.SCRSYLN_CRSE_NUMB	   = areas.Crse
														  AND D.SCRSYLN_TERM_CODE_EFF <= areas.term
													  )
						AND	C.SCRSYLN_SUBJ_CODE	= areas.Subj
						AND	C.SCRSYLN_CRSE_NUMB	= areas.Crse
					),areas.Titl
				) AS Title,
				NVL(
					(SELECT	M.SWBCRSE_CODE_SEP
					   FROM	SWBCRSE	M
					  WHERE	M.SWBCRSE_SUBJ_CODE	= areas.Subj
						AND	M.SWBCRSE_CRSE_NUMB	= areas.Crse
						AND	M.SWBCRSE_TERM_CODE	= (SELECT MAX(N.SWBCRSE_TERM_CODE)
													 FROM SWBCRSE N
													WHERE N.SWBCRSE_SUBJ_CODE  = areas.Subj
													  AND N.SWBCRSE_CRSE_NUMB  = areas.Crse
													  AND N.SWBCRSE_TERM_CODE <= areas.term
												  )
					),
				areas.Subj||areas.Crse)					AS Clave,
				areas.Cred								AS Creditos,
				areas.Grde								AS GrdeFinal,
				(SELECT	STVTERM_FA_PROC_YR
				   FROM	STVTERM
				  WHERE	STVTERM_CODE = areas.term
												   )	AS Periodo,
				areas.Camp								AS campCode,
				areas.Gmod								AS GmodCode,
				areas.Crnn								AS Crnn,
				SUBSTR(areas.Grup,LENGTH(areas.Grup),1)	AS Grupo,
				areas.Requ								AS Requ,
				areas.term								AS Term
		   FROM	(SELECT	SWRCAPP_AREA		  AS Area,
						SWRCAPP_AREA_PRIORITY AS Prio,
						SWRCAPP_GROUP		  AS Grup,
						SWRCAPP_SUBJ_CODE	  AS Subj,
						SWRCAPP_CRSE_NUMB	  AS Crse,
						SWRCAPP_GRDE_CODE	  AS Grde,
						SWRCAPP_TERM_CODE	  AS Term,
						SWRCAPP_CREDIT_HOURS  AS Cred,
						SWRCAPP_GMOD_CODE	  AS Gmod,
						SWRCAPP_CRN			  AS Crnn,
						SWRCAPP_TITLE		  AS Titl,
						SWRCAPP_REQUEST_NO	  AS Requ,
						SWRCAPP_CAMP_CODE	  AS Camp
				   FROM	SWRCAPP
				  WHERE	SWRCAPP_CRSE_SOURCE	<> csR
					AND	SWRCAPP_GMOD_CODE	<> csX
				 ) areas
		  ORDER	BY Orden,
				   Grupo,
				   Clave,
				   AreaDesc;

  -- cumateriasreprobadas
  CURSOR cuMateriasReprobadas (	psSubj	VARCHAR2,
								psCrse	VARCHAR2,
								pnPidm	NUMBER ) IS
		 SELECT	SHRTCKG_GRDE_CODE_FINAL						 AS	GrdeFinal,
				(SELECT	STVTERM_FA_PROC_YR
				   FROM	STVTERM
				  WHERE	STVTERM_CODE = M.SHRTCKN_TERM_CODE)	 AS	Periodo,
				(SELECT	DECODE(STVTERM_TRMT_CODE,
						csS,cn1,csT,cn2,csC,cn3,csA,cn4,csF,cn5,csY,cn6,csV,cn7,cn8)
				   FROM	STVTERM
				  WHERE	STVTERM_CODE = M.SHRTCKN_TERM_CODE)	 AS	Orden,
				M.SHRTCKN_TERM_CODE							 AS	Term,
				SHRTCKG_CREDIT_HOURS						 AS	Credito
		   FROM	SHRTCKG,
				SHRTCKN	M,
				SHRTCKL,
				SHRGRDE	A
		  WHERE	M.SHRTCKN_PIDM				  =	SHRTCKG_PIDM
			AND	SHRTCKG_TERM_CODE			  =	M.SHRTCKN_TERM_CODE
			AND	SHRTCKG_TCKN_SEQ_NO			  =	M.SHRTCKN_SEQ_NO
			AND	SHRTCKG_SEQ_NO				  =	(SELECT	MAX	(SHRTCKG_SEQ_NO)
												   FROM	SHRTCKG
												  WHERE	SHRTCKG_PIDM		= SHRTCKN_PIDM
													AND	SHRTCKG_TERM_CODE	= SHRTCKN_TERM_CODE
													AND	SHRTCKG_TCKN_SEQ_NO	= SHRTCKN_SEQ_NO
												 )
			AND	SHRTCKL_PIDM				  =	M.SHRTCKN_PIDM
			AND	SHRTCKL_TERM_CODE			  =	M.SHRTCKN_TERM_CODE
			AND	SHRTCKL_TCKN_SEQ_NO			  =	M.SHRTCKN_SEQ_NO
			AND	A.SHRGRDE_CODE				  =	SHRTCKG_GRDE_CODE_FINAL
			AND	A.SHRGRDE_LEVL_CODE			  =	SHRTCKL_LEVL_CODE
			AND	A.SHRGRDE_TERM_CODE_EFFECTIVE =	(SELECT	MAX	(B.SHRGRDE_TERM_CODE_EFFECTIVE)
												   FROM	SHRGRDE	B
												  WHERE	B.SHRGRDE_CODE				   = SHRTCKG_GRDE_CODE_FINAL
													AND	B.SHRGRDE_LEVL_CODE			   = SHRTCKL_LEVL_CODE
													AND	B.SHRGRDE_TERM_CODE_EFFECTIVE <= M.SHRTCKN_TERM_CODE
												 )
			AND	EXISTS (SELECT NULL
						  FROM SWVHIAC
						 WHERE SWVHIAC_PIDM				   = M.SHRTCKN_PIDM
						   AND SWVHIAC_SUBJ				   = M.SHRTCKN_SUBJ_CODE
						   AND SWVHIAC_CRSE				   = M.SHRTCKN_CRSE_NUMB
						   AND SWVHIAC_TERM_CODE		   = M.SHRTCKN_TERM_CODE
						   AND SWVHIAC_PASSED_IND		   = csN
						   AND (
								 (
									  SWVHIAC_QUALITY_POINTS	 >=	cn5
								  AND
									  SWVHIAC_QUALITY_POINTS	  <	cn6
								  )
							   OR
								  SHRTCKG_GRDE_CODE_FINAL =	csOU
							   )
						)
			AND	NOT	EXISTS (SELECT NULL
							  FROM SWRCAPP
							 WHERE SWRCAPP_TERM_CODE = M.SHRTCKN_TERM_CODE
							   AND SWRCAPP_GMOD_CODE = SHRTCKG_GMOD_CODE
							   AND SWRCAPP_GRDE_CODE = SHRTCKG_GRDE_CODE_FINAL
							   AND SWRCAPP_CRSE_NUMB = psCrse
							   AND SWRCAPP_SUBJ_CODE = psSubj
						   )
			AND	SHRTCKG_GMOD_CODE  <> csX
			AND	M.SHRTCKN_PIDM		= pnPidm
			AND	M.SHRTCKN_CRSE_NUMB	= psCrse
			AND	M.SHRTCKN_SUBJ_CODE	= psSubj
		  ORDER	BY Term, Orden;

  -- cumateriasaprobadas
  CURSOR cuMateriasAprobadas ( psSubj  VARCHAR2,
							   psCrse  VARCHAR2,
							   pnPidm  NUMBER )	IS
		 SELECT	SHRTCKG_GRDE_CODE_FINAL						AS GrdeFinal,
				(SELECT	STVTERM_FA_PROC_YR
				   FROM	STVTERM
				  WHERE	STVTERM_CODE = M.SHRTCKN_TERM_CODE)	AS Periodo,
				(SELECT	DECODE(STVTERM_TRMT_CODE,
						csS,cn1,csT,cn2,csC,cn3,csA,cn4,csF,cn5,csY,cn6,csV,cn7,cn8)
				   FROM	STVTERM
				  WHERE	STVTERM_CODE = M.SHRTCKN_TERM_CODE)	AS Orden,
				M.SHRTCKN_TERM_CODE							AS Term,
				SHRTCKG_CREDIT_HOURS						AS Credito
		   FROM	SHRTCKG,
				SHRTCKN	M,
				SHRTCKL,
				SHRGRDE	A
		  WHERE	M.SHRTCKN_PIDM				  =	SHRTCKG_PIDM
			AND	SHRTCKG_TERM_CODE			  =	M.SHRTCKN_TERM_CODE
			AND	SHRTCKG_TCKN_SEQ_NO			  =	M.SHRTCKN_SEQ_NO
			AND	SHRTCKG_SEQ_NO				  =	(SELECT	MAX	(SHRTCKG_SEQ_NO)
												   FROM	SHRTCKG
												  WHERE	SHRTCKG_PIDM		= SHRTCKN_PIDM
													AND	SHRTCKG_TERM_CODE	= SHRTCKN_TERM_CODE
													AND	SHRTCKG_TCKN_SEQ_NO	= SHRTCKN_SEQ_NO
												 )
			AND	SHRTCKL_PIDM				  =	M.SHRTCKN_PIDM
			AND	SHRTCKL_TERM_CODE			  =	M.SHRTCKN_TERM_CODE
			AND	SHRTCKL_TCKN_SEQ_NO			  =	M.SHRTCKN_SEQ_NO
			AND	A.SHRGRDE_CODE				  =	SHRTCKG_GRDE_CODE_FINAL
			AND	A.SHRGRDE_LEVL_CODE			  =	SHRTCKL_LEVL_CODE
			AND	A.SHRGRDE_TERM_CODE_EFFECTIVE =	(SELECT	MAX	(B.SHRGRDE_TERM_CODE_EFFECTIVE)
												   FROM	SHRGRDE	B
												  WHERE	B.SHRGRDE_CODE				   = SHRTCKG_GRDE_CODE_FINAL
													AND	B.SHRGRDE_LEVL_CODE			   = SHRTCKL_LEVL_CODE
													AND	B.SHRGRDE_TERM_CODE_EFFECTIVE <= M.SHRTCKN_TERM_CODE
												 )
			AND	EXISTS (SELECT NULL
						  FROM SWVHIAC
						 WHERE SWVHIAC_PIDM		  =	M.SHRTCKN_PIDM
						   AND SWVHIAC_SUBJ		  =	M.SHRTCKN_SUBJ_CODE
						   AND SWVHIAC_CRSE		  =	M.SHRTCKN_CRSE_NUMB
						   AND SWVHIAC_TERM_CODE  =	M.SHRTCKN_TERM_CODE
						   AND SWVHIAC_PASSED_IND =	csY
						)
			AND	NOT	EXISTS (SELECT NULL
							  FROM SWRCAPP
							 WHERE SWRCAPP_TERM_CODE = M.SHRTCKN_TERM_CODE
							   AND SWRCAPP_GMOD_CODE = SHRTCKG_GMOD_CODE
							   AND SWRCAPP_GRDE_CODE = SHRTCKG_GRDE_CODE_FINAL
							   AND SWRCAPP_CRSE_NUMB = psCrse
							   AND SWRCAPP_SUBJ_CODE = psSubj
						   )
			AND	SHRTCKG_GMOD_CODE  <> csX
			AND	M.SHRTCKN_PIDM		= pnPidm
			AND	M.SHRTCKN_CRSE_NUMB	= psCrse
			AND	M.SHRTCKN_SUBJ_CODE	= psSubj
		  ORDER	BY Term, Orden;

  -- cuextraordinarios
  CURSOR cuExtraordinarios(psSubj VARCHAR2,
						   psCrse VARCHAR2,
						   pnPidm NUMBER) IS
		 SELECT	SHRTCKG_GRDE_CODE_FINAL					 AS	GrdeFinal,
				(SELECT	STVTERM_FA_PROC_YR
				   FROM	STVTERM
				  WHERE	STVTERM_CODE=SHRTCKN_TERM_CODE)	 AS	Periodo,
				SHRTCKG_CREDIT_HOURS					 AS	Credito
		   FROM	SHRTCKG,
				SHRTCKN,
				SHRTCKL,
				SHRGRDE	A
		  WHERE	SHRTCKN_PIDM				  =	SHRTCKG_PIDM
			AND	SHRTCKG_TERM_CODE			  =	SHRTCKN_TERM_CODE
			AND	SHRTCKG_TCKN_SEQ_NO			  =	SHRTCKN_SEQ_NO
			AND	SHRTCKG_SEQ_NO				  =	(SELECT	MAX(SHRTCKG_SEQ_NO)
												   FROM	SHRTCKG
												  WHERE	SHRTCKG_PIDM		= SHRTCKN_PIDM
													AND	SHRTCKG_TERM_CODE	= SHRTCKN_TERM_CODE
													AND	SHRTCKG_TCKN_SEQ_NO	= SHRTCKN_SEQ_NO
												)
			AND	SHRTCKL_PIDM				  =	SHRTCKN_PIDM
			AND	SHRTCKL_TERM_CODE			  =	SHRTCKN_TERM_CODE
			AND	SHRTCKL_TCKN_SEQ_NO			  =	SHRTCKN_SEQ_NO
			AND	A.SHRGRDE_CODE				  =	SHRTCKG_GRDE_CODE_FINAL
			AND	A.SHRGRDE_LEVL_CODE			  =	SHRTCKL_LEVL_CODE
			AND	A.SHRGRDE_TERM_CODE_EFFECTIVE =	(SELECT	MAX	(B.SHRGRDE_TERM_CODE_EFFECTIVE)
												   FROM	SHRGRDE	B
												  WHERE	B.SHRGRDE_CODE				   = SHRTCKG_GRDE_CODE_FINAL
													AND	B.SHRGRDE_LEVL_CODE			   = SHRTCKL_LEVL_CODE
													AND	B.SHRGRDE_TERM_CODE_EFFECTIVE <= SHRTCKN_TERM_CODE
												)
			AND	SHRTCKG_GMOD_CODE			  =	csX
			AND	SHRTCKG_GRDE_CODE_FINAL		 <>	csRM
			AND	SHRTCKG_GRDE_CODE_FINAL		 <>	csP
			AND	SHRTCKG_GRDE_CODE_FINAL		 <>	csCN
			AND	SHRTCKG_GRDE_CODE_FINAL		 <>	csNV
			AND	SHRTCKN_PIDM				  =	pnPidm
			AND	SHRTCKN_SUBJ_CODE			  =	psSubj
			AND	SHRTCKN_CRSE_NUMB			  =	psCrse
		  ORDER	BY Periodo;

  -- f_encabezado
  function f_Encabezado(pnPidm number, pnRUT varchar2) return varchar2 is

	vsProgDesc	swbprog.swbprog_program_deslar%type	:= null;
	vsLeglName	spbpers.spbpers_legal_name%type		:= null;
	vsID		spriden.spriden_id%type				:= null;
	vsStstCode	sgbstdn.sgbstdn_stst_code%type		:= null;
	vsStstDesc	stvstst.stvstst_desc%type			:= null;
	vsProgAcrd	swbprog.swbprog_fec_acuerdo%type	:= null;
	vsProgNumA	swbprog.swbprog_num_acuerdo%type	:= null;
	vsProgDges	swbprog.swbprog_cve_registro%type	:= null;
	vsProgCred	swbprog.swbprog_num_creditos%type	:= null;
	vsLeyenda	swbprog.swbprog_leyenda%type		:= null;
	vsMajrDesc	varchar2(300)						:= null;
	vsRUT  varchar2(300)					   := null;

  cursor cuEncabezado is
		 select	swbprog_program_deslar	progDesc,
				swbprog_cve_registro	progDges,
				swbprog_fec_acuerdo		progAcrd,
				swbprog_num_acuerdo		progNumA,
				swbprog_num_creditos	progCred,
				swbprog_leyenda			progLeye
		   from	swbprog
		  where	swbprog_program	= vsProgCode;

  begin
		  vsRUT	:= pnRUT;
		  select spriden_id
			into vsID
			from spriden
		   where spriden_pidm		 = pnPidm
			 and spriden_change_ind	is null;

		  select replace(spbpers_legal_name,csAst,csEsp)
			into vsLeglName
			from spbpers
		   where spbpers_pidm =	pnPidm;

		  select a.sgbstdn_stst_code,
				 pk_Catalogo.stastst(a.sgbstdn_stst_code)
			into vsStstCode,
				 vsStstDesc
			from sgbstdn a
		   where a.sgbstdn_term_code_eff = (select max(b.sgbstdn_term_code_eff)
											  from sgbstdn b
											 where b.sgbstdn_pidm =	pnPidm
											)
			 and a.sgbstdn_pidm	= pnPidm;
	  vsMajrDesc :=	FWRMAJR(pnPidm,	vsProgCode);

	  for regEnc in	cuEncabezado loop
		  vsProgDesc :=	regEnc.progDesc;
		  vsProgAcrd :=	regEnc.progAcrd;
		  vsProgNumA :=	regEnc.progNumA;
		  vsProgDges :=	regEnc.progDges;
		  vnCred	 :=	regEnc.progCred;
		  vsLeyenda	 :=	regEnc.progLeye;
	  end loop;

	  if vsLeyenda = 'DEPRE' then
	  --<th	align="right">Acuerdo:</th>
	  --<td	colspan="3">'||'CON	RECONOCIMIENTO DE VALIDEZ OFICIAL DECRETO PRESIDENCIAL PUBLICADO EN	EL D.O.F. DEL VEINTIS&Eacute;IS	DE NOVIEMBRE DE	1982'||'</td>
		  return '<tr class="trSeparador"><td colspan="'||vnColumnas||'" bordercolor="#ffffff"></td></tr>
					 <tr><td colspan="'||vnColumnas||'"	bordercolor="#ffffff" bgcolor="#dddddd">
					 <table	border="0" bordercolor="#000000" width="100%" bgcolor="#dddddd">
					 <tr>
						  <th>Expediente:</th>	<td	>'||vsID||'</td>
						  <th>RUT: </th>  <td >'||vsRUT||'</td>
						  <th>Alumno:  </th>	<td>'||vsLeglName||'</td>
					 <tr>
						  <th>Programa:</th> <td>'||vsProgCode||'</td>
						  <th>Carrera:</th>	 <td>'||vsMajrDesc||'</td>
						  <th>Status:</th>		<td>'||vsStstCode||' '||vsStstDesc||'</td>
					 </tr>
					 </table></td></tr>
					 <tr class="trSeparador"><td colspan="'||vnColumnas||'"	style="border-left:none;border-right:none;"></td></tr>';
	  else
--<th align="right">Acuerdo:</th>
--<td>'||vsProgNumA||'</td></tr>
--<th align="right">DGES:	</th><td>'||vsProgDges||'</td>
--'<th width="10%" align="right">Fecha acuerdo:</th>'||
--'<td width="15%">'||vsProgAcrd||'</td></tr>'||
		  return '<tr class="trSeparador"><td colspan="'||vnColumnas||'" bordercolor="#ffffff"></td></tr>'||
					 '<tr><td colspan="'||vnColumnas||'" bordercolor="#ffffff" bgcolor="#dddddd">'||
					 '<table border="0"	bordercolor="#000000" width="100%" bgcolor="#dddddd">'||
					 '
					  <tr>
						  <th>Expediente:</th>	<td	>'||vsID||'</td>
						  <th>RUT: </th>  <td >'||vsRUT||'</td>
						  <th>Alumno:  </th>	<td>'||vsLeglName||'</td>
					 <tr>
						  <th>Programa:</th> <td>'||vsProgCode||'</td>
						  <th>Carrera:</th>	 <td>'||vsMajrDesc||'</td>
						  <th>Status:</th>		<td>'||vsStstCode||' '||vsStstDesc||'</td>
					 </tr>
					 </table></td></tr>
					 <tr class="trSeparador"><td colspan="'||vnColumnas||'"	style="border-left:none;border-right:none;"></td></tr>';
	  end if;
  end f_Encabezado;

  -- f_pie
  function f_Pie(pnPidm	number)	return varchar2	is

	vnPga NUMBER :=	NULL;

  cursor cuNoCapp is
		 select	(select	stvncrq_desc
				   from	stvncrq
				  where	stvncrq_code = a.shrncrs_ncrq_code
				) ncrqcode,
				(select	stvncst_desc
				   from	stvncst
				  where	stvncst_code = a.shrncrs_ncst_code
				) ncstcode,
				a.shrncrs_ncst_date	ncstdate
		   from	shrncrs	a
		  where	a.shrncrs_pidm = pnPidm;

  begin
	  vnTotalCre :=	vnCred;
	  IF vnPromArit>0 AND vnPromArit>0 THEN
		 vnPromArit	:= TRUNC(vnPromArit/vnMaterias,2);
	  END IF;
	  IF vnTotAcred>0 AND vnTotalCre>0 THEN
		 vnPorcCred	:= TRUNC((vnTotAcred/vnTotalCre)*100,2);
	  END IF;
	  begin
		  select trunc(sum(a.shrtgpa_gpa*shrtgpa_gpa_hours)/sum(shrtgpa_gpa_hours),2)
			into vnPga
			from shrtgpa a
		   where a.shrtgpa_pidm	= pnPidm
			 and shrtgpa_levl_code = substr(vsProgCode,1,2);
	  exception
		  when others then
			   null;
	  end;

	  htp.p('<tr><td colspan="'||vnColumnas||'"	style="border-left:solid #ffffff 1.0pt;border-right:solid #ffffff 1.0pt;border-bottom:solid	#ffffff	1.0pt;">
	  <table border="1"	cellpadding="1"	cellspacing="1"	style="border:solid	#ffffff	1.0pt;"	width="100%">
			 <tr><th style="border:solid #ffffff 1.0pt;" width="10%" align="right" valign="top"	style="font-size:7.0pt;" >Promedio Aritm&eacute;tico</th>
				 <td style="border:solid #ffffff 1.0pt;" width="10%" valign="top">'||vnPromArit||'</td>
				 <th style="border:solid #ffffff 1.0pt;" width="10%" align="right" valign="top"	style="font-size:7.0pt;">Total de cr&eacute;ditos  </td>
				 <td style="border:solid #ffffff 1.0pt;" width="10%" valign="top">'||vnTotalCre||'</td>
				 <td style="border:solid #ffffff 1.0pt;" width="10%"></td>
				 <td style="border:solid #ffffff 1.0pt;" width="10%"></td>
				 <td style="border:solid #ffffff 1.0pt;" width="40%" rowspan="2" valign="top">
				 <table	border="1" cellpadding="0" cellspacing="0" style="border:solid #000000 1.0pt;" width="100%"><tr><td>
				 <table	border="0"	width="100%">
				 <tr><td colspan="3" align="center"	class="tdfont7"><b><u>REQUISITOS CURRICULARES</u></b></td></tr>
				 <tr><td width="33%" align="center"	class="tdfont7"	valign="top"><b><u>Requisito</u></b></td>
					 <td width="34%" align="center"	class="tdfont7"	valign="top"><b><u>Estado	</u></b></td>
					 <td width="33%" align="center"	class="tdfont7"	valign="top"><b><u>Acreditaci&oacute;n</b></u></td></tr>');

	  for regNoc in	cuNoCapp loop
		  htp.p('<tr>
		  <td align="center" valign="top" >'||regNoc.ncrqcode||'</td>
		  <td align="center" valign="top" >'||regNoc.ncstcode||'</td>
		  <td align="center" valign="top" >'||regNoc.ncstdate||'</td>
		  </tr>');
	  end loop;

	   htp.p('</table>
	   </td></tr>
	   </table>
	   </td></tr>
			 <tr><th style="border:solid #ffffff 1.0pt;" align="right" valign="top"	style="font-size:7.0pt;">Promedio Ponderado</th>
				 <td style="border:solid #ffffff 1.0pt;" valign="top">'||vnPga	   ||'</td>
				 <th style="border:solid #ffffff 1.0pt;" align="right" valign="top"	style="font-size:7.0pt;">Total acreditados </th>
				 <td style="border:solid #ffffff 1.0pt;" valign="top">'||vnTotAcred||'</td>
				 <th style="border:solid #ffffff 1.0pt;" align="right" valign="top"	style="font-size:7.0pt;">% de avance</th>
				 <td style="border:solid #ffffff 1.0pt;" valign="top">'||vnPorcCred||'%</td></tr>
	   <tr><td style="border:solid #ffffff 1.0pt;" colspan="3"></td>
		   <td style="border:solid #ffffff 1.0pt;" colspan="3"></td>
		   <td style="border:solid #ffffff 1.0pt;"></td>
		   </tr>
	   <tr><td style="border:solid #ffffff 1.0pt;" colspan="3"></td>
		   <td style="border-left:solid	#ffffff	1.0pt;border-right:solid #ffffff 1.0pt;border-top:solid	#ffffff	1.0pt;border-bottom:solid #000000 1.0pt;" colspan="3"></td>
		   <td style="border:solid #ffffff 1.0pt;"></td>
		   </tr>
	   <tr><td style="border:solid #ffffff 1.0pt;" colspan="3"></td>
		   <th style="border-left:solid	#ffffff	1.0pt;border-right:solid #ffffff 1.0pt;border-top:solid	#000000	1.0pt;border-bottom:solid #ffffff 1.0pt;" colspan="3">Servicios	Escolares</th>
		   <td style="border:solid #ffffff 1.0pt;"></td>
		   </tr>
	   ');

	   if vsSinValidez is not null then
		  htp.p(
		  '<tr><td colspan="3"></td>
			  <th colspan="3" '||pk_ObjHtml.vgsBorderffffff||'>'||vsDocSinVald||'</th>
			  <td></td>
			  </tr>
		  ');
	   end if;

	   htp.p(
	   '
	   <tr><td style="border:solid #ffffff 1.0pt;" colspan="'||vnColumnas||'">
			   Escala de Calificaciones	Numrica de	3.5	 a 7 mnima	de aprobacin 4	(cuatro)
			   </td></tr>
	   <tr><td style="border:solid #ffffff 1.0pt;" colspan="'||vnColumnas||'">
			   Mod.	Cal.: N: Calificacin numrica A:Calificacin alfabtica C:Convalidacin  E	y R	: Equivalencia y Revalidacin X:Eximido
	   </td></tr>
	   ');

	   htp.p('
	   </table>
	   </td></tr>
	   ');
	   return null;
  end f_Pie;

  --f_bloque
  function f_Bloque(psArea varchar2) return	varchar2 is

  begin
	  return '<tr class="trSeparador"><td colspan="'||vnColumnas||'" style="border-bottom:none;"></td></tr>'||
			 '<tr><th colspan="'||vnColumnas||'" style="border-top:none;" align="left">'||
			 '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'||psArea||'</th></tr>';

	  exception
		  when others then
			null;
  end f_Bloque;

  --f_detalledeencabezado
  function f_DetalleDeEncabezado return	varchar2 is

  begin
	  return '<table border="0"	cellpadding="0"	cellspacing="0"	width="100%">'||
			 '<tr class="trSeparador">'||
				 '<td width="90%" align="right"	>Fecha de expedici&oacute;n</td>'||
				 '<td width="10%">&nbsp;'||TO_CHAR(SYSDATE,'DD MON YYYY')||'</td></tr>'||
			 '<tr class="trSeparador">'||
				 '<td align="right"	>Pagina	'||vnNumPagina||' de </td> '||
					 '<form	name="frmTotal'||vnNumPagina||'" onSubmit="return false">'||
				 '<td >&nbsp;'||
					 '<input type="text" name="txtPag" tabindex="-1" style="width:100%;height:100%;border:inset	0;font-size:7.5pt;"	readonly/>'||
				 '</td>'||
				 '</form></tr>'||
			 '</table>';

  end f_DetalleDeEncabezado;

---------------------------------------------------
-- bloque principal	para la	generacin del reporte
---------------------------------------------------
  BEGIN
	  -- valida	que	el usuario tenga acceso	a la base de datos:
	  --IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;
	  -- obtiene los valores de	las	cookies	para asignar los valores del filtro	del	query:
	  vnPidm	 :=	f_get_pidm(pk_ObjHTML.getValueCookie('psExped'));
	  vsProgCode :=	f_get_programa(vnPidm, '999999');--pk_ObjHTML.getValueCookie('psPgm');
	  vsRUT		 :=	f_get_rut(vnPidm);
	  -- realiza la	consulta del capp:
	  PWAHIAC(vnPidm, vsProgCode, 'lic');

	  -- determina el largo	de la tabla:
	  FOR vnI IN 1..vnColumnas LOOP
		  tabColumna.EXTEND(vnI);
		  tabColumna(vnI) := NULL;
	  END LOOP;

	  -- define	los	encabezados	de columnas:
	  tabColumna(1)	 :=	'Nombre	de la materia';
	  tabColumna(2)	 :=	'Clave';
	  --tabColumna(3)  := 'Periodo';
	  tabColumna(3)	 :=	'Cr&eacute;ditos';
	  tabColumna(4)	 :=	'1er. Ord';
	  tabColumna(5)	 :=	'2do. Ord';
	  tabColumna(6)	 :=	'3er. Ord';
	  tabColumna(7)	 :=	'4to. Ord';
	  tabColumna(8)	 :=	'1er. Ext';
	  tabColumna(9)	:= '2do. Ext';
	  --tabColumna(10) := 'Campus';
	  tabColumna(10) :=	'Modo de calificaci&oacute;n';

	  -- manipula la informacin obtenida por el cursor:
	  FOR regCum IN	cuCumplimiento(vnPidm) LOOP
		  IF FWRINNT(regCum.Crnn, regCum.Term, vnPidm) OR regCum.GrdeFinal IN (csP,csRM,csCN,csNV,csER)	THEN
			 --	invalidar nota:	no se muestran las materias	con	calificacin "cn" o	"nv".
			 NULL;
		  ELSE
			 vnRows	:= vnRows +	1;
			 tabHist(vnRows).AreaCode  := regCum.AreaCode;
			 tabHist(vnRows).Orden	   := regCum.Orden;
			 tabHist(vnRows).Grup	   := regCum.Grup;
			 tabHist(vnRows).Subj	   := regCum.Subj;
			 tabHist(vnRows).Crse	   := regCum.Crse;
			 tabHist(vnRows).AreaDesc  := regCum.AreaDesc;
			 tabHist(vnRows).Title	   := regCum.Title;
			 tabHist(vnRows).Clave	   := regCum.Clave;
			 tabHist(vnRows).Creditos  := regCum.Creditos;
			 tabHist(vnRows).GrdeFinal := regCum.GrdeFinal;
			 tabHist(vnRows).Periodo   := regCum.Periodo;
			 tabHist(vnRows).campCode  := regCum.campCode;
			 tabHist(vnRows).GmodCode  := regCum.GmodCode;
			 tabHist(vnRows).Crnn	   := regCum.Crnn;
			 tabHist(vnRows).Grupo	   := regCum.Grupo;
			 tabHist(vnRows).Prio	   := regCum.Orden;
			 tabHist(vnRows).Term	   := regCum.Term;
			 tabHist(vnRows).Requ	   := regCum.Requ;
		  END IF;
	  END LOOP;

	  IF vsSinValidez IS NOT NULL THEN
		 htp.p('<style type="text/css"><!--
					   body	{background-image: url(/imagenes/sinValidez.gif);}
					   -->
				</style>
			   ');
		 vsDocSinVald := 'DOCUMENTO	SIN	VALOR OFICIAL';
	  END IF;

	  FOR vnRws	IN 1..vnRows LOOP
		  vsBreakPoint := 'BK001';
		  IF vnRow = 0 OR vnRow	> 16 THEN
			Pk_Sisrepimp.P_EncabezadoDeReporte(UPPER(psReclDesc),vnColumnas,tabColumna,vsInicoPag,'1',psUsuario=>pk_login.vgsUSR,psSeccion=>vsSeccion,psUniversidad=>csCampus,psDetalle=>f_Encabezado(vnPidm,vsRUT),psDetalle2=>f_DetalleDeEncabezado,psTitulo=>'UNIVERSIDAD FINIS TERRAE', psAlignCell=>'center', psSinPiePag=>vsSinPiePag);
			 vsInicoPag	:= 'SALTO';
			 vsSinPiePag :=	'A';
			 vnTotPagina :=	vnTotPagina	+ 1;
			 vnNumPagina :=	vnNumPagina	+ 1;
			 vnRow		 :=	0;
		  END IF;

		  IF (vsBloqueDesc IS NULL)	OR vsBloqueDesc	<> tabHist(vnRws).AreaDesc OR (vnRow=0)	THEN
			 htp.p(f_Bloque(tabHist(vnRws).AreaDesc));
		  END IF;

		  SELECT DECODE(MOD(vnRow,2),0,'F0FFFF','CDFFFF')
			INTO vsBackGround
			FROM DUAL;

		  IF 'BLOQUE FUNDAMENTAL' <> tabHist(vnRws).AreaDesc THEN
			 tabHist(vnRws).Grupo := NULL;
		  END IF;
		  htp.p('<tr bgcolor="#'||vsBackGround||'">
					 <td width="30%" valign="top" align="left" class="tdfont6">'||tabHist(vnRws).Title||'</td>
					 <td width="6%"	 valign="top" align="center">'||tabHist(vnRws).Clave   ||'</td>
					 <td width="6%"	 valign="top" align="center">'||tabHist(vnRws).Creditos||'</td>
				');
	   --<td width="6%"	 valign="top" align="center">'||tabHist(vnRws).Grupo   ||'</td>
		  -- materias reporbadas:
		  FOR regMat IN	cuMateriasReprobadas(tabHist(vnRws).Subj, tabHist(vnRws).Crse, vnPidm) LOOP
			  IF tabHist(vnRws).Periodo	<> regMat.Periodo OR (tabHist(vnRws).Periodo = regMat.Periodo AND regMat.GrdeFinal <> tabHist(vnRws).GrdeFinal)	THEN
				  vnReprobadas := vnReprobadas + 1;
				  IF tabHist(vnRws).Term < regMat.Term THEN
					 vsGrdeCode	:= tabHist(vnRws).GrdeFinal;
					 vsSeppCode	:= tabHist(vnRws).Periodo;
					 tabHist(vnRws).GrdeFinal := regMat.GrdeFinal;
					 tabHist(vnRws).Periodo	  := regMat.Periodo;
					 IF	regMat.GrdeFinal <>	csOU THEN
						IF regMat.GrdeFinal	> 3.9 THEN
						   vnTotAcred := vnTotAcred	+ regMat.Credito;
						END	IF;
					 END IF;
					 regMat.GrdeFinal := vsGrdeCode;
					 regMat.Periodo	  := vsSeppCode;
				  END IF;
				 --	htp.p('<td width="6%" valign="top" align="center">'||regMat.GrdeFinal||'&nbsp;&nbsp;&nbsp;'||regMat.Periodo||'</td>');
			  END IF;
		  END LOOP;
		  htp.p('<td width="6%"	valign="top" align="center">'||tabHist(vnRws).GrdeFinal||'&nbsp;&nbsp;&nbsp;'||tabHist(vnRws).Periodo||'</td>');
		  -- materias cumateriasaprobadas:
		  FOR regMat IN	cuMateriasAprobadas(tabHist(vnRws).Subj, tabHist(vnRws).Crse, vnPidm) LOOP
			  vnReprobadas := vnReprobadas + 1;
			  htp.p('<td width="6%"	valign="top" align="center">'||regMat.GrdeFinal||'&nbsp;&nbsp;&nbsp;'||regMat.Periodo||'</td>');
		  END LOOP;

		  FOR vnI IN vnReprobadas..2 LOOP
			  htp.p('<td width="6%"	></td>');
		  END LOOP;

		  vnExisteExt := 0;
		  -- extraordinarios
		  FOR regExt IN	cuExtraordinarios(tabHist(vnRws).Subj, tabHist(vnRws).Crse,	vnPidm)	LOOP
			  vnReprobada2 := vnReprobada2 + 1;
			  IF regExt.GrdeFinal >	3.9	THEN
				 vnTotAcred	 :=	vnTotAcred + regExt.Credito;
				 vnExisteExt :=	1;
				 vnPromArit	 :=	vnPromArit + regExt.GrdeFinal;
			  END IF;
			  htp.p('<td width="6%"	valign="top" align="center">'||regExt.GrdeFinal||'&nbsp;&nbsp;&nbsp;'||regExt.Periodo||'</td>');
		  END LOOP;

		  FOR vnI IN vnReprobada2..1 LOOP
			  htp.p('<td width="6%"	></td>');
		  END LOOP;

		  htp.p('<td width="6%"	 valign="top" align="center">'||tabHist(vnRws).GmodCode	||'</td>
				 </tr>');
		  vnExists	   := 1;
		  vnRow		   := vnRow	+ 1;
		  vsBloqueDesc := tabHist(vnRws).AreaDesc;
		  vnLastPidm   := vnPidm;
		  vnReprobadas := 0;
		  vnReprobada2 := 0;
--			htp.p('UNO');
		  IF TO_CHAR(tabHist(vnRws).GrdeFinal) NOT IN ('AC','AD','OU','NP',	'RE', 'P', 'NV') AND NVL(tabHist(vnRws).Creditos,0)	> 0	THEN
			 vnValida :=0 ;
			 SELECT	COUNT(*) INTO vnValida FROM	DUAL WHERE REGEXP_LIKE(tabHist(vnRws).Creditos,	'^[0-9]+$');
			 IF	vnValida > 0 THEN
				vnTotalCre := vnTotalCre + NVL(tabHist(vnRws).Creditos,0);
			 END IF;
			 vnMaterias	:= vnMaterias +	1;
--			 vnpromarit	:= vnpromarit +	tabhist(vnrws).grdefinal;
			 IF	vnExisteExt	= 0	THEN
				vnValida :=0 ;
				SELECT COUNT(*)	INTO vnValida FROM DUAL	WHERE REGEXP_LIKE(tabHist(vnRws).GrdeFinal,	'^[0-9]+$');
				IF vnValida	> 0	THEN
					vnPromArit := vnPromArit + tabHist(vnRws).GrdeFinal;
				END	IF;
			 END IF;
--			   htp.p('DOS');
			vnValida :=0 ;
			SELECT COUNT(*)	INTO vnValida FROM DUAL	WHERE REGEXP_LIKE(tabHist(vnRws).GrdeFinal,	'^[0-9]+$');
			 IF	vnValida > 0 THEN
				IF TO_NUMBER(tabHist(vnRws).GrdeFinal) > 3.9  THEN
					vnTotAcred := vnTotAcred + tabHist(vnRws).Creditos;
				END	IF;
			 END IF;
--			   htp.p('TRES');
		  END IF;

		  vnValida :=0 ;
		  SELECT COUNT(*) INTO vnValida	FROM DUAL WHERE	REGEXP_LIKE(tabHist(vnRws).GrdeFinal, '^[0-9]+$');
		  IF vnValida =	0 THEN
			  IF tabHist(vnRws).GrdeFinal =	'AC'  THEN
				 vnTotAcred	:= vnTotAcred +	tabHist(vnRws).Creditos;
			  END IF;
		  END IF;
	  END LOOP;
--htp.p('CUATRO');
	  IF vnExists =	1 THEN
		 htp.p(f_Pie(vnLastPidm));
	  END IF;
--htp.p('CINCO');
	  IF vnExists =	0 THEN
		 htp.p('<tr><th	colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
	  END IF;
	  htp.p('</table><script language=''JavaScript''><!--');
	  FOR vnI IN 1..vnTotPagina	LOOP
		  htp.p('document.frmTotal'||vnI||'.txtPag.value = "'||vnTotPagina||'";');
	  END LOOP;
	  htp.p('//--></script>');
	  --kwnotrefresh.script;
	  htp.p('<br/></body></html>');
	  ROLLBACK;
  EXCEPTION
	  WHEN OTHERS THEN
		   htp.p(vsProgCode||' '||sqlerrm);
  END PWRHIAC;
/


DROP PUBLIC SYNONYM PWRHIAC;

CREATE PUBLIC SYNONYM PWRHIAC FOR BANINST1.PWRHIAC;


GRANT EXECUTE ON BANINST1.PWRHIAC TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRHIAC TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRHIAC2;

CREATE OR REPLACE PROCEDURE BANINST1.PWRHIAC2(
	psProg		IN		SGBSTDN.SGBSTDN_PROGRAM_1%TYPE DEFAULT NULL
) IS
	/*******************************************************************************
	tarea: procedimiento que genera el reporte de historia acadmica.
   propsito: obtener informacin de la historia acadmica de un alumno
		determinado.
	  mdulo: historia acadmica - uft.
	 reporte: historia acadmica v.2.
	autor: Eduardo Moreno Macal
	fecha: 08/005/2012.
	*******************************************************************************/

	TYPE reg_history IS RECORD
	(
		areacode	VARCHAR2 (60),
		orden		VARCHAR2 (15),
		grup		VARCHAR2 (15),
		subj		VARCHAR2 (15),
		crse		VARCHAR2 (15),
		areadesc	VARCHAR2 (200),
		title		VARCHAR2 (300),
		clave		VARCHAR2 (10),
		creditos	VARCHAR2 (5),
		grdefinal	VARCHAR2 (5),
		periodo 	VARCHAR2 (8),
		campcode	VARCHAR2 (5),
		gmodcode	VARCHAR2 (5),
		crnn		VARCHAR2 (5),
		grupo		VARCHAR2 (5),
		prio		VARCHAR2 (5),
		requ		VARCHAR2 (3),
		term		VARCHAR2 (6)
	);

	TYPE tablehistory IS TABLE OF reg_history
							 INDEX BY BINARY_INTEGER;

	tabhist 	   tablehistory;

	vnrow		   INTEGER := 0;
	vnrows		   INTEGER := 0;
	vnexists	   INTEGER := 0;
	vncolumnas	   INTEGER := 12;
	vnnumpagina    INTEGER := 1;
	vntotpagina    INTEGER := 0;
	vnreprobadas   INTEGER := 0;
	vnreprobada2   INTEGER := 0;
	vnmaterias	   NUMBER := 0;
	vnpromarit	   NUMBER := 0;
	vnlastpidm	   NUMBER := 0;
	vntotalcre	   NUMBER := 0;
	vntotacred	   NUMBER := 0;
	vnporccred	   NUMBER := 0;
	vnpidm		   NUMBER := 0;
	vnvalida	   NUMBER := 0;
	tabcolumna	   pk_sisrepimp.tipotabla := pk_sisrepimp.tipotabla (1);
	vsseccion	   VARCHAR2 (3) := '3';
	vssinpiepag    VARCHAR2 (1) := NULL;
	vsbackground   VARCHAR2 (25) := NULL;
	vsbloquedesc   VARCHAR2 (1000) := NULL;
	vsprogcode	   VARCHAR2 (25) := NULL;
	vsrut		   VARCHAR2 (25) := NULL;
	vsbreakpoint   VARCHAR2 (10) := NULL;
	vsinicopag	   VARCHAR2 (10) := NULL;
	vsgrdecode	   smrdocn.smrdocn_grde_code%TYPE := NULL;
	vsseppcode	   VARCHAR2 (10) := NULL;
	psrecldesc	   VARCHAR2 (50) := 'Reporte de HA basado en CAPP';
	vsdocsinvald   VARCHAR2 (30) := NULL;
	vncred		   swbprog.swbprog_num_creditos%TYPE := NULL;
	vbbloquee	   BOOLEAN := TRUE;
	global_pidm    spriden.spriden_pidm%TYPE;

	csotros 	   CONSTANT VARCHAR2 (5) := 'OTROS';
	cssindecs	   CONSTANT VARCHAR2 (15) := 'SIN DESCRIPCION';
	csbloqueelc    CONSTANT VARCHAR2 (15) := 'OTROS';
	csbloque	   CONSTANT VARCHAR2 (6) := 'BLOQUE';
	csn 		   CONSTANT VARCHAR2 (1) := 'N';
	csou		   CONSTANT VARCHAR2 (2) := 'OU';
	csac		   CONSTANT VARCHAR2 (2) := 'AC';
	csx 		   CONSTANT VARCHAR2 (1) := 'X';
	cscampus	   CONSTANT VARCHAR2 (6) := f_contexto ();
	csmajor 	   CONSTANT VARCHAR2 (5) := 'MAJOR';
	csast		   CONSTANT VARCHAR2 (1) := '*';
	csesp		   CONSTANT VARCHAR2 (1) := ' ';
	css 		   CONSTANT VARCHAR2 (1) := 'S';
	cst 		   CONSTANT VARCHAR2 (1) := 'T';
	csc 		   CONSTANT VARCHAR2 (1) := 'C';
	csa 		   CONSTANT VARCHAR2 (1) := 'A';
	csf 		   CONSTANT VARCHAR2 (1) := 'F';
	csy 		   CONSTANT VARCHAR2 (1) := 'Y';
	csv 		   CONSTANT VARCHAR2 (1) := 'V';
	csr 		   CONSTANT VARCHAR2 (1) := 'R';
	csrm		   CONSTANT VARCHAR2 (2) := 'RM';
	csp 		   CONSTANT VARCHAR2 (1) := 'P';
	cscn		   CONSTANT VARCHAR2 (2) := 'CN';
	csnv		   CONSTANT VARCHAR2 (2) := 'NV';
	cser		   CONSTANT VARCHAR2 (2) := 'ER';
	cn0 		   CONSTANT INTEGER := 0;
	cn1 		   CONSTANT INTEGER := 1;
	cn2 		   CONSTANT INTEGER := 2;
	cn3 		   CONSTANT INTEGER := 3;
	cn4 		   CONSTANT INTEGER := 4;
	cn5 		   CONSTANT INTEGER := 5;
	cn6 		   CONSTANT INTEGER := 6;
	cn7 		   CONSTANT INTEGER := 7;
	cn8 		   CONSTANT INTEGER := 8;
	vnexisteext    NUMBER := 0;

	-- cucumplimiento
	CURSOR cucumplimiento (pnpidm NUMBER) IS
		  SELECT   areas.area AS areacode, areas.prio AS orden,
				   areas.grup AS grup, areas.subj AS subj, areas.crse AS crse,
				   LTRIM (DECODE (
							  areas.area,
							  csotros, csotros,
							  csbloque, csbloqueelc,
							  NVL ( (  SELECT	c.smracmt_text
										 FROM	smracmt c
										WHERE	(c.smracmt_term_code_eff,
												 c.smracmt_text_seqno) =
													(SELECT   MAX(d.smracmt_term_code_eff),
															  MAX(d.smracmt_text_seqno)
													   FROM   smracmt d
													  WHERE   d.smracmt_area =
																  c.smracmt_area)
												AND c.smracmt_area = areas.area
									 GROUP BY	c.smracmt_text),
							  cssindecs || areas.area)
						  ))
					   AS areadesc, NVL ( (SELECT	LTRIM(c.scrsyln_long_course_title)
											 FROM	scrsyln c
											WHERE	c.scrsyln_term_code_eff =
														(SELECT   MAX(d.scrsyln_term_code_eff)
														   FROM   scrsyln d
														  WHERE   d.scrsyln_subj_code =
																	  areas.subj
																  AND d.scrsyln_crse_numb =
																		 areas.crse
																  AND d.scrsyln_term_code_eff <=
																		 areas.term)
													AND c.scrsyln_subj_code =
														   areas.subj
													AND c.scrsyln_crse_numb =
														   areas.crse),
									areas.titl)
										AS title, NVL ( (SELECT   m.swbcrse_code_sep
														   FROM   swbcrse m
														  WHERE   m.swbcrse_subj_code =
																	  areas.subj
																  AND m.swbcrse_crse_numb =
																		 areas.crse
																  AND m.swbcrse_term_code =
																		 (SELECT   MAX(n.swbcrse_term_code)
																			FROM   swbcrse n
																		   WHERE   n.swbcrse_subj_code =
																					   areas.subj
																				   AND n.swbcrse_crse_numb =
																						  areas.crse
																				   AND n.swbcrse_term_code <=
																						  areas.term)),
												  areas.subj || areas.crse)
													  AS clave,
				   areas.cred AS creditos, areas.grde AS grdefinal,
				   (SELECT	 stvterm_fa_proc_yr
					  FROM	 stvterm
					 WHERE	 stvterm_code = areas.term)
					   AS periodo, areas.camp AS campcode,
				   areas.gmod AS gmodcode, areas.crnn AS crnn,
				   SUBSTR (areas.grup, LENGTH(areas.grup), 1) AS grupo,
				   areas.requ AS requ, areas.term AS term
			FROM   (SELECT	 swrcapp_area AS area,
							 swrcapp_area_priority AS prio,
							 swrcapp_group AS grup, swrcapp_subj_code AS subj,
							 swrcapp_crse_numb AS crse,
							 swrcapp_grde_code AS grde,
							 swrcapp_term_code AS term,
							 swrcapp_credit_hours AS cred,
							 swrcapp_gmod_code AS gmod, swrcapp_crn AS crnn,
							 swrcapp_title AS titl, swrcapp_request_no AS requ,
							 swrcapp_camp_code AS camp
					  FROM	 swrcapp
					 WHERE	 swrcapp_crse_source <> csr
							 AND swrcapp_gmod_code <> csx) areas
		ORDER BY   orden, grupo, clave, areadesc;

	-- cumateriasreprobadas
	CURSOR cumateriasreprobadas (
		pssubj				VARCHAR2,
		pscrse				VARCHAR2,
		pnpidm				NUMBER
	) IS
		  SELECT   shrtckg_grde_code_final AS grdefinal,
				   (SELECT	 stvterm_fa_proc_yr
					  FROM	 stvterm
					 WHERE	 stvterm_code = m.shrtckn_term_code)
					   AS periodo,
				   (SELECT	 DECODE (
								 stvterm_trmt_code,
								 css, cn1,
								 cst, cn2,
								 csc, cn3,
								 csa, cn4,
								 csf, cn5,
								 csy, cn6,
								 csv, cn7,
								 cn8
							 )
					  FROM	 stvterm
					 WHERE	 stvterm_code = m.shrtckn_term_code)
					   AS orden, m.shrtckn_term_code AS term,
				   shrtckg_credit_hours AS credito
			FROM   shrtckg, shrtckn m, shrtckl, shrgrde a
		   WHERE	   m.shrtckn_pidm = shrtckg_pidm
				   AND shrtckg_term_code = m.shrtckn_term_code
				   AND shrtckg_tckn_seq_no = m.shrtckn_seq_no
				   AND shrtckg_seq_no =
						  (SELECT	MAX (shrtckg_seq_no)
							 FROM	shrtckg
							WHERE		shrtckg_pidm = shrtckn_pidm
									AND shrtckg_term_code = shrtckn_term_code
									AND shrtckg_tckn_seq_no = shrtckn_seq_no)
				   AND shrtckl_pidm = m.shrtckn_pidm
				   AND shrtckl_term_code = m.shrtckn_term_code
				   AND shrtckl_tckn_seq_no = m.shrtckn_seq_no
				   AND a.shrgrde_code = shrtckg_grde_code_final
				   AND a.shrgrde_levl_code = shrtckl_levl_code
				   AND a.shrgrde_term_code_effective =
						  (SELECT	MAX (b.shrgrde_term_code_effective)
							 FROM	shrgrde b
							WHERE	b.shrgrde_code = shrtckg_grde_code_final
									AND b.shrgrde_levl_code = shrtckl_levl_code
									AND b.shrgrde_term_code_effective <=
										   m.shrtckn_term_code)
				   AND EXISTS
						  (SELECT	NULL
							 FROM	swvhiac
							WHERE		swvhiac_pidm = m.shrtckn_pidm
									AND swvhiac_subj = m.shrtckn_subj_code
									AND swvhiac_crse = m.shrtckn_crse_numb
									AND swvhiac_term_code = m.shrtckn_term_code
									AND swvhiac_passed_ind = csn
									AND ( (swvhiac_quality_points >= cn5
										   AND swvhiac_quality_points < cn6)
										 OR shrtckg_grde_code_final = csou))
				   AND NOT EXISTS
						  (SELECT	NULL
							 FROM	swrcapp
							WHERE	swrcapp_term_code = m.shrtckn_term_code
									AND swrcapp_gmod_code = shrtckg_gmod_code
									AND swrcapp_grde_code =
										   shrtckg_grde_code_final
									AND swrcapp_crse_numb = pscrse
									AND swrcapp_subj_code = pssubj)
				   AND shrtckg_gmod_code <> csx
				   AND m.shrtckn_pidm = pnpidm
				   AND m.shrtckn_crse_numb = pscrse
				   AND m.shrtckn_subj_code = pssubj
		ORDER BY   term, orden;

	-- cumateriasaprobadas
	CURSOR cumateriasaprobadas (
		pssubj				VARCHAR2,
		pscrse				VARCHAR2,
		pnpidm				NUMBER
	) IS
		  SELECT   shrtckg_grde_code_final AS grdefinal,
				   (SELECT	 stvterm_fa_proc_yr
					  FROM	 stvterm
					 WHERE	 stvterm_code = m.shrtckn_term_code)
					   AS periodo,
				   (SELECT	 DECODE (
								 stvterm_trmt_code,
								 css, cn1,
								 cst, cn2,
								 csc, cn3,
								 csa, cn4,
								 csf, cn5,
								 csy, cn6,
								 csv, cn7,
								 cn8
							 )
					  FROM	 stvterm
					 WHERE	 stvterm_code = m.shrtckn_term_code)
					   AS orden, m.shrtckn_term_code AS term,
				   shrtckg_credit_hours AS credito
			FROM   shrtckg, shrtckn m, shrtckl, shrgrde a
		   WHERE	   m.shrtckn_pidm = shrtckg_pidm
				   AND shrtckg_term_code = m.shrtckn_term_code
				   AND shrtckg_tckn_seq_no = m.shrtckn_seq_no
				   AND shrtckg_seq_no =
						  (SELECT	MAX (shrtckg_seq_no)
							 FROM	shrtckg
							WHERE		shrtckg_pidm = shrtckn_pidm
									AND shrtckg_term_code = shrtckn_term_code
									AND shrtckg_tckn_seq_no = shrtckn_seq_no)
				   AND shrtckl_pidm = m.shrtckn_pidm
				   AND shrtckl_term_code = m.shrtckn_term_code
				   AND shrtckl_tckn_seq_no = m.shrtckn_seq_no
				   AND a.shrgrde_code = shrtckg_grde_code_final
				   AND a.shrgrde_levl_code = shrtckl_levl_code
				   AND a.shrgrde_term_code_effective =
						  (SELECT	MAX (b.shrgrde_term_code_effective)
							 FROM	shrgrde b
							WHERE	b.shrgrde_code = shrtckg_grde_code_final
									AND b.shrgrde_levl_code = shrtckl_levl_code
									AND b.shrgrde_term_code_effective <=
										   m.shrtckn_term_code)
				   AND EXISTS
						  (SELECT	NULL
							 FROM	swvhiac
							WHERE		swvhiac_pidm = m.shrtckn_pidm
									AND swvhiac_subj = m.shrtckn_subj_code
									AND swvhiac_crse = m.shrtckn_crse_numb
									AND swvhiac_term_code = m.shrtckn_term_code
									AND swvhiac_passed_ind = csy)
				   AND NOT EXISTS
						  (SELECT	NULL
							 FROM	swrcapp
							WHERE	swrcapp_term_code = m.shrtckn_term_code
									AND swrcapp_gmod_code = shrtckg_gmod_code
									AND swrcapp_grde_code =
										   shrtckg_grde_code_final
									AND swrcapp_crse_numb = pscrse
									AND swrcapp_subj_code = pssubj)
				   AND shrtckg_gmod_code <> csx
				   AND m.shrtckn_pidm = pnpidm
				   AND m.shrtckn_crse_numb = pscrse
				   AND m.shrtckn_subj_code = pssubj
		ORDER BY   term, orden;

	-- cuextraordinarios
	CURSOR cuextraordinarios (
		pssubj				VARCHAR2,
		pscrse				VARCHAR2,
		pnpidm				NUMBER
	) IS
		  SELECT   shrtckg_grde_code_final AS grdefinal,
				   (SELECT	 stvterm_fa_proc_yr
					  FROM	 stvterm
					 WHERE	 stvterm_code = shrtckn_term_code)
					   AS periodo, shrtckg_credit_hours AS credito
			FROM   shrtckg, shrtckn, shrtckl, shrgrde a
		   WHERE	   shrtckn_pidm = shrtckg_pidm
				   AND shrtckg_term_code = shrtckn_term_code
				   AND shrtckg_tckn_seq_no = shrtckn_seq_no
				   AND shrtckg_seq_no =
						  (SELECT	MAX (shrtckg_seq_no)
							 FROM	shrtckg
							WHERE		shrtckg_pidm = shrtckn_pidm
									AND shrtckg_term_code = shrtckn_term_code
									AND shrtckg_tckn_seq_no = shrtckn_seq_no)
				   AND shrtckl_pidm = shrtckn_pidm
				   AND shrtckl_term_code = shrtckn_term_code
				   AND shrtckl_tckn_seq_no = shrtckn_seq_no
				   AND a.shrgrde_code = shrtckg_grde_code_final
				   AND a.shrgrde_levl_code = shrtckl_levl_code
				   AND a.shrgrde_term_code_effective =
						  (SELECT	MAX (b.shrgrde_term_code_effective)
							 FROM	shrgrde b
							WHERE	b.shrgrde_code = shrtckg_grde_code_final
									AND b.shrgrde_levl_code = shrtckl_levl_code
									AND b.shrgrde_term_code_effective <=
										   shrtckn_term_code)
				   AND shrtckg_gmod_code = csx
				   AND shrtckg_grde_code_final <> csrm
				   AND shrtckg_grde_code_final <> csp
				   AND shrtckg_grde_code_final <> cscn
				   AND shrtckg_grde_code_final <> csnv
				   AND shrtckn_pidm = pnpidm
				   AND shrtckn_subj_code = pssubj
				   AND shrtckn_crse_numb = pscrse
		ORDER BY   periodo;

	-- f_encabezado
	FUNCTION f_encabezado (pnpidm NUMBER, pnrut VARCHAR2)
		RETURN VARCHAR2 IS
		vsprogdesc	 swbprog.swbprog_program_deslar%TYPE := NULL;
		vsleglname	 spbpers.spbpers_legal_name%TYPE := NULL;
		vsid		 spriden.spriden_id%TYPE := NULL;
		vsststcode	 sgbstdn.sgbstdn_stst_code%TYPE := NULL;
		vsststdesc	 stvstst.stvstst_desc%TYPE := NULL;
		vsprogacrd	 swbprog.swbprog_fec_acuerdo%TYPE := NULL;
		vsprognuma	 swbprog.swbprog_num_acuerdo%TYPE := NULL;
		vsprogdges	 swbprog.swbprog_cve_registro%TYPE := NULL;
		vsprogcred	 swbprog.swbprog_num_creditos%TYPE := NULL;
		vsleyenda	 swbprog.swbprog_leyenda%TYPE := NULL;
		vsmajrdesc	 VARCHAR2 (300) := NULL;
		vsrut		 VARCHAR2 (300) := NULL;

		CURSOR cuencabezado IS
			SELECT	 swbprog_program_deslar progdesc,
					 swbprog_cve_registro progdges,
					 swbprog_fec_acuerdo progacrd,
					 swbprog_num_acuerdo prognuma,
					 swbprog_num_creditos progcred, swbprog_leyenda progleye
			  FROM	 swbprog
			 WHERE	 swbprog_program = vsprogcode;
	BEGIN
		-- Iguala el RUT del alumno
		vsrut := pnrut;

		-- Busca el ID del alumno
		SELECT	 spriden_id
		  INTO	 vsid
		  FROM	 spriden
		 WHERE	 spriden_pidm = pnpidm AND spriden_change_ind IS NULL;

		--
		SELECT	 REPLACE (spbpers_legal_name, csast, csesp)
		  INTO	 vsleglname
		  FROM	 spbpers
		 WHERE	 spbpers_pidm = pnpidm;

		SELECT	 a.sgbstdn_stst_code,
				 pk_catalogo.stastst (a.sgbstdn_stst_code)
		  INTO	 vsststcode, vsststdesc
		  FROM	 sgbstdn a
		 WHERE	 a.sgbstdn_term_code_eff =
					 (SELECT   MAX (b.sgbstdn_term_code_eff)
						FROM   sgbstdn b
					   WHERE   b.sgbstdn_pidm = pnpidm)
				 AND a.sgbstdn_pidm = pnpidm;

		vsmajrdesc := fwrmajr (pnpidm, vsprogcode);

		FOR regenc IN cuencabezado LOOP
			vsprogdesc := regenc.progdesc;
			vsprogacrd := regenc.progacrd;
			vsprognuma := regenc.prognuma;
			vsprogdges := regenc.progdges;
			vncred := regenc.progcred;
			vsleyenda := regenc.progleye;
		END LOOP;

		IF vsleyenda = 'DEPRE' THEN
			--<th align="right">Acuerdo:</th>
			--<td colspan="3">'||'CON RECONOCIMIENTO DE VALIDEZ OFICIAL DECRETO PRESIDENCIAL PUBLICADO EN EL D.O.F. DEL VEINTIS&Eacute;IS DE NOVIEMBRE DE 1982'||'</td>

			RETURN '<tr class="trSeparador"><td colspan="' || vncolumnas
				   || '" bordercolor="#ffffff"></td></tr>
					 <tr><td colspan="'
				   || vncolumnas
				   || '" bordercolor="#ffffff" bgcolor="#dddddd">
					 <table border="0" bordercolor="#000000" width="100%" bgcolor="#dddddd">
					 <tr>
							<th>Expediente:</th>	<td >'
				   || vsid
				   || '</td>
							<th>RUT: </th>	<td >'
				   || vsrut
				   || '</td>
							<th>Alumno:  </th>	<td>'
				   || vsleglname
				   || '</td>
					 <tr>
							<th>Programa:</th> <td>'
				   || vsprogcode
				   || '</td>
							<th>Carrera:</th>  <td>'
				   || vsmajrdesc
				   || '</td>
							<th>Status:</th>		<td>'
				   || vsststcode
				   || ' '
				   || vsststdesc
				   || '</td>
					 </tr>

					 </table></td></tr>
					 <tr class="trSeparador"><td colspan="'
				   || vncolumnas
				   || '" style="border-left:none;border-right:none;"></td></tr>';
		ELSE
			RETURN	  '<tr class="trSeparador"><td colspan="'
				   || vncolumnas
				   || '" bordercolor="#ffffff"></td></tr>'
				   || '<tr><td colspan="'
				   || vncolumnas
				   || '" bordercolor="#ffffff" bgcolor="#dddddd">'
				   || '<table border="0" bordercolor="#000000" width="100%" bgcolor="#dddddd">'
				   || '
					  <tr>
							<th>Expediente:</th>	<td >'
				   || vsid
				   || '</td>
							<th>RUT: </th>	<td >'
				   || vsrut
				   || '</td>
							<th>Alumno:  </th>	<td>'
				   || vsleglname
				   || '</td>
					 <tr>
							<th>Programa:</th> <td>'
				   || vsprogcode
				   || '</td>
							<th>Carrera:</th>  <td>'
				   || vsmajrdesc
				   || '</td>
							<th>Status:</th>		<td>'
				   || vsststcode
				   || ' '
				   || vsststdesc
				   || '</td>
					 </tr>
					 </table></td></tr>
					 <tr class="trSeparador"><td colspan="'
				   || vncolumnas
				   || '" style="border-left:none;border-right:none;"></td></tr>';
		END IF;
	END f_encabezado;

	-- f_pie
	FUNCTION f_pie (pnpidm NUMBER)
		RETURN VARCHAR2 IS
		vnpga	NUMBER := NULL;

		CURSOR cunocapp IS
			SELECT	 (SELECT   stvncrq_desc
						FROM   stvncrq
					   WHERE   stvncrq_code = a.shrncrs_ncrq_code)
						 ncrqcode,
					 (SELECT   stvncst_desc
						FROM   stvncst
					   WHERE   stvncst_code = a.shrncrs_ncst_code)
						 ncstcode, a.shrncrs_ncst_date ncstdate
			  FROM	 shrncrs a
			 WHERE	 a.shrncrs_pidm = pnpidm;
	BEGIN
		vntotalcre := vncred;

		IF vnpromarit > 0 AND vnpromarit > 0 THEN
			vnpromarit := TRUNC (vnpromarit / vnmaterias, 2);
		END IF;

		IF vntotacred > 0 AND vntotalcre > 0 THEN
			vnporccred := TRUNC ( (vntotacred / vntotalcre) * 100, 2);
		END IF;

		BEGIN
			SELECT	 TRUNC (SUM (a.shrtgpa_gpa * shrtgpa_gpa_hours)
							/ SUM (shrtgpa_gpa_hours), 2)
			  INTO	 vnpga
			  FROM	 shrtgpa a
			 WHERE	 a.shrtgpa_pidm = pnpidm
					 AND shrtgpa_levl_code = SUBSTR (vsprogcode, 1, 2);
		EXCEPTION
			WHEN OTHERS THEN
				NULL;
		END;

		HTP.p('<tr><td colspan="' || vncolumnas
			  || '" style="border-left:solid #ffffff 1.0pt;border-right:solid #ffffff 1.0pt;border-bottom:solid #ffffff 1.0pt;">
	  <table border="1" cellpadding="1" cellspacing="1" style="border:solid #ffffff 1.0pt;" width="100%">
			 <tr><th style="border:solid #ffffff 1.0pt;" width="10%" align="right" valign="top" style="font-size:7.0pt;" >Promedio Aritm&eacute;tico</th>
				 <td style="border:solid #ffffff 1.0pt;" width="10%" valign="top">'
			  || vnpromarit
			  || '</td>
				 <th style="border:solid #ffffff 1.0pt;" width="10%" align="right" valign="top" style="font-size:7.0pt;">Total de cr&eacute;ditos  </td>
				 <td style="border:solid #ffffff 1.0pt;" width="10%" valign="top">'
			  || vntotalcre
			  || '</td>
				 <td style="border:solid #ffffff 1.0pt;" width="10%"></td>
				 <td style="border:solid #ffffff 1.0pt;" width="10%"></td>
				 <td style="border:solid #ffffff 1.0pt;" width="40%" rowspan="2" valign="top">
				 <table border="1" cellpadding="0" cellspacing="0" style="border:solid #000000 1.0pt;" width="100%"><tr><td>
				 <table border="0"  width="100%">
				 <tr><td colspan="3" align="center" class="tdfont7"><b><u>REQUISITOS CURRICULARES</u></b></td></tr>
				 <tr><td width="33%" align="center" class="tdfont7" valign="top"><b><u>Requisito</u></b></td>
					 <td width="34%" align="center" class="tdfont7" valign="top"><b><u>Estado   </u></b></td>
					 <td width="33%" align="center" class="tdfont7" valign="top"><b><u>Acreditaci&oacute;n</b></u></td></tr>');

		FOR regnoc IN cunocapp LOOP
			HTP.p (   '<tr>
			<td align="center" valign="top" >'
				   || regnoc.ncrqcode
				   || '</td>
			<td align="center" valign="top" >'
				   || regnoc.ncstcode
				   || '</td>
			<td align="center" valign="top" >'
				   || regnoc.ncstdate
				   || '</td>
			</tr>');
		END LOOP;

		HTP.p('</table>
		</td></tr>
		</table>
		</td></tr>
			 <tr><th style="border:solid #ffffff 1.0pt;" align="right" valign="top" style="font-size:7.0pt;">Promedio Ponderado</th>
				 <td style="border:solid #ffffff 1.0pt;" valign="top">'
			  || vnpga
			  || '</td>
				 <th style="border:solid #ffffff 1.0pt;" align="right" valign="top" style="font-size:7.0pt;">Total acreditados </th>
				 <td style="border:solid #ffffff 1.0pt;" valign="top">'
			  || vntotacred
			  || '</td>
				 <th style="border:solid #ffffff 1.0pt;" align="right" valign="top" style="font-size:7.0pt;">% de avance</th>
				 <td style="border:solid #ffffff 1.0pt;" valign="top">'
			  || vnporccred
			  || '%</td></tr>
		<tr><td style="border:solid #ffffff 1.0pt;" colspan="3"></td>
			 <td style="border:solid #ffffff 1.0pt;" colspan="3"></td>
			 <td style="border:solid #ffffff 1.0pt;"></td>
			 </tr>
		<tr><td style="border:solid #ffffff 1.0pt;" colspan="3"></td>
			 <td style="border-left:solid #ffffff 1.0pt;border-right:solid #ffffff 1.0pt;border-top:solid #ffffff 1.0pt;border-bottom:solid #000000 1.0pt;" colspan="3"></td>
			 <td style="border:solid #ffffff 1.0pt;"></td>
			 </tr>
		<tr><td style="border:solid #ffffff 1.0pt;" colspan="3"></td>
			 <th style="border-left:solid #ffffff 1.0pt;border-right:solid #ffffff 1.0pt;border-top:solid #000000 1.0pt;border-bottom:solid #ffffff 1.0pt;" colspan="3">Servicios Escolares</th>
			 <td style="border:solid #ffffff 1.0pt;"></td>
			 </tr>
		');

		HTP.p (   '<tr><td colspan="3"></td>
			<th colspan="3" '
			|| pk_objhtml.vgsborderffffff
			|| '>'
			|| vsdocsinvald
			|| '</th>
			<td></td>
			</tr>
			');

		HTP.p('
		<tr><td style="border:solid #ffffff 1.0pt;" colspan="'
			  || vncolumnas
			  || '">
			   Escala de Calificaciones Numrica de 3.5	a 7 mnima de aprobacin 4 (cuatro)
			   </td></tr>
		<tr><td style="border:solid #ffffff 1.0pt;" colspan="'
			  || vncolumnas
			  || '">
			   Mod. Cal.: N: Calificacin numrica A:Calificacin alfabtica C:Convalidacin  E y R : Equivalencia y Revalidacin X:Eximido
		</td></tr>
		');

		HTP.p ('
		</table>
		</td></tr>
		');

		RETURN NULL;
	END f_pie;

	--f_bloque
	FUNCTION f_bloque (psarea VARCHAR2)
		RETURN VARCHAR2 IS
	BEGIN
		RETURN	  '<tr class="trSeparador"><td colspan="'
			   || vncolumnas
			   || '" style="border-bottom:none;"></td></tr>'
			   || '<tr><th colspan="'
			   || vncolumnas
			   || '" style="border-top:none;" align="left">'
			   || '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
			   || psarea
			   || '</th></tr>';
	EXCEPTION
		WHEN OTHERS THEN
			NULL;
	END f_bloque;

	--f_detalledeencabezado
	FUNCTION f_detalledeencabezado
		RETURN VARCHAR2 IS
	BEGIN
		RETURN '<table border="0" cellpadding="0" cellspacing="0" width="100%">'
			   || '<tr class="trSeparador">'
			   || '<td width="90%" align="right" >Fecha de expedici&oacute;n</td>'
			   || '<td width="10%">&nbsp;'
			   || TO_CHAR (SYSDATE, 'DD MON YYYY')
			   || '</td></tr>'
			   || '<tr class="trSeparador">'
			   || '<td align="right" >Pagina '
			   || vnnumpagina
			   || ' de </td> '
			   || '<form name="frmTotal'
			   || vnnumpagina
			   || '" onSubmit="return false">'
			   || '<td >&nbsp;'
			   || '<input type="text" name="txtPag" tabindex="-1" style="width:100%;height:100%;border:inset 0;font-size:7.5pt;" readonly/>'
			   || '</td>'
			   || '</form></tr>'
			   || '</table>';
	END f_detalledeencabezado;
---------------------------------------------------
-- bloque principal para la generacin del reporte
---------------------------------------------------
BEGIN
	-- valida que el usuario tenga acceso a la base de datos:
	--	  IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;
	IF NOT twbkwbis.f_validuser (global_pidm) THEN
		RETURN;
	END IF;

	-- obtiene los valores de las cookies para asignar los valores del filtro del query:
--	vnpidm := f_get_pidm('00011602');
	vnpidm := global_pidm;
--	vsprogcode := f_get_programa(vnpidm, '999999');
    vsprogcode := psProg;
	vsrut := f_get_rut (vnpidm);
	-- realiza la consulta del capp:
	pwahiac (vnpidm, vsprogcode, 'lic');

	-- determina el largo de la tabla:
	FOR vni IN 1 .. vncolumnas LOOP
		tabcolumna.EXTEND (vni);
		tabcolumna (vni) := NULL;
	END LOOP;

	-- define los encabezados de columnas:
	tabcolumna (1) := 'Nombre de la materia';
	tabcolumna (2) := 'Clave';
	--tabColumna(3) := 'Periodo';
	tabcolumna (3) := 'Cr&eacute;ditos';
	tabcolumna (4) := '1er. Ord';
	tabcolumna (5) := '2do. Ord';
	tabcolumna (6) := '3er. Ord';
	tabcolumna (7) := '4to. Ord';
	tabcolumna (8) := '1er. Ext';
	tabcolumna (9) := '2do. Ext';
	--tabColumna(10) := 'Campus';
	tabcolumna (10) := 'Modo de calificaci&oacute;n';

	-- manipula la informacin obtenida por el cursor:
	FOR regcum IN cucumplimiento (vnpidm) LOOP
		IF fwrinnt (regcum.crnn, regcum.term, vnpidm)
		   OR regcum.grdefinal IN (csp, csrm, cscn, csnv, cser) THEN
			-- invalidar nota: no se muestran las materias con calificacin "cn" o "nv".
			NULL;
		ELSE
			vnrows := vnrows + 1;

			tabhist (vnrows).areacode := regcum.areacode;
			tabhist (vnrows).orden := regcum.orden;
			tabhist (vnrows).grup := regcum.grup;
			tabhist (vnrows).subj := regcum.subj;
			tabhist (vnrows).crse := regcum.crse;
			tabhist (vnrows).areadesc := regcum.areadesc;
			tabhist (vnrows).title := regcum.title;
			tabhist (vnrows).clave := regcum.clave;
			tabhist (vnrows).creditos := regcum.creditos;
			tabhist (vnrows).grdefinal := regcum.grdefinal;
			tabhist (vnrows).periodo := regcum.periodo;
			tabhist (vnrows).campcode := regcum.campcode;
			tabhist (vnrows).gmodcode := regcum.gmodcode;
			tabhist (vnrows).crnn := regcum.crnn;
			tabhist (vnrows).grupo := regcum.grupo;
			tabhist (vnrows).prio := regcum.orden;
			tabhist (vnrows).term := regcum.term;
			tabhist (vnrows).requ := regcum.requ;
		END IF;
	END LOOP;

	HTP.p('<style type="text/css"><!--
			body {background-image: url(/imagenes/sinValidez.gif);}
			-->
			</style>
		');
	vsdocsinvald := 'DOCUMENTO SIN VALOR OFICIAL';

	FOR vnrws IN 1 .. vnrows LOOP
		vsbreakpoint := 'BK001';

		IF vnrow = 0 OR vnrow > 16 THEN
			pk_sisrepimp.p_encabezadodereporte (UPPER (psrecldesc),
			vncolumnas, tabcolumna, vsinicopag, '1',
			psusuario => pk_login.vgsusr, psseccion => vsseccion,
			psuniversidad => cscampus,
			psdetalle => f_encabezado (vnpidm, vsrut),
			psdetalle2 => f_detalledeencabezado,
			pstitulo => 'UNIVERSIDAD ANHUAC', psaligncell => 'center',
			pssinpiepag => vssinpiepag);
			vsinicopag := 'SALTO';
			vssinpiepag := 'A';

			vntotpagina := vntotpagina + 1;
			vnnumpagina := vnnumpagina + 1;
			vnrow := 0;
		END IF;

		IF  (vsbloquedesc IS NULL)
		   OR vsbloquedesc <> tabhist (vnrws).areadesc
		   OR (vnrow = 0) THEN
			HTP.p (f_bloque (tabhist (vnrws).areadesc));
		END IF;

		SELECT	 DECODE (MOD (vnrow, 2), 0, 'F0FFFF', 'CDFFFF')
		  INTO	 vsbackground
		  FROM	 DUAL;

		IF 'BLOQUE FUNDAMENTAL' <> tabhist (vnrws).areadesc THEN
			tabhist (vnrws).grupo := NULL;
		END IF;

		HTP.p ('<tr bgcolor="#' || vsbackground
			   || '">
					 <td width="30%" valign="top" align="left" class="tdfont6">'
			   || tabhist (vnrws).title
			   || '</td>
					 <td width="6%"  valign="top" align="center">'
			   || tabhist (vnrws).clave
			   || '</td>
					 <td width="6%"  valign="top" align="center">'
			   || tabhist (vnrws).creditos
			   || '</td>
				');

		-- materias reporbadas:
		FOR regmat IN cumateriasreprobadas (tabhist (vnrws).subj,
					  tabhist (vnrws).crse, vnpidm) LOOP
			IF tabhist (vnrws).periodo <> regmat.periodo
			   OR (tabhist (vnrws).periodo = regmat.periodo
				   AND regmat.grdefinal <> tabhist (vnrws).grdefinal) THEN
				vnreprobadas := vnreprobadas + 1;

				IF tabhist (vnrws).term < regmat.term THEN
					vsgrdecode := tabhist (vnrws).grdefinal;
					vsseppcode := tabhist (vnrws).periodo;

					tabhist (vnrws).grdefinal := regmat.grdefinal;
					tabhist (vnrws).periodo := regmat.periodo;

					IF regmat.grdefinal <> csou THEN
						IF regmat.grdefinal > 3.9 THEN
							vntotacred := vntotacred + regmat.credito;
						END IF;
					END IF;

					regmat.grdefinal := vsgrdecode;
					regmat.periodo := vsseppcode;
				END IF;
			END IF;
		END LOOP;

		HTP.p (   '<td width="6%" valign="top" align="center">'
			   || tabhist (vnrws).grdefinal
			   || '&nbsp;&nbsp;&nbsp;'
			   || tabhist (vnrws).periodo
			   || '</td>');

		-- materias cumateriasaprobadas:
		FOR regmat IN cumateriasaprobadas (tabhist (vnrws).subj,
					  tabhist (vnrws).crse, vnpidm) LOOP
			vnreprobadas := vnreprobadas + 1;
			HTP.p (   '<td width="6%" valign="top" align="center">'
				   || regmat.grdefinal
				   || '&nbsp;&nbsp;&nbsp;'
				   || regmat.periodo
				   || '</td>');
		END LOOP;

		FOR vni IN vnreprobadas .. 2 LOOP
			HTP.p ('<td width="6%" ></td>');
		END LOOP;

		vnexisteext := 0;

		-- extraordinarios
		FOR regext IN cuextraordinarios (tabhist (vnrws).subj,
					  tabhist (vnrws).crse, vnpidm) LOOP
			vnreprobada2 := vnreprobada2 + 1;

			IF regext.grdefinal > 3.9 THEN
				vntotacred := vntotacred + regext.credito;
				vnexisteext := 1;
				vnpromarit := vnpromarit + regext.grdefinal;
			END IF;

			HTP.p (   '<td width="6%" valign="top" align="center">'
				   || regext.grdefinal
				   || '&nbsp;&nbsp;&nbsp;'
				   || regext.periodo
				   || '</td>');
		END LOOP;

		FOR vni IN vnreprobada2 .. 1 LOOP
			HTP.p ('<td width="6%" ></td>');
		END LOOP;

		HTP.p (   '<td width="6%"  valign="top" align="center">'
			   || tabhist (vnrws).gmodcode
			   || '</td>
				 </tr>');
		vnexists := 1;
		vnrow := vnrow + 1;
		vsbloquedesc := tabhist (vnrws).areadesc;
		vnlastpidm := vnpidm;
		vnreprobadas := 0;
		vnreprobada2 := 0;

		IF TO_CHAR (tabhist (vnrws).grdefinal) NOT IN
				   ('AC', 'AD', 'OU', 'NP', 'RE', 'P', 'NV')
		   AND NVL (tabhist (vnrws).creditos, 0) > 0 THEN
			vnvalida := 0;

			SELECT	 COUNT ( * )
			  INTO	 vnvalida
			  FROM	 DUAL
			 WHERE	 REGEXP_LIKE (tabhist (vnrws).creditos, '^[0-9]+$');

			IF vnvalida > 0 THEN
				vntotalcre := vntotalcre + NVL (tabhist (vnrws).creditos, 0);
			END IF;

			vnmaterias := vnmaterias + 1;

			IF vnexisteext = 0 THEN
				vnvalida := 0;

				SELECT	 COUNT ( * )
				  INTO	 vnvalida
				  FROM	 DUAL
				 WHERE	 REGEXP_LIKE (tabhist (vnrws).grdefinal, '^[0-9]+$');

				IF vnvalida > 0 THEN
					vnpromarit := vnpromarit + tabhist (vnrws).grdefinal;
				END IF;
			END IF;

			vnvalida := 0;

			SELECT	 COUNT ( * )
			  INTO	 vnvalida
			  FROM	 DUAL
			 WHERE	 REGEXP_LIKE (tabhist (vnrws).grdefinal, '^[0-9]+$');

			IF vnvalida > 0 THEN
				IF TO_NUMBER (tabhist (vnrws).grdefinal) > 3.9 THEN
					vntotacred := vntotacred + tabhist (vnrws).creditos;
				END IF;
			END IF;
		END IF;

		vnvalida := 0;

		SELECT	 COUNT ( * )
		  INTO	 vnvalida
		  FROM	 DUAL
		 WHERE	 REGEXP_LIKE (tabhist (vnrws).grdefinal, '^[0-9]+$');

		IF vnvalida = 0 THEN
			IF tabhist (vnrws).grdefinal = 'AC' THEN
				vntotacred := vntotacred + tabhist (vnrws).creditos;
			END IF;
		END IF;
	END LOOP;

	IF vnexists = 1 THEN
		HTP.p (f_pie (vnlastpidm));
	END IF;

	IF vnexists = 0 THEN
		HTP.p (   '<tr><th colspan="'
			   || vncolumnas
			   || '"><font color="#ff0000">'
			   || pk_sisrepimp.vgsresultado
			   || '</font></th></tr>');
	END IF;

	HTP.p ('</table><script language=''JavaScript''><!--');

	FOR vni IN 1 .. vntotpagina LOOP
		HTP.p (   'document.frmTotal'
			   || vni
			   || '.txtPag.value = "'
			   || vntotpagina
			   || '";');
	END LOOP;

	HTP.p ('//--></script>');

	HTP.p ('<br/></body></html>');
--	ROLLBACK;
EXCEPTION
	WHEN OTHERS THEN
		HTP.p (vsprogcode || ' ' || SQLERRM);
END PWRHIAC2;
/


DROP PUBLIC SYNONYM PWRHIAC2;

CREATE PUBLIC SYNONYM PWRHIAC2 FOR BANINST1.PWRHIAC2;


GRANT EXECUTE ON BANINST1.PWRHIAC2 TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRHIAC2 TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRHIAC2 TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRHIAC2 TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRHIAC2 TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRHIAC3;

CREATE OR REPLACE PROCEDURE BANINST1.PWRHIAC3
IS
	-- DECLARACION DE VARIABLES LOCALES
	curr_release		CONSTANT VARCHAR2 (10)             := '8.1.1';
	global_pidm			spriden.spriden_pidm%TYPE;
	-- DECLARACION DE CURSORES LOCALES
	-- CURSOR QUE CARGA LOS PROGRMACIAS DEL ESTUDIANTE
	CURSOR cProg IS
		SELECT DISTINCT PK_CATALOGO.PROGRAMA(SGBSTDN_PROGRAM_1) AS DESCR, SGBSTDN_PROGRAM_1
		FROM SGBSTDN
		WHERE SGBSTDN_PIDM = global_pidm;
BEGIN
	IF NOT twbkwbis.f_validuser (global_pidm) THEN
		RETURN;
	END IF;
	-- INICIALIZA LA PAGUINA
	bwckfrmt.p_open_doc ('PWRHIAC3');
	twbkwbis.p_dispinfo ('PWRHIAC3');

	 HTP.formopen ('PWRHIAC2', 'post');
	 twbkfrmt.p_tableopen (
		'DATAENTRY',
		cattributes   => 'SUMMARY="' ||
							g$_nls.get ('BWSKOTR1-0001',
							   'SQL',
							   'This entry table is used to request
							   transcript type and level'
							) ||
							'."'
	 );
	twbkfrmt.p_tablerowopen;
	twbkfrmt.p_tabledataopen;
	-- GENERA EL COMBO PARA SELECCIONAR EL PROGRAMA
	htp.formSelectOpen('psProg', 'Programa:   ');
	FOR x IN cProg LOOP
		twbkwbis.p_formselectoption(x.DESCR, x.SGBSTDN_PROGRAM_1);
	END LOOP;
	htp.formSelectClose;
	twbkfrmt.p_tabledataclose;
	twbkfrmt.p_tablerowclose;

	 twbkfrmt.p_tablerowopen ();
	 twbkfrmt.p_tabledataseparator (' ', ccolspan => 11);
	 twbkfrmt.p_tablerowclose;
	 twbkfrmt.p_tableclose;
	 HTP.formsubmit (NULL, g$_nls.get ('BWSKOTR1-0007', 'SQL', 'Submit'));
	 HTP.formclose;

  twbkwbis.p_closedoc (curr_release);
  COMMIT;
END PWRHIAC3;
/


DROP PUBLIC SYNONYM PWRHIAC3;

CREATE PUBLIC SYNONYM PWRHIAC3 FOR BANINST1.PWRHIAC3;


GRANT EXECUTE ON BANINST1.PWRHIAC3 TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRHIAC3 TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRHIAC3 TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRHIAC3 TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRHIAC3 TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRHISA;

CREATE OR REPLACE PROCEDURE BANINST1.PWRHISA ( psReclDesc   VARCHAR2 ) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de historia acad?mica.
     prop?sito: obtener informaci?n de las materias que conforman la historia
                acad?mica del alumno.
        m?dulo: historia acad?mica - uft.
         autor: horacio mart?nez ram?rez - hmr.
         fecha: 28/10/2010.

  modificaci?n: hmr - 22/06/2011.
                simplemente se estandariz? el c?digo.
*******************************************************************************/

  vnExists      INTEGER       := 0;
  vnColumnas    INTEGER       := 9;
  vgsinicopag   varchar2(10)  := null;     -- bandera que al tener el valor "imprime" no colocar? el salto de p?gina para impresi?n
  tabColumna    Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vgsUSR        VARCHAR2(500);
  vsseccion     varchar2(3)   := null;

  vsId          SPRIDEN.SPRIDEN_ID%TYPE DEFAULT NULL;
  vsNivel       STVLEVL.STVLEVL_CODE%TYPE DEFAULT NULL;

  vnPidm        SPRIDEN.SPRIDEN_PIDM%TYPE DEFAULT NULL;
  vsName        VARCHAR2(50)  := NULL;
  vsRut         SPBPERS.SPBPERS_NAME_SUFFIX%TYPE DEFAULT NULL;

  vsPrograma    SGBSTDN.SGBSTDN_PROGRAM_1%TYPE DEFAULT NULL;
  vsProgDesc    SMRPRLE.SMRPRLE_PROGRAM_DESC%TYPE DEFAULT NULL;
  vsEstatus     SGBSTDN.SGBSTDN_STST_CODE%TYPE DEFAULT NULL;
  vsEstDesc     STVSTST.STVSTST_DESC%TYPE DEFAULT NULL;

  vnIdRenglon   NUMBER(8) := 1;

  CURSOR cuReporte ( psId     VARCHAR2 DEFAULT NULL,
                     psNivel  VARCHAR2 DEFAULT NULL ) IS

         SELECT S.SPRIDEN_ID                                                     ID,
                S.SPRIDEN_PIDM                                                   PIDM,
                N.SHRTCKN_SUBJ_CODE||N.SHRTCKN_CRSE_NUMB                         CLAVE,
                N.SHRTCKN_CRSE_TITLE                                             MATERIA,
                N.SHRTCKN_TERM_CODE                                              PERIODO,
                NVL(G.SHRTCKG_CREDIT_HOURS,0)                                    CREDITOS,
                G.SHRTCKG_GRDE_CODE_FINAL                                        CALIFICACION,
                DECODE(G.SHRTCKG_GMOD_CODE,'N','ORD','H','HOM','C','CON','A',
                                           'ALF','E','EQI','S','SUF','X','EXI')  TIPO,
                BANINST1.FWASEHA(N.SHRTCKN_SUBJ_CODE, N.SHRTCKN_CRSE_NUMB)       SERIACION,
                N.SHRTCKN_CAMP_CODE                                              CAMPUS,
                L.SHRTCKL_LEVL_CODE                                              NIVEL
           FROM SPRIDEN S,
                SHRTCKN N,
                SHRTCKG G,
                SHRTCKL L
          WHERE S.SPRIDEN_ID = psId
            AND ( L.SHRTCKL_LEVL_CODE = psNivel OR psNivel IS NULL )
            AND L.SHRTCKL_PRIMARY_LEVL_IND = 'Y'
            AND S.SPRIDEN_PIDM = N.SHRTCKN_PIDM
            AND G.SHRTCKG_PIDM = N.SHRTCKN_PIDM
            AND G.SHRTCKG_TERM_CODE = N.SHRTCKN_TERM_CODE
            AND G.SHRTCKG_TCKN_SEQ_NO = N.SHRTCKN_SEQ_NO
            AND G.SHRTCKG_SEQ_NO = ( SELECT MAX (G1.SHRTCKG_SEQ_NO)
                                       FROM SHRTCKG G1
                                      WHERE G1.SHRTCKG_PIDM = G.SHRTCKG_PIDM
                                        AND G1.SHRTCKG_TERM_CODE = G.SHRTCKG_TERM_CODE
                                        AND G1.SHRTCKG_TCKN_SEQ_NO = G.SHRTCKG_TCKN_SEQ_NO )
            AND L.SHRTCKL_PIDM = N.SHRTCKN_PIDM
            AND L.SHRTCKL_TERM_CODE = N.SHRTCKN_TERM_CODE
            AND L.SHRTCKL_TCKN_SEQ_NO = N.SHRTCKN_SEQ_NO
            AND SPRIDEN_CHANGE_IND IS NULL
          ORDER BY N.SHRTCKN_TERM_CODE, N.SHRTCKN_SUBJ_CODE, N.SHRTCKN_CRSE_NUMB;


---------------------------------------------------
-- bloque principal para la generaci?n del reporte
---------------------------------------------------
BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsId    := pk_ObjHtml.getValueCookie('psId');
   vsNivel := pk_ObjHtml.getValueCookie('psNivel');

   -- obtiene pidm, nombre y rut:
   BEGIN
      SELECT S.SPRIDEN_PIDM,
             UPPER(REPLACE(REPLACE(S.SPRIDEN_FIRST_NAME||' '||
                           S.SPRIDEN_LAST_NAME,'*',' '),'  ',' '))  NOMBRE,
             P.SPBPERS_NAME_SUFFIX  RUT
        INTO vnPidm,
             vsName,
             vsRut
        FROM SPRIDEN S,
             SPBPERS P
       WHERE S.SPRIDEN_ID = vsId
         AND S.SPRIDEN_CHANGE_IND IS NULL
         AND S.SPRIDEN_PIDM = P.SPBPERS_PIDM;
   EXCEPTION
      WHEN OTHERS THEN
           vnPidm := NULL;
           vsName := NULL;
           vsRut  := NULL;
   END;

   -- obtiene programa y estatus:
   BEGIN
      SELECT G.SGBSTDN_PROGRAM_1 PROGRAMA,
             P.SMRPRLE_PROGRAM_DESC PROG_DESC,
             G.SGBSTDN_STST_CODE,
             C.STVSTST_DESC  ESTATUS
        INTO vsPrograma,
             vsProgDesc,
             vsEstatus,
             vsEstDesc
        FROM SGBSTDN G,
             STVSTST C,
             SMRPRLE P
       WHERE SGBSTDN_PIDM = vnPidm
         AND G.SGBSTDN_STST_CODE = C.STVSTST_CODE
         AND G.SGBSTDN_PROGRAM_1 = P.SMRPRLE_PROGRAM
         AND G.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(H.SGBSTDN_TERM_CODE_EFF) FROM SGBSTDN H
                                                                WHERE G.SGBSTDN_PIDM = H.SGBSTDN_PIDM);
   EXCEPTION
      WHEN OTHERS THEN
           vsPrograma := NULL;
           vsProgDesc := NULL;
           vsEstatus := NULL;
   END;

   -- define el encabezado del reporte:
   htp.p('<table width="95%" border="0" cellpadding="5" cellspacing="0" align="center">
          <tr class="trTabSepara">
          <td class="thFont10"  width="20%" align="left"   valign="top"   rowspan="2"><img src="/imagenes/logo_uft.jpg'||'" width="110" height="40" border="0"></td>
          <td class="tdFont12" width="60%" align="center" valign="center"><b>UNIVERSIDAD FINIS TERRAE</br></br>Historia Acad&eacute;mica</b></td>
          <td class="thFont10"  width="20%"></td></tr>
          <tr class="trTabSepara">');

   htp.p('<tr class="trSeparador">
          <table width="85%" border="0" cellpadding="5" cellspacing="0" align="center">
          <tr class="trSeparador" >
          <br> <td class="tdFont8" align="center"><b>'||vsId||'</b></td>
               <td class="tdFont8" align="left"><b>'||vsName||'</b></td>
               <td class="tdFont8" align="right"><b>'||'Rut :      '||'</b></td>
               <td class="tdFont8" align="left"><b>'||vsRut||'</b></td> </tr>
          <tr class="trSeparador">
               <td class="tdFont8" align="center"><b>'||vsPrograma||'</b></td>
               <td class="tdFont8" align="left"><b>'||vsProgDesc||'</b></td>
               <td class="tdFont8" align="right"><b>'||'Estatus :      '||'</b></td>
               <td class="tdFont8" align="left"><b>'||vsEstDesc||'</b></td> </tr>
          </tr></table><br/>');

   -- determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;
--
   -- define los encabezados de columnas:
   tabColumna(1) := 'No.';
   tabColumna(2) := 'Clave';
   tabColumna(3) := 'Materia';
   tabColumna(4) := 'Periodo';
   tabColumna(5) := 'Cr&eacute;ditos';
   tabColumna(6) := 'Calificaci&oacute;n';
   tabColumna(7) := 'Tipo';
   tabColumna(8) := 'Seriaci&oacute;n';
   tabColumna(9) := 'Campus';

   -- manipula la informaci?n obtenida por el cursor:
   FOR regRep IN cuReporte (vsId, vsNivel) LOOP

       IF vnExists = 0 THEN
          pk_sisrepimp.p_encabezadodereporte(NULL, vncolumnas, tabcolumna, vgsinicopag, '1', psusuario=>vgsusr, pssinlogo=>'sin');
          vgsInicoPag := 'SALTO';
       END IF;

       -- despliega los valores para cada registro:
       htp.p('<tr> <td valign="top" align="center">' ||vnIdRenglon         ||'</td>
                   <td valign="top" align="center">' ||regRep.Clave        ||'</td>
                   <td valign="top" align="left">'   ||regRep.Materia      ||'</td>
                   <td valign="top" align="center">' ||regRep.Periodo      ||'</td>
                   <td valign="top" align="center">' ||regrep.Creditos     ||'</td>
                   <td valign="top" align="center">' ||regrep.Calificacion ||'</td>
                   <td valign="top" align="center">' ||regrep.Tipo         ||'</td>
                   <td valign="top" align="center">' ||regrep.Seriacion    ||'</td>
                   <td valign="top" align="center">' ||regrep.Campus       ||'</td>
              </tr>');

       vnExists    := 1;
       vnIdRenglon := vnIdRenglon + 1;

   END LOOP;

   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">El reporte no ha generado datos.</font></th></tr>');
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRHISA;
/


DROP PUBLIC SYNONYM PWRHISA;

CREATE PUBLIC SYNONYM PWRHISA FOR BANINST1.PWRHISA;


GRANT EXECUTE ON BANINST1.PWRHISA TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRHISA TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRHOLD;

CREATE OR REPLACE PROCEDURE BANINST1.PWRHOLD  IS

/*******************************************************************************
         tarea: generacin de certificados.
     propsito: generar para impresin los diversos certificados que se otorgan
                a los alumnos.
        mdulo: registro curricular - uft.
         fecha: 07/10/2010.
         autor: jccr.

  modificacin: 11-ene-2011, jccr
                se implementan nuevos alcances solicitados por el usuario,
                se ajusta que el folio se inicie por ao
                nuevos alcances a las leyendas de los certificados

  modificacin: 14-ene-2011, jccr
                ajustes validaciones base y holds

  modificacin: 18-ene-2011, jccr
                carrera y prrafos de leyenda

  modificacin: 20-ene-2011, jccr
                se ajusto que muestre solo las materias de acuerdo al nivel,
                se paso la opcion de impresin de certificados a registro curricular
                se ajustarn tablas de leyendas y control de folios
                se genera folio por modulo - periodo, para separar.

  modificacin: 25-ene-2011, jccr
                se ajusto validacin de holds si stvhldd_trans_hold_ind is null,
                no debe mostrar detalle

  modificacin: 26-ene-2011, jccr
                se implementa que el hold no tenga vigencia activa
                se implementa funcion f_tienematerias
                se ajusto rutina del calculo de pga acumulativo y calculo de los
                crditos tomando lo que se imprime y el desplegado de la pgina

  modificacin: 16-feb-2011, jccr
                se implemento funcion jscript
                fimprimereporte() para poder imprimirse

  modificacin: 01/11/2011 - hmr
                se corrigieron faltas de ortografa, se ajustaron los textos y
                se adecuaron los mrgenes de los distintos certificados.

  modificacin: 11/11/2011 - hmr
                se separ el tratamiento para el certificado de "estudios
                foliados" eliminando la firma y distribuyendo las lneas en
                blanco, y para el certificado de "sin impedimentos" reduciendo
                el mrgen superior.

  modificacin: 19/JUL/2013 - RRA
                se agrego la validadcion  de generar reporte holds descartando
                el tipo de hold 'MA- matricula'.

*******************************************************************************/

  ckNombres     owa_cookie.vc_arr;
  ckValores     owa_cookie.vc_arr;
  ckCount       INTEGER;
  vgsUSR        VARCHAR2(500);
  global_pidm   SPRIDEN.SPRIDEN_PIDM%TYPE;

  TYPE reg_Student IS RECORD ( rPdim          NUMBER(8),
                               rNombreLeg     VARCHAR2(70),
                               rSufix         VARCHAR2(40),
                               rClaseStdn     VARCHAR2(10),
                               rAoGenRep     VARCHAR2(4),
                               rCarrera       VARCHAR2(70),
                               rEscuela       VARCHAR2(70),
                               rApplDate      VARCHAR2(40),
                               rClaseStdnIni  VARCHAR2(10),
                               rClaseStdnFin  VARCHAR2(10),
                               rPerIniStdn    VARCHAR2(40),
                               rPerFinStdn    VARCHAR2(40) );

  TYPE tableStudent IS TABLE OF reg_Student  INDEX BY BINARY_INTEGER;
  tabStudent    tableStudent;

  vsExp                  VARCHAR2(10)   := NULL;
  vsProg                 VARCHAR2(20)   := NULL;
  vnCert                 INTEGER        := 0;
  vnRow                  INTEGER        := 0;
  vsDesDocto             VARCHAR2(50)   := NULL;
  vnTotTextos            INTEGER        := 0;
  vnEsdeDerecho          INTEGER        := 0;
  vsImpTexto             VARCHAR2(1000) := NULL;
  vsPasoTexto            VARCHAR2(1200) := NULL;
  vsBanExito             VARCHAR2(1)    := NULL;
  vsPeriodoT             VARCHAR2(10)   := NULL;
  vsError                VARCHAR2(500)  := NULL;
  vsNombre               VARCHAR2(100)  := NULL;
  vsRut                  VARCHAR2(20)   := NULL;
  vsAno                  VARCHAR2(4)    := NULL;
  vsClasstdn             VARCHAR2(300)  := NULL;
  vsHoldPdim             VARCHAR2(300)  := NULL;
  vsSchool               VARCHAR2(50)   := NULL;
  vsCarrera              VARCHAR2(50)   := NULL;
  vnConsecNo             NUMBER(15)     := 0;
  vsCode                 VARCHAR2(10)   := NULL;
  vsLevel                VARCHAR2(10)   := NULL;
  vsPeriodo              VARCHAR2(10)   := NULL;
  vsEscuela              VARCHAR2(2)    := 0;

  vsImprime              VARCHAR2(1500) := NULL;
  vsFecImprime           VARCHAR2(100)  := NULL;
  vnValida               INTEGER        := 0;
  vnLinHtp               INTEGER        := 0;
  vsCodHtp               VARCHAR2(5)    := NULL;
  vsFecEgreso            VARCHAR(30)    := NULL;
  vsFacultad             VARCHAR(30)    := NULL;
  vsStatCong             VARCHAR2(2)    := NULL;
  vsNomSpriden           VARCHAR2(100)  := NULL;
  vsEsAlumno             VARCHAR2(20)   := NULL;
  vsFueAlumno            VARCHAR2(20)   := NULL;
  vsElAlumno             VARCHAR2(20)   := NULL;
  vsSexo                 VARCHAR2(20)   := NULL;
  vsStdn1                VARCHAR2(8)    := NULL;
  vsStdn2                VARCHAR2(8)    := NULL;
  vsMesAnoStdn1          VARCHAR2(40)   := NULL;
  vsMesAnoStdn2          VARCHAR2(40)   := NULL;
  vs1erClaseStdn         VARCHAR2(10)   := NULL;
  vs1erAnoStdn           VARCHAR2(10)   := NULL;
  vsUltClaseStdn         VARCHAR2(10)   := NULL;
  vsUltAnoStdn           VARCHAR2(10)   := NULL;

  cnModRep     CONSTANT  INTEGER        := 28;
  cnLinPag     CONSTANT  INTEGER        := 32;
  csY          CONSTANT  VARCHAR2(1)    := 'Y';
  csN          CONSTANT  VARCHAR2(1)    := 'N';
  cn0          CONSTANT  INTEGER        := 0;
  csParam      CONSTANT  VARCHAR2(7)    := 'psTraCe';
  csTRAbre     CONSTANT  VARCHAR2(43)   := '<tr bgcolor="#ffffff">';
  csTRCierra   CONSTANT  VARCHAR2(5)    := '</tr>';
  csH1         CONSTANT  VARCHAR2(91)   := '<FONT class="fontH1">';
  csH2         CONSTANT  VARCHAR2(91)   := '<FONT class="fontH2">';
  csTX         CONSTANT  VARCHAR2(93)   := '<FONT class="fontTX">';
  csER         CONSTANT  VARCHAR2(93)   := '<FONT class="fontER">';
  csNM         CONSTANT  VARCHAR2(93)   := '<FONT class="fontNM">';
  csNMB        CONSTANT  VARCHAR2(93)   := '<FONT class="fontNMB">';
  csT8         CONSTANT  VARCHAR2(93)   := '<FONT class="fontT8">';
  csT10        CONSTANT  VARCHAR2(93)   := '<FONT class="fontT10">';
  csFF         CONSTANT  VARCHAR2(7)    := '</FONT>';

  csLBlanco    CONSTANT  VARCHAR2(49)   := '<tr><td class="fontNM">&nbsp;</td></tr>';
  csCenter     CONSTANT  VARCHAR2(6)    := 'CENTER';
  csLeft       CONSTANT  VARCHAR2(4)    := 'LEFT';
  csRight      CONSTANT  VARCHAR2(5)    := 'RIGHT';

  cnEspEP      CONSTANT  VARCHAR2(5)    := 'RIGHT';
  cnEspPF      CONSTANT  VARCHAR2(5)    := 'RIGHT';
  cnEspFF      CONSTANT  VARCHAR2(5)    := 'RIGHT';

  cnEspMsE     CONSTANT  INTEGER        := 3;
  cnEspMsE18   CONSTANT  INTEGER        := 2;

  csMA     CONSTANT    VARCHAR2(2)    := 'MA';


  -- obtiene las leyendas del certificado:
  CURSOR cu_Texto ( pnTexto  INTEGER ) IS

         SELECT SWRRLEY_DOCTO_CODE      rDocto,
                SWRRLEY_CONSEC          rConsec,
                SWRRLEY_DESC_LEY        rDesc,
                SWRRLEY_TYPE_JUST       rJustif,
                SWRRLEY_TYPE_FONT       rFont
           FROM SWRRLEY
          WHERE SWRRLEY_TYPE_PARA  = csParam
            AND SWRRLEY_RECMCODE   = cnModRep
            AND SWRRLEY_DOCTO_CODE = pnTexto
          ORDER BY SWRRLEY_CONSEC;


  function f_ImprimeReporte ( pnDocto  INTEGER ) RETURN VARCHAR2 IS

    vsRegreso  varchar2(1) := NULL;

  begin

     SELECT COUNT(SWRRLEY_DOCTO_CODE)
       INTO vnValida
       FROM SWRRLEY
      WHERE SWRRLEY_TYPE_PARA  = csParam
        AND SWRRLEY_RECMCODE   = cnModRep
        AND SWRRLEY_DOCTO_CODE = pnDocto;

     IF (vnValida > cn0) THEN vsRegreso := csY; ELSE vsRegreso := csN; END IF;

     RETURN(vsRegreso);

  end;


  function f_checaStudent ( pnPdim  NUMBER,
                            psProg  VARCHAR2 ) RETURN VARCHAR2 IS

    vscarre1   VARCHAR2(100) := NULL;
    vscarre2   VARCHAR2(100) := NULL;
    vsCode1    VARCHAR2(10)  := NULL;

  begin
      -- verifica que el programa este asociado a la carrera del estudiante o muestra leyenda de carrera no vlida.
      begin
         select distinct sgbstdn_majr_code_1
           into vsCode1
           from sgbstdn a
          where a.sgbstdn_pidm          = pnPdim
            and a.sgbstdn_program_1     = psProg;
        --  and a.sgbstdn_term_code_eff = vsperiodo
      exception
         when no_data_found then
              vsCode1  := null;
              vscarre1 := '<br/><br/><P ALIGN="center" CLASS="csER">EL ALUMNO NO PERTENECE A ESE PROGRAMA.</P>';
         when others then
              vsCode1  := null;
              vscarre1 := '<br/><br/><P ALIGN="center" CLASS="csER">EL ALUMNO NO PERTENECE A ESE PROGRAMA.</P>';
      end;

      IF (vscarre1 IS NULL) THEN vscarre1 := vscarre2; END IF;

      RETURN vscarre1;
  end;


  function f_TieneMaterias RETURN VARCHAR2 IS

    vsRegresa   VARCHAR2(300)         := NULL;
    lnMatPer    INTEGER               := 0;
    lsMatP      CONSTANT VARCHAR2(80) := 'NO cuenta con registro curricular en el periodo seleccionado - '||vsPeriodo;

  begin

     -- verifica si tiene materias del periodo:
     select count(SFRSTCR_crn)
       into lnmatper
       from SFRSTCR
      where SFRSTCR_pidm       = global_pidm
        and (SFRSTCR_term_code = vsPeriodo or vsPeriodo IS NULL) ;

     -- verifica en shacrse:
     if (lnMatPer = 0 ) then
        select count(shrtckn_crn)
          into lnmatper
          from shrtckn
         where shrtckn_pidm = global_pidm
           and (shrtckn_term_code = vsPeriodo or vsPeriodo is null);

        if (lnMatPer = 0 ) then vsRegresa := lsMatP; end if;

     end if;

     return vsRegresa;

  end f_TieneMaterias;

    function f_TieneHolds ( pnPidm     VARCHAR2,
                          pnPeriodo  VARCHAR2 ) RETURN VARCHAR2 IS

    lsClasstd    VARCHAR2(500)         := NULL;
    lnMatPer     INTEGER               := 0;
    lsCompl      VARCHAR2(17)          := 'tiene adeudo de ';
    lsMatP       CONSTANT VARCHAR2(67) := 'NO cuenta con registro curricular en el periodo seleccionado - ';
    lsHold       CONSTANT VARCHAR2(65) := '*** NO se pueden mostrar datos por que el alumno ';
    csSalLocal   VARCHAR2(300)         := NULL;

  -- verifica los holds invlidos para impresin del certificado:
  CURSOR cuHold IS

         SELECT SPRHOLD_HLDD_CODE, STVHLDD_DESC||'- '    dHold
           FROM SPRHOLD,
                STVHLDD
          WHERE SPRHOLD_PIDM            = global_pidm
            AND SPRHOLD_HLDD_CODE       = STVHLDD_CODE
            AND STVHLDD_TRANS_HOLD_IND IS NOT NULL
            AND SPRHOLD_HLDD_CODE      not in (csMA)
            AND TRUNC(SYSDATE)BETWEEN TRUNC(SPRHOLD_FROM_DATE) AND TRUNC(SPRHOLD_TO_DATE);
       --   and sprhold_hldd_code in ('ma','lf','bi')

  BEGIN

  -- verifica si tiene materias del periodo
  --  select count(sftregs_crn)
  --    into lnmatper
  --    from sftregs
  --   where sftregs_pidm       = global_pidm
  --     and (sftregs_term_code = pnperiodo or pnperiodo is null);
  --
  --  if (lnmatper = 0) then
  --     cssallocal := lshold||lsmatp;
  --  end if;

     -- barre los holds:
     FOR vhold IN cuHold LOOP
         lsClasstd := lsClasstd||vhold.dHold;
     END LOOP;

     IF (lsClasstd IS NOT NULL) THEN lsClasstd := lsHold ||''||lsCompl||lsClasstd||' ***'; END IF;

     RETURN lsClasstd;

  EXCEPTION
     WHEN NO_DATA_FOUND THEN
          lsClasstd := 'NO DATA';
          RETURN NULL;
     WHEN OTHERS THEN
          lsClasstd := '***';
          RETURN NULL;
  END;


  procedure p_RegistraCertificado IS

    vsClasstd  varchar2(300) := null;

  begin

     -- obtiene el nombre legal:
     BEGIN
        SELECT NVL(REPLACE(SPBPERS_LEGAL_NAME,'*',' '),'Sin Nombre Legal')  Nombre,
               SPBPERS_NAME_SUFFIX                                          Suffix,
               TO_CHAR(sysdate,'YYYY')                                      ImpAno
          INTO vsNombre,
               vsRut,
               vsAno
          FROM SPBPERS
         WHERE SPBPERS_PIDM = global_pidm;

     EXCEPTION
        WHEN NO_DATA_FOUND THEN
             vsNombre := '**********';
             vsRut    := '**********';
             vsAno    := '****';
     END;

     -- verifica que no tenga holds
     vsClasstd := f_TieneHolds(global_pidm, vsPeriodo);

     IF (vsClasstd IS NULL) THEN

        IF (SUBSTR(vsPeriodo,5,2) = '25') THEN
           vsClasstd := '1er. semestre';
           vsAno     := SUBSTR(vsPeriodo,1,4);
        ELSIF (SUBSTR(vsPeriodo,5,2) = '75') THEN
              vsClasstd := '2do. semestre';
              vsAno     := SUBSTR(vsPeriodo,1,4);
        ELSIF (SUBSTR(vsPeriodo,5,2) = '10') THEN
              vsClasstd := 'periodo anual';
              vsAno     := SUBSTR(vsPeriodo,1,4);
        END IF;

     END IF;

     vsClasstdn := vsClasstd;

     BEGIN
        SELECT STVCOLL_DESC
          INTO vsSchool
          FROM STVCOLL
         WHERE STVCOLL_CODE = vsEscuela;

     EXCEPTION
        WHEN NO_DATA_FOUND THEN
             vsSchool := '**********';
     END;

     -- obtiene la descripcin de la carrera:
     BEGIN
        SELECT STVMAJR_DESC
          INTO vsCarrera
          FROM STVMAJR
         WHERE STVMAJR_CODE = vsCode;

     EXCEPTION
        WHEN NO_DATA_FOUND THEN
             vsCarrera := '**********';
     END;

     -- obtiene la fecha de egreso:
     BEGIN
        SELECT NVL(TO_CHAR(MAX(SHRDGMR_APPL_DATE),'month'),'*********')||' de '||NVL(TO_CHAR(MAX(SHRDGMR_APPL_DATE),'YYYY'),'****')
          INTO vsFecEgreso
          FROM SHRDGMR
         WHERE SHRDGMR_PIDM        = global_pidm
           AND SHRDGMR_PROGRAM     = vsProg
           AND SHRDGMR_LEVL_CODE   = vsLevel
           AND SHRDGMR_MAJR_CODE_1 = vsCode;
     EXCEPTION
        WHEN NO_DATA_FOUND THEN
             vsFecEgreso := '**********';
     END;

     -- obtiene la descripcin de la facultad:
     BEGIN
        SELECT STVCAMP_DESC
          INTO vsFacultad
          FROM STVCAMP
         WHERE STVCAMP_CODE = vsFacultad;
     EXCEPTION
        WHEN NO_DATA_FOUND THEN
             vsFacultad := '**********';
     END;

     -- determina si es la carrera de derecho:
     BEGIN
        SELECT COUNT(STVMAJR_CODE)
          INTO vnEsdeDerecho
          FROM STVMAJR
         WHERE UPPER(STVMAJR_DESC) LIKE 'DERECHO%'
           AND STVMAJR_CODE = vsCode;
     EXCEPTION
        WHEN NO_DATA_FOUND THEN
             vnEsdeDerecho := '**********';
     END;

     -- obtiene el nombre del alumno:
     BEGIN
        SELECT DISTINCT(REPLACE(SPRIDEN_LAST_NAME,'*',' ')||' '||SPRIDEN_FIRST_NAME)
          INTO vsNomSpriden
          FROM SPRIDEN
         WHERE SPRIDEN_PIDM = global_pidm
         AND SPRIDEN_CHANGE_IND IS NULL;
     EXCEPTION
        WHEN NO_DATA_FOUND THEN
             vsNomSpriden := '**********';
     END;

     -- determina las palabras de acuerdo al sexo del alumno:
     vsSexo := FWRSEXO(global_pidm);
     SELECT DECODE(vsSexo, 'Masculino','es alumno ' ,'Femenino','es alumna ' , 'es ****** ') INTO vsEsAlumno  FROM DUAL;
     SELECT DECODE(vsSexo, 'Masculino','fue alumno ','Femenino','fue alumna ', 'es ****** ') INTO vsFueAlumno FROM DUAL;
     SELECT DECODE(vsSexo, 'Masculino','el alumno ' ,'Femenino','la alumna ' , 'es ****** ') INTO vsElAlumno  FROM DUAL;

     -- obtiene las fechas de inicio y de trmino de la carrera:
     SELECT TO_CHAR(STVTERM_START_DATE,'month')||' de '||TO_CHAR(STVTERM_START_DATE,'YYYY')
       INTO vsMesAnoStdn1
       FROM STVTERM WHERE STVTERM_CODE = vsStdn1;

     SELECT TO_CHAR(STVTERM_START_DATE,'month')||' de '||TO_CHAR(STVTERM_START_DATE,'YYYY')
       INTO vsMesAnoStdn2
       FROM STVTERM WHERE STVTERM_CODE = vsStdn2;

     -- obtiene las fechas de suspensin de la carrera:
     SELECT CASE WHEN TO_NUMBER(TO_CHAR(STVTERM_START_DATE,'mm')) <= 6 THEN '1er' ELSE '2do' END,
            TO_CHAR(STVTERM_START_DATE,'YYYY')
       INTO vs1erClaseStdn, vs1erAnoStdn
       FROM STVTERM WHERE STVTERM_CODE = vsStdn1;

     SELECT CASE WHEN TO_NUMBER(TO_CHAR(STVTERM_START_DATE,'mm')) <= 6 THEN '1er' ELSE '2do' END,
            TO_CHAR(STVTERM_START_DATE,'YYYY')
       INTO vsUltClaseStdn, vsUltAnoStdn
       FROM STVTERM WHERE STVTERM_CODE = vsStdn2;

     vsBanExito := 'N';

     -- registra en la bitcora de impresiones:
     BEGIN
        SELECT NVL(MAX(SWRSCRT_ID_CONSEC),0) + 1
          INTO vnConsecNo
          FROM SWRSCRT
         WHERE SWRSCRT_TYPE_PARA = csParam
           AND SWRSCRT_TERM_CODE = NVL(vsPeriodo,'999999');

        INSERT INTO SWRSCRT ( SWRSCRT_TYPE_PARA,
                              SWRSCRT_TERM_CODE,       SWRSCRT_ID_CONSEC,       SWRSCRT_RECMCODE,
                              SWRSCRT_DOCTO_CODE,      SWRSCRT_PIDM,            SWRSCRT_NOMBRE,
                              SWRSCRT_RUT,             SWRSCRT_CLAS_STDN,       SWRSCRT_SCHO_STDN )
                    VALUES  ( csParam,
                              NVL(vsPeriodo,'999999'), vnConsecNo,              cnModRep,
                              vnCert,                  global_pidm,             vsNombre,
                              vsRut,                   SUBSTR(vsClasstdn,0,29), vsSchool );
        COMMIT;
        vsBanExito := 'Y';

     EXCEPTION
        WHEN OTHERS THEN
             vsError    := SUBSTR(SQLERRM,1,500);
             vsBanExito := 'N';
     END;

     vsFecImprime := TO_CHAR(sysdate,'DD')||' de '||TO_CHAR(sysdate,'month')||' de '||TO_CHAR(sysdate,'YYYY');

  END p_RegistraCertificado;


-------------------------------------------------------
-- bloque principal para la generacin del certificado
-------------------------------------------------------

BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- son buscados los valores de las cookies para asignar los valores del filtro del query:
   vsExp      := pk_objHtml.getValueCookie('psExped');
   vsProg     := pk_objHtml.getValueCookie('psPgm');
   vnCert     := pk_objHtml.getValueCookie('psTraCe');
   vsPeriodoT := pk_objHtml.getValueCookie('psPerio');

   -- obtiene el pidm:
   global_pidm := f_get_pidm(vsExp);
   vsPeriodo   := vsPeriodoT;

   -- obtiene el nombre o descripcin del certificado:
   BEGIN
      SELECT GWBTIPO_DESC
        INTO vsDesDocto
        FROM GWBTIPO
       WHERE GWBTIPO_CODE = csParam
         AND TO_NUMBER(GWBTIPO_TYPE) = vnCert;
   EXCEPTION
      WHEN OTHERS THEN NULL;
   END;

   -- informacin bsica del estudiante y situacin actual:
   BEGIN
      SELECT SGBSTDN_MAJR_CODE_1, SGBSTDN_LEVL_CODE,   SGBSTDN_CAMP_CODE,
             SGBSTDN_STST_CODE,   SGBSTDN_COLL_CODE_1
        INTO vsCode, vsLevel, vsFacultad, vsStatCong, vsEscuela
        FROM SGBSTDN
       WHERE SGBSTDN_PIDM          = global_pidm
         AND SGBSTDN_PROGRAM_1     = vsProg
         AND SGBSTDN_TERM_CODE_EFF = (SELECT MAX(SGBSTDN_TERM_CODE_EFF)
                                        FROM SGBSTDN
                                       WHERE SGBSTDN_PIDM      = global_pidm
                                         AND SGBSTDN_PROGRAM_1 = vsProg);
   EXCEPTION
      WHEN OTHERS THEN  NULL;
   END;

   -- obtiene los periodos inicio y final del estudiante y carrera:
   BEGIN
      SELECT MIN(SGBSTDN_TERM_CODE_EFF)  FMin,
             MAX(SGBSTDN_TERM_CODE_EFF)  FMax
        INTO vsStdn1,
             vsStdn2
        FROM SGBSTDN
       WHERE SGBSTDN_PIDM      = global_pidm
         AND SGBSTDN_PROGRAM_1 = vsprog;
   EXCEPTION
      WHEN OTHERS THEN NULL;
   END;

   -- renglones disponibles para impresin:
   vnValida := (cnLinPag - vnValida);

   -- desactiva ventana de "espere ...":
   htp.p('<script language="javascript" src="kwacnls.js"></script>');

   -- inicializa la pgina html:
   htp.p('<html><head><title>'||'Impresin de Certificados'||'Untitled Page</title>
                <style type="text/css">
                   p            {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10pt; font-weight: normal; font-style: normal; color: #000000;}
                   p.pER        {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10pt; font-weight: normal; font-style: normal; color: #FF0000; text-align: center;}
                   td           {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10pt; font-weight: normal; font-style: normal; color: #000000;}
                   td.tdER      {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10pt; font-weight: normal; font-style: normal; color: #FF0000; text-align: center;}
                   font         {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10pt; font-weight: normal; font-style: normal; color: #000000;}
                   font.fontH1  {font-family: Times New Roman, verdana, helvetica; sans-serif; font-size: 13pt; font-weight: bold;   font-style: normal; color: #000000;}
                   font.fontH2  {font-family: Times New Roman, verdana, helvetica; sans-serif; font-size: 13pt; font-weight: bold;   font-style: normal; color: #000000;}
                   font.fontTX  {font-family: Times New Roman, verdana, helvetica; sans-serif; font-size: 13pt; font-weight: normal; font-style: normal; color: #000000;}
                   font.fontER  {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10pt; font-weight: bold;   font-style: normal; color: #FF0000; text-align: center;}
                   font.fontNM  {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10t;  font-weight: normal; font-style: normal; color: #000000;}
                   font.fontNMB {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10pt; font-weight: bold;   font-style: normal; color: #000000;}
                   font.fontT8  {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 8pt;  font-weight: normal; font-style: normal; color: #000000;}
                   font.fontT10 {font-family: Arial Narrow,    verdana, helvetica; sans-serif; font-size: 10pt; font-weight: normal; font-style: normal; color: #000000;}
                </style>
                <script language="JavaScript"><!--
                        function fImprimeReporte() {
                                 window.focus()
                                 print();}
                //--></script>
                </head><body>');

   -- inicia tabla de despliegue:
   htp.p('<table width="70%" border="0" align="center">');

   -- verifica si el documento ya est disponible para su impresin:
   IF (f_ImprimeReporte(vnCert) = csY) THEN

         -- verifica si tiene materias:
        -- IF (f_TieneMaterias IS NULL) THEN

            -- verifica el estado del estudiante:
            IF (f_checaStudent(global_pidm,vsProg) IS NULL) THEN

               -- agrega a bitcora de impresin y obtiene informacin del detalle de las leyendas:
               p_RegistraCertificado;

               IF (vsBanExito = 'N') THEN
                  htp.p('<TR/><TD CLASS="tdER"><b>*** ERROR *** AL OBTENER EL FOLIO DEL CERTIFICADO.</b>... '||vsError||'</TD></TR>');
               ELSIF (vnCert = 6 AND vnEsdeDerecho = 0) THEN
                     htp.p('<TR/><TD CLASS="tdER"><b>EL CERTIFICADO &nbsp;"'||UPPER(vsDesDocto)||'"&nbsp; S&Oacute;LO ES V&Aacute;LIDO PARA DERECHO.</b></TD></TR>');
               ELSIF (vnCert= 12 AND vsStatCong != 'IS') THEN
                     htp.p('<TR/><TD CLASS="tdER"><b>EL CERTIFICADO &nbsp;"'||UPPER(vsDesDocto)||'"&nbsp; S&Oacute;LO ES V&Aacute;LIDO PARA EL ESTATUS DE CONGELADO.</b></TD></TR>');
               ELSIF (INSTR('25|75|10',SUBSTR(vsPeriodo,5,2)) = 0) THEN
                     htp.p('<TR/><TD CLASS="tdER"><b>EL PERIODO ES INV&Aacute;LIDO PARA IMPRESI&OAacute;N DE CERTIFICADOS.</b></TD></TR>');
               ELSE

                  -- verifica si es certificado "sin impedimentos":
                  IF vnCert = 18 THEN
                     -- determina el espacio entre el mrgen superior y el encabezado:
                     FOR vnI IN 1..cnEspMsE18 LOOP
                         htp.p(csLBlanco);
                     END LOOP;
                  ELSE
                     -- determina el espacio entre el mrgen superior y el encabezado:
                     FOR vnI IN 1..cnEspMsE LOOP
                         htp.p(csLBlanco);
                     END LOOP;
                  END IF;

                  FOR reg_Texto IN cu_Texto(vnCert) LOOP

                      -- inicia impresin de la pgina:
                      htp.p(csTRAbre);

                      vsImprime   := CASE
                                     WHEN reg_Texto.rJustif = 'JUSTIFY' THEN '<TD class="fontT10">'
                                                                        ELSE '<TD class="fontT10" align="'||reg_texto.rjustif||'" >'
                                     END;

                      vsPasoTexto := reg_Texto.rDesc;

                      -- reemplaza valores de variables:
                      IF INSTR(vsPasoTexto,'||esAlumno')     > 0 THEN SELECT REPLACE(vsPasoTexto,'||esAlumno',vsEsAlumno)                             INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||fueAlumno')    > 0 THEN SELECT REPLACE(vsPasoTexto,'||fueAlumno',vsfueAlumno)                           INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||elAlumno')     > 0 THEN SELECT REPLACE(vsPasoTexto,'||elAlumno',vsElAlumno)                             INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||Nombre')       > 0 THEN SELECT REPLACE(vsPasoTexto,'||Nombre',UPPER(vsNombre))                          INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||RutSuffix')    > 0 THEN SELECT REPLACE(vsPasoTexto,'||RutSuffix',UPPER(vsRut))                          INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||ClaseSTDN')    > 0 THEN SELECT REPLACE(vsPasoTexto,'||ClaseSTDN',vsClasstdn)                            INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||AnoGenRep')    > 0 THEN SELECT REPLACE(vsPasoTexto,'||AnoGenRep',UPPER(vsAno))                          INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||carrera')      > 0 THEN SELECT REPLACE(vsPasoTexto,'||carrera',vsCarrera)                               INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||escuela')      > 0 THEN SELECT REPLACE(vsPasoTexto,'||escuela',vsSchool)                                INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||FechaImprime') > 0 THEN SELECT REPLACE(vsPasoTexto,'||FechaImprime',vsFecImprime)                       INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||FolDocto')     > 0 THEN SELECT REPLACE(vsPasoTexto,'||FolDocto','<B>'||LPAD(vnConsecNo,6,'0')||'</B>')  INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||FecEgreso')    > 0 THEN SELECT REPLACE(vsPasoTexto,'||FecEgreso',vsFecEgreso)                           INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||Facultad')     > 0 THEN SELECT REPLACE(vsPasoTexto,'||Facultad',vsFacultad)                             INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||NomSpriden')   > 0 THEN SELECT REPLACE(vsPasoTexto,'||NomSpriden',vsNomSpriden)                         INTO vsPasoTexto FROM DUAL; END IF;

                      IF INSTR(vsPasoTexto,'||mesAno1erStdn')> 0 THEN SELECT REPLACE(vsPasoTexto,'||mesAno1erStdn',vsMesAnoStdn1)                     INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||mesAnoUltStdn')> 0 THEN SELECT REPLACE(vsPasoTexto,'||mesAnoUltStdn',vsMesAnoStdn2)                     INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||1erClaseStdn') > 0 THEN SELECT REPLACE(vsPasoTexto,'||1erClaseStdn',vs1erClaseStdn)                     INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||1erAnoStdn')   > 0 THEN SELECT REPLACE(vsPasoTexto,'||1erAnoStdn',vs1erAnoStdn)                         INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||UltClaseStdn') > 0 THEN SELECT REPLACE(vsPasoTexto,'||UltClaseStdn',vsUltClaseStdn)                     INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||UltAnoStdn')   > 0 THEN SELECT REPLACE(vsPasoTexto,'||UltAnoStdn',vsUltAnoStdn)                         INTO vsPasoTexto FROM DUAL; END IF;

                   -- if instr(vspasotexto,'||styleh1')      > 0 then select replace(vspasotexto,'la ||styleh1','<br>la '||csh1)                      into vspasotexto from dual; end if;
                      IF INSTR(vsPasoTexto,'||styleH1')      > 0 THEN SELECT REPLACE(vsPasoTexto,'La ||styleH1',' La '||csH1)                         INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||styleH2')      > 0 THEN SELECT REPLACE(vsPasoTexto,'||styleH2',csH2)                                    INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||styleTX')      > 0 THEN SELECT REPLACE(vsPasoTexto,'||styleH2',csTX)                                    INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||styleNM')      > 0 THEN SELECT REPLACE(vsPasoTexto,'||styleH2',csNM)                                    INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||styleNMB')     > 0 THEN SELECT REPLACE(vsPasoTexto,'||styleH2',csNMB)                                   INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||styleT8')      > 0 THEN SELECT REPLACE(vsPasoTexto,'||styleH2',cst8)                                    INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||styleH10')     > 0 THEN SELECT REPLACE(vsPasoTexto,'||styleH2',csT10)                                   INTO vsPasoTexto FROM DUAL; END IF;
                      IF INSTR(vsPasoTexto,'||styleFF')      > 0 THEN SELECT REPLACE(vsPasoTexto,'||styleFF',csFF)                                    INTO vsPasoTexto FROM DUAL; END IF;

                      -- arma cadena a imprimir en el formato:
                      vsImprime := vsImprime||CASE
                                                 WHEN reg_Texto.rFont = 'HH1'  THEN csH1||vsPasoTexto||csFF||'</TD>'
                                                 WHEN reg_Texto.rFont = 'HH2'  THEN csH2||vsPasoTexto||csFF||'</TD>'
                                                 WHEN reg_Texto.rFont = 'HH2A' THEN csTX||vsPasoTexto||csFF||'</TD>'
                                                 WHEN reg_Texto.rFont = 'FM1'  THEN csTX||vsPasoTexto||csFF||'</TD>'
                                                 WHEN reg_Texto.rFont = 'FT1'  THEN csTX||vsPasoTexto||csFF||'</TD>'
                                                 WHEN reg_Texto.rFont = 'TX1'  THEN '<P align="'||reg_Texto.rJustif||'">'||csTX||vsPasoTexto||csFF||'</P></TD>'
                                                 ELSE '</TD>'
                                              END;

                      -- determina el espacio entre las lneas del encabezado:
                      IF (SUBSTR(reg_Texto.rFont,1,2) = 'HH' AND (vscodhtp IS NULL OR SUBSTR(vscodhtp,1,2) = 'HH')) THEN
                         htp.p(csLBlanco);
                         htp.p(csLBlanco);
                         vnLinhtp := vnLinhtp + 1;
                      END IF;

                      -- verifica si es certificado "estudios foliados":
                      IF vncert = 19 THEN

                         -- determina el espacio entre el encabezado y el primer prrafo:
                         IF (SUBSTR(reg_Texto.rFont,1,2) = 'TX') THEN
                            IF (vnLinHtp < 6) THEN          -- cnespep
                               vnLinHtp := vnLinHtp + 1;

                               FOR vnJ IN vnLinHtp..6 LOOP
                                   htp.p(csLBlanco);
                                   vnLinHtp := vnLinHtp + 1;
                               END LOOP;

                               vnLinHtp := 6;
                            ELSE
                               htp.p(csLBlanco);
                               vnLinHtp := vnLinHtp + 1;
                            END IF;
                         END IF;
                         -- determina el espacio entre el ltimo prrafo y la firma:
                         IF (SUBSTR(reg_Texto.rFont,1,2) = 'FM') THEN
                            IF (vnLinHtp < 4 ) THEN         -- cnesppf
                               vnLinHtp := vnLinHtp + 1;

                               FOR vnJ IN vnLinHtp..4 LOOP
                                   htp.p(csLBlanco);
                                   vnLinHtp := vnLinHtp + 1;
                               END LOOP;

                               vnLinHtp := 4;
                            END IF;
                         END IF;
                         -- determina el espacio entre la firma y la fecha:
                         IF (SUBSTR(reg_Texto.rFont,1,2) = 'FT') THEN
                            IF (vnLinHtp < 18 ) THEN         -- cnespff
                               vnLinHtp := vnLinHtp + 1;

                               FOR vnJ IN vnLinHtp..18 LOOP
                                   htp.p(csLBlanco);
                                   vnLinHtp := vnLinHtp + 1;
                               END LOOP;

                               vnLinHtp := 18;
                            END IF;
                         END IF;

                      ELSE

                         -- determina el espacio entre el encabezado y el primer prrafo:  (original)
                         IF (SUBSTR(reg_Texto.rFont,1,2) = 'TX') THEN
                            IF (vnLinHtp < 8) THEN          -- cnespep
                               vnLinHtp := vnLinHtp + 1;

                               FOR vnJ IN vnLinHtp..8 LOOP
                                   htp.p(csLBlanco);
                                   vnLinHtp := vnLinHtp + 1;
                               END LOOP;

                               vnLinHtp := 8;
                            ELSE
                               htp.p(csLBlanco);
                               vnLinHtp := vnLinHtp + 1;
                            END IF;
                         END IF;
                         -- determina el espacio entre el ltimo prrafo y la firma:  (original)
                         IF (SUBSTR(reg_Texto.rFont,1,2) = 'FM') THEN
                            IF (vnLinHtp < 18 ) THEN         -- cnesppf
                               vnLinHtp := vnLinHtp + 1;

                               FOR vnJ IN vnLinHtp..18 LOOP
                                   htp.p(csLBlanco);
                                   vnLinHtp := vnLinHtp + 1;
                               END LOOP;

                               vnLinHtp := 18;
                            END IF;
                         END IF;
                         -- determina el espacio entre la firma y la fecha:  (original)
                         IF (SUBSTR(reg_Texto.rFont,1,2) = 'FT') THEN
                            IF (vnLinHtp < 24 ) THEN         -- cnespff
                               vnLinHtp := vnLinHtp + 1;

                               FOR vnJ IN vnLinHtp..24 LOOP
                                   htp.p(csLBlanco);
                                   vnLinHtp := vnLinHtp + 1;
                               END LOOP;

                               vnLinHtp := 24;
                            END IF;
                         END IF;

                      END IF;

                      htp.p(vsImprime);
                      htp.p(csTRCierra);

                      vsCodHtp := reg_Texto.rFont;
                      vnLinHtp := vnLinHtp + 1;

                  END LOOP;

               END IF;  -- if (vsbanexito = 'n')
            ELSE
               htp.p('<TR/><TD class="tdER">ESTATUS ... <B>'||f_checaStudent(global_pidm,vsProg )||'.</B></TD></TR>');
            END IF;  -- if (f_checastudent(global_pidm,vsprog)
--         ELSE
--            htp.p('<TR/><TD class="tdER">ESTATUS ... <B>'||f_TieneMaterias||'.</B></TD></TR>');
--         END IF;  -- if (f_tienematerias)
   ELSE
      htp.p('<TR/><TD class="tdER">El certificado <b>'||vsDesDocto||' </b> NO EST&Aacute; DISPONIBLE para su impresi&oacute;n.</TD></TR>');
   END IF;  -- if (f_imprimereporte(vncert)

   htp.p('</TABLE><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        vsError := SUBSTR(SQLERRM,1,500);
        htp.p('<P class="pER">GENERACI&Oacute;N DE CERTIFICADOS ESCOLARES --> '||vsError||' </P>');

END PWRHOLD;
/


DROP PUBLIC SYNONYM PWRHOLD;

CREATE PUBLIC SYNONYM PWRHOLD FOR BANINST1.PWRHOLD;


GRANT EXECUTE ON BANINST1.PWRHOLD TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRHOLD TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRHOLD TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRHOLD TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRHRAS;

CREATE OR REPLACE PROCEDURE BANINST1.PWRHRAS(psReclDesc VARCHAR2,
                                             psTerm     VARCHAR2 DEFAULT NULL,
                                             psEscu     VARCHAR2 DEFAULT NULL,
                                             psTipo     VARCHAR2 DEFAULT NULL,
                                             pnPidm     NUMBER   DEFAULT NULL,
                                             psPtrm     VARCHAR2 DEFAULT NULL,
                                             psType     VARCHAR2 DEFAULT NULL,
                                             psUser     VARCHAR2 DEFAULT NULL,
                                             psProceso  VARCHAR2 DEFAULT NULL,
                                             psPlaHon   VARCHAR2 DEFAULT NULL
                                           ) IS

/*
         TAREA: Reporte de horas de docente de planta
         FECHA: 12/05/2006
         AUTOR: VBZ
        MODULO: Programacin acadmica

  Modificacin: 01/03/2010
                GEPC
                * Se agregue la columna de "porcentaje de responsabilidad".
                  (Campo:SIRASGN_PERCENT_RESPONSE de SSASECT).
                  - es ms funcional para las auditoras de la programacin acadmica
                    se pueda revisar el dato por profesor

                * TUNING
                  - Se quitan variables que no se usan
                  - Se eliminan columnas que no se usan en las consultas
                  - Son homologados los reportes:
                    "Reporte de horas de docente de planta"     (Pk_Reporteprogacademica.PGAD21)
                    y
                    "Reporte de Horas de docente de Honorarios" (Pk_Reporteprogacademica.PGAD20)

*/

  csPlanta   CONSTANT VARCHAR2(6)   := 'PLA';
  csHonora   CONSTANT VARCHAR2(6)   := 'HON';

  vnRow      INTEGER                := 0;
  vnRegs     INTEGER                := 0;
  vnExists   INTEGER                := 0;
  vnColumnas INTEGER                := 7;
  tabColumna Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);

  vsPerio    VARCHAR2(1000)         := NULL;
  vsFacu     VARCHAR2(3)            := NULL;
  vsCate     VARCHAR2(10)           := NULL;
  vsTipo     VARCHAR2(10)           := NULL;
  vsSede     VARCHAR2(10)           := NULL;
  vsPtrm     VARCHAR2(1000)         := NULL;
  vsSeccion  VARCHAR2(3)            := NULL;
  vsTermCode VARCHAR2(6)            := NULL;
  vsCampCode VARCHAR2(6)            := NULL;
  vsInicoPag VARCHAR2(10)           := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion

  CURSOR cuReporte(psTerm  VARCHAR2 DEFAULT NULL,
                   psFacu  VARCHAR2 DEFAULT NULL,
                   psCate  VARCHAR2 DEFAULT NULL,
                   psType  VARCHAR2 DEFAULT NULL,
                   psPtrm  VARCHAR2 DEFAULT NULL
                  ) IS
         SELECT SSBSEC.termCode                                 termCode,
                SSBSEC.ptrmCode                                 ptrmCode,
                SSBSEC.campCode                                 campCode,
                SSBSEC.collCode                                 collCode,
                SSBSEC.collDesc                                 collDesc,
                SSBSEC.asgnPidm                                 asgnPidm,
                SPRIDEN_ID                                      idenIDdd,
                REPLACE(REPLACE(SPRIDEN_LAST_NAME||' '||
                SPRIDEN_FIRST_NAME||' '||
                SPRIDEN_MI,'','&ntilde;'),'*',' ')             idenName,
                SSBSEC.fstpCode                                 fstpCode,
                Pk_Catalogo.TIPO(SSBSEC.fstpCode)               fstpDesc,
                NVL(SSBSEC.horsWeek,0)                          horsWeek,
                NVL(SIRNIS.nistWork,0)                          nistWork,
                NVL(SSBSEC.horsWeek,0) + NVL(SIRNIS.nistWork,0) totlWork
          FROM (SELECT SSBSECT_TERM_CODE                    termCode,
                       SSBSECT_PTRM_CODE                    ptrmCode,
                       SSBSECT_CAMP_CODE                    campCode,
                       SIRDPC.collCode                      collCode,
                       Pk_Catalogo.COLEGIO(SIRDPC.collCode) collDesc,
                       SSRMEE.asgnPidm                      asgnPidm,
                       SSRMEE.fstpCode                      fstpCode,
                       SUM(SSRMEE.horsWeek)                 horsWeek
                  FROM SSBSECT,
                       SCBCRSE,
                       (SELECT SSRMEET_TERM_CODE        termCode,
                               SIRASGN_PIDM             asgnPidm,
                               SSRMEET_CRN              asgnCrnn,
                               NVL(SSRMEET_HRS_WEEK,0)  horsWeek,
                               SIBINS.fstpCode          fstpCode,
                               SIBINS.fctgCode          fctgCode
                          FROM SIRASGN,
                               SSRMEET,
                               (SELECT SI.SIBINST_PIDM      instPidm,
                                       SI.SIBINST_FSTP_CODE fstpCode,
                                       SI.SIBINST_FCTG_CODE fctgCode
                                  FROM SIBINST SI
                                 WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(ZI.SIBINST_TERM_CODE_EFF)
                                                                  FROM SIBINST ZI
                                                                 WHERE ZI.SIBINST_PIDM            =  SI.SIBINST_PIDM
                                                                   AND (ZI.SIBINST_TERM_CODE_EFF <= psTerm OR psTerm IS NULL)
                                                               )
                               ) SIBINS
                         WHERE SIRASGN_PIDM              = SIBINS.instPidm(+)
                           AND SSRMEET_TERM_CODE         = SIRASGN_TERM_CODE(+)
                           AND SSRMEET_CRN               = SIRASGN_CRN(+)
                           AND SSRMEET_CATAGORY          = SIRASGN_CATEGORY(+)
                           AND SIRASGN_PERCENT_RESPONSE  > 0
                           AND (   (SIBINS.fstpCode <> csHonora AND psPlaHon = csPlanta)
                                OR
                                   (SIBINS.fstpCode  = csHonora AND psPlaHon = csHonora)
                               )
                      ) SSRMEE,
                      (SELECT SIRDPCL_PIDM      dpclPidm,
                              SIRDPCL_COLL_CODE collCode,
                              SIRDPCL_DEPT_CODE deptSede
                         FROM SIRDPCL A
                        WHERE SIRDPCL_HOME_IND      = 'Y'
                          AND SIRDPCL_TERM_CODE_EFF = (SELECT MAX(SI.SIRDPCL_TERM_CODE_EFF)
                                                         FROM SIRDPCL SI
                                                        WHERE SI.SIRDPCL_PIDM           =  A.SIRDPCL_PIDM
                                                          AND (SI.SIRDPCL_TERM_CODE_EFF <= psTerm OR psTerm IS NULL)
                                                      )
                      ) SIRDPC
                WHERE SSBSECT_SUBJ_CODE     = SCBCRSE_SUBJ_CODE
                  AND SSBSECT_CRSE_NUMB     = SCBCRSE_CRSE_NUMB
                  AND SCBCRSE_EFF_TERM      = (SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                                 FROM SCBCRSE SC
                                                WHERE SC.SCBCRSE_EFF_TERM <= SSBSECT_TERM_CODE
                                                  AND SC.SCBCRSE_SUBJ_CODE = SSBSECT_SUBJ_CODE
                                                  AND SC.SCBCRSE_CRSE_NUMB = SSBSECT_CRSE_NUMB
                                              )
                  AND SSBSECT_TERM_CODE     = SSRMEE.termCode
                  AND SSBSECT_CRN           = SSRMEE.asgnCrnn
                  AND SIRDPC.dpclPidm       = SSRMEE.asgnPidm
                  AND (SSBSECT_TERM_CODE                                     = psTerm  OR psTerm  IS NULL)
                  AND (SIRDPC.collCode                                       = psFacu  OR psFacu  IS NULL)
                  AND (SSRMEE.fctgCode                                       = psCate  OR psCate  IS NULL)
                  AND (SUBSTR(SSRMEE.fstpCode,1,2)                           = psType  OR psType  IS NULL)
                  AND (INSTR('/' || psPtrm, '/' || SSBSECT_PTRM_CODE || '/') > 0       OR psPtrm  IS NULL)
                GROUP BY SSBSECT_TERM_CODE,
                         SSBSECT_PTRM_CODE,
                         SSBSECT_CAMP_CODE,
                         SIRDPC.collCode,
                         SSRMEE.asgnPidm,
                         SSRMEE.fstpCode,
                         SSRMEE.fctgCode
               ) SSBSEC,
               (SELECT SIRNIST_TERM_CODE                 termCode,
                       SIRNIST_PIDM                      nistPidm,
                       SUM(NVL(SIRNIST_NIST_WORKLOAD,0)) nistWork
                  FROM SIRNIST
                 GROUP BY SIRNIST_TERM_CODE,
                          SIRNIST_PIDM
               ) SIRNIS,
               SPRIDEN
         WHERE SSBSEC.termCode     = SIRNIS.termCode(+)
           AND SSBSEC.asgnPidm     = SIRNIS.nistPidm(+)
           AND SSBSEC.asgnPidm     = SPRIDEN_PIDM
           AND SPRIDEN_CHANGE_IND IS NULL
         ORDER BY termCode DESC,
                  campCode,
                  idenName;

  procedure stilos(psTitle varchar2) is

  begin
      htp.p('<html><title>'||psTitle||'</title>

      <style type="text/css"><!--
      table {border-collapse:collapse;border:none;}
      tr    {height:20px;}
      th    {font-SIZE:8.0pt;  mso-bidi-font-SIZE:12.0pt;font-family:Arial Narrow, verdana, helvetica, sans-serif;mso-ansi-LANGUAGE:ES-MX;}
      td    {font-SIZE:8.0pt;  mso-bidi-font-SIZE:12.0pt;font-family:Arial Narrow, verdana, helvetica, sans-serif;mso-ansi-LANGUAGE:ES-MX;}
      --></style>

      </head><body bgcolor="#FFFFFF">'
      );
  end stilos;

  --el procedimiento presenta una ventana para mostrar la informacin de los cursos
  procedure horario(psStilos varchar2 default null
                   ) is

  --  Para obtener funciones de docencia
  cursor cuReporte is
         SELECT SSBSEC.termCode                                       termCode,
                SSBSEC.sectCrnn                                       sectCrnn,
                SSBSEC.ptrmCode                                       ptrmCode,
                SSBSEC.campCode                                       campCode,
                SSBSEC.collCode                                       collCode,
                SSBSEC.subjCode                                       subjCode,
                SSBSEC.crseNumb                                       crseNumb,
                Pk_Catalogo.TIPO(SSBSEC.fstpCode)                     fstpDesc,
                NVL(SSBSEC.horsWeek,0)                                horsWeek,
                SSBSEC.LU                                             LU,
                SSBSEC.MA                                             MA,
                SSBSEC.MI                                             MI,
                SSBSEC.JU                                             JU,
                SSBSEC.VI                                             VI,
                SSBSEC.SA                                             SA,
                SSBSEC.begTime                                        begTime,
                SSBSEC.endTime                                        endTime,
                SSBSEC.categor                                        categor,
                SSBSEC.asgnPerc                                       asgnPerc,
                DECODE(SWRXLST_TYPE,'M','Master',
                                    'S','Simultneo',
                                    'Independiente')                  xlstType,
                SSRXLST_XLST_GROUP                                    xlstGrop,
                DECODE(SWRXLST_TYPE,'M',SSBXLST_ENRL,SSBSEC.sectEnrl) sectEnrl,
                Pk_Catalogo.STATUS_1(SSBSEC.sstsCode)                 sstsCode
          FROM (SELECT SSBSECT_TERM_CODE              termCode,
                       SSBSECT_Crn                    sectCrnn,
                       SSBSECT_CAMP_CODE              campCode,
                       SSBSECT_SSTS_CODE              sstsCode,
                       SSBSECT_PTRM_CODE||' '||
                       SSBSECT_PTRM_START_DATE||' '||
                       SSBSECT_PTRM_END_DATE||' '||
                       SSBSECT_PTRM_WEEKS             ptrmCode,
                       SSBSECT_ENRL                   sectEnrl,
                       SCBCRSE_SUBJ_CODE              subjCode,
                       SCBCRSE_CRSE_NUMB              crseNumb,
                       SCBCRSE_COLL_CODE              collCode,
                       SSRMEE.asgnPidm                asgnPidm,
                       SSRMEE.fstpCode                fstpCode,
                       SSRMEE.LU                      LU,
                       SSRMEE.MA                      MA,
                       SSRMEE.MI                      MI,
                       SSRMEE.JU                      JU,
                       SSRMEE.VI                      VI,
                       SSRMEE.SA                      SA,
                       SSRMEE.begTime                 begTime,
                       SSRMEE.endTime                 endTime,
                       SSRMEE.categor                 categor,
                       SSRMEE.horsWeek                horsWeek,
                       SSRMEE.asgnPerc                asgnPerc
                  FROM SSBSECT,
                       SCBCRSE,
                       (SELECT SSRMEET_TERM_CODE                                   termCode,
                               SIRASGN_PIDM                                        asgnPidm,
                               SSRMEET_CRN                                         asgnCrnn,
                               NVL(SSRMEET_HRS_WEEK,0)                             horsWeek,
                               SIBINS.fstpCode                                     fstpCode,
                               DECODE(SSRMEET_MON_DAY, 'M', 'Lu', SSRMEET_MON_DAY) Lu,
                               DECODE(SSRMEET_TUE_DAY, 'T', 'Ma', SSRMEET_TUE_DAY) Ma,
                               DECODE(SSRMEET_WED_DAY, 'W', 'Mi', SSRMEET_WED_DAY) Mi,
                               DECODE(SSRMEET_THU_DAY, 'R', 'Ju', SSRMEET_THU_DAY) Ju,
                               DECODE(SSRMEET_FRI_DAY, 'F', 'Vi', SSRMEET_FRI_DAY) Vi,
                               DECODE(SSRMEET_SAT_DAY, 'S', 'Sa', SSRMEET_SAT_DAY) Sa,
                               SUBSTR(SSRMEET_BEGIN_TIME,1,2)||':'||
                                      NVL(SUBSTR(SSRMEET_BEGIN_TIME,3,2),'00')     begTime,
                               SUBSTR(SSRMEET_END_TIME,1,2)||':'||
                                      NVL(SUBSTR(SSRMEET_END_TIME,3,2),'00')       endTime,
                               SIRASGN_CATEGORY                                    categor,
                               SIRASGN_PERCENT_RESPONSE                            asgnPerc
                          FROM SIRASGN,
                               SSRMEET,
                               (SELECT SI.SIBINST_PIDM      instPidm,
                                       SI.SIBINST_FSTP_CODE fstpCode
                                  FROM SIBINST SI
                                 WHERE SI.SIBINST_TERM_CODE_EFF = (SELECT MAX(ZI.SIBINST_TERM_CODE_EFF)
                                                                     FROM SIBINST ZI
                                                                    WHERE ZI.SIBINST_PIDM            =  pnPidm
                                                                      AND (ZI.SIBINST_TERM_CODE_EFF <= psTerm OR psTerm IS NULL)
                                                                  )
                                   AND SI.SIBINST_PIDM          = pnPidm
                               ) SIBINS
                         WHERE SIRASGN_PIDM              = SIBINS.instPidm(+)
                           AND SSRMEET_TERM_CODE         = SIRASGN_TERM_CODE(+)
                           AND SSRMEET_CRN               = SIRASGN_CRN(+)
                           AND SSRMEET_CATAGORY          = SIRASGN_CATEGORY(+)
                           AND SIRASGN_PERCENT_RESPONSE  > 0
                           AND (   (SIBINS.fstpCode <> csHonora AND psPlaHon = csPlanta)
                                OR
                                   (SIBINS.fstpCode  = csHonora AND psPlaHon = csHonora)
                               )
                           AND SIRASGN_PIDM              = pnPidm
                           AND SSRMEET_TERM_CODE         = psTerm
                      ) SSRMEE,
                      (SELECT A.SIRDPCL_PIDM      dpclPidm,
                              A.SIRDPCL_COLL_CODE collCode
                         FROM SIRDPCL A
                        WHERE A.SIRDPCL_HOME_IND      = 'Y'
                          AND A.SIRDPCL_TERM_CODE_EFF = (SELECT MAX(SI.SIRDPCL_TERM_CODE_EFF)
                                                           FROM SIRDPCL SI
                                                          WHERE SI.SIRDPCL_PIDM           =  pnPidm
                                                            AND (SI.SIRDPCL_TERM_CODE_EFF <= psTerm OR psTerm IS NULL)
                                                        )
                          AND A.SIRDPCL_PIDM          = pnPidm
                      ) SIRDPC
                WHERE SSBSECT_SUBJ_CODE     = SCBCRSE_SUBJ_CODE
                  AND SSBSECT_CRSE_NUMB     = SCBCRSE_CRSE_NUMB
                  AND SCBCRSE_EFF_TERM      = (SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                                 FROM SCBCRSE SC
                                                WHERE SC.SCBCRSE_EFF_TERM <= SSBSECT_TERM_CODE
                                                  AND SC.SCBCRSE_SUBJ_CODE = SSBSECT_SUBJ_CODE
                                                  AND SC.SCBCRSE_CRSE_NUMB = SSBSECT_CRSE_NUMB
                                              )
                  AND SSBSECT_TERM_CODE     = SSRMEE.termCode
                  AND SSBSECT_CRN           = SSRMEE.asgnCrnn
                  AND SIRDPC.dpclPidm       = SSRMEE.asgnPidm
                  AND SSBSECT_TERM_CODE = psTerm
                  AND SSBSECT_PTRM_CODE = psPtrm
                  AND SIRDPC.collCode   = psEscu
                  AND SSRMEE.fstpCode   = psTipo
                  AND SSRMEE.asgnPidm   = pnPidm
               ) SSBSEC,
               SWRXLST,
               SSRXLST,
               SSBXLST
         WHERE SSBSEC.asgnPidm     = pnPidm
           AND SSBSEC.termCode     = SSRXLST_TERM_CODE(+)
           AND SSBSEC.sectCrnn     = SSRXLST_CRN(+)
           AND SSRXLST_TERM_CODE   = SWRXLST_TERM_CODE(+)
           AND SSRXLST_CRN         = SWRXLST_CRN(+)
           AND SSRXLST_XLST_GROUP  = SWRXLST_XLST_GROUP(+)
           AND SSRXLST_TERM_CODE   = SSBXLST_TERM_CODE(+)
           AND SSRXLST_XLST_GROUP  = SSBXLST_XLST_GROUP(+)
         ORDER BY collCode,
                  sectCrnn;

  begin
      vnExists := 0;

      if psStilos is null then
         stilos('Funciones de docencia');
      end if;

      htp.p('<table border="1" bordercolor="#DDDDDD" bgcolor="#FFFFFF" width="100%" cellpadding="1" cellspacing="0">
                    <tr><th colspan="19" style="border-top:none;border-bottom:none;border-left:none;border-right:none;">
                               Funciones de docencia
                        </th></tr>'
      );

      htp.p('<tr>
      <th align="left" >NRC</th>
      <th align="left" >Materia</th>
      <th align="left" >Curso</th>
      <th align="left" >Escuela curso</th>
      <th align="left" >Horas semanales</th>
      <th align="left" >Lu</th>
      <th align="left" >Ma</th>
      <th align="left" >Mi</th>
      <th align="left" >Ju</th>
      <th align="left" >Vi</th>
      <th align="left" >Sa</th>
      <th align="left" >Sesi&oacute;n</th>
      <th align="left" >Parte del periodo</th>
      <th align="left" >Hora inicio</th>
      <th align="left" >Hora fin</th>
      <th align="left" >Status</th>
      <th align="left" >Lista cruzada</th>
      <th align="left" >Tipo de curso</th>
      <th align="left" >Inscritos</th>
      <th align="left" >Porcentaje de responsabilidad</th>
      </tr>');

      for regRep in cuReporte loop
          htp.p(
          '<tr><td valign="top" align="left">'  ||regRep.sectCrnn||'</td>
               <td valign="top" align="left">'  ||regRep.subjCode||'</td>
               <td valign="top" align="left">'  ||regRep.crseNumb||'</td>
               <td valign="top" align="left">'  ||regRep.collCode||'</td>
               <td valign="top" align="left">'  ||regRep.horsWeek||'</td>
               <td valign="top" align="center">'||regRep.Lu      ||'</td>
               <td valign="top" align="center">'||regRep.Ma      ||'</td>
               <td valign="top" align="center">'||regRep.Mi      ||'</td>
               <td valign="top" align="center">'||regRep.Ju      ||'</td>
               <td valign="top" align="center">'||regRep.Vi      ||'</td>
               <td valign="top" align="center">'||regRep.Sa      ||'</td>
               <td valign="top" align="left">'  ||regRep.categor ||'</td>
               <td valign="top" align="left">'  ||regRep.ptrmCode||'</td>
               <td valign="top" align="center">'||regRep.begTime ||'</td>
               <td valign="top" align="center">'||regRep.endTime ||'</td>
               <td valign="top" align="left">'  ||regRep.sstsCode||'</td>
               <td valign="top" align="left">'  ||regRep.xlstGrop||'</td>
               <td valign="top" align="left">'  ||regRep.xlstType||'</td>
               <td valign="top" align="left">'  ||regRep.sectEnrl||'</td>
               <td valign="top" align="left">'  ||regRep.asgnPerc||'</td>
               </tr>'
          );

          vnExists := 1;

      end loop;

      if vnExists = 0 then
         htp.p('<tr><th colspan="19"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      end if;

      htp.p('</table>');

      if psStilos is null then
         htp.p('</body></html>');
      end if;

      vnExists := 0;

  exception
      when others then
           htp.p(sqlerrm);
  end horario;

  --el procedimiento presenta una ventana para mostrar la informacin de los cursos
  procedure funcion(psStilos varchar2 default null
                   ) IS

  --  Para obtener funciones de no docencia
  cursor cuReporte is
         SELECT SIRNIST_NIST_CODE                       nistCode,
                Pk_Catalogo.FUNCION(SIRNIST_NIST_CODE)  nistDesc,
                SIRNIST_TOPS_CODE                       topsCode,
                SUM(NVL(SIRNIST_NIST_WORKLOAD,0))       nistwork
           FROM SIRNIST
          WHERE SIRNIST_TERM_CODE    = psTerm
            AND SIRNIST_PIDM         = pnPidm
          GROUP BY SIRNIST_NIST_CODE,
                   SIRNIST_TOPS_CODE;

  begin
      vnExists := 0;

      if psStilos is null then
         stilos('Funciones de no docencia');
      end if;

      htp.p(
      '<table border="1" bordercolor="#DDDDDD" width="100%" bgcolor="#FFFFFF" cellpadding="1" cellspacing="0">
              <tr><th colspan="4" style="border-top:none;border-bottom:none;border-left:none;border-right:none;">
                      Funciones de no docencia
                      </th></tr>
              <tr bgcolor="#FFFFFF">
                  <th align="left" >Clave</th>
                  <th align="left" >Descripci&oacute;n</th>
                  <th align="left" >TOPS</th>
                  <th align="left" >Horas asignadas</th>
                  </tr>'
      );

      for regRep in cuReporte loop
          htp.p(
          '<tr><td valign="top">'||regRep.nistCode||'</td>
               <td valign="top">'||regRep.nistDesc||'</td>
               <td valign="top">'||regRep.topsCode||'</td>
               <td valign="top">'||regRep.nistwork||'</td></tr>'
          );

          vnExists := 1;

      end loop;

      if vnExists = 0 then
         htp.p('<tr><th colspan="4"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      end if;

      htp.p('</table>');

      if psStilos is null then
         htp.p('</body></html>');
      end if;

      vnExists := 0;
  exception
      when others then
           htp.p(sqlerrm);

  end funcion;

  --el procedimiento presenta una ventana para mostrar la informacin de los cursos
  procedure docente is

  vnColumnas integer := 4;
  vsSeccion  VARCHAR2(3)            := NULL;

  cursor cuReporte IS
         SELECT SPRIDEN_ID                                      idenIDdd,
                REPLACE(REPLACE(SPRIDEN_LAST_NAME||' '||
                SPRIDEN_FIRST_NAME||' '||
                SPRIDEN_MI,'','&ntilde;'),'*',' ')             idenName,
                (SELECT A.SIBINST_FSTP_CODE
                   FROM SIBINST A
                  WHERE A.SIBINST_TERM_CODE_EFF = (SELECT MAX(B.SIBINST_TERM_CODE_EFF)
                                                     FROM SIBINST B
                                                    WHERE B.SIBINST_PIDM           =  pnPidm
                                                      AND B.SIBINST_TERM_CODE_EFF <= psTerm
                                                  )
                    AND A.SIBINST_PIDM          = pnPidm
                ) fstpcode,
                (SELECT C.SIRDPCL_COLL_CODE
                   FROM SIRDPCL C
                  WHERE C.SIRDPCL_HOME_IND      = 'Y'
                    AND C.SIRDPCL_TERM_CODE_EFF = (SELECT MAX(D.SIRDPCL_TERM_CODE_EFF)
                                                     FROM SIRDPCL D
                                                    WHERE D.SIRDPCL_PIDM           = pnPidm
                                                      AND D.SIRDPCL_TERM_CODE_EFF <= psTerm
                                                  )
                    AND C.SIRDPCL_PIDM          = pnPidm
                ) collCode
           FROM SPRIDEN
          WHERE SPRIDEN_CHANGE_IND IS NULL
            AND SPRIDEN_PIDM        = pnPidm;

  BEGIN
      -- Las instrucciones determinan el largo de la tabla
      for vnI in 1..vnColumnas loop
          tabColumna.extend(vnI);
          tabColumna(vnI) := null;
      end loop;

      tabColumna(1)  := 'ID';
      tabColumna(2)  := 'Docente';
      tabColumna(3)  := 'Tipo docente';
      tabColumna(4)  := 'Escuela';

      for regRep in cuReporte loop
          Pk_Sisrepimp.P_EncabezadoDeReporte('Reporte de horarios de docentes de planta', vnColumnas,tabColumna,vsInicoPag,'1', psSubtitulo=>'Periodo '||psTerm, psUsuario=>psUser, psSeccion=>vsSeccion, psSinPiePag=>'S',psSinLogo=>'L',psTituloSinFr=>'F');
          vsInicoPag := 'SALTO';

         htp.p(
         '<tr><td valign="top">'||regRep.idenIDdd||'</td>
              <td valign="top">'||regRep.idenName||'</td>
              <td valign="top">'||regRep.fstpcode||'</td>
              <td valign="top">'||regRep.collCode||'</td></tr>'||
         '<tr><td colspan="'||vnColumnas||'" style="border-top:none;border-bottom:none;border-left:none;border-right:none;"></td></tr>'||
         '<tr><td colspan="'||vnColumnas||'" style="border-top:none;border-bottom:none;border-left:none;border-right:none;">'
         );

         horario('a');

         htp.p('</td></tr>
         <tr><td colspan="'||vnColumnas||'" style="border-top:none;border-bottom:none;border-left:none;border-right:none;"></td></tr>
         <tr><td colspan="'||vnColumnas||'" style="border-top:none;border-bottom:none;border-left:none;border-right:none;">'
         );

         funcion('a');

         htp.p('</td></tr>');

         vnExists := 1;
      end loop;

      if vnExists = 0 then
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      end if;

      htp.p('</table></body></html>');

  exception
      when others then htp.p( sqlerrm);
  end docente;

  BEGIN
      IF    psType = 'D' THEN
            docente;

            RETURN;
      ELSIF psType = 'F' THEN
            funcion;

            RETURN;
      ELSIF psType = 'H' THEN
            horario;

            RETURN;
      END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      vsPerio   := pk_objhtml.getValueCookie('psPeriM');
      vsFacu    := pk_objhtml.getValueCookie('psFacu');
      vsCate    := pk_objhtml.getValueCookie('psCate');
      vsTipo    := pk_objhtml.getValueCookie('psTipoN');
      vsPtrm    := pk_objhtml.getValueCookie('psPtrm');
      vsSeccion := pk_objhtml.getValueCookie('cookSeccion');

      htp.p('<script language="JavaScript"><!--');
      --fIniciarVentana
      htp.p('function fIniciarVentana(){
      frmLovFun = window.open("","winFunciones","toolbar=no,menubar=no,directories=no,status=no,resizable=no,location=no,scrollbars=no,width=0,height=0");

      frmLovFun.close();
      }//fIniciarVentana');

      --fMuestraDiv
      htp.p('function fMuestraDiv(pnRow,psTipoDetalle){

      var vsTerm = eval("document.frmHoras.termCode" + pnRow + ".value");
      var vsEscu = eval("document.frmHoras.collCode" + pnRow + ".value");
      var vsTipo = eval("document.frmHoras.fstpCode" + pnRow + ".value");
      var vnPidm = eval("document.frmHoras.asgnPidm" + pnRow + ".value");
      var vsPtrm = eval("document.frmHoras.ptrmCode" + pnRow + ".value");

      document.frmInforma.psTerm.value = vsTerm;
      document.frmInforma.psEscu.value = vsEscu;
      document.frmInforma.psTipo.value = vsTipo;
      document.frmInforma.pnPidm.value = vnPidm;
      document.frmInforma.psPtrm.value = vsPtrm;
      document.frmInforma.psType.value = psTipoDetalle;

      frmLovFun.close();

      frmLovFun = window.open("","winFunciones","toolbar=no,menubar=no,directories=no,status=no,resizable=yes,location=no,scrollbars=yes,width=300,height=250");

      if (frmLovFun.opener == null) {
          frmLovFun.opener = self;
      }

      window.status = "";
      frmLovFun.moveTo(0,0);
      frmLovFun.resizeTo(600,550);

      setTimeout("frmSubmit()",1000);

      }//fMuestraDiv');

      --frmSubmit
      htp.p('function frmSubmit() {
      document.frmInforma.submit();
      } //frmSubmit');
      htp.p('//--></script>');

      htp.p('</haed><body bgcolor="#ffffff" onLoad="fIniciarVentana();">');

      -- Las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1) := 'Escuela sede';
      tabColumna(2) := 'ID';
      tabColumna(3) := 'Docente';
      tabColumna(4) := 'Tipo docente';
      tabColumna(5) := 'Total de horas de docencia';
      tabColumna(6) := 'Total funciones de no docencia';
      tabColumna(7) := 'Total horas docente';

      htp.p('<form name="frmHoras" onSubmit="return false;">');

      WHILE INSTR(vsPerio, '/') > 0  LOOP
            FOR regRep IN cuReporte(SUBSTR(vsPerio, 1, INSTR(vsPerio,'/')-1), vsFacu, vsCate, vsTipo, vsPtrm) LOOP
                IF vsTermCode IS NULL OR regRep.termCode <> vsTermCode OR
                   vsCampCode IS NULL OR regRep.campCode <> vsCampCode THEN

                   Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicoPag,'1',psSubtitulo=>'Periodo '||regRep.termCode,psUsuario=>psUser,psSeccion=>vsSeccion, psSinPiePag=>'S',psSinLogo=>'L',psTituloSinFr=>'F');
                   vsInicoPag := 'SALTO';
                END IF;

                htp.p('<tr>'||
                '<td valign="top">'||regRep.collDesc||'</td>'||
                '<td valign="top">'||regRep.idenIDdd||'</td>'||
                '<td valign="top"><a href="javascript:fMuestraDiv('||vnRow||',''D'');">'||regRep.idenName||'</a></td>'||
                '<td valign="top">'||regRep.fstpDesc||'</td>'||
                '<td valign="top"><a href="javascript:fMuestraDiv('||vnRow||',''H'');">'||regRep.horsWeek||'</a></td>'||
                '<td valign="top"><a href="javascript:fMuestraDiv('||vnRow||',''F'');">'||regRep.nistWork||'</a></td>'||
                '<td valign="top">'||regRep.totlWork||
                '<input type="hidden" name="termCode'||vnRow||'" value="'||regRep.termCode||'" />'||
                '<input type="hidden" name="collCode'||vnRow||'" value="'||regRep.collCode||'" />'||
                '<input type="hidden" name="fstpCode'||vnRow||'" value="'||regRep.fstpCode||'" />'||
                '<input type="hidden" name="asgnPidm'||vnRow||'" value="'||regRep.asgnPidm||'" />'||
                '<input type="hidden" name="ptrmCode'||vnRow||'" value="'||regRep.ptrmCode||'" />'||
                '</td>'||
                '</tr>'
                );

                vnExists   := 1;
                vnRow      := vnRow + 1;
                vsCampCode := regRep.campCode;
                vsTermCode := regRep.termCode;
            END LOOP;

            vsPerio := SUBSTR(vsPerio, INSTR(vsPerio,'/')+1 );
      END LOOP ;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>psUser, psSeccion=>vsSeccion,psSinPiePag=>'S',psSinLogo=>'L',psTituloSinFr=>'F');

         htp.p(
         '</table>
         </form>
         <form name="frmInforma" action="'||psProceso||'" method="post" target="winFunciones">
         <input type="hidden" name="psReclDesc" value="'||psReclDesc||'" />
         <input type="hidden" name="psTerm" />
         <input type="hidden" name="psEscu" />
         <input type="hidden" name="psTipo" />
         <input type="hidden" name="pnPidm" />
         <input type="hidden" name="psPtrm" />
         <input type="hidden" name="psType" />
         <input type="hidden" name="psUser"   value="'||psUser  ||'" />
         <input type="hidden" name="psPlaHon" value="'||psPlaHon||'" />
         </form>'
         );
      END IF;

      htp.p('<br/><br/></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
          htp.p( SQLERRM);
  END PWRHRAS;
/


DROP PUBLIC SYNONYM PWRHRAS;

CREATE PUBLIC SYNONYM PWRHRAS FOR BANINST1.PWRHRAS;
DROP PROCEDURE BANINST1.PWRIDSE;

CREATE OR REPLACE PROCEDURE BANINST1.PWRIDSE (psReclDesc    VARCHAR2)  IS

/**************************************************************
           tarea:  procedimiento que genera el reporte
                   de ingresados segn datos socioeconmicos
          mdulo:  admisiones
           autor:  horacio martnez ramrez - hmr
           fecha:  02/mar/2011
**************************************************************/

  vnExists       INTEGER := 0;
  vnColumnas     INTEGER := 11;
  vgsInicioPag   VARCHAR2(30) := NULL;           -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vnIdRenglon    INTEGER := 1;
  vsTerm         SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsProgr        SARADAP.SARADAP_PROGRAM_1%TYPE DEFAULT NULL;
  vsTipoA         VARCHAR2(5);
  vsEdadProm     VARCHAR2(25) := 0;
  vnValorMax     NUMBER := 0;


  CURSOR cuReporte ( psTerm    VARCHAR2  DEFAULT NULL,
                     psProgr   VARCHAR2  DEFAULT NULL,
                     psTipoA   VARCHAR2  DEFAULT NULL )  IS

     SELECT SR.SORLCUR_PROGRAM                                                            CARRERA,
            (SELECT COUNT(DISTINCT(SORLCUR_PIDM))
               FROM SORLCUR
              WHERE SORLCUR_TERM_CODE = SR.SORLCUR_TERM_CODE
                AND SORLCUR_TERM_CODE = SORLCUR_TERM_CODE_ADMIT
                AND SORLCUR_PROGRAM = SR.SORLCUR_PROGRAM
                AND (SORLCUR_ADMT_CODE = psTipoA OR psTipoA IS NULL)
                AND SORLCUR_CACT_CODE = 'ACTIVE' )                                        TOTAL_ING,
            (SELECT COUNT(DISTINCT(SORLCUR_PIDM)) FROM SPBPERS, SORLCUR
              WHERE SPBPERS_SEX = 'F'
                AND SPBPERS_PIDM = SORLCUR_PIDM
                AND SORLCUR_TERM_CODE = SR.SORLCUR_TERM_CODE
                AND SORLCUR_TERM_CODE = SORLCUR_TERM_CODE_ADMIT
                AND SORLCUR_PROGRAM = SR.SORLCUR_PROGRAM
                AND (SORLCUR_ADMT_CODE = psTipoA OR psTipoA IS NULL)
                AND SORLCUR_CACT_CODE = 'ACTIVE')                                         FEMENINO,
            (SELECT COUNT(DISTINCT(SORLCUR_PIDM)) FROM SPBPERS, SORLCUR
              WHERE SPBPERS_SEX = 'M'
                AND SPBPERS_PIDM = SORLCUR_PIDM
                AND SORLCUR_TERM_CODE = SR.SORLCUR_TERM_CODE
                AND SORLCUR_TERM_CODE = SORLCUR_TERM_CODE_ADMIT
                AND SORLCUR_PROGRAM = SR.SORLCUR_PROGRAM
                AND (SORLCUR_ADMT_CODE = psTipoA OR psTipoA IS NULL)
                AND SORLCUR_CACT_CODE = 'ACTIVE' )                                        MASCULINO,
--            (select count(distinct(sorlcur_pidm)) from spbpers, sorlcur
--              where spbpers_sex = 'n'
--                and spbpers_pidm = sorlcur_pidm
--                and sorlcur_term_code = sr.sorlcur_term_code
--                and sorlcur_term_code = sorlcur_term_code_admit
--                and sorlcur_program = sr.sorlcur_program
--                and (sorlcur_admt_code = pstipoa or pstipoa is null)
--                and sorlcur_cact_code = 'active')                                         no_definido,
--            (select count(distinct(sorlcur_pidm)) from spbpers, sorlcur
--              where spbpers_sex is null
--                and spbpers_pidm = sorlcur_pidm
--                and sorlcur_term_code = sr.sorlcur_term_code
--                and sorlcur_term_code = sorlcur_term_code_admit
--                and sorlcur_program = sr.sorlcur_program
--                and (sorlcur_admt_code = pstipoa or pstipoa is null)
--                and sorlcur_cact_code = 'active')                                         campo_null,
            (SELECT COUNT(DISTINCT(SORLCUR_PIDM)) FROM SPRADDR, SORLCUR
              WHERE SPRADDR_NATN_CODE = 39
                AND SPRADDR_PIDM = SORLCUR_PIDM
                AND SORLCUR_TERM_CODE = SR.SORLCUR_TERM_CODE
                AND SORLCUR_TERM_CODE = SORLCUR_TERM_CODE_ADMIT
                AND SORLCUR_PROGRAM = SR.SORLCUR_PROGRAM
                AND (SORLCUR_ADMT_CODE = psTipoA OR psTipoA IS NULL)
                AND SORLCUR_CACT_CODE = 'ACTIVE')                                         NAC_CHILENA,
            (SELECT COUNT(DISTINCT(SORLCUR_PIDM)) FROM SPRADDR, SORLCUR
              WHERE SPRADDR_NATN_CODE <> 39
                AND SPRADDR_PIDM = SORLCUR_PIDM
                AND SORLCUR_TERM_CODE = SR.SORLCUR_TERM_CODE
                AND SORLCUR_TERM_CODE = SORLCUR_TERM_CODE_ADMIT
                AND SORLCUR_PROGRAM = SR.SORLCUR_PROGRAM
                AND (SORLCUR_ADMT_CODE = psTipoA OR psTipoA IS NULL)
                AND SORLCUR_CACT_CODE = 'ACTIVE')                                         NAC_EXTRANJERA,
--            (select count(distinct(sorlcur_pidm)) from spraddr, sorlcur
--              where spraddr_natn_code is null
--                and spraddr_pidm = sorlcur_pidm
--                and sorlcur_term_code = sr.sorlcur_term_code
--                and sorlcur_term_code = sorlcur_term_code_admit
--                and sorlcur_program = sr.sorlcur_program
--                and (sorlcur_admt_code = pstipoa or pstipoa is null)
--                and sorlcur_cact_code = 'active')                                         nacional_null,
            (SELECT COUNT(DISTINCT(SORLCUR_PIDM)) FROM SPBPERS, SORLCUR
              WHERE SPBPERS_PIDM = SORLCUR_PIDM
                AND TRUNC(((SYSDATE-SPBPERS_BIRTH_DATE)/365),0) < 18
                AND SORLCUR_TERM_CODE = SR.SORLCUR_TERM_CODE
                AND SORLCUR_TERM_CODE = SORLCUR_TERM_CODE_ADMIT
                AND SORLCUR_PROGRAM = SR.SORLCUR_PROGRAM
                AND (SORLCUR_ADMT_CODE = psTipoA OR psTipoA IS NULL)
                AND SORLCUR_CACT_CODE = 'ACTIVE')                                         MENORES_18,
            (SELECT COUNT(DISTINCT(SORLCUR_PIDM)) FROM SPBPERS, SORLCUR
              WHERE SPBPERS_PIDM = SORLCUR_PIDM
                AND TRUNC(((SYSDATE-SPBPERS_BIRTH_DATE)/365),0) >= 18
                AND TRUNC(((SYSDATE-SPBPERS_BIRTH_DATE)/365),0) < 21
                AND SORLCUR_TERM_CODE = SR.SORLCUR_TERM_CODE
                AND SORLCUR_TERM_CODE = SORLCUR_TERM_CODE_ADMIT
                AND SORLCUR_PROGRAM = SR.SORLCUR_PROGRAM
                AND (SORLCUR_ADMT_CODE = psTipoA OR psTipoA IS NULL)
                AND SORLCUR_CACT_CODE = 'ACTIVE')                                         DE18_MENORES21,
            (SELECT COUNT(DISTINCT(SORLCUR_PIDM)) FROM SPBPERS, SORLCUR
              WHERE SPBPERS_PIDM = SORLCUR_PIDM
                AND TRUNC(((SYSDATE-SPBPERS_BIRTH_DATE)/365),0) >= 21
                AND TRUNC(((SYSDATE-SPBPERS_BIRTH_DATE)/365),0) < 25
                AND SORLCUR_TERM_CODE = SR.SORLCUR_TERM_CODE
                AND SORLCUR_TERM_CODE = SORLCUR_TERM_CODE_ADMIT
                AND SORLCUR_PROGRAM = SR.SORLCUR_PROGRAM
                AND (SORLCUR_ADMT_CODE = psTipoA OR psTipoA IS NULL)
                AND SORLCUR_CACT_CODE = 'ACTIVE')                                         DE21_MENORES25,
            (SELECT COUNT(DISTINCT(SORLCUR_PIDM)) FROM SPBPERS, SORLCUR
              WHERE SPBPERS_PIDM = SORLCUR_PIDM
                AND TRUNC(((SYSDATE-SPBPERS_BIRTH_DATE)/365),0) >= 25
                AND SORLCUR_TERM_CODE = SR.SORLCUR_TERM_CODE
                AND SORLCUR_TERM_CODE = SORLCUR_TERM_CODE_ADMIT
                AND SORLCUR_PROGRAM = SR.SORLCUR_PROGRAM
                AND (SORLCUR_ADMT_CODE = psTipoA OR psTipoA IS NULL)
                AND SORLCUR_CACT_CODE = 'ACTIVE')                                         MAYORES_25
       FROM SORLCUR SR
      WHERE SR.SORLCUR_TERM_CODE = psterm
        AND SR.SORLCUR_TERM_CODE = SR.SORLCUR_TERM_CODE_ADMIT
        AND SR.SORLCUR_CACT_CODE = 'ACTIVE'
        AND (SR.SORLCUR_PROGRAM = psProgr OR psProgr IS NULL)
        AND (SR.SORLCUR_ADMT_CODE = psTipoA OR psTipoA IS NULL)
      GROUP BY SR.SORLCUR_PROGRAM, SR.SORLCUR_TERM_CODE
      ORDER BY SR.SORLCUR_PROGRAM;


  BEGIN

     -- valida que el usuario pertenezca a la base de datos:
     IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

     -- son buscados los valores de las cookies para asignar los valores del filtro del query:
     vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
     vsProgr := pk_ObjHtml.getValueCookie('psProgr');
     vsTipoA := pk_ObjHtml.getValueCookie('psTipoA');

     -- se determina el largo de la tabla:
     FOR vnI IN 1..vnColumnas LOOP
         tabColumna.EXTEND(vnI);
         tabColumna(vnI) := NULL;
     END LOOP;

     tabColumna(1)  := '<center> Carrera';
     tabColumna(2)  := '<center> Total ingresados';
     tabColumna(3)  := '<center> Sexo <br> femenino';
     tabColumna(4)  := '<center> Sexo <br> masculino';
     tabColumna(5)  := '<center> Nacionalidad <br> chilena';
     tabColumna(6)  := '<center> Nacionalidad <br> extranjera';
     tabColumna(7)  := '<center> Edad <br> menores de 18';
     tabColumna(8)  := '<center> Edad <br> de 18 y menores de 21';
     tabColumna(9)  := '<center> Edad <br> de 21 y menores de 25';
     tabColumna(10) := '<center> Edad <br> de 25 y mayores de 25';
     tabColumna(11) := '<center> Edad promedio';


     FOR regRep IN cuReporte (vsTerm, vsProgr, vsTipoA) LOOP

         IF vnExists = 0 THEN

            -- selecciona encabezado segn tipo de admisin:
            IF vsTipoA IS NOT NULL THEN
               Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||', &nbsp&nbsp&nbsp'||'Tipo de admisin: '||vsTipoA||' - '||Pk_Catalogo.Admision(vsTipoA), psUniversidad=>'UFT');
            ELSE
               Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||', &nbsp&nbsp&nbsp'||'Tipo de admisin: '||'Todos', psUniversidad=>'UFT');
            END IF;

            vgsInicioPag := 'SALTO';
         END IF;

         -- funcin que obtiene el valor mayor de entre cuatro cantidades:
         SELECT F_VALMAYOR4 (regRep.MENORES_18, regRep.DE18_MENORES21, regRep.DE21_MENORES25, regRep.MAYORES_25)
           INTO vnValorMax
           FROM DUAL;

         IF vnValorMax = regRep.MENORES_18 THEN
            IF vnValorMax = 0 THEN
               vsEdadProm := '- - - - - - - - -';
            ELSE
               vsEdadProm := 'menor de 18';
            END IF;
         ELSIF vnValorMax = regRep.DE18_MENORES21 THEN
               vsEdadProm := 'de 18 y menores de 21';
         ELSIF vnValorMax = regRep.DE21_MENORES25 THEN
               vsEdadProm := 'de 21 y menores de 25';
         ELSIF vnValorMax = regRep.MAYORES_25 THEN
               vsEdadProm := 'de 25 y mayores de 25';
         END IF;

         HTP.P('<tr> <td valign="top" align="left">'   ||regRep.CARRERA         ||'</td>
                     <td valign="top" align="center">' ||regRep.TOTAL_ING       ||'</td>
                     <td valign="top" align="center">' ||regRep.FEMENINO        ||'</td>
                     <td valign="top" align="center">' ||regRep.MASCULINO       ||'</td>
                     <td valign="top" align="center">' ||regRep.NAC_CHILENA     ||'</td>
                     <td valign="top" align="center">' ||regRep.NAC_EXTRANJERA  ||'</td>
                     <td valign="top" align="center">' ||regRep.MENORES_18      ||'</td>
                     <td valign="top" align="center">' ||regRep.DE18_MENORES21  ||'</td>
                     <td valign="top" align="center">' ||regRep.DE21_MENORES25  ||'</td>
                     <td valign="top" align="center">' ||regRep.MAYORES_25      ||'</td>
                     <td valign="top" align="center">' ||vsEdadProm             ||'</td>
               </tr>');

         vnExists := 1;
         vnIdRenglon := vnIdRenglon + 1;

     END LOOP;

     IF vnExists = 0 THEN
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
     ELSE
        -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pgina:
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR);
     END IF;

     htp.p('</table><br/></body></html>');

  EXCEPTION
     WHEN OTHERS THEN
          htp.p(SQLERRM);

  END PWRIDSE;
/


DROP PUBLIC SYNONYM PWRIDSE;

CREATE PUBLIC SYNONYM PWRIDSE FOR BANINST1.PWRIDSE;


GRANT EXECUTE ON BANINST1.PWRIDSE TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRIDSE TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRINCR;

CREATE OR REPLACE PROCEDURE BANINST1.PWRINCR(psReclDesc VARCHAR2) IS

/**************************************************************
           tarea:  presentar la cantidad de profesores que no han capturado
                      criterios de evaluacin
         mdulo:  consulta al registro de calificaciones
           autor:  horacio martnez ramrez - hmr
           fecha:  12/oct/2010
**************************************************************/

  vsPeriodoDesc   STVTERM.STVTERM_DESC%TYPE := NULL;
  vsEscuelaDesc   STVCOLL.STVCOLL_DESC%TYPE := NULL;
  vnTotalM        NUMBER                    := 0;
  vnTotalC        NUMBER                    := 0;
  vnTotalCno      NUMBER                    := 0;
  vnPorcentajeP   NUMBER                    := 0;
  vsCamp          VARCHAR2(6)               := NULL;
  vsSede          VARCHAR2(10)              := NULL;
  vsTerm          VARCHAR2(10)              := NULL;
  vsColl          VARCHAR2(10)              := NULL;

  CURSOR cuProfesore IS
         SELECT FWRSIRG_DEPT_CODE            AS deptCode,
                FWRSIRG_COLL_CODE            AS collCode,
                COUNT(DISTINCT FWRSIRG_PIDM) AS sirgPidm,
                (SELECT COUNT(DISTINCT A.FWRSIRG_PIDM)
                   FROM FWRSIRG A
                  WHERE A.FWRSIRG_DEPT_CODE = B.FWRSIRG_DEPT_CODE
                    AND A.FWRSIRG_COLL_CODE = B.FWRSIRG_COLL_CODE
                    AND EXISTS (SELECT NULL
                                  FROM SHRGCOM
                                 WHERE SHRGCOM_TERM_CODE = A.FWRSIRG_TERM_CODE
                                   AND SHRGCOM_CRN       = A.FWRSIRG_CRN
                               )
                ) AS ysGcom,
                (SELECT COUNT(DISTINCT C.FWRSIRG_PIDM)
                   FROM FWRSIRG C
                  WHERE C.FWRSIRG_DEPT_CODE = B.FWRSIRG_DEPT_CODE
                    AND C.FWRSIRG_COLL_CODE = B.FWRSIRG_COLL_CODE
                    AND NOT EXISTS (SELECT NULL
                                      FROM SHRGCOM
                                     WHERE SHRGCOM_TERM_CODE = C.FWRSIRG_TERM_CODE
                                       AND SHRGCOM_CRN       = C.FWRSIRG_CRN
                                   )
                ) AS noGcom
           FROM FWRSIRG B
          GROUP BY FWRSIRG_DEPT_CODE,
                   FWRSIRG_COLL_CODE
          ORDER BY FWRSIRG_DEPT_CODE,
                   FWRSIRG_COLL_CODE;

  BEGIN
      -- valida que el usuario pertenezca a la base de datos.
      IF PK_Login.F_ValidacionDeAcceso(PK_Login.vgsUSR) THEN RETURN; END IF;

      vsCamp := pk_objHtml.getValueCookie('psUnive');
      vsTerm := pk_objHtml.getValueCookie('psPerio');
      vsColl := pk_objHtml.getValueCookie('psEscu');
      vsSede := pk_objHtml.getValueCookie('psDept');

      PWAINGD(vsCamp, vsTerm, vsColl, vsSede);

      vsPeriodoDesc := pk_Catalogo.Periodo(vsTerm);

      htp.p('<html><head><title>&nbsp;</title>');

      -- la aplicaci&oacute;n no se guarda en el cache de la maquina.
      pk_objHtml.P_NoCache;

      --c&oacute;digo css
      pk_objHtml.P_CssTabs;

      htp.p('<script language="JavaScript"><!--');

      --fejecuta
      htp.p('function fEjecuta(psCOLL,pnVAL,psSede) {
               document.frmAction.psColl.value = psCOLL;
               document.frmAction.psSede.value = psSede;

               if(pnVAL == 1) {
                   document.frmAction.action = "pk_RegCaliModalidad.P_SiIngresoCriterios";
                   } else {
                            document.frmAction.action = "pk_RegCaliModalidad.P_NoIngresoCriterios";
                            }
                     document.frmAction.submit();
                   }'
               );

      --fimprimereporte
      htp.p('function fImprimeReporte() {
                window.focus();
                print();
               }'
              );

      htp.p('--></script>');

      htp.p('</head><body bgcolor="#ffffff">
             <table border="1" cellpadding="2" cellspacing="1" align="center" bordercolor="#cccccc">
             <tr><td rowspan="3" align="center" style="border-right:none;border-left:none;border-top:none;">
                   <img src="/imagenes/logouft.gif" hspace="0" vspace="0" border="0" height="40" width="40"></td>
                   <td bordercolor="#ffffff" align="left" colspan="4">
                     Profesores que han ingresado criterios de evaluaci&oacute;n</td></tr>
             <tr><td bordercolor="#ffffff" align="left"  colspan="4">
                     '||vsTerm||' '||vsPERIODODESC||'</td></tr>
             <tr><td style="border-right:none;border-left:none;" align="left"  colspan="4">
                     '||to_char(sysdate,'DD/MM/YYYY HH24:MI:SS')||'</td></tr>
             <tr bgcolor="#efefef">
                 <th align="center" style=''width:100px;''>
                     Sede</th>
                 <th align="center" style=''width:200px;''>
                     Escuela o Facultad</th>
                 <th align="center" style=''width:95px;''>
                     Maestros   </th>
                 <th align="center" style=''width:95px;''>
                     Ingres&oacute;<br />criterios</th>
                 <th align="center" style=''width:95px;''>
                     No ha<br />ingresado criterios</th>
                 <th align="center" style=''width:95px;''>
                     %<br />de profesores que ingresaron criterios</th></tr>
                     '
              );
              htp.p('<script language="javascript" src="kwacnls.js"></script>');

      FOR regPrf IN cuProfesore LOOP
          vnPorcentajeP := 0;
          vsEscuelaDesc := pk_catalogo.colegio(regPrf.collCode);

          IF regPrf.ysGcom <> 0 AND regPrf.sirgPidm <> 0 THEN
             vnPorcentajeP := ROUND((regPrf.ysGcom/regPrf.sirgPidm) * 100,2);
             --vnporcentajep := vnporcentajep;
          END IF;

          htp.p(
          '<tr>
          <td align="left">' ||NVL(pk_catalogo.fstvdept(regPrf.deptCode),'sin Sede')||'</td>
          <td align="left">' ||vsEscuelaDesc                                        ||'</td>
          <td align="right">'||regPrf.sirgPidm                                      ||'</td>
          <td align="right">
              <a href="javascript:fEjecuta('''||regPrf.collCode||''',1,'''||regPrf.deptCode||''');" onMouseOver="window.status='''||vsEscuelaDesc||' '||regPrf.ysGcom||'''; return true;" onMouseOut="window.status=''''; return true;">
              '||regPrf.ysGcom||'
              </a></td>
          <td align="right">
              <a href="javascript:fEjecuta('''||regPrf.collCode||''',2,'''||regPrf.deptCode||''');" onMouseOver="window.status='''||vsEscuelaDesc||' '||regPrf.noGcom||'''; return true;" onMouseOut="window.status=''''; return true;">
              '||regPrf.noGcom||'
              </a></td>
          <td align="right">'||vnPorcentajeP||'%</td>
          </tr>'
          );

         vnTotalCno := vnTotalCno + regPrf.noGcom;
         vnTotalM   := vnTotalM   + regPrf.sirgPidm;
         vnTotalC   := vnTotalC   + regPrf.ysGcom;
      END LOOP;

      vnPorcentajeP := 0;

      IF vnTotalM <> 0 AND vnTotalC <> 0 THEN
         vnPorcentajeP := ROUND((vnTotalC/vnTotalM) * 100,2);
      END IF;

      htp.p( '<tr bgcolor="#efefef">
                <th align="center" colspan="2">Total</th>
                <th align="right">'||vnTotalM     ||'</th>
                <th align="right">'||vnTotalC     ||'</th>
                <th align="right">'||vnTotalCno   ||'</th>
                <th align="right">'||vnPorcentajeP||'%</th>
                </tr></table><br/>

                <form name="frmAction" method="post">
                <input type="hidden" name="psCamp" value="'||vsCamp||'">
                <input type="hidden" name="psTerm" value="'||vsTerm||'">
                <input type="hidden" name="psColl" >
                <input type="hidden" name="psSede" >
                </form>
                </html></body>'
              );

      ROLLBACK;

  END PWRINCR;
/


DROP PUBLIC SYNONYM PWRINCR;

CREATE PUBLIC SYNONYM PWRINCR FOR BANINST1.PWRINCR;


GRANT EXECUTE ON BANINST1.PWRINCR TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRINCR TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRINDR;

CREATE OR REPLACE PROCEDURE BANINST1.PWRINDR(psReclDesc VARCHAR2) IS

/**************************************************************
           tarea:  paquete para el reporte indicadores de rendimiento por curso
         mdulo:  registro estudiantil
           autor:  horacio martnez ramrez - hmr
           fecha:  09/sep/2010
**************************************************************/

  vnRow      INTEGER                := 0;
  vnExists   INTEGER                := 0;
  vnColumnas INTEGER                := 19;
  tabColumna Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vsInicoPag VARCHAR2(10)           := NULL;
  vsSeccion  VARCHAR2(3)            := NULL;
  vsTsscCode VARCHAR2(15)           := NULL;
  vsId       VARCHAR2(8)            := NULL;
  vsPromedio VARCHAR2(10)           := NULL;
  vsCampCode VARCHAR2(6)            := NULL;
  vsTermCode VARCHAR2(6)            := NULL;
  vsCollCode VARCHAR2(3)            := NULL;
  vsProgCode VARCHAR2(25)           := NULL;
  vsLevlCode VARCHAR2(2)            := NULL;
  vsCampCod2 VARCHAR2(6)            := NULL;
  vsTermCod2 VARCHAR2(6)            := NULL;
  vsLink     VARCHAR2(5000)         := NULL;
  vsEnca     VARCHAR2(5)            := NULL;
  vbEnca     BOOLEAN                := TRUE;

  csA     CONSTANT VARCHAR2(1) := 'A';
  csEsp   CONSTANT VARCHAR2(1) := ' ';
  csAC    CONSTANT VARCHAR2(2) := 'AC';
  csVGC   CONSTANT VARCHAR2(3) := 'VGC';
  csVGP   CONSTANT VARCHAR2(3) := 'VGP';
  csY     CONSTANT VARCHAR2(1) := 'Y';
  csL     CONSTANT VARCHAR2(1) := 'L';
  cs0_00  CONSTANT VARCHAR2(4) := '0.00';
  cs90_99 CONSTANT VARCHAR2(6) := '990.99';
  cs90_00 CONSTANT VARCHAR2(6) := '990.00';
  cn0     CONSTANT NUMBER(1)   := 0;
  cn1     CONSTANT NUMBER(1)   := 1;
  cn2     CONSTANT NUMBER(1)   := 2;
  cn10    CONSTANT NUMBER(2)   := 10;
  cn100   CONSTANT NUMBER(3)   := 100;

  CURSOR cuReporte IS
         SELECT SWRPGAC_CRN                                                 AS pgacCrnn,
                SWRPGAC_COLL_CODE                                           AS collCode,
                pk_Catalogo.colegio(SWRPGAC_COLL_CODE)                      AS collDesc,
                SWRPGAC_SUBJ_CODE                                           AS subjCode,
                SWRPGAC_CRSE_NUMB                                           AS crseNumb,
                SWRPGAC_TERM_CODE                                           AS termCode,
                SWRPGAC_CAMP_CODE                                           AS campCode,
                SWRPGAC_GMOD_CODE                                           AS gmodCode,
                SWRPGAC_TITLE                                               AS pgacTitl,
                F_GET_ID(FWRHORS_PIDM)                                 AS Id,
                pk_Catalogo.NOMBRE(FWRHORS_PIDM)                            AS factName,
                SPBPERS_NAME_SUFFIX                                             AS Rut,
                FWRHORS_PIDM                                                AS horsPidm,
                pk_Catalogo.Tipo(FWRHORS_FSTP_CODE)                         AS fstpCode,
                SWRSTC.pasedInd                                             AS pasedInd,
                SWRSTC.quality9                                             AS quality9,
                SWRSTC.qualityP                                             AS qualityP,
                SWRSTC.stcrInsc                                             AS stcrInsc,
                TO_CHAR((SWRSTC.pasedInd/SWRSTC.stcrInsc)*cn100,cs90_00)    AS psdIndPr,
                TO_CHAR((SWRSTC.quality9/SWRSTC.stcrInsc)*cn100,cs90_00)    AS qulty9Pr,
                TO_CHAR(ROUND(SWRSTC.qualityP/SWRSTC.stcrInsc,cn2),cs90_00) AS qualitPm,
                FWRXLST_XLST_GROUP                                          AS xlstGrop,
                NVL(FWRXLST_TYPE,'I')                                       AS xlstType,
                SWRPGAC_PTRM                                                AS ptrm
           FROM SWRPGAC,
                FWRHORS,
                (SELECT SWRSTCR_TERM_CODE           AS termCode,
                        SWRSTCR_CRN                 AS crnnCode,
                        SWRSTCR_LEVL_CODE           AS levlCode,
                        SUM(SWRSTCR_PASSED_IND)     AS pasedInd,
                        SUM(SWRSTCR_QUALITY)        AS quality9,
                        SUM(SWRSTCR_QUALITY_POINTS) AS qualityP,
                        COUNT(SWRSTCR_PIDM)         AS stcrInsc
                   FROM SWRSTCR
                 GROUP BY SWRSTCR_TERM_CODE,
                          SWRSTCR_CRN,
                          SWRSTCR_LEVL_CODE
                ) SWRSTC,
                FWRXLST,
                SPBPERS
          WHERE SWRPGAC_TERM_CODE = FWRHORS_TERM_CODE
            AND SWRPGAC_CRN       = FWRHORS_CRN
            AND SWRPGAC_TERM_CODE = SWRSTC.termCode
            AND SWRPGAC_CRN       = SWRSTC.crnnCode
            AND SWRPGAC_TERM_CODE = FWRXLST_TERM_CODE(+)
            AND SWRPGAC_CRN       = FWRXLST_CRN(+)
            AND FWRHORS_PIDM      = SPBPERS_PIDM(+)
         ORDER BY collDesc, subjCode, crseNumb;

  --la funcion retorna el promedio del seprad
  function promedioSeprad(psTerm     VARCHAR2,
                          pnCrn      NUMBER,
                          psCamp     VARCHAR2,
                          psColl     VARCHAR2,
                          pnPidm     NUMBER,
                          psTsscCode IN OUT VARCHAR2
                         ) return varchar2 is

  vsPromedio VARCHAR2(20) := cs0_00;

  begin
      select to_char(round(sum(swrsepr_media)/sum(decode(swrsepr_media,cn0,cn0,cn1)),cn2),cs90_99),
             swrsepr_tssc_code
        into vsPromedio,psTsscCode
        from swrsepr
       where swrsepr_term_code = psTerm
         and swrsepr_crn       = pnCrn
         and swrsepr_camp_code = psCamp
         and swrsepr_coll_code = psColl
         and swrsepr_pidm      = pnPidm
         and swrsepr_tipo_crn <> csL
         and swrsepr_teqa_code not in (csVGC,csVGP)
       group by swrsepr_tssc_code;

      return vsPromedio;

  exception
      when no_data_found then
           return vsPromedio;
  end promedioSeprad;

  procedure distribucion is

  begin
      htp.p('<script language="JavaScript"><!--');
      htp.p('function fMuestraDiv(psDesc, psUni, psTerm,psEscu,psCurso, psEncs, psPidm, psTipo, psPtrm){
      document.frmInforma.psReclDesc.value = psDesc;
      document.frmInforma.psCamp.value     = psUni;
      document.frmInforma.psTerm.value     = psTerm;
      document.frmInforma.psColl.value     = psEscu;
      document.frmInforma.psCrn.value      = psCurso;
      document.frmInforma.psEncs.value     = psEncs;
      document.frmInforma.pnPidm.value     = psPidm;
      document.frmInforma.psTipo.value     = psTipo;
      document.frmInforma.psPtrm.value     = psPtrm;

      frmLovFun = window.open("","winFunciones","toolbar=no,menubar=no,directories=no,status=no,resizable=yes,location=no,scrollbars=yes,width=300,height=250");

      if (frmLovFun.opener == null) {
      frmLovFun.opener = self;
      }

      window.status = "";
      frmLovFun.moveTo(0,0);
      setTimeout("fMuestraInf()",1000);

      }');

      htp.p('function fMuestraInf() {
      document.frmInforma.submit();
      }');

      htp.p('//--></script>

      <form name="frmInforma" action="PWRDFRE" method="get" target="winFunciones">
      <input type="hidden" name="psReclDesc"/>
      <input type="hidden" name="psSiu" value="" />
      <input type="hidden" name="psCamp" />
      <input type="hidden" name="psColl" />
      <input type="hidden" name="psTerm" />
      <input type="hidden" name="psCrn" />
      <input type="hidden" name="psEncs" />
      <input type="hidden" name="pnPidm" />
      <input type="hidden" name="psTipo" />
      <input type="hidden" name="psPtrm" />
      </form>

      ');
  end distribucion;


  procedure insertSIRASGN is

  begin
      insert into fwrhors
      (fwrhors_pidm, fwrhors_term_code, fwrhors_crn, fwrhors_fstp_code
       )
     select sirasgn_pidm,
            sirasgn_term_code,
            sirasgn_crn,
            (select a.sibinst_fstp_code
               from sibinst a
              where sibinst_term_code_eff = (select max(b.sibinst_term_code_eff)
                                               from sibinst b
                                              where b.sibinst_pidm           = sirasgn_pidm
                                                and b.sibinst_term_code_eff <= sirasgn_term_code
                                             )
                and a.sibinst_fcst_code = csAC
                and a.sibinst_pidm      = sirasgn_pidm
            )
       from sirasgn
      where (vsId is null or (exists (select null
                                        from spriden
                                       where spriden_change_ind is null
                                         and spriden_pidm        = sirasgn_pidm
                                         and spriden_id          = vsId
                                     )
                             )
            )
        and (sirasgn_crn,sirasgn_term_code) in (select swrpgac_crn,swrpgac_term_code
                                                  from swrpgac
                                               );

  end insertSIRASGN;

  procedure insertSSRXLST is

  begin
      insert into fwrxlst
      (fwrxlst_crn,fwrxlst_term_code,fwrxlst_xlst_group,fwrxlst_type)
      select ssrxlst_crn,
             ssrxlst_term_code,
             ssrxlst_xlst_group,
             (select swrxlst_type
                from swrxlst
               where swrxlst_term_code  = ssrxlst_term_code
                 and swrxlst_crn        = ssrxlst_crn
                 and swrxlst_xlst_group = ssrxlst_xlst_group
             )
        from ssrxlst
       where (ssrxlst_crn,ssrxlst_term_code) in (select swrpgac_crn,swrpgac_term_code
                                                   from swrpgac
                                                 );
  end insertSSRXLST;

  procedure insertSFRSTCR is

  begin
      insert into swrstcr
      (swrstcr_term_code, swrstcr_crn,     swrstcr_levl_code,
       swrstcr_passed_ind,swrstcr_quality, swrstcr_quality_points,
       swrstcr_pidm)
      select
       sfrstcr_term_code,sfrstcr_crn,sfrstcr_levl_code,
       decode(c.shrgrde_passed_ind,csY,cn0,cn1),
       decode(trunc((c.shrgrde_quality_points + cn1)/cn10),cn0,cn0,cn1),
       c.shrgrde_quality_points,
       sfrstcr_pidm
        from sfrstcr,
             sgbstdn a,
             shrgrde c
       where c.shrgrde_term_code_effective    = (select max(d.shrgrde_term_code_effective)
                                                   from shrgrde d
                                                  where d.shrgrde_code                = c.shrgrde_code
                                                    and d.shrgrde_levl_code           = c.shrgrde_levl_code
                                                    and d.shrgrde_term_code_effective <= sfrstcr_term_code
                                                )
         and sfrstcr_grde_code                = c.shrgrde_code
         and sfrstcr_levl_code                = c.shrgrde_levl_code
         and a.sgbstdn_term_code_eff          = (select max(b.sgbstdn_term_code_eff)
                                                   from sgbstdn b
                                                  where b.sgbstdn_pidm           = a.sgbstdn_pidm
                                                    and b.sgbstdn_term_code_eff <= sfrstcr_term_code
                                                )
         and sfrstcr_pidm                     = a.sgbstdn_pidm
         and (sgbstdn_program_1 = vsProgCode or vsProgCode is null)
         and (sfrstcr_levl_code = vsLevlCode or vsLevlCode is null)
         and sfrstcr_rsts_code               in (select stvrsts_code from stvrsts where stvrsts_gradable_ind = csY)
         and (sfrstcr_crn,sfrstcr_term_code) in (select swrpgac_crn,swrpgac_term_code
                                                   from swrpgac
                                                 );

  end insertSFRSTCR;

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      vsCampCode := pk_objHTML.getValueCookie('psUnive');
      vsTermCode := pk_objHTML.getValueCookie('psPerio');
      vsCollCode := pk_objHTML.getValueCookie('psFacu');
      vsProgCode := pk_objHTML.getValueCookie('psProgr');
      vsLevlCode := pk_objHTML.getValueCookie('psNivel');
      vsEnca     := pk_objHTML.getValueCookie('psEnca');
      vsId       := pk_objHTML.getValueCookie('psId');
      vsSeccion  := pk_objHTML.getValueCookie('cookSeccion');

      PWAISSBSECT(vsCampCode,vsTermCode,vsCollCode,psSstsCode=>csA);
      insertSIRASGN;
      insertSSRXLST;
      insertSFRSTCR;

       -- las instrucciones determinan el largo de la tabla
       FOR vnI IN 1..vnColumnas LOOP
           tabColumna.EXTEND(vnI);
           tabColumna(vnI) := NULL;
       END LOOP;

       tabColumna(1)  := 'NRC';
       tabColumna(2)  := 'Escuela';
       tabColumna(3)  := 'Materia';
       tabColumna(4)  := 'Curso';
       tabColumna(5)  := 'Nombre de la Materia';
       tabColumna(6)  := 'Tipo';
       tabColumna(7)  := 'Lista Cruzada';
       tabColumna(8)  := 'Id';
       tabColumna(9)  := 'Docente';
       tabcolumna(10)  := 'Rut';
       tabColumna(11) := 'Tipo Docente';
       tabColumna(12) := 'Alumnos inscritos';
       tabColumna(13) := 'N&uacute;mero de Reprobados';
       tabColumna(14) := '% Reprobados';
       tabColumna(15) := '>=9';
       tabColumna(16) := '%>=9';
       tabColumna(17) := 'Resultado Seprad';
       tabColumna(18) := 'Promedio';
       tabColumna(19) := 'Modalidad del Curso';

       FOR regRep IN cuReporte LOOP
           IF (vsTermCod2 IS NULL OR vsTermCod2 <> regRep.termCode OR
               vsCampCod2 IS NULL OR vsCampCod2 <> regRep.campCode OR vnRow=27
              ) AND vbEnca THEN
               Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicoPag,'1',psSubtitulo=>'Periodo '||regRep.TermCode,psUsuario=>pk_login.vgsUSR,psSeccion=>vsSeccion,psUniversidad=>regRep.campCode);
               vsInicoPag := 'SALTO';

               vnRow  := 0;
           END IF;

           IF vsEnca = 'N' THEN
              vbEnca := FALSE;
           END IF;

           vsPromedio := promedioSeprad(regRep.termCode, regRep.pgacCrnn, regRep.campCode, regRep.CollCode, regRep.horsPidm, vsTsscCode);

           vsLink := '<a href="javascript:fMuestraDiv(''Distribucin de frecuencias de la evaluacin docente'','''||
                     regRep.campCode||''','''||
                     regRep.termCode||''','''||
                     regRep.CollCode||''','''||
                     regRep.pgacCrnn||''','''||
                     vsTsscCode     ||''','''||
                     regRep.horsPidm||''','''||
                     regRep.xlstType||''','''||
                     regRep.ptrm||''')">'||
                     vsPromedio||'</a>';

           htp.p(
           '<tr>
           <td valign="top" align="left">' ||regRep.pgacCrnn||'</td>
           <td valign="top" align="left">' ||regRep.CollDesc||'</td>
           <td valign="top" align="left">' ||regRep.subjCode||'</td>
           <td valign="top" align="left">' ||regRep.crseNumb||'</td>
           <td valign="top" align="left">' ||regRep.pgacTitl||'</td>
           <td valign="top" align="left">' ||regRep.xlstType||'</td>
           <td valign="top" align="left">' ||regRep.xlstGrop||'</td>
           <td valign="top" align="left">' ||regRep.Id||'</td>
           <td valign="top" align="left">' ||regRep.factName||'</td>
           <td valign="top" align="left">' ||regRep.rut||'</td>
           <td valign="top" align="left">' ||regRep.fstpCode||'</td>
           <td valign="top" align="right">'||regRep.stcrInsc||'</td>
           <td valign="top" align="right">'||regRep.pasedInd||'</td>
           <td valign="top" align="right">'||regRep.psdIndPr||'%</td>
           <td valign="top" align="right">'||regRep.quality9||'</td>
           <td valign="top" align="right">'||regRep.qulty9Pr||'%</td>
           <td valign="top" align="right">'||vsLink         ||'</td>
           <td valign="top" align="right">'||regRep.qualitPm||'</td>
           <td valign="top" align="right">'||regRep.gmodCode||'</td></tr>'
           );

           vsCampCod2 := regRep.campCode;
           vsTermCod2 := regRep.termCode;
           vnExists   := 1;
           vnRow      := vnRow + 1;
       END LOOP;

       IF vnExists = 0 THEN
          htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
       ELSE
          -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
          Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

          -- es omitido el encabezado del reporte pero se agrega el salto de pagina
          Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR, psSeccion=>vsSeccion);
       END IF;

       htp.p('</table>');

       distribucion;

       htp.p('</body></html>');

       ROLLBACK;

  EXCEPTION
      WHEN OTHERS THEN
           HTP.P(SQLERRM);

  END PWRINDR;
/


DROP PUBLIC SYNONYM PWRINDR;

CREATE PUBLIC SYNONYM PWRINDR FOR BANINST1.PWRINDR;


GRANT EXECUTE ON BANINST1.PWRINDR TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRINDR TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRINGD;

CREATE OR REPLACE PROCEDURE BANINST1.PWRINGD(psReclDesc VARCHAR2) IS

/**************************************************************
           tarea:  presentar la cantidad de profesores que no han capturado calificaciones
                      y los profesores que si han capturado calificaciones
         mdulo:  consulta al registro de calificaciones
           autor:  horacio martnez ramrez - hmr
           fecha:  12/oct/2010

    modificacin: CCR
                  16/12/2010
                  Se agrega la instruiccin para que termine la imagen de espera en el
                  reporte
**************************************************************/

  vsPeriodoDesc   STVTERM.STVTERM_DESC%TYPE      := NULL;
  vsEscuelaDesc   STVCOLL.STVCOLL_DESC%TYPE      := NULL;
  vnTotalM        NUMBER                         := 0;
  vnTotalC        NUMBER                         := 0;
  vnTotalCno      NUMBER                         := 0;
  vnPorcentajeP   NUMBER                         := 0;
  vsCamp          VARCHAR2(6)                    := NULL;
  vsSede          VARCHAR2(10)                   := NULL;
  vsTerm          VARCHAR2(10)                   := NULL;
  vsColl          VARCHAR2(10)                   := NULL;

  csEsp CONSTANT VARCHAR2(1) := ' ';

  CURSOR cuProfesore IS
         SELECT FWRSIRG_DEPT_CODE            AS deptCode,
                FWRSIRG_COLL_CODE            AS collCode,
                COUNT(DISTINCT FWRSIRG_PIDM) AS sirgPidm,
                (SELECT COUNT(DISTINCT A.FWRSIRG_PIDM)
                   FROM FWRSIRG A
                  WHERE A.FWRSIRG_DEPT_CODE = B.FWRSIRG_DEPT_CODE
                    AND A.FWRSIRG_COLL_CODE = B.FWRSIRG_COLL_CODE
                    AND EXISTS (SELECT NULL
                                  FROM SHRMRKS
                                 WHERE SHRMRKS_TERM_CODE                      = A.FWRSIRG_TERM_CODE
                                   AND SHRMRKS_CRN                            = A.FWRSIRG_CRN
                                   AND REPLACE(SHRMRKS_GRDE_CODE,csEsp,NULL) IS NOT NULL
                               )
                ) AS ysGrade,
                (SELECT COUNT(DISTINCT C.FWRSIRG_PIDM)
                   FROM FWRSIRG C
                  WHERE C.FWRSIRG_DEPT_CODE = B.FWRSIRG_DEPT_CODE
                    AND C.FWRSIRG_COLL_CODE = B.FWRSIRG_COLL_CODE
                    AND (
                          (0 = (SELECT SUM(DECODE(REPLACE(SHRMRKS_GRDE_CODE,csEsp,NULL),NULL,0,1))
                                  FROM SHRMRKS
                                 WHERE SHRMRKS_TERM_CODE = C.FWRSIRG_TERM_CODE
                                   AND SHRMRKS_CRN       = C.FWRSIRG_CRN
                               )
                           )
                         OR
                           (NOT EXISTS (SELECT NULL
                                          FROM SHRMRKS
                                         WHERE SHRMRKS_TERM_CODE  = C.FWRSIRG_TERM_CODE
                                           AND SHRMRKS_CRN        = C.FWRSIRG_CRN
                                       )
                           )
                         )
                ) AS noGrade
           FROM FWRSIRG B
          GROUP BY FWRSIRG_DEPT_CODE,
                   FWRSIRG_COLL_CODE
          ORDER BY FWRSIRG_DEPT_CODE,
                   FWRSIRG_COLL_CODE;

  BEGIN
      -- valida que el usuario pertenezca a la base de datos.
      IF PK_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      vsCamp := pk_objHtml.getValueCookie('psUnive');
      vsTerm := pk_objHtml.getValueCookie('psPerio');
      vsColl := pk_objHtml.getValueCookie('psEscu');
      vsSede := pk_objHtml.getValueCookie('psDept');

      PWAINGD(vsCamp, vsTerm, vsColl, vsSede);

      vsPeriodoDesc := pk_Catalogo.PERIODO(vsTerm);

      htp.p('<html><head><title>&nbsp;</title></head>');

      -- la aplicaci&oacute;n no se guarda en el cache de la maquina.
      pk_objHtml.P_NoCache;

      --c&oacute;digo css
      pk_objHtml.P_CssTabs;

      htp.p('<script language="javascript" src="kwacnls.js"></script>');
      htp.p('<script language="JavaScript"><!--');
      htp.p('function fEjecuta(psCOLL,pnVAL,psSede) {
            document.frmAction.psColl.value = psCOLL;
            document.frmAction.psSede.value = psSede;

            if(pnVAL == 1) {
                     document.frmAction.action = "pk_RegCaliCalificacion.P_SiCalificaciones";
               } else {
                  document.frmAction.action = "pk_RegCaliCalificacion.P_NoCalificaciones";
               }

               document.frmAction.submit();
            }');

      ---
      htp.p('function fImprimeReporte() {
               window.focus()
               print();
               }');
      htp.p('--></script>');

      htp.p('</head><body bgcolor="#ffffff">');

      htp.p('
      <table border="1" cellpadding="2" cellspacing="1" align="center" bordercolor="#cccccc">
          <tr><td style="border-right:none;border-left:none;border-top:none;" rowspan="3" align="center">
         <img src="/imagenes/logouft.gif" hspace="0" vspace="0" border="0" height="40" width="40"></td>
              <td bordercolor="#ffffff" align="left" colspan="4">
         Profesores que han ingresado calificaciones</td></tr>
          <tr><td bordercolor="#ffffff" align="left"  colspan="4">
            '||vsTerm||' '||vsPERIODODESC||'</td></tr>
          <tr><td style="border-right:none;border-left:none;" align="left" colspan="4">
            '||to_char(sysdate,'DD/MM/YYYY HH24:MI:SS')||'</td></tr>
             <tr bgcolor="#efefef">
              <th style="width:100px;">Sede</th>
              <th style="width:200px;">Escuela o Facultad</th>
              <th style="width:90px;"> Maestros   </th>
              <th style="width:90px;"> Ingres&oacute;<br />calificaciones</th>
              <th style="width:90px;"> No ha<br />ingresado calificaciones</th>
              <th style="width:90px;"> %<br />de profesores que ingresaron calificaciones</th></tr>'
      );

      FOR regPrf IN cuProfesore LOOP
          vnPorcentajeP := 0;
          vsEscuelaDesc := pk_catalogo.colegio(regPrf.collCode);

          IF regPrf.ysGrade <> 0 AND regPrf.sirgPidm <> 0 THEN
             vnPorcentajeP := ROUND((regPrf.ysGrade/regPrf.sirgPidm) * 100,2);
          END IF;

          htp.p(
          '<tr>
          <td align="left">' ||NVL(pk_catalogo.fstvdept(regPrf.deptCode),'sin Sede')||'</td>
          <td align="left">' ||vsEscuelaDesc                                        ||'</td>
          <td align="right">'||regPrf.sirgPidm                                      ||'</td>
          <td align="right">
              <a href="javascript:fEjecuta('''||regPrf.collCode||''',1,'''||regPrf.deptCode||''');" onMouseOver="window.status='''||vsEscuelaDesc||' '||regPrf.ysGrade||'''; return true;" onMouseOut="window.status=''''; return true;">
              '||regPrf.ysGrade||'
              </a></td>
          <td align="right">
              <a href="javascript:fEjecuta('''||regPrf.collCode||''',2,'''||regPrf.deptCode||''');" onMouseOver="window.status='''||vsEscuelaDesc||' '||regPrf.noGrade||'''; return true;" onMouseOut="window.status=''''; return true;">
              '||regPrf.noGrade||'
              </a></td>
          <td align="right">'||vnPorcentajeP||'%</td>
          </tr>'
          );

         vnTotalCno := vnTotalCno + regPrf.noGrade;
         vnTotalM   := vnTotalM   + regPrf.sirgPidm;
         vnTotalC   := vnTotalC   + regPrf.ysGrade;
      END LOOP;

      vnPorcentajeP := 0;

      IF vnTotalM <> 0 AND vnTotalC <> 0 THEN
         vnPorcentajeP := ROUND((vnTotalC/vnTotalM) * 100,2);
      END IF;

      htp.p('
      <tr bgcolor="#efefef">
          <th colspan="2">Total</th>
          <th align="right">'||vnTotalM     ||'</th>
          <th align="right">'||vnTotalC     ||'</th>
          <th align="right">'||vnTotalCno   ||'</th>
          <th align="right">'||vnPorcentajeP||'%</th>
          </tr></table><br/>'
      );

      htp.p('
      <form name="frmAction" method="post">
      <input type="hidden" name="psCamp" value="'||vsCamp||'" />
      <input type="hidden" name="psTerm" value="'||vsTerm||'" />
      <input type="hidden" name="psColl" />
      <input type="hidden" name="psSede" >
      </form>
      </html></body>'
      );

      ROLLBACK;

  EXCEPTION
       WHEN OTHERS THEN
                htp.p(SQLERRM);

  END PWRINGD;
/


DROP PUBLIC SYNONYM PWRINGD;

CREATE PUBLIC SYNONYM PWRINGD FOR BANINST1.PWRINGD;


GRANT EXECUTE ON BANINST1.PWRINGD TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRINGD TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRISCR;

CREATE OR REPLACE PROCEDURE BANINST1.PWRISCR (psReclDesc   VARCHAR2)  IS

/**************************************************************
           tarea:  procedimiento que genera el reporte
                   de ingresados segn comuna de residencia
          mdulo:  admisiones
           autor:  horacio martnez ramrez - hmr
           fecha:  03/mar/2011
**************************************************************/

  vnExists       INTEGER := 0;
  vnColumnas     INTEGER := 25;
  vgsInicioPag   VARCHAR2(30) := NULL;           -- bandera que al tener el valor "imprime", no colocar el salto de pgina para impresin
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vnIdRenglon    INTEGER := 1;
  vsTerm         SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsProgr        SARADAP.SARADAP_PROGRAM_1%TYPE DEFAULT NULL;


  CURSOR cuReporte ( psTerm    VARCHAR2  DEFAULT NULL )  IS

     SELECT COMUNA_CODE,
            COMUNA_DESC,
            REGION,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'AC', REGION)   ESC_ACTUAC,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'AR', REGION)   ESC_ARQUI,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'AV', REGION)   ESC_ART_VIS,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'CF', REGION)   ESC_CIEN_FAM,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'CS', REGION)   ESC_PER_HIST,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'DE', REGION)   ESC_DERECHO,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'DI', REGION)   ESC_DISEO,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'EB', REGION)   ESC_EDU_BAS,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'EM', REGION)   ESC_EDU_MED,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'EN', REGION)   ESC_ENFERM,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'EP', REGION)   ESC_EDU_PARV,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'HI', REGION)   ESC_HISTORIA,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'IC', REGION)   ESC_ING_COMER,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'KI', REGION)   ESC_KINES,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'LI', REGION)   ESC_LITER,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'MD', REGION)   ESC_MEDICINA,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'NU', REGION)   ESC_NUT_DIET,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'OD', REGION)   ESC_ODONTO,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'PE', REGION)   ESC_PERIOD,
            BANINST1.F_ING_COMUNA (psTerm, COMUNA_CODE, 'PR', REGION)   ESC_PED_REL,
            BANINST1.F_ING_COMUNA_TOT (psTerm, COMUNA_CODE, REGION)     TOT_COL_NUM,
            BANINST1.F_ING_COMUNA_PORC (psTerm, COMUNA_CODE, REGION)    TOT_COL_PORC
       FROM ( SELECT DR.SPRADDR_CNTY_CODE                           COMUNA_CODE,
                     REPLACE(UPPER(CN.STVCNTY_DESC), '*', ' * ')    COMUNA_DESC,
                     DR.SPRADDR_STAT_CODE                           REGION
                FROM SORLCUR  SR,
                     STVCNTY  CN,
                     SPRADDR  DR
               WHERE SR.SORLCUR_TERM_CODE = psterm
                 AND SR.SORLCUR_TERM_CODE = SR.SORLCUR_TERM_CODE_ADMIT
                 AND SR.SORLCUR_ADMT_CODE = 'AD'
                 AND SR.SORLCUR_CACT_CODE = 'ACTIVE'
                 AND DR.SPRADDR_CNTY_CODE <> '00000'
                 AND DR.SPRADDR_STAT_CODE NOT IN ('00', 'PUE')
                 AND SR.SORLCUR_PIDM = DR.SPRADDR_PIDM
                 AND DR.SPRADDR_CNTY_CODE = CN.STVCNTY_CODE
               GROUP BY DR.SPRADDR_CNTY_CODE, CN.STVCNTY_DESC, DR.SPRADDR_STAT_CODE
               ORDER BY DR.SPRADDR_CNTY_CODE );

  BEGIN

     -- valida que el usuario pertenezca a la base de datos:
     IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

     -- son buscados los valores de las cookies para asignar los valores del filtro del query:
     vsTerm := pk_ObjHtml.getValueCookie('psTerm');

     -- se determina el largo de la tabla:
     FOR vnI IN 1..vnColumnas LOOP
         tabColumna.EXTEND(vnI);
         tabColumna(vnI) := NULL;
     END LOOP;

     tabColumna(1)  := '<center> Comuna de <br> residencia <br> <br> Cdigo';
     tabColumna(2)  := '<center> Comuna de <br> residencia <br> <br> Nombre';
     tabColumna(3)  := '<center> Comuna de <br> residencia <br> <br> Regin';
     tabColumna(4)  := '<center> Escuela <br> de <br> Actuacin';
     tabColumna(5)  := '<center> Escuela <br> de <br> Arquitectura';
     tabColumna(6)  := '<center> Escuela <br> de <br> Artes <br> Visuales';
     tabColumna(7)  := '<center> Escuela de<br> Ciencias<br>de la Familia';
     tabColumna(8)  := '<center> Escuela <br> de <br> Periodismo <br> e Historia';
     tabColumna(9)  := '<center> Escuela <br> de <br> Derecho';
     tabColumna(10) := '<center> Escuela <br> de <br> Diseo';
     tabColumna(11) := '<center> Escuela <br> de <br> Educacin <br> Bsica';
     tabColumna(12) := '<center> Escuela <br> de <br> Educacin <br> Media';
     tabColumna(13) := '<center> Escuela <br> de <br> Enfermera';
     tabColumna(14) := '<center> Escuela <br> de <br> Educacin <br> Parvularia';
     tabColumna(15) := '<center> Escuela <br> de <br> Historia';
     tabColumna(16) := '<center> Escuela <br> de <br> Ingeniera <br> Comercial';
     tabColumna(17) := '<center> Escuela <br> de <br> Kinesiologa';
     tabColumna(18) := '<center> Escuela <br> de <br> Literatura';
     tabColumna(19) := '<center> Escuela <br> de <br> Medicina';
     tabColumna(20) := '<center> Escuela <br> de <br> Nutricin<br>y Diett.';
     tabColumna(21) := '<center> Escuela <br> de <br> Odotologa';
     tabColumna(22) := '<center> Escuela <br> de <br> Periodismo';
     tabColumna(23) := '<center> Escuela de <br> Pedagoga, <br> Religin <br> y MC';
     tabColumna(24) := '<center> Total <br> comuna <br> <br> No.';
     tabColumna(25) := '<center> Total <br> comuna <br> Porcentaje <br> del Total';

     FOR regRep IN cuReporte (vsTerm) LOOP

         IF vnExists = 0 THEN
            Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||'  '||Pk_Catalogo.PERIODO(vsTerm), psUniversidad=>'UFT');
            vgsInicioPag := 'SALTO';
         END IF;

         HTP.P('<tr> <td valign="top" align="center">' ||regRep.COMUNA_CODE    ||'</td>
                     <td valign="top" align="left">'   ||regRep.COMUNA_DESC    ||'</td>
                     <td valign="top" align="center">' ||regRep.REGION         ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_ACTUAC     ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_ARQUI      ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_ART_VIS    ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_CIEN_FAM   ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_PER_HIST   ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_DERECHO    ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_DISEO     ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_EDU_BAS    ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_EDU_MED    ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_ENFERM     ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_EDU_PARV   ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_HISTORIA   ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_ING_COMER  ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_KINES      ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_LITER      ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_MEDICINA   ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_NUT_DIET   ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_ODONTO     ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_PERIOD     ||'</td>
                     <td valign="top" align="center">' ||regRep.ESC_PED_REL    ||'</td>
                     <td valign="top" align="center">' ||regRep.TOT_COL_NUM    ||'</td>
                     <td valign="top" align="center">' ||regRep.TOT_COL_PORC   ||'</td>
               </tr>');

         vnExists    := 1;
         vnIdRenglon := vnIdRenglon + 1;

     END LOOP;

     IF vnExists = 0 THEN
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
     ELSE
        -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pgina:
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR);
     END IF;

     htp.p('</table><br/></body></html>');

  EXCEPTION
     WHEN OTHERS THEN
          htp.p(SQLERRM);

  END PWRISCR;
/


DROP PUBLIC SYNONYM PWRISCR;

CREATE PUBLIC SYNONYM PWRISCR FOR BANINST1.PWRISCR;


GRANT EXECUTE ON BANINST1.PWRISCR TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRISCR TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRIVIN;

CREATE OR REPLACE PROCEDURE BANINST1.PWRIVIN (psReclDesc   VARCHAR2)  IS

/**************************************************************
           tarea:  procedimiento que genera el reporte de ingresados
                   segn va de ingreso.
          mdulo:  admisiones
           autor:  horacio martnez ramrez - hmr
           fecha:  31/ene/2011
**************************************************************/

  vnExists       INTEGER  := 0;
  vnColumnas     INTEGER  := 30;
  vgsInicioPag   VARCHAR2(30)  := NULL;           -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vnIdRenglon    INTEGER  := 1;
  vsTerm         SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsProgr        SARADAP.SARADAP_PROGRAM_1%TYPE DEFAULT NULL;


  CURSOR cuReporte ( psTerm    VARCHAR2  DEFAULT NULL,
                     psProgr   VARCHAR2  DEFAULT NULL)  IS

     SELECT SR.SORLCUR_PROGRAM                                                  CARRERA,
            F_CANT_TIPADM(SR.SORLCUR_TERM_CODE, 'AD', SR.SORLCUR_PROGRAM)   ADM_REG_NUM,
            F_PORC_TIPADM(SR.SORLCUR_TERM_CODE, 'AD', SR.SORLCUR_PROGRAM)   ADM_REG_PORC,
            F_CANT_TIPADM(SR.SORLCUR_TERM_CODE, 'AL', SR.SORLCUR_PROGRAM)   ALUM_LIB_NUM,
            F_PORC_TIPADM(SR.SORLCUR_TERM_CODE, 'AL', SR.SORLCUR_PROGRAM)   ALUM_LIB_PORC,
            F_CANT_TIPADM(SR.SORLCUR_TERM_CODE, 'BA', SR.SORLCUR_PROGRAM)   BACH_ALE_NUM,
            F_PORC_TIPADM(SR.SORLCUR_TERM_CODE, 'BA', SR.SORLCUR_PROGRAM)   BACH_ALE_PORC,
            F_CANT_TIPADM(SR.SORLCUR_TERM_CODE, 'BF', SR.SORLCUR_PROGRAM)   BACH_FRA_NUM,
            F_PORC_TIPADM(SR.SORLCUR_TERM_CODE, 'BF', SR.SORLCUR_PROGRAM)   BACH_FRA_PORC,
            F_CANT_TIPADM(SR.SORLCUR_TERM_CODE, 'BI', SR.SORLCUR_PROGRAM)   BACH_ING_NUM,
            F_PORC_TIPADM(SR.SORLCUR_TERM_CODE, 'BI', SR.SORLCUR_PROGRAM)   BACH_ING_PORC,
            F_CANT_TIPADM(SR.SORLCUR_TERM_CODE, 'CO', SR.SORLCUR_PROGRAM)   COVAL_UN_NUM,
            F_PORC_TIPADM(SR.SORLCUR_TERM_CODE, 'CO', SR.SORLCUR_PROGRAM)   COVAL_UN_PORC,
            F_CANT_TIPADM(SR.SORLCUR_TERM_CODE, 'EE', SR.SORLCUR_PROGRAM)   EST_EXT_NUM,
            F_PORC_TIPADM(SR.SORLCUR_TERM_CODE, 'EE', SR.SORLCUR_PROGRAM)   EST_EXT_PORC,
            F_CANT_TIPADM(SR.SORLCUR_TERM_CODE, 'LO', SR.SORLCUR_PROGRAM)   LIC_TIT_NUM,
            F_PORC_TIPADM(SR.SORLCUR_TERM_CODE, 'LO', SR.SORLCUR_PROGRAM)   LIC_TIT_PORC,
            F_CANT_TIPADM(SR.SORLCUR_TERM_CODE, 'LU', SR.SORLCUR_PROGRAM)   LIC_TIT_UFT_NUM,
            F_PORC_TIPADM(SR.SORLCUR_TERM_CODE, 'LU', SR.SORLCUR_PROGRAM)   LIC_TIT_UFT_PORC,
            F_CANT_TIPADM(SR.SORLCUR_TERM_CODE, 'PA', SR.SORLCUR_PROGRAM)   PSU_ANT_NUM,
            F_PORC_TIPADM(SR.SORLCUR_TERM_CODE, 'PA', SR.SORLCUR_PROGRAM)   PSU_ANT_PORC,
            F_CANT_TIPADM(SR.SORLCUR_TERM_CODE, 'VP', SR.SORLCUR_PROGRAM)   VESPERT_NUM,
            F_PORC_TIPADM(SR.SORLCUR_TERM_CODE, 'VP', SR.SORLCUR_PROGRAM)   VERPERT_PORC,
            F_CANT_TIPADM(SR.SORLCUR_TERM_CODE, 'AE', SR.SORLCUR_PROGRAM)    ADM_ESP_NUM,
            F_PORC_TIPADM(SR.SORLCUR_TERM_CODE, 'AE', SR.SORLCUR_PROGRAM)    ADM_ESP_PORC,
            F_CANT_TIPADM(SR.SORLCUR_TERM_CODE, 'BR', SR.SORLCUR_PROGRAM)    BACH_ART_NUM,
            F_PORC_TIPADM(SR.SORLCUR_TERM_CODE, 'BR', SR.SORLCUR_PROGRAM)    BACH_ART_PORC,
            F_CANT_TIPADM(SR.SORLCUR_TERM_CODE, 'CM', SR.SORLCUR_PROGRAM)    ADM_IV_M_NUM,
            F_PORC_TIPADM(SR.SORLCUR_TERM_CODE, 'CM', SR.SORLCUR_PROGRAM)    ADM_IV_M_PORC,
            ( SELECT COUNT(SORLCUR_ADMT_CODE)
                FROM SORLCUR
               WHERE SORLCUR_TERM_CODE = psTerm
                 AND SORLCUR_TERM_CODE = SORLCUR_TERM_CODE_ADMIT
                 AND SORLCUR_CACT_CODE = 'ACTIVE'
                 AND SORLCUR_ADMT_CODE IN ('AD', 'AL', 'BA', 'BF', 'BI', 'CO', 'EE', 'LO', 'LU', 'PA', 'VP', 'AE', 'BR', 'CM')
                 AND SORLCUR_PROGRAM = SR.SORLCUR_PROGRAM )                   TOTAL_ING
           FROM SORLCUR SR
          WHERE SR.SORLCUR_TERM_CODE = psTerm
             AND SR.SORLCUR_TERM_CODE = SR.SORLCUR_TERM_CODE_ADMIT
             AND SR.SORLCUR_CACT_CODE = 'ACTIVE'
             AND (SR.SORLCUR_PROGRAM = psProgr OR psProgr IS NULL)
          GROUP BY SR.SORLCUR_PROGRAM, SR.SORLCUR_TERM_CODE
          ORDER BY SR.SORLCUR_PROGRAM;


  BEGIN

     -- valida que el usuario pertenezca a la base de datos:
     IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

     -- son buscados los valores de las cookies para asignar los valores del filtro del query:
     vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
     vsProgr := pk_ObjHtml.getValueCookie('psProgr');

     -- se determina el largo de la tabla:
     FOR vnI IN 1..vnColumnas LOOP
         tabColumna.EXTEND(vnI);
         tabColumna(vnI) := NULL;
     END LOOP;

     tabColumna(1)  := '<center> Carrera';
     tabColumna(2)  := '<center> Admisin <br> regular <br> No.';
     tabColumna(3)  := '<center> Admisin <br> regular <br> %';
     tabColumna(4)  := '<center> Alumno <br> libre <br> No.';
     tabColumna(5)  := '<center> Alumno <br> libre <br> %';
     tabColumna(6)  := '<center> Bachillerato <br> alemn <br> No.';
     tabColumna(7)  := '<center> Bachillerato <br> alemn <br> %';
     tabColumna(8)  := '<center> Bachillerato <br> francs <br> No.';
     tabColumna(9)  := '<center> Bachillerato <br> francs <br> %';
     tabColumna(10) := '<center> Bachillerato <br> ingls <br>No.';
     tabColumna(11) := '<center> Bachillerato <br> ingls <br> %';
     tabColumna(12) := '<center> Covalidacin <br> otra universidad <br> No.';
     tabColumna(13) := '<center> Covalidacin <br> otra universidad <br> %';
     tabColumna(14) := '<center> Estudios <br> extranjeros <br> No.';
     tabColumna(15) := '<center> Estudios <br> extranjeros <br> %';
     tabColumna(16) := '<center> Licen. / Tit. <br> otra universidad <br> No.';
     tabColumna(17) := '<center> Licen. / Tit. <br> otra universidad <br> %';
     tabColumna(18) := '<center> Licen. / Tit. <br> UFT <br> No.';
     tabColumna(19) := '<center> Licen. / Tit. <br> UFT <br> %';
     tabColumna(20) := '<center> PSU <br> anterior <br> No.';
     tabColumna(21) := '<center> PSU <br> anterior <br> %';
     tabColumna(22) := '<center> Vespertino <br> No.';
     tabColumna(23) := '<center> Vespertino <br> %';
     tabColumna(24) := '<center> Admisin <br> especial <br> No.';
     tabColumna(25) := '<center> Admisin <br> especial <br> %';
     tabColumna(26) := '<center> Bachillerato <br> de artes <br> No.';
     tabColumna(27) := '<center> Bachillerato <br> de artes <br> %';
     tabColumna(28) := '<center> Admisin <br> IV medio <br> No.';
     tabColumna(29) := '<center> Admisin <br> IV medio <br> %';
     tabColumna(30) := '<center> Total ingresados';


     FOR regRep IN cuReporte (vsTerm, vsProgr) LOOP

         IF vnExists = 0 THEN
            Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||'  '||Pk_Catalogo.PERIODO(vsTerm), psUniversidad=>'UFT');
            vgsInicioPag := 'SALTO';
         END IF;

         HTP.P('<tr> <td valign="top" align="left">'   ||regRep.CARRERA          ||'</td>
                     <td valign="top" align="center">' ||regRep.ADM_REG_NUM      ||'</td>
                     <td valign="top" align="center">' ||regRep.ADM_REG_PORC     ||'</td>
                     <td valign="top" align="center">' ||regRep.ALUM_LIB_NUM     ||'</td>
                     <td valign="top" align="center">' ||regRep.ALUM_LIB_PORC    ||'</td>
                     <td valign="top" align="center">' ||regRep.BACH_ALE_NUM     ||'</td>
                     <td valign="top" align="center">' ||regRep.BACH_ALE_PORC    ||'</td>
                     <td valign="top" align="center">' ||regRep.BACH_FRA_NUM     ||'</td>
                     <td valign="top" align="center">' ||regRep.BACH_FRA_PORC    ||'</td>
                     <td valign="top" align="center">' ||regRep.BACH_ING_NUM     ||'</td>
                     <td valign="top" align="center">' ||regRep.BACH_ING_PORC    ||'</td>
                     <td valign="top" align="center">' ||regRep.COVAL_UN_NUM     ||'</td>
                     <td valign="top" align="center">' ||regRep.COVAL_UN_PORC    ||'</td>
                     <td valign="top" align="center">' ||regRep.EST_EXT_NUM      ||'</td>
                     <td valign="top" align="center">' ||regRep.EST_EXT_PORC     ||'</td>
                     <td valign="top" align="center">' ||regRep.LIC_TIT_NUM      ||'</td>
                     <td valign="top" align="center">' ||regRep.LIC_TIT_PORC     ||'</td>
                     <td valign="top" align="center">' ||regRep.LIC_TIT_UFT_NUM  ||'</td>
                     <td valign="top" align="center">' ||regRep.LIC_TIT_UFT_PORC ||'</td>
                     <td valign="top" align="center">' ||regRep.PSU_ANT_NUM      ||'</td>
                     <td valign="top" align="center">' ||regRep.PSU_ANT_PORC     ||'</td>
                     <td valign="top" align="center">' ||regRep.VESPERT_NUM      ||'</td>
                     <td valign="top" align="center">' ||regRep.VERPERT_PORC     ||'</td>
                     <td valign="top" align="center">' ||regRep.ADM_ESP_NUM        ||'</td>
                     <td valign="top" align="center">' ||regRep.ADM_ESP_PORC       ||'</td>
                     <td valign="top" align="center">' ||regRep.BACH_ART_NUM        ||'</td>
                     <td valign="top" align="center">' ||regRep.BACH_ART_PORC       ||'</td>
                     <td valign="top" align="center">' ||regRep.ADM_IV_M_NUM        ||'</td>
                     <td valign="top" align="center">' ||regRep.ADM_IV_M_PORC       ||'</td>
                     <td valign="top" align="center">' ||regRep.TOTAL_ING        ||'</td>
               </tr>');

         vnExists    := 1;
         vnIdRenglon := vnIdRenglon + 1;

     END LOOP;

     IF vnExists = 0 THEN
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
     ELSE
        -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pgina:
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR);
     END IF;

     htp.p('</table><br/></body></html>');

  EXCEPTION
     WHEN OTHERS THEN
          htp.p(SQLERRM);

  END PWRIVIN;
/


DROP PUBLIC SYNONYM PWRIVIN;

CREATE PUBLIC SYNONYM PWRIVIN FOR BANINST1.PWRIVIN;


GRANT EXECUTE ON BANINST1.PWRIVIN TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRIVIN TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRLCCU;

CREATE OR REPLACE PROCEDURE BANINST1.PWRLCCU(psReclDesc VARCHAR2) AS

/*
     Tarea: REPORTE DE LISTAS CRUZADAS CON CUPOS
            * Se agrega el sobrepaso del colegio

     Fecha: 08/10/2009
     Autor: GEPC
    Modulo: Programacin acadmica

             Fecha: 21/10/2009
             Autor: CCR
      Modificacin: Se Agregaron los campos de horas semanales y horas programadas
                    cambio en los parametros del proceso P_EncabezadoDeReporte por
                    que no pintaba encabezado
*/

ckNombres   owa_cookie.vc_arr;
ckValores   owa_cookie.vc_arr;
ckCount     INTEGER;
vgsInicoPag VARCHAR2(10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
vgsUSR      VARCHAR2(500);

  vnRow      INTEGER                := 0;
  vnExists   INTEGER                := 0;
  vnColumnas INTEGER                := 29;
  tabColumna Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);

  vsPerio    VARCHAR2(6)            := NULL;
  vsFacu     VARCHAR2(6)            := NULL;
  vsLista    VARCHAR2(10)           := NULL;
  vsSeccion  VARCHAR2(3)            := NULL;
  vsTermCode VARCHAR2(6)            := NULL;
  vsCampCode VARCHAR2(6)            := NULL;
  vsCollCode VARCHAR2(6)            := NULL;

  CURSOR cuReporte(psTerm  VARCHAR2 DEFAULT NULL,
                   psFacu  VARCHAR2 DEFAULT NULL,
                   psLista VARCHAR2 DEFAULT NULL) IS
         SELECT DECODE(SSBOVRR_COLL_CODE,NULL,SCBCRSE_COLL_CODE,SSBOVRR_COLL_CODE)  ESCUELA,
                SS.SSBSECT_TERM_CODE                                                                     TERMCODE,
                NVL(SSBSECT_CAMP_CODE,'S/Univ')                                                          CAMPCODE,
                Pk_Catalogo.UNIVERSIDAD(SSBSECT_CAMP_CODE)                                               DESC_UNIVERSIDAD,
                SSRXLST_XLST_GROUP                                                                       LISTA_CRUZADA,
                SSBXLST_MAX_ENRL                                                                         CUPO_LISTA,
                SSBXLST_ENRL                                                                             INSC_LISTA,
                SSBXLST_SEATS_AVAIL                                                                      LUGAR_DISP_LISTA,
                SSBSECT_CRN                                                                              NRC,
                SSBSECT_MAX_ENRL                                                                         CUPO_MAX,
                SSBSECT_ENRL                                                                             INSCRITOS,
                SSBSECT_SEATS_AVAIL                                                                      LUGAR_DISPONIBLE,
                Pk_Catalogo.STATUS_1(SSBSECT_SSTS_CODE)                                                  STATUS,
                SCBCRSE_TITLE                                                                            MATERIA,
                SCBCRSE_SUBJ_CODE                                                                        SUBJ,
                SCBCRSE_CRSE_NUMB                                                                        CURSO,
                PROFESOR.EDIFICIO                                                                        EDIFICIO,
                PROFESOR.AULA                                                                            SALON,
                Pk_Catalogo.NIVEL(SCRLEVL_LEVL_CODE)                                                     NIVEL,
                SPRIDEN_ID                                                                               ID,
                REPLACE(SPRIDEN_LAST_NAME||''||SPRIDEN_FIRST_NAME,'*',' ')                               DOCENTE,
                PROFESOR.LU                                                                              LU,
                PROFESOR.MA                                                                              MA,
                PROFESOR.MI                                                                              MI,
                PROFESOR.JU                                                                              JU,
                PROFESOR.VI                                                                              VI,
                PROFESOR.SA                                                                              SA,
                PROFESOR.DI                                                                              DI,
                PROFESOR.INICIO                                                                          INICIO,
                PROFESOR.FIN                                                                             FIN,
                SCBCRSE_CREDIT_HR_LOW                                                                    CREDITOS,
                Pk_Catalogo.SCHDTYPE(SSBSECT_SCHD_CODE)                                                  TIPO_HORARIO,
                DECODE(SWRXLST_TYPE,'M','Master','S','Simultneo','Independiente')                       TIPO_LISTA,
                PROFESOR.HORAS_SEM                                                                       HORAS_SEM,
                (SELECT SD.SCRSCHD_WORKLOAD
                 FROM SCRSCHD SD
                WHERE SD.SCRSCHD_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB
                  AND SD.SCRSCHD_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                  AND SD.SCRSCHD_SCHD_CODE = SS.SSBSECT_SCHD_CODE
                  AND SD.SCRSCHD_EFF_TERM  = (SELECT MAX(G.SCRSCHD_EFF_TERM)
                                                FROM SCRSCHD G
                                               WHERE G.SCRSCHD_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                                 AND G.SCRSCHD_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                                 AND G.SCRSCHD_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB
                                             )
                )                                                                                        WORKLOAD
           FROM SSBSECT SS,
                SCBCRSE,
                (SELECT SIRASGN_PIDM                                        PIDM,
                        SSRMEET_TERM_CODE                                   PERIODO,
                        SSRMEET_CRN                                         CRN,
                        SSRMEET_CATAGORY                                    CATEGORY,
                        SSRMEET_HRS_WEEK                                    HORAS_SEM,
                        DECODE(SSRMEET_MON_DAY, 'M', 'Lu', SSRMEET_MON_DAY) LU,
                        DECODE(SSRMEET_TUE_DAY, 'T', 'Ma', SSRMEET_TUE_DAY) MA,
                        DECODE(SSRMEET_WED_DAY, 'W', 'Mi', SSRMEET_WED_DAY) MI,
                        DECODE(SSRMEET_THU_DAY, 'R', 'Ju', SSRMEET_THU_DAY) JU,
                        DECODE(SSRMEET_FRI_DAY, 'F', 'Vi', SSRMEET_FRI_DAY) VI,
                        DECODE(SSRMEET_SAT_DAY, 'S', 'Sa', SSRMEET_SAT_DAY) SA,
                        DECODE(SSRMEET_SUN_DAY, 'U', 'Do', SSRMEET_SUN_DAY) DI,
                        SUBSTR(SSRMEET_BEGIN_TIME,1,2)||':'||
                        NVL(SUBSTR(SSRMEET_BEGIN_TIME,3,2),'00')            INICIO,
                        SUBSTR(SSRMEET_END_TIME,1,2)||':'||
                        NVL(SUBSTR(SSRMEET_END_TIME,3,2),'00')              FIN,
                        SSRMEET_BLDG_CODE                                   EDIFICIO,
                        SSRMEET_ROOM_CODE                                   AULA,
                        INST.TIPO                                           TIPO
                   FROM SSRMEET,
                        SIRASGN,
                        (SELECT SI.SIBINST_PIDM PIDM,
                                SI.SIBINST_FSTP_CODE TIPO
                           FROM SIBINST SI
                          WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(ZI.SIBINST_TERM_CODE_EFF)
                                                           FROM SIBINST ZI
                                                          WHERE ZI.SIBINST_PIDM      =  SI.SIBINST_PIDM
                                                            AND ZI.SIBINST_FCST_CODE = 'AC'
                                                        )
                        ) INST
                  WHERE SIRASGN_PIDM            = INST.PIDM(+)
                    AND SSRMEET_TERM_CODE       = SIRASGN_TERM_CODE(+)
                    AND SSRMEET_CRN             = SIRASGN_CRN(+)
                    AND SSRMEET_CATAGORY        = SIRASGN_CATEGORY(+)
                ) PROFESOR,
                SPRIDEN,
                SWRXLST,
                SSRXLST,
                SSBXLST,
                SCRLEVL,
                SSBOVRR
          WHERE SSBSECT_SUBJ_CODE   = SCBCRSE_SUBJ_CODE
            AND SSBSECT_CRSE_NUMB   = SCBCRSE_CRSE_NUMB
            AND SCBCRSE_EFF_TERM    = (SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                         FROM SCBCRSE SC
                                        WHERE SC.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                          AND SC.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                          AND SC.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB
                                      )
            AND SSBSECT_TERM_CODE   = PROFESOR.PERIODO(+)
            AND SSBSECT_CRN         = PROFESOR.CRN(+)
            AND PROFESOR.PIDM       = SPRIDEN_PIDM(+)
            AND SPRIDEN_CHANGE_IND IS NULL
            AND SSBSECT_TERM_CODE   = SSRXLST_TERM_CODE
            AND SSBSECT_CRN         = SSRXLST_CRN
            AND SSRXLST_TERM_CODE   = SWRXLST_TERM_CODE(+)
            AND SSRXLST_CRN         = SWRXLST_CRN(+)
            AND SSRXLST_XLST_GROUP  = SWRXLST_XLST_GROUP(+)
            AND SSRXLST_TERM_CODE   = SSBXLST_TERM_CODE(+)
            AND SSRXLST_XLST_GROUP  = SSBXLST_XLST_GROUP(+)
            AND SSBSECT_SUBJ_CODE   = SCRLEVL_SUBJ_CODE(+)
            AND SSBSECT_CRSE_NUMB   = SCRLEVL_CRSE_NUMB(+)
            AND SCRLEVL_EFF_TERM    = (SELECT MAX(SC.SCRLEVL_EFF_TERM)
                                         FROM SCRLEVL SC
                                        WHERE SC.SCRLEVL_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                          AND SC.SCRLEVL_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                          AND SC.SCRLEVL_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB
                                      )
            AND SSBSECT_TERM_CODE   = SSBOVRR_TERM_CODE(+)
            AND SSBSECT_CRN         = SSBOVRR_CRN(+)
            AND (SS.SSBSECT_TERM_CODE                                               = psTerm  OR psTerm IS NULL)
            AND (DECODE(SSBOVRR_COLL_CODE,NULL,SCBCRSE_COLL_CODE,SSBOVRR_COLL_CODE) = psFacu  OR psFacu IS NULL)
            AND (SSRXLST_XLST_GROUP                                                 = psLista OR psLista IS NULL)
          ORDER BY PERIODO DESC,
                   ESCUELA,
                   LISTA_CRUZADA,
                   MATERIA;

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
         FOR vnCOKIES IN 1..ckCount LOOP

             IF ckNOMBRES(vnCOKIES) = 'psPerio' THEN
                   vsPerio := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                   vsFacu := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psLista' THEN
                   vsLista := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                   vsSeccion := ckValores(vnCOKIES);

             END IF;
         END LOOP;
      END IF;

      -- Las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := 'Lista cruzada';
      tabColumna(2)  := 'Cupo m&aacute;ximo lista';
      tabColumna(3)  := 'No. inscritos lista';
      tabColumna(4)  := 'Lugar disponible lista';
      tabColumna(5)  := 'NRC';
      tabColumna(6)  := 'Cupo m&aacute;ximo';
      tabColumna(7)  := 'No. inscritos';
      tabColumna(8)  := 'Lugar disponible';
      tabColumna(9)  := 'Tipo de curso';
      tabColumna(10) := 'Materia';
      tabColumna(11) := 'Curso';
      tabColumna(12) := 'Nombre de la materia';
      tabColumna(13) := 'Edificio';
      tabColumna(14) := 'Sal&oacute;n';
      tabColumna(15) := 'Nivel';
      tabColumna(16) := 'ID';
      tabColumna(17) := 'Docente';
      tabColumna(18) := 'Lu';
      tabColumna(19) := 'Ma';
      tabColumna(20) := 'Mi';
      tabColumna(21) := 'Ju';
      tabColumna(22) := 'Vi';
      tabColumna(23) := 'Sa';
      tabColumna(24) := 'Hora inicio';
      tabColumna(25) := 'Hora fin';
      tabColumna(26) := 'Cr&eacute;ditos';
      tabColumna(27) := 'Tipo de horario';
      tabColumna(28) := 'Horas Programadas';
      tabColumna(29) := 'Horas Semanales';

      FOR regRep IN cuReporte(vsPerio, vsFacu, vsLista) LOOP
          IF vsTermCode IS NULL OR regRep.termCode <> vsTermCode OR
             vsCampCode IS NULL OR regRep.campCode <> vsCampCode OR
             vsCollCode IS NULL OR regRep.ESCUELA <> vsCollCode THEN

             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vgsInicoPag,'1','#000000',psSubtitulo=>'Periodo '||regRep.termCode || '<BR>' || Pk_Catalogo.COLEGIO(regRep.ESCUELA),psUsuario=>vgsUSR,psSeccion=>vsSeccion);
             vgsInicoPag := 'SALTO';

             vnRow := 0;
          END IF;

          htp.p('<tr>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.Lista_Cruzada   ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.Cupo_lista      ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.Insc_lista      ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.Lugar_disp_lista||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.NRC             ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.Cupo_max        ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.Inscritos       ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.LUGAR_DISPONIBLE||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.TIPO_LISTA      ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.SUBJ            ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.CURSO           ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.MATERIA         ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.EDIFICIO        ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.SALON           ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.NIVEL           ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.ID              ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.Docente         ||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.Lu              ||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.Ma              ||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.Mi              ||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.Ju              ||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.Vi              ||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.Sa              ||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.Inicio          ||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.Fin             ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.CREDITOS        ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.TIPO_HORARIO    ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.Horas_Sem       ||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.WORKLOAD        ||'</td>
          </tr>');

          vnExists   := 1;
          vnRow      := vnRow + 1;
          vsCampCode := regRep.campCode;
          vsTermCode := regRep.termCode;
          vsCollCode :=  regRep.ESCUELA;
      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      END IF;

      htp.p('</table><br/><br/></body></html>');
  EXCEPTION
      WHEN OTHERS THEN
           htp.p(SQLERRM);
  END PWRLCCU;
/


DROP PUBLIC SYNONYM PWRLCCU;

CREATE PUBLIC SYNONYM PWRLCCU FOR BANINST1.PWRLCCU;


GRANT EXECUTE ON BANINST1.PWRLCCU TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRLCCU TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRLCRM;

CREATE OR REPLACE PROCEDURE BANINST1.PWRLCRM(psReclDesc VARCHAR2 DEFAULT NULL) IS

  vnRow       INTEGER                := 0;
  vnExists    INTEGER                := 0;
  vnColumnas  INTEGER                := 59;
  tabColumna  pk_sisrepimp.tipotabla := pk_sisrepimp.tipotabla(1);
  vsInicioPag VARCHAR2(20)           := NULL;

  CURSOR cuLectura IS
         SELECT SWRTCRM_SEQNC                AS tcrmSeqn,
                SWRTCRM_NAME_SUFFIX          AS tcrmRutt,
                SWRTCRM_ID                   AS tcrmIddd,
                SWRTCRM_PROGRAM_CODE         AS tcrmProg,
                SWRTCRM_DATE_BANNER          AS tcrmDate,
                SWRTCRM_PSMA                 AS tcrmPsma,
                SWRTCRM_PSLC                 AS tcrmPslc,
                SWRTCRM_PSCI                 AS tcrmPsci,
                SWRTCRM_PSHC                 AS tcrmPshc,
                SWRTCRM_NEM                  AS tcrmNeme,
                SWRTCRM_PROG_SCORE           AS tcrmScor,
                SWRTCRM_PSU_SCORE            AS tcrmPsuu,
                SWRTCRM_EXP_AUTPSU           AS tcrmAutp,
                SWRTCRM_EXP_AUTCOL           AS tcrmAutc,
                SWRTCRM_EXP_ESAR             AS tcrmEsar,
                SWRTCRM_EXP_ESES             AS tcrmEses,
                SWRTCRM_EXP_CONV             AS tcrmConv,
                SWRTCRM_EXP_DESC             AS tcrmDesc,
                SWRTCRM_EXP_BHER             AS tcrmBher,
                SWRTCRM_EXP_BPAR             AS tcrmBpar,
                SWRTCRM_EXP_BASI             AS tcrmBasi,
                SWRTCRM_EXP_BDEP             AS tcrmBdep,
                SWRTCRM_STS_ADM              AS tcrmStss,
                SWRTCRM_DEC_ADM              AS tcrmDecc,
                SWRTCRM_DATE_FIN             AS tcrmDfin,
                SWRTCRM_USER_FIN             AS tcrmUfin,
                SWRTCRM_TERM_CODE            AS tcrmTerm,
                SWRTCRM_SARHEAD_CODE         AS tcrmHcod,
                SWRTCRM_SARHEAD_APLS_CODE    AS tcrmApls,
                SWRTCRM_SARHEAD_ADD_DATE     AS tcrmAddD,
                SWRTCRM_SARETRY_PRIORITY_NO  AS tcrmPrio,
                SWRTCRM_SARADDR_STREET_LINE1 AS tcrmLin1,
                SWRTCRM_SARADDR_STREET_LINE2 AS tcrmLin2,
                SWRTCRM_SARADDR_STREET_LINE3 AS tcrmLin3,
                SWRTCRM_SARADDR_CITY         AS tcrmCity,
                SWRTCRM_SARADDR_STAT_CDE     AS tcrmStat,
                SWRTCRM_SARADDR_CNTY_CDE     AS tcrmCnty,
                SWRTCRM_SARADDR_ZIP          AS tcrmZipp,
                SWRTCRM_SARADDR_NATN_CDE     AS tcrmNant,
                SWRTCRM_SARPHON_PQLF_CDE1    AS tcrmPql1,
                SWRTCRM_SARPHON_PHONE1       AS tcrmPho1,
                SWRTCRM_SARPHON_PQLF_CDE2    AS tcrmPql2,
                SWRTCRM_SARPHON_PHONE2       AS tcrmPho2,
                SWRTCRM_SARPHON_PQLF_CDE3    AS tcrmPql3,
                SWRTCRM_SARPHON_PHONE3       AS tcrmPho3,
                SWRTCRM_SARPERS_FIRST_NAME   AS tcrmFirs,
                SWRTCRM_SARPERS_LAST_NAME    AS tcrmLast,
                SWRTCRM_SARPERS_MIDDLE_NAME1 AS tcrmMidd,
                SWRTCRM_SARPERS_BIRTH_DTE    AS tcrmBirt,
                SWRTCRM_SARPERS_GENDER       AS tcrmGend,
                SWRTCRM_SARPERS_CITZ_CDE     AS tcrmCitz,
                SWRTCRM_SARHSCH_IDEN_CDE     AS tcrmIdnn,
                SWRTCRM_SARHSCH_HSGR_DATE    AS tcrmHsgr,
                SWRTCRM_SARPCOL_IDEN_CDE     AS tcrmIden,
                SWRTCRM_SARRQST_ANSR_DESC    AS tcrmAsn1,
                SWRTCRM_SARRQST_ANSR_DESC2   AS tcrmAns2,
                SWRTCRM_ACTIVITY_DATE        AS tcrmActy,
                SWRTCRM_USER                 AS tcrmUser,
                SWRTCRM_CHECK_IND            AS tcrmChek
           FROM SWRTCRM
          ORDER BY SWRTCRM_SEQNC;

  --salta
  procedure salta is

  begin
       if pk_login.f_validaciondeacceso (pk_login.vgsusr) then return; end if;
  end salta;

  BEGIN
      FOR vnI IN 1 .. vnColumnas LOOP
          tabColumna.EXTEND (vnI);
          tabColumna (vnI) := NULL;
      END LOOP;

      tabColumna(1)  := 'SWRTCRM_SEQNC';
      tabColumna(2)  := 'SWRTCRM_NAME_SUFFIX';
      tabColumna(3)  := 'SWRTCRM_ID';
      tabColumna(4)  := 'SWRTCRM_PROGRAM_CODE';
      tabColumna(5)  := 'SWRTCRM_DATE_BANNER';
      tabColumna(6)  := 'SWRTCRM_PSMA';
      tabColumna(7)  := 'SWRTCRM_PSLC';
      tabColumna(8)  := 'SWRTCRM_PSCI';
      tabColumna(9)  := 'SWRTCRM_PSHC';
      tabColumna(10) := 'SWRTCRM_NEM';
      tabColumna(11) := 'SWRTCRM_PROG_SCORE';
      tabColumna(12) := 'SWRTCRM_PSU_SCORE';
      tabColumna(13) := 'SWRTCRM_EXP_AUTPSU';
      tabColumna(14) := 'SWRTCRM_EXP_AUTCOL';
      tabColumna(15) := 'SWRTCRM_EXP_ESAR';
      tabColumna(16) := 'SWRTCRM_EXP_ESES';
      tabColumna(17) := 'SWRTCRM_EXP_CONV';
      tabColumna(18) := 'SWRTCRM_EXP_DESC';
      tabColumna(19) := 'SWRTCRM_EXP_BHER';
      tabColumna(20) := 'SWRTCRM_EXP_BPAR';
      tabColumna(21) := 'SWRTCRM_EXP_BASI';
      tabColumna(22) := 'SWRTCRM_EXP_BDEP';
      tabColumna(23) := 'SWRTCRM_STS_ADM';
      tabColumna(24) := 'SWRTCRM_DEC_ADM';
      tabColumna(25) := 'SWRTCRM_DATE_FIN';
      tabColumna(26) := 'SWRTCRM_USER_FIN';
      tabColumna(27) := 'SWRTCRM_TERM_CODE';
      tabColumna(28) := 'SWRTCRM_SARHEAD_CODE';
      tabColumna(29) := 'SWRTCRM_SARHEAD_APLS_CODE';
      tabColumna(30) := 'SWRTCRM_SARHEAD_ADD_DATE';
      tabColumna(31) := 'SWRTCRM_SARETRY_PRIORITY_NO';
      tabColumna(32) := 'SWRTCRM_SARADDR_STREET_LINE1';
      tabColumna(33) := 'SWRTCRM_SARADDR_STREET_LINE2';
      tabColumna(34) := 'SWRTCRM_SARADDR_STREET_LINE3';
      tabColumna(35) := 'SWRTCRM_SARADDR_CITY';
      tabColumna(36) := 'SWRTCRM_SARADDR_STAT_CDE';
      tabColumna(37) := 'SWRTCRM_SARADDR_CNTY_CDE';
      tabColumna(38) := 'SWRTCRM_SARADDR_ZIP';
      tabColumna(39) := 'SWRTCRM_SARADDR_NATN_CDE';
      tabColumna(40) := 'SWRTCRM_SARPHON_PQLF_CDE1';
      tabColumna(41) := 'SWRTCRM_SARPHON_PHONE1';
      tabColumna(42) := 'SWRTCRM_SARPHON_PQLF_CDE2';
      tabColumna(43) := 'SWRTCRM_SARPHON_PHONE2';
      tabColumna(44) := 'SWRTCRM_SARPHON_PQLF_CDE3';
      tabColumna(45) := 'SWRTCRM_SARPHON_PHONE3';
      tabColumna(46) := 'SWRTCRM_SARPERS_FIRST_NAME';
      tabColumna(47) := 'SWRTCRM_SARPERS_LAST_NAME';
      tabColumna(48) := 'SWRTCRM_SARPERS_MIDDLE_NAME1';
      tabColumna(49) := 'SWRTCRM_SARPERS_BIRTH_DTE';
      tabColumna(50) := 'SWRTCRM_SARPERS_GENDER';
      tabColumna(51) := 'SWRTCRM_SARPERS_CITZ_CDE';
      tabColumna(52) := 'SWRTCRM_SARHSCH_IDEN_CDE';
      tabColumna(53) := 'SWRTCRM_SARHSCH_HSGR_DATE';
      tabColumna(54) := 'SWRTCRM_SARPCOL_IDEN_CDE';
      tabColumna(55) := 'SWRTCRM_SARRQST_ANSR_DESC';
      tabColumna(56) := 'SWRTCRM_SARRQST_ANSR_DESC2';
      tabColumna(57) := 'SWRTCRM_ACTIVITY_DATE';
      tabColumna(58) := 'SWRTCRM_USER';
      tabColumna(59) := 'Leido';

      FOR regLec IN cuLectura LOOP
          IF 0 = vnRow THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag);
             vsInicioPag := 'SALTO';
          END IF;

          htp.p(
          '<tr>'||
          '<td>'||regLec.tcrmSeqn||'</td>'||
          '<td>'||regLec.tcrmRutt||'</td>'||
          '<td>'||regLec.tcrmIddd||'</td>'||
          '<td>'||regLec.tcrmProg||'</td>'||
          '<td>'||regLec.tcrmDate||'</td>'||
          '<td>'||regLec.tcrmPsma||'</td>'||
          '<td>'||regLec.tcrmPslc||'</td>'||
          '<td>'||regLec.tcrmPsci||'</td>'||
          '<td>'||regLec.tcrmPshc||'</td>'||
          '<td>'||regLec.tcrmNeme||'</td>'||
          '<td>'||regLec.tcrmScor||'</td>'||
          '<td>'||regLec.tcrmPsuu||'</td>'||
          '<td>'||regLec.tcrmAutp||'</td>'||
          '<td>'||regLec.tcrmAutc||'</td>'||
          '<td>'||regLec.tcrmEsar||'</td>'||
          '<td>'||regLec.tcrmEses||'</td>'||
          '<td>'||regLec.tcrmConv||'</td>'||
          '<td>'||regLec.tcrmDesc||'</td>'||
          '<td>'||regLec.tcrmBher||'</td>'||
          '<td>'||regLec.tcrmBpar||'</td>'||
          '<td>'||regLec.tcrmBasi||'</td>'||
          '<td>'||regLec.tcrmBdep||'</td>'||
          '<td>'||regLec.tcrmStss||'</td>'||
          '<td>'||regLec.tcrmDecc||'</td>'||
          '<td>'||regLec.tcrmDfin||'</td>'||
          '<td>'||regLec.tcrmUfin||'</td>'||
          '<td>'||regLec.tcrmTerm||'</td>'||
          '<td>'||regLec.tcrmHcod||'</td>'||
          '<td>'||regLec.tcrmApls||'</td>'||
          '<td>'||regLec.tcrmAddD||'</td>'||
          '<td>'||regLec.tcrmPrio||'</td>'||
          '<td>'||regLec.tcrmLin1||'</td>'||
          '<td>'||regLec.tcrmLin2||'</td>'||
          '<td>'||regLec.tcrmLin3||'</td>'||
          '<td>'||regLec.tcrmCity||'</td>'||
          '<td>'||regLec.tcrmStat||'</td>'||
          '<td>'||regLec.tcrmCnty||'</td>'||
          '<td>'||regLec.tcrmZipp||'</td>'||
          '<td>'||regLec.tcrmNant||'</td>'||
          '<td>'||regLec.tcrmPql1||'</td>'||
          '<td>'||regLec.tcrmPho1||'</td>'||
          '<td>'||regLec.tcrmPql2||'</td>'||
          '<td>'||regLec.tcrmPho2||'</td>'||
          '<td>'||regLec.tcrmPql3||'</td>'||
          '<td>'||regLec.tcrmPho3||'</td>'||
          '<td>'||regLec.tcrmFirs||'</td>'||
          '<td>'||regLec.tcrmLast||'</td>'||
          '<td>'||regLec.tcrmMidd||'</td>'||
          '<td>'||regLec.tcrmBirt||'</td>'||
          '<td>'||regLec.tcrmGend||'</td>'||
          '<td>'||regLec.tcrmCitz||'</td>'||
          '<td>'||regLec.tcrmIdnn||'</td>'||
          '<td>'||regLec.tcrmHsgr||'</td>'||
          '<td>'||regLec.tcrmIden||'</td>'||
          '<td>'||regLec.tcrmAsn1||'</td>'||
          '<td>'||regLec.tcrmAns2||'</td>'||
          '<td>'||regLec.tcrmActy||'</td>'||
          '<td>'||regLec.tcrmUser||'</td>'||
          '<td>'||regLec.tcrmChek||'</td>'||
          '</tr>'
          );

          vnRow    := 1;
          vnExists := 1;

      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
      END IF;

      htp.p('</table><br/></body></html>');

  END PWRLCRM;
/


DROP PUBLIC SYNONYM PWRLCRM;

CREATE PUBLIC SYNONYM PWRLCRM FOR BANINST1.PWRLCRM;


GRANT EXECUTE ON BANINST1.PWRLCRM TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRLCRM TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRLIAS;

CREATE OR REPLACE PROCEDURE BANINST1.PWRLIAS(psReclDesc VARCHAR2) IS

/**************************************************************
           tarea:  genera el reporte de listas de asistencia para auditora
         mdulo:  consulta al registro de calificaciones
           autor:  horacio martnez ramrez - hmr
           fecha:  12/oct/2010
**************************************************************/

  ckNombres   owa_cookie.vc_arr;
  ckValores   owa_cookie.vc_arr;
  ckCount     INTEGER;
  vgsInicoPag VARCHAR2(10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vgsUSR      VARCHAR2(500);

  vnRow      INTEGER                := 0;
  vnExists   INTEGER                := 0;
  vnColumnas INTEGER                := 5;
  vnRegs     INTEGER                := 0;
  tabColumna Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vsSeccion  VARCHAR2(3)            := NULL;
  vsUnive    VARCHAR2(10)           := NULL;
  vsPerio    VARCHAR2(10)           := NULL;
  vsDocen    VARCHAR2(10)           := NULL;
  vsFacu     VARCHAR2(10)           := NULL;
  vsPeriodo  VARCHAR2(10)           := NULL;
  vsNRC      VARCHAR2(10)           := NULL;
  vsFaculty  VARCHAR2(10)           := NULL;
  vsCrn      VARCHAR2(10)           := NULL;

  CURSOR cuReporte(psUnive VARCHAR2 DEFAULT NULL,
                   psPerio VARCHAR2 DEFAULT NULL,
                   psFacu  VARCHAR2 DEFAULT NULL,
                   psDoce  VARCHAR2 DEFAULT NULL,
                   psNRC   VARCHAR2 DEFAULT NULL) IS
         SELECT DISTINCT SS.SSBSECT_TERM_CODE                        PERIODO,
                NVL(SSBSECT_CAMP_CODE,'S/Univ')                      UNIVERSIDAD,
                Pk_Catalogo.UNIVERSIDAD(SSBSECT_CAMP_CODE)           DESC_UNIVERSIDAD,
                SCBCRSE_COLL_CODE                                    CVEESCUELA,
                Pk_Catalogo.COLEGIO(SCBCRSE_COLL_CODE)               DESCESCUELA,
                SPRIDEN_ID                                              ID,
                REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME,'*',' ') DOCENTE,
                SCBCRSE_SUBJ_CODE                                    SUBJ,
                SCBCRSE_CRSE_NUMB                                    CURSO,
                SCBCRSE_TITLE                                        MATERIA,
                SSBSECT_CRN                                          CRN,
                SS.SSBSECT_SEQ_NUMB                                  SECCION,
                SCBCRSE_CREDIT_HR_LOW                                CREDITOS,
                NVL(NVL(SSBSECT_LAB_HR,SCBCRSE_LAB_HR_LOW),0) +
                NVL(NVL(SSBSECT_LEC_HR,SCBCRSE_LEC_HR_LOW),0) +
                NVL(NVL(SSBSECT_OTH_HR,SCBCRSE_OTH_HR_LOW),0)        HORAS,
                SSBSECT_PTRM_START_DATE||' '||SSBSECT_PTRM_END_DATE  PART_PERIODO,
                SSBSECT_MAX_ENRL                                     CUPO,
                SSBSECT_ENRL                                         INSCRITOS,
                NVL(SSBSECT_MAX_ENRL,0) -  NVL(SSBSECT_ENRL,0)       DISPONIBLES,
                DECODE(PROFESOR.INDICADOR,'Y','Titular')             TITULAR,
                SSRXLST_XLST_GROUP                                      LISTA_CRUZADA
           FROM SSBSECT SS,
                SCBCRSE,
                (SELECT SIRASGN_PIDM                  PIDM,
                        SSRMEET_TERM_CODE             PERIODO,
                        SIRASGN_CRN                   CRN,
                        SIRASGN_PRIMARY_IND           INDICADOR
                   FROM SSRMEET,
                        SIRASGN
                  WHERE SSRMEET_TERM_CODE       = SIRASGN_TERM_CODE
                    AND SSRMEET_CRN             = SIRASGN_CRN
                    AND SSRMEET_CATAGORY        = SIRASGN_CATEGORY
                ) PROFESOR,
                SPRIDEN,
                SSRXLST
          WHERE SSBSECT_SUBJ_CODE     = SCBCRSE_SUBJ_CODE
            AND SSBSECT_CRSE_NUMB     = SCBCRSE_CRSE_NUMB
            AND SCBCRSE_EFF_TERM      = (SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                           FROM SCBCRSE SC
                                          WHERE SC.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                            AND SC.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                            AND SC.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB
                                        )
            AND SSBSECT_TERM_CODE     = PROFESOR.PERIODO(+)
            AND SSBSECT_CRN           = PROFESOR.CRN(+)
            AND PROFESOR.PIDM         = SPRIDEN_PIDM(+)
            AND SPRIDEN_CHANGE_IND IS NULL
            AND SSBSECT_TERM_CODE     = SSRXLST_TERM_CODE(+)
            AND SSBSECT_CRN           = SSRXLST_CRN(+)
            AND EXISTS (SELECT NULL
                          FROM SFRSTCR
                         WHERE SFRSTCR_CAMP_CODE = SS.SSBSECT_CAMP_CODE
                           AND SFRSTCR_TERM_CODE = SS.SSBSECT_TERM_CODE
                           AND SFRSTCR_CRN       = SS.SSBSECT_CRN
                           AND SFRSTCR_RSTS_CODE IN ('RE','RW')
                       )
            AND (SS.SSBSECT_CAMP_CODE = psUnive OR psUnive IS NULL)
            AND (SS.SSBSECT_TERM_CODE = psPerio OR psPerio IS NULL)
            AND (SCBCRSE_COLL_CODE    = psFacu  OR psFacu  IS NULL)
            AND (PROFESOR.PIDM        = psDoce  OR psDoce  IS NULL)
            AND (SSBSECT_CRN          = psNRC   OR psNRC IS NULL)
          ORDER BY PERIODO DESC, DESC_UNIVERSIDAD, DESCESCUELA, MATERIA, DOCENTE;

  -- para obtener los estudiantes del crn
  CURSOR cuProceso(psPerio VARCHAR2,
                   psCrn   VARCHAR2) IS
         SELECT SFRSTCR_REG_SEQ                          SECUENCIA,
                SPRIDEN_ID                               ID,
                REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME,'*',' ') NOMBRE,
                SGBSTDN_MAJR_CODE_1                      CVEMAJR,
                Pk_Catalogo.Carrera(SGBSTDN_MAJR_CODE_1) DESCMAJR
           FROM SGBSTDN A,
                SPRIDEN,
                SFRSTCR
          WHERE SPRIDEN_PIDM            = A.SGBSTDN_PIDM
            AND SPRIDEN_CHANGE_IND     IS NULL
            AND A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                             FROM SGBSTDN B
                                            WHERE B.SGBSTDN_PIDM           = A.SGBSTDN_PIDM
                                              AND B.SGBSTDN_STST_CODE      = 'AS'
                                              AND B.SGBSTDN_TERM_CODE_EFF <= SFRSTCR_TERM_CODE
                                          )
            AND SFRSTCR_PIDM            = SPRIDEN_PIDM
            AND SFRSTCR_RSTS_CODE IN ('RE','RW')
            AND SFRSTCR_TERM_CODE  = psPerio
            AND SFRSTCR_CRN        = psCrn
          ORDER BY NOMBRE, DESCMAJR;

  function f_detalle(psFacty varchar2,
                     psTitur varchar2,
                     psSubjc varchar2,
                     psCorse varchar2,
                     psTitle varchar2,
                     psCrn   varchar2,
                     psSeccn varchar2,
                     psCredt varchar2,
                     psHoras varchar2,
                     psPtrm  varchar2,
                     psCupMx varchar2,
                     psInscr varchar2,
                     psDispn varchar2,
                     psLstCx varchar2) return varchar2 is
  begin
      return '<tr><td colspan="'||vnColumnas||'" bordercolor="#ffffff">'||
             '<table width="100%" border="1" bordercolor="#000000"><tr>'||
             '<td width="80%" align="right" bordercolor="#ffffff" valign="bottom">Fecha        </td><td width="20%" style="border-left:solid 1px #ffffff;border-right:solid 1px #ffffff;border-top:solid 1px #ffffff;border-bottom:solid 1px #000000;"></td></tr>'||
             '<td align="right" bordercolor="#ffffff" valign="bottom">Hora         </td><td style="border-left:solid 1px #ffffff;border-right:solid 1px #ffffff;border-top:solid 1px #000000;border-bottom:solid 1px #000000;"></td></tr>'||
             '<td align="right" bordercolor="#ffffff" valign="bottom">Hora Auditada</td><td style="border-left:solid 1px #ffffff;border-right:solid 1px #ffffff;border-top:solid 1px #000000;border-bottom:solid 1px #000000;"></td></tr>'||
             '<td align="right" bordercolor="#ffffff" valign="bottom">Sal&oacute;n </td><td style="border-left:solid 1px #ffffff;border-right:solid 1px #ffffff;border-top:solid 1px #000000;border-bottom:solid 1px #000000;"></td></tr>'||
             '<td align="right" bordercolor="#ffffff" valign="bottom">Modalidad de Evaluaci&oacute;n </td><td style="border-left:solid 1px #ffffff;border-right:solid 1px #ffffff;border-top:solid 1px #000000;border-bottom:solid 1px #000000;"></td></tr>'||
             '</table>'||
             '</td></tr>'||
             '<tr><td colspan="'||vnColumnas||'" bordercolor="#ffffff">'||
             '<table width="100%" border="1" bordercolor="#dddddd">'||
             '<tr><th bgcolor="#efefef" align="right">Docente                         </th><td colspan="5">'  ||psFacty||'</td>'||
             '<th bgcolor="#efefef" align="right">Status                </th><td>'||psTitur||'</td>'||
             '</tr>'||
             '<tr><th bgcolor="#efefef" width="12.5%" align="right">Materia           </th><td width="12.5%">'||psSubjc||'</td>'||
             '<th bgcolor="#efefef" width="10%" align="right">Curso                 </th><td width="10%">'||psCorse||'</td>'||
             '<th bgcolor="#efefef" width="12.5%" align="right">Nombre de la materia  </th><td width="17.5%">'||psTitle||'</td>'||
             '<th bgcolor="#efefef" width="12.5%" align="right">NRC                   </th><td width="12.5%">'||psCrn  ||'</td>'||
             '</tr>'||
             '<tr><th bgcolor="#efefef" align="right">Secci&oacute;n    </th><td>'||psSeccn||'</td>'||
             '<th bgcolor="#efefef" align="right">Cr&eacute;ditos       </th><td>'||psCredt||'</td>'||
             '<th bgcolor="#efefef" align="right">Horas totales         </th><td>'||psHoras||'</td>'||
             '<th bgcolor="#efefef" align="right">Parte del periodo     </th><td>'||psPtrm ||'</td>'||
             '</tr>'||
             '<tr><th bgcolor="#efefef" align="right">Cupo m&aacute;ximo</th><td>'||psCupMx||'</td>'||
             '<th bgcolor="#efefef" align="right">Inscritos             </th><td>'||psInscr||'</td>'||
             '<th bgcolor="#efefef" align="right">Lugares disponibles   </th><td>'||psDispn||'</td>'||
             '<th bgcolor="#efefef" align="right">Lista cruzada         </th><td>'||psLstCx||'</td>'||
             '</tr>'||
             '</table>'||
             '</td></tr>'||
             '<tr><th colspan="'||vnColumnas||'" align="left" style="border-left: 1px #ffffff;border-right: 1px #ffffff;border-top: 1px #ffffff;border-bottom: 1px #ffffff;"></th></tr>';

  end f_detalle;


  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      -- son buscados los valores de las cookies para asignar los valores del filtro del query
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

     IF ckCount != 0 THEN
        FOR vnCOKIES IN 1..ckCount LOOP
            IF    ckNOMBRES(vnCOKIES) = 'psUnive' THEN
                  vsUnive := ckValores(vnCOKIES);

            ELSIF ckNOMBRES(vnCOKIES) = 'psPerio' THEN
                  vsPerio := ckValores(vnCOKIES);

            ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                  vsFacu := ckValores(vnCOKIES);

            ELSIF ckNOMBRES(vnCOKIES) = 'psDoce' THEN
                  vsDocen := ckValores(vnCOKIES);

            ELSIF ckNOMBRES(vnCOKIES) = 'psNRC' THEN
                  vsNRC := ckValores(vnCOKIES);

            ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                  vsSeccion := ckValores(vnCOKIES);

            END IF;
        END LOOP;
     END IF;

     -- las instrucciones determinan el largo de la tabla
     FOR vnI IN 1..vnColumnas LOOP
         tabColumna.EXTEND(vnI);
         tabColumna(vnI) := NULL;
     END LOOP;

     tabColumna(1) := 'Secuencia';
     tabColumna(2) := 'Id';
     tabColumna(3) := 'Nombre';
     tabColumna(4) := 'Ausentes';
     tabColumna(5) := 'Major';

     FOR regRep IN cuReporte(vsUnive, vsPerio, vsFacu, vsDocen, vsNRC) LOOP
         FOR regReporte IN cuProceso(regRep.Periodo,regRep.Crn) LOOP
             IF 20 = vnRow OR vsFaculty IS NULL OR vsFaculty <> regRep.ID OR vsCrn <> regRep.Crn THEN
                -- el procedimiento presenta el encabezado del reporte
                Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vgsInicoPag,psSubtitulo=>'Periodo '||regRep.Periodo||'<BR>'||regRep.DescEscuela,psUsuario=>vgsUSR,psSeccion=>vsSeccion, psUniversidad=>regRep.Universidad, psDetalle=>f_detalle(regRep.Docente,regRep.Titular,regRep.Subj,regRep.Curso,regRep.Materia,regRep.CRN,regRep.Seccion,regRep.Creditos,regRep.Horas,regRep.Part_periodo,regRep.Cupo,regRep.Inscritos,regRep.Disponibles,regRep.LISTA_CRUZADA));
                vgsInicoPag := 'SALTO';

                vnRow := 0;
             END IF;

             vnRow  := vnRow  + 1;
             vnRegs := vnRegs + 1;

             htp.p('<tr>
             <td width="10%" valign="top">'||vnRegs             ||'</td>
             <td width="10%" valign="top">'||regReporte.ID      ||'</td>
             <td width="50%" valign="top">'||regReporte.Nombre  ||'</td>
             <td width="10%" valign="top"></td>
             <td width="20%" valign="top">'||regReporte.Descmajr||'</td></tr>');

             vsFaculty := regRep.ID;
             vsCrn     := regRep.Crn;

         END LOOP;

         vsFaculty := regRep.ID;

         htp.p('
         <tr><th style="border-left: 1px #ffffff;border-right: 1px #ffffff;border-bottom: 1px #ffffff;" align="right" colspan="'||(vnColumnas-2)||'">Alumnos ausentes</th>
         <td style="border-left: 1px #ffffff;border-right: 1px #ffffff;border-bottom: 1px #ffffff;" colspan="'||(vnColumnas-3)||'"></td></tr>
         <tr><th align="right" colspan="'||(vnColumnas-3)||'" bordercolor="#ffffff">Supervisor      </th>
         <td colspan="'||(vnColumnas-2)||'" bordercolor="#ffffff">__________________</td></tr>
         <tr><th align="right" colspan="'||(vnColumnas-3)||'" bordercolor="#ffffff">Alumnos ausentes</th>
         <td bordercolor="#ffffff">
         <table width="100%" bordercolor="#ffffff">
         <tr><td>__________________</td>
         <th align="right">Porcentaje de cumplimiento programa</th></tr>
         </table>
         </td>
         <td colspan="'||(vnColumnas-3)||'" bordercolor="#ffffff">__________________</td></tr>
         <tr><th align="right" colspan="'||(vnColumnas-3)||'" bordercolor="#ffffff">Copia de Examen</th>
         <td bordercolor="#ffffff">
         <table width="100%" bordercolor="#ffffff">
         <tr><td>__________________</td>
         <th align="right">Valor de reactivo</th></tr>
         </table>
         </td>
         <td colspan="'||(vnColumnas-3)||'" bordercolor="#ffffff">__________________</td></tr>

         <tr><th align="right" colspan="'||(vnColumnas-3)||'" bordercolor="#ffffff">Observaciones</th>
         <td bordercolor="#ffffff">______________________________________________________________________</td>
         <td colspan="'||(vnColumnas-3)||'" bordercolor="#ffffff"></td></tr>
         <tr><th align="right" colspan="'||(vnColumnas-3)||'" bordercolor="#ffffff"></th>
         <td bordercolor="#ffffff">______________________________________________________________________</td>
         <td colspan="'||(vnColumnas-3)||'" bordercolor="#ffffff"></td></tr>
         <tr><th align="right" colspan="'||(vnColumnas-3)||'" bordercolor="#ffffff"></th>
         <td bordercolor="#ffffff">______________________________________________________________________</td>
         <td colspan="'||(vnColumnas-3)||'" bordercolor="#ffffff"></td></tr>
         <tr><td colspan="'||vnColumnas||'" bordercolor="#ffffff">
         <table border="0" width="100%" bordercolor="#ffffff">
         <tr><td width="20%"></td>
             <th width="20%" valign="bottom">__________________________________</th>
             <td width="20%"></td>
             <th width="20%" valign="bottom">__________________________________</th>
             <td width="20%"></td></tr>
         <tr><td></td>
             <th valign="top">Firma del profesor</th>
             <td></td>
             <th valign="top">Firma Auditoria</th>
             <td></td></tr>
         </table>
         </td></tr>
         ');

         vnRegs   := 0;
         vnExists := 1;
     END LOOP;

     IF vnExists = 0 THEN
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');

     ELSE
        -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pagina
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>vgsUSR, psSeccion=>vsSeccion);

     END IF;

     htp.p('</table></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
               HTP.P(SQLERRM);

  END PWRLIAS;
/


DROP PUBLIC SYNONYM PWRLIAS;

CREATE PUBLIC SYNONYM PWRLIAS FOR BANINST1.PWRLIAS;


GRANT EXECUTE ON BANINST1.PWRLIAS TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRLIAS TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRLICO;

CREATE OR REPLACE PROCEDURE BANINST1.PWRLICO (psReclDesc VARCHAR2)
IS
   vnRow         INTEGER := 0;
   vnExists      INTEGER := 0;
   vnColumnas    INTEGER := 5;
   vsProg       smrprle.smrprle_program_desc%TYPE;
   vsVia        stvstst.stvstst_code%TYPE;
   vsTyAl       stvstyp.stvstyp_code%TYPE;
   vsPerio      stvterm.stvterm_code%TYPE;
   vsCont       twbcntr.twbcntr_num%TYPE;
   vsPidm       TWRCRAL.TWRCRAL_PIDM%TYPE;
   tabColumna   Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla (1);
   vsInicioPag   VARCHAR2 (10) := NULL;
CURSOR cuABCDE (vsCont in twbcntr.twbcntr_num%TYPE)
  IS
        select 1
             , 'Contrato'                                                                                               modulo
             , TWBCNTR_NUM                                                                                              operacion
             , to_char(TWBCNTR_ISSUE_DATE, 'dd/mm/yyyy HH24:MI:SS')                                                     fecha
             , TWBCNTR_ISSUE_USER                                                                                       usuario
             , pk_util.f_LigaBaseSSB||'pk_Contrato.p_Contrato?psCntr='||TWBCNTR_NUM                                     liga
        from TWBCNTR
        where TWBCNTR_NUM = vsCont
    union
        Select 2
             , 'Reprogramacin'                                                                                         modulo
             , to_char(TWBRPRG_NUM)                                                                                     operacion
             , to_char(TWBRPRG_RPRG_DATE, 'dd/mm/yyyy HH24:MI:SS')                                                                                        fecha
             , TWBRPRG_RPRG_USER                                                                                        usuario
             , pk_util.f_LigaBaseSSB||'pk_MatRepro.p_Comprobante?psNumRepro='||TWBRPRG_NUM                              liga
        from TWBRPRG
        where TWBRPRG_CNTR_NUM = vsCont
    union
        select 3
             , 'Tesorera'                                                                                              modulo
             , to_char(TWBTESO_NUM)                                                                                     operacion
             , to_char(TWBTESO_DATE, 'dd/mm/yyyy HH24:MI:SS')                                                                                             fecha
             , TWBTESO_TESO_USER                                                                                        usuario
             , pk_util.f_LigaBaseSSB||'pk_Tesoreria.p_Recibo?psNumTeso='||TWBTESO_NUM                                   liga
        from TWBTESO
        where TWBTESO_CNTR_NUM = vsCont
    union
        select 4
             , 'Minuta de devolucin'                                                                                   modulo
             , to_char(TWBMIDE_NUM)                                                                                     operacion
             , to_char(TWBMIDE_ISSUE_DATE, 'dd/mm/yyyy HH24:MI:SS')                                                                                       fecha
             , TWBMIDE_ISSUE_USER                                                                                       usuario
             , pk_util.f_LigaBaseSSB||'pk_MatMinutaDev.p_Comprobante?psNumMinu='||TWBMIDE_NUM                           liga
        from TWBMIDE
        where TWBMIDE_CNTR_NUM = vsCont
    union
        select 5
             , 'Retracto'                                                                                               modulo
             , to_char(TWBRETR_NUM)                                                                                     operacion
             , to_char(TWBRETR_DATE, 'dd/mm/yyyy HH24:MI:SS')                                                                                             fecha
             , TWBRETR_USER                                                                                             usuario
             , pk_util.f_LigaBaseSSB||'pk_Retracto.p_Comprobante?psNumRetr='||TWBRETR_NUM                               liga
        from TWBRETR
        where TWBRETR_CNTR_NUM = vsCont
    union
        select 6
             , 'Congelacin'                                                                                            modulo
             , to_char(TWBCONG_NUM)                                                                                     operacion
             , to_char(TWBCONG_CONG_DATE, 'dd/mm/yyyy HH24:MI:SS')                                                                                        fecha
             , TWBCONG_CONG_USER                                                                                        usuario
             ,pk_util.f_LigaBaseSSB||'pk_Congelacion.p_Comprobante?psNumCong='||TWBCONG_NUM                             liga
        from TWBCONG
        where TWBCONG_CNTR_NUM = vsCont
    order by 1, 3;

BEGIN

   IF Pk_Login.F_ValidacionDeAcceso (pk_login.vgsUSR)
   THEN
      RETURN;
   END IF;

    /* Parmetros */
    --Se busca el valor de la cookie (parmetro) para asignarlo al filtro del query.
    vsProg  := pk_ObjHtml.getValueCookie ('psProgr');
    vsVia  := pk_ObjHtml.getValueCookie ('psVia');
    vsTyAl   := pk_ObjHtml.getValueCookie ('psTiPo');
    vsPerio   := pk_ObjHtml.getValueCookie ('psPerio');
    vsCont   := pk_ObjHtml.getValueCookie ('psCont');

  -- Nmero de columnas de la tabla --
   FOR vnI IN 1 .. vnColumnas
   LOOP
      tabColumna.EXTEND (vnI);
      tabColumna (vnI) := NULL;
   END LOOP;

   /* Encabezado de las columnas */
   tabColumna (1) := 'Modulo';
   tabColumna (2) := 'Nmero Operacin';
   tabColumna (3) := 'Fecha Operacin';
   tabColumna (4) := 'Usuario';
   tabColumna (5) := 'Link';

      FOR regRep IN cuABCDE(vsCont) LOOP
          IF vnRow = 0 THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag);
             vsInicioPag := 'SALTO';
             vnRow  := 0;
          END IF;

          htp.p(
          '<tr>
          <td valign="top">'||regRep.modulo||'</td>
          <td valign="top">'||regRep.operacion||'</td>
          <td valign="top">'||regRep.fecha||'</td>
          <td valign="top">'||regRep.usuario||'</td>
          <td valign="top"><a href='||regRep.liga||'  target="_blank">'||regRep.liga||'</a></td>');

          vnExists   := 1;
          vnRow      := vnRow + 1;
      END LOOP;

   IF vnExists = 0
   THEN
      HTP.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- es omitido el encabezado del reporte pero se agrega el salto de pagina
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
   END IF;

   HTP.p ('</table><br/></body></html>');
EXCEPTION
   WHEN OTHERS
   THEN
      HTP.P (SQLERRM);
END PWRLICO;
/


DROP PUBLIC SYNONYM PWRLICO;

CREATE PUBLIC SYNONYM PWRLICO FOR BANINST1.PWRLICO;


GRANT EXECUTE ON BANINST1.PWRLICO TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRLICO TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRLICO TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRLICO TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRLICO TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRLIMO;

CREATE OR REPLACE PROCEDURE BANINST1.PWRLIMO (psReclDesc   VARCHAR2) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de historia acadmica
        mdulo: admisiones - uft.
         autor: hmr - socorro crdenas.
         fecha:13/07/2012.


*******************************************************************************/

  -- declaracin de variables:
  vnExists       INTEGER      := 0;
  vnColumnas     INTEGER      := 15;
  vgsInicioPag   VARCHAR2(30) := NULL;         -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vnIdRenglon    INTEGER      := 1;
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);

  vsTerm        SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE	DEFAULT NULL;
  vsEscu	SGBSTDN.SGBSTDN_COLL_CODE_1%TYPE	DEFAULT NULL;


  -- obtiene la informacin de los alumnos:
  CURSOR cuReporte (	psTerm		VARCHAR2  DEFAULT NULL,
                        psEscu		VARCHAR2  DEFAULT NULL) IS
	SELECT	DISTINCT SSBSECT_TERM_CODE PERIODO_NRC
		,SSBSECT_CRN NRC
        ,SSBSECT_SUBJ_CODE MATERIA
        ,SSBSECT_CRSE_NUMB CRSE
		,SSBSECT_SEQ_NUMB SECCION
		,SSBSECT_SESS_CODE SESION
		,SCBCRSE_TITLE TITULO_CURSO
		,SPRIDEN_ID ID_Docente
		,SPRIDEN_FIRST_NAME Nombre_Docente
		,SPRIDEN_LAST_NAME Apellido_Docente
		,DECODE(SIBINST_SCHD_IND, 'Y',1,0) docente
		,DECODE(SIBINST_ADVR_IND, 'Y',1,0) asesor
		,(SELECT STVFCTG_DESC FROM STVFCTG
			 WHERE SIBINST_FCTG_CODE   =  STVFCTG_CODE )CATEGORIA
        ,(SELECT STVCOLL_DESC FROM STVCOLL, SIRDPCL s1
                where s1.SIRDPCL_TERM_CODE_EFF = (select  MAX(s.SIRDPCL_TERM_CODE_EFF) from SIRDPCL s where s.SIRDPCL_PIDM=s1.SIRDPCL_PIDM)
                AND STVCOLL_CODE=S1.SIRDPCL_COLL_CODE
                AND S1.SIRDPCL_PIDM = SIBINST_PIDM
                --and s1.SIRDPCL_HOME_IND = 'Y'
                and rownum = 1) ESCUELA
		,(SELECT GOREMAL_EMAIL_ADDRESS from goremal
			where GOREMAL_EMAL_CODE = 'UFT'
			AND GOREMAL_PIDM = SIRASGN_PIDM) Correo_UFT
	FROM SIBINST A, SPRIDEN, SSBSECT, SIRASGN, SCBCRSE E
	WHERE A.SIBINST_PIDM = SPRIDEN_PIDM
	 AND A.SIBINST_PIDM = SIRASGN_PIDM
	 AND SSBSECT_TERM_CODE = SIRASGN_TERM_CODE
      AND (SCBCRSE_COLL_CODE                 = psEscu OR psEscu IS NULL)
	 AND SSBSECT_TERM_CODE = nvl(psTerm,SSBSECT_TERM_CODE)
	 AND SSBSECT_CRN = SIRASGN_CRN
     --AND SIRASGN_PRIMARY_IND = 'Y'
	 AND SSBSECT_SUBJ_CODE = E.SCBCRSE_SUBJ_CODE
	 AND SSBSECT_CRSE_NUMB = E.SCBCRSE_CRSE_NUMB
	 AND A.SIBINST_TERM_CODE_EFF = (SELECT MAX(B.SIBINST_TERM_CODE_EFF) FROM SIBINST B
                                                            WHERE A.SIBINST_PIDM = B.SIBINST_PIDM)
	 AND E.SCBCRSE_EFF_TERM = (SELECT MAX(D.SCBCRSE_EFF_TERM) FROM SCBCRSE D
                                                WHERE E.SCBCRSE_SUBJ_CODE = D.SCBCRSE_SUBJ_CODE
                                                AND E.SCBCRSE_CRSE_NUMB = D.SCBCRSE_CRSE_NUMB)
	 AND SPRIDEN_CHANGE_IND IS NULL
     order by ssbsect_crn;
---------------------------------------------------
-- bloque principal para la generacin del reporte
---------------------------------------------------
BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
   vsEscu := pk_ObjHtml.getValueCookie('psEscu');

   -- determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   -- define los encabezados de las columnas:
   tabColumna(1)  := '<left> Perodo NRC';
   tabColumna(2)  := '<left> NRC';
   tabColumna(3)  := '<left> Materia';
   tabColumna(4)  := '<left> Nmero de Curso';
   tabColumna(5)  := '<left> Seccin';
   tabColumna(6)  := '<left> Sesin';
   tabColumna(7)  := '<left> Nombre NRC';
   tabColumna(8)  := '<left> ID Docente';
   tabColumna(9)  := '<left> Nombre Docente';
   tabColumna(10)  := '<left> Apellido Docente';
   tabColumna(11)  := '<left> Docente';
   tabColumna(12) := '<left> Asesor';
   tabColumna(13) := '<left> Categora';
   tabcolumna(14) := '<left> Escuela';
   tabColumna(15) := '<left> Correo UFT ';

IF vsEscu = 'ZZ' THEN vsEscu := NULL; END IF;

   -- manipula la informacin obtenida por el cursor:
   FOR regRep IN cuReporte (vsTerm,vsEscu) LOOP

       IF vnExists = 0 THEN

          -- muestra el encabezado segn el periodo y programa seleccionados:
          IF vsEscu IS NOT NULL THEN
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||'<br>'||'Escuela: &nbsp;'||vsEscu||' - '||Pk_Catalogo.Colegio(vsEscu),
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
          ELSE
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||'<br>'||'Escuela: &nbsp;'||'Todos ',
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
          END IF;

       END IF;

       -- muestra los valores para cada registro:
       HTP.P('<tr> <td valign="top" align="left">'   ||regRep.PERIODO_NRC              ||'</td>
                   <td valign="top" align="left">'   ||regRep.NRC			||'</td>
                   <td valign="top" align="left">'   ||regRep.MATERIA            ||'</td>
                   <td valign="top" align="left">'   ||regRep.CRSE            ||'</td>
                   <td valign="top" align="left">'   ||regRep.SECCION			||'</td>
                   <td valign="top" align="left">'   ||regRep.SESION			||'</td>
                   <td valign="top" align="left">'   ||regRep.TITULO_CURSO		||'</td>
                   <td valign="top" align="left">'   ||regRep.ID_Docente		||'</td>
                   <td valign="top" align="left">'  ||regRep.Nombre_Docente		||'</td>
		            <td valign="top" align="left">'  ||regRep.Apellido_Docente		||'</td>
                   <td valign="top" align="left">'  ||regRep.Docente			||'</td>
                   <td valign="top" align="left">' ||regRep.Asesor			||'</td>
                   <td valign="top" align="left">' ||regRep.CATEGORIA			||'</td>
                   <td valign="top" align="left">' ||regRep.ESCUELA			||'</td>
                   <td valign="top" align="left">' ||regRep.Correo_UFT			||'</td>
             </tr>');

       vnExists    := 1;
       vnIdRenglon := vnIdRenglon + 1;
   -- END IF;
   END LOOP;

   -- muestra el pie de reporte:
   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- omite el encabezado del reporte pero se agrega el salto de pgina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRLIMO;
/


DROP PUBLIC SYNONYM PWRLIMO;

CREATE PUBLIC SYNONYM PWRLIMO FOR BANINST1.PWRLIMO;


GRANT EXECUTE ON BANINST1.PWRLIMO TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRLSAL;

CREATE OR REPLACE PROCEDURE BANINST1.PWRLSAL(psReclDesc VARCHAR2) IS

/*
         Tarea: REPORTE: LISTADO DE ASIGNATURAS
         Fecha: 11/02/2011.
         Autor: MAC


*/

ckNombres   owa_cookie.vc_arr;
ckValores   owa_cookie.vc_arr;
ckCount     INTEGER;
vgsInicoPag VARCHAR2(10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de p?gina para impresion
vgsUSR      VARCHAR2(500);

  vnExists   INTEGER                                := 0;
  vnColumnas INTEGER                                := 19;
  tabColumna Pk_Sisrepimp.tipoTabla                 := Pk_Sisrepimp.tipoTabla(1);
  vsPerio    SCBCRSE.SCBCRSE_EFF_TERM%TYPE          := NULL;
  vsNivel    VARCHAR2(30)                           := NULL;
  vsSUBJc    SCBCRSE.SCBCRSE_SUBJ_CODE%TYPE         := NULL;
  vsModo     varchar2(50):= null;
  vsEscu     SCBCRSE.SCBCRSE_COLL_CODE%TYPE         := NULL;
  vsArea     SCBSUPP.SCBSUPP_CUDA_CODE%TYPE         := NULL;
  vsAtributo SCRATTR.SCRATTR_ATTR_CODE%TYPE         := NULL;
  vsCoord    SCBSUPP.SCBSUPP_TOPS_CODE%TYPE         := NULL;
  vsSeccion  VARCHAR2(3)                            := NULL;
  vsTitulo   SCRSYLN.SCRSYLN_LONG_COURSE_TITLE%TYPE := NULL;

  CURSOR cuReporte(psEscu  VARCHAR2 DEFAULT NULL,
                   psPerio VARCHAR2 DEFAULT NULL) IS
         SELECT SCBCRSE_EFF_TERM                            termCode,
                PK_Catalogo.Periodo(SCBCRSE_EFF_TERM)       termDesc,
                SCBCRSE_COLL_CODE                           collCode,
                PK_Catalogo.Colegio(SCBCRSE_COLL_CODE)      collDesc,
                SCBCRSE_SUBJ_CODE                           SUBJ,
                SCBCRSE_CRSE_NUMB                           CRSE,
                SCBCRSE_LEC_HR_LOW                          LEC,
                SCBCRSE_LAB_HR_LOW                          LAB,
                SCBCRSE_CSTA_CODE       STATUS,
                (SELECT STVCSTA_DESC FROM STVCSTA
                WHERE STVCSTA_CODE = SCBCRSE_CSTA_CODE)  DESC_STATUS,
                (
                SELECT A.SCRATTR_ATTR_CODE FROM SCRATTR A
                WHERE A.SCRATTR_SUBJ_CODE = SCBCRSE_SUBJ_CODE
                AND A.SCRATTR_CRSE_NUMB = SCBCRSE_CRSE_NUMB
                and rownum = 1  --md-01
                AND A.SCRATTR_EFF_TERM = (SELECT MAX(B.SCRATTR_EFF_TERM) FROM SCRATTR B
                       WHERE A.SCRATTR_SUBJ_CODE = B.SCRATTR_SUBJ_CODE
                                            AND A.SCRATTR_CRSE_NUMB = B.SCRATTR_CRSE_NUMB)) ATRIBUTO,
                (
                SELECT STVATTR_DESC FROM SCRATTR A, STVATTR
                WHERE A.SCRATTR_SUBJ_CODE = SCBCRSE_SUBJ_CODE
                AND A.SCRATTR_CRSE_NUMB = SCBCRSE_CRSE_NUMB
                AND STVATTR_CODE = A.SCRATTR_ATTR_CODE
                and rownum = 1  --md-01
                AND A.SCRATTR_EFF_TERM = (SELECT MAX(B.SCRATTR_EFF_TERM) FROM SCRATTR B
                       WHERE A.SCRATTR_SUBJ_CODE = B.SCRATTR_SUBJ_CODE
                                            AND A.SCRATTR_CRSE_NUMB = B.SCRATTR_CRSE_NUMB)) DESC_ATRIBUTO,
                SCBCRSE_CREDIT_HR_LOW                       CRED,
                SCBCRSE_CONT_HR_LOW                         HoraSemana,
                SUPP.TOPS                                   TOPS,
                PK_Catalogo.Coordinacion(SUPP.TOPS)         DTOPS,
                SUPP.ANT                                    ANTERIOR,
                SCBCRSE_REPEAT_LIMIT                        LIM
           FROM SCBCRSE H,
                (SELECT E.SCBSUPP_TOPS_CODE TOPS,
                        E.SCBSUPP_SUBJ_CODE SUBJ,
                        E.SCBSUPP_CRSE_NUMB CRSE,
                        E.SCBSUPP_PERM_DIST_IND ANT
                   FROM SCBSUPP E
                  WHERE E.SCBSUPP_EFF_TERM = (SELECT MAX(F.SCBSUPP_EFF_TERM)
                                                FROM SCBSUPP F
                                               WHERE F.SCBSUPP_SUBJ_CODE = E.SCBSUPP_SUBJ_CODE
                                                 AND F.SCBSUPP_CRSE_NUMB = E.SCBSUPP_CRSE_NUMB
                                                -- AND F.SCBSUPP_EFF_TERM <= E.SCBSUPP_EFF_TERM
                                             )
                  ) SUPP
          WHERE SCBCRSE_SUBJ_CODE       = SUPP.SUBJ(+)
            AND SCBCRSE_CRSE_NUMB       = SUPP.CRSE(+)
            AND (SCBCRSE_COLL_CODE = psEscu  OR psEscu  IS NULL)
            AND H.SCBCRSE_EFF_TERM = (SELECT MAX(I.SCBCRSE_EFF_TERM)
                                        FROM SCBCRSE I
                                       WHERE I.SCBCRSE_SUBJ_CODE = H.SCBCRSE_SUBJ_CODE
                                         AND I.SCBCRSE_CRSE_NUMB = H.SCBCRSE_CRSE_NUMB
                                         AND (I.SCBCRSE_EFF_TERM <= psPerio OR psPerio IS NULL)
                                     )
          ORDER BY SCBCRSE_EFF_TERM DESC, collDesc, SCBCRSE_SUBJ_CODE, SCBCRSE_CRSE_NUMB;

           CURSOR cuModo(psSubj VARCHAR2 DEFAULT NULL, psCrse VARCHAR DEFAULT NULL) IS

           SELECT DISTINCT B.SCRGMOD_GMOD_CODE modoCalif FROM SCRGMOD B
           WHERE  B.SCRGMOD_SUBJ_CODE = psSubj
           AND B.SCRGMOD_CRSE_NUMB = psCrse
          AND B.SCRGMOD_EFF_TERM  = (SELECT MAX(I.SCRGMOD_EFF_TERM)
                                                          FROM SCRGMOD I
                                                         WHERE I.SCRGMOD_SUBJ_CODE = B.SCRGMOD_SUBJ_CODE
                                                           AND I.SCRGMOD_CRSE_NUMB = B.SCRGMOD_CRSE_NUMB
                                                       )
           ORDER BY B.SCRGMOD_GMOD_CODE;

           CURSOR cuNivel(psSubj VARCHAR2 DEFAULT NULL, psCrse VARCHAR DEFAULT NULL) IS
           SELECT DISTINCT A.SCRLEVL_LEVL_CODE Nivel FROM SCRLEVL A
           WHERE A.SCRLEVL_SUBJ_CODE       = psSubj
            AND  A.SCRLEVL_CRSE_NUMB       = psCrse
            AND A.SCRLEVL_EFF_TERM      = (SELECT MAX(B.SCRLEVL_EFF_TERM)
                                             FROM SCRLEVL B
                                            WHERE B.SCRLEVL_SUBJ_CODE = A.SCRLEVL_SUBJ_CODE
                                              AND B.SCRLEVL_CRSE_NUMB = A.SCRLEVL_CRSE_NUMB);



  -- se busca el titulo de la materia
  CURSOR cuTitulo(psSUBJ VARCHAR2,
                  psCRSE VARCHAR2,
                  psTerm VARCHAR2) IS
         SELECT NVL(scbcrse_title, SCRSYLN_LONG_COURSE_TITLE) Title
           FROM SCBCRSE D,
          (SELECT SCRSYLN_CRSE_NUMB, SCRSYLN_SUBJ_CODE, SCRSYLN_LONG_COURSE_TITLE FROM SCRSYLN C
          WHERE C.SCRSYLN_TERM_CODE_EFF = (SELECT MAX(F.SCRSYLN_TERM_CODE_EFF)
                                             FROM SCRSYLN F
                                            WHERE F.SCRSYLN_SUBJ_CODE      = psSUBJ
                                              AND F.SCRSYLN_CRSE_NUMB      = psCRSE
                                              AND F.SCRSYLN_TERM_CODE_EFF <= psTerm)
                                          ) SCRSYLN
          WHERE D.SCBCRSE_CRSE_NUMB = psCRSE
            AND D.SCBCRSE_SUBJ_CODE = psSUBJ
            AND D.SCBCRSE_CRSE_NUMB = SCRSYLN_CRSE_NUMB(+)
            AND D.SCBCRSE_SUBJ_CODE = SCRSYLN_SUBJ_CODE(+)
            AND D.SCBCRSE_EFF_TERM = (SELECT MAX(G.SCBCRSE_EFF_TERM)
                                             FROM SCBCRSE G
                                            WHERE G.SCBCRSE_SUBJ_CODE      = psSUBJ
                                              AND G.SCBCRSE_CRSE_NUMB      = psCRSE
                                              AND G.SCBCRSE_EFF_TERM <= psTerm
                                          );

  BEGIN
      /* Check/update the user's web session */
      IF PK_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      -- Son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
         FOR vnCOKIES IN 1..ckCount LOOP
             IF ckNOMBRES(vnCOKIES) = 'psEscu' THEN
                   vsEscu := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psPerio' THEN
                   vsPerio := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                   vsSeccion := ckValores(vnCOKIES);

             END IF;
         END LOOP;
      END IF;

      -- las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := 'Periodo';
      tabColumna(2)  := 'Descripci&oacute;n Periodo';
      tabColumna(3)  := 'Escuela';
      tabColumna(4)  := 'Descripci&oacute;n Escuela';
      tabColumna(5)  := 'Ramo';
      tabColumna(6)  := 'Clave Sistema';
      tabColumna(7)  := 'Descripci&oacute;n del Ramo';
      tabColumna(8)  := 'Nivel';
      tabColumna(9)  := 'Horas Te&oacute;ricas';
      tabColumna(10) := 'Horas Pr&aacute;cticas';
      tabColumna(11) := 'Horas a la semana';
      tabColumna(12) := 'Cr&eacute;ditos';
      tabColumna(13) := 'TOPS';
      tabColumna(14) := 'Limite de Repeticiones';
      tabColumna(15) := 'Modo de calificaci&oacute;n';
      tabColumna(16) := 'C&oacute;digo Estatus ';
      tabColumna(17) := 'Descripci&oacute;n Estatus';
      tabColumna(18) := 'C&oacute;digo Atributo';
      tabColumna(19) := 'Descripci&oacute;n Atributo';
--htp.p(' vsEscu= ' || vsEscu || ' vsPerio= ' ||  vsPerio || ' vsNivel= ' ||  vsNivel || ' vsSUBJc= ' ||  vsSUBJc || ' vsCoord= ' ||  vsCoord || ' vsArea= ' ||  vsArea || ' vsAtributo= ' ||  vsAtributo || ' vsModo= ' ||  );
      FOR regRep IN cuReporte(vsEscu,vsPerio) LOOP
          IF vnExists = 0 THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,vgsInicoPag,'1', psUsuario=>vgsUSR, psSeccion=>vsSeccion);
             vgsInicoPag := 'SALTO';
          END IF;

          FOR regTil IN cuTitulo(regRep.SUBJ, regRep.CRSE, regRep.termCode) LOOP
              vsTitulo := regTil.Title;
          END LOOP;

          htp.p('<tr>
          <td valign="top">'||regRep.termCode||'</td>
          <td valign="top">'||regRep.termDesc||'</td>
          <td valign="top">'||regRep.collCode||'</td>
          <td valign="top">'||regRep.collDesc||'</td>
          <td valign="top">'||regRep.SUBJ    ||' '||regRep.CRSE||'</td>
          <td valign="top">'||regRep.ANTERIOR ||'</td>
          <td valign="top">'||vsTitulo       ||'</td>');
          vsNivel := '';
          FOR regNivel IN cuNivel(regRep.SUBJ,regRep.CRSE) LOOP
              vsNivel := vsNivel || ' ' || regNivel.Nivel ;
          END LOOP;

        htp.p('
          <td valign="top">'||vsNivel ||'</td>');
          htp.p('
          <td valign="top">'||regRep.LEC     ||'</td>
          <td valign="top">'||regRep.LAB     ||'</td>
          <td valign="top">'||regRep.HoraSemana||'</td>
          <td valign="top">'||regRep.CRED    ||'</td>
          <td valign="top">'||regRep.TOPS    ||' '||regRep.DTOPS||'</td>
          <td valign="top">'||regRep.LIM    ||'</td>
          ');
          vsModo := '';
          FOR regModo in cuModo(regRep.SUBJ,regRep.CRSE) loop
          vsModo := vsModo || ' ' || regModo.modoCalif ;


          end loop;

htp.p('<td valign="top">'||vsModo||'</td>');
htp.p('<td valign="top">'||regRep.status||'</td>');
htp.p('<td valign="top">'||regRep.desc_status||'</td>');
htp.p('<td valign="top">'||regRep.atributo||'</td>');
htp.p('<td valign="top">'||regRep.desc_atributo||'</td>');
          htp.p('</tr>');

          vnExists := 1;
          vsTitulo := NULL;
      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de p?gina para impresion
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>vgsUSR, psSeccion=>vsSeccion);
      END IF;

      htp.p('</table></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           htp.P(SQLERRM);
  END PWRLSAL;
/


DROP PUBLIC SYNONYM PWRLSAL;

CREATE PUBLIC SYNONYM PWRLSAL FOR BANINST1.PWRLSAL;


GRANT EXECUTE ON BANINST1.PWRLSAL TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRLSAL TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRLTAS;

CREATE OR REPLACE PROCEDURE BANINST1.PWRLTAS (psReclDesc   VARCHAR2) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de listas de asistencia.
        mdulo: toma de ramos.
         autor: horacio martnez ramrez - hmr.
         fecha: 19/11/2010.

  modificacin: 25/03/2011 - hmr.
                se agreg la numeracin por hoja, se dividi en 25 registros
                por pgina y se agregaron algunas columnas en blanco.

  modificacin: 01/09/2011 - hmr.
                se agreg una validacin en el cursor "cureporte" para que
                considere solamente los profesores titulares.
*******************************************************************************/

  vnRow          INTEGER                := 0;
  vnHoja         INTEGER                := 0;                       -- cuenta registros para corte de pgina
  vnParte        INTEGER                := 0;
  vsParte        VARCHAR2(30)           := '';
  vnExists       INTEGER                := 0;
  vnColumnas     INTEGER                := 20;
  vnRegs         INTEGER                := 0;
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vsSeccion      VARCHAR2(3)            := NULL;
  vsUnive        VARCHAR2(100)          := NULL;
  vsPerio        VARCHAR2(100)          := NULL;
  vsDocen        VARCHAR2(100)          := NULL;
  vsFacu         VARCHAR2(100)          := NULL;
  vsNRC          VARCHAR2(100)          := NULL;

  vsEtiqueta     VARCHAR2(100)          := NULL;
  vsPtrm         VARCHAR2(6)            := NULL;
  vsSede         VARCHAR2(10)           := NULL;
  vsDeptCode     VARCHAR2(10)           := NULL;
  vsInicioPag    VARCHAR2(10)           := NULL;

  vnRegsTot      INTEGER                := 0;

  CURSOR cuReporte ( psUnive  VARCHAR2 DEFAULT NULL,
                     psPerio  VARCHAR2 DEFAULT NULL,
                     psFacu   VARCHAR2 DEFAULT NULL,
                     psDoce   VARCHAR2 DEFAULT NULL,
                     psNRC    VARCHAR2 DEFAULT NULL,
                     psPtrm   VARCHAR2 DEFAULT NULL,
                     psSede   VARCHAR2 DEFAULT NULL ) IS

         SELECT SS.SSBSECT_TERM_CODE                                 AS TERMCODE,
                SSBSECT_CAMP_CODE                                    AS CAMPCODE,
              --pk_catalogo.universidad(ssbsect_camp_code)           desc_universidad,
                SCBCRSE_COLL_CODE                                    AS CVEESCUELA,
                Pk_Catalogo.COLEGIO(SCBCRSE_COLL_CODE)               AS DESCESCUELA,
                SPRIDEN_ID                                           AS ID,
                PROFESOR.PIDM                                        AS PIDM,
                UPPER(REPLACE(REPLACE(SPRIDEN_LAST_NAME||' '||
                SPRIDEN_FIRST_NAME||' '||
                SPRIDEN_MI,'','&ntilde;'),'*',' '))                 AS DOCENTE,
                SPBPERS_NAME_SUFFIX                                  AS RUT,
                SCBCRSE_SUBJ_CODE                                    AS SUBJ,
                SCBCRSE_CRSE_NUMB                                    AS CURSO,
                SCBCRSE_TITLE                                        AS MATERIA,
                SSBSECT_CRN                                          AS CRN,
                SS.SSBSECT_SEQ_NUMB                                  AS SECCION,
                SCBCRSE_CREDIT_HR_LOW                                AS CREDITOS,
                NVL(NVL(SSBSECT_LAB_HR,SCBCRSE_LAB_HR_LOW),0) +
                NVL(NVL(SSBSECT_LEC_HR,SCBCRSE_LEC_HR_LOW),0) +
                NVL(NVL(SSBSECT_OTH_HR,SCBCRSE_OTH_HR_LOW),0)        AS HORAS,
                SSBSECT_PTRM_START_DATE||' '||SSBSECT_PTRM_END_DATE  AS PART_PERIODO,
                SSBSECT_MAX_ENRL                                     AS CUPO,
                SSBSECT_ENRL                                         AS INSCRITOS,
                NVL(SSBSECT_MAX_ENRL,0) -  NVL(SSBSECT_ENRL,0)       AS DISPONIBLES,
                DECODE(PROFESOR.INDICADOR,'Y','TITULAR')             AS TITULAR,
                SSRXLST_XLST_GROUP                                   AS LISTA_CRUZADA,
                SIRDPC.DEPTSEDE                                      AS DEPTSEDE
           FROM SSBSECT SS,
                SCBCRSE,
                ( SELECT DISTINCT SIRASGN_PIDM  AS PIDM,
                         SSRMEET_TERM_CODE      AS PERIODO,
                         SIRASGN_CRN            AS CRN,
                         SIRASGN_PRIMARY_IND    AS INDICADOR
                    FROM SSRMEET,
                         SIRASGN
                   WHERE SSRMEET_TERM_CODE   = SIRASGN_TERM_CODE
                     AND SSRMEET_CRN         = SIRASGN_CRN
                     AND SIRASGN_PRIMARY_IND = 'Y'
                     AND SSRMEET_CATAGORY    = SIRASGN_CATEGORY )      PROFESOR,
                SPRIDEN,
                SPBPERS,
                SSRXLST,
                ( SELECT SIRDPCL_PIDM            DPCLPIDM,
                         SIRDPCL_DEPT_CODE       DEPTSEDE
                    FROM SIRDPCL A
                   WHERE SIRDPCL_HOME_IND      = 'Y'
                     AND SIRDPCL_TERM_CODE_EFF = ( SELECT MAX(SI.SIRDPCL_TERM_CODE_EFF)
                                                     FROM SIRDPCL SI
                                                    WHERE SI.SIRDPCL_PIDM            = A.SIRDPCL_PIDM
                                                      AND (SI.SIRDPCL_TERM_CODE_EFF <= psPerio OR psPerio IS NULL)  )  ) SIRDPC
          WHERE SSBSECT_SUBJ_CODE   = SCBCRSE_SUBJ_CODE
            AND SSBSECT_CRSE_NUMB   = SCBCRSE_CRSE_NUMB
            AND SCBCRSE_EFF_TERM    = ( SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                          FROM SCBCRSE SC
                                         WHERE SC.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                           AND SC.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                           AND SC.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB )
            AND SSBSECT_TERM_CODE   = PROFESOR.PERIODO(+)
            AND SSBSECT_CRN         = PROFESOR.CRN(+)
            AND PROFESOR.PIDM       = SPRIDEN_PIDM(+)
            AND PROFESOR.PIDM       = SPBPERS_PIDM(+)
            AND PROFESOR.PIDM       = SIRDPC.DPCLPIDM(+)
            AND SPRIDEN_CHANGE_IND IS NULL
            AND SSBSECT_TERM_CODE   = SSRXLST_TERM_CODE(+)
            AND SSBSECT_CRN         = SSRXLST_CRN(+)
            AND EXISTS ( SELECT NULL
                           FROM SFRSTCR
                          WHERE SFRSTCR_CAMP_CODE  = SS.SSBSECT_CAMP_CODE
                            AND SFRSTCR_TERM_CODE  = SS.SSBSECT_TERM_CODE
                            AND SFRSTCR_CRN        = SS.SSBSECT_CRN
                            AND SFRSTCR_RSTS_CODE IN ('RE','RW')  )
            AND (SS.SSBSECT_CAMP_CODE = psUnive OR psUnive IS NULL)
            AND (SS.SSBSECT_TERM_CODE = psPerio OR psPerio IS NULL)
            AND (SCBCRSE_COLL_CODE    = psFacu  OR psFacu  IS NULL)
            AND (PROFESOR.PIDM        = psDoce  OR psDoce  IS NULL)
            AND (SSBSECT_CRN          = psNRC   OR psNRC   IS NULL)
            AND (SSBSECT_PTRM_CODE    = psPtrm  OR psPtrm  IS NULL)
          --and (sirdpc.deptsede      = pssede  or pssede  is null)
          ORDER BY TERMCODE DESC, DEPTSEDE, DESCESCUELA, MATERIA, DOCENTE;

  -- cursor para obtener los estudiantes del crn:
  CURSOR cuProceso ( psPerio   VARCHAR2,
                     psCrn     VARCHAR2 ) IS

         SELECT SFRSTCR_REG_SEQ                                            AS SECUENCIA,
                SPRIDEN_PIDM                                               AS PIDM,
                SPRIDEN_ID                                                 AS ID,
                UPPER(REPLACE(REPLACE(SPRIDEN_LAST_NAME ||' '||
                                      SPRIDEN_FIRST_NAME||' '||
                                      SPRIDEN_MI,'','&ntilde;'),'*',' ')) AS NOMBRE,
                SPBPERS_NAME_SUFFIX                                        AS RUT,
                SGBSTDN_MAJR_CODE_1                                        AS CVEMAJR,
                UPPER(Pk_Catalogo.Carrera(SGBSTDN_MAJR_CODE_1))            AS DESCMAJR
           FROM SGBSTDN A,
                SPRIDEN,
                SFRSTCR,
                SPBPERS
          WHERE SPRIDEN_PIDM            = A.SGBSTDN_PIDM
            AND SPRIDEN_PIDM            = SPBPERS_PIDM
            AND SPRIDEN_CHANGE_IND     IS NULL
            AND A.SGBSTDN_TERM_CODE_EFF = ( SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                              FROM SGBSTDN B
                                             WHERE B.SGBSTDN_PIDM           = A.SGBSTDN_PIDM
                                               AND B.SGBSTDN_STST_CODE      IN  ('AS', 'AL')
                                               AND B.SGBSTDN_TERM_CODE_EFF <= SFRSTCR_TERM_CODE )
            AND SFRSTCR_PIDM            = SPRIDEN_PIDM
            AND SFRSTCR_RSTS_CODE      IN ('RE','RW')
            AND SFRSTCR_TERM_CODE       = psPerio
            AND SFRSTCR_CRN             = psCrn
          ORDER BY DESCMAJR, NOMBRE;

  FUNCTION F_DETALLE ( psDocente       VARCHAR2,
                       psRut           VARCHAR2,
                       psTitular       VARCHAR2,
                       psSubj          VARCHAR2,
                       psCurso         VARCHAR2,
                       psMateria       VARCHAR2,
                       psCRN           VARCHAR2,
                       psSeccion       VARCHAR2,
                       psCreditos      VARCHAR2,
                       psHoras         VARCHAR2,
                       psPart_periodo  VARCHAR2,
                       psCupo          VARCHAR2,
                       psInscritos     VARCHAR2,
                       psDisponibles   VARCHAR2,
                       psListaCruzada  VARCHAR2,
                       psParte         VARCHAR2 )  RETURN  VARCHAR2  IS

  BEGIN
     RETURN '<tr><td colspan="'||vnColumnas||'" style="border-left: 1px #ffffff;border-right: 1px #ffffff;border-top: 1px #ffffff;border-bottom: 1px #ffffff;">'||
                 '<table width="100%" border="1" bordercolor="#cccccc">'||
                 '<tr><th bgcolor="#efefef" align="left">Docente&nbsp:</th><td colspan="3">'||'&nbsp'||psDocente||'</td>'||
                     '<th bgcolor="#efefef" width="12.5%" align="left">RUT&nbsp:</th><td width="12.5%" >'||'&nbsp'||psRut||'</td>'||
                     '<th bgcolor="#efefef" width="12.5%" align="left">Estatus&nbsp:</th><td width="12.5%" style="border-left: 1px #ffffff;">'||'&nbsp'||psTitular||'</td>'||
                 '</tr>'||
                 '<tr><th bgcolor="#efefef" width="12.5%" align="left">Materia&nbsp:</th><td width="12.5%">'||'&nbsp'||psSubj||'</td>'||
                     '<th bgcolor="#efefef" width="12.5%" align="left">Curso&nbsp:</th><td width="12.5%">'||'&nbsp'||psCurso||'</td>'||
                     '<th bgcolor="#efefef" width="12.5%" align="left">Nombre de la materia&nbsp:</th><td width="12.5%">'||'&nbsp'||psMateria||'</td>'||
                     '<th bgcolor="#efefef" width="12.5%" align="left">NRC&nbsp:</th><td width="12.5%">'||'&nbsp'||psCRN||'&nbsp&nbsp&nbsp&nbsp'||psParte||'</td>'||
                 '</tr>'||
                 '<tr><th bgcolor="#efefef" width="12.5%" align="left">Secci&oacute;n&nbsp:</th><td width="12.5%">'||'&nbsp'||psSeccion||'</td>'||
                     '<th bgcolor="#efefef" width="12.5%" align="left">Cr&eacute;ditos&nbsp:</th><td width="12.5%">'||'&nbsp'||psCreditos||'</td>'||
                     '<th bgcolor="#efefef" width="12.5%" align="left">Horas totales&nbsp:</th><td width="12.5%">'||'&nbsp'||psHoras||'</td>'||
                     '<th bgcolor="#efefef" width="12.5%" align="left">Parte del periodo&nbsp:</th><td width="12.5%">'||'&nbsp'||psPart_periodo||'</td>'||
                 '</tr>'||
                 '<tr><th bgcolor="#efefef" width="12.5%" align="left">Cupo m&aacute;ximo&nbsp:</th><td width="12.5%">'||'&nbsp'||psCupo||'</td>'||
                     '<th bgcolor="#efefef" width="12.5%" align="left">Inscritos&nbsp:</th><td width="12.5%">'||'&nbsp'||psInscritos||'</td>'||
                     '<th bgcolor="#efefef" width="12.5%" align="left">Lugares disponibles&nbsp:</th><td width="12.5%">'||'&nbsp'||psDisponibles||'</td>'||
                     '<th bgcolor="#efefef" width="12.5%" align="left">Lista cruzada&nbsp:</th><td width="12.5%">'||'&nbsp'||psListaCruzada||'</td>'||
                 '</tr>'||
                 '</table></td></tr>'||
              '<tr><th colspan="4" align="left" style="border-left: 1px #ffffff;border-right: 1px #ffffff;border-top: 1px #ffffff;border-bottom: 1px #ffffff;"> </th></tr>';
  END F_DETALLE;


  -------------------------------------------------
  -- inicia bloque principal que genera el reporte
  -------------------------------------------------

  BEGIN

     -- valida que el usuario tenga acceso a la base de datos:
     IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

     -- obtiene los valores de las cookies para asignar los valores del filtro del query:
     vsUnive   := pk_objHtml.getValueCookie('psUnive');
     vsPerio   := pk_objHtml.getValueCookie('psPerio');
     vsFacu    := pk_objHtml.getValueCookie('psFacu');
     vsDocen   := pk_objHtml.getValueCookie('psDoce');
     vsNRC     := pk_objHtml.getValueCookie('psNRC');
     vsSeccion := pk_objHtml.getValueCookie('cookSeccion');
     vsPtrm    := pk_objHtml.getValueCookie('psPtrm');

     -- determina el largo de la tabla:
     FOR vnI IN 1..vnColumnas LOOP
         tabColumna.EXTEND(vnI);
         tabColumna(vnI) := NULL;
     END LOOP;

     -- define los encabezados de las columnas del detalle:
     tabColumna(1)  := '<center> No.';
     tabColumna(2)  := '<center> ID';
     tabColumna(3)  := '<center> Nombre';
     tabColumna(4)  := '<center> RUT';
     tabColumna(5)  := '<center> Major';
     tabColumna(6)  := '  ';
     tabColumna(7)  := '  ';
     tabColumna(8)  := '  ';
     tabColumna(9)  := '  ';
     tabColumna(10) := '  ';
     tabColumna(11) := '  ';
     tabColumna(12) := '  ';
     tabColumna(13) := '  ';
     tabColumna(14) := '  ';
     tabColumna(15) := '  ';
     tabColumna(16) := '  ';
     tabColumna(17) := '  ';
     tabColumna(18) := '  ';
     tabColumna(19) := '  ';
     tabColumna(20) := '  ';

     -- manipula la informacin obtenida por los cursores:
     FOR regRep IN cuReporte (vsUnive, vsPerio, vsFacu, vsDocen, vsNRC, vsPtrm, vsSede) LOOP
         FOR regReporte IN cuProceso (regRep.termCode, regRep.Crn) LOOP
             vnRegsTot := vnRegsTot + 1;
         END LOOP;
     END LOOP;

     FOR regRep IN cuReporte (vsUnive, vsPerio, vsFacu, vsDocen, vsNRC, vsPtrm, vsSede) LOOP
         FOR regReporte IN cuProceso (regRep.termCode, regRep.Crn) LOOP

             -- verifica el nmero de registros para el corte de pgina:
             IF vnRow = 25 OR vnRow = 0 THEN

                vnParte := vnParte + 1;
                vnHoja  := vnHoja + 1;

                IF vnParte = 1 THEN
                   vsParte := '( 1A. PARTE )';
                ELSIF vnParte = 2 THEN
                      vsParte := '( 2A. PARTE )';
                ELSIF vnParte = 3 THEN
                      vsParte := '( 3A. PARTE )';
                ELSIF vnParte = 4 THEN
                      vsParte := '( 4A. PARTE )';
                ELSIF vnParte = 5 THEN
                      vsParte := '( 5A. PARTE )';
                ELSIF vnParte = 6 THEN
                      vsParte := '( 6A. PARTE )';
                END IF;

                IF regRep.Inscritos <= 25 THEN
                   vsParte := '';
                END IF;

                -- muestra el encabezado del reporte:
                Pk_Sisrepimp.P_EncabezadoDeReporte ( psReclDesc, vnColumnas, tabColumna, vsInicioPag, '1',
                                                     psSubtitulo   => 'Periodo: '||regRep.TERMCODE||' - '||Pk_Catalogo.Periodo(regRep.TERMCODE)||',&nbsp &nbsp '||
                                                                      'Escuela: '||regRep.DESCESCUELA||'<p align="right">'||'Hoja: '||vnHoja||'&nbsp&nbsp'||'</p>',
                                                     psUsuario     => pk_login.vgsUSR,
                                                     psSeccion     => vsSeccion,
                                                     psUniversidad => regRep.campCode,
                                                     psDetalle     => f_Detalle (regRep.DOCENTE, regRep.RUT, regRep.TITULAR, regRep.SUBJ, regRep.CURSO, regRep.MATERIA, regRep.CRN, regRep.SECCION,
                                                                                 regRep.CREDITOS, regRep.HORAS, regRep.PART_PERIODO, regRep.CUPO, regRep.INSCRITOS, regRep.DISPONIBLES, regRep.LISTA_CRUZADA, vsParte)
                                                    );
                vsInicioPag := 'SALTO';
                vnRow := 0;

             END IF;

             vnRow      := vnRow  + 1;
             vnRegs     := vnRegs + 1;
             vsDeptCode := regRep.deptSede;

             -- arma el detalle del reporte:
             htp.p('</tr> <tr> <td width="3%"    valign="top" align="center">'||vnRegs             ||'</td>
                               <td width="6%"    valign="top" align="center">'||regReporte.ID      ||'</td>
                               <td width="27%"   valign="top">'      ||'&nbsp'||regReporte.NOMBRE  ||'</td>
                               <td width="7%"    valign="top" align="center">'||regReporte.RUT     ||'</td>
                               <td width="19.5%" valign="top">'      ||'&nbsp'||regReporte.DESCMAJR||'</td>
                               <td width="2.5%"> </td>
                               <td width="2.5%"> </td>
                               <td width="2.5%"> </td>
                               <td width="2.5%"> </td>
                               <td width="2.5%"> </td>
                               <td width="2.5%"> </td>
                               <td width="2.5%"> </td>
                               <td width="2.5%"> </td>
                               <td width="2.5%"> </td>
                               <td width="2.5%"> </td>
                               <td width="2.5%"> </td>
                               <td width="2.5%"> </td>
                               <td width="2.5%"> </td>
                               <td width="2.5%"> </td>
                               <td width="2.5%"> </td>
                    </tr>');

            -- establece el corte de pgina del reporte:
            IF vnRow = 25 OR vnRow = 0 THEN

               IF vnRegsTot = 25 THEN
                  NULL;

               ELSE
                  htp.p('<tr class="trTabSepara">
                             <td colspan="20" align="center" class="tdFont7">
                                 *&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*'||
                                 '&nbsp&nbspC O N T I N &Uacute; A&nbsp&nbsp&nbspE N&nbsp&nbsp&nbspL A&nbsp&nbsp&nbspS I G U I E N T E&nbsp&nbsp&nbspH O J A&nbsp&nbsp'||
                                 '*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*
                             </td>
                         </tr>');

               END IF;
            END IF;

         END LOOP;

         -- establece el fin del detalle del reporte:
         htp.p('<tr class="trTabSepara">
                    <td colspan="20" align="center" class="tdFont7">
                        *&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*'||
                        '&nbsp&nbspN A D A&nbsp&nbsp&nbspV &Aacute L I D O&nbsp&nbsp&nbspD E S P U &Eacute S&nbsp&nbsp&nbspD E&nbsp&nbsp&nbspE S T A&nbsp&nbsp&nbspL &Iacute N E A&nbsp&nbsp'||
                        '*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*&nbsp&nbsp*
                    </td>
                </tr>');

         vnParte  := 0;
         vnRow    := 0;
         vnRegs   := 0;
         vnExists := 1;

     END LOOP;

     IF vnExists = 0 THEN
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');

     ELSE
        -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- omite el encabezado del reporte pero agrega el salto de pgina:
        Pk_Sisrepimp.P_EncabezadoDeReporte (psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR, psSeccion=>vsSeccion);

     END IF;

     htp.p('</table><br/></body></html>');

  EXCEPTION
     WHEN OTHERS THEN
          HTP.P(SQLERRM);

  END PWRLTAS;
/


DROP PUBLIC SYNONYM PWRLTAS;

CREATE PUBLIC SYNONYM PWRLTAS FOR BANINST1.PWRLTAS;


GRANT EXECUTE ON BANINST1.PWRLTAS TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRLTAS TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRMCSA;

CREATE OR REPLACE PROCEDURE BANINST1.PWRMCSA(psReclDesc VARCHAR2) IS
/*
         Tarea: Materias con encuesta y sin encuesta asignada
                Se busca si un alumno le falta la encuesta del SEPRAD
        Modulo: Evaluacin Docente (SEPRAD)
         Fecha: 12/01/2011.
         Autor: GEPC

  Modificacin:

*/

  vsProfesor      VARCHAR2(90)   := NULL;
  vsSinID         VARCHAR2(20)   := NULL;
  vsEnEncuesta    VARCHAR2(20)   := NULL;
  vsEnEncuestaMsj VARCHAR2(30)   := NULL;
  vsEncu          VARCHAR2(30)   := NULL;
  vsTerm          VARCHAR2(7)    := NULL;
  vsPtrm          VARCHAR2(1000) := NULL;
  vnRow           INTEGER        := 0;
  vnSinName       INTEGER        := 0;
  vnProf          INTEGER        := 0;

  csA      CONSTANT VARCHAR2(1)  := 'A';
  csY      CONSTANT VARCHAR2(1)  := 'Y';
  csShl    CONSTANT VARCHAR2(1)  := '/';
  csEsp    CONSTANT VARCHAR2(1)  := ' ';
  csSI     CONSTANT VARCHAR2(2)  := 'SI';
  csCamp   CONSTANT VARCHAR2(6)  := F_CONTEXTO();
  csAAFFAA CONSTANT VARCHAR2(17) := 'bgcolor="#aaffaa"';
  cn0      CONSTANT NUMBER(1)    := 0;
  cn1      CONSTANT NUMBER(1)    := 1;
  cn79     CONSTANT NUMBER(2)    := 79;

  CURSOR cuMateria(psTerm VARCHAR2,
                   psEncu VARCHAR2,
                   psPtrm VARCHAR2 DEFAULT NULL
                  ) IS
         SELECT Materia.Term      AS Term,
                Materia.Subj      AS Subj,
                Materia.Crse      AS Crse,
                Materia.Secc      AS Secc,
                Materia.Crn       AS Crn,
                Materia.Title     AS Title,
                Materia.Ptrm      AS Ptrm,
                (SELECT SPRIDEN_ID
                   FROM SPRIDEN
                  WHERE SPRIDEN_PIDM = SVRESAF_FACULTY_PIDM
                    AND SPRIDEN_CHANGE_IND IS NULL
                )                 AS ID,
                (SELECT SPRIDEN_LAST_NAME||csEsp||SPRIDEN_FIRST_NAME
                   FROM SPRIDEN
                  WHERE SPRIDEN_PIDM = SVRESAF_FACULTY_PIDM
                    AND SPRIDEN_CHANGE_IND IS NULL
                )                 AS Nombre,
                (SELECT SPRIDEN_PIDM
                   FROM SPRIDEN
                  WHERE SPRIDEN_PIDM = SVRESAF_FACULTY_PIDM
                    AND SPRIDEN_CHANGE_IND IS NULL
                )                 AS idenPidm,
                SVRESAF_TSSC_CODE AS Encuesta
           FROM SVRESAF,
                (SELECT SS.SSBSECT_TERM_CODE AS Term,
                        A.SCBCRSE_SUBJ_CODE  AS Subj,
                        A.SCBCRSE_CRSE_NUMB  AS Crse,
                        SS.SSBSECT_SEQ_NUMB  AS Secc,
                        SS.SSBSECT_CRN       AS Crn,
                        A.SCBCRSE_TITLE      AS Title,
                        SSBSECT_PTRM_CODE    AS Ptrm
                   FROM SCBCRSE A,SSBSECT SS
                  WHERE A.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                    AND A.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB
                    AND A.SCBCRSE_EFF_TERM  = (SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                                 FROM SCBCRSE SC
                                                WHERE SC.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                                  AND SC.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                                  AND SC.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB
                                              )
                    AND SS.SSBSECT_CAMP_CODE = csCamp
                    AND SS.SSBSECT_SSTS_CODE = csA
                    AND (SSBSECT_PTRM_CODE,SS.SSBSECT_TERM_CODE) IN (SELECT SVBDTES_PTRM_CODE,SVBDTES_TERM_CODE
                                                                       FROM SVBDTES
                                                                      WHERE SVBDTES_TERM_CODE = psTerm
                                                                       AND (INSTR(csShl||SVBDTES_PTRM_CODE||csShl,csShl||psPtrm) > cn0 OR psPtrm = csShl OR psPtrm IS NULL)
                                                                    )
                ) Materia
          WHERE SVRESAF_TERM_CODE = Materia.Term
            AND SVRESAF_CRN       = Materia.Crn
            AND SVRESAF_TSSC_CODE = psEncu
            AND EXISTS (SELECT NULL
                         FROM SFRSTCR
                        WHERE SFRSTCR_TERM_CODE  = psTerm
                          AND SFRSTCR_RSTS_CODE IN (SELECT STVRSTS_CODE FROM STVRSTS WHERE STVRSTS_GRADABLE_IND = csY)
                          AND SFRSTCR_CRN        = SVRESAF_CRN
                       )
          ORDER BY Subj,Crse,Secc;

  CURSOR cuCursos(psTerm VARCHAR2,
                  psEncu VARCHAR2,
                  psPtrm VARCHAR2 DEFAULT NULL
                 )  IS
         SELECT SS.SSBSECT_TERM_CODE AS Term,
                A.SCBCRSE_SUBJ_CODE  AS Subj,
                A.SCBCRSE_CRSE_NUMB  AS Crse,
                SS.SSBSECT_SEQ_NUMB  AS Secc,
                SS.SSBSECT_CRN       AS Crn,
                A.SCBCRSE_TITLE      AS Title,
                SS.SSBSECT_PTRM_CODE AS Ptrm,
                SS.SSBSECT_SCHD_CODE AS Schd
           FROM SCBCRSE A,
                SSBSECT SS
          WHERE A.SCBCRSE_SUBJ_CODE  = SS.SSBSECT_SUBJ_CODE
            AND A.SCBCRSE_CRSE_NUMB  = SS.SSBSECT_CRSE_NUMB
            AND A.SCBCRSE_EFF_TERM   = (SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                          FROM SCBCRSE SC
                                         WHERE SC.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                           AND SC.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                           AND SC.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB
                                       )
            AND SS.SSBSECT_SSTS_CODE = csA
            AND SS.SSBSECT_CAMP_CODE = csCamp
            AND (SS.SSBSECT_TERM_CODE,SS.SSBSECT_PTRM_CODE) IN (SELECT SVBDTES_TERM_CODE,SVBDTES_PTRM_CODE
                                                                  FROM SVBDTES
                                                                 WHERE SVBDTES_TERM_CODE = psTerm
                                                                   AND (INSTR(csShl||SVBDTES_PTRM_CODE||csShl,csShl||psPtrm) > cn0 OR psPtrm = csShl OR psPtrm IS NULL)
                                                               )
          ORDER BY Subj,Crse,Secc;

  BEGIN
      -- valida que el usuario pertenezca a la base de datos.
      IF PK_Login.F_ValidacionDeAcceso(PK_Login.vgsUSR) THEN RETURN; END IF;

      vsEncu := pk_objhtml.getValueCookie('psSeprd');
      vsTerm := pk_objhtml.getValueCookie('psSpTCO');
      vsPtrm := NVL(pk_objhtml.getValueCookie('psPtrmP'),csShl);

      htp.p('<html><head><title>'||psReclDesc||'</title>');

      -- la aplicaci&oacute;n no se guarda en el cache de la maquina.
      pk_ObjHTML.P_NoCache;

      --cdigo css
      pk_ObjHTML.P_CssTabs;

      htp.p('
      <script language="javascript" src="kwacnls.js"></script>
      </head><body bgcolor="#ffffff" class="bodyCeroR">
      <br/>
      <table border="1" cellpadding="2" cellspacing="1" width="100%" bordercolor="#ffffff" bgcolor="#ffffff">
      <tr>
      <td width="10%" rowspan="2" valign="top"><img src="/imagenes/logo_uft.jpg" tabindex="-1" width="110" height="40" border="0"></td>
      <td width="90%">'||vsEncu||' - '||pK_Seprad1.F_Encuesta(vsEncu)||' ('||vsTerm||')</td>
      <tr><td width="90%" valign="top">
      '||TO_CHAR(SYSDATE,'DD/MON/YYYY HH24:MI:SS')||'
      </td></tr></table><br/>');

      htp.p('<table border="1" cellpadding="2" cellspacing="1" width="100%" bordercolor="#cccccc" bgcolor="#ffffff">');
      htp.p('
      <tr><th colspan="12" bgcolor="#efefef">'||f_Label(75)||' '||vsEncu||' - '||vsTerm||'</th></tr>
      <tr bgcolor="#efefef">
      <td></td>
      <th valign="top">'||f_Label(14)||'</th><!--Periodo    -->
      <th valign="top">'||f_Label(74)||'</th><!--Parte de periodo-->
      <th valign="top">'||f_Label(44)||'</th><!--Subj       -->
      <th valign="top">'||f_Label(45)||'</th><!--Crse       -->
      <th valign="top">'||f_Label(76)||'</th><!--Sec        -->
      <th valign="top">'||f_Label(19)||'</th><!--Crn        -->
      <th valign="top">'||f_Label(46)||'</th><!--Titulo     -->
      <th valign="top">'||f_Label(15)||'</th><!--Profesor   -->
      <th valign="top">'||f_Label(82)||'</th><!--RUT        -->
      <th valign="top">'||f_Label(77)||'</th><!--Tssc Cde   -->
      <th valign="top"></th>
      </tr>');

      FOR regMat IN cuMateria(vsTerm, vsEncu, vsPtrm) LOOP
          vnRow := vnRow + 1;

          IF regMat.Nombre IS NOT NULL THEN
             vnSinName := vnSinName + 1;
          END IF;

          IF regMat.ID IS NULL THEN
             vsSinID       := 'bgcolor="#FFbbbb"';
             regMat.Nombre := 'Sin registro en SPRIDEN';
          ELSE
             vsSinID := NULL;
          END IF;

         htp.p('<tr '||vsSinID||'>
         <td valign="top" align="right">'||vnRow||'</td>
         <td valign="top">'||regMat.Term                ||'</td>
         <td valign="top">'||regMat.Ptrm                ||'</td>
         <td valign="top">'||regMat.Subj                ||'</td>
         <td valign="top">'||regMat.Crse                ||'</td>
         <td valign="top">'||regMat.Secc                ||'</td>
         <td valign="top">'||regMat.Crn                 ||'</td>
         <td valign="top">'||regMat.Title               ||'</td>
         <td valign="top">'||regMat.ID                  ||' '||regMat.Nombre  ||'</td>
         <td valign="top">'||f_get_rut(regMat.idenPidm) ||'</td>
         <td valign="top">'||regMat.Encuesta            ||'</td>
         <td valign="top">'||vnSinName                  ||'</td>
         </tr>');
      END LOOP;

      htp.p('</table><br/><br/><hr size="2" width="100%" align="center"><br/>');

      htp.p('<table border="1" cellpadding="2" cellspacing="1" width="80%" bordercolor="#cccccc" bgcolor="#ffffff">');
      htp.p('<tr><th colspan="10" bgcolor="#efefef">Catalogo de cursos '||vsEncu||' - '||vsTerm||'</th></tr>

      <tr bgcolor="#efefef">
      <td></td>
      <th valign="top">'||f_Label(14)||'</th><!--Periodo    -->
      <th valign="top">'||f_Label(74)||'</th><!--Parte de periodo-->
      <th valign="top">'||f_Label(44)||'</th><!--Subj       -->
      <th valign="top">'||f_Label(45)||'</th><!--Crse       -->
      <th valign="top">'||f_Label(76)||'</th><!--Sec        -->
      <th valign="top">'||f_Label(19)||'</th><!--Crn        -->
      <th valign="top">'||f_Label(46)||'</th><!--Titulo     -->
      <th valign="top">'||f_Label(78)||'</th><!--Profesor asignado?-->
      <th valign="top"></th>
      </tr>');

      vnRow := 0;

      FOR regMat IN cuCursos(vsTerm, vsEncu, vsPtrm) LOOP
          vnRow        := vnRow + 1;
          vsProfesor   := NULL;

          SELECT DECODE(COUNT(cn1),cn0,f_Label(cn79),csSI)
            INTO vsProfesor
            FROM SIRASGN
           WHERE SIRASGN_TERM_CODE = regMat.Term
             AND SIRASGN_CRN       = regMat.Crn;

          SELECT DECODE(COUNT(cn1),cn0,csAAFFAA,NULL)
            INTO vsEnEncuesta
            FROM SVRESAF
           WHERE SVRESAF_TSSC_CODE = vsEncu
             AND SVRESAF_TERM_CODE = regMat.Term
             AND SVRESAF_CRN       = regMat.Crn;

          IF vsEnEncuesta IS NULL THEN
             vsEnEncuestaMsj := NULL;
          ELSE
             vsEnEncuestaMsj := f_Label(80);
          END IF;

          htp.p('<tr>
          <td valign="top" align="right">'||vnRow||'</td>
          <td valign="top">'||regMat.Term ||'</td>
          <td valign="top">'||regMat.Ptrm ||'</td>
          <td valign="top">'||regMat.Subj ||'</td>
          <td valign="top">'||regMat.Crse ||'</td>
          <td valign="top">'||regMat.Secc ||'</td>
          <td valign="top">'||regMat.Crn  ||'</td>
          <td valign="top">'||regMat.Title||'</td>
          <td valign="top">'||vsProfesor  ||'</td>
          <td valign="top" '||vsEnEncuesta||'>'||vsEnEncuestaMsj||'</td>
          </tr>');
      END LOOP;

      htp.p('</table><br/><hr size="2" width="100%" align="center"><br/></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           HTP.P(SQLERRM);
  END PWRMCSA;
/


DROP PUBLIC SYNONYM PWRMCSA;

CREATE PUBLIC SYNONYM PWRMCSA FOR BANINST1.PWRMCSA;


GRANT EXECUTE ON BANINST1.PWRMCSA TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRMCSA TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRMDC;

CREATE OR REPLACE PROCEDURE BANINST1.PWRMDC (
	psReclDesc			VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:			BANINST1.PWRMDC
OBJETIVO:				Matricula: Detalle de Contratos
AUTORES:				Gilberto Velazquez
FECHA:					29/12/2010
******************************************************************************/
	--Numero de renglones
	vnRow				PLS_INTEGER := 0;
	--Bandera para mostrar si hubo datos
	vnExists			INTEGER := 0;
	--Numero de columnas
	vnColumnas			INTEGER := 25;
	--Numero de registros
	vnRegs				INTEGER := 0;
	--Arreglo (nested table) donde se guardan los encabezados de las columnas
	tabColumna			Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
	-- la variable es una bandera que al tener el valor "imprime" no colocara
	--el salto de pgina para impresion
	vsInicoPag			VARCHAR2(10) := NULL;
	--Nmero de renglones por pgina
	vnRegsPag			PLS_INTEGER := 25;

	--Variable para guardar el numero de contrato deseado
	vsCONT				VARCHAR2(10);
	--Variable para guardar la fecha de matriculacion
	vdFecha				DATE;

	--Variable para guardar el total
	vnTotal				NUMBER(16,2);

	--Variable para guardar el gran total
	vnGranTotal			NUMBER(16,2);

	--Registro para los datos del alumno
	vrDatosAlum			pk_MatCorteCaja.cuDatosAlum%ROWTYPE;
	--Registro para los datos del apoderado
	vrDatosApo			pk_MatApoderado.cuDatosApo%ROWTYPE;

	CURSOR cuReporte(
		psContrato		VARCHAR2
		,pdFecha		DATE
	) IS
		SELECT
			TWRCCAS_DATE						AS FechaSup
			,TWRCCAS_NUM						AS NumCorteSup
			,TWRCCAM_DATE						AS FechaMat
			,TWRCCAM_CCAM_USER					AS UsuarioMat
			,TWRCCAM_NUM						AS NumCorteMat
			,TWBCNTR_NUM						AS Contrato
			,TWBCNTR_ISSUE_DATE					AS FechaCont
			,TWBCNTR_TERM_CODE					AS Periodo
			,TWBDOCU_PIDM						AS Pidm
			,TWVPAYM_CODE						AS CodMedPago
			,TBRACCD_DETAIL_CODE				AS CodDet
			,TWVPAYM_DESC						AS DescMedPago
			,TWBDOCU_DOCU_NUM					AS NumDoc
			,TWBDOCU_BANK_CODE					AS Banco
			,TWBDOCU_CTYP_CODE					AS TipoTC
			,TWRDOTR_PART_AMOUNT				AS Monto
			,TWBDOCU_EXPIRATION_DATE			AS FechaVen
			,TWBDOCU_STATUS_IND					AS Status
		FROM
			TWRCCAS
			,TWRCCAM
			,TWRCCMD
			,TWVPAYM
			,TBBDETC
			,TBRACCD
			,TWBDOCU
			,TWRDOTR
			,TWBCNTR
		WHERE
			TWRCCAS_NUM = TWRCCAM_CCAS_NUM
			AND TWRCCMD_CCAM_USER = TWRCCAM_CCAM_USER
			AND TWRCCMD_CCAM_NUM = TWRCCAM_NUM
			AND TWBDOCU_SEQ_NUM = TWRCCMD_DOCU_SEQ_NUM
			AND TWBDOCU_PAYM_CODE = TWVPAYM_CODE
			AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
			AND TBBDETC_TYPE_IND = 'C'
			AND TBRACCD_PIDM = TWRDOTR_PIDM
			AND TBRACCD_TRAN_NUMBER = TWRDOTR_TRAN_NUMBER
			AND TWBDOCU_PIDM = TWRDOTR_PIDM
			AND TWBDOCU_SEQ_NUM = TWRDOTR_DOCU_SEQ_NUM
			AND TWBDOCU_CNTR_NUM = TWBCNTR_NUM
			and not exists (select 1
					from twbretr
					where twbretr_cntr_num = twbcntr_num)
			AND (psContrato IS NULL OR TWBDOCU_CNTR_NUM = psContrato)
			AND (pdFecha IS NULL OR (TWBCNTR_ISSUE_DATE >= TRUNC(pdFecha)
				AND TWBCNTR_ISSUE_DATE < TRUNC(pdFecha) + 1)
			)
		ORDER BY
			TWBCNTR_NUM
			,DECODE(TWBDOCU_STATUS_IND ,'PA' ,1 ,'TR' ,2 ,'AC' ,3 ,4)
			,TWVPAYM_CODE
			,TWBDOCU_DOCU_NUM;

BEGIN

	--Seguridad de GWAMNUR
	IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

	--Obtengo el numero de corte que se desea para el usuario dado
	vsCont := pk_objHtml.getValueCookie('psCont');

	--Obtengo de las cookies el valor fechas de corte de caja
	vdFecha := TO_DATE(pk_objHtml.getValueCookie('psFecha'),'DD/MM/YYYY');

	-- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
	tabColumna.EXTEND(vnColumnas);

	--Guardamos los encabezados en el arreglo de columnas
	tabColumna( 1) := 'Fecha/Hora Cierre Sup.';
	tabColumna( 2) := 'N&uacute;m. Cierre Sup.';
	tabColumna( 3) := 'Fecha/Hora Cierre Mat.';
	tabColumna( 4) := 'Matriculador';
	tabColumna( 5) := 'N&uacute;m. Cierre Mat.';

	tabColumna( 6) := 'Contrato';

	tabColumna( 7) := 'Alumno<br/>Id. ';
	tabColumna( 8) := 'Alumno<br/>RUT';
	tabColumna( 9) := 'Alumno<br/>Apellidos';
	tabColumna(10) := 'Alumno<br/>Nombre(s)';

	tabColumna(11) := 'Apoderado<br/>RUT';
	tabColumna(12) := 'Apoderado<br/>Apellidos';
	tabColumna(13) := 'Apoderado<br/>Nombre(s)';

	tabColumna(14) := 'Concepto';
	tabColumna(15) := 'Medio Pago';
	tabColumna(16) := 'Descrip.';
	tabColumna(17) := 'N&uacute;m. Doc.';
	tabColumna(18) := 'C&oacute;d. Banco';
	tabColumna(19) := 'Tipo TC';
	tabColumna(20) := 'Status';
	tabColumna(21) := 'Monto';
	tabColumna(22) := 'Fecha Ven.';

	tabColumna(23) := 'Fecha Matr.';
	tabColumna(24) := 'Programa';
	tabColumna(25) := 'Centro Costos';


	--Por cada corte reinicializo el contador de renglones
	vnRow := 0;


	FOR regReporte IN cuReporte(vsCont, vdFecha) LOOP

		--Incremento el contador de renglones
		vnRow := vnRow + 1;
		vnExists := 1; --Bandera para indicar que hubo resultados

		--Si es el primer renglon de cada pgina...
		IF vnRow = 1 then--MOD(vnRow, vnRegsPag) = 1  THEN
			--imprimo el encabezado de reporte
			Pk_Sisrepimp.P_EncabezadoDeReporte(
				psReclDesc ,vnColumnas ,tabColumna
				,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
			);
			vsInicoPag := 'SALTO';
		END IF;

		--Comienzo a desplegar el renglon
		HTP.P('<tr>');

		--Despliego la fecha y hora de cierre de matriculador
		HTP.P('<td>'||TO_CHAR(regReporte.FechaSup
			,'DD/MM/YYYY HH24:MI:SS')||'</td>');

		--Despliego el corte de caja
		HTP.P('<td>'||regReporte.NumCorteSup||'</td>');

		--Despliego la fecha y hora de cierre de matriculador
		HTP.P('<td>'||TO_CHAR(regReporte.FechaMat,'DD/MM/YYYY HH24:MI:SS')||'</td>');

		--Despliego el Usuario:
		HTP.P('<td>'||regReporte.UsuarioMat||'</td>');

		--Despliego el corte de caja
		HTP.P('<td>'||regReporte.NumCorteMat||'</td>');

		--Despliego el Contrato:
		HTP.P('<td>'||regReporte.Contrato||'</td>');

		--Obtengo los datos del alumno
		OPEN pk_MatCorteCaja.cuDatosAlum(regReporte.Pidm);
		FETCH pk_MatCorteCaja.cuDatosAlum INTO vrDatosAlum;
		IF pk_MatCorteCaja.cuDatosAlum%NOTFOUND THEN vrDatosAlum := NULL; END IF;
		CLOSE pk_MatCorteCaja.cuDatosAlum;

		--Despliego el ID
		HTP.P('<td>'||vrDatosAlum.ID||'</td>');

		--Despliego el RUT
		HTP.P('<td>'||vrDatosAlum.RUT||'</td>');

		--Despliego los apellidos
		HTP.P('<td>'||vrDatosAlum.Apellidos||'</td>');

		--Despliego los nombres
		HTP.P('<td>'||vrDatosAlum.Nombre||' '
			||vrDatosAlum.SegNombre||'</td>');

		--Obtengo los datos del apoderado
		OPEN pk_MatApoderado.cuDatosApo(regReporte.Contrato);
		FETCH pk_MatApoderado.cuDatosApo INTO vrDatosApo;
		IF pk_MatApoderado.cuDatosApo%NOTFOUND THEN vrDatosApo := NULL; END IF;
		CLOSE pk_MatApoderado.cuDatosApo;

		--Despliego el RUT
		HTP.P('<td>'||vrDatosApo.RUT||'</td>');

		--Despliego los apellidos
		HTP.P('<td>'||pk_MatApoderado.f_Apellido(vrDatosApo.RUT)||'</td>');

		--Despliego los nombres
		HTP.P('<td>'||pk_MatApoderado.f_Nombre(vrDatosApo.RUT)||'</td>');

		--Despliego el Concepto:
		HTP.P('<td>'||regReporte.CodDet||'</td>');

		--Despliego el codigo de medio de pago
		HTP.P('<td>'||regReporte.CodMedPago||'</td>');

		--Despliego la descripcion de medio de pago
		HTP.P('<td>'||regReporte.DescMedPago||'</td>');

		--Despliego el nmero de documento
		HTP.P('<td>'||regReporte.NumDoc||'</td>');

		--Despliego el codigo de banco
		HTP.P('<td>'||regReporte.Banco||'</td>');

		--Despliego el tipo de tc
		HTP.P('<td>'||regReporte.TipoTC||'</td>');

		--Despliego el estado de los documentos
		HTP.P('<td>'||pk_Matricula.f_GetDocStatusDesc(regReporte.Status)||'</td>');

		--Despliego el monto
		HTP.P('<td style="text-align:right;">'
			||TO_CHAR(regReporte.Monto,'L999G999G999')||'</td>');

		--Despliego la fecha de vencimiento
		HTP.P('<td>'||TO_CHAR(regReporte.FechaVen,'DD/MM/YYYY')||'</td>');

		--Despliego fecha de matriculacion
		HTP.P('<td>'||TO_CHAR(regReporte.FechaCont
			,'DD/MM/YYYY HH24:MI:SS')||'</td>');

		--Despliego el programa del alumno
		HTP.P('<td>'||f_Get_Programa(regReporte.Pidm, regReporte.Periodo)
			||'</td>');

		--Despliego el centro de costos
		HTP.P('<td>'||Pk_Contabilidad.f_ObtCentroCostos(regReporte.Pidm, regReporte.Periodo)
			||'</td>');

		--Fin del renglon
		HTP.P('</tr>');

	END LOOP;

	IF vnExists = 0 THEN
		--Ojo esta linea lo que hace es imprimir
		--NO SE ENCONTRARON DATOS o un mensaje similar
		htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
	ELSE

		-- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
		Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

		-- es omitido el encabezado del reporte pero se agrega el salto de pagina
		Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
	END IF;

	--Fin de la pagina
	htp.p('</table><br/></body></html>');
EXCEPTION
	WHEN OTHERS THEN
		--pantallazo de error.
		pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
			'PWRMDC', NULL);
END PWRMDC;
/


DROP PUBLIC SYNONYM PWRMDC;

CREATE PUBLIC SYNONYM PWRMDC FOR BANINST1.PWRMDC;


GRANT EXECUTE ON BANINST1.PWRMDC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRMDC TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRMDC TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRMDC TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRMDC TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRMINS;

CREATE OR REPLACE PROCEDURE BANINST1.PWRMINS ( psReclDesc  VARCHAR2 ) IS
/*******************************************************************************
         tarea: procedimiento que genera el reporte de
                registro de materias inscritas.
        mdulo: toma de ramos - uft.
         autor: hmr - horacio martnez ramrez.
         fecha: 01/01/2011.

  modificacin: hmr - 17/05/2011.
                se aplic el estandar para los reportes de uft.
  modificacin: hmr - 24/05/2011.
                se elimin el parmetro de sede y el subttulo del reporte.
*******************************************************************************/

  vnRow       INTEGER                := 0;
  vnExists    INTEGER                := 0;
  vnColumnas  INTEGER                := 9;
  tabColumna  Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vsPerio     VARCHAR2(6)            := NULL;
  vsUniv      VARCHAR2(20)           := NULL;
  vsProgr     VARCHAR2(30)           := NULL;
  vsSeccion   VARCHAR2(3)            := NULL;
  vsTermCode  VARCHAR2(6)            := NULL;
  vsCampCode  VARCHAR2(6)            := NULL;
  vsRateCode  VARCHAR2(10)           := NULL;
  vsNrc       VARCHAR2(4000)         := NULL;
  vsID        VARCHAR2(20)           := NULL;
  vsMajr      VARCHAR2(30)           := NULL;
  vsPtrm      VARCHAR2(10)           := NULL;
--  vssede      varchar2(10)           := null;
  vsInicoPag  VARCHAR2(10)           := NULL;

  CURSOR cuReporte ( psTerm VARCHAR2 DEFAULT NULL,
                     psCamp VARCHAR2 DEFAULT NULL,
                     psProg VARCHAR2 DEFAULT NULL,
                     psIDdd VARCHAR2 DEFAULT NULL,
                     psMajr VARCHAR2 DEFAULT NULL,
                     psPtrm VARCHAR2 DEFAULT NULL
--                     pssede varchar2 default null
                      ) IS
         SELECT SGBSTDN_CAMP_CODE                                                  CAMPCODE,
                SFRSTCR_TERM_CODE                                                  TERMCODE,
                A.SGBSTDN_PROGRAM_1                                                CVEPROGRAMA,
                UPPER(PK_CATALOGO.PROGRAMA(A.SGBSTDN_PROGRAM_1))                   DESCPROGRAMA,
                SPRIDEN_ID                                                         ID,
                SFRSTCR_PIDM                                                       PIDM,
--                nvl(sgbstdn_rate_code,'sin sede')                                  ratecode,
                UPPER(REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME,'*',' ')) NOMBRE,
--                ( select sgbuser_suda_code
--                    from sgbuser
--                   where sgbuser_term_code = sfrstcr_term_code
--                     and sgbuser_pidm      = sfrstcr_pidm )                        cursado,
                ( SELECT SFBETRM_MHRS_OVER
                    FROM SFBETRM
                   WHERE SFBETRM_ESTS_CODE = 'EL'
                     AND SFBETRM_PIDM      = SFRSTCR_PIDM
                     AND SFBETRM_TERM_CODE = SFRSTCR_TERM_CODE )                   CARGA
           FROM SCBCRSE E,
                SSBSECT C,
                SGBSTDN A,
                SPRIDEN D,
                SFRSTCR J
          WHERE A.SGBSTDN_PIDM          = D.SPRIDEN_PIDM
            AND A.SGBSTDN_PIDM          = J.SFRSTCR_PIDM
            AND E.SCBCRSE_SUBJ_CODE     = C.SSBSECT_SUBJ_CODE
            AND E.SCBCRSE_CRSE_NUMB     = C.SSBSECT_CRSE_NUMB
            AND C.SSBSECT_CRN           = J.SFRSTCR_CRN
            AND D.SPRIDEN_CHANGE_IND    IS NULL
            AND A.SGBSTDN_TERM_CODE_EFF = ( SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                              FROM SGBSTDN B
                                             WHERE B.SGBSTDN_PIDM = A.SGBSTDN_PIDM
                                               AND B.SGBSTDN_TERM_CODE_EFF <= SFRSTCR_TERM_CODE )
            AND A.SGBSTDN_STST_CODE  IN ('AS', 'AL')
            AND J.SFRSTCR_RSTS_CODE  IN ('RE','RW')
            AND (SFRSTCR_TERM_CODE   = psTerm OR psTerm IS NULL)
            AND (SGBSTDN_CAMP_CODE   = psCamp OR psCamp IS NULL)
            AND (A.SGBSTDN_PROGRAM_1 = psProg OR psProg IS NULL)
            AND (SPRIDEN_ID          = psIDdd OR psIDdd IS NULL)
            AND (SGBSTDN_MAJR_CODE_1 = psMajr OR psMajr IS NULL)
            AND (J.SFRSTCR_PTRM_CODE = psPtrm OR psPtrm IS NULL)
--            and (sgbstdn_rate_code   = pssede or pssede is null)
          GROUP BY SGBSTDN_CAMP_CODE,
                   SFRSTCR_TERM_CODE,
                   A.SGBSTDN_PROGRAM_1,
                   SPRIDEN_ID,
                   SFRSTCR_PIDM,
                   REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME,'*',' ')
--                   nvl(sgbstdn_rate_code,'sin sede')
--          order by termcode desc, ratecode, descprograma, nombre;
          ORDER BY TERMCODE DESC, CVEPROGRAMA, NOMBRE;

  -- obtiene los crn's de los cursos que inscribio el alumno:
  CURSOR cuNRC ( psTerm  VARCHAR2,
                 pnPidm  NUMBER,
                 psPtrm  VARCHAR2 ) IS
        SELECT SFRSTCR_CRN||' '||SCBCRSE_SUBJ_CODE||' '||SCBCRSE_CRSE_NUMB||' '||SCBCRSE_TITLE NRC
          FROM SFRSTCR,
               SSBSECT SS,
               SCBCRSE
         WHERE SSBSECT_SUBJ_CODE = SCBCRSE_SUBJ_CODE
           AND SSBSECT_CRSE_NUMB = SCBCRSE_CRSE_NUMB
           AND SCBCRSE_EFF_TERM  = ( SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                       FROM SCBCRSE SC
                                      WHERE SC.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                        AND SC.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                        AND SC.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB )
           AND SFRSTCR_RSTS_CODE IN ('RE','RW')
           AND SFRSTCR_TERM_CODE  = SSBSECT_TERM_CODE
           AND SFRSTCR_CRN        = SSBSECT_CRN
           AND SFRSTCR_TERM_CODE  = psTerm
           AND SFRSTCR_PIDM       = pnPidm
           AND (SFRSTCR_PTRM_CODE = psPtrm OR psPtrm IS NULL);

  CURSOR cuMatCredBill ( psterm  VARCHAR2,
                         pnpidm  NUMBER,
                         psPtrm  VARCHAR2 ) IS
         SELECT COUNT(SFRSTCR_CRN)                                 MATERIAS,
                SUM(SFRSTCR_CREDIT_HR)                             CREDITOS,
                SUM(SFRSTCR_BILL_HR)                               BILLHRS
           FROM SFRSTCR CR
          WHERE CR.SFRSTCR_PIDM       = PNPIDM
            AND CR.SFRSTCR_TERM_CODE  = PSTERM
            AND CR.SFRSTCR_RSTS_CODE  IN ('RE','RW')
            AND (CR.SFRSTCR_PTRM_CODE = PSPTRM OR PSPTRM IS NULL);

  vnMCB cuMatCredBill%ROWTYPE;


  BEGIN
      -- valida que el usuario pertenezca a la base de datos:
      IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      -- son buscados los valores de las cookies para asignar los valores del filtro del query:
      vsPerio   := pk_ObjHtml.getValueCookie('psPerio');
      vsUniv    := pk_ObjHtml.getValueCookie('psUnive');
      vsProgr   := pk_ObjHtml.getValueCookie('psProgr');
      vsID      := pk_ObjHtml.getValueCookie('psId');
      vsMajr    := pk_ObjHtml.getValueCookie('psMajrr');
      vsSeccion := pk_ObjHtml.getValueCookie('cookSeccion');
      vsPtrm    := pk_ObjHtml.getValueCookie('psPtrm');
--      vssede    := pk_objhtml.getvaluecookie('psrate');

      -- se determina el largo de la tabla:
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1) := '<center> Programa';
      tabColumna(2) := '<center> Descripci&oacute;n';
      tabColumna(3) := '<center> ID';
      tabColumna(4) := '<center> Nombre';
      tabColumna(5) := '<center> Materias inscritas';
      tabColumna(6) := '<center> Total de materias inscritas';
      tabColumna(7) := '<center> Cr&eacute;ditos inscritos';
      tabColumna(8) := '<center> Bill Hrs.';
      tabColumna(9) := '<center> Carga acad&eacute;mica permitida';
--      tabcolumna(10):= '<center> periodo que cursa';

--      for regrep in cureporte(vsperio, vsuniv, vsprogr, vsid, vsmajr,vsptrm,vssede) loop
      FOR regRep IN cuReporte(vsPerio, vsUniv, vsProgr, vsID, vsMajr, vsPtrm) LOOP
          IF vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
             vsCampCode IS NULL OR vsCampCode <> regRep.campCode  THEN
--             vsratecode is null or vsratecode <> regrep.ratecode or vnrow = 10 then

--             pk_sisrepimp.p_encabezadodereporte(psrecldesc, vncolumnas, tabcolumna, vsinicopag, '1', pssubtitulo=>'sede: '||nvl(pk_catalogo.fstvrate(regrep.ratecode),'sin sede')||'<br>periodo: '||regrep.termcode||' - '||pk_catalogo.periodo(regrep.termcode), psusuario=>pk_login.vgsusr, psseccion=>vsseccion, psuniversidad=>regrep.campcode);
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vsInicoPag, '1', psSubtitulo=>'Periodo: '||regrep.termcode||' - '||Pk_Catalogo.PERIODO(regrep.termcode), psUsuario=>pk_login.vgsUSR, psSeccion=>vsSeccion, psUniversidad=>regRep.campCode);
             vsInicoPag := 'SALTO';
             vnRow  := 0;
          END IF;

          htp.p('<tr> <td valign="top">'||regRep.CVEPROGRAMA ||'</td>
                      <td valign="top">'||regRep.DESCPROGRAMA||'</td>
                      <td valign="top">'||regRep.ID          ||'</td>
                      <td valign="top">'||regRep.NOMBRE      ||'</td>
                      <td valign="top">');

          FOR regCrn IN cuNRC(regRep.termCode, regRep.Pidm, vsPtrm) LOOP
              htp.p(regCrn.Nrc|| '<br>');
          END LOOP;

          OPEN  cuMatCredBill(regRep.termCode, regRep.Pidm, vsPtrm);
          FETCH cuMatCredBill INTO vnMCB;
          CLOSE cuMatCredBill;

          htp.p('</td> <td align="center" valign="top">'||vnMCB.MATERIAS||'</td>
                       <td align="center" valign="top">'||vnMCB.CREDITOS||'</td>
                       <td align="center" valign="top">'||vnMCB.BILLHRS ||'</td>
                       <td align="center" valign="top">'||regRep.CARGA  ||'</td></tr>');
--                       <td valign="top">'||regrep.cursado||'</td></tr>');

          vnExists   := 1;
          vnRow      := vnRow + 1;
          vsTermCode := regRep.termCode;
          vsCampCode := regRep.campCode;
--          vsratecode := regrep.ratecode;
      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pgina:
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR, psSeccion=>vsSeccion);
      END IF;

      htp.p('</table><br><br></body></html>');

  EXCEPTION
     WHEN OTHERS THEN
          HTP.P(SQLERRM);

  END PWRMINS;
/


DROP PUBLIC SYNONYM PWRMINS;

CREATE PUBLIC SYNONYM PWRMINS FOR BANINST1.PWRMINS;


GRANT EXECUTE ON BANINST1.PWRMINS TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRMINS TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRMNLA;

CREATE OR REPLACE PROCEDURE BANINST1.PWRMNLA (
	psReclDesc			VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:		PWRMNLA
OBJETIVO:			Reporte de Matricula: Nuevo Ingreso, "Ligero", acumulado
PARAMETROS:
psReclDesc			Variable estandar para la maquina de reportes custom
AUTOR:				Gilberto Velazquez Hernandez
FECHA:				20110106
******************************************************************************/
	--Numero de renglones
	vnRow				PLS_INTEGER := 0;
	--Bandera para mostrar si hubo datos
	vnExists			INTEGER := 0;
	--Numero de columnas
	vnColumnas			INTEGER := 10;
	--Numero de registros
	vnRegs				INTEGER := 0;
	--Arreglo (nested table) donde se guardan los encabezados de las columnas
	tabColumna			Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
	-- la variable es una bandera que al tener el valor "imprime" no colocara
	--el salto de pgina para impresion
	vsInicoPag			VARCHAR2(10) := NULL;
	--Nmero de renglones por pgina
	vnRegsPag			PLS_INTEGER := 25;

	--Variable para guardar el periodo deseado
	vsPerio				STVTERM.STVTERM_CODE%TYPE;

	--Variable para guardar EL PROGRAMA DESEADO
	vsProg				SMRPRLE.SMRPRLE_PROGRAM%TYPE;
	--Variable para guardar el total de matriculados
	vnTotalMat			PLS_INTEGER;
	--Total de matriculados AR
	vnTotalMatAR		PLS_INTEGER;
	--Total de matriculados AE
	vnTotalMatAE		PLS_INTEGER;
	--Total de matriculados AC
	vnTotalMatAC		PLS_INTEGER;

	--Variable para guardar el total de matriculados del dia
	vnTotalDia			PLS_INTEGER;
	--Total del dia AR
	vnTotalDiaAR		PLS_INTEGER;
	--Total del dia AE
	vnTotalDiaAE		PLS_INTEGER;
	--Total del dia AC
	vnTotalDiaAC		PLS_INTEGER;
	--Fecha del reporte
	vdFecha				DATE;

	CURSOR cuReporte(
		psPerio			VARCHAR2
		,psProg			VARCHAR2
		,pdFecha		DATE DEFAULT SYSDATE
	) IS
		SELECT
			SMRPRLE_PROGRAM							AS Prog
			,SMRPRLE_PROGRAM_DESC					AS ProgDesc
			,NVL(Q3.DelDiaAR,0)						AS MatDiaAR
			,NVL(Q3.DelDiaAC,0)						AS MatDiaAC
			,NVL(Q3.DelDiaAE,0)						AS MatDiaAE
			,NVL(Q3.DelDia,0)						AS MatDia
			,NVL(Q3.TotalAR,0)						AS TotalMatAR
			,NVL(Q3.TotalAC,0)						AS TotalMatAC
			,NVL(Q3.TotalAE,0)						AS TotalMatAE
			,NVL(Q3.Total,0)						AS TotalMat
			,(
				SELECT
					SUM(SWBCUNI_ENRL_NUM)
				FROM
					SWBCUNI
				WHERE
					SWBCUNI_TERM_CODE = psPerio
					AND SWBCUNI_PROGRAM = SMRPRLE_PROGRAM
			)										AS Cupo
		FROM
			(
				SELECT
					Q2.Programa														AS Programa
					,SUM(Q2.DelDia*Q2.AdmAR)										AS DelDiaAR
					,SUM(Q2.DelDia*Q2.AdmAE)										AS DelDiaAE
					,SUM(Q2.DelDia*Q2.AdmAC)										AS DelDiaAC
					,SUM(Q2.DelDia)													AS DelDia
					,SUM(Q2.AdmAR)													AS TotalAR
					,SUM(Q2.AdmAE)													AS TotalAE
					,SUM(Q2.AdmAC)													AS TotalAC
					,Count(1)														AS Total
				FROM
					(SELECT
						Q1.Programa													AS Programa
						,CASE WHEN TRUNC(Q1.Fecha)=TRUNC(pdFecha) THEN 1 ELSE 0 END	AS DelDia
						,CASE WHEN ViaAdm = 'AR' THEN 1 ELSE 0 END					AS AdmAR
						,CASE WHEN ViaAdm = 'AE' THEN 1 ELSE 0 END					AS AdmAE
						,CASE WHEN ViaAdm = 'AC' THEN 1 ELSE 0 END					AS AdmAC
					FROM
						(SELECT
							TWBCNTR_ORI_PROGRAM									AS Programa
							,TWBCNTR_ISSUE_DATE									AS Fecha
							,pk_AdMat.f_Get_Rtyp_Alumn(
								TWBCNTR_PIDM
								,TWBCNTR_TERM_CODE
							)													AS ViaAdm
						FROM
							TWBCNTR
						WHERE
							TWBCNTR_TERM_CODE = psPerio
							AND TWBCNTR_STATUS_IND = 'A'
							AND FWATYALUFT(TWBCNTR_PIDM, TWBCNTR_TERM_CODE) = 'N'
							AND TRUNC(TWBCNTR_ISSUE_DATE) <= TRUNC(pdFecha)
							AND NOT EXISTS(
								SELECT
									1
								FROM
									TWBRETR
								WHERE
									TWBRETR_CNTR_NUM = TWBCNTR_NUM
							)) Q1
					) Q2
				GROUP BY
					Q2.Programa
			) Q3
			,SMRPRLE
		WHERE
			SMRPRLE_PROGRAM = Q3.Programa
			AND (psProg IS NULL OR SMRPRLE_PROGRAM = psProg)
		ORDER BY
			SMRPRLE_PROGRAM_DESC;

BEGIN

	--Seguridad de GWAMNUR
	IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

	--Obtengo el numero de corte que se desea para el usuario dado
	vsPerio := pk_objHtml.getValueCookie('psPerio');

	--Obtengo de las cookies el valor fechas de corte de caja
	vsProg := pk_objHtml.getValueCookie('psProgr');

	--Obtenemos la fecha
	vdFecha := NVL(
		TO_DATE(pk_objHtml.getValueCookie('psFecha'),'DD/MM/YYYY')
		,SYSDATE
	);

	-- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
	tabColumna.EXTEND(vnColumnas);

	--Guardamos los encabezados en el arreglo de columnas
	tabColumna( 1) := 'Cod. Prog.';
	tabColumna( 2) := 'Programa';
	tabColumna( 3) := 'Mat. Regular del Dia<br/>'||TO_CHAR(vdFecha,'DD/MM/YYYY');
	tabColumna( 4) := 'Mat. Especial del Dia<br/>'||TO_CHAR(vdFecha,'DD/MM/YYYY');
	tabColumna( 5) := 'Mat. Complementaria del Dia<br/>'||TO_CHAR(vdFecha,'DD/MM/YYYY');
	tabColumna( 6) := 'Matriculados del Dia <br/>'||TO_CHAR(vdFecha,'DD/MM/YYYY');
	tabColumna( 7) := 'Mat. Acumulada Regular';
	tabColumna( 8) := 'Mat. Acumulada Especial';
	tabColumna( 9) := 'Mat. Acumulada Complementaria';
	tabColumna(10) := 'Matriculados Acumulado';

	--Inicializamos contador de renglones
	vnRow := 0;

	--Inicializamos los totales
	vnTotalMat := 0;
	vnTotalMatAR := 0;
	vnTotalMatAE := 0;
	vnTotalMatAC := 0;
	vnTotalDia := 0;
	vnTotalDiaAR := 0;
	vnTotalDiaAE := 0;
	vnTotalDiaAC := 0;

	FOR regReporte IN cuReporte(vsPerio, vsProg, vdFecha) LOOP

		--Incremento el contador de renglones
		vnRow := vnRow + 1;
		vnExists := 1; --Bandera para indicar que hubo resultados

		--Si es el primer renglon de cada pgina...
		IF MOD(vnRow, vnRegsPag) = 1  THEN
			--imprimo el encabezado de reporte
			Pk_Sisrepimp.P_EncabezadoDeReporte(
				psReclDesc ,vnColumnas ,tabColumna
				,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
			);
			vsInicoPag := 'SALTO';
		END IF;

		--Comienzo a desplegar el renglon
		HTP.P('<tr>');

		HTP.P('<td>'||regReporte.Prog||'</td>');
		HTP.P('<td>'||regReporte.ProgDesc||'</td>');

		HTP.P('<td style="text-align:right;">'||regReporte.MatDiaAR ||'</td>');
		HTP.P('<td style="text-align:right;">'||regReporte.MatDiaAE ||'</td>');
		HTP.P('<td style="text-align:right;">'||regReporte.MatDiaAC ||'</td>');
		HTP.P('<td style="text-align:right;">'||regReporte.MatDia ||'</td>');

		HTP.P('<td style="text-align:right;">'||regReporte.TotalMatAR ||'</td>');
		HTP.P('<td style="text-align:right;">'||regReporte.TotalMatAE ||'</td>');
		HTP.P('<td style="text-align:right;">'||regReporte.TotalMatAC ||'</td>');
		HTP.P('<td style="text-align:right;">'||regReporte.TotalMat||'</td>');


		--Fin del renglon
		HTP.P('</tr>');

		--Voy sumando a los totales
		vnTotalDiaAR := vnTotalDiaAR +  regReporte.MatDiaAR;
		vnTotalDiaAE := vnTotalDiaAE +  regReporte.MatDiaAE;
		vnTotalDiaAC := vnTotalDiaAC +  regReporte.MatDiaAC;
		vnTotalDia := vnTotalDia + regReporte.MatDia;

		vnTotalMatAR := vnTotalMatAR + regReporte.TotalMatAR;
		vnTotalMatAE := vnTotalMatAE + regReporte.TotalMatAE;
		vnTotalMatAC := vnTotalMatAC + regReporte.TotalMatAC;
		vnTotalMat := vnTotalMat + regReporte.TotalMat;


	END LOOP;

	--Si existio un renglon despliego el renglon de totales
	IF vnRow > 0 THEN
		HTP.P('<tr>');
		HTP.P('<td style="border:0px">&nbsp;</td>');
		HTP.P('<td style="font-weight:bold;"> Total: </td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalDiaAR,'999G999G999')||'</td>');
			HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalDiaAE,'999G999G999')||'</td>');
			HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalDiaAC,'999G999G999')||'</td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalDia,'999G999G999')||'</td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalMatAR,'999G999G999')||'</td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalMatAE,'999G999G999')||'</td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalMatAC,'999G999G999')||'</td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalMat,'999G999G999')||'</td>');
		HTP.P('</tr>');
	END IF;

	IF vnExists = 0 THEN
		--Ojo esta linea lo que hace es imprimir
		--NO SE ENCONTRARON DATOS o un mensaje similar
		htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
	ELSE

		-- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
		Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

		-- es omitido el encabezado del reporte pero se agrega el salto de pagina
		Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
	END IF;

	--Fin de la pagina
	htp.p('</table><br/></body></html>');
EXCEPTION
	WHEN OTHERS THEN
		--pantallazo de error.
		pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
			'PWRMNLA', NULL);
END PWRMNLA;
/


DROP PUBLIC SYNONYM PWRMNLA;

CREATE PUBLIC SYNONYM PWRMNLA FOR BANINST1.PWRMNLA;


GRANT EXECUTE ON BANINST1.PWRMNLA TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRMNLA TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRMNLA TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRMNLA TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRMNLA TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRMNLD;

CREATE OR REPLACE PROCEDURE BANINST1.PWRMNLD (
	psReclDesc			VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:		PWRMNLD
OBJETIVO:			Reporte de Matricula: Nuevo Ingreso, Ligero, detallado
PARAMETROS:
psReclDesc			Variable estandar para la maquina de reportes custom
AUTOR:				Gilberto Velazquez Hernandez
FECHA:				20110106
******************************************************************************/

	--Numero de renglones
	vnRow				PLS_INTEGER := 0;
	--Bandera para mostrar si hubo datos
	vnExists			INTEGER := 0;
	--Numero de columnas
	vnColumnas			INTEGER := 11;
	--Numero de registros
	vnRegs				INTEGER := 0;
	--Arreglo (nested table) donde se guardan los encabezados de las columnas
	tabColumna			Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
	-- la variable es una bandera que al tener el valor "imprime" no colocara
	--el salto de pgina para impresion
	vsInicoPag			VARCHAR2(10) := NULL;
	--Nmero de renglones por pgina
	vnRegsPag			PLS_INTEGER := 50;

	--Variable para guardar el periodo deseado
	vsPerio				STVTERM.STVTERM_CODE%TYPE;
	--Variable para guardar EL PROGRAMA DESEADO
	vsProg				SMRPRLE.SMRPRLE_PROGRAM%TYPE;

	CURSOR cuReporte(
		psPerio			VARCHAR2
		,psProg			VARCHAR2
	) IS
		SELECT
			SPBPERS_NAME_SUFFIX							AS RutAlu
			,SPRIDEN_ID									AS IdAlu
			,SPRIDEN_LAST_NAME ||' '
				||SPRIDEN_FIRST_NAME					AS NomAlu
			,A.SGBSTDN_PROGRAM_1						AS Prog
			,SMRPRLE_PROGRAM_DESC						AS ProgDesc
			,TWBCNTR_NUM								AS CntrNum
			,TRUNC(TWBCNTR_ISSUE_DATE)					AS FechaCntr
			,(
				SELECT
					MAX(T1.SORTEST_TEST_SCORE)
				FROM
					SWBPRCT
					,SORTEST T1
				WHERE
					T1.SORTEST_PIDM = SPRIDEN_PIDM
					AND T1.SORTEST_TESC_CODE = SWBPRCT_TESC_CODE_POND
					AND SWBPRCT_PROGRAM = A.SGBSTDN_PROGRAM_1
--					AND T1.SORTEST_TEST_DATE =
--						(SELECT
--							MAX(T2.SORTEST_TEST_DATE)
--						FROM
--							SORTEST T2
--						WHERE
--							T2.SORTEST_PIDM = T1.SORTEST_PIDM
--							AND T2.SORTEST_TESC_CODE = T1.SORTEST_TESC_CODE
--					)
			)											AS Puntaje
			,(
				SELECT
					STVADMT_DESC
				FROM
					STVADMT
				WHERE
					STVADMT_CODE = A.SGBSTDN_ADMT_CODE
			)											AS ViaAdm
			,(
				SELECT
					STVRTYP_DESC
				FROM
					STVRTYP
					,SWVTAVI
				WHERE
					STVRTYP_CODE = SWVTAVI_RTYP_CODE
					AND SWVTAVI_TERM_CODE = TWBCNTR_TERM_CODE
					AND SWVTAVI_ADMT_CODE =  A.SGBSTDN_ADMT_CODE
			)											AS ViaIngreso
			,(
				SELECT
					'Si'
				FROM
					TWBRETR
				WHERE
					TWBRETR_CNTR_NUM = TWBCNTR_NUM
			)											AS Retracto
		FROM
			SPRIDEN
			,SPBPERS
			,SMRPRLE
			,SGBSTDN A
			,TWBCNTR
		WHERE
				SPRIDEN_PIDM = SPBPERS_PIDM
				AND SPRIDEN_CHANGE_IND IS NULL
				AND SPBPERS_PIDM = TWBCNTR_PIDM
				AND A.SGBSTDN_PIDM = TWBCNTR_PIDM
				AND A.SGBSTDN_TERM_CODE_EFF = (
					SELECT
						MAX(B.SGBSTDN_TERM_CODE_EFF)
					FROM
						SGBSTDN B
					WHERE
						B.SGBSTDN_PIDM = A.SGBSTDN_PIDM
						AND B.SGBSTDN_TERM_CODE_EFF <= psPerio)
				AND TWBCNTR_TERM_CODE = psPerio
				AND A.SGBSTDN_PROGRAM_1 = SMRPRLE.SMRPRLE_PROGRAM
				AND TWBCNTR_STATUS_IND = 'A'
				--GVH: 20110314 las reglas de nuevo ingreso cambiaron y se
				--reflejan en este AND
				AND(
					(NOT EXISTS(
						--Verifica que no tenga cursos inscritos en periodos
						-- anteriores al actual
						SELECT
							1
						FROM
							SFRSTCR
						WHERE
							SFRSTCR_RSTS_CODE IN ('RE', 'RW')
							AND SFRSTCR_LEVL_CODE IN ('LC', 'LI')
							AND SFRSTCR_TERM_CODE < psPerio
							AND SFRSTCR_PIDM = A.SGBSTDN_PIDM
					) AND NOT EXISTS(
						--Verifica que no haya registros de historia academica
						SELECT
							1
						FROM
							SHRTCKN
						INNER JOIN
							SHRTCKL
						ON
							SHRTCKN_PIDM = SHRTCKL_PIDM
							AND SHRTCKN_TERM_CODE = SHRTCKL_TERM_CODE
							AND SHRTCKN_SEQ_NO = SHRTCKL_TCKN_SEQ_NO
						WHERE
							SHRTCKN_TERM_CODE < psPerio
							AND SHRTCKN_PIDM = A.SGBSTDN_PIDM
							AND SHRTCKL_LEVL_CODE IN ('LC', 'LI')
					))OR (
						--Educacion Media, bandera con N, periodo = que el
						--del contrato
						A.SGBSTDN_TERM_CODE_EFF = TWBCNTR_TERM_CODE
						AND A.SGBSTDN_STYP_CODE = 'N'
						AND A.SGBSTDN_MAJR_CODE_1 = 'EDME'
					)
				)
				AND (psProg IS NULL OR a.SGBSTDN_PROGRAM_1 = psProg);

BEGIN

	--Seguridad de GWAMNUR
	IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

	--Obtengo el numero de corte que se desea para el usuario dado
	vsPerio := pk_objHtml.getValueCookie('psPerio');

	--Obtengo de las cookies el valor fechas de corte de caja
	vsProg := pk_objHtml.getValueCookie('psProgr');

	-- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
	tabColumna.EXTEND(vnColumnas);

	--Guardamos los encabezados en el arreglo de columnas
	tabColumna( 1) := 'Rut Alumno';
	tabColumna( 2) := 'ID Alumno';
	tabColumna( 3) := 'Nombre Alumno';
	tabColumna( 4) := 'Programa';
	tabColumna( 5) := 'Nombre Programa';
	tabColumna( 6) := 'Numero de Contrato';
	tabColumna( 7) := 'Fecha de Contrato';
	tabColumna( 8) := 'Puntaje Ponderado';
	tabColumna( 9) := 'Tipo de Admision';
	tabColumna(10) := 'Via de Admision';
	tabColumna(11) := 'Retracto';

	--Inicializamos contador de renglones
	vnRow := 0;

	FOR regReporte IN cuReporte(vsPerio, vsProg) LOOP

		--Incremento el contador de renglones
		vnRow := vnRow + 1;
		vnExists := 1; --Bandera para indicar que hubo resultados

		--Si es el primer renglon de cada pgina...
		IF MOD(vnRow, vnRegsPag) = 1  THEN
			--imprimo el encabezado de reporte
			Pk_Sisrepimp.P_EncabezadoDeReporte(
				psReclDesc ,vnColumnas ,tabColumna
				,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
			);
			vsInicoPag := 'SALTO';
		END IF;

		--Comienzo a desplegar el renglon
		HTP.P('<tr>');
		HTP.P('<td>'||regReporte.RutAlu||'</td>');
		HTP.P('<td>'||regReporte.IdAlu||'</td>');
		HTP.P('<td>'||regReporte.NomAlu ||'</td>');
		HTP.P('<td>'||regReporte.Prog||'</td>');
		HTP.P('<td>'||regReporte.ProgDesc||'</td>');
		HTP.P('<td>'||regReporte.CntrNum||'</td>');
		HTP.P('<td>'||regReporte.FechaCntr ||'</td>');
		HTP.P('<td>'||regReporte.Puntaje ||'</td>');
		HTP.P('<td>'||regReporte.ViaAdm ||'</td>');
		HTP.P('<td>'||regReporte.ViaIngreso ||'</td>');
		HTP.P('<td>'||regReporte.Retracto ||'</td>');
		--Fin del renglon
		HTP.P('</tr>');

	END LOOP;

	IF vnExists = 0 THEN
		--Ojo esta linea lo que hace es imprimir
		--NO SE ENCONTRARON DATOS o un mensaje similar
		htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
	ELSE

		-- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
		Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

		-- es omitido el encabezado del reporte pero se agrega el salto de pagina
		Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
	END IF;

	--Fin de la pagina
	htp.p('</table><br/></body></html>');
EXCEPTION
	WHEN OTHERS THEN
		--pantallazo de error.
		pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
			'PWRMNLD', NULL);
END PWRMNLD;
/


DROP PUBLIC SYNONYM PWRMNLD;

CREATE PUBLIC SYNONYM PWRMNLD FOR BANINST1.PWRMNLD;


GRANT EXECUTE ON BANINST1.PWRMNLD TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRMNLD TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRMNLD TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRMNLD TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRMNLD TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRMNLD3;

CREATE OR REPLACE PROCEDURE BANINST1.PWRMNLD3 (
    psReclDesc            VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:        PWRMNLD3
OBJETIVO:            Reporte de Matricula: Nuevo Ingreso, Ligero, detallado
PARAMETROS:          psReclDesc
psReclDesc           Variable estandar para la maquina de reportes custom
AUTOR:               Gilberto Velazquez Hernandez
FECHA:               20110106
******************************************************************************/

    --Numero de renglones
    vnRow                  PLS_INTEGER := 0;
    --Bandera para mostrar si hubo datos
    vnExists                INTEGER := 0;
    --Numero de columnas
    vnColumnas          INTEGER := 12;
    --Numero de registros
    vnRegs                 INTEGER := 0;
    --Arreglo (nested table) donde se guardan los encabezados de las columnas
    tabColumna            Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
    -- la variable es una bandera que al tener el valor "imprime" no colocara
    --el salto de pgina para impresion
    vsInicoPag            VARCHAR2(10) := NULL;
    --Nmero de renglones por pgina
    vnRegsPag            PLS_INTEGER := 99999;

    --Variable para guardar el periodo deseado
    vsPerio                STVTERM.STVTERM_CODE%TYPE;
    --Variable para guardar EL PROGRAMA DESEADO
    vsProg                SMRPRLE.SMRPRLE_PROGRAM%TYPE;
    --Variable para guardar el Indicador Semestral
    vsIndSe              SARAATT.SARAATT_ATTS_CODE%TYPE;

    CURSOR cuReporte(
        psPerio            VARCHAR2
        ,psProg            VARCHAR2
        ,psIndSe          VARCHAR2
    ) IS
        SELECT distinct SPBPERS_NAME_SUFFIX                                              AS RutAlu
                   ,SPRIDEN_ID                                                                AS IdAlu
                   ,SPRIDEN_LAST_NAME ||' '||SPRIDEN_FIRST_NAME       AS NomAlu
                   ,A.SGBSTDN_PROGRAM_1                                             AS Prog
                   ,SMRPRLE_PROGRAM_DESC                                          AS ProgDesc
                   ,TWBCNTR_NUM                                                          AS CntrNum
                   ,TRUNC(TWBCNTR_ISSUE_DATE)                                  AS FechaCntr
            ,(SELECT MAX(T1.SORTEST_TEST_SCORE)
                FROM  SWBPRCT
                          ,SORTEST T1
              WHERE T1.SORTEST_PIDM = SPRIDEN_PIDM
                   AND T1.SORTEST_TESC_CODE = SWBPRCT_TESC_CODE_POND
                   AND SWBPRCT_PROGRAM = A.SGBSTDN_PROGRAM_1
            )                                                                                           AS Puntaje
            ,(SELECT STVADMT_DESC
                FROM  STVADMT
              WHERE  STVADMT_CODE = A.SGBSTDN_ADMT_CODE)           AS ViaAdm
            ,(SELECT STVRTYP_DESC
                FROM  STVRTYP
                         ,SWVTAVI
              WHERE STVRTYP_CODE  = SWVTAVI_RTYP_CODE
                   AND SWVTAVI_TERM_CODE = TWBCNTR_TERM_CODE
                    AND SWVTAVI_ADMT_CODE =  A.SGBSTDN_ADMT_CODE)  AS ViaIngreso
            ,(SELECT 'Si'
                FROM TWBRETR
              WHERE TWBRETR_CNTR_NUM = TWBCNTR_NUM)                    AS Retracto
             ,  (SELECT 'Si'
                FROM SFRWDRL
                WHERE SFRWDRL_PIDM = A.SGBSTDN_PIDM
                AND SFRWDRL_TERM_CODE = TWBCNTR_TERM_CODE
                AND SFRWDRL_WDRL_CODE= 'R2')                    AS Ext
        FROM  SPRIDEN
                    ,SPBPERS
                    ,SMRPRLE
                    ,SGBSTDN A
                    ,SWVTAVI
                    ,TWBCNTR
                    ,SARAATT
                  WHERE SPRIDEN_PIDM = SPBPERS_PIDM
             AND SPRIDEN_CHANGE_IND IS NULL
             --AND SPRIDEN_PIDM = SARADAP_PIDM
             AND SPBPERS_PIDM = TWBCNTR_PIDM
             AND A.SGBSTDN_PIDM = TWBCNTR_PIDM
             AND SWVTAVI_ADMT_CODE = SGBSTDN_ADMT_CODE
             AND SWVTAVI_RTYP_CODE IN ('AR', 'AE','AC')
             AND FWATYALUFT(TWBCNTR_PIDM, TWBCNTR_TERM_CODE) = 'N'
             AND SWVTAVI_TERM_CODE = TWBCNTR_TERM_CODE
             AND (SARAATT_ATTS_CODE = psIndSe OR psIndSe IS NULL)
             AND EXISTS (SELECT 1 FROM SARADAP
             			WHERE SARADAP_PIDM = TWBCNTR_PIDM
                        AND SARADAP_TERM_CODE_ENTRY = A.SGBSTDN_TERM_CODE_EFF
                        --AND SARADAP_APPL_NO = SARAATT_APPL_NO
			AND SARADAP_PROGRAM_1 = A.SGBSTDN_PROGRAM_1)
             AND SARAATT_TERM_CODE = TWBCNTR_TERM_CODE
             AND SARAATT_PIDM = TWBCNTR_PIDM
            --AND SARADAP_APPL_NO = SARAATT_APPL_NO
              AND TWBCNTR_TERM_CODE = psPerio
              AND SGBSTDN_TERM_CODE_EFF = psPerio
              AND A.SGBSTDN_PROGRAM_1 = SMRPRLE.SMRPRLE_PROGRAM
              AND TWBCNTR_STATUS_IND = 'A'
                AND (psProg IS NULL OR a.SGBSTDN_PROGRAM_1 = psProg)
                AND A.SGBSTDN_STYP_CODE IN('N','D','R') ;


BEGIN

    --Seguridad de GWAMNUR
    IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

    --Obtengo el numero de corte que se desea para el usuario dado
    vsPerio := pk_objHtml.getValueCookie('psPerio');

    --Obtengo de las cookies el valor fechas de corte de caja
    vsProg := pk_objHtml.getValueCookie('psProgr');

    vsIndSe := pk_objHtml.getValueCookie('psIndSe');

    -- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
    tabColumna.EXTEND(vnColumnas);

    --Guardamos los encabezados en el arreglo de columnas
    tabColumna( 1) := 'Rut Alumno';
    tabColumna( 2) := 'ID Alumno';
    tabColumna( 3) := 'Nombre Alumno';
    tabColumna( 4) := 'Programa';
    tabColumna( 5) := 'Nombre Programa';
    tabColumna( 6) := 'Numero de Contrato';
    tabColumna( 7) := 'Fecha de Contrato';
    tabColumna( 8) := 'Puntaje Ponderado';
    tabColumna( 9) := 'Tipo de Admision';
    tabColumna(10) := 'Via de Admision';
    tabColumna(11) := 'Retracto';
	tabColumna(12) := 'Retracto Extemporneo';
    --Inicializamos contador de renglones
    vnRow := 0;
    -- Obtiene el Periodo y el Programa que son los parametros pedidos para el reporte.
    FOR regReporte IN cuReporte(vsPerio, vsProg, vsIndSe) LOOP

        --Incremento el contador de renglones
        vnRow := vnRow + 1;
        vnExists := 1; --Bandera para indicar que hubo resultados

        --Si es el primer renglon de cada pgina...
        IF MOD(vnRow, vnRegsPag) = 1  THEN
            --imprimo el encabezado de reporte
            Pk_Sisrepimp.P_EncabezadoDeReporte(
                psReclDesc ,vnColumnas ,tabColumna
                ,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
            );
           -- vsInicoPag := 'SALTO';
        END IF;

        --Comienzo a desplegar el renglon
        HTP.P('<tr>');
        HTP.P('<td>'||regReporte.RutAlu||'</td>');
        HTP.P('<td>'||regReporte.IdAlu||'</td>');
        HTP.P('<td>'||regReporte.NomAlu ||'</td>');
        HTP.P('<td>'||regReporte.Prog||'</td>');
        HTP.P('<td>'||regReporte.ProgDesc||'</td>');
        HTP.P('<td>'||regReporte.CntrNum||'</td>');
        HTP.P('<td>'||regReporte.FechaCntr ||'</td>');
        HTP.P('<td>'||regReporte.Puntaje ||'</td>');
        HTP.P('<td>'||regReporte.ViaAdm ||'</td>');
        HTP.P('<td>'||regReporte.ViaIngreso ||'</td>');
        HTP.P('<td>'||regReporte.Retracto ||'</td>');
        HTP.P('<td>'||regReporte.Ext ||'</td>');
        --Fin del renglon
        HTP.P('</tr>');

    END LOOP;

    IF vnExists = 0 THEN
        --Ojo esta linea lo que hace es imprimir
        --NO SE ENCONTRARON DATOS o un mensaje similar
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
    ELSE

        -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pagina
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
    END IF;

    --Fin de la pagina
    htp.p('</table><br/></body></html>');
EXCEPTION
    WHEN OTHERS THEN
        --pantallazo de error.
        pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
            'PWRMNLD3', NULL);
END PWRMNLD3;
/


DROP PUBLIC SYNONYM PWRMNLD3;

CREATE PUBLIC SYNONYM PWRMNLD3 FOR BANINST1.PWRMNLD3;


GRANT EXECUTE ON BANINST1.PWRMNLD3 TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRMNLI;

CREATE OR REPLACE PROCEDURE BANINST1.PWRMNLI (
	psReclDesc			VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:		PWRMNLA
OBJETIVO:			Reporte de Matricula: Nuevo Ingreso, "Ligero", acumulado
PARAMETROS:
psReclDesc			Variable estandar para la maquina de reportes custom
AUTOR:				Gilberto Velazquez Hernandez
FECHA:				20110106
******************************************************************************/
	--Numero de renglones
	vnRow				PLS_INTEGER := 0;
	--Bandera para mostrar si hubo datos
	vnExists			INTEGER := 0;
	--Numero de columnas
	vnColumnas			INTEGER := 10;
	--Numero de registros
	vnRegs				INTEGER := 0;
	--Arreglo (nested table) donde se guardan los encabezados de las columnas
	tabColumna			Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
	-- la variable es una bandera que al tener el valor "imprime" no colocara
	--el salto de pgina para impresion
	vsInicoPag			VARCHAR2(10) := NULL;
	--Nmero de renglones por pgina
	vnRegsPag			PLS_INTEGER := 25;

	--Variable para guardar el periodo deseado
	vsPerio				STVTERM.STVTERM_CODE%TYPE;
        --Variable de atributos
    vsIndSe         SARAATT.SARAATT_ATTS_CODE%TYPE;

	--Variable para guardar EL PROGRAMA DESEADO
	vsProg				SMRPRLE.SMRPRLE_PROGRAM%TYPE;
	--Variable para guardar el total de matriculados
	vnTotalMat			PLS_INTEGER;
	--Total de matriculados AR
	vnTotalMatAR		PLS_INTEGER;
	--Total de matriculados AE
	vnTotalMatAE		PLS_INTEGER;
	--Total de matriculados AC
	vnTotalMatAC		PLS_INTEGER;

	--Variable para guardar el total de matriculados del dia
	vnTotalDia			PLS_INTEGER;
	--Total del dia AR
	vnTotalDiaAR		PLS_INTEGER;
	--Total del dia AE
	vnTotalDiaAE		PLS_INTEGER;
	--Total del dia AC
	vnTotalDiaAC		PLS_INTEGER;
	--Fecha del reporte
	vdFecha				DATE;

	CURSOR cuReporte(
		psPerio			VARCHAR2
		,psProg			VARCHAR2
        ,psIndSe          VARCHAR2
		,pdFecha		DATE DEFAULT SYSDATE
	) IS
		SELECT
			SMRPRLE_PROGRAM							AS Prog
			,SMRPRLE_PROGRAM_DESC					AS ProgDesc
			,NVL(Q3.DelDiaAR,0)						AS MatDiaAR
			,NVL(Q3.DelDiaAC,0)						AS MatDiaAC
			,NVL(Q3.DelDiaAE,0)						AS MatDiaAE
			,NVL(Q3.DelDia,0)						AS MatDia
			,NVL(Q3.TotalAR,0)						AS TotalMatAR
			,NVL(Q3.TotalAC,0)						AS TotalMatAC
			,NVL(Q3.TotalAE,0)						AS TotalMatAE
			,NVL(Q3.Total,0)						AS TotalMat
			,(
				SELECT
					SUM(SWBCUNI_ENRL_NUM)
				FROM
					SWBCUNI
				WHERE
					SWBCUNI_TERM_CODE = psPerio
					AND SWBCUNI_PROGRAM = SMRPRLE_PROGRAM
			)										AS Cupo
		FROM
			(
				SELECT
					Q2.Programa														AS Programa
					,SUM(Q2.DelDia*Q2.AdmAR)										AS DelDiaAR
					,SUM(Q2.DelDia*Q2.AdmAE)										AS DelDiaAE
					,SUM(Q2.DelDia*Q2.AdmAC)										AS DelDiaAC
					,SUM(Q2.DelDia)													AS DelDia
					,SUM(Q2.AdmAR)													AS TotalAR
					,SUM(Q2.AdmAE)													AS TotalAE
					,SUM(Q2.AdmAC)													AS TotalAC
					,Count(1)														AS Total
				FROM
					(SELECT
						Q1.Programa													AS Programa
						,CASE WHEN TRUNC(Q1.Fecha)=TRUNC(pdFecha) THEN 1 ELSE 0 END	AS DelDia
						,CASE WHEN ViaAdm = 'AR' THEN 1 ELSE 0 END					AS AdmAR
						,CASE WHEN ViaAdm = 'AE' THEN 1 ELSE 0 END					AS AdmAE
						,CASE WHEN ViaAdm = 'AC' THEN 1 ELSE 0 END					AS AdmAC
					FROM
						(SELECT
							f_get_programa(TWBCNTR_PIDM, TWBCNTR_TERM_CODE)		AS Programa
							,TWBCNTR_ISSUE_DATE									AS Fecha
							,pk_AdMat.f_Get_Rtyp_Alumn(
								TWBCNTR_PIDM
								,TWBCNTR_TERM_CODE
							)													AS ViaAdm
						FROM
							TWBCNTR, SARAATT A

						WHERE
							TWBCNTR_TERM_CODE = psPerio
							AND TWBCNTR_STATUS_IND = 'A'
                            AND A.SARAATT_TERM_CODE = TWBCNTR_TERM_CODE
                            AND A.SARAATT_PIDM = TWBCNTR_PIDM
                            AND (A.SARAATT_ATTS_CODE = vsIndSe or vsIndSe is null)
                            AND A.SARAATT_APPL_NO = (SELECT MAX(B.SARAATT_APPL_NO) FROM SARAATT B
                            						WHERE A.SARAATT_PIDM = B.SARAATT_PIDM
                                                    AND A.SARAATT_TERM_CODE = B.SARAATT_TERM_CODE)
							AND FWATYALUFT(TWBCNTR_PIDM, TWBCNTR_TERM_CODE) = 'N'
							AND TRUNC(TWBCNTR_ISSUE_DATE) <= TRUNC(pdFecha)
							AND NOT EXISTS(
								SELECT
									1
								FROM
									TWBRETR
								WHERE
									TWBRETR_CNTR_NUM = TWBCNTR_NUM
							)
                           AND NOT EXISTS (SELECT 1 FROM SFRWDRL
                           				WHERE SFRWDRL_PIDM = TWBCNTR_PIDM
                                        AND SFRWDRL_TERM_CODE = TWBCNTR_TERM_CODE
                                        AND SFRWDRL_WDRL_CODE = 'R2'
                                        )

                            ) Q1
					) Q2
				GROUP BY
					Q2.Programa
			) Q3
			,SMRPRLE
		WHERE
			SMRPRLE_PROGRAM = Q3.Programa
			AND (psProg IS NULL OR SMRPRLE_PROGRAM = psProg)
		ORDER BY
			SMRPRLE_PROGRAM_DESC;

BEGIN

--	 IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

 IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

	--Obtengo el numero de corte que se desea para el usuario dado
	vsPerio := pk_objHtml.getValueCookie('psPerio');

	--Obtengo de las cookies el valor fechas de corte de caja
	vsProg := pk_objHtml.getValueCookie('psProgr');
    vsIndSe:= pk_objHtml.getValueCookie('psIndSe');

	--Obtenemos la fecha
	vdFecha := NVL(
		TO_DATE(pk_objHtml.getValueCookie('psFecha'),'DD/MM/YYYY')
		,SYSDATE
	);

	-- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
	tabColumna.EXTEND(vnColumnas);

	--Guardamos los encabezados en el arreglo de columnas
	tabColumna( 1) := 'Cod. Prog.';
	tabColumna( 2) := 'Programa';
	tabColumna( 3) := 'Mat. Regular del Dia<br/>'||TO_CHAR(vdFecha,'DD/MM/YYYY');
	tabColumna( 4) := 'Mat. Especial del Dia<br/>'||TO_CHAR(vdFecha,'DD/MM/YYYY');
	tabColumna( 5) := 'Mat. Complementaria del Dia<br/>'||TO_CHAR(vdFecha,'DD/MM/YYYY');
	tabColumna( 6) := 'Matriculados del Dia <br/>'||TO_CHAR(vdFecha,'DD/MM/YYYY');
	tabColumna( 7) := 'Mat. Acumulada Regular';
	tabColumna( 8) := 'Mat. Acumulada Especial';
	tabColumna( 9) := 'Mat. Acumulada Complementaria';
	tabColumna(10) := 'Matriculados Acumulado';

	--Inicializamos contador de renglones
	vnRow := 0;

	--Inicializamos los totales
	vnTotalMat := 0;
	vnTotalMatAR := 0;
	vnTotalMatAE := 0;
	vnTotalMatAC := 0;
	vnTotalDia := 0;
	vnTotalDiaAR := 0;
	vnTotalDiaAE := 0;
	vnTotalDiaAC := 0;

	FOR regReporte IN cuReporte(vsPerio, vsProg, vsIndSe, vdFecha) LOOP

		--Incremento el contador de renglones
		vnRow := vnRow + 1;
		vnExists := 1; --Bandera para indicar que hubo resultados

		--Si es el primer renglon de cada pgina...
		IF MOD(vnRow, vnRegsPag) = 1  THEN
			--imprimo el encabezado de reporte
			Pk_Sisrepimp.P_EncabezadoDeReporte(
				psReclDesc ,vnColumnas ,tabColumna
				,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
			);
			vsInicoPag := 'SALTO';
		END IF;

		--Comienzo a desplegar el renglon
		HTP.P('<tr>');

		HTP.P('<td>'||regReporte.Prog||'</td>');
		HTP.P('<td>'||regReporte.ProgDesc||'</td>');

		HTP.P('<td style="text-align:right;">'||regReporte.MatDiaAR ||'</td>');
		HTP.P('<td style="text-align:right;">'||regReporte.MatDiaAE ||'</td>');
		HTP.P('<td style="text-align:right;">'||regReporte.MatDiaAC ||'</td>');
		HTP.P('<td style="text-align:right;">'||regReporte.MatDia ||'</td>');

		HTP.P('<td style="text-align:right;">'||regReporte.TotalMatAR ||'</td>');
		HTP.P('<td style="text-align:right;">'||regReporte.TotalMatAE ||'</td>');
		HTP.P('<td style="text-align:right;">'||regReporte.TotalMatAC ||'</td>');
		HTP.P('<td style="text-align:right;">'||regReporte.TotalMat||'</td>');


		--Fin del renglon
		HTP.P('</tr>');

		--Voy sumando a los totales
		vnTotalDiaAR := vnTotalDiaAR +  regReporte.MatDiaAR;
		vnTotalDiaAE := vnTotalDiaAE +  regReporte.MatDiaAE;
		vnTotalDiaAC := vnTotalDiaAC +  regReporte.MatDiaAC;
		vnTotalDia := vnTotalDia + regReporte.MatDia;

		vnTotalMatAR := vnTotalMatAR + regReporte.TotalMatAR;
		vnTotalMatAE := vnTotalMatAE + regReporte.TotalMatAE;
		vnTotalMatAC := vnTotalMatAC + regReporte.TotalMatAC;
		vnTotalMat := vnTotalMat + regReporte.TotalMat;


	END LOOP;

	--Si existio un renglon despliego el renglon de totales
	IF vnRow > 0 THEN
		HTP.P('<tr>');
		HTP.P('<td style="border:0px">&nbsp;</td>');
		HTP.P('<td style="font-weight:bold;"> Total: </td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalDiaAR,'999G999G999')||'</td>');
			HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalDiaAE,'999G999G999')||'</td>');
			HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalDiaAC,'999G999G999')||'</td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalDia,'999G999G999')||'</td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalMatAR,'999G999G999')||'</td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalMatAE,'999G999G999')||'</td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalMatAC,'999G999G999')||'</td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalMat,'999G999G999')||'</td>');
		HTP.P('</tr>');
	END IF;

	IF vnExists = 0 THEN
		--Ojo esta linea lo que hace es imprimir
		--NO SE ENCONTRARON DATOS o un mensaje similar
		htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
	ELSE

		-- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
		Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

		-- es omitido el encabezado del reporte pero se agrega el salto de pagina
		Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
	END IF;

	--Fin de la pagina
	htp.p('</table><br/></body></html>');
EXCEPTION
	WHEN OTHERS THEN
		--pantallazo de error.
		pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
			'PWRMNLI', NULL);
END PWRMNLI;
/


DROP PUBLIC SYNONYM PWRMNLI;

CREATE PUBLIC SYNONYM PWRMNLI FOR BANINST1.PWRMNLI;


GRANT EXECUTE ON BANINST1.PWRMNLI TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRMORO;

CREATE OR REPLACE PROCEDURE BANINST1.PWRMORO(psReclDesc VARCHAR2,
                                             psSiu      VARCHAR2 DEFAULT NULL,
                                             psEje      VARCHAR2 DEFAULT NULL
                                             ) IS

/**************************************************************
           tarea:  Reporte de Morosidad
         mdulo:   Matrcula
           autor:  Alejandra Mungua
           fecha:  14/jun/2013
**************************************************************/

  vnRow        INTEGER                := 0;
  vnExists     INTEGER                := 0;
  vnColumnas   INTEGER                := 21;
  tabColumna   Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
  vsPerio      VARCHAR2(10)           := NULL;
  vsUniv       VARCHAR2(10)           := NULL;
  vsFec        VARCHAR2(15)           := NULL;
  vsHora       VARCHAR2(15)           := NULL;
  vsSeccion    VARCHAR2(3)            := NULL;
  vsTermCode   VARCHAR2(10)           := NULL;
  vsInicoPag   VARCHAR2(10)           := NULL;
  vsEncabezado VARCHAR2(1)            := NULL;
  vbEncabezado BOOLEAN                := TRUE;
  vgsUSR       VARCHAR2(500);

  vnPidm       SPRIDEN.SPRIDEN_PIDM%TYPE := NULL;

  csSALTO    CONSTANT VARCHAR2(5)  := 'SALTO';
  csPIE      CONSTANT VARCHAR2(3)  := 'PIE';
  csImprime  CONSTANT VARCHAR2(7)  := 'Imprime';
  csDDMMRRRR CONSTANT VARCHAR2(10) := 'DD/MM/YYYY';
  csN        CONSTANT VARCHAR2(1)  := 'N';
  csSesp     CONSTANT VARCHAR2(1)  := '';
  cn0        CONSTANT NUMBER(1)    := 0;
  cn1        CONSTANT NUMBER(1)    := 1;
  cn10000    CONSTANT NUMBER(5)    := 10000;




  CURSOR cuReporte(psHora VARCHAR2, psPerio VARCHAR2,psFec VARCHAR2) IS
         SELECT TWRMORO_CNTR_NUM CONTRATO,
                TWRMORO_AMOUNT MONTO,
                TWRMORO_CNTR_TERM_CODE PERIODO_CONTRATO,
                TWRMORO_DOCU_TERM_CODE PERIODO_DOCUMENTO,
                --TWRMORO_PAYM_CODE MEDIO_PAGO,
                MAX (
                       (SELECT STVCOLL_DESC
                          FROM STVCOLL
                         WHERE STVCOLL_CODE = S1.SGBSTDN_COLL_CODE_1)
                     ) ESCUELA,
                S1.SGBSTDN_PROGRAM_1 CARRERA,
                MAX (
                       (SELECT SMRPRLE_PROGRAM_DESC
                          FROM SMRPRLE
                         WHERE SMRPRLE_PROGRAM = S1.SGBSTDN_PROGRAM_1)
                      ) DESCRIPCION_CARRERA,
                SPRIDEN_ID ID,
                TWRMORO_STU_RUT RUT,
                SPRIDEN_FIRST_NAME NOMBRE,
                SPRIDEN_LAST_NAME APELLIDOS,
                S1.SGBSTDN_STST_CODE ESTATUS,
                S1.SGBSTDN_TERM_CODE_ADMIT PERIODO_ADMISION,
                MAX (
                       (SELECT X.SGBSTDN_STST_CODE FROM SGBSTDN X
                         WHERE X.SGBSTDN_PIDM = A.TWRMORO_PIDM
                           AND X.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(Y.SGBSTDN_TERM_CODE_EFF) FROM SGBSTDN Y
                                 WHERE X.SGBSTDN_PIDM = Y.SGBSTDN_PIDM))
                    ) ACTUAL,
                SUM(TWRMORO_MORA_30) MORA_30,
                SUM(TWRMORO_MORA_90) MORA_90,
                SUM(TWRMORO_MORA_180) MORA_180,
                SUM(TWRMORO_MORA_MAYOR) MORA_MAYOR,
                SUM(TWRMORO_TOTAL_MORA) TOTAL_ADEUDO,
                SUM(TWRMORO_TOTAL_CAE) TOTAL_CAE,
                SUM(TWRMORO_TOTAL_BECAS) TOTAL_BECAS
           FROM TAISMGR.TWRMORO A, SGBSTDN S1, SPRIDEN
          WHERE A.TWRMORO_PIDM = S1.SGBSTDN_PIDM
            AND A.TWRMORO_PIDM = SPRIDEN_PIDM
            AND S1.SGBSTDN_TERM_CODE_EFF  =(SELECT MAX(S2.SGBSTDN_TERM_CODE_EFF)
                                              FROM SGBSTDN S2
                                             WHERE S1.SGBSTDN_PIDM = S2.SGBSTDN_PIDM
                                             and (S2.SGBSTDN_TERM_CODE_EFF <= psPerio OR psPerio IS NULL)--A.TWRMORO_CNTR_TERM_CODE
                                             )
            AND A.TWRMORO_REPORT_SEQ      = (SELECT MAX(B.TWRMORO_REPORT_SEQ)
                                              FROM TAISMGR.TWRMORO B
                                              WHERE B.TWRMORO_CNTR_NUM = A.TWRMORO_CNTR_NUM )
            AND (TWRMORO_REPORT_SEQ       = TO_NUMBER(psHora) OR psHora = '0')
            AND(TWRMORO_CNTR_TERM_CODE    = psPerio OR psPerio IS NULL OR psPerio = csSesp)
            AND TRUNC(TWRMORO_RANK_DATE)  <= TO_DATE(psFec,csDDMMRRRR)
            AND SPRIDEN_CHANGE_IND IS NULL
            AND TWRMORO_CNTR_NUM IS NOT NULL
          GROUP BY TWRMORO_CNTR_NUM,
                TWRMORO_AMOUNT,
                TWRMORO_CNTR_TERM_CODE,
                TWRMORO_DOCU_TERM_CODE,
                S1.SGBSTDN_PROGRAM_1,
                SPRIDEN_ID,
                TWRMORO_STU_RUT,
                SPRIDEN_FIRST_NAME,
                SPRIDEN_LAST_NAME,
                S1.SGBSTDN_STST_CODE,
                S1.SGBSTDN_TERM_CODE_ADMIT;

  BEGIN

      /* check/update the user's web session */
      --IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN  RETURN; END IF;

      IF    psSiu IS NULL THEN
            IF PK_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;
      ELSIF psSiu IS NOT NULL THEN
            IF NOT twbkwbis.f_validuser(vnPidm) THEN RETURN; END IF;
      END IF;


      vsPerio      := pk_ObjHtml.getValueCookie('psPerio');
      vsFec        := pk_ObjHtml.getValueCookie('psFecha');
      vsHora       := pk_ObjHtml.getValueCookie('psHora');
      vsEncabezado := pk_objhtml.getValueCookie('psEnca');
      vsSeccion    := pk_ObjHtml.getValueCookie('cookSeccion');

      tabColumna.EXTEND(vnColumnas);


      --Se corre el proceso que carga la tabla que lee el reporte
      IF LENGTH(vsHora) = 0 OR vsHora IS NULL  OR vsHora = '' OR vsHora = 'undefined'  THEN
         vsHora := '0';
      END IF;

      IF LENGTH(vsPerio) = 0 OR vsPerio = '' OR vsPerio = 'undefined'  THEN
         vsPerio := NULL;
      END IF;

      IF LENGTH(vsFec) = 0 OR vsFec = '' OR vsFec = 'undefined'  THEN
         vsFec := NULL;
      END IF;


      IF vsHora = '0'  AND  psEje IS NULL THEN
         BANINST1.PWPMORA (vsPerio,vsFec);
      END IF;

      --Se ponen encabezados del reporte
      tabColumna(1)  := 'Nm.Contrato';
      tabColumna(2)  := 'Total Contrato';
      tabColumna(3)  := 'Periodo del Contrato';
      tabColumna(4)  := 'Periodo Documento';
      tabColumna(5)  := 'Escuela';
      tabColumna(6)  := 'Carrera';
      tabColumna(7)  := 'Descripcin Carrera';
      tabColumna(8)  := 'ID del Alumno';
      tabColumna(9)  := 'RUT';
      tabColumna(10) := 'Nombre';
      tabColumna(11) := 'Apellidos';
      tabColumna(12) := 'Estatus del alumno <br>al contrato';
      tabColumna(13) := 'Estatus del alumno <br>actual';
      tabColumna(14) := 'Periodo de Admisin';
      tabColumna(15) := 'de 1 a 30 das';
      tabColumna(16) := 'de 31 a 90 das';
      tabColumna(17) := 'de 91 a 180 das';
      tabColumna(18) := 'Mayor a 180 das';
      tabColumna(19) := 'Total Adeudo';
      tabColumna(20) := 'Total Cae';
      tabColumna(21) := 'Total Becas';


      FOR regRep IN cuReporte(vsHora,vsPerio,vsFec) LOOP

        IF (vnRow = cn0 OR vnRow >= cn10000) AND vbEncabezado THEN
              Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicoPag,cn1,psUsuario=>pk_login.vgsUSR);
              vsInicoPag := csSALTO;
              vnRow := cn0;
        END IF;

        IF vsEncabezado = csN THEN
           vbEncabezado := FALSE;
        END IF;

--<td valign="top">'||regRep.MEDIO_PAGO||'</td>

           htp.p('<tr><td valign="top">'||regRep.CONTRATO||'</td>
                      <td valign="top">'||regRep.MONTO||'</td>
                      <td valign="top">'||regRep.PERIODO_CONTRATO||'</td>
                      <td valign="top">'||regRep.PERIODO_DOCUMENTO||'</td>
                      <td valign="top">'||regRep.ESCUELA||'</td>
                      <td valign="top">'||regRep.CARRERA||'</td>
                      <td valign="top">'||regRep.DESCRIPCION_CARRERA||'</td>
                      <td valign="top">'||regRep.ID||'</td>
                      <td valign="top">'||regRep.RUT||'</td>
                      <td valign="top">'||regRep.NOMBRE||'</td>
                      <td valign="top">'||regRep.APELLIDOS||'</td>
                      <td valign="top">'||regRep.ESTATUS||'</td>
                      <td valign="top">'||regRep.ACTUAL||'</td>
                      <td valign="top">'||regRep.PERIODO_ADMISION||'</td>
                      <td valign="top">'||regRep.MORA_30||'</td>
                      <td valign="top">'||regRep.MORA_90||'</td>
                      <td valign="top">'||regRep.MORA_180||'</td>
                      <td valign="top">'||regRep.MORA_MAYOR||'</td>
                      <td valign="top">'||regRep.TOTAL_ADEUDO||'</td>
                      <td valign="top">'||regRep.TOTAL_CAE||'</td>
                      <td valign="top">'||regRep.TOTAL_BECAS||'</td></tr>' );

          vnExists   := cn1;
          vnRow      := vnRow + cn1;
      END LOOP;

      IF vnExists = cn0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
         Pk_Sisrepimp.vgsSaltoImp := csImprime;

         -- es omitido el encabezado del reporte pero se agrega el salto de pgina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,csPIE,cn0, psUsuario=>pk_login.vgsUSR, psSeccion=>vsSeccion);
      END IF;



      htp.p('</table></body></html>');
  EXCEPTION
--      WHEN NO_DATA_FOUND THEN
           --INSERT INTO BITACORA values();
  --         NULL;
      WHEN OTHERS THEN
               HTP.P(SQLERRM);
  END PWRMORO;
/


DROP PUBLIC SYNONYM PWRMORO;

CREATE PUBLIC SYNONYM PWRMORO FOR BANINST1.PWRMORO;


GRANT EXECUTE ON BANINST1.PWRMORO TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRMTMT;

CREATE OR REPLACE PROCEDURE BANINST1.PWRMTMT (
	psReclDesc			VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:		PWRMTMT
OBJETIVO:			Reporte de Matricula: Total Matriculados por Tipo
PARAMETROS:
psReclDesc			Variable estandar para la maquina de reportes custom
AUTOR:				Gilberto Velazquez Hernandez
FECHA:				20110113
******************************************************************************/
	--Numero de	renglones
	vnRow				PLS_INTEGER := 0;
	--Bandera para mostrar si hubo datos
	vnExists			INTEGER := 0;
	--Numero de	columnas
	vnColumnas			INTEGER := 8;
	--Numero de registros
	vnRegs				INTEGER := 0;
	--Arreglo (nested table) donde se guardan los encabezados de las columnas
	tabColumna			Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
	-- la variable es una bandera que al tener el valor "imprime" no colocara
	--el salto de pgina para impresion
	vsInicoPag			VARCHAR2(10) := NULL;
	--Nmero de renglones por pgina
	vnRegsPag			PLS_INTEGER := 50;

	--Variable para guardar el periodo deseado
	vsPerio				STVTERM.STVTERM_CODE%TYPE;

	--variable para guardar la fecha de filtro
	vdFecha				DATE;

	--Variable para guardar el total de matriculados
	vnTotalNvoAcum		PLS_INTEGER;
	vnTotalAvaAcum		PLS_INTEGER;
	vnTotalNvoDia		PLS_INTEGER;
	vnTotalAvaDia		PLS_INTEGER;

	CURSOR cuReporte(
		psPerio			VARCHAR2
		,pdFecha		DATE
	) IS
	SELECT
		Q2.Programa												AS Prog
		,SMRPRLE_PROGRAM_DESC									AS ProgDesc
		,Count(Q2.NvoIng)										AS NvoIng
		,Count(Q2.Avanzado)										AS Avanzado
		,Count(Q2.NvoIngDia)									AS NvoIngDia
		,Count(Q2.AvanzadoDia)									AS AvanzadoDia
	FROM
		(SELECT
			Q1.Programa											AS Programa
			,CASE WHEN Q1.Tipo = 'N' THEN 1 ELSE NULL END		AS NvoIng
			,CASE WHEN Q1.Tipo = 'A' THEN 1 ELSE NULL END		AS Avanzado
			,CASE WHEN Q1.Tipo = 'N' AND TRUNC(pdFecha) = TRUNC(Q1.Fecha)
				THEN 1 ELSE NULL END							AS NvoIngDia
			,CASE WHEN Q1.Tipo = 'A' AND TRUNC(pdFecha) = TRUNC(Q1.Fecha)
				THEN 1 ELSE NULL END							AS AvanzadoDia
		FROM
			(SELECT
				TWBCNTR_ORI_PROGRAM								AS Programa
				,FWATYALUFT(TWBCNTR_PIDM, TWBCNTR_TERM_CODE) AS Tipo
				,TWBCNTR_ISSUE_DATE								AS Fecha
			FROM
				TWBCNTR
			WHERE
				TWBCNTR_TERM_CODE = psPerio
				--acumulados a la fecha
				AND TWBCNTR_ISSUE_DATE < (TRUNC(pdFecha) + 1)
				AND TWBCNTR_STATUS_IND = 'A'
				AND NOT EXISTS (
					SELECT
						1
					FROM
						TWBRETR
					WHERE
						TWBRETR_CNTR_NUM = TWBCNTR_NUM
				)
			) Q1
		) Q2
		,SMRPRLE
	WHERE
		Q2.Programa = SMRPRLE_PROGRAM
	GROUP BY
		Q2.Programa
		,SMRPRLE_PROGRAM_DESC
	ORDER BY
		SMRPRLE_PROGRAM_DESC;

BEGIN

	--Seguridad de GWAMNUR
	IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

	--Obtengo el numero de corte que se desea para el usuario dado
	vsPerio := pk_objHtml.getValueCookie('psPerio');

	--Obtengo de las cookies el valor fechas de corte de caja
	vdFecha := TO_DATE(pk_objHtml.getValueCookie('psFecha'),'DD/MM/YYYY');

	-- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
	tabColumna.EXTEND(vnColumnas);

	--Guardamos los encabezados en el arreglo de columnas
	tabColumna( 1) := 'Cod. Prog.';
	tabColumna( 2) := 'Programa';
	tabColumna( 3) := 'Nuevo Ingreso<br/> Acumulados al Dia';
	tabColumna( 4) := 'Avanzados<br/> Acumulados al Dia';
	tabColumna( 5) := 'Total<br/> Acumulado al Dia';
	tabColumna( 6) := 'Nuevo Ingreso <br/>del Dia';
	tabColumna( 7) := 'Avanzados <br/>del Dia';
	tabColumna( 8) := 'Total <br/>del Dia';

	--Inicializamos contador de renglones
	vnRow := 0;

	--Inicializamos los totales
	vnTotalNvoAcum := 0;
	vnTotalAvaAcum := 0;
	vnTotalNvoDia := 0;
	vnTotalAvaDia := 0;

	FOR regReporte IN cuReporte(vsPerio, vdFecha) LOOP

		--Incremento el contador de renglones
		vnRow := vnRow + 1;
		vnExists := 1; --Bandera para indicar que hubo resultados

		--Si es el primer renglon de cada pgina...
		IF MOD(vnRow, vnRegsPag) = 1  THEN
			--imprimo el encabezado de reporte
			Pk_Sisrepimp.P_EncabezadoDeReporte(
				psReclDesc ,vnColumnas ,tabColumna
				,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
			);
			vsInicoPag := 'SALTO';
		END IF;

		--Comienzo a desplegar el renglon
		HTP.P('<tr>');

		HTP.P('<td>'||regReporte.Prog||'</td>');

		HTP.P('<td>'||regReporte.ProgDesc||'</td>');

		HTP.P('<td style="text-align:right;">'||regReporte.NvoIng ||'</td>');

		HTP.P('<td style="text-align:right;">'||regReporte.Avanzado||'</td>');

		HTP.P('<td>'||(regReporte.NvoIng + regReporte.Avanzado) ||'</td>');

		HTP.P('<td style="text-align:right;">'||regReporte.NvoIngDia ||'</td>');

		HTP.P('<td style="text-align:right;">'||regReporte.AvanzadoDia||'</td>');

		HTP.P('<td>'||(regReporte.NvoIngDia + regReporte.AvanzadoDia) ||'</td>');

		--Fin del renglon
		HTP.P('</tr>');

		--Voy sumando a los totales
		vnTotalNvoAcum := vnTotalNvoAcum + regReporte.NvoIng;
		vnTotalAvaAcum := vnTotalAvaAcum + regReporte.Avanzado;
		vnTotalNvoDia := vnTotalNvoDia + regReporte.NvoIngDia;
		vnTotalAvaDia := vnTotalAvaDia + regReporte.AvanzadoDia;

	END LOOP;

	--Si existio un renglon despliego el renglon de totales
	IF vnRow > 0 THEN
		HTP.P('<tr>');
		HTP.P('<td>&nbsp;</td>');
		HTP.P('<td style="font-weight:bold;"> Total: </td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalNvoAcum,'999G999G999')||'</td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalAvaAcum,'999G999G999')||'</td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalAvaAcum+vnTotalNvoAcum,'999G999G999')||'</td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalNvoDia,'999G999G999')||'</td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalAvaDia,'999G999G999')||'</td>');
		HTP.P('<td style="font-weight:bold; text-align:right;">'
			||TO_CHAR(vnTotalAvaDia+vnTotalNvoDia,'999G999G999')||'</td>');
		HTP.P('</tr>');
	END IF;


	IF vnExists = 0 THEN
		--Ojo esta linea lo que hace es imprimir
		--NO SE ENCONTRARON DATOS o un mensaje similar
		htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
	ELSE

		-- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
		Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

		-- es omitido el encabezado del reporte pero se agrega el salto de pagina
		Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
	END IF;

	--Fin de la pagina
	htp.p('</table><br/></body></html>');
EXCEPTION
	WHEN OTHERS THEN
		--pantallazo de error.
		pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
			'PWRMTMT', NULL);
END PWRMTMT;
/


DROP PUBLIC SYNONYM PWRMTMT;

CREATE PUBLIC SYNONYM PWRMTMT FOR BANINST1.PWRMTMT;


GRANT EXECUTE ON BANINST1.PWRMTMT TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRMTMT TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRMTMT TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRMTMT TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRMTMT TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRMTQI;

CREATE OR REPLACE PROCEDURE BANINST1.PWRMTQI(psReclDesc VARCHAR2) IS
/*
           Tarea: REPORTE DE MATERIAS QUE IMPARTE
           Fecha: 12/05/2006.
           Autor: VBZ

    Modificacin: 10/10/2008
                  GEPC
                  1. Agregar el parmetro de "Tipo docente", despus del parmetro "Contrato"
                  2. Agregar la columna "Tipo de docente", despues de la columna "Contrato".


 Modificacin: 10/10/2008
                  CCR
                  1.- Se Agrego la columna RUT
                  2.- Desplegar los titulos de las columnas lista cruzada y tipo de curso
*/

ckNombres   owa_cookie.vc_arr;
ckValores   owa_cookie.vc_arr;
ckCount     INTEGER;
vgsInicoPag VARCHAR2(10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
vgsUSR      VARCHAR2(500);

  vnExists   INTEGER                := 0;
  vnColumnas INTEGER                := 15;
  tabColumna Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vsPerio    VARCHAR2(100)          := NULL;
  vsFacu     VARCHAR2(100)          := NULL;

  vsTipo     VARCHAR2(10)           := NULL;
  vsUnive    VARCHAR2(10)           := NULL;
  vsSeccion  VARCHAR2(3)            := NULL;
  vsStatus   VARCHAR2(10)           := NULL;
  vsContrato VARCHAR2(10)           := NULL;
  vsDocente  VARCHAR2(10)           := NULL;
  vsTidoc    VARCHAR2(10)           := NULL;

  CURSOR cuReporte(psTerm  VARCHAR2 DEFAULT NULL,
                   psFacu  VARCHAR2 DEFAULT NULL,
                   psTycon VARCHAR2 DEFAULT NULL,
                   psDocen VARCHAR2 DEFAULT NULL,
                   psTidoc VARCHAR2 DEFAULT NULL) IS
         SELECT SS.SSBSECT_TERM_CODE                    termCode,
                SSBSECT_CAMP_CODE                       campCode,
                PROFESOR.ID                             ID,
                PROFESOR.PIDM                           PIDM,
                PROFESOR.NOMBRE                         DOCENTE,
                Pk_Catalogo.COLEGIO(ESCUELA.ESC_SEDE)   ESCUELA_SEDE,
                Pk_Catalogo.CONTRATO(CONTRATO.CONTRATO) CONTRATO,
                Pk_Catalogo.CATEGORIA(PROFESOR.PERFIL)  CATEGORIA,
                PROFESOR.ASIGNACION                     ASIGNACION,
                SSBSECT_CRN                             NRC,
                SCBCRSE_SUBJ_CODE                       SUBJ,
                SCBCRSE_CRSE_NUMB                       CURSO,
                SCBCRSE_TITLE                           NOMBRE,
                Pk_Catalogo.COLEGIO(SCBCRSE_COLL_CODE)  ESCUELA,
                SSRXLST_XLST_GROUP                      LISTA_CRUZADA,
                DECODE(SWRXLST_TYPE,'M','Master','S',
                'Simultneo','Independiente')           TIPO_LISTA,
                Pk_Catalogo.Tipo(PROFESOR.TipoFac)      TipoFac
           FROM SSBSECT SS,
                SCBCRSE,
                (SELECT SPRIDEN_ID              ID,
                        SPRIDEN_PIDM            PIDM,
                        REPLACE(SPRIDEN_LAST_NAME||''||SPRIDEN_FIRST_NAME,'*',' ') NOMBRE,
                        SIRASGN_TERM_CODE       TERM,
                        SIRASGN_CRN             CRN,
                        SIRASGN_CATEGORY        CATEGORY,
                        SIBINST_FSTP_CODE       TipoFac,
                        SIBINST_FCTG_CODE       PERFIL,
                        SIRASGN_ASTY_CODE       asignacion
                   FROM SPRIDEN A,
                        SIRASGN B,
                        SIBINST S
                  WHERE SIRASGN_PIDM            = SPRIDEN_PIDM
                    AND SPRIDEN_CHANGE_IND     IS NULL
                    AND S.SIBINST_TERM_CODE_EFF = (SELECT MAX(G.SIBINST_TERM_CODE_EFF)
                                                     FROM SIBINST G
                                                    WHERE G.SIBINST_PIDM           = S.SIBINST_PIDM
                                                      AND G.SIBINST_TERM_CODE_EFF <= SIRASGN_TERM_CODE
                                                   )
                    AND SIRASGN_PIDM            = S.SIBINST_PIDM
                    AND (SIBINST_FSTP_CODE = psTidoc OR psTidoc IS NULL)

                ) PROFESOR,
                (SELECT SIRICNT_TERM_CODE_EFF   PERIODO,
                        SIRICNT_PIDM            PIDM,
                        SIRICNT_FCNT_CODE       CONTRATO
                   FROM SIRICNT A
                  WHERE SIRICNT_DEF_IND       = 'D'
                    AND SIRICNT_TERM_CODE_EFF = (SELECT MAX(SI.SIRICNT_TERM_CODE_EFF)
                                                   FROM SIRICNT SI
                                                  WHERE SI.SIRICNT_PIDM           =  A.SIRICNT_PIDM
                                                    AND (SI.SIRICNT_TERM_CODE_EFF <= psTerm OR psTerm IS NULL)
                                                )
                ) CONTRATO,
                (SELECT SIRDPCL_TERM_CODE_EFF   PERIODO,
                        SIRDPCL_PIDM            PIDM,
                        SIRDPCL_COLL_CODE       ESC_SEDE
                   FROM SIRDPCL A
                  WHERE SIRDPCL_HOME_IND      = 'Y'
                    AND SIRDPCL_TERM_CODE_EFF = (SELECT MAX(SI.SIRDPCL_TERM_CODE_EFF)
                                                   FROM SIRDPCL SI
                                                  WHERE SI.SIRDPCL_PIDM           =  A.SIRDPCL_PIDM
                                                    AND (SI.SIRDPCL_TERM_CODE_EFF <= psTerm OR psTerm IS NULL)
                                                )
                ) ESCUELA,
                SWRXLST,
                SSRXLST
          WHERE SSBSECT_TERM_CODE = PROFESOR.TERM(+)
            AND SSBSECT_CRN       = PROFESOR.CRN(+)
            AND SCBCRSE_SUBJ_CODE = SSBSECT_SUBJ_CODE
            AND SCBCRSE_CRSE_NUMB = SSBSECT_CRSE_NUMB
            AND SCBCRSE_EFF_TERM  = (SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                       FROM SCBCRSE SC
                                      WHERE SC.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                        AND SC.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                        AND SC.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB
                                    )
            AND PROFESOR.PIDM      = CONTRATO.PIDM(+)
            AND PROFESOR.PIDM      = ESCUELA.PIDM(+)
            AND SSBSECT_TERM_CODE  = SSRXLST_TERM_CODE(+)
            AND SSBSECT_CRN        = SSRXLST_CRN(+)
            AND SSRXLST_TERM_CODE  = SWRXLST_TERM_CODE(+)
            AND SSRXLST_CRN        = SWRXLST_CRN(+)
            AND SSRXLST_XLST_GROUP = SWRXLST_XLST_GROUP(+)
            AND (SSBSECT_TERM_CODE = psTerm  OR psTerm IS NULL)
            AND (ESCUELA.ESC_SEDE  = psFacu  OR psFacu IS NULL)
            AND (CONTRATO.CONTRATO = psTycon OR psTycon IS NULL)
            AND (PROFESOR.ID       = psDocen OR psDocen IS NULL)
          ORDER BY termCode DESC, campCode, ESCUELA, NOMBRE;

  BEGIN
      /* Check/update the user's web session */
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
         FOR vnCOKIES IN 1..ckCount LOOP

             IF ckNOMBRES(vnCOKIES) = 'psPerio' THEN
                   vsPerio := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                   vsFacu := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psTycon' THEN
                   vsContrato := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psDocen' THEN
                   vsDocente := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psType' THEN
                   vsTidoc  := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                   vsSeccion := ckValores(vnCOKIES);

             END IF;
         END LOOP;
      END IF;

      -- Las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := 'ID';
      tabColumna(2)  := 'RUT';
      tabColumna(3)  := 'Nombre';
      tabColumna(4)  := 'Escuela sede';
      tabColumna(5)  := 'Contrato';
      tabColumna(6)  := 'Tipo de docente';
      tabColumna(7)  := '<b>Categor&iacute;a</b>';
      tabColumna(8)  := '<b>Tipo de Asignaci&oacute;n</b>';
      tabColumna(9)  := 'NRC';
      tabColumna(10) := 'Materia';
      tabColumna(11) := 'Curso';
      tabColumna(12) := 'Nombre materia';
      tabColumna(13) := 'Escuela';
      tabColumna(14) := 'Lista cruzada';
      tabColumna(15) := 'Tipo de curso';


      FOR regRep IN cuReporte(vsPerio, vsFacu, vsContrato, vsDocente, vsTidoc) LOOP
          IF vnExists = 0 THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,vgsInicoPag,'1', psSubtitulo=>'Periodo '||regRep.termCode, psUsuario=>vgsUSR, psSeccion=>vsSeccion, psSinLogo=>'sin');
             vgsInicoPag := 'SALTO';

          END IF;

          htp.p('<tr>
          <td valign="top">'||regRep.ID               ||'</td>
          <td valign="top">'||f_get_rut(regRep.PIDM ) ||'</td>
          <td valign="top">'||regRep.Docente          ||'</td>
          <td valign="top">'||regRep.Escuela_sede     ||'</td>
          <td valign="top">'||regRep.Contrato         ||'</td>
          <td valign="top">'||regRep.TipoFac          ||'</td>
          <td valign="top">'||regRep.Categoria        ||'</td>
          <td valign="top">'||regRep.Asignacion       ||'</td>
          <td valign="top">'||regRep.NRC              ||'</td>
          <td valign="top">'||regRep.Subj             ||'</td>
          <td valign="top">'||regRep.Curso            ||'</td>
          <td valign="top">'||regRep.Nombre           ||'</td>
          <td valign="top">'||regRep.Escuela          ||'</td>
          <td valign="top">'||regRep.Lista_cruzada    ||'</td>
          <td valign="top">'||regRep.Tipo_lista       ||'</td>
          </tr>');

          vnExists := 1;
      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      END IF;

      htp.p('</table><br/></body></html>');
EXCEPTION
WHEN OTHERS THEN htp.p( SQLERRM);

END PWRMTQI;
/


DROP PUBLIC SYNONYM PWRMTQI;

CREATE PUBLIC SYNONYM PWRMTQI FOR BANINST1.PWRMTQI;


GRANT EXECUTE ON BANINST1.PWRMTQI TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRMTQI TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRMTRE;

CREATE OR REPLACE PROCEDURE BANINST1.PWRMTRE (psReclDesc   VARCHAR2,
                                              psTipoAcce   VARCHAR2 DEFAULT NULL,
                                              psProgCode   VARCHAR2 DEFAULT NULL,
                                              psSubtitulo  VARCHAR2 DEFAULT NULL)  IS

/*****************************************************************************************
           tarea:  reporte de accesos a las encuestas del "motor de encuestas"
          mdulo:  motor de encuestas
           autor:  horacio martnez ramrez - hmr
           fecha:  26/nov/2010

    modificacin; CCR
                  17/12/2010
                  se agrego el join en el cursos para el proceso persona
                  se agrego la instruccin que detiene la imagen de load
                  se cambio el campo Sede por RUT.

*******************************************************************************************/

  vnTotal     NUMBER          := 0;
  vnTotaT     NUMBER          := 0;
  vnTotaP     NUMBER          := 0;
  vnPorcT     NUMBER          := 0;
  vnPorTP     NUMBER          := 0;
  vnRow       INTEGER         := 0;
  vsUnive     VARCHAR2(6)     := NULL;
  vsRate      VARCHAR2(6)     := NULL;
  vsEncst     VARCHAR2(20)    := NULL;
  vnNmRfE     INTEGER         := NULL;
  vsTerm      VARCHAR2(6)     := NULL;
  vsAccpr     VARCHAR2(20)    := NULL;
  vsEscul     VARCHAR2(2)     := NULL;
  vsTitulo    VARCHAR2(90)    := NULL;
  vsDescEncst VARCHAR2(300)   := NULL;
  vsProgramas VARCHAR2(10000) := NULL;

  csSIN CONSTANT VARCHAR2(3) := 'SIN';

  CURSOR cuPrograma(psCamp VARCHAR2,
                    psEncs VARCHAR2,
                    pnNmrR INTEGER,
                    psTerm VARCHAR2,
                    psColl VARCHAR2 DEFAULT NULL,
                    psRate VARCHAR2 DEFAULT NULL
                   ) IS
         SELECT A.SGBSTDN_COLL_CODE_1      Coll,
                A.SGBSTDN_PROGRAM_1        Prog,
--                a.sgbstdn_vpdi_code        camp,       -- hmr
                COUNT(A.SGBSTDN_PIDM)      Total,
                NVL(SUM(GVRSRA.Pending),0) Pending,
                NVL(SUM(GVRSRA.Progres),0) Progres,
                NVL(SUM(GVRSRA.Complet),0) Complet
           FROM SGBSTDN A,
                (SELECT DECODE(GVRSRAS_STATUS_IND,'P',1,0) Pending,
                        DECODE(GVRSRAS_STATUS_IND,'I',1,0) Progres,
                        DECODE(GVRSRAS_STATUS_IND,'C',1,0) Complet,
                        GVRSRAS_SPIDM                      Pidm
                   FROM GVRSRAS
                  WHERE GVRSRAS_SRN = pnNmrR
                ) GVRSRA
          WHERE A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                             FROM SGBSTDN B
                                            WHERE B.SGBSTDN_PIDM           = A.SGBSTDN_PIDM
                                              AND B.SGBSTDN_TERM_CODE_EFF <= psTerm
                                          )

            AND A.SGBSTDN_PIDM      = GVRSRA.PIDM(+)
            AND A.SGBSTDN_CAMP_CODE = psCamp
            AND (A.SGBSTDN_COLL_CODE_1 = psColl OR psColl IS NULL)
            AND (NVL(A.SGBSTDN_RATE_CODE,csSIN)   = psRate OR psRate IS NULL)
          GROUP BY A.SGBSTDN_COLL_CODE_1,
                   A.SGBSTDN_PROGRAM_1;
--                   a.sgbstdn_vpdi_code;     -- hmr

  CURSOR cuPersona(psCamp     VARCHAR2,
                   psEncs     VARCHAR2,
                   pnNmrR     INTEGER,
                   psTerm     VARCHAR2,
                   psProgCode VARCHAR2 DEFAULT NULL,
                   psRate     VARCHAR2 DEFAULT NULL
                   ) IS
         SELECT SPRIDEN_PIDM                        Pidm,
                SPRIDEN_ID                          ID,
                REPLACE(SPRIDEN_LAST_NAME, '*',' ') LastN,
                REPLACE(SPRIDEN_FIRST_NAME,'*',' ') FirsN,
                1                                   Total,
                NVL(SUM(GVRSRA.Progres),0)          Progres,
                NVL(SUM(GVRSRA.Complet),0)          Complet
           FROM SPRIDEN,
                (SELECT DECODE(GVRSRAS_STATUS_IND,'P',1,0) Pending,
                        DECODE(GVRSRAS_STATUS_IND,'I',1,0) Progres,
                        DECODE(GVRSRAS_STATUS_IND,'C',1,0) Complet,
                        GVRSRAS_SPIDM                      Pidm
                   FROM GVRSRAS
                  WHERE GVRSRAS_SRN = pnNmrR
                ) GVRSRA

            WHERE SPRIDEN_PIDM = GVRSRA.pidm
              and (
                    EXISTS (SELECT NULL
                              FROM SGBSTDN A
                             WHERE A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                                                FROM SGBSTDN B
                                                               WHERE B.SGBSTDN_PIDM = A.SGBSTDN_PIDM
                                                             )
                               AND A.SGBSTDN_PROGRAM_1     = psProgCode
                               AND A.SGBSTDN_PIDM          = GVRSRA.pidm
                          )
                 OR
                    psProgCode IS NULL
                )
            AND (
                    EXISTS (SELECT NULL
                               FROM SGBSTDN A
                              WHERE A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                                                 FROM SGBSTDN B
                                                                WHERE B.SGBSTDN_PIDM = A.SGBSTDN_PIDM
                                                              )
                                AND A.SGBSTDN_RATE_CODE     = psRate
                           )

                 OR
                    psRate IS NULL
                )
            AND SPRIDEN_CHANGE_IND IS NULL
          GROUP BY SPRIDEN_PIDM,
                   SPRIDEN_ID,
                   REPLACE(SPRIDEN_LAST_NAME, '*',' '),
                   REPLACE(SPRIDEN_FIRST_NAME,'*',' ')
          ORDER BY REPLACE(SPRIDEN_LAST_NAME, '*',' '),
                   REPLACE(SPRIDEN_FIRST_NAME,'*',' ');


  -- obtiene el campus del encuestado
  FUNCTION F_CAMPUS (pnPidm number) RETURN varchar2 IS

  vsCampCode     stvcamp.stvcamp_code%type := NULL;
  vsVpdiAnterior varchar2(10)              := NULL;

  CURSOR cuCamp IS
         SELECT stvcamp_code campCode
           FROM stvcamp;

  BEGIN
      BEGIN
          SELECT A.sgbstdn_camp_code
            INTO vsCampCode
            FROM sgbstdn A
           WHERE A.sgbstdn_term_code_eff = (SELECT MAX(B.sgbstdn_term_code_eff)
                                              FROM sgbstdn B
                                            WHERE B.sgbstdn_pidm           = pnPidm
                                               AND B.sgbstdn_term_code_eff <= vsTerm
                                           )
             AND A.sgbstdn_pidm          = pnPidm;
      EXCEPTION
          WHEN OTHERS THEN
               NULL ;
      END;

      IF vsCampCode IS NULL THEN
         vsVpdiAnterior := SYS_CONTEXT('g$_vpdi_home_context','vpdi_home_code');

         FOR regCmp in cuCamp LOOP
             IF vsCampCode IS NULL THEN
                g$_vpdi_security.g$_vpdi_set_home_context(regCmp.campCode);

                BEGIN
                    SELECT A.sgbstdn_camp_code
                      INTO vsCampCode
                      FROM sgbstdn A
                     WHERE A.sgbstdn_term_code_eff = (SELECT MAX(b.sgbstdn_term_code_eff)
                                                        FROM sgbstdn b
                                                       WHERE b.sgbstdn_pidm           = pnPidm
                                                           AND b.sgbstdn_term_code_eff <= vsTerm  )
                       AND A.sgbstdn_pidm          = pnPidm;
                EXCEPTION
                    WHEN OTHERS THEN
                             NULL;
                END;

             END IF;
         END LOOP;

         g$_vpdi_security.g$_vpdi_set_home_context(vsVpdiAnterior);

      END IF;

      RETURN vsCampCode;

  EXCEPTION
      WHEN NO_DATA_FOUND THEN
               g$_vpdi_security.g$_vpdi_set_home_context(vsVpdiAnterior);
               RETURN NULL;
      WHEN OTHERS THEN
               g$_vpdi_security.g$_vpdi_set_home_context(vsVpdiAnterior);
               RETURN NULL;
  END F_CAMPUS;


  PROCEDURE PROGRAMA IS

  vnPorcAcc number := 0;
  vnPorcPrg number := 0;
  vnPorcPC  number := 0;
  vnPorcA   number := 0;
  vnTotlAcc number := 0;
  vnTotlPC  number := 0;
  vnTotaA   number := 0;
  vnTotaE   number := 0;
  vnTotaTP  number := 0;

  BEGIN

      htp.p('<script language="javascript" src="kwacnls.js"></script>');

      htp.p('<table border="1" width="100%">
               <tr bgcolor="#efefef">
               <th '||PK_ObjHTML.vgsBorderDDDDDD||' rowspan="2" valign="bottom" colspan="2">Programa   </th>
               <th '||PK_ObjHTML.vgsBorderDDDDDD||' rowspan="2" valign="bottom">Total alumnos          </th>
               <th '||PK_ObjHTML.vgsBorderDDDDDD||' rowspan="2" valign="bottom">Alumnos que accedieron </th>
               <th '||PK_ObjHTML.vgsBorderDDDDDD||' rowspan="2" valign="bottom">% de acceso            </th>
               <th '||PK_ObjHTML.vgsBorderDDDDDD||' rowspan="2" valign="bottom">Evaluaciones esperadas </th>
               <th '||PK_ObjHTML.vgsBorderDDDDDD||' rowspan="2" valign="bottom">Evaluaciones terminadas</th>
               <th '||PK_ObjHTML.vgsBorderDDDDDD||' rowspan="2" valign="bottom">Evaluaciones<br/>en proceso</th>
               <th '||PK_ObjHTML.vgsBorderDDDDDD||' colspan="2" valign="bottom">Participaci&oacute;n   </th>
               </tr>
               <tr bgcolor="#efefef">
               <th '||PK_ObjHTML.vgsBorderDDDDDD||' valign="bottom">% Encuestas terminadas</th>
               <th '||PK_ObjHTML.vgsBorderDDDDDD||' valign="bottom">% Encuestas terminadas y<br/>en proceso</th>
               </tr>  ');

      FOR regPrg IN cuPrograma(vsUnive, vsEncst, vnNmRfE, vsTerm, vsEscul, vsRate) LOOP
            vnRow     := vnRow          + 1;
            vnTotlAcc := regPrg.Pending + regPrg.Progres + regPrg.Complet;
            vnTotlPC  := regPrg.Progres + regPrg.Complet;
            vnTotal   := vnTotal        + regPrg.Total;

            vnTotaA   := vnTotaA        + regPrg.Pending + regPrg.Progres + regPrg.Complet;
            vnTotaE   := vnTotaE        + regPrg.Total;
            vnTotaT   := vnTotaT        + regPrg.Complet;
            vnTotaP   := vnTotaP        + regPrg.Progres;
            vnTotaTP  := vnTotaTP       + regPrg.Progres + regPrg.Complet;

            IF vnTotlAcc > 0 AND regPrg.Total > 0 THEN
                vnPorcAcc := (vnTotlAcc/regPrg.Total) * 100;
            END IF;

            IF regPrg.Complet > 0 AND regPrg.Total > 0 THEN
                vnPorcPrg := (regPrg.Complet/regPrg.Total) * 100;
            END IF;

            IF vnTotlPC > 0 AND regPrg.Total > 0 THEN
                vnPorcPC := (vnTotlPC/regPrg.Total) * 100;
            END IF;

            htp.p(' <tr>
                      <td '||PK_ObjHTML.vgsBorderDDDDDD||' width="8%" align="center">'||
                      pk_ObjHTML.f_a(regPrg.Prog,'PWRMTRE?psReclDesc='||psReclDesc||'&psTipoAcce=TA&psProgCode='||regPrg.Prog||',&psSubtitulo=(Detalle)',vnRow)
                      ||'</td>
                      <td '||PK_ObjHTML.vgsBorderDDDDDD||' width="28%" align="left">' ||pk_Catalogo.programa(regPrg.Prog)||'</td>
                      <td '||PK_ObjHTML.vgsBorderDDDDDD||' width="8%" align="center">'||regPrg.Total                     ||'</td>
                      <td '||PK_ObjHTML.vgsBorderDDDDDD||' width="8%" align="center">'||vnTotlAcc                        ||'</td>
                      <td '||PK_ObjHTML.vgsBorderDDDDDD||' width="8%" align="center">'||to_char(vnPorcAcc,'990.90')      ||'%</td>
                      <td '||PK_ObjHTML.vgsBorderDDDDDD||' width="8%" align="center">'||regPrg.Total                     ||'</td>
                      <td '||PK_ObjHTML.vgsBorderDDDDDD||' width="8%" align="center">'||regPrg.Complet                   ||'</td>
                      <td '||PK_ObjHTML.vgsBorderDDDDDD||' width="8%" align="center">'||regPrg.Progres                   ||'</td>
                      <td '||PK_ObjHTML.vgsBorderDDDDDD||' width="8%" align="center">'||to_char(vnPorcPrg,'990.90')      ||'%</td>
                      <td '||PK_ObjHTML.vgsBorderDDDDDD||' width="8%" align="center">'||to_char(vnPorcPC, '990.90')      ||'%</td>
                      </tr> ');

            vnTotlAcc := 0;
            vnTotlPC  := 0;
            vnPorcPC  := 0;
            vnPorcAcc := 0;
            vnPorcPrg := 0;

            vsProgramas := vsProgramas||regPrg.Prog||',';
      END LOOP;

      IF vnTotal > 0 AND vnTotaA > 0 THEN
          vnPorcA := (vnTotaA/vnTotal) * 100;
      END IF;

      IF vnTotal > 0 AND vnTotaT > 0 THEN
          vnPorcT := (vnTotaT/vnTotal) * 100;
      END IF;

      IF vnTotal > 0 AND vnTotaTP > 0 THEN
          vnPorTP := (vnTotaTP/vnTotal) * 100;
      END IF;

      htp.p('<tr> <td '||PK_ObjHTML.vgsBorderDDDDDD_TR||' colspan="2">'||pk_ObjHTML.f_a('Todos los programas','PWRMTRE?psReclDesc='||psReclDesc||'&psTipoAcce=TA&psProgCode='||vsProgramas||'&psSubtitulo=(Detalle)',vnRow)||'</td>
                      <th '||PK_ObjHTML.vgsBorderDDDDDD   ||' bgcolor="#efefef">'||vnTotal                  ||'</th>
                      <th '||PK_ObjHTML.vgsBorderDDDDDD   ||' bgcolor="#efefef">'||vnTotaA                  ||'</th>
                      <th '||PK_ObjHTML.vgsBorderDDDDDD   ||' bgcolor="#efefef">'||to_char(vnPorcA,'990.90')||'%</th>
                      <th '||PK_ObjHTML.vgsBorderDDDDDD   ||' bgcolor="#efefef">'||vnTotaE                  ||'</th>
                      <th '||PK_ObjHTML.vgsBorderDDDDDD   ||' bgcolor="#efefef">'||vnTotaT                  ||'</th>
                      <th '||PK_ObjHTML.vgsBorderDDDDDD   ||' bgcolor="#efefef">'||vnTotaP                  ||'</th>
                      <th '||PK_ObjHTML.vgsBorderDDDDDD   ||' bgcolor="#efefef">'||to_char(vnPorcT,'990.90')||'%</th>
                      <th '||PK_ObjHTML.vgsBorderDDDDDD   ||' bgcolor="#efefef">'||to_char(vnPorTP,'990.90')||'%</th>
                      </tr>
                      </table> ');

  END PROGRAMA;


  PROCEDURE PERSONA (psProgCode varchar2 default null) IS

  vsTitulo   varchar2(10) := 'Nombre';
  vsProgCode varchar2(20) := null;

  BEGIN
      vsProgramas := NVL(psProgCode,',');

      WHILE INSTR(vsProgramas,',') > 0 LOOP

            vsProgCode := SUBSTR(vsProgramas,1, INSTR(vsProgramas,',') - 1);
            vnRow      := 0;

            htp.p('<table border="1" width="100%">');

            htp.p('<script language="javascript" src="kwacnls.js"></script>');

            IF vsProgCode IS NOT NULL THEN
                vsTitulo := 'Alumno';

                htp.p('<tr><th '||PK_ObjHTML.vgsBorderDDDDDD_B||' colspan="6" align="left">('||vsProgCode||') '||pk_Catalogo.programa(vsProgCode)||'</th>
                          </tr> ');
            END IF;

            htp.p('<tr><th '||PK_ObjHTML.vgsBorderDDDDDD||' bgcolor="#efefef" rowspan="2" valign="bottom" colspan="4">'||vsTitulo ||'</th>
                       <th '||PK_ObjHTML.vgsBorderDDDDDD||' bgcolor="#efefef" rowspan="2" valign="bottom">RUT                        </th>
                       <th '||PK_ObjHTML.vgsBorderDDDDDD||' bgcolor="#efefef" rowspan="2" valign="bottom">Evaluaciones esperadas     </th>
                       <th '||PK_ObjHTML.vgsBorderDDDDDD||' bgcolor="#efefef" colspan="2" valign="bottom">Estatus de las evaluaciones</th>
                  </tr><tr>
                       <th '||PK_ObjHTML.vgsBorderDDDDDD||' bgcolor="#efefef" valign="bottom">Encuestas terminadas</th>
                       <th '||PK_ObjHTML.vgsBorderDDDDDD||' bgcolor="#efefef" valign="bottom">Encuestas en proceso</th>
                    </tr>  ');

            FOR regPer IN cuPersona(vsUnive, vsEncst, vnNmRfE, vsTerm, vsProgCode, vsRate) LOOP
                vnRow   := vnRow + 1;
                vnTotal := vnTotal   + regPer.Total;
                vnTotaT := vnTotaT   + regPer.Complet;
                vnTotaP := vnTotaP   + regPer.Progres;

                htp.p(' <tr>
                           <td '||PK_ObjHTML.vgsBorderDDDDDD||' align="right">'  ||vnRow                ||'.</td>
                           <td '||PK_ObjHTML.vgsBorderDDDDDD||' align="left">'   ||regPer.LastN         ||' '||regPer.FirsN||'</td>
                           <td '||PK_ObjHTML.vgsBorderDDDDDD||' align="center">('||regPer.ID            ||')</td>
                           <td '||PK_ObjHTML.vgsBorderDDDDDD||' align="center">' ||f_Campus(regPer.Pidm)||'</td>
                           <td '||PK_ObjHTML.vgsBorderDDDDDD||' align="center">' ||f_get_rut(regPer.Pidm)||'</td>
                           <td '||PK_ObjHTML.vgsBorderDDDDDD||' align="center">' ||regPer.Total         ||'</td>
                           <td '||PK_ObjHTML.vgsBorderDDDDDD||' align="center">' ||regPer.Complet       ||'</td>
                           <td '||PK_ObjHTML.vgsBorderDDDDDD||' align="center">' ||regPer.Progres       ||'</td>
                           </tr>
                           ');
            END LOOP;

            IF vnTotal>0 AND vnTotaT>0 THEN
                vnPorcT := (vnTotaT/vnTotal) * 100;
            END IF;

            IF vnTotal>0 AND vnTotaP>0 THEN
                vnPorTP := (vnTotaP/vnTotal) * 100;
            END IF;

            htp.p('
            <tr><th '||PK_ObjHTML.vgsBorderDDDDDD_TR||' align="right" colspan="5">Total</th>
                <th '||PK_ObjHTML.vgsBorderDDDDDD   ||' bgcolor="#efefef">'||vnTotal||'</th>
                <th '||PK_ObjHTML.vgsBorderDDDDDD   ||' bgcolor="#efefef">'||vnTotaT||'</th>
                <th '||PK_ObjHTML.vgsBorderDDDDDD   ||' bgcolor="#efefef">'||vnTotaP||'</th>
                </tr>
            <tr><td '||PK_ObjHTML.vgsBorderFFFFFF   ||' colspan="5"></td>
                <th '||PK_ObjHTML.vgsBorderDDDDDD_TR||' align="right">Porcentaje</th>
                <th '||PK_ObjHTML.vgsBorderDDDDDD   ||' bgcolor="#efefef">'||to_char(vnPorcT,'990.90')||'%</th>
                <th '||PK_ObjHTML.vgsBorderDDDDDD   ||' bgcolor="#efefef">'||to_char(vnPorTP,'990.90')||'%</th>
                </tr>
            </table>
            <br/>
            ');

            vsProgramas := SUBSTR(vsProgramas, INSTR(vsProgramas,',')  + 1);
            vnTotal     := 0;
            vnTotaT     := 0;
            vnTotaP     := 0;
            vnPorcT     := 0;
            vnPorTP     := 0;
      END LOOP;

  END PERSONA;

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      -- son buscadas los valores de las cookies para asignar los valores del filtro del query
      vsUnive := pk_objHTML.getValueCookie('psUnive');
      vsEncst := pk_objHTML.getValueCookie('psEncst');
      vnNmRfE := pk_objHTML.getValueCookie('psNmRfE');
      vsTerm  := pk_objHTML.getValueCookie('psTerm');
      vsAccpr := pk_objHTML.getValueCookie('psAccpr');
      vsEscul := pk_objHTML.getValueCookie('psEscu');
      vsRate  := pk_objHTML.getValueCookie('psRatS');

      SELECT GVVGSRC_DESC
         INTO vsDescEncst
        FROM GVVGSRC
       WHERE GVVGSRC_CODE = vsEncst;

      htp.p('<html><head><title>&nbsp;</title>');

      -- la aplicacin no se guarda en el cache de la mquina
      pk_ObjHTML.P_NoCache;

      -- cdigo css
      pk_ObjHTML.P_CssTabs;


      htp.p('<script language="JavaScript"><!--');
      htp.p('function fImprimeReporte() {
               window.focus()
               print();
               }');

      IF vsAccpr = 'Persona' THEN
         vsTitulo := 'Acceso por persona - Motor Encuestas';

         htp.p('function fHabilita() {
                  //NADA
                  }');
      ELSE
         vsTitulo := psReclDesc;

         IF psTipoAcce IS NOT NULL THEN
             htp.p('function fRegresar() {
                      parent.document.frmBotones.btnRegresar.className = "oculto";
                      window.history.back();
                      }');

             htp.p('function fHabilita() {
                      parent.document.frmBotones.btnRegresar.className = "btnAA";
                      }');
         ELSE
             htp.p('function fHabilita() {
                      //NADA
                      }');
         END IF;

      END IF;

      htp.p('--></script>');

      htp.p('</head><body bgcolor="#ffffff" onLoad="fHabilita();" class="bodyCeroR"><br/>
                <table border="0" cellpadding="2" cellspacing="1" width="100%" bgcolor="#ffffff" bordercolor="#ffffff">
                <tr><td width="10%" rowspan="3"><img src="/imagenes/logo_uft.jpg'||'" border="0" width="80"/></td>
                      <td width="90%" class="tdTitulo"><b>&nbsp;&nbsp;'||vsDescEncst||' ('||vsEncst||'), NRE: '||vnNmRfE||', Periodo: '||vsTerm||'</td></tr>
                <tr><th align="left">&nbsp;&nbsp;'||vsTitulo||' '||psSubtitulo||'</th></tr>
                <tr><td>&nbsp;&nbsp;'||pK_Seprad1.F_Fecha||'</td></tr>
                <tr><td colspan="2">&nbsp;</td>
                </table> ');

      -- reportes a presentar
      IF vsAccpr = 'Programa' AND psTipoAcce IS NULL THEN
          programa;
      ELSE
          persona(psProgCode);
      END IF;

      htp.p(' <br/><br/>
                </body></html>  ');

  EXCEPTION
      WHEN OTHERS THEN
               htp.p(SQLERRM);

  END PWRMTRE;
/


DROP PUBLIC SYNONYM PWRMTRE;

CREATE PUBLIC SYNONYM PWRMTRE FOR BANINST1.PWRMTRE;


GRANT EXECUTE ON BANINST1.PWRMTRE TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRMTRE TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRNEME;

CREATE OR REPLACE PROCEDURE BANINST1.PWRNEME(psReclDesc VARCHAR2) IS

/*
        Nombre: Reporte de puntajes NEME
         Fecha: 27/01/2011.
         Autor: MAC
*/

    vgsInicoPag  VARCHAR2(10) := null;

    vsNRC          VARCHAR2(10)  := NULL;
    vnExists       INTEGER       := 0;
    vnColumnas     INTEGER       := 15;
    tabColumna     PK_sisRepImp.tipoTabla := PK_sisRepImp.tipoTabla(1);

    vsCamp         VARCHAR2(10)  := NULL;
    vsTerm         VARCHAR2(10)  := NULL;
    vsProgr        VARCHAR2(14)  := NULL;


    csNEM          CONSTANT      VARCHAR2(3) := 'NEM';
    csNEME         CONSTANT      VARCHAR2(4) := 'NEME';



  CURSOR cuReporte(psCamp   VARCHAR2,
                   psTerm   VARCHAR2,
                   psProgr  VARCHAR2) IS
           SELECT  DISTINCT
                    SARADAP_CAMP_CODE UNIVERSIDAD,
                    F_GET_RUT(SARADAP_PIDM) RUT,
                    SPRIDEN_ID ID,
                    SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME NOMBRE,
                    SARADAP_ADMT_CODE CODIGO_ADMISION,
                    PK_CATALOGO.ADMISION(SARADAP_ADMT_CODE)DESC_ADMISION,
                    SARADAP_APPL_PREFERENCE CODIGO_PREFERENCIA,
                    SARADAP_PROGRAM_1 PROGRAMA,
                    f_get_apdc(saradap_pidm, saradap_term_code_entry,SARADAP_APPL_NO) DECISI_ADMISION,
                    TO_CHAR(SORHSCH_GRADUATION_DATE, 'YYYY') ANO_GRADUACION,
                    SORHSCH_SBGI_CODE CODIGO_ESCUELA_PROCEDENCIA,
                    PK_CATALOGO.PREPARATORIA(SORHSCH_SBGI_CODE) DESCRIPCION_ESCUELA,
                    SOBSBGI_CNTY_CODE CODIGO_COMUNA_PROCEDENCIA,
                    PK_CATALOGO.CNTY(SOBSBGI_CNTY_CODE) DESCRIPCION_COMUNA,
                    SORTEST_NEM.SORTEST_TEST_SCORE EVALUACION_NEM,
                    SORTEST_NEME.SORTEST_TEST_SCORE EVALUACION_NEME
            FROM    SPRIDEN, SARADAP, (SELECT SORHSCH_SBGI_CODE, SORHSCH_PIDM, SOBSBGI_CNTY_CODE, SORHSCH_GRADUATION_DATE
                                  FROM SORHSCH, SOBSBGI
                                    WHERE SOBSBGI_SBGI_CODE = SORHSCH_SBGI_CODE)SORHSCH, (SELECT A.SORTEST_PIDM, A.SORTEST_TEST_SCORE FROM SORTEST A
                                  WHERE A.SORTEST_TESC_CODE = csNEM)SORTEST_NEM,
                                  (SELECT B.SORTEST_PIDM, B.SORTEST_TEST_SCORE FROM SORTEST B
                                  WHERE B.SORTEST_TESC_CODE = csNEME)SORTEST_NEME
            WHERE SPRIDEN_PIDM = SARADAP_PIDM
            AND   SARADAP_PIDM = SORHSCH_PIDM(+)
            AND   SARADAP_PIDM = SORTEST_NEM.SORTEST_PIDM(+)
            AND   SARADAP_PIDM = SORTEST_NEME.SORTEST_PIDM(+)
            AND   SPRIDEN_CHANGE_IND IS NULL
            AND  (SARADAP_TERM_CODE_ENTRY  = PSTERM  OR PSTERM IS NULL)
            AND  (SARADAP_PROGRAM_1 = PSPROGR  OR PSPROGR IS NULL)
            ORDER BY SPRIDEN_ID;


  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.

      vsCamp   := pk_objHtml.getValueCookie('psUnive');
      vsTerm   := pk_objHtml.getValueCookie('psPerio');
      vsProgr  := pk_objHtml.getValueCookie('psProgr');


      -- las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := 'RUT';
      tabColumna(2)  := 'ID';
      tabColumna(3)  := 'Nombre';
      tabColumna(4)  := 'Tipo de Admisi&oacute;n';
      tabColumna(5)  := 'Descripci&oacute;n de Tipo de Admisi&oacute;n';
      tabColumna(6)  := 'Prioridad';
      tabColumna(7)  := 'Programa';
      tabColumna(8)  := 'Decisi&oacute;n de Admisi&oacute;n';
      tabColumna(9)  := 'Ao de Egreso EM';
      tabColumna(10) := 'C&oacute;digo Colegio';
      tabColumna(11) := 'Descripci&oacute;n Colegio';
      tabColumna(12) := 'C&oacute;digo Comuna Colegio';
      tabColumna(13) := 'Comuna Colegio';
      tabColumna(14) := 'NEME';
      tabColumna(15) := 'NEM';

      FOR regRep IN cuReporte(vsCamp,vsTerm,vsProgr) LOOP



          IF vnExists = 0 THEN
              PK_sisRepImp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vgsInicoPag,'1',psSubtitulo=>'Periodo '||vsTerm,psUsuario=>pk_login.vgsUSR,psSeccion=>'3',psUniversidad=>regRep.UNIVERSIDAD);
 --             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna, vsInicoPag,'1',psSubtitulo=>'Sede: '||NVL(pk_catalogo.fstvrate(regRep.rateCode),'sin Sede')||'<br>Periodo '||regRep.termCode,psUsuario=>pk_login.vgsUSR,psSeccion=>vsSeccion,psUniversidad=>regRep.campCode);
               vgsInicoPag := 'SALTO';
          END IF;




           htp.p('<tr>
            <td  width="5%"  valign="top">'||regRep.RUT        ||'</td>
            <td  width="5%"  valign="top">'||regRep.ID             ||'</td>
            <td  width="20%" valign="top">'||regRep.Nombre         ||'</td>
            <td  width="8%"  valign="top">'||regRep.CODIGO_ADMISION            ||'</td>
            <td  width="8%"  valign="top">'||regRep.DESC_ADMISION       ||'</td>
            <td  width="10%" valign="top">'||regRep.CODIGO_PREFERENCIA              ||'</td>
            <td  width="5%"  valign="top">'||regRep.PROGRAMA            ||'</td>
            <td  width="5%"  valign="top">'||regRep.DECISI_ADMISION           ||'</td>
            <td  width="5%"  valign="top">'||regRep.ANO_GRADUACION           ||'</td>
            <td  width="5%"  valign="top">'||regRep.CODIGO_ESCUELA_PROCEDENCIA         ||'</td>
            <td  width="15%" valign="top">'||regRep.DESCRIPCION_ESCUELA ||'</td>
            <td  width="5%"  valign="top">'||regRep.CODIGO_COMUNA_PROCEDENCIA   ||'</td>
            <td  width="12%" valign="top">'||regRep.DESCRIPCION_COMUNA ||'</td>
            <td  width="5%"  valign="top">'||regRep.EVALUACION_NEME   ||'</td>
            <td  width="5%"  valign="top">'||regRep.EVALUACION_NEM   ||'</td>

            </tr>');

          vnExists := 1;

      END LOOP;


      IF vnExists = 0 THEN
          htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||PK_sisRepImp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
         PK_sisRepImp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         PK_sisRepImp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,'PIE','0',psUsuario=>pk_login.vgsUSR,psSeccion=>'3');

      END IF;

      htp.p('</table><br><br></body></html>');

  END PWRNEME;
/


DROP PUBLIC SYNONYM PWRNEME;

CREATE PUBLIC SYNONYM PWRNEME FOR BANINST1.PWRNEME;


GRANT EXECUTE ON BANINST1.PWRNEME TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRNEME TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRNHOE;

CREATE OR REPLACE PROCEDURE BANINST1.PWRNHOE(psReclDesc VARCHAR2) IS
/*
         Tarea: Reporte de nmina de honorarios Excel
         Fecha: 01/06/2009.
         Autor: CCR

  Modificacion: 13/11/2009
                EAMM
                CAMBIAR LOS PARAMETROS DE PERIODO Y PARTE DE PERIODO POR MULTIOPCIONES

*/
vgsUSR       VARCHAR2(500);
ckCount      INTEGER;
ckNombres    owa_cookie.vc_arr;
ckValores    owa_cookie.vc_arr;
vgsInicoPag  VARCHAR2(10) := NULL;

 -- vnRow            INTEGER                          := 0;
  vnExists         INTEGER                          := 0;
  vnColumnas       INTEGER                          := 22;
  tabColumna       Pk_Sisrepimp.tipoTabla          := Pk_Sisrepimp.tipoTabla(1);

  vnTotalFd        NUMBER                           := 0;
  vnTotalFnd       NUMBER                           := 0;
  vnTotal          NUMBER                           := 0;
  vnPidm           NUMBER                           := NULL;

  vsUnive          VARCHAR2(6)                     := NULL;
  vsPerio          VARCHAR2(1000)                   := NULL;
  vsPerioE         VARCHAR2(10)                   := NULL;
  vsFacu           VARCHAR2(3)                    := NULL;
  vsCate           VARCHAR2(10)                    := NULL;
  vsSeccion        VARCHAR2(3)                      := NULL;
  vsPtrm           VARCHAR2(1000)                   := NULL;
  vsSede           VARCHAR2(10)                     := NULL;
  vsID             VARCHAR2(10)                     := NULL;
  vsCRN            VARCHAR2(10)                     := NULL;
  vsTermCode      VARCHAR2(6)                     := NULL;
  vsCampCode      VARCHAR2(6)                     := NULL;
  vsCollcode      VARCHAR2(6)                     := NULL;
  vsSinHeadrs VARCHAR2(1)            := NULL;



  CURSOR cuReporte(psUnive VARCHAR2 DEFAULT NULL,
                   psTerm  VARCHAR2 DEFAULT NULL,
                   psFacu  VARCHAR2 DEFAULT NULL,
                   psCate  VARCHAR2 DEFAULT NULL,
                   psPtrm  VARCHAR2 DEFAULT NULL,
                   psSede  VARCHAR2 DEFAULT NULL
                  ) IS

     SELECT DISTINCT SS.SSBSECT_TERM_CODE                                                                     termCode,
                SSBSECT_CAMP_CODE                                                                        campCode,
                DECODE(SSBOVRR_COLL_CODE,NULL,SCBCRSE_COLL_CODE,SSBOVRR_COLL_CODE)                       collCode,
                Pk_Catalogo.COLEGIO(DECODE(SSBOVRR_COLL_CODE,NULL,SCBCRSE_COLL_CODE,SSBOVRR_COLL_CODE))  descSede,
                SPRIDEN_PIDM                                                                             SPIDM,
                SPRIDEN_ID                                                                               ID,
                SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME                                               NOMBRE,
                SPBPERS_NAME_SUFFIX                                                                      SUFFIX,
                PROFESOR_SUM.PIDM                                                                            PIDM,
                REPLACE(REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME||' '||SPRIDEN_MI,'','&ntilde;'),'*',' ') DOCENTE,
                Pk_Catalogo.TIPO(PROFESOR_SUM.TIPO)                                                          TIPO_PROFESOR,
                PROFESOR_SUM.PERFIL                                                                          CVEPERFIL,
                Pk_Catalogo.CATEGORIA(PROFESOR_SUM.PERFIL)                                                   DESCPERFIL,
                SSBSECT_CRN                                                                              NRC,
                '('||SSBSECT_PTRM_CODE||') '||PROFESOR_SUM.P_PERIODO                                         PART_PERIODO,
                --PROFESOR.DIAS                                                                            DIAS,
              SSBSECT_SESS_CODE                                                                       SESION,
                --PROFESOR.HORARIO                                                                         HORARIO,
                PROFESOR_SUM.ASIGNACION                                                                      ASIGNACION,
                PROFESOR_SUM.SOBREPASO                                                                  SOBREPASO,
                SCBCRSE_TITLE                                                                            TITULO,
                SSBSECT_SEQ_NUMB                                                                         SECUENCIA,
                SCBCRSE_SUBJ_CODE                                  MATERIA,
                SCBCRSE_CRSE_NUMB                                  CURSO,
                --NVL(PROFESOR_SUM.SUMA_MODULO,0) * NVL(PROFESOR_SUM.PORCENTAJE,0)/100 MODULO,
                NVL(PROFESOR_SUM.SUMA_MODULO,0) MODULO,
                --NVL(PROFESOR.HORAS_SEM,0)                          HORAS_SEM,
                --PROFESOR.MODULO                                    MODULO,
                DECODE(SWRXLST_TYPE,'M','Master','S','Simultneo','Independiente') TIPO_CURSO,
                DECODE(SWRXLST_TYPE,'M',SSBXLST_ENRL,SSBSECT_ENRL) INSCRITOS,
                NVL(PROFESOR_SUM.PORCENTAJE,0)                         PORCENTAJE,
                --NVL(PROFESOR_SUM.PORCENTAJE,0)/100                    TOTAL,
                ROUND((NVL(PROFESOR_SUM.SUMA_MODULO,0) * NVL(PROFESOR_SUM.PORCENTAJE,0)/100),1) TOTAL,
                PROFESOR_SUM.IndSesion                                                                        IndSesion
                --TOTAL
           FROM SSBSECT SS,
                SCBCRSE,
                (SELECT SIRASGN_PIDM                                                 PIDM,
                        SSRMEET_TERM_CODE                                            PERIODO,
                        SSRMEET_CRN                                                  CRN,
                        ROUND(SUM((SSRMEET_HRS_WEEK/1.33)),2)                        SUMA_MODULO,
                        SIRASGN_PERCENT_RESPONSE                                    PORCENTAJE,
                        SIRASGN_WORKLOAD_ADJUST                                      SOBREPASO,
                        SIRASGN_ASTY_CODE                                            ASIGNACION,
                        SSRMEET_CATAGORY                                             IndSesion,
                        SSRMEET_START_DATE||' - '||SSRMEET_END_DATE                  P_PERIODO,
                        INST_SUM.TIPO                                                    TIPO,
                        INST_SUM.PERFIL                                                  PERFIL
                        FROM SSRMEET,
                        SIRASGN,
                        (SELECT S2.SIBINST_PIDM         PIDM,
                                S2.SIBINST_FSTP_CODE    TIPO,
                                S2.SIBINST_FCTG_CODE    PERFIL
                           FROM SIBINST S2
                          WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(Z2.SIBINST_TERM_CODE_EFF)
                                                           FROM SIBINST Z2
                                                          WHERE Z2.SIBINST_PIDM            =  S2.SIBINST_PIDM
                                                            AND (Z2.SIBINST_TERM_CODE_EFF <= psTerm OR psTerm IS NULL)
                                                        )
                        ) INST_SUM
                  WHERE SIRASGN_PIDM            = INST_SUM.PIDM(+)
                    AND SSRMEET_TERM_CODE       = SIRASGN_TERM_CODE(+)
                    AND SSRMEET_CRN             = SIRASGN_CRN(+)
                    AND SSRMEET_CATAGORY        = SIRASGN_CATEGORY(+)
                    AND SIRASGN_PERCENT_RESPONSE > 0
                    AND INST_SUM.TIPO               = 'HON'
                    group by SIRASGN_PIDM, SSRMEET_TERM_CODE, SSRMEET_CRN, SIRASGN_PERCENT_RESPONSE, SIRASGN_WORKLOAD_ADJUST, SIRASGN_ASTY_CODE, SSRMEET_CATAGORY, SSRMEET_START_DATE||' - '||SSRMEET_END_DATE, INST_SUM.TIPO, INST_SUM.PERFIL)PROFESOR_SUM,
                SPRIDEN,
                SPBPERS,
                SWRXLST,
                SSRXLST,
                SSBXLST,
                SSBOVRR,
                (SELECT SIRDPCL_PIDM      dpclPidm,
                        SIRDPCL_COLL_CODE collCode,
                        SIRDPCL_DEPT_CODE deptSede
                   FROM SIRDPCL A
                  WHERE SIRDPCL_HOME_IND      = 'Y'
                    AND SIRDPCL_TERM_CODE_EFF = (SELECT MAX(SI.SIRDPCL_TERM_CODE_EFF)
                                                   FROM SIRDPCL SI
                                                  WHERE SI.SIRDPCL_PIDM           =  A.SIRDPCL_PIDM
                                                    AND (SI.SIRDPCL_TERM_CODE_EFF <= psTerm OR psTerm IS NULL)
                                                )
                ) SIRDPC
          WHERE SSBSECT_SUBJ_CODE     = SCBCRSE_SUBJ_CODE
            AND SSBSECT_CRSE_NUMB     = SCBCRSE_CRSE_NUMB
            AND SCBCRSE_EFF_TERM      = (SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                           FROM SCBCRSE SC
                                          WHERE SC.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                            AND SC.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                            AND SC.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB
                                        )
            AND SSBSECT_TERM_CODE     = PROFESOR_SUM.PERIODO
            AND SSBSECT_CRN           = PROFESOR_SUM.CRN
            AND PROFESOR_SUM.PIDM         = SPRIDEN_PIDM(+)
            --AND PROFESOR_SUM.PIDM     = SPRIDEN_PIDM
            AND SPRIDEN_PIDM          = SIRDPC.dpclPidm(+)
            AND SPRIDEN_CHANGE_IND IS NULL
            AND SPBPERS_PIDM          = SPRIDEN_PIDM
            AND SSBSECT_TERM_CODE     = SSRXLST_TERM_CODE(+)
            AND SSBSECT_CRN           = SSRXLST_CRN(+)
            AND SSRXLST_TERM_CODE     = SWRXLST_TERM_CODE(+)
            AND SSRXLST_CRN           = SWRXLST_CRN(+)
            AND SSRXLST_XLST_GROUP    = SWRXLST_XLST_GROUP(+)
            AND SSRXLST_TERM_CODE     = SSBXLST_TERM_CODE(+)
            AND SSRXLST_XLST_GROUP    = SSBXLST_XLST_GROUP(+)
            AND (SS.SSBSECT_CAMP_CODE = psUnive OR psUnive IS NULL)
            AND (SS.SSBSECT_TERM_CODE = psTerm  OR psTerm  IS NULL)
            AND (PROFESOR_SUM.PERFIL      = psCate  OR psCate  IS NULL)
            AND (SIRDPC.deptSede      = psSede  OR psSede  IS NULL)
            AND (INSTR('/' || psPtrm, '/' || SS.SSBSECT_PTRM_CODE || '/') > 0 OR psPtrm IS NULL)
        --   AND (SS.SSBSECT_PTRM_CODE  = psPtrm  OR psPtrm IS NULL)
            AND SSBSECT_TERM_CODE     = SSBOVRR_TERM_CODE(+)
            AND SSBSECT_CRN           = SSBOVRR_CRN(+)
            AND (DECODE(SSBOVRR_COLL_CODE,NULL,SCBCRSE_COLL_CODE,SSBOVRR_COLL_CODE) = psFacu OR psFacu IS NULL)
UNION
         SELECT DISTINCT
              '' TERM_CODE,
              'UFT' CAMP_CODE,
              SIRNIST_COLL_CODE                       ESCUELA,
              Pk_Catalogo.COLEGIO(SIRNIST_COLL_CODE)  descSede,
              A.SIBINST_PIDM PIDM,
                SPRIDEN_ID                                              ID,
                SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME              NOMBRE,
                f_get_rut(SIRNIST_PIDM)                                 RUT,
                SIRNIST_PIDM PIDM,
                REPLACE(REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME||' '||SPRIDEN_MI,'','&ntilde;'),'*',' ')  DOCENTE,
                         A.SIBINST_FSTP_CODE    TIPO,
           A.SIBINST_FCTG_CODE    PERFIL,
           Pk_Catalogo.CATEGORIA(A.SIBINST_FCTG_CODE    )                                                   DESCPERFIL,
              --Pk_Catalogo.FUNCION(SIRNIST_NIST_CODE)  DESCRIPCION,
               '' NRC,
                '' PART_PERIODO,
                '' SESION,
                '' ASIGNACION,
                0 SOBREPASO,
                Pk_Catalogo.FUNCION(SIRNIST_NIST_CODE) TITULO,
                '' SECUENCIA,
                 SIRNIST_NIST_CODE                        MATERIA,
                '' CURSO,
                NVL(SUM(SIRNIST_NIST_WORKLOAD),0)  MODULO,
                '' TIPO_CURSO,
                0 INSCRITOS,
                0 PORCENTAJE,
                NVL(SUM(SIRNIST_NIST_WORKLOAD),0)        TOTAL,
                '' IndSesion
           FROM SIRNIST A, SPRIDEN, SIBINST A
          WHERE SIRNIST_PIDM = SPRIDEN_PIDM
          AND A.SIBINST_PIDM = SIRNIST_PIDM
            AND (A.SIRNIST_TERM_CODE = psTerm  OR psTerm  IS NULL)
            and A.SIBINST_TERM_CODE_EFF = (SELECT MAX(Z8.SIBINST_TERM_CODE_EFF)
                                                           FROM SIBINST Z8
                                                          WHERE Z8.SIBINST_PIDM            =  A.SIBINST_PIDM
                                                            AND (Z8.SIBINST_TERM_CODE_EFF <= psTerm OR psTerm IS NULL))
            --AND SIRNIST_PIDM         = pnPidm
            AND A.SIBINST_FSTP_CODE = 'HON'
            and not exists (select 1 from sirasgn
                                    where sirasgn_pidm = sibinst_pidm)
            GROUP BY SIRNIST_COLL_CODE, A.SIBINST_PIDM, SPRIDEN_ID,SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME,f_get_rut(A.SIRNIST_PIDM),
                A.SIRNIST_PIDM, REPLACE(REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME||' '||SPRIDEN_MI,'','&ntilde;'),'*',' '),
                A.SIBINST_FSTP_CODE,A.SIBINST_FCTG_CODE,Pk_Catalogo.CATEGORIA(A.SIBINST_FCTG_CODE),
              Pk_Catalogo.FUNCION(A.SIRNIST_NIST_CODE),A.SIRNIST_NIST_CODE,
                A.SIRNIST_TOPS_CODE
          ORDER BY termCode DESC, campCode, collCode, DOCENTE,NRC;
  --Para obtener funciones de no docencia
  CURSOR cuDetalle(psTerm  VARCHAR2,
                   pnPidm  NUMBER) IS
         SELECT DISTINCT SIRNIST_NIST_CODE                       CLAVE,
                Pk_Catalogo.FUNCION(SIRNIST_NIST_CODE)  DESCRIPCION,
                SIRNIST_TOPS_CODE                       TOPS,
                NVL(SUM(SIRNIST_NIST_WORKLOAD),0)       HORAS,
                SPRIDEN_ID                                              ID,
                SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME              NOMBRE,
                f_get_rut(SIRNIST_PIDM)                                 RUT,
                SIRNIST_COLL_CODE                       ESCUELA
           FROM SIRNIST, SPRIDEN
          WHERE SIRNIST_PIDM = SPRIDEN_PIDM
            AND SIRNIST_TERM_CODE    = psTerm
            AND SIRNIST_PIDM         = pnPidm
            GROUP BY SIRNIST_NIST_CODE, Pk_Catalogo.FUNCION(SIRNIST_NIST_CODE),SIRNIST_TOPS_CODE,SPRIDEN_ID,SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME,f_get_rut(SIRNIST_PIDM),SIRNIST_COLL_CODE ;


            --SPRIDEN_ID,
            --f_get_rut(SIRNIST_PIDM),
            --SIRNIST_COLL_CODE,
            --S1.SIBINST_FCTG_CODE;

procedure detalleFaculty(pnPidm NUMBER,
                             psTerm VARCHAR2
                            ) is

  --Para obtener funciones de no docencia
  cursor cuDetalle(psTerm  varchar2,
                   pnPidm  number) is
         select sirnist_nist_code                       nistCode,
                pk_Catalogo.funcion(sirnist_nist_code)  nistDesc,
                sirnist_tops_code                       topsCode,
                nvl(sum(sirnist_nist_workload),0)       nistWork
           from sirnist
          where sirnist_term_code    = psTerm
            and sirnist_pidm         = pnPidm
          group by sirnist_nist_code,
                   pk_Catalogo.funcion(sirnist_nist_code),
                   sirnist_tops_code;


          begin
                    for regDet in cuDetalle(psTerm, pnPidm) loop
                 IF regDet.nistCode is not null then
                    htp.p('
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top" align="left" width="50%">'||regDet.nistDesc||'</td>
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top" align="left" width="10%">' ||regDet.nistWork||'</td>'
                         );


            END IF;
          end loop;

  end detalleFaculty;


  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
          FOR vnCOKIES IN 1..ckCount LOOP
              IF    ckNOMBRES(vnCOKIES) = 'psUnive' THEN
                    vsUnive := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psPeriM' THEN
                    vsPerio := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                    vsFacu := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psCate' THEN
                    vsCate := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                    vsSeccion := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psPtrm'    THEN
                    vsPtrm  := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psSede' THEN
                    vsSede    := ckValores(vnCOKIES);

              END IF;
          END LOOP;
      END IF;

vsPerioE:= substr(vsPerio,1,6);

      -- Las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := ' ';

      tabColumna(2)  := '<b>ID</b>';
      tabColumna(3)  := '<b>Nombre</b>';
      tabColumna(4)  := '<b>RUT</b>';
      tabColumna(5)  := '<b>NRC</b>';
      tabColumna(6)  := '<b>Parte del periodo</b>';
      tabColumna(7)  := '<b>Jornada</b>';
      tabColumna(8)  := '<b>Materia</b>';
      tabColumna(9)  := '<b>T&iacute;tulo de Curso</b>';
      tabColumna(10)  := '<b>Curso</b>';
      tabColumna(11)  := '<b>Escuela</b>';
      tabColumna(12)  := '<b>Secci&oacute;n</b>';
      tabColumna(13)  := '<b>Sesi&oacute;n</b>';
      tabColumna(14) := '<b>M&oacute;dulo</b>';
      tabColumna(15) := '<b>% de responsabilidad</b>';
      tabColumna(16) := '<b>Total M&oacute;dulo % de responsabilidad</b>';
      tabColumna(17) := '<b>Sobrepaso de Carga</b>';
      tabColumna(18) := '<b>Tipo de Asignaci&oacute;n</b>';
      tabColumna(19) := '<b>Categor&iacute;a</b>';
      tabColumna(20) := '<b>Tipo de curso</b>';
      tabColumna(21) := '<b>Inscritos</b>';



      Pk_Sisrepimp.vgsSaltoImp := 'SALTO';
                   Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,vgsInicoPag,'0', psSubtitulo=>'Periodo '||vsPerioE,psUsuario=>vgsUSR, psSeccion=>vsSeccion, psSinPiePag=>'P',psSinLogo=>'P',psTituloSinFr=>'P',psSinHeaders=>vsSinHeadrs);

    IF vsPtrm IS NOT NULL THEN
    vsPtrm:= vsPtrm;
    end if;
    if vsPtrm = '/' then
    vsPtrm:= NULL;
    END IF;

      WHILE (INSTR(vsPerio, '/') > 0 ) LOOP



          FOR regRep IN cuReporte(vsUnive, SUBSTR(vsPerio, 0, INSTR(vsPerio,'/')-1), vsFacu, vsCate,vsPtrm, vsSede) LOOP


  --              IF vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
--                   vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR
  --                 vsCollcode IS NULL OR vsCollcode <> regRep.collCode OR
    --               vsID       IS NULL OR regRep.ID  <> vsID
      --             THEN

        --           IF vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
          --            vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR
            --          vsCollcode IS NULL OR vsCollcode <> regRep.collCode
              --        THEN
                --      vsSinHeadrs := NULL;
                  -- END IF;



                   --vgsInicoPag := 'SALTO';
                  -- vsSinHeadrs := 'H';
                --END IF;

                htp.p(
                '<tr>
                 <td></td>

                 <td valign="top">'||regRep.ID         ||'</td>
                 <td valign="top">'||regRep.NOMBRE         ||'</td>
                 <td valign="top">'||regRep.SUFFIX         ||'</td>
                 <td valign="top">'||regRep.NRC         ||'</td>
                 <td valign="top">'||regRep.Part_periodo||'</td>
                 <td valign="top">'||regRep.Sesion      ||'</td>
                 <td valign="top">'||regRep.Materia     ||'</td>
                 <td valign="top">'||regRep.TITULO    ||'</td>
                 <td valign="top">'||regRep.Curso       ||'</td>
                 <td valign="top">'||regRep.collCode    ||'</td>
                 <td valign="top">'||regRep.SECUENCIA    ||'</td>
                 <td valign="top">'||regRep.IndSesion    ||'</td>
                 <td valign="top">'||regRep.MODULO   ||'</td>
                 <td valign="top">'||regRep.Porcentaje  ||'</td>
                 <td valign="top">'||regRep.Total       ||'</td>
                 <td valign="top">'||regRep.SOBREPASO  ||'</td>
                 <td valign="top">'||regRep.ASIGNACION  ||'</td>
                 <td valign="top">'||regRep.CVEPERFIL  ||'</td>
                 <td valign="top">'||regRep.Tipo_curso  ||'</td>
                 <td valign="top">'||regRep.Inscritos   ||'</td> </tr>');


                if vsID       IS NULL OR regRep.ID  <> vsID AND regRep.NRC  <> vsCrn THEN

                    for regDet in cuDetalle(regRep.termCode, regRep.Spidm) loop
                 IF regDet.CLAVE is not null then
          htp.p('
          <td valign="top"></td>
          <td valign="top" align="left" width="50%">'||regDet.ID||'</td>
          <td valign="top" align="left" width="50%">'||regDet.NOMBRE||'</td>
          <td valign="top" align="left" width="50%">'||regDet.RUT||'</td>
          <td valign="top"></td>
          <td valign="top"></td>
          <td valign="top">'||regRep.Sesion      ||'</td>
          <td valign="top" align="left" width="50%">'||regDet.CLAVE||'</td>
          <td valign="top" align="left" width="50%">'||regDet.DESCRIPCION||'</td>
          <td valign="top"></td>
          <td valign="top" align="left" width="50%">'||regDet.ESCUELA||'</td>
          <td valign="top"></td>
          <td valign="top" align="left" width="10%">' ||regDet.horas||'</td>
          <td valign="top"></td>
          <td valign="top" align="left" width="10%">' ||regDet.horas||'</td>
          <td valign="top"></td>
          <td valign="top"></td>
          <td valign="top">'||regRep.CVEPERFIL  ||'</td></tr>');

          END IF;
          end loop;
          end if;

                vnPidm     := regRep.Pidm;
                vsID       := regRep.ID;
                vsCRN      := regRep.NRC;
                vsCampCode := regRep.campCode;
                vsTermCode := regRep.termCode;
                vsCollcode := regRep.collCode;
                vnTotalFd  := vnTotalFd + regRep.TOTAL;
                vnExists   := 1;

            END LOOP;

            vsPerio := SUBSTR(vsPerio, INSTR(vsPerio,'/')+1 );
      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');

         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>vgsUSR, psSeccion=>vsSeccion,psSinPiePag=>'P',psSinLogo=>'P');
      END IF;

      htp.p('</table><br/><br/></body></html>');

    EXCEPTION
        WHEN OTHERS THEN htp.p( SQLERRM);

    END PWRNHOE;
/


DROP PUBLIC SYNONYM PWRNHOE;

CREATE PUBLIC SYNONYM PWRNHOE FOR BANINST1.PWRNHOE;


GRANT EXECUTE ON BANINST1.PWRNHOE TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRNHOE TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRNHON;

CREATE OR REPLACE PROCEDURE BANINST1.PWRNHON(psReclDesc VARCHAR2) IS
/*
         Tarea: Reporte de nmina de honorarios
         Fecha: 01/06/2009.
         Autor: CCR

  Modificacion: 13/11/2009
                EAMM
                CAMBIAR LOS PARAMETROS DE PERIODO Y PARTE DE PERIODO POR MULTIOPCIONES

*/
vgsUSR       VARCHAR2(500);
ckCount      INTEGER;
ckNombres    owa_cookie.vc_arr;
ckValores    owa_cookie.vc_arr;
vgsInicoPag  VARCHAR2(10) := NULL;

 -- vnRow            INTEGER                          := 0;
  vnExists         INTEGER                          := 0;
  vnColumnas       INTEGER                          := 19;
  tabColumna       Pk_Sisrepimp.tipoTabla          := Pk_Sisrepimp.tipoTabla(1);

  vnTotalFd        NUMBER                           := 0;
  vnTotalFnd       NUMBER                           := 0;
  vnTotal          NUMBER                           := 0;
  vnPidm           NUMBER                           := NULL;

  vsUnive          VARCHAR2(6)                     := NULL;
  vsPerio          VARCHAR2(1000)                   := NULL;
  vsFacu           VARCHAR2(3)                    := NULL;
  vsCate           VARCHAR2(10)                    := NULL;
  vsSeccion        VARCHAR2(3)                      := NULL;
  vsPtrm           VARCHAR2(1000)                   := NULL;
  vsSede           VARCHAR2(10)                     := NULL;
  vsID             VARCHAR2(10)                     := NULL;
  vsTermCode      VARCHAR2(6)                     := NULL;
  vsCampCode      VARCHAR2(6)                     := NULL;
  vsCollcode      VARCHAR2(6)                     := NULL;
  vsSinHeadrs VARCHAR2(1)            := NULL;

  CURSOR cuReporte(psUnive VARCHAR2 DEFAULT NULL,
                   psTerm  VARCHAR2 DEFAULT NULL,
                   psFacu  VARCHAR2 DEFAULT NULL,
                   psCate  VARCHAR2 DEFAULT NULL,
                   psPtrm  VARCHAR2 DEFAULT NULL,
                   psSede  VARCHAR2 DEFAULT NULL
                  ) IS
         SELECT DISTINCT SS.SSBSECT_TERM_CODE                                                                     termCode,
                SSBSECT_CAMP_CODE                                                                        campCode,
                DECODE(SSBOVRR_COLL_CODE,NULL,SCBCRSE_COLL_CODE,SSBOVRR_COLL_CODE)                       collCode,
                Pk_Catalogo.COLEGIO(DECODE(SSBOVRR_COLL_CODE,NULL,SCBCRSE_COLL_CODE,SSBOVRR_COLL_CODE))  descSede,
                SPRIDEN_ID                                                                               ID,
                SPBPERS_NAME_SUFFIX                                                                      SUFFIX,
                PROFESOR.PIDM                                                                            PIDM,
                REPLACE(REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME||' '||SPRIDEN_MI,'','&ntilde;'),'*',' ') DOCENTE,
                Pk_Catalogo.TIPO(PROFESOR.TIPO)                                                          TIPO_PROFESOR,
                PROFESOR.PERFIL                                                                          CVEPERFIL,
                Pk_Catalogo.CATEGORIA(PROFESOR.PERFIL)                                                   DESCPERFIL,
                SSBSECT_CRN                                                                              NRC,
                '('||SSBSECT_PTRM_CODE||') '||PROFESOR.P_PERIODO                                         PART_PERIODO,
                PROFESOR.DIAS                                                                            DIAS,
                SSBSECT_SESS_CODE                                                                        SESION,
                PROFESOR.HORARIO                                                                         HORARIO,
                PROFESOR.ASIGNACION                                                                      ASIGNACION,
                PROFESOR.SOBREPASO                                                                       SOBREPASO,
                SCBCRSE_TITLE                                                                            TITULO,
                SSBSECT_SEQ_NUMB                                                                         SECUENCIA,
                SCBCRSE_SUBJ_CODE                                  MATERIA,
                SCBCRSE_CRSE_NUMB                                  CURSO,
                NVL(PROFESOR.HORAS_SEM,0)                          HORAS_SEM,
                PROFESOR.MODULO                                    MODULO,
                DECODE(SWRXLST_TYPE,'M','Master','S','Simultneo','Independiente') TIPO_CURSO,
                DECODE(SWRXLST_TYPE,'M',SSBXLST_ENRL,SSBSECT_ENRL) INSCRITOS,
                NVL(PROFESOR.PORCENTAJE,0)                         PORCENTAJE,
                NVL(PROFESOR.MODULO,0) * NVL(PROFESOR.PORCENTAJE,0)/100 TOTAL
           FROM SSBSECT SS,
                SCBCRSE,
                (SELECT SIRASGN_PIDM                                                 PIDM,
                        SIRASGN_ASTY_CODE                                            ASIGNACION,
                        SSRMEET_TERM_CODE                                            PERIODO,
                        SSRMEET_CRN                                                  CRN,
                        SSRMEET_CATAGORY                                             CATEGORIA,
                        SSRMEET_HRS_WEEK                                             HORAS_SEM,
                        round((SSRMEET_HRS_WEEK/1.33),2)                                             MODULO,
                        SIRASGN_WORKLOAD_ADJUST                                      SOBREPASO,
                        DECODE(SSRMEET_MON_DAY, 'M', 'Lu', SSRMEET_MON_DAY)||'-'||
                        DECODE(SSRMEET_TUE_DAY, 'T', 'Ma', SSRMEET_TUE_DAY)||'-'||
                        DECODE(SSRMEET_WED_DAY, 'W', 'Mi', SSRMEET_WED_DAY)||'-'||
                        DECODE(SSRMEET_THU_DAY, 'R', 'Ju', SSRMEET_THU_DAY)||'-'||
                        DECODE(SSRMEET_FRI_DAY, 'F', 'Vi', SSRMEET_FRI_DAY)||'-'||
                        DECODE(SSRMEET_SAT_DAY, 'S', 'Sa', SSRMEET_SAT_DAY)          DIAS,
                        SUBSTR(SSRMEET_BEGIN_TIME,1,2)||':'||
                        NVL(SUBSTR(SSRMEET_BEGIN_TIME,3,2),'00')||' '||
                            SUBSTR(SSRMEET_END_TIME,1,2)||':'||
                        NVL(SUBSTR(SSRMEET_END_TIME,3,2),'00')                       HORARIO,
                        SSRMEET_START_DATE||' - '||SSRMEET_END_DATE                  P_PERIODO,
                        INST.TIPO                                                    TIPO,
                        INST.PERFIL                                                  PERFIL,
                        SIRASGN_PERCENT_RESPONSE                                     PORCENTAJE
                   FROM SSRMEET,
                        SIRASGN,
                        (SELECT SI.SIBINST_PIDM         PIDM,
                                SI.SIBINST_FSTP_CODE    TIPO,
                                SI.SIBINST_FCTG_CODE    PERFIL
                           FROM SIBINST SI
                          WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(ZI.SIBINST_TERM_CODE_EFF)
                                                           FROM SIBINST ZI
                                                          WHERE ZI.SIBINST_PIDM            =  SI.SIBINST_PIDM
                                                            AND (ZI.SIBINST_TERM_CODE_EFF <= psTerm OR psTerm IS NULL)
                                                        )
                        ) INST
                  WHERE SIRASGN_PIDM            = INST.PIDM(+)
                    AND SSRMEET_TERM_CODE       = SIRASGN_TERM_CODE(+)
                    AND SSRMEET_CRN             = SIRASGN_CRN(+)
                    AND SSRMEET_CATAGORY        = SIRASGN_CATEGORY(+)
                    AND SIRASGN_PERCENT_RESPONSE > 0
                    AND INST.TIPO               = 'HON'
                ) PROFESOR,
                SPRIDEN,
                SPBPERS,
                SWRXLST,
                SSRXLST,
                SSBXLST,
                SSBOVRR,
                (SELECT SIRDPCL_PIDM      dpclPidm,
                        SIRDPCL_COLL_CODE collCode,
                        SIRDPCL_DEPT_CODE deptSede
                   FROM SIRDPCL A
                  WHERE SIRDPCL_HOME_IND      = 'Y'
                    AND SIRDPCL_TERM_CODE_EFF = (SELECT MAX(SI.SIRDPCL_TERM_CODE_EFF)
                                                   FROM SIRDPCL SI
                                                  WHERE SI.SIRDPCL_PIDM           =  A.SIRDPCL_PIDM
                                                    AND (SI.SIRDPCL_TERM_CODE_EFF <= psTerm OR psTerm IS NULL)
                                                )
                ) SIRDPC
          WHERE SSBSECT_SUBJ_CODE     = SCBCRSE_SUBJ_CODE
            AND SSBSECT_CRSE_NUMB     = SCBCRSE_CRSE_NUMB
            AND SCBCRSE_EFF_TERM      = (SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                           FROM SCBCRSE SC
                                          WHERE SC.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                            AND SC.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                            AND SC.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB
                                        )
            AND SSBSECT_TERM_CODE     = PROFESOR.PERIODO
            AND SSBSECT_CRN           = PROFESOR.CRN
            AND PROFESOR.PIDM         = SPRIDEN_PIDM(+)
            AND SPRIDEN_PIDM          = SIRDPC.dpclPidm(+)
            AND SPRIDEN_CHANGE_IND IS NULL
            AND SPBPERS_PIDM          = SPRIDEN_PIDM
            AND SSBSECT_TERM_CODE     = SSRXLST_TERM_CODE(+)
            AND SSBSECT_CRN           = SSRXLST_CRN(+)
            AND SSRXLST_TERM_CODE     = SWRXLST_TERM_CODE(+)
            AND SSRXLST_CRN           = SWRXLST_CRN(+)
            AND SSRXLST_XLST_GROUP    = SWRXLST_XLST_GROUP(+)
            AND SSRXLST_TERM_CODE     = SSBXLST_TERM_CODE(+)
            AND SSRXLST_XLST_GROUP    = SSBXLST_XLST_GROUP(+)
            AND (SS.SSBSECT_CAMP_CODE = psUnive OR psUnive IS NULL)
            AND (SS.SSBSECT_TERM_CODE = psTerm  OR psTerm  IS NULL)
            AND (PROFESOR.PERFIL      = psCate  OR psCate  IS NULL)
            AND (SIRDPC.deptSede      = psSede  OR psSede  IS NULL)
            AND (INSTR('/' || psPtrm, '/' || SS.SSBSECT_PTRM_CODE || '/') > 0 OR psPtrm IS NULL)
            AND SSBSECT_TERM_CODE     = SSBOVRR_TERM_CODE(+)
            AND SSBSECT_CRN           = SSBOVRR_CRN(+)
            AND (DECODE(SSBOVRR_COLL_CODE,NULL,SCBCRSE_COLL_CODE,SSBOVRR_COLL_CODE) = psFacu OR psFacu IS NULL)
          ORDER BY termCode DESC, campCode, collCode, DOCENTE, NRC;

  --Para obtener funciones de no docencia
  CURSOR cuDetalle(psTerm  VARCHAR2,
                   pnPidm  NUMBER) IS
         SELECT SIRNIST_NIST_CODE                       CLAVE,
                Pk_Catalogo.FUNCION(SIRNIST_NIST_CODE)  DESCRIPCION,
                SIRNIST_TOPS_CODE                       TOPS,
                NVL(SUM(SIRNIST_NIST_WORKLOAD),0)       HORAS
           FROM SIRNIST
          WHERE SIRNIST_TERM_CODE    = psTerm
            AND SIRNIST_PIDM         = pnPidm
          GROUP BY SIRNIST_NIST_CODE, Pk_Catalogo.FUNCION(SIRNIST_NIST_CODE),SIRNIST_TOPS_CODE;

  function detalle(psId   varchar2,
                   psName varchar2,
                   psRut  varchar2,
                   psSede varchar2
                  ) return varchar2 is

  vsEscuelaSede VARCHAR2(300) := '<tr><th colspan='||vncolumnas||'>Escuela &nbsp;&nbsp;'||psSede||'</th></tr>';

  begin
      if vsSinHeadrs is not null then
         vsEscuelaSede := null;
      end if;

            return vsEscuelaSede||
          '<tr>'||
             '<td width="15%"><b>'||psId||'&nbsp;&nbsp;'||psName||'&nbsp;&nbsp;&nbsp;'||psRut||'</b></td>'||
             '<td width="85%" colspan='||(vncolumnas-1)||'></td>'||
             '</tr>';


  end detalle;

  /*function detalle(psId   varchar2,
                   psName varchar2,
                   psSede varchar2
                  ) return varchar2 is

  vsEscuelaSede VARCHAR2(300) := '<tr><th colspan='||vncolumnas||'>Escuela &nbsp;&nbsp;'||psSede||'</th></tr>';

  begin
      if vsSinHeadrs is not null then
         vsEscuelaSede := null;
      end if;

      return vsEscuelaSede||
             '<tr>'||
             '<td width="15%"><b>'||psId||'&nbsp;&nbsp;'||psName||'</b></td>'||
             '<td width="85%" colspan='||(vncolumnas-1)||'></td>'||
             '</tr>';

  end detalle;
*/
  procedure detalleFaculty(pnPidm NUMBER,
                             psTerm VARCHAR2
                            ) is

  --Para obtener funciones de no docencia
  cursor cuDetalle(psTerm  varchar2,
                   pnPidm  number) is
         select sirnist_nist_code                       nistCode,
                pk_Catalogo.funcion(sirnist_nist_code)  nistDesc,
                sirnist_tops_code                       topsCode,
                nvl(sum(sirnist_nist_workload),0)       nistWork
           from sirnist
          where sirnist_term_code    = psTerm
            and sirnist_pidm         = pnPidm
          group by sirnist_nist_code,
                   sirnist_nist_code,
                   sirnist_tops_code;

  begin
      htp.p('<tr><td>
      <table border="0" width="100%" cellpadding="0 cellspacing="0">
      <tr><th align="left" colspan="3">Horas docencia</th>
          <th align="left">'||vnTotalFd||'</th>
          </tr>'
      );

      for regDet in cuDetalle(psTerm, pnPidm) loop
          vnTotalFnd := vnTotalFnd + regDet.nistWork;

          htp.p('<tr>
          <td valign="top" align="left" width="20%">'||regDet.nistCode||'</td>
          <td valign="top" align="left" width="50%">'||regDet.nistDesc||'</td>
          <td valign="top" align="left" width="20%">'||regDet.topsCode||'</td>
          <td valign="top" align="left" width="10%">' ||regDet.nistWork||'</td>
          </tr>'
          );
      end loop;

      vnTotal := vnTotalFd + vnTotalFnd;

      htp.p('<tr>
      <th align="left" colspan="3">Total M&oacute;dulos docentes</th>
      <th align="left">'||vnTotal||'</th>
      </tr>
      </table>
      </td>
      <td colspan="'||(vnColumnas-1)||'">
      </td></tr>'
      );

--      for vnI in 1..(vnColumnas-1)  loop
--          htp.p('<td></td>');
--      end loop;
--
--      htp.p('</tr>');

      vnTotalFd  := 0;
      vnTotalFnd := 0;
      vnTotal    := 0;

  end detalleFaculty;


  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
          FOR vnCOKIES IN 1..ckCount LOOP
              IF    ckNOMBRES(vnCOKIES) = 'psUnive' THEN
                    vsUnive := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psPeriM' THEN
                    vsPerio := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                    vsFacu := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psCate' THEN
                    vsCate := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                    vsSeccion := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psPtrm'    THEN
                    vsPtrm  := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psSede' THEN
                    vsSede    := ckValores(vnCOKIES);

              END IF;
          END LOOP;
      END IF;

      -- Las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := ' ';
      tabColumna(2)  := '<b>NRC</b>';
      tabColumna(3)  := '<b>Parte del periodo</b>';
      tabColumna(4)  := '<b>D&iacute;as</b>';
      tabColumna(5)  := '<b>Sesi&oacute;n</b>';
      tabColumna(6)  := '<b>Horario</b>';
      tabColumna(7)  := '<b>Materia</b>';
      tabColumna(8)  := '<b>T&iacute;ulo de Curso</b>';
      tabColumna(9)  := '<b>Curso</b>';
      tabColumna(10)  := '<b>Escuela</b>';
      tabColumna(11)  := '<b>Secci&oacute;n</b>';
      tabColumna(12) := '<b>M&oacute;dulo</b>';
      tabColumna(13) := '<b>% de responsabilidad</b>';
      tabColumna(14) := '<b>Total M&oacute;dulo % de responsabilidad</b>';
      tabColumna(15) := '<b>Sobrepaso de Carga</b>';
      tabColumna(16) := '<b>Tipo de Asignaci&oacute;n</b>';
      tabColumna(17) := '<b>Categor&iacute;a</b>';
      tabColumna(18) := '<b>Tipo de curso</b>';
      tabColumna(19) := '<b>Inscritos</b>';

      Pk_Sisrepimp.vgsSaltoImp := 'SALTO';

      WHILE (INSTR(vsPerio, '/') > 0 ) LOOP

            FOR regRep IN cuReporte(vsUnive, SUBSTR(vsPerio, 0, INSTR(vsPerio,'/')-1), vsFacu, vsCate,vsPtrm, vsSede) LOOP
                IF vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
                   vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR
                   vsCollcode IS NULL OR vsCollcode <> regRep.collCode OR
                   vsID       IS NULL OR regRep.ID  <> vsID
                   THEN

                   IF vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
                      vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR
                      vsCollcode IS NULL OR vsCollcode <> regRep.collCode
                      THEN
                      vsSinHeadrs := NULL;
                   END IF;

                   IF vsID IS NOT NULL THEN
                      detalleFaculty(vnPidm, vsTermCode);
                   END IF;

                   Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,vgsInicoPag,'0', psSubtitulo=>'Periodo '||regRep.termCode, psUsuario=>vgsUSR, psSeccion=>vsSeccion, psUniversidad=>regRep.campCode, psDetalle=>detalle(regRep.ID,regRep.Docente, regRep.SUFFIX, regRep.descSede),psSinPiePag=>'P',psSinLogo=>'P',psTituloSinFr=>'P',psSinHeaders=>vsSinHeadrs);
                   vgsInicoPag := 'SALTO';
                   vsSinHeadrs := 'H';
                END IF;

                htp.p(
                '<tr>
                 <td></td>
                 <td valign="top">'||regRep.NRC         ||'</td>
                 <td valign="top">'||regRep.Part_periodo||'</td>
                 <td valign="top">'||regRep.Dias        ||'</td>
                 <td valign="top">'||regRep.Sesion      ||'</td>
                 <td valign="top">'||regRep.Horario     ||'</td>
                 <td valign="top">'||regRep.Materia     ||'</td>
                 <td valign="top">'||regRep.TITULO    ||'</td>
                 <td valign="top">'||regRep.Curso       ||'</td>
                 <td valign="top">'||regRep.collCode    ||'</td>
                 <td valign="top">'||regRep.SECUENCIA    ||'</td>
                 <td valign="top">'||regRep.MODULO   ||'</td>
                 <td valign="top">'||regRep.Porcentaje  ||'</td>
                 <td valign="top">'||regRep.Total       ||'</td>
                 <td valign="top">'||regRep.SOBREPASO  ||'</td>
                 <td valign="top">'||regRep.ASIGNACION  ||'</td>
                 <td valign="top">'||regRep.CVEPERFIL  ||'</td>
                 <td valign="top">'||regRep.Tipo_curso  ||'</td>
                 <td valign="top">'||regRep.Inscritos   ||'</td>
                 </tr>'
                );

                vnPidm     := regRep.Pidm;
                vsID       := regRep.ID;
                vsCampCode := regRep.campCode;
                vsTermCode := regRep.termCode;
                vsCollcode := regRep.collCode;
                vnTotalFd  := vnTotalFd + regRep.TOTAL;
                vnExists   := 1;
            END LOOP;

            vsPerio := SUBSTR(vsPerio, INSTR(vsPerio,'/')+1 );
      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
         detalleFaculty(vnPidm, vsTermCode);

         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>vgsUSR, psSeccion=>vsSeccion,psSinPiePag=>'P',psSinLogo=>'P');
      END IF;

      htp.p('</table><br/><br/></body></html>');

    EXCEPTION
        WHEN OTHERS THEN htp.p( SQLERRM);

    END PWRNHON;
/


DROP PUBLIC SYNONYM PWRNHON;

CREATE PUBLIC SYNONYM PWRNHON FOR BANINST1.PWRNHON;


GRANT EXECUTE ON BANINST1.PWRNHON TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRNHON TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRNHOP;

CREATE OR REPLACE PROCEDURE BANINST1.PWRNHOP(psReclDesc VARCHAR2) IS
/*
         Tarea: Reporte de nmina de honorarios Excel
         Fecha: 01/06/2009.
         Autor: CCR

  Modificacion: 13/11/2009
                EAMM
                CAMBIAR LOS PARAMETROS DE PERIODO Y PARTE DE PERIODO POR MULTIOPCIONES

*/
vgsUSR       VARCHAR2(500);
ckCount      INTEGER;
ckNombres    owa_cookie.vc_arr;
ckValores    owa_cookie.vc_arr;
vgsInicoPag  VARCHAR2(10) := NULL;

 -- vnRow            INTEGER                          := 0;
  vnExists         INTEGER                          := 0;
  vnColumnas       INTEGER                          := 20;
  tabColumna       Pk_Sisrepimp.tipoTabla          := Pk_Sisrepimp.tipoTabla(1);

  vnTotalFd        NUMBER                           := 0;
  vnTotalFnd       NUMBER                           := 0;
  vnTotal          NUMBER                           := 0;
  vnPidm           NUMBER                           := NULL;

  vsUnive          VARCHAR2(6)                     := NULL;
  vsPerio          VARCHAR2(1000)                   := NULL;
  vsFacu           VARCHAR2(3)                    := NULL;
  vsCate           VARCHAR2(10)                    := NULL;
  vsSeccion        VARCHAR2(3)                      := NULL;
  vsTipo           VARCHAR2(50)                     := NULL;
  vsPtrm           VARCHAR2(1000)                   := NULL;
  vsSede           VARCHAR2(10)                     := NULL;
  vsID             VARCHAR2(10)                     := NULL;
  vsCRN            VARCHAR2(10)                     := NULL;
  vsTermCode      VARCHAR2(6)                     := NULL;
  vsCampCode      VARCHAR2(6)                     := NULL;
  vsCollcode      VARCHAR2(6)                     := NULL;
  vsSinHeadrs VARCHAR2(1)            := NULL;

  CURSOR cuReporte(psTerm  VARCHAR2 DEFAULT NULL,
                   psFacu  VARCHAR2 DEFAULT NULL,
                   psCate  VARCHAR2 DEFAULT NULL,
                   psPtrm  VARCHAR2 DEFAULT NULL,
                   psSede  VARCHAR2 DEFAULT NULL,
                   psType  VARCHAR2 DEFAULT NULL
                  ) IS
         SELECT DISTINCT SS.SSBSECT_TERM_CODE                                                                     termCode,
                SSBSECT_CAMP_CODE                                                                        campCode,
                DECODE(SSBOVRR_COLL_CODE,NULL,SCBCRSE_COLL_CODE,SSBOVRR_COLL_CODE)                       collCode,
                Pk_Catalogo.COLEGIO(DECODE(SSBOVRR_COLL_CODE,NULL,SCBCRSE_COLL_CODE,SSBOVRR_COLL_CODE))  descSede,
                SPRIDEN_PIDM                                                                             SPIDM,
                SPRIDEN_ID                                                                               ID,
                SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME                                               NOMBRE,
                SPBPERS_NAME_SUFFIX                                                                      SUFFIX,
                PROFESOR_SUM.PIDM                                                                            PIDM,
                REPLACE(REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME||' '||SPRIDEN_MI,'','&ntilde;'),'*',' ') DOCENTE,
                Pk_Catalogo.TIPO(PROFESOR_SUM.TIPO)                                                          TIPO_PROFESOR,
                PROFESOR_SUM.PERFIL                                                                          CVEPERFIL,
                Pk_Catalogo.CATEGORIA(PROFESOR_SUM.PERFIL)                                                   DESCPERFIL,
                SSBSECT_CRN                                                                              NRC,
                '('||SSBSECT_PTRM_CODE||') '||PROFESOR_SUM.P_PERIODO                                         PART_PERIODO,
                SSBSECT_SESS_CODE                                                                       SESION,
                PROFESOR_SUM.ASIGNACION                                                                      ASIGNACION,
                PROFESOR_SUM.SOBREPASO                                                                  SOBREPASO,
                SCBCRSE_TITLE                                                                            TITULO,
                SSBSECT_SEQ_NUMB                                                                         SECUENCIA,
                SCBCRSE_SUBJ_CODE                                  MATERIA,
                SCBCRSE_CRSE_NUMB                                  CURSO,
                NVL(PROFESOR_SUM.SUMA_MODULO,0) MODULO,
                DECODE(SWRXLST_TYPE,'M','Master','S','Simultneo','Independiente') TIPO_CURSO,
                DECODE(SWRXLST_TYPE,'M',SSBXLST_ENRL,SSBSECT_ENRL) INSCRITOS,
                NVL(PROFESOR_SUM.PORCENTAJE,0)                         PORCENTAJE,
                ROUND((NVL(PROFESOR_SUM.SUMA_MODULO,0) * NVL(PROFESOR_SUM.PORCENTAJE,0)/100),1) TOTAL
           FROM SSBSECT SS,
                SCBCRSE,
                (SELECT SIRASGN_PIDM                                                 PIDM,
                        SSRMEET_TERM_CODE                                            PERIODO,
                        SSRMEET_CRN                                                  CRN,
                        ROUND(SUM((SSRMEET_HRS_WEEK/1.33)),2)                        SUMA_MODULO,
                        SIRASGN_PERCENT_RESPONSE                                    PORCENTAJE,
                        SIRASGN_WORKLOAD_ADJUST                                      SOBREPASO,
                        SIRASGN_ASTY_CODE                                            ASIGNACION,
                        SSRMEET_CATAGORY                                             CATEGORIA,
                        SSRMEET_START_DATE||' - '||SSRMEET_END_DATE                  P_PERIODO,
                        INST_SUM.TIPO                                                    TIPO,
                        INST_SUM.PERFIL                                                  PERFIL
                        FROM SSRMEET,
                        SIRASGN,
                        (SELECT S2.SIBINST_PIDM         PIDM,
                                S2.SIBINST_FSTP_CODE    TIPO,
                                S2.SIBINST_FCTG_CODE    PERFIL
                           FROM SIBINST S2
                          WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(Z2.SIBINST_TERM_CODE_EFF)
                                                           FROM SIBINST Z2
                                                          WHERE Z2.SIBINST_PIDM            =  S2.SIBINST_PIDM
                                                            AND (Z2.SIBINST_TERM_CODE_EFF <= psTerm)

                                                        )

                        ) INST_SUM
                  WHERE SIRASGN_PIDM            = INST_SUM.PIDM(+)
                    AND SSRMEET_TERM_CODE       = SIRASGN_TERM_CODE(+)
                    AND SSRMEET_CRN             = SIRASGN_CRN(+)
                    AND SSRMEET_CATAGORY        = SIRASGN_CATEGORY(+)
                    AND SIRASGN_PERCENT_RESPONSE > 0
                    AND INST_SUM.TIPO               IN  ('PCP' ,'PSP')
                    GROUP BY SIRASGN_PIDM, SSRMEET_TERM_CODE, SSRMEET_CRN, SIRASGN_PERCENT_RESPONSE, SIRASGN_WORKLOAD_ADJUST, SIRASGN_ASTY_CODE, SSRMEET_CATAGORY, SSRMEET_START_DATE||' - '||SSRMEET_END_DATE, INST_SUM.TIPO, INST_SUM.PERFIL)PROFESOR_SUM,
                SPRIDEN,
                SPBPERS,
                SWRXLST,
                SSRXLST,
                SSBXLST,
                SSBOVRR,
                (SELECT SIRDPCL_PIDM      dpclPidm,
                        SIRDPCL_COLL_CODE collCode,
                        SIRDPCL_DEPT_CODE deptSede
                   FROM SIRDPCL A
                  WHERE SIRDPCL_HOME_IND      = 'Y'
                    AND SIRDPCL_TERM_CODE_EFF = (SELECT MAX(SI.SIRDPCL_TERM_CODE_EFF)
                                                   FROM SIRDPCL SI
                                                  WHERE SI.SIRDPCL_PIDM           =  A.SIRDPCL_PIDM
                                                    AND (SI.SIRDPCL_TERM_CODE_EFF <= psTerm)
                                                )
                ) SIRDPC
          WHERE SSBSECT_SUBJ_CODE     = SCBCRSE_SUBJ_CODE
            AND SSBSECT_CRSE_NUMB     = SCBCRSE_CRSE_NUMB
            AND SCBCRSE_EFF_TERM      = (SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                           FROM SCBCRSE SC
                                          WHERE SC.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                            AND SC.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                            AND SC.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB
                                        )
            AND SSBSECT_TERM_CODE     = PROFESOR_SUM.PERIODO
            AND SSBSECT_CRN           = PROFESOR_SUM.CRN
            AND PROFESOR_SUM.PIDM         = SPRIDEN_PIDM(+)
            AND SPRIDEN_PIDM          = SIRDPC.dpclPidm(+)
            AND SPRIDEN_CHANGE_IND IS NULL
            AND SPBPERS_PIDM          = SPRIDEN_PIDM
            AND SSBSECT_TERM_CODE     = SSRXLST_TERM_CODE(+)
            AND SSBSECT_CRN           = SSRXLST_CRN(+)
            AND SSRXLST_TERM_CODE     = SWRXLST_TERM_CODE(+)
            AND SSRXLST_CRN           = SWRXLST_CRN(+)
            AND SSRXLST_XLST_GROUP    = SWRXLST_XLST_GROUP(+)
            AND SSRXLST_TERM_CODE     = SSBXLST_TERM_CODE(+)
            AND SSRXLST_XLST_GROUP    = SSBXLST_XLST_GROUP(+)
            AND SS.SSBSECT_TERM_CODE = psTerm
            AND (SUBSTR(PROFESOR_SUM.TIPO,1,2) = psType OR psType IS NULL)
            AND (PROFESOR_SUM.PERFIL      = psCate  OR psCate  IS NULL)
            AND (SIRDPC.deptSede      = psSede  OR psSede  IS NULL)
            AND (INSTR('/' || psPtrm, '/' || SS.SSBSECT_PTRM_CODE || '/') > 0 OR psPtrm IS NULL)
            AND SSBSECT_TERM_CODE     = SSBOVRR_TERM_CODE(+)
            AND SSBSECT_CRN           = SSBOVRR_CRN(+)
            AND (DECODE(SSBOVRR_COLL_CODE,NULL,SCBCRSE_COLL_CODE,SSBOVRR_COLL_CODE) = psFacu OR psFacu IS NULL)
          ORDER BY termCode DESC, campCode, collCode, NRC, DOCENTE;

  --Para obtener funciones de no docencia
  --Para obtener funciones de no docencia
  CURSOR cuDetalle(psTerm  VARCHAR2,
                   pnPidm  NUMBER) IS
         SELECT DISTINCT SIRNIST_NIST_CODE                       CLAVE,
                Pk_Catalogo.FUNCION(SIRNIST_NIST_CODE)  DESCRIPCION,
                SIRNIST_TOPS_CODE                       TOPS,
                NVL(SUM(SIRNIST_NIST_WORKLOAD),0)       HORAS,
                SPRIDEN_ID                                              ID,
                SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME              NOMBRE,
                f_get_rut(SIRNIST_PIDM)                                 RUT,
                SIRNIST_COLL_CODE                       ESCUELA
           FROM SIRNIST, SPRIDEN
          WHERE SIRNIST_PIDM = SPRIDEN_PIDM
            AND SIRNIST_TERM_CODE    = psTerm
            AND SIRNIST_PIDM         = pnPidm
            GROUP BY SIRNIST_NIST_CODE, Pk_Catalogo.FUNCION(SIRNIST_NIST_CODE),SIRNIST_TOPS_CODE,SPRIDEN_ID,SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME,f_get_rut(SIRNIST_PIDM),SIRNIST_COLL_CODE;





  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
          FOR vnCOKIES IN 1..ckCount LOOP
              IF    ckNOMBRES(vnCOKIES) = 'psUnive' THEN
                    vsUnive := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psPeriM' THEN
                    vsPerio := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                    vsFacu := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psCate' THEN
                    vsCate := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                    vsSeccion := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psPtrm'    THEN
                    vsPtrm  := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psSede' THEN
                    vsSede    := ckValores(vnCOKIES);


              ELSIF ckNOMBRES(vnCOKIES) = 'psTipoN' THEN
                    vsTipo  := ckValores(vnCOKIES);

              END IF;
          END LOOP;
      END IF;

      -- Las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := ' ';

      tabColumna(2)  := '<b>ID</b>';
      tabColumna(3)  := '<b>Nombre</b>';
      tabColumna(4)  := '<b>RUT</b>';
      tabColumna(5)  := '<b>NRC</b>';
      tabColumna(6)  := '<b>Parte del periodo</b>';
      tabColumna(7)  := '<b>Sesi&oacute;n</b>';
      tabColumna(8)  := '<b>Materia</b>';
      tabColumna(9)  := '<b>T&iacute;ulo de Curso</b>';
      tabColumna(10)  := '<b>Curso</b>';
      tabColumna(11)  := '<b>Escuela</b>';
      tabColumna(12)  := '<b>Secci&oacute;n</b>';
      tabColumna(13) := '<b>M&oacute;dulo</b>';
      tabColumna(14) := '<b>% de responsabilidad</b>';
      tabColumna(15) := '<b>Total M&oacute;dulo % de responsabilidad</b>';
      tabColumna(16) := '<b>Sobrepaso de Carga</b>';
      tabColumna(17) := '<b>Tipo de Asignaci&oacute;n</b>';
      tabColumna(18) := '<b>Categor&iacute;a</b>';
      tabColumna(19) := '<b>Tipo de curso</b>';
      tabColumna(20) := '<b>Inscritos</b>';

      Pk_Sisrepimp.vgsSaltoImp := 'SALTO';
                   Pk_Sisrepimp.P_EncabezadoDeReporte(null, vnColumnas,tabColumna,vgsInicoPag,'0', psSubtitulo=>'Periodo '||'201075', psUsuario=>vgsUSR, psSeccion=>vsSeccion, psSinPiePag=>'P',psSinLogo=>'P',psTituloSinFr=>'P',psSinHeaders=>vsSinHeadrs);

      WHILE (INSTR(vsPerio, '/') > 0 ) LOOP



          FOR regRep IN cuReporte(SUBSTR(vsPerio, 0, INSTR(vsPerio,'/')-1), vsFacu, vsCate,vsPtrm,  vsSede, vsTipo) LOOP
  --              IF vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
--                   vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR
  --                 vsCollcode IS NULL OR vsCollcode <> regRep.collCode OR
    --               vsID       IS NULL OR regRep.ID  <> vsID
      --             THEN

        --           IF vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
          --            vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR
            --          vsCollcode IS NULL OR vsCollcode <> regRep.collCode
              --        THEN
                --      vsSinHeadrs := NULL;
                  -- END IF;



                   --vgsInicoPag := 'SALTO';
                  -- vsSinHeadrs := 'H';
                --END IF;

                htp.p(
                '<tr>
                 <td></td>

                 <td valign="top">'||regRep.ID         ||'</td>
                 <td valign="top">'||regRep.NOMBRE         ||'</td>
                 <td valign="top">'||regRep.SUFFIX         ||'</td>
                 <td valign="top">'||regRep.NRC         ||'</td>
                 <td valign="top">'||regRep.Part_periodo||'</td>
                 <td valign="top">'||regRep.Sesion      ||'</td>
                 <td valign="top">'||regRep.Materia     ||'</td>
                 <td valign="top">'||regRep.TITULO    ||'</td>
                 <td valign="top">'||regRep.Curso       ||'</td>
                 <td valign="top">'||regRep.collCode    ||'</td>
                 <td valign="top">'||regRep.SECUENCIA    ||'</td>
                 <td valign="top">'||regRep.MODULO   ||'</td>
                 <td valign="top">'||regRep.Porcentaje  ||'</td>
                 <td valign="top">'||regRep.Total       ||'</td>
                 <td valign="top">'||regRep.SOBREPASO  ||'</td>
                 <td valign="top">'||regRep.ASIGNACION  ||'</td>
                 <td valign="top">'||regRep.CVEPERFIL  ||'</td>
                 <td valign="top">'||regRep.Tipo_curso  ||'</td>
                 <td valign="top">'||regRep.Inscritos   ||'</td> </tr>');


                if vsID       IS NULL OR regRep.ID  <> vsID AND regRep.NRC  <> vsCrn THEN

                    for regDet in cuDetalle(regRep.termCode, regRep.Spidm) loop
                 IF regDet.CLAVE is not null then
          htp.p('
          <td valign="top"></td>
          <td valign="top" align="left" width="50%">'||regDet.ID||'</td>
          <td valign="top" align="left" width="50%">'||regDet.NOMBRE||'</td>
          <td valign="top" align="left" width="50%">'||regDet.RUT||'</td>
          <td valign="top"></td>
          <td valign="top"></td>
          <td valign="top">'||regRep.Sesion      ||'</td>
          <td valign="top" align="left" width="50%">'||regDet.CLAVE||'</td>
          <td valign="top" align="left" width="50%">'||regDet.DESCRIPCION||'</td>
          <td valign="top"></td>
          <td valign="top" align="left" width="50%">'||regDet.ESCUELA||'</td>
          <td valign="top"></td>
          <td valign="top" align="left" width="10%">' ||regDet.horas||'</td>
          <td valign="top"></td>
          <td valign="top" align="left" width="10%">' ||regDet.horas||'</td>
          <td valign="top"></td>
          <td valign="top"></td>
--                           <td valign="top">'||regRep.CVEPERFIL  ||'</td></tr>');

          END IF;
          end loop;
          end if;


                vnPidm     := regRep.Pidm;
                vsID       := regRep.ID;
                vsCRN      := regRep.NRC;
                vsCampCode := regRep.campCode;
                vsTermCode := regRep.termCode;
                vsCollcode := regRep.collCode;
                vnTotalFd  := vnTotalFd + regRep.TOTAL;
                vnExists   := 1;
            END LOOP;

            vsPerio := SUBSTR(vsPerio, INSTR(vsPerio,'/')+1 );
      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');

         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>vgsUSR, psSeccion=>vsSeccion,psSinPiePag=>'P',psSinLogo=>'P');
      END IF;

      htp.p('</table><br/><br/></body></html>');

    EXCEPTION
        WHEN OTHERS THEN htp.p( SQLERRM);

    END PWRNHOP;
/


DROP PUBLIC SYNONYM PWRNHOP;

CREATE PUBLIC SYNONYM PWRNHOP FOR BANINST1.PWRNHOP;


GRANT EXECUTE ON BANINST1.PWRNHOP TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRNHOP TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRNHOU;

CREATE OR REPLACE PROCEDURE BANINST1.PWRNHOU(psReclDesc VARCHAR2) IS
/*
         Tarea: Reporte de nmina de honorarios Excel
         Fecha: 01/06/2009.
         Autor: CCR

  Modificacion: 13/11/2009
                EAMM
                CAMBIAR LOS PARAMETROS DE PERIODO Y PARTE DE PERIODO POR MULTIOPCIONES

*/
vgsUSR       VARCHAR2(500);
ckCount      INTEGER;
ckNombres    owa_cookie.vc_arr;
ckValores    owa_cookie.vc_arr;
vgsInicoPag  VARCHAR2(10) := NULL;

 -- vnRow            INTEGER                          := 0;
  vnExists         INTEGER                          := 0;
  vnColumnas       INTEGER                          := 22;
  tabColumna       Pk_Sisrepimp.tipoTabla          := Pk_Sisrepimp.tipoTabla(1);

  vnTotalFd        NUMBER                           := 0;
  vnTotalFnd       NUMBER                           := 0;
  vnTotal          NUMBER                           := 0;
  vnPidm           NUMBER                           := NULL;

  vsUnive          VARCHAR2(6)                     := NULL;
  vsPerio          VARCHAR2(1000)                   := NULL;
  vsPerioE         VARCHAR2(10)                   := NULL;
  vsFacu           VARCHAR2(3)                    := NULL;
  vsCate           VARCHAR2(10)                    := NULL;
  vsSeccion        VARCHAR2(3)                      := NULL;
  vsPtrm           VARCHAR2(1000)                   := NULL;
  vsSede           VARCHAR2(10)                     := NULL;
  vsID             VARCHAR2(10)                     := NULL;
  vsCRN            VARCHAR2(10)                     := NULL;
  vsTermCode      VARCHAR2(6)                     := NULL;
  vsCampCode      VARCHAR2(6)                     := NULL;
  vsCollcode      VARCHAR2(6)                     := NULL;
  vsSinHeadrs VARCHAR2(1)            := NULL;



  CURSOR cuReporte(psUnive VARCHAR2 DEFAULT NULL,
                   psTerm  VARCHAR2 DEFAULT NULL,
                   psFacu  VARCHAR2 DEFAULT NULL,
                   psCate  VARCHAR2 DEFAULT NULL,
                   psPtrm  VARCHAR2 DEFAULT NULL,
                   psSede  VARCHAR2 DEFAULT NULL
                  ) IS

     SELECT DISTINCT SS.SSBSECT_TERM_CODE                                                                     termCode,
                SSBSECT_CAMP_CODE                                                                        campCode,
                DECODE(SSBOVRR_COLL_CODE,NULL,SCBCRSE_COLL_CODE,SSBOVRR_COLL_CODE)                       collCode,
                Pk_Catalogo.COLEGIO(DECODE(SSBOVRR_COLL_CODE,NULL,SCBCRSE_COLL_CODE,SSBOVRR_COLL_CODE))  descSede,
                SPRIDEN_PIDM                                                                             SPIDM,
                SPRIDEN_ID                                                                               ID,
                SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME                                               NOMBRE,
                SPBPERS_NAME_SUFFIX                                                                      SUFFIX,
                PROFESOR_SUM.PIDM                                                                            PIDM,
                REPLACE(REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME||' '||SPRIDEN_MI,'','&ntilde;'),'*',' ') DOCENTE,
                Pk_Catalogo.TIPO(PROFESOR_SUM.TIPO)                                                          TIPO_PROFESOR,
                PROFESOR_SUM.PERFIL                                                                          CVEPERFIL,
                Pk_Catalogo.CATEGORIA(PROFESOR_SUM.PERFIL)                                                   DESCPERFIL,
                SSBSECT_CRN                                                                              NRC,
                '('||SSBSECT_PTRM_CODE||') '||PROFESOR_SUM.P_PERIODO                                         PART_PERIODO,
                --PROFESOR.DIAS                                                                            DIAS,
              SSBSECT_SESS_CODE                                                                       SESION,
                --PROFESOR.HORARIO                                                                         HORARIO,
                PROFESOR_SUM.ASIGNACION                                                                      ASIGNACION,
                PROFESOR_SUM.SOBREPASO                                                                  SOBREPASO,
                SCBCRSE_TITLE                                                                            TITULO,
                SSBSECT_SEQ_NUMB                                                                         SECUENCIA,
                SCBCRSE_SUBJ_CODE                                  MATERIA,
                SCBCRSE_CRSE_NUMB                                  CURSO,
                --NVL(PROFESOR_SUM.SUMA_MODULO,0) * NVL(PROFESOR_SUM.PORCENTAJE,0)/100 MODULO,
                NVL(PROFESOR_SUM.SUMA_MODULO,0) MODULO,
                --NVL(PROFESOR.HORAS_SEM,0)                          HORAS_SEM,
                --PROFESOR.MODULO                                    MODULO,
                DECODE(SWRXLST_TYPE,'M','Master','S','Simultneo','Independiente') TIPO_CURSO,
                DECODE(SWRXLST_TYPE,'M',SSBXLST_ENRL,SSBSECT_ENRL) INSCRITOS,
                NVL(PROFESOR_SUM.PORCENTAJE,0)                         PORCENTAJE,
                --NVL(PROFESOR_SUM.PORCENTAJE,0)/100                    TOTAL,
                ROUND((NVL(PROFESOR_SUM.SUMA_MODULO,0) * NVL(PROFESOR_SUM.PORCENTAJE,0)/100),1) TOTAL
                --TOTAL
           FROM SSBSECT SS,
                SCBCRSE,
                (SELECT SIRASGN_PIDM                                                 PIDM,
                        SSRMEET_TERM_CODE                                            PERIODO,
                        SSRMEET_CRN                                                  CRN,
                        ROUND(SUM((SSRMEET_HRS_WEEK/1.33)),2)                        SUMA_MODULO,
                        SIRASGN_PERCENT_RESPONSE                                    PORCENTAJE,
                        SIRASGN_WORKLOAD_ADJUST                                      SOBREPASO,
                        SIRASGN_ASTY_CODE                                            ASIGNACION,
                        SSRMEET_CATAGORY                                             CATEGORIA,
                        SSRMEET_START_DATE||' - '||SSRMEET_END_DATE                  P_PERIODO,
                        INST_SUM.TIPO                                                    TIPO,
                        INST_SUM.PERFIL                                                  PERFIL
                        FROM SSRMEET,
                        SIRASGN,
                        (SELECT S2.SIBINST_PIDM         PIDM,
                                S2.SIBINST_FSTP_CODE    TIPO,
                                S2.SIBINST_FCTG_CODE    PERFIL
                           FROM SIBINST S2
                          WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(Z2.SIBINST_TERM_CODE_EFF)
                                                           FROM SIBINST Z2
                                                          WHERE Z2.SIBINST_PIDM            =  S2.SIBINST_PIDM
                                                            AND (Z2.SIBINST_TERM_CODE_EFF <= psTerm OR psTerm IS NULL)
                                                        )
                        ) INST_SUM
                  WHERE SIRASGN_PIDM            = INST_SUM.PIDM(+)
                    AND SSRMEET_TERM_CODE       = SIRASGN_TERM_CODE(+)
                    AND SSRMEET_CRN             = SIRASGN_CRN(+)
                    AND SSRMEET_CATAGORY        = SIRASGN_CATEGORY(+)
                    AND SIRASGN_PERCENT_RESPONSE > 0
                    AND INST_SUM.TIPO               = 'HON'
                    group by SIRASGN_PIDM, SSRMEET_TERM_CODE, SSRMEET_CRN, SIRASGN_PERCENT_RESPONSE, SIRASGN_WORKLOAD_ADJUST, SIRASGN_ASTY_CODE, SSRMEET_CATAGORY, SSRMEET_START_DATE||' - '||SSRMEET_END_DATE, INST_SUM.TIPO, INST_SUM.PERFIL)PROFESOR_SUM,
                SPRIDEN,
                SPBPERS,
                SWRXLST,
                SSRXLST,
                SSBXLST,
                SSBOVRR,
                (SELECT SIRDPCL_PIDM      dpclPidm,
                        SIRDPCL_COLL_CODE collCode,
                        SIRDPCL_DEPT_CODE deptSede
                   FROM SIRDPCL A
                  WHERE SIRDPCL_HOME_IND      = 'Y'
                    AND SIRDPCL_TERM_CODE_EFF = (SELECT MAX(SI.SIRDPCL_TERM_CODE_EFF)
                                                   FROM SIRDPCL SI
                                                  WHERE SI.SIRDPCL_PIDM           =  A.SIRDPCL_PIDM
                                                    AND (SI.SIRDPCL_TERM_CODE_EFF <= psTerm OR psTerm IS NULL)
                                                )
                ) SIRDPC
          WHERE SSBSECT_SUBJ_CODE     = SCBCRSE_SUBJ_CODE
            AND SSBSECT_CRSE_NUMB     = SCBCRSE_CRSE_NUMB
            AND SCBCRSE_EFF_TERM      = (SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                           FROM SCBCRSE SC
                                          WHERE SC.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                            AND SC.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                            AND SC.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB
                                        )
            AND SSBSECT_TERM_CODE     = PROFESOR_SUM.PERIODO
            AND SSBSECT_CRN           = PROFESOR_SUM.CRN
            AND PROFESOR_SUM.PIDM         = SPRIDEN_PIDM(+)
            --AND PROFESOR_SUM.PIDM     = SPRIDEN_PIDM
            AND SPRIDEN_PIDM          = SIRDPC.dpclPidm(+)
            AND SPRIDEN_CHANGE_IND IS NULL
            AND SPBPERS_PIDM          = SPRIDEN_PIDM
            AND SSBSECT_TERM_CODE     = SSRXLST_TERM_CODE(+)
            AND SSBSECT_CRN           = SSRXLST_CRN(+)
            AND SSRXLST_TERM_CODE     = SWRXLST_TERM_CODE(+)
            AND SSRXLST_CRN           = SWRXLST_CRN(+)
            AND SSRXLST_XLST_GROUP    = SWRXLST_XLST_GROUP(+)
            AND SSRXLST_TERM_CODE     = SSBXLST_TERM_CODE(+)
            AND SSRXLST_XLST_GROUP    = SSBXLST_XLST_GROUP(+)
            AND (SS.SSBSECT_CAMP_CODE = psUnive OR psUnive IS NULL)
            AND (SS.SSBSECT_TERM_CODE = psTerm  OR psTerm  IS NULL)
            AND (PROFESOR_SUM.PERFIL      = psCate  OR psCate  IS NULL)
            AND (SIRDPC.deptSede      = psSede  OR psSede  IS NULL)
            AND (INSTR('/' || psPtrm, '/' || SS.SSBSECT_PTRM_CODE || '/') > 0 OR psPtrm IS NULL)
        --   AND (SS.SSBSECT_PTRM_CODE  = psPtrm  OR psPtrm IS NULL)
            AND SSBSECT_TERM_CODE     = SSBOVRR_TERM_CODE(+)
            AND SSBSECT_CRN           = SSBOVRR_CRN(+)
            AND (DECODE(SSBOVRR_COLL_CODE,NULL,SCBCRSE_COLL_CODE,SSBOVRR_COLL_CODE) = psFacu OR psFacu IS NULL)
UNION
         SELECT DISTINCT
              '' TERM_CODE,
              'UFT' CAMP_CODE,
              SIRNIST_COLL_CODE                       ESCUELA,
              Pk_Catalogo.COLEGIO(SIRNIST_COLL_CODE)  descSede,
              A.SIBINST_PIDM PIDM,
                SPRIDEN_ID                                              ID,
                SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME              NOMBRE,
                f_get_rut(SIRNIST_PIDM)                                 RUT,
                SIRNIST_PIDM PIDM,
                REPLACE(REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME||' '||SPRIDEN_MI,'','&ntilde;'),'*',' ')  DOCENTE,
                         A.SIBINST_FSTP_CODE    TIPO,
           A.SIBINST_FCTG_CODE    PERFIL,
           Pk_Catalogo.CATEGORIA(A.SIBINST_FCTG_CODE    )                                                   DESCPERFIL,
              --Pk_Catalogo.FUNCION(SIRNIST_NIST_CODE)  DESCRIPCION,
               '' NRC,
                '' PART_PERIODO,
                '' SESION,
                '' ASIGNACION,
                0 SOBREPASO,
                Pk_Catalogo.FUNCION(SIRNIST_NIST_CODE) TITULO,
                '' SECUENCIA,
                 SIRNIST_NIST_CODE                        MATERIA,
                '' CURSO,
                NVL(SUM(SIRNIST_NIST_WORKLOAD),0)  MODULO,
                '' TIPO_CURSO,
                0 INSCRITOS,
                0 PORCENTAJE,
                NVL(SUM(SIRNIST_NIST_WORKLOAD),0)        TOTAL
           FROM SIRNIST A, SPRIDEN, SIBINST A
          WHERE SIRNIST_PIDM = SPRIDEN_PIDM
          AND A.SIBINST_PIDM = SIRNIST_PIDM
            AND (A.SIRNIST_TERM_CODE = psTerm  OR psTerm  IS NULL)
            and A.SIBINST_TERM_CODE_EFF = (SELECT MAX(Z8.SIBINST_TERM_CODE_EFF)
                                                           FROM SIBINST Z8
                                                          WHERE Z8.SIBINST_PIDM            =  A.SIBINST_PIDM
                                                            AND (Z8.SIBINST_TERM_CODE_EFF <= psTerm OR psTerm IS NULL))
            --AND SIRNIST_PIDM         = pnPidm
            AND A.SIBINST_FSTP_CODE = 'HON'
            and not exists (select 1 from sirasgn
                                    where sirasgn_pidm = sibinst_pidm)
            GROUP BY SIRNIST_COLL_CODE, A.SIBINST_PIDM, SPRIDEN_ID,SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME,f_get_rut(A.SIRNIST_PIDM),
                A.SIRNIST_PIDM, REPLACE(REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME||' '||SPRIDEN_MI,'','&ntilde;'),'*',' '),
                A.SIBINST_FSTP_CODE,A.SIBINST_FCTG_CODE,Pk_Catalogo.CATEGORIA(A.SIBINST_FCTG_CODE),
              Pk_Catalogo.FUNCION(A.SIRNIST_NIST_CODE),A.SIRNIST_NIST_CODE,
                A.SIRNIST_TOPS_CODE
          ORDER BY termCode DESC, campCode, collCode, DOCENTE,NRC;
  --Para obtener funciones de no docencia
  CURSOR cuDetalle(psTerm  VARCHAR2,
                   pnPidm  NUMBER) IS
         SELECT DISTINCT SIRNIST_NIST_CODE                       CLAVE,
                Pk_Catalogo.FUNCION(SIRNIST_NIST_CODE)  DESCRIPCION,
                SIRNIST_TOPS_CODE                       TOPS,
                NVL(SUM(SIRNIST_NIST_WORKLOAD),0)       HORAS,
                SPRIDEN_ID                                              ID,
                SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME              NOMBRE,
                f_get_rut(SIRNIST_PIDM)                                 RUT,
                SIRNIST_COLL_CODE                       ESCUELA
           FROM SIRNIST, SPRIDEN
          WHERE SIRNIST_PIDM = SPRIDEN_PIDM
            AND SIRNIST_TERM_CODE    = psTerm
            AND SIRNIST_PIDM         = pnPidm
            GROUP BY SIRNIST_NIST_CODE, Pk_Catalogo.FUNCION(SIRNIST_NIST_CODE),SIRNIST_TOPS_CODE,SPRIDEN_ID,SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME,f_get_rut(SIRNIST_PIDM),SIRNIST_COLL_CODE ;


            --SPRIDEN_ID,
            --f_get_rut(SIRNIST_PIDM),
            --SIRNIST_COLL_CODE,
            --S1.SIBINST_FCTG_CODE;

procedure detalleFaculty(pnPidm NUMBER,
                             psTerm VARCHAR2
                            ) is

  --Para obtener funciones de no docencia
  cursor cuDetalle(psTerm  varchar2,
                   pnPidm  number) is
         select sirnist_nist_code                       nistCode,
                pk_Catalogo.funcion(sirnist_nist_code)  nistDesc,
                sirnist_tops_code                       topsCode,
                nvl(sum(sirnist_nist_workload),0)       nistWork
           from sirnist
          where sirnist_term_code    = psTerm
            and sirnist_pidm         = pnPidm
          group by sirnist_nist_code,
                   pk_Catalogo.funcion(sirnist_nist_code),
                   sirnist_tops_code;


          begin
                    for regDet in cuDetalle(psTerm, pnPidm) loop
                 IF regDet.nistCode is not null then
                    htp.p('
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top" align="left" width="50%">'||regDet.nistDesc||'</td>
                      <td valign="top"></td>
                      <td valign="top"></td>
                      <td valign="top" align="left" width="10%">' ||regDet.nistWork||'</td>'
                         );


            END IF;
          end loop;

  end detalleFaculty;


  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
          FOR vnCOKIES IN 1..ckCount LOOP
              IF    ckNOMBRES(vnCOKIES) = 'psUnive' THEN
                    vsUnive := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psPeriM' THEN
                    vsPerio := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                    vsFacu := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psCate' THEN
                    vsCate := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                    vsSeccion := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psPtrm'    THEN
                    vsPtrm  := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psSede' THEN
                    vsSede    := ckValores(vnCOKIES);

              END IF;
          END LOOP;
      END IF;

vsPerioE:= substr(vsPerio,1,6);

      -- Las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := ' ';

      tabColumna(2)  := '<b>ID</b>';
      tabColumna(3)  := '<b>Nombre</b>';
      tabColumna(4)  := '<b>RUT</b>';
      tabColumna(5)  := '<b>NRC</b>';
      tabColumna(6)  := '<b>Parte del periodo</b>';
      tabColumna(7)  := '<b>Sesi&oacute;n</b>';
      tabColumna(8)  := '<b>Materia</b>';
      tabColumna(9)  := '<b>T&iacute;tulo de Curso</b>';
      tabColumna(10)  := '<b>Curso</b>';
      tabColumna(11)  := '<b>Escuela</b>';
      tabColumna(12)  := '<b>Secci&oacute;n</b>';
      tabColumna(13) := '<b>M&oacute;dulo</b>';
      tabColumna(14) := '<b>% de responsabilidad</b>';
      tabColumna(15) := '<b>Total M&oacute;dulo % de responsabilidad</b>';
      tabColumna(16) := '<b>Sobrepaso de Carga</b>';
      tabColumna(17) := '<b>Tipo de Asignaci&oacute;n</b>';
      tabColumna(18) := '<b>Categor&iacute;a</b>';
      tabColumna(19) := '<b>Tipo de curso</b>';
      tabColumna(20) := '<b>Inscritos</b>';



      Pk_Sisrepimp.vgsSaltoImp := 'SALTO';
                   Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,vgsInicoPag,'0', psSubtitulo=>'Periodo '||vsPerioE,psUsuario=>vgsUSR, psSeccion=>vsSeccion, psSinPiePag=>'P',psSinLogo=>'P',psTituloSinFr=>'P',psSinHeaders=>vsSinHeadrs);

    IF vsPtrm IS NOT NULL THEN
    vsPtrm:= vsPtrm;
    end if;
    if vsPtrm = '/' then
    vsPtrm:= NULL;
    END IF;

      WHILE (INSTR(vsPerio, '/') > 0 ) LOOP



          FOR regRep IN cuReporte(vsUnive, SUBSTR(vsPerio, 0, INSTR(vsPerio,'/')-1), vsFacu, vsCate,vsPtrm, vsSede) LOOP


  --              IF vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
--                   vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR
  --                 vsCollcode IS NULL OR vsCollcode <> regRep.collCode OR
    --               vsID       IS NULL OR regRep.ID  <> vsID
      --             THEN

        --           IF vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
          --            vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR
            --          vsCollcode IS NULL OR vsCollcode <> regRep.collCode
              --        THEN
                --      vsSinHeadrs := NULL;
                  -- END IF;



                   --vgsInicoPag := 'SALTO';
                  -- vsSinHeadrs := 'H';
                --END IF;

                htp.p(
                '<tr>
                 <td></td>

                 <td valign="top">'||regRep.ID         ||'</td>
                 <td valign="top">'||regRep.NOMBRE         ||'</td>
                 <td valign="top">'||regRep.SUFFIX         ||'</td>
                 <td valign="top">'||regRep.NRC         ||'</td>
                 <td valign="top">'||regRep.Part_periodo||'</td>
                 <td valign="top">'||regRep.Sesion      ||'</td>
                 <td valign="top">'||regRep.Materia     ||'</td>
                 <td valign="top">'||regRep.TITULO    ||'</td>
                 <td valign="top">'||regRep.Curso       ||'</td>
                 <td valign="top">'||regRep.collCode    ||'</td>
                 <td valign="top">'||regRep.SECUENCIA    ||'</td>
                 <td valign="top">'||regRep.MODULO   ||'</td>
                 <td valign="top">'||regRep.Porcentaje  ||'</td>
                 <td valign="top">'||regRep.Total       ||'</td>
                 <td valign="top">'||regRep.SOBREPASO  ||'</td>
                 <td valign="top">'||regRep.ASIGNACION  ||'</td>
                 <td valign="top">'||regRep.CVEPERFIL  ||'</td>
                 <td valign="top">'||regRep.Tipo_curso  ||'</td>
                 <td valign="top">'||regRep.Inscritos   ||'</td> </tr>');


                if vsID       IS NULL OR regRep.ID  <> vsID AND regRep.NRC  <> vsCrn THEN

                    for regDet in cuDetalle(regRep.termCode, regRep.Spidm) loop
                 IF regDet.CLAVE is not null then
          htp.p('
          <td valign="top"></td>
          <td valign="top" align="left" width="50%">'||regDet.ID||'</td>
          <td valign="top" align="left" width="50%">'||regDet.NOMBRE||'</td>
          <td valign="top" align="left" width="50%">'||regDet.RUT||'</td>
          <td valign="top"></td>
          <td valign="top"></td>
          <td valign="top">'||regRep.Sesion      ||'</td>
          <td valign="top" align="left" width="50%">'||regDet.CLAVE||'</td>
          <td valign="top" align="left" width="50%">'||regDet.DESCRIPCION||'</td>
          <td valign="top"></td>
          <td valign="top" align="left" width="50%">'||regDet.ESCUELA||'</td>
          <td valign="top"></td>
          <td valign="top" align="left" width="10%">' ||regDet.horas||'</td>
          <td valign="top"></td>
          <td valign="top" align="left" width="10%">' ||regDet.horas||'</td>
          <td valign="top"></td>
          <td valign="top"></td>
          <td valign="top">'||regRep.CVEPERFIL  ||'</td></tr>');

          END IF;
          end loop;
          end if;

                vnPidm     := regRep.Pidm;
                vsID       := regRep.ID;
                vsCRN      := regRep.NRC;
                vsCampCode := regRep.campCode;
                vsTermCode := regRep.termCode;
                vsCollcode := regRep.collCode;
                vnTotalFd  := vnTotalFd + regRep.TOTAL;
                vnExists   := 1;

            END LOOP;

            vsPerio := SUBSTR(vsPerio, INSTR(vsPerio,'/')+1 );
      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');

         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>vgsUSR, psSeccion=>vsSeccion,psSinPiePag=>'P',psSinLogo=>'P');
      END IF;

      htp.p('</table><br/><br/></body></html>');

    EXCEPTION
        WHEN OTHERS THEN htp.p( SQLERRM);

    END PWRNHOU;
/


DROP PUBLIC SYNONYM PWRNHOU;

CREATE PUBLIC SYNONYM PWRNHOU FOR BANINST1.PWRNHOU;


GRANT EXECUTE ON BANINST1.PWRNHOU TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRNHOU TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRNOMH;

CREATE OR REPLACE PROCEDURE BANINST1.PWRNOMH ( psReclDesc  VARCHAR2 ) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de nmina de honorarios.
     propsito: obtener y presentar informacin de la nmina de profesores
                contratados por honorarios.
        mdulo: programacin acadmica - uft.
         autor: hmr - horacio martnez ramrez.
         fecha: 25/08/2011.  (versin 3).

  modificacin: 08/11/2011 - hmr.
                se ajustaron los clculos para obtener los totales de cada
                docente.
*******************************************************************************/

  vgsUSR             VARCHAR2(500);
  ckCount            INTEGER;
  ckNombres          owa_cookie.vc_arr;
  ckValores          owa_cookie.vc_arr;
  vgsInicoPag        VARCHAR2(10)           := NULL;

  vnExists           INTEGER                := 0;
  vnColumnas         INTEGER                := 23;
  tabColumna         Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);

  vsPTotalX          VARCHAR2(15)           := NULL;
  vnTotalFd          NUMBER                 := 0;
  vnTotalFnd         NUMBER                 := 0;
  vnModulos          NUMBER                 := 0;
  vnTotal            NUMBER                 := 0;
  vnPidm             NUMBER                 := NULL;
  vnptotal           NUMBER                 := NULL;
  vnPTotalS          NUMBER                 := NULL;
  vnPTotalM          NUMBER                 := NULL;
  vnCuentaSobrepaso  NUMBER                 := NULL;
  vnCuentaModulos    NUMBER                 := NULL;
  vnContador         NUMBER                 := 0;
--vniva              number                 := null;   -- cancelada (hmr)
--vntotaliva         number                 := null;   -- cancelada (hmr)
  vsCategoria        VARCHAR2(6)            := NULL;
  vsUnive            VARCHAR2(6)            := NULL;
  vsPerio            VARCHAR2(1000)         := NULL;
  vsFacu             VARCHAR2(3)            := NULL;
  vsCate             VARCHAR2(10)           := NULL;
  vsSeccion          VARCHAR2(3)            := NULL;
  vsPtrm             VARCHAR2(1000)         := NULL;
  vsSede             VARCHAR2(10)           := NULL;
  vsID               VARCHAR2(10)           := NULL;
  vsTermCode         VARCHAR2(6)            := NULL;
  vsCampCode         VARCHAR2(6)            := NULL;
  vsCollcode         VARCHAR2(6)            := NULL;
  vnPTabulador       NUMBER                 := 0;
  vnSobrepaso        NUMBER                 := 0;
  vsSinHeadrs        VARCHAR2(1)            := NULL;
  vsPonerLinea       VARCHAR2(1)            := 'N';

  -- nuevas variables:  (hmr)
  vnSumTarifaModulo  NUMBER                 := 0;   -- suma los importes de "tarifa mdulo" por docente
  vnTotBrutoP        NUMBER                 := 0;   -- contiene el "total bruto a pagar"
  vnRetIva           NUMBER                 := 0;   -- contiene el "10% de retencin de impuesto" (iva)
  vnTotLiquidoP      NUMBER                 := 0;   -- contiene el "total lquido a pagar"


  -- cursor principal:   (hmr)
  CURSOR cuReporte ( psUnive  VARCHAR2  DEFAULT NULL,
                     psTerm   VARCHAR2  DEFAULT NULL,
                     psFacu   VARCHAR2  DEFAULT NULL,
                     psCate   VARCHAR2  DEFAULT NULL,
                     psPtrm   VARCHAR2  DEFAULT NULL,
                     psSede   VARCHAR2  DEFAULT NULL ) IS

         SELECT DISTINCT SS.SSBSECT_TERM_CODE                                                            TERMCODE,
                SSBSECT_CAMP_CODE                                                                        CAMPCODE,
                DECODE(SSBOVRR_COLL_CODE,NULL,SCBCRSE_COLL_CODE,SSBOVRR_COLL_CODE)                       COLLCODE,
                Pk_Catalogo.COLEGIO(DECODE(SSBOVRR_COLL_CODE,NULL,SCBCRSE_COLL_CODE,SSBOVRR_COLL_CODE))  DESCSEDE,
                SPRIDEN_ID                                                                               ID,
                SPBPERS_NAME_SUFFIX                                                                      SUFFIX,
                PROFESOR.PIDM                                                                            PIDM,
                REPLACE(REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME||' '||
                                SPRIDEN_MI,'','&ntilde;'),'*',' ')                                      DOCENTE,
                Pk_Catalogo.TIPO(PROFESOR.TIPO)                                                          TIPO_PROFESOR,
                PROFESOR.PERFIL                                                                          CVEPERFIL,
                Pk_Catalogo.CATEGORIA(PROFESOR.PERFIL)                                                   DESCPERFIL,
                PROFESOR.SOBREPASO                                                                       SOBREPASO,   -- encabezado: "sobrepaso carga"
                (SELECT X1.SWBCDCT_TABULATOR FROM SWBCDCT X1
                  WHERE X1.SWBCDCT_TERM_CODE_EFF = (SELECT MAX(X2.SWBCDCT_TERM_CODE_EFF)
                                                      FROM SWBCDCT X2
                                                     WHERE X1.SWBCDCT_FCTG_CODE = X2.SWBCDCT_FCTG_CODE
                                                       AND X1.SWBCDCT_LEVL_CODE = SWBCDCT_LEVL_CODE)
                    AND X1.SWBCDCT_FCTG_CODE = PROFESOR.PERFIL
                    AND X1.SWBCDCT_LEVL_CODE = 'LC')                                                     TARIFA,      -- encabezado: "valor modulo"
   (SELECT X1.SWBCDCT_TABULATOR FROM SWBCDCT X1
                  WHERE X1.SWBCDCT_TERM_CODE_EFF = (SELECT MAX(X2.SWBCDCT_TERM_CODE_EFF)
                                                      FROM SWBCDCT X2
                                                     WHERE X1.SWBCDCT_FCTG_CODE = X2.SWBCDCT_FCTG_CODE
                                                       AND X1.SWBCDCT_LEVL_CODE = SWBCDCT_LEVL_CODE)
                    AND X1. SWBCDCT_ASTY_CODE IS NOT NULL
                    AND X1.SWBCDCT_LEVL_CODE = 'LC')                         TARIFA_MODULO_SOBREPASO,  -- tarifa tipo asignacion

                (SELECT X1.SWBCDCT_TABULATOR FROM SWBCDCT X1
                  WHERE X1.SWBCDCT_TERM_CODE_EFF = (SELECT MAX(X2.SWBCDCT_TERM_CODE_EFF)
                                                      FROM SWBCDCT X2
                                                     WHERE X1.SWBCDCT_FCTG_CODE = X2.SWBCDCT_FCTG_CODE
                                                       AND X1.SWBCDCT_LEVL_CODE = SWBCDCT_LEVL_CODE)
                    AND X1.SWBCDCT_FCTG_CODE = PROFESOR.PERFIL
                    AND X1.SWBCDCT_LEVL_CODE = 'LC') * (NVL(PROFESOR.MODULO,0) *
                                                        NVL(PROFESOR.PORCENTAJE,0)/100)                  TAF_TOTAL,   -- encabezado: "tarifa modulo"    --mac
                          (SELECT X1.SWBCDCT_TABULATOR FROM SWBCDCT X1
                  WHERE X1.SWBCDCT_TERM_CODE_EFF = (SELECT MAX(X2.SWBCDCT_TERM_CODE_EFF)
                                                      FROM SWBCDCT X2
                                                     WHERE X1.SWBCDCT_FCTG_CODE = X2.SWBCDCT_FCTG_CODE
                                                       AND X1.SWBCDCT_LEVL_CODE = SWBCDCT_LEVL_CODE)
                    AND X1.SWBCDCT_FCTG_CODE = PROFESOR.PERFIL
                    and x1.swbcdct_asty_code is not null
                    AND X1.SWBCDCT_LEVL_CODE = 'LC') * (NVL(PROFESOR.MODULO,0) *
                                                        NVL(PROFESOR.PORCENTAJE,0)/100)                  TAF_TOTAL_ASIGNACION,   -- encabezado: "tarifa modulo"    --mac

                (SELECT X1.SWBCDCT_TABULATOR FROM SWBCDCT X1
                  WHERE X1.SWBCDCT_TERM_CODE_EFF = (SELECT MAX(X2.SWBCDCT_TERM_CODE_EFF)
                                                      FROM SWBCDCT X2
                                                     WHERE X1.SWBCDCT_FCTG_CODE = X2.SWBCDCT_FCTG_CODE
                                                       AND X1.SWBCDCT_LEVL_CODE = SWBCDCT_LEVL_CODE)
                    AND X1.SWBCDCT_FCTG_CODE = PROFESOR.PERFIL
                    AND X1.SWBCDCT_LEVL_CODE = 'LC') * (NVL(PROFESOR.SOBREPASO,0) *
                                                        NVL(PROFESOR.PORCENTAJE,0)/100)                  TOTAL_ASIG,   --mac

                       (SELECT X1.SWBCDCT_TABULATOR FROM SWBCDCT X1
                  WHERE X1.SWBCDCT_TERM_CODE_EFF = (SELECT MAX(X2.SWBCDCT_TERM_CODE_EFF)
                                                      FROM SWBCDCT X2
                                                     WHERE X1.SWBCDCT_FCTG_CODE = X2.SWBCDCT_FCTG_CODE
                                                       AND X1.SWBCDCT_LEVL_CODE = SWBCDCT_LEVL_CODE)
                    AND X1.SWBCDCT_ASTY_CODE IS NOT NULL
                    AND X1.SWBCDCT_LEVL_CODE = 'LC') * (NVL(PROFESOR.SOBREPASO,0) *
                                                        NVL(PROFESOR.PORCENTAJE,0)/100)                  TOTAL_ASIG_SOBREPASO,   --mac
                SSBSECT_CRN                                                                              NRC,
                '('||SSBSECT_PTRM_CODE||') '||PROFESOR.P_PERIODO                                         PART_PERIODO,
                SSBSECT_SESS_CODE                                                                        SESION,
                PROFESOR.ASIGNACION                                                                      ASIGNACION,
                SCBCRSE_TITLE                                                                            TITULO,
                SSBSECT_SEQ_NUMB                                                                         SECUENCIA,
                SCBCRSE_SUBJ_CODE                                                                        MATERIA,
                SCBCRSE_CRSE_NUMB                                                                        CURSO,
                NVL(PROFESOR.HORAS_SEM,0)                                                                HORAS_SEM,
                PROFESOR.MODULO                                                                          MODULO,
                DECODE(SWRXLST_TYPE,'M','Master','S','Simultneo','Independiente')                       TIPO_CURSO,
                DECODE(SWRXLST_TYPE,'M',SSBXLST_ENRL,SSBSECT_ENRL)                                       INSCRITOS,
                NVL(PROFESOR.PORCENTAJE,0)                                                               PORCENTAJE,
                PROFESOR.CATEGORIA                                                                       IND_SESION,
                PROFESOR_MODULO.TOTAL_MODULO                                                             TOTAL_MODULO,
                NVL(PROFESOR.MODULO,0) * NVL(PROFESOR.PORCENTAJE,0)/100                                  TOTAL,
                PROFESOR.INICIO INICIO,
                PROFESOR.FIN FIN
           FROM SSBSECT SS,
                SCBCRSE,
                (SELECT SIRASGN_PIDM                                                 PIDM,
                        SIRASGN_ASTY_CODE                                            ASIGNACION,
                        SSRMEET_TERM_CODE                                            PERIODO,
                        SSRMEET_CRN                                                  CRN,
                        SSRMEET_CATAGORY                                             CATEGORIA,
                        SSRMEET_HRS_WEEK                                             HORAS_SEM,
                        ROUND((SSRMEET_HRS_WEEK/1.33),2)                             MODULO,
                        SIRASGN_WORKLOAD_ADJUST                                      SOBREPASO,
                        DECODE(SSRMEET_MON_DAY, 'M', 'Lu', SSRMEET_MON_DAY)||'-'||
                        DECODE(SSRMEET_TUE_DAY, 'T', 'Ma', SSRMEET_TUE_DAY)||'-'||
                        DECODE(SSRMEET_WED_DAY, 'W', 'Mi', SSRMEET_WED_DAY)||'-'||
                        DECODE(SSRMEET_THU_DAY, 'R', 'Ju', SSRMEET_THU_DAY)||'-'||
                        DECODE(SSRMEET_FRI_DAY, 'F', 'Vi', SSRMEET_FRI_DAY)||'-'||
                        DECODE(SSRMEET_SAT_DAY, 'S', 'Sa', SSRMEET_SAT_DAY)          DIAS,
                        SUBSTR(SSRMEET_BEGIN_TIME,1,2)||':'||
                        NVL(SUBSTR(SSRMEET_BEGIN_TIME,3,2),'00')||' '||
                            SUBSTR(SSRMEET_END_TIME,1,2)||':'||
                        NVL(SUBSTR(SSRMEET_END_TIME,3,2),'00')                       HORARIO,
                        SSRMEET_START_DATE  INICIO,
                        SSRMEET_END_DATE FIN,
                        SSRMEET_START_DATE||' - '||SSRMEET_END_DATE                  P_PERIODO,
                        INST.TIPO                                                    TIPO,
                        INST.PERFIL                                                  PERFIL,
                        SIRASGN_PERCENT_RESPONSE                                     PORCENTAJE
                   FROM SSRMEET,
                        SIRASGN,
                        (SELECT SI.SIBINST_PIDM         PIDM,
                                SI.SIBINST_FSTP_CODE    TIPO,
                                SI.SIBINST_FCTG_CODE    PERFIL
                           FROM SIBINST SI
                          WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(ZI.SIBINST_TERM_CODE_EFF)
                                                           FROM SIBINST ZI
                                                          WHERE ZI.SIBINST_PIDM            = SI.SIBINST_PIDM
                                                            AND (ZI.SIBINST_TERM_CODE_EFF <= psTerm OR psTerm IS NULL) )
                        )  INST
                  WHERE SIRASGN_PIDM             = INST.PIDM(+)
                    AND SSRMEET_TERM_CODE        = SIRASGN_TERM_CODE(+)
                    AND SSRMEET_CRN              = SIRASGN_CRN(+)
                    AND SSRMEET_CATAGORY         = SIRASGN_CATEGORY(+)
                    AND SIRASGN_PERCENT_RESPONSE > 0
                    AND TO_DATE(SYSDATE,'DD/MM/YYYY') BETWEEN TO_DATE(SSRMEET_START_DATE,'DD/MM/YYYY') AND TO_DATE(SSRMEET_END_DATE,'DD/MM/YYYY')
                    AND INST.TIPO                = 'HON')                            PROFESOR,
                (SELECT SIRASGN_PIDM                                       PIDM_MODULO,
                        SSRMEET_TERM_CODE                                  PERIODO_MODULO,
                        SSRMEET_CRN                                        CRN_MODULO,
                        ROUND(SUM(SSRMEET_HRS_WEEK/1.33),2)                TOTAL_MODULO
                   FROM SSRMEET,
                        SIRASGN,
                        (SELECT SI.SIBINST_PIDM            PIDM,
                                SI.SIBINST_FSTP_CODE       TIPO,
                                SI.SIBINST_FCTG_CODE       PERFIL
                           FROM SIBINST SI
                          WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(ZI.SIBINST_TERM_CODE_EFF)
                                                           FROM SIBINST ZI
                                                          WHERE ZI.SIBINST_PIDM            = SI.SIBINST_PIDM
                                                            AND (ZI.SIBINST_TERM_CODE_EFF <= psTerm OR psTerm IS NULL) )
                        )  INST
                  WHERE SIRASGN_PIDM             = INST.PIDM(+)
                    AND SSRMEET_TERM_CODE        = SIRASGN_TERM_CODE(+)
                    AND SSRMEET_CRN              = SIRASGN_CRN(+)
                    AND SSRMEET_CATAGORY         = SIRASGN_CATEGORY(+)
                    AND SIRASGN_PERCENT_RESPONSE > 0
                    AND TO_DATE(SYSDATE,'DD/MM/YYYY') BETWEEN TO_DATE(SSRMEET_START_DATE,'DD/MM/YYYY') AND TO_DATE(SSRMEET_END_DATE,'DD/MM/YYYY')
                    AND INST.TIPO                = 'HON'
                    GROUP BY SIRASGN_PIDM, SSRMEET_TERM_CODE, SSRMEET_CRN)           PROFESOR_MODULO,
                SPRIDEN,
                SPBPERS,
                SWRXLST,
                SSRXLST,
                SSBXLST,
                SSBOVRR,
                (SELECT SIRDPCL_PIDM            dpclPidm,
                        SIRDPCL_COLL_CODE       collCode,
                        SIRDPCL_DEPT_CODE       deptSede
                   FROM SIRDPCL A
                  WHERE SIRDPCL_HOME_IND      = 'Y'
                    AND SIRDPCL_TERM_CODE_EFF = (SELECT MAX(SI.SIRDPCL_TERM_CODE_EFF)
                                                   FROM SIRDPCL SI
                                                  WHERE SI.SIRDPCL_PIDM            = A.SIRDPCL_PIDM
                                                    AND (SI.SIRDPCL_TERM_CODE_EFF <= psTerm OR psTerm IS NULL) )
                 ) SIRDPC
          WHERE SSBSECT_SUBJ_CODE     = SCBCRSE_SUBJ_CODE
            AND SSBSECT_CRSE_NUMB     = SCBCRSE_CRSE_NUMB
            AND SCBCRSE_EFF_TERM      = (SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                           FROM SCBCRSE SC
                                          WHERE SC.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                            AND SC.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                            AND SC.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB)
            AND SSBSECT_TERM_CODE     = PROFESOR.PERIODO
            AND SSBSECT_CRN           = PROFESOR.CRN
            AND PROFESOR.PIDM         = PROFESOR_MODULO.PIDM_MODULO
            AND PROFESOR.CRN          = PROFESOR_MODULO.CRN_MODULO
            AND PROFESOR.PERIODO      = PROFESOR_MODULO.PERIODO_MODULO
            AND PROFESOR.PIDM         = SPRIDEN_PIDM(+)
            AND SPRIDEN_PIDM          = SIRDPC.dpclPidm(+)
            AND SPRIDEN_CHANGE_IND   IS NULL
            AND SPBPERS_PIDM          = SPRIDEN_PIDM
            AND SSBSECT_TERM_CODE     = SSRXLST_TERM_CODE(+)
            AND SSBSECT_CRN           = SSRXLST_CRN(+)
            AND SSRXLST_TERM_CODE     = SWRXLST_TERM_CODE(+)
            AND SSRXLST_CRN           = SWRXLST_CRN(+)
            AND SSRXLST_XLST_GROUP    = SWRXLST_XLST_GROUP(+)
            AND SSRXLST_TERM_CODE     = SSBXLST_TERM_CODE(+)
            AND SSRXLST_XLST_GROUP    = SSBXLST_XLST_GROUP(+)
            AND (SS.SSBSECT_CAMP_CODE = psUnive OR psUnive IS NULL)
            AND (SS.SSBSECT_TERM_CODE = psTerm  OR psTerm  IS NULL)
            AND (PROFESOR.PERFIL      = psCate  OR psCate  IS NULL)
            AND (SIRDPC.deptSede      = psSede  OR psSede  IS NULL)
            AND (INSTR('/' || psPtrm, '/' || SS.SSBSECT_PTRM_CODE || '/') > 0 OR psPtrm IS NULL)
            AND SSBSECT_TERM_CODE     = SSBOVRR_TERM_CODE(+)
            AND SSBSECT_CRN           = SSBOVRR_CRN(+)
            AND (DECODE(SSBOVRR_COLL_CODE,NULL,SCBCRSE_COLL_CODE,SSBOVRR_COLL_CODE) = psFacu OR psFacu IS NULL)
          ORDER BY TERMCODE DESC, CAMPCODE, COLLCODE, DOCENTE, NRC;


  -- obtiene funciones de no docencia:
  CURSOR cuDetalle ( psTerm  VARCHAR2,
                     pnPidm  NUMBER ) IS

         SELECT SIRNIST_NIST_CODE                         CLAVE,
                Pk_Catalogo.FUNCION(SIRNIST_NIST_CODE)    DESCRIPCION,
                SIRNIST_TOPS_CODE                         TOPS,
                NVL(SUM(SIRNIST_NIST_WORKLOAD),0)         HORAS
           FROM SIRNIST
          WHERE SIRNIST_TERM_CODE = psTerm
            AND SIRNIST_PIDM      = pnPidm
          GROUP BY SIRNIST_NIST_CODE, Pk_Catalogo.FUNCION(SIRNIST_NIST_CODE), SIRNIST_TOPS_CODE;


  -- nuevo cursor:  (hmr)
  CURSOR cuAdicional ( psTerm  VARCHAR2,
                       pnPidm  NUMBER ) IS

         SELECT DISTINCT SIRNIST_TERM_CODE                                                               TERMCODE,
                SIRNIST_PIDM                                                                             PIDM,
                SPRIDEN_ID                                                                               ID,
                SIRNIST_NIST_CODE                                                                        CLAVE,
                UPPER(Pk_Catalogo.FUNCION(SIRNIST_NIST_CODE))                                            DESCRIPCION,
                SIRNIST_COLL_CODE                                                                        ESCUELA,
                SIRNIST_NIST_WORKLOAD                                                                    HORAS_MODULO,
                '100'                                                                                    RESPONSABILIDAD,
                SIRNIST_NIST_WORKLOAD                                                                    TOTAL_MODULO,
                SI.SIBINST_FCTG_CODE                                                                     CATEGORIA,
                (SELECT X1.SWBCDCT_TABULATOR FROM SWBCDCT X1
                  WHERE X1.SWBCDCT_TERM_CODE_EFF = (SELECT MAX(X2.SWBCDCT_TERM_CODE_EFF)
                                                      FROM SWBCDCT X2
                                                     WHERE X1.SWBCDCT_FCTG_CODE = X2.SWBCDCT_FCTG_CODE
                                                       AND X1.SWBCDCT_LEVL_CODE = SWBCDCT_LEVL_CODE)
                    AND X1.SWBCDCT_FCTG_CODE = SI.SIBINST_FCTG_CODE
                    AND X1.SWBCDCT_LEVL_CODE = 'LC')                                                     VALOR_MODULO,   -- encabezado: "valor modulo"
                (SELECT X1.SWBCDCT_TABULATOR FROM SWBCDCT X1
                  WHERE X1.SWBCDCT_TERM_CODE_EFF = (SELECT MAX(X2.SWBCDCT_TERM_CODE_EFF)
                                                      FROM SWBCDCT X2
                                                     WHERE X1.SWBCDCT_FCTG_CODE = X2.SWBCDCT_FCTG_CODE
                                                       AND X1.SWBCDCT_LEVL_CODE = SWBCDCT_LEVL_CODE)
                    AND X1.SWBCDCT_FCTG_CODE = SI.SIBINST_FCTG_CODE
                    AND X1.SWBCDCT_LEVL_CODE = 'LC') * SIRNIST_NIST_WORKLOAD                             TARIFA_MODULO,   -- encabezado: "tarifa modulo"
                      (SELECT X1.SWBCDCT_TABULATOR FROM SWBCDCT X1
                  WHERE X1.SWBCDCT_TERM_CODE_EFF = (SELECT MAX(X2.SWBCDCT_TERM_CODE_EFF)
                                                      FROM SWBCDCT X2
                                                     WHERE X1.SWBCDCT_FCTG_CODE = X2.SWBCDCT_FCTG_CODE
                                                       AND X1.SWBCDCT_LEVL_CODE = SWBCDCT_LEVL_CODE)
                    AND X1. SWBCDCT_ASTY_CODE IS NOT NULL
                    AND X1.SWBCDCT_LEVL_CODE = 'LC') * SIRNIST_NIST_WORKLOAD                             TARIFA_MODULO_SOBREPASO  -- tarifa tipo asignacion

           FROM SIRNIST,
                SIBINST SI,
                SPBPERS,
                SPRIDEN
          WHERE SIRNIST_PIDM          = SI.SIBINST_PIDM
            AND SIRNIST_PIDM          = SPRIDEN_PIDM
            AND SPRIDEN_CHANGE_IND   IS NULL
            AND SIRNIST_PIDM          = SPBPERS_PIDM
            AND SIRNIST_PIDM          = pnPidm
            AND (SIRNIST_TERM_CODE    = psTerm OR psTerm IS NULL)
            AND SIBINST_TERM_CODE_EFF = (SELECT MAX(ZI.SIBINST_TERM_CODE_EFF)
                                           FROM SIBINST ZI
                                          WHERE ZI.SIBINST_PIDM            = SI.SIBINST_PIDM
                                            AND (ZI.SIBINST_TERM_CODE_EFF <= psTerm OR psTerm IS NULL));


  -- establece las columnas para los totales por alumno:
  function detalle ( psId   varchar2,
                     psName varchar2,
                     psRut  varchar2,
                     psSede varchar2 ) return varchar2 is

    vsEscuelaSede  VARCHAR2(300) := '<tr><th colspan='||vncolumnas||'><FONT SIZE="2"> Escuela: &nbsp;'||psSede||'<br><br></FONT></th></tr>';

  begin
     if vsSinHeadrs is not null then
        vsEscuelaSede := null;
     end if;

     return vsEscuelaSede||'<tr>'||'<td width="16%"><b>'               ||psid  ||' &nbsp; '||'</b></td>'
                                 ||'<td width="22%" colspan=4><b>'     ||psname||' &nbsp; '||'</b></td>'
                                 ||'<td width="6%"  align="center"><b>'||psrut ||'</b></td>'
                                 ||'<td width="70%" colspan='          ||(vncolumnas-1)||'></td>'
                                 ||'<tr><td>&nbsp;</td></tr>'
                         ||'</tr><br>';
  end detalle;


  -- genera los totales para cada alumno:
  procedure GeneraTotales ( pnPidm  NUMBER,
                            psTerm  VARCHAR2 ) is

    -- obtiene funciones de no docencia:
    cursor cuDetalle ( psTerm  varchar2,
                       pnPidm  number ) is

           select sirnist_nist_code                       nistCode,
                  pk_Catalogo.funcion(sirnist_nist_code)  nistDesc,
                  sirnist_tops_code                       topsCode,
                  nvl(sum(sirnist_nist_workload),0)       nistWork
             from sirnist
            where sirnist_term_code = psTerm
              and sirnist_pidm      = pnPidm
            group by sirnist_nist_code,
                     sirnist_nist_code,
                     sirnist_tops_code;

  begin

     htp.p('<tr><td>
                <table border="0" width="100%" cellpadding="0 cellspacing="0">
                <tr><th align="left" colspan="3">Horas docencia:</th>
                    <th align="right">'||vnTotalFd||'</th>
                </tr>');

     for regDet in cuDetalle(psTerm, pnPidm) loop
         vnTotalFnd := vnTotalFnd + regDet.nistWork;

         /* bloqueado - hmr (29-sep-2011):
         -- cambio (hmr) : primero-20%, tercero-20%, cuarto-10%
         htp.p('<tr><td valign="top" align="left" width="15%">'||regdet.nistcode||'</td>
                    <td valign="top" align="left" width="50%">'||regdet.nistdesc||'</td>
                    <td valign="top" align="left" width="10%">'||regdet.topscode||'</td>
                    <td valign="top" align="left" width="15%">'||regdet.nistwork||'</td>
               </tr>');
         */

     end loop;

     vnTotal := vnTotalFd + vnTotalFnd;

     BEGIN
        SELECT count(distinct(ssrmeet_crn))
          INTO vnModulos
          FROM SSRMEET,
               SIRASGN,
               (SELECT SI.SIBINST_PIDM         PIDM,
                       SI.SIBINST_FSTP_CODE    TIPO,
                       SI.SIBINST_FCTG_CODE    PERFIL
                  FROM SIBINST SI
                 WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(ZI.SIBINST_TERM_CODE_EFF)
                                                  FROM SIBINST ZI
                                                 WHERE ZI.SIBINST_PIDM            = SI.SIBINST_PIDM
                                                   AND (ZI.SIBINST_TERM_CODE_EFF <= psTerm OR psTerm IS NULL) )
               )  INST
         WHERE SIRASGN_PIDM             = INST.PIDM(+)
           AND TO_DATE(SYSDATE,'DD/MM/YYYY') BETWEEN TO_DATE(SSRMEET_START_DATE,'DD/MM/YYYY')
                                                 AND TO_DATE(SSRMEET_END_DATE,'DD/MM/YYYY')
           AND SSRMEET_TERM_CODE        = SIRASGN_TERM_CODE(+)
           AND SSRMEET_CRN              = SIRASGN_CRN(+)
           AND SSRMEET_CATAGORY         = SIRASGN_CATEGORY(+)
           AND SIRASGN_TERM_CODE        = psTerm
           AND SIRASGN_PERCENT_RESPONSE > 0
           AND INST.PIDM                = pnPidm
           AND INST.TIPO                = 'HON';
     END;

     BEGIN
        SELECT NVL(SUM(ROUND((SIRASGN_WORKLOAD_ADJUST),2)),0)
          INTO vnSobrepaso                                     -- encabezado de:  "sobrepaso carga"   (hmr)
          FROM SIRASGN,
               (SELECT SI.SIBINST_PIDM         PIDM,
                       SI.SIBINST_FSTP_CODE    TIPO,
                       SI.SIBINST_FCTG_CODE    PERFIL
                  FROM SIBINST SI
                 WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(ZI.SIBINST_TERM_CODE_EFF)
                                                  FROM SIBINST ZI
                                                 WHERE ZI.SIBINST_PIDM            = SI.SIBINST_PIDM
                                                   AND (ZI.SIBINST_TERM_CODE_EFF <= psTerm OR psTerm IS NULL) )
                )                               INST
                  WHERE SIRASGN_PIDM             = INST.PIDM(+)
                    and SIRASGN_TERM_CODE        = psTerm
                    AND SIRASGN_PERCENT_RESPONSE > 0
                    AND INST.PIDM                = pnPidm
                    AND INST.TIPO                = 'HON';
     END;

     BEGIN
        SELECT COUNT(ROUND((SIRASGN_WORKLOAD_ADJUST),2))
          INTO vnCuentaSobrepaso                            --
          FROM
               SIRASGN,
               (SELECT SI.SIBINST_PIDM         PIDM,
                       SI.SIBINST_FSTP_CODE    TIPO,
                       SI.SIBINST_FCTG_CODE    PERFIL
                  FROM SIBINST SI
                 WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(ZI.SIBINST_TERM_CODE_EFF)
                                                  FROM SIBINST ZI
                                                 WHERE ZI.SIBINST_PIDM            = SI.SIBINST_PIDM
                                                   AND (ZI.SIBINST_TERM_CODE_EFF <= psTerm OR psTerm IS NULL))
                        ) INST
         WHERE SIRASGN_PIDM             = INST.PIDM(+)
           AND SIRASGN_TERM_CODE        = psTerm
           AND SIRASGN_PERCENT_RESPONSE > 0
           AND INST.PIDM                = pnPidm
           AND INST.TIPO                = 'HON';
     END;

     BEGIN
        SELECT COUNT(ROUND((SSRMEET_HRS_WEEK/1.33),2))
          INTO vnCuentaModulos
          FROM SIRASGN,
               SSRMEET,
               (SELECT SI.SIBINST_PIDM         SIBINST_PIDM,
                       SI.SIBINST_FSTP_CODE    TIPO,
                       SI.SIBINST_FCTG_CODE    PERFIL
                  FROM SIBINST SI
                 WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(ZI.SIBINST_TERM_CODE_EFF)
                                                  FROM SIBINST ZI
                                                 WHERE ZI.SIBINST_PIDM            = SI.SIBINST_PIDM
                                                   AND (ZI.SIBINST_TERM_CODE_EFF <= psTerm OR psTerm IS NULL)) )sibinst
         WHERE SIRASGN_PIDM      = pnPidm
           AND SIRASGN_TERM_CODE = psTerm
           AND SIBINST_PIDM      = SIRASGN_PIDM
           AND SIBINST.TIPO      = 'HON'
           AND SSRMEET_TERM_CODE = SIRASGN_TERM_CODE
           AND SSRMEET_CRN       = SIRASGN_CRN
           AND SSRMEET_CATAGORY  = SIRASGN_CATEGORY;
     END;

     BEGIN
        SELECT A.SIBINST_FCTG_CODE
          INTO vsCategoria
          FROM SIBINST A
         WHERE A.SIBINST_PIDM = pnPidm
           AND A.SIBINST_TERM_CODE_EFF = (SELECT MAX(B.SIBINST_TERM_CODE_EFF)
                                            FROM SIBINST B
                                           WHERE A.SIBINST_PIDM = B.SIBINST_PIDM);
     END;

     BEGIN
        SELECT X1.SWBCDCT_TABULATOR
          INTO vnPTabulador                                    --
          FROM SWBCDCT X1
         WHERE X1.SWBCDCT_TERM_CODE_EFF = (SELECT MAX(X2.SWBCDCT_TERM_CODE_EFF)
                                             FROM SWBCDCT X2
                                            WHERE X1.SWBCDCT_FCTG_CODE = X2.SWBCDCT_FCTG_CODE
                                              AND X1.SWBCDCT_LEVL_CODE = SWBCDCT_LEVL_CODE)
           AND X1.SWBCDCT_FCTG_CODE = vsCategoria
           AND X1.SWBCDCT_LEVL_CODE = 'LC';

     EXCEPTION WHEN NO_DATA_FOUND THEN
        vnPTabulador := 0;

     END;

     vnPTotalS := ROUND((vnPTabulador * vnSobrepaso),2);

     IF vnSobrepaso = 0 THEN

        IF vnPTabulador IS NOT NULL THEN
        -- vnptotal  := vnptotalm;
           vnPTotalM := ROUND((vnPTabulador * vnModulos),2);
           vnPTotal  := vnPTotalM;
        END IF;

     ELSE

        IF vnSobrepaso <> vnModulos THEN

           IF vnModulos = 1 THEN
              vnPTotal := vnPTotalS;
           ELSE
              --vnmodulos := vncuentamodulos - vncuentasobrepaso;
              vnPTotalM := ROUND((vnPTabulador * vnModulos),2);
              vnPTotal  := vnPTotalM + vnPTotalS;
           END IF;

        END IF;

        IF vnCuentaModulos = vnCuentaSobrepaso THEN
           vnPTotal := vnPTotalS;
        END IF;

     END IF;

/*   lneas anteriores desechadas:   (hmr)
     vntotbrutop := vnptotal;
     vniva       := round((vnptotal * .10),2);
     vntotaliva  := round(vnptotal - vniva,2);
*/
     -- nuevas variables de totales:   (hmr)
     vnTotBrutoP   := vnSumTarifaModulo;                  -- "total bruto a pagar"
     vnRetIva      := ROUND((vnTotBrutoP * .10),2);       -- "10% de retencin de impuesto" (iva)
     vnTotLiquidoP := ROUND(vnTotBrutoP - vnRetIva,2);    -- "total lquido a pagar"

     -- despliega los importes totales:   (hmr)
     htp.p('<tr><th align="left" colspan="3">Total m&oacute;dulos docentes:</th>
                <th align="right">'||vnTotal||'</th>
            </tr>

            <tr><th align="left" colspan="3">Total bruto a pagar: </th>
                <th align="right">'||'$'||vnTotBrutoP||'</th>       <!-- antes: vnPTotal -->
            </tr>

            <tr><th align="left" colspan="3">10% de retenci&oacute;n de impuestos: </th>
                <th align="right">'||'$'||vnRetIva||'</th>          <!-- antes: vnIva -->
            </tr>

            <tr><th align="left" colspan="3">Total l&iacute;quido a pagar: </th>
                <th align="right">'||'$'||vnTotLiquidoP||'</th>     <!-- antes: vnTotalIva -->
            </tr>

            </table>
            </td>

            <td colspan="'||(vnColumnas-1)||'">
            </td></tr>');

      vnTotalFd  := 0;
      vnTotalFnd := 0;
      vnTotal    := 0;
      vnSumTarifaModulo := 0;


  end GeneraTotales;

  -- ya no se usa:   (hmr)
  procedure detalleTotal ( pnPidm  NUMBER,
                           psTerm  VARCHAR2 ) is

  begin

     -- obtiene la cantidad de mdulos:
     SELECT SUM(ROUND((SSRMEET_HRS_WEEK/1.33),2))
       INTO vnModulos
       FROM SSRMEET,
            SIRASGN,
            (SELECT SI.SIBINST_PIDM         PIDM,
                    SI.SIBINST_FSTP_CODE    TIPO,
                    SI.SIBINST_FCTG_CODE    PERFIL
               FROM SIBINST SI
              WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(ZI.SIBINST_TERM_CODE_EFF)
                                               FROM SIBINST ZI
                                              WHERE ZI.SIBINST_PIDM            = SI.SIBINST_PIDM
                                                AND (ZI.SIBINST_TERM_CODE_EFF <= psTerm OR psTerm IS NULL) )
             ) INST
      WHERE SIRASGN_PIDM             = INST.PIDM(+)
        AND SSRMEET_TERM_CODE        = SIRASGN_TERM_CODE(+)
        AND SSRMEET_CRN              = SIRASGN_CRN(+)
        AND SSRMEET_CATAGORY         = SIRASGN_CATEGORY(+)
        AND SIRASGN_TERM_CODE        = psTerm
        AND SIRASGN_PERCENT_RESPONSE > 0
        AND INST.PIDM                = pnPidm
        AND INST.TIPO                = 'HON';

     -- obtiene la categora:
     SELECT A.SIBINST_FCTG_CODE
       INTO vsCategoria
       FROM SIBINST A
      WHERE A.SIBINST_PIDM = pnPidm
        AND A.SIBINST_TERM_CODE_EFF = (SELECT MAX(B.SIBINST_TERM_CODE_EFF)
                                         FROM SIBINST B
                                        WHERE A.SIBINST_PIDM = B.SIBINST_PIDM);

     -- obtiene el tabulador:
     SELECT X1.SWBCDCT_TABULATOR
       INTO vnPTabulador
       FROM SWBCDCT X1
      WHERE X1.SWBCDCT_TERM_CODE_EFF = (SELECT MAX(X2.SWBCDCT_TERM_CODE_EFF) FROM SWBCDCT X2
                                         WHERE X1.SWBCDCT_FCTG_CODE = X2.SWBCDCT_FCTG_CODE
                                           AND X1.SWBCDCT_LEVL_CODE = SWBCDCT_LEVL_CODE)
        AND X1.SWBCDCT_FCTG_CODE     = vsCategoria;

     vnPTotal := ROUND((vnPTabulador * vnModulos),2);

  exception
     when no_data_found then
          vnPTabulador:= 0;
          vnPTotal    := 0;
          vnModulos   := 0;

          htp.p('<tr><td>
                     <table border="0" width="100%" cellpadding="0 cellspacing="0">
                 <tr><th align="left" colspan="3">Total a Pagar</th>
                     <th align="left">'||vnPTotal||'</th>
                 </tr>');

  end detalleTotal;


  -------------------------------------------------
  -- inicia bloque principal que genera el reporte
  -------------------------------------------------

  BEGIN

     -- valida que el usuario tenga acceso a la base de datos:
     IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

     -- obtiene los valores de las cookies para asignar los valores del filtro del query:
     ckCount := 0;
     owa_cookie.get_all(ckNombres, ckValores, ckCount);

     IF ckCount != 0 THEN
         FOR vnCOKIES IN 1..ckCount LOOP
             IF ckNOMBRES(vnCOKIES) = 'psUnive' THEN
                vsUnive := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psPeriM' THEN
                   vsPerio := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                   vsFacu := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psCate' THEN
                   vsCate := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                   vsSeccion := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psPtrm' THEN
                   vsPtrm := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psSede' THEN
                   vsSede := ckValores(vnCOKIES);

             END IF;
         END LOOP;
     END IF;

     -- determina el largo de la tabla:
     FOR vnI IN 1..vnColumnas LOOP
         tabColumna.EXTEND(vnI);
         tabColumna(vnI) := NULL;
     END LOOP;

     -- define los encabezados de columnas:
     tabColumna(1)  := ' ';
     tabColumna(2)  := '<b><center>NRC</b>';
     tabColumna(3)  := '<b><center>Parte<br>del<br>periodo</b>';
     tabColumna(4)  := '<b><center>Jornada</b>';
     tabColumna(5)  := '<b><center>Indicador<br>de<br>Sesi&oacute;n</b>';
     tabColumna(6)  := '<b><center>Materia</b>';
     tabColumna(7)  := '<b><center>T&iacute;tulo<br>del<br>Curso</b>';
     tabColumna(8)  := '<b><center>&nbsp;Curso&nbsp;</b>';
     tabColumna(9)  := '<b><center>&nbsp;Escuela&nbsp;</b>';
     tabColumna(10) := '<b><center>&nbsp;Secci&oacute;n&nbsp;</b>';
     tabColumna(11) := '<b><center>&nbsp;Sesi&oacute;n</b>';
     tabColumna(12) := '<b><center>&nbsp;Fecha&nbsp;<br>de<br>Inicio</b>';
     tabColumna(13) := '<b><center>&nbsp;Fecha&nbsp;<br>de<br>Fin</b>';
     tabColumna(14) := '<b><center>M&oacute;dulo</b>';
     tabColumna(15) := '<b><center>% de<br>responsabilidad</b>';
     tabColumna(16) := '<b><center>&nbsp;Total&nbsp;</b>';
     tabColumna(17) := '<b><center>Sobrepaso<br>Carga</b>';
     tabColumna(18) := '<b><center>Tipo<br>de<br>Asignaci&oacute;n</b>';
     tabColumna(19) := '<b><center>Categor&iacute;a</b>';
     tabColumna(20) := '<b><center>Valor<br>&nbsp;M&oacute;dulo&nbsp;</b>';
     tabColumna(21) := '<b><center>Tarifa<br>&nbsp;M&oacute;dulo&nbsp;</b>';
     tabColumna(22) := '<b><center>Tipo<br>de<br>curso</b>';
     tabColumna(23) := '<b><center>Inscritos</b>';

   --pk_sisrepimp.gtabproptd(15) := 'rowspan="2"';
     Pk_Sisrepimp.vgsSaltoImp    := 'SALTO';


     WHILE (INSTR(vsPerio, '/') > 0 ) LOOP

           -- manipula la informacin obtenida por el cursor:
           FOR regRep IN cuReporte(vsUnive, SUBSTR(vsPerio, 0, INSTR(vsPerio,'/')-1), vsFacu, vsCate, vsPtrm, vsSede) LOOP

               vnPTabulador:= 0;
               vsCategoria := NULL;

               IF vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
                  vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR
                  vsCollcode IS NULL OR vsCollcode <> regRep.collCode OR
                  vsID       IS NULL OR regRep.ID  <> vsID
                  THEN

                  IF vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
                     vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR
                     vsCollcode IS NULL OR vsCollcode <> regRep.collCode
                     THEN
                        vsSinHeadrs := NULL;
                  END IF;

                  IF vsID IS NOT NULL THEN
                     vnContador  := 0;

                     IF vsPonerLinea = 'Y' THEN
                        -- muestra una lnea divisoria:  (hmr)
                        htp.p('<hr width="100%" colspan='||(vncolumnas-1)||'></hr>');
                     END IF;

                     FOR regAdic IN cuAdicional (regRep.termCode,vnPidm) LOOP

                         htp.p('<tr><td>
                                    </td><td align="center" valign="top">'||regAdic.CLAVE||'</td>
                                         <td align="center" valign="top">'||'--'||'</td>
                                         <td align="center" valign="top">'||'--'||'</td>
                                         <td align="center" valign="top">'||'--'||'</td>
                                         <td align="center" valign="top">'||'--'||'</td>
                                         <td align="center" valign="top">'||regAdic.DESCRIPCION||'</td>
                                         <td align="center" valign="top">'||'--'||'</td>
                                         <td align="center" valign="top">'||regAdic.ESCUELA||'</td>
                                         <td align="center" valign="top">'||'--'||'</td>
                                         <td align="center" valign="top">'||'--'||'</td>
                                         <td align="center" valign="top">'||'--'||'</td>
                                         <td align="center" valign="top">'||'--'||'</td>
                                         <td align="center" valign="top">'||regAdic.HORAS_MODULO||'</td>
                                         <td align="center" valign="top">'||regAdic.RESPONSABILIDAD||'</td>
                                         <td align="center" valign="top">'||regAdic.TOTAL_MODULO||'</td>
                                         <td align="center" valign="top">'||'--'||'</td>
                                         <td align="center" valign="top">'||'--'||'</td>
                                         <td align="center" valign="top">'||regAdic.CATEGORIA||'</td>
                                         <td align="center" valign="top">'||regAdic.VALOR_MODULO||'</td>    <!-- Encabezado: VALOR_MODULO      -->
                                         <td align="center" valign="top">'||regAdic.TARIFA_MODULO||'</td>   <!-- Encabezado: TARIFA_MODULO     -->
                                         <td align="center" valign="top">'||'--'||'</td>
                                         <td align="center" valign="top">'||'--'||'</td>
                                </tr>');

                         -- suma la "tarifa modulo" cuando no hay nrc:  (hmr / 08-nov-2011)
                         vnSumTarifaModulo := vnSumTarifaModulo + regAdic.TARIFA_MODULO;

                     END LOOP;

                     -- genera los totales por docente:
                     GeneraTotales (vnPidm, vsTermCode);

                     vsPonerLinea := 'Y';

                  END IF;

                  -- establece el encabezado del reporte considerando los parmetros:
                  Pk_Sisrepimp.P_EncabezadoDeReporte ( psReclDesc, vnColumnas, tabColumna, vgsInicoPag, '0',
                                                       psSubtitulo   => 'Periodo: &nbsp;'||regrep.termcode||' - '||Pk_Catalogo.PERIODO(regrep.termcode),
                                                       psUsuario     => vgsUSR,
                                                       psSeccion     => vsSeccion,
                                                       psUniversidad => regRep.campCode,
                                                       psDetalle     => detalle(regRep.ID, regRep.Docente, regRep.SUFFIX, regRep.descSede),
                                                       psSinPiePag   => 'P',
                                                       psSinLogo     => 'P',
                                                       psTituloSinFr => 'P',
                                                       psSinHeaders  => vsSinHeadrs );

                  vgsInicoPag := 'SALTO';
                  vsSinHeadrs := 'H';

               END IF;

               -- establece cada lnea de datos:
               htp.p('<tr><td>
                          </td><td align="center" valign="top">'||regRep.NRC         ||'</td>
                               <td align="center" valign="top">'||regRep.PART_PERIODO||'</td>
                               <td align="center" valign="top">'||regRep.SESION      ||'</td>
                               <td align="center" valign="top">'||regRep.IND_SESION  ||'</td>
                               <td align="center" valign="top">'||regRep.MATERIA     ||'</td>
                               <td align="center" valign="top">'||regRep.TITULO      ||'</td>
                               <td align="center" valign="top">'||regRep.CURSO       ||'</td>
                               <td align="center" valign="top">'||regRep.COLLCODE    ||'</td>
                               <td align="center" valign="top">'||regRep.SECUENCIA   ||'</td>
                               <td align="center" valign="top">'||regRep.IND_SESION  ||'</td>
                               <td align="center" valign="top">'||regRep.INICIO      ||'</td>
                               <td align="center" valign="top">'||regRep.FIN         ||'</td>
                               <td align="center" valign="top">'||regRep.MODULO      ||'</td>   <!-- Encabezado: Modulo               -->
                               <td align="center" valign="top">'||regRep.PORCENTAJE  ||'</td>   <!-- Encabezado: % de responsabilidad -->
                               <td align="center" valign="top">'||regRep.TOTAL       ||'</td>   <!-- Encabezado: Total                -->
                               <td align="center" valign="top">'||regRep.SOBREPASO   ||'</td>   <!-- Encabezado: Sobrepaso Carga      -->
                               <td align="center" valign="top">'||regRep.ASIGNACION  ||'</td>   <!-- Encabezado: Tipo de asignacin   -->
                               <td align="center" valign="top">'||regRep.CVEPERFIL   ||'</td>   <!-- Encabezado: Categoria            -->');
                               IF regRep.ASIGNACION IS NULL THEN
                              htp.p('<td align="center" valign="top">'||regRep.TARIFA      ||'</td>');  -- encabezado: valor mdulo
                               END IF;
                               IF regRep.ASIGNACION IS NOT NULL THEN
                               htp.p('<td align="center" valign="top">'||regRep.TARIFA_MODULO_SOBREPASO      ||'</td>');  -- encabezado: valor mdulo
                                END IF;
               -- determina el valor de "tarifa mdulo": (hmr)
               IF regRep.SOBREPASO IS NOT NULL THEN
                 if regRep.ASIGNACION IS NULL then
                  htp.p('<td align="center" valign="top">'||regrep.TOTAL_ASIG||'</td>');      -- toma internamente el sobrepaso
                  ELSE
                  htp.p('<td align="center" valign="top">'||regrep.TOTAL_ASIG_SOBREPASO||'</td>');      -- toma internamente el sobrepaso
                END IF;
               ELSE
                    if regRep.ASIGNACION IS NULL then
                  htp.p('<td align="center" valign="top">'||regrep.TAF_TOTAL||'</td>');       -- toma internamente el modulo
                    ELSE
                    htp.p('<td align="center" valign="top">'||regRep.TAF_TOTAL_ASIGNACION||'</td>');       --
               END IF;
               END IF;

               htp.p('<td align="center" valign="top">'||regRep.TIPO_CURSO||'</td>   <!-- Encabezado: Tipo de curso -->
                      <td align="center" valign="top">'||regRep.INSCRITOS ||'</td>   <!-- Encabezado: Inscritos -->
                      </tr>');

               vnPidm     := regRep.PIDM;
               vsID       := regRep.ID;
               vsCampCode := regRep.CAMPCODE;
               vsTermCode := regRep.TERMCODE;
               vsCollcode := regRep.COLLCODE;
               vnContador := vnContador + 1;

               IF regRep.SOBREPASO IS NULL THEN
                  vnTotalFd := vnTotalFd + regRep.TOTAL;
               END IF;

               IF regRep.SOBREPASO IS NOT NULL AND vnContador <= 1 THEN
                  vnTotalFd := vnTotalFd + regRep.SOBREPASO;
               END IF;

               IF regRep.sobrepaso IS NOT NULL AND vncontador > 1 THEN
                 -- vnTotalFd := vnTotalFd + regRep.TOTAL;
                  vnTotalFd := vnTotalFd + regRep.SOBREPASO;

               END IF;

               -- suma la "tarifa mdulo" cuando hay nrc:  (hmr / 08-nov-2011)
               IF regRep.SOBREPASO IS NOT NULL THEN
               if regRep.ASIGNACION is null then
                  vnSumTarifaModulo := vnSumTarifaModulo + regrep.TOTAL_ASIG;
               else
               vnSumTarifaModulo := vnSumTarifaModulo + regrep.TOTAL_ASIG_SOBREPASO;
               end if;
               ELSE
               if regRep.ASIGNACION is null then
                  vnSumTarifaModulo := vnSumTarifaModulo + regrep.TAF_TOTAL;
               else
               vnSumTarifaModulo := vnSumTarifaModulo + regrep.TAF_TOTAL_ASIGNACION;
               end if;
               END IF;

               vnExists := 1;

           END LOOP;

           vsPerio := SUBSTR(vsPerio, INSTR(vsPerio,'/')+1 );

           -- muestra una lnea divisoria (penltima lnea):  (hmr)
           htp.p('<hr width="100%" colspan='||(vncolumnas-1)||'></hr>');

     END LOOP;

     IF vnExists = 0 THEN
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');

     ELSE
        -- genera los totales por docente:
        GeneraTotales (vnPidm, vsTermCode);


        -- bloque cancelado anteriormente:  (hmr)
           --if regrep.  is not null then
           --   detalletotal(vnpidm, vstermcode);
           --end if;

           --detalletotal(vnpidm, vstermcode);


        -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- omite el encabezado del reporte pero se agrega el salto de pgina:
        Pk_Sisrepimp.P_EncabezadoDeReporte ( psReclDesc, vnColumnas, tabColumna, 'PIE', '0',
                                             psUsuario   => vgsUSR,
                                             psSeccion   => vsSeccion,
                                             psSinPiePag => 'P',
                                             psSinLogo   => 'P' );

        -- muestra una lnea divisoria (ltima lnea):  (hmr)
        htp.p('<hr width="100%" colspan='||(vncolumnas-1)||'></hr>');

     END IF;

     --htp.p('</table><br/><br/></body></html>');
     htp.p('<br/><br/></body></html>');

  EXCEPTION
     WHEN OTHERS THEN htp.p(SQLERRM);

  END PWRNOMH;
/


DROP PUBLIC SYNONYM PWRNOMH;

CREATE PUBLIC SYNONYM PWRNOMH FOR BANINST1.PWRNOMH;


GRANT EXECUTE ON BANINST1.PWRNOMH TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRNOMH TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRNOMP;

CREATE OR REPLACE PROCEDURE BANINST1.PWRNOMP(psReclDesc VARCHAR2) IS
/*
     TAREA: Reporte de nomina por planta
     FECHA: 23/03/2010
     AUTOR: GEPC
    MODULO: Programacin acadmica

*/

ckNombres    owa_cookie.vc_arr;
ckValores    owa_cookie.vc_arr;
ckCount      INTEGER;
vgsInicoPag  VARCHAR2(10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
vgsUSR       VARCHAR2(500);

  vnRow       INTEGER                := 0;
  vnExists    INTEGER                := 0;
  vnColumnas  INTEGER                := 11;
  tabColumna  Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vsPerio     VARCHAR2(1000)         := NULL;
  vsCate      VARCHAR2(100)          := NULL;
  vsTipo      VARCHAR2(50)           := NULL;
  vsUnive     VARCHAR2(50)           := NULL;
  vsSeccion   VARCHAR2(3)            := NULL;
  vsStatus    VARCHAR2(50)           := NULL;
  vsTipoDoc   VARCHAR2(50)           := NULL;
  vsDocente   VARCHAR2(50)           := NULL;
  vsEscuela   VARCHAR2(150)          := NULL;
  vsID        VARCHAR2(50)           := NULL;
  vsFacu      VARCHAR2(100)          := NULL;
  vsPtrm      VARCHAR2(1000)         := NULL;
  vsSede      VARCHAR2(10)           := NULL;
  vnTotalFd   NUMBER                 := 0;
  vnTotalFnd  NUMBER                 := 0;
  vnTotal     NUMBER                 := 0;
  vnPidm      NUMBER                 := NULL;
  vsMatCurAct VARCHAR2(14)           := NULL;
  vsMatCurAnt VARCHAR2(14)           := NULL;
  vnInscritos NUMBER                 := NULL;
  vsSinHeadrs VARCHAR2(1)            := NULL;
  vsTermCode  VARCHAR2(6)            := NULL;
  vsCampCode  VARCHAR2(6)            := NULL;
  vsCollCode  VARCHAR2(6)            := NULL;
  vsPtrmCode  VARCHAR2(6)            := NULL;

  CURSOR cuReporte(psUnive VARCHAR2 DEFAULT NULL,
                   psTerm  VARCHAR2 DEFAULT NULL,
                   psFacu  VARCHAR2 DEFAULT NULL,
                   psCate  VARCHAR2 DEFAULT NULL,
                   psType  VARCHAR2 DEFAULT NULL,
                   psPtrm  VARCHAR2 DEFAULT NULL,
                   psSede  VARCHAR2 DEFAULT NULL
                  ) IS
         SELECT SS.SSBSECT_TERM_CODE                                               termCode,
                SSBSECT_CAMP_CODE                                                  campCode,
                ESCUELA.SEDE                                                       collSede,
                Pk_Catalogo.COLEGIO(ESCUELA.SEDE)                                  DESC_SEDE,
                SCBCRSE_COLL_CODE                                                  ESCUELA,
                Pk_Catalogo.COLEGIO(SCBCRSE_COLL_CODE)                             descSede,
                SPRIDEN_ID                                                         ID,
                PROFESOR.PIDM                                                      PIDM,
                REPLACE(REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME||' '||SPRIDEN_MI,'','&ntilde;'),'*',' ') DOCENTE,
                PROFESOR.TIPO                                                      TIPO,
                Pk_Catalogo.TIPO(PROFESOR.TIPO)                                    TIPO_PROFESOR,
                SSBSECT_CRN                                                        NRC,
                PROFESOR.DIAS                                                      DIAS,
                PROFESOR.CATEGORIA                                                 SESION,
                PROFESOR.HORARIO                                                   HORARIO,
                SCBCRSE_SUBJ_CODE                                                  MATERIA,
                SCBCRSE_CRSE_NUMB                                                  CURSO,
                NVL(PROFESOR.HORAS_SEM,0)                                          HORAS_SEM,
                DECODE(SWRXLST_TYPE,'M','Master','S','Simultneo','Independiente') TIPO_CURSO,
                DECODE(SWRXLST_TYPE,'M',SSBXLST_ENRL,SSBSECT_ENRL) INSCRITOS,
                PROFESOR.CVEPERFIL,
                PROFESOR.DESCPERFIL,
                SSBSECT_PTRM_CODE                                  ptrmCode
           FROM SSBSECT SS,
                SCBCRSE,
                (SELECT SIRASGN_PIDM                                       PIDM,
                        SSRMEET_TERM_CODE                                  PERIODO,
                        SSRMEET_CRN                                        CRN,
                        SSRMEET_CATAGORY                                   CATEGORIA,
                        SSRMEET_HRS_WEEK                                   HORAS_SEM,
                        DECODE(SSRMEET_MON_DAY, 'M', 'Lu', SSRMEET_MON_DAY)||'-'||
                        DECODE(SSRMEET_TUE_DAY, 'T', 'Ma', SSRMEET_TUE_DAY)||'-'||
                        DECODE(SSRMEET_WED_DAY, 'W', 'Mi', SSRMEET_WED_DAY)||'-'||
                        DECODE(SSRMEET_THU_DAY, 'R', 'Ju', SSRMEET_THU_DAY)||'-'||
                        DECODE(SSRMEET_FRI_DAY, 'F', 'Vi', SSRMEET_FRI_DAY)||'-'||
                        DECODE(SSRMEET_SAT_DAY, 'S', 'Sa', SSRMEET_SAT_DAY) DIAS,
                        SUBSTR(SSRMEET_BEGIN_TIME,1,2)||':'||
                        NVL(SUBSTR(SSRMEET_BEGIN_TIME,3,2),'00')||' '||
                        SUBSTR(SSRMEET_END_TIME,1,2)||':'||
                        NVL(SUBSTR(SSRMEET_END_TIME,3,2),'00')             HORARIO,
                        INST.TIPO                                          TIPO,
                        INST.CVEPERFIL,
                        INST.DESCPERFIL
                   FROM SSRMEET,
                        SIRASGN,
                        (SELECT SI.SIBINST_PIDM         PIDM,
                                SI.SIBINST_FSTP_CODE    TIPO,
                                SI.SIBINST_FCTG_CODE    CVEPERFIL,
                                STVFCTG_DESC            DESCPERFIL
                           FROM SIBINST SI, STVFCTG
                          WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(ZI.SIBINST_TERM_CODE_EFF)
                                                           FROM SIBINST ZI
                                                          WHERE ZI.SIBINST_PIDM =  SI.SIBINST_PIDM
                                                            AND (ZI.SIBINST_TERM_CODE_EFF <= psTerm OR psTerm IS NULL)
                                                        )
                            AND STVFCTG_CODE(+) = SIBINST_FCTG_CODE
                        ) INST
                  WHERE SIRASGN_PIDM            = INST.PIDM(+)
                    AND SSRMEET_TERM_CODE       = SIRASGN_TERM_CODE(+)
                    AND SSRMEET_CRN             = SIRASGN_CRN(+)
                    AND SSRMEET_CATAGORY        = SIRASGN_CATEGORY(+)
                    AND SIRASGN_PERCENT_RESPONSE > 0
                    AND INST.TIPO               <> 'HON'
                ) PROFESOR,
                (SELECT SIRDPCL_PIDM      PIDM,
                        SIRDPCL_COLL_CODE SEDE,
                        SIRDPCL_DEPT_CODE deptSede
                   FROM SIRDPCL A
                  WHERE SIRDPCL_HOME_IND        = 'Y'
                    AND SIRDPCL_TERM_CODE_EFF   = (SELECT MAX(SI.SIRDPCL_TERM_CODE_EFF)
                                                     FROM SIRDPCL SI
                                                    WHERE SI.SIRDPCL_PIDM           =  A.SIRDPCL_PIDM
                                                     AND (SI.SIRDPCL_TERM_CODE_EFF <= psTerm OR psTerm IS NULL))
                ) ESCUELA,
                SPRIDEN,
                SWRXLST,
                SSRXLST,
                SSBXLST
          WHERE SSBSECT_SUBJ_CODE     = SCBCRSE_SUBJ_CODE
            AND SSBSECT_CRSE_NUMB     = SCBCRSE_CRSE_NUMB
            AND SCBCRSE_EFF_TERM      = (SELECT MAX(SC.SCBCRSE_EFF_TERM)
                                           FROM SCBCRSE SC
                                          WHERE SC.SCBCRSE_EFF_TERM <= SS.SSBSECT_TERM_CODE
                                            AND SC.SCBCRSE_SUBJ_CODE = SS.SSBSECT_SUBJ_CODE
                                            AND SC.SCBCRSE_CRSE_NUMB = SS.SSBSECT_CRSE_NUMB
                                        )
            AND SSBSECT_TERM_CODE     = PROFESOR.PERIODO
            AND SSBSECT_CRN           = PROFESOR.CRN
            AND PROFESOR.PIDM         = ESCUELA.PIDM
            AND PROFESOR.PIDM         = SPRIDEN_PIDM(+)
            AND SPRIDEN_CHANGE_IND IS NULL
            AND SSBSECT_TERM_CODE     = SSRXLST_TERM_CODE(+)
            AND SSBSECT_CRN           = SSRXLST_CRN(+)
            AND SSRXLST_TERM_CODE     = SWRXLST_TERM_CODE(+)
            AND SSRXLST_CRN           = SWRXLST_CRN(+)
            AND SSRXLST_XLST_GROUP    = SWRXLST_XLST_GROUP(+)
            AND SSRXLST_TERM_CODE     = SSBXLST_TERM_CODE(+)
            AND SSRXLST_XLST_GROUP    = SSBXLST_XLST_GROUP(+)
            AND (SS.SSBSECT_CAMP_CODE = psUnive OR psUnive IS NULL)
            AND (SS.SSBSECT_TERM_CODE = psTerm  OR psTerm  IS NULL)
            AND (ESCUELA.deptSede     = psSede  OR psSede  IS NULL)
            AND (INSTR('/' || psPtrm ,'/' || SS.SSBSECT_PTRM_CODE || '/') > 0 OR psPtrm  IS NULL)
            AND (ESCUELA.SEDE         = psFacu  OR psFacu IS NULL)
            AND (PROFESOR.CVEPERFIL   = psCate  OR psCate IS NULL)
            AND (SUBSTR(PROFESOR.TIPO,1,2) = psType OR psType IS NULL)
          UNION ALL
         SELECT DISTINCT SIRNIST_TERM_CODE                    termCode,
                NULL                                          campCode,
                ESCUELA.SEDE                                  collSede,
                Pk_Catalogo.COLEGIO(ESCUELA.SEDE)             descSede,
                SIRNIST_COLL_CODE                             ESCUELA,
                Pk_Catalogo.COLEGIO(SIRNIST_COLL_CODE)        DESC_ESCUELA,
                SPRIDEN_ID                                    ID,
                SPRIDEN_PIDM                                  PIDEM,
                REPLACE(REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME||' '||SPRIDEN_MI,'','&ntilde;'),'*',' ') DOCENTE,
                PROFESOR.TIPO                                 TIPO,
                Pk_Catalogo.TIPO(PROFESOR.TIPO)               TIPO_PROFESOR,
                NULL                                          NRC,
                NULL                                          DIAS,
                NULL                                          SESION,
                NULL                                          HORARIO,
                NULL                                          MATERIA,
                NULL                                          CURSO,
                NULL                                          HORAS_SEM,
                NULL                                          TIPO_CURSO,
                NULL                                          INSCRITOS,
                PROFESOR.CVEPERFIL,
                PROFESOR.DESCPERFIL,
                NULL                                  ptrmCode
           FROM SIRNIST, SPRIDEN,
                (SELECT SIRDPCL_PIDM      PIDEM,
                        SIRDPCL_COLL_CODE SEDE,
                        SIRDPCL_DEPT_CODE deptSede
                   FROM SIRDPCL A
                  WHERE SIRDPCL_HOME_IND        = 'Y'
                    AND SIRDPCL_TERM_CODE_EFF   = (SELECT MAX(SI.SIRDPCL_TERM_CODE_EFF)
                                                     FROM SIRDPCL SI
                                                    WHERE SI.SIRDPCL_PIDM           =  A.SIRDPCL_PIDM
                                                      AND (SI.SIRDPCL_TERM_CODE_EFF <= psTerm OR psTerm IS NULL)
                                                  )
                ) ESCUELA,
                (SELECT SI.SIBINST_PIDM         PIDM,
                        SI.SIBINST_FSTP_CODE    TIPO,
                        SI.SIBINST_FCTG_CODE    CVEPERFIL,
                        STVFCTG_DESC            DESCPERFIL
                   FROM SIBINST SI,
                        STVFCTG
                  WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(ZI.SIBINST_TERM_CODE_EFF)
                                                   FROM SIBINST ZI
                                                  WHERE ZI.SIBINST_PIDM      =  SI.SIBINST_PIDM
                                                    AND (ZI.SIBINST_TERM_CODE_EFF <= psTerm OR psTerm IS NULL)
                                                )
                    AND STVFCTG_CODE(+) = SIBINST_FCTG_CODE
                ) PROFESOR
          WHERE NOT EXISTS (SELECT 1
                              FROM SIRASGN
                             WHERE SIRASGN_TERM_CODE = SIRNIST_TERM_CODE
                               AND SIRASGN_PIDM      = SIRNIST_PIDM
                           )
           AND SPRIDEN_PIDM                          = SIRNIST_PIDM
           AND SPRIDEN_CHANGE_IND IS NULL
           AND ESCUELA.PIDEM              = SPRIDEN_PIDM
           AND SIRNIST_PIDM               = PROFESOR.PIDM(+)
           AND PROFESOR.TIPO             <> 'HON'
           AND (PROFESOR.CVEPERFIL        = psCate OR psCate IS NULL)
           AND (SUBSTR(PROFESOR.TIPO,1,2) = psType OR psType IS NULL)
           AND (SIRNIST_TERM_CODE         = psTerm OR psTerm IS NULL)
           AND (ESCUELA.SEDE              = psFacu OR psFacu IS NULL)
           AND (ESCUELA.deptSede          = psSede  OR psSede  IS NULL)
         ORDER BY termCode DESC, campCode, DOCENTE, NRC, MATERIA, CURSO;

  function detalle(psId   varchar2,
                   psName varchar2,
                   psType varchar2,
                   psPerf varchar2,
                   psSede varchar2
                  ) return varchar2 is

  vsEscuelaSede VARCHAR2(300) := '<tr><th colspan='||vncolumnas||'>Escuela &nbsp;&nbsp;'||psSede||'</th></tr>';

  begin
      if vsSinHeadrs is not null then
         vsEscuelaSede := null;
      end if;

      return vsEscuelaSede||
             '<tr>'||
             '<td width="34%"><b>'||psId||'&nbsp;&nbsp;'         ||psName||'</b></td>'||
             '<td width="33%" colspan="5"><b>Tipo &nbsp;&nbsp;'   ||psType||'</b></td>'||
             '<td width="33%" colspan="5"><b>Perfil &nbsp;&nbsp;'||psPerf||'</b></td>'||
             '</tr>';

  end detalle;

  procedure detalleFaculty(pnPidm NUMBER,
                           psCamp VARCHAR2,
                           psTerm VARCHAR2,
                           psPtrm VARCHAR2
                          ) is

  vnMatDif integer := null;

  --cursor materias diferentes
  cursor cuMateriasDiferentes is
         select count(distinct ssbsect_subj_code||ssbsect_crse_numb) subjCrse
           from ssbsect,
                sirasgn
          where ssbsect_term_code        = sirasgn_term_code
            and ssbsect_crn              = sirasgn_crn
            and sirasgn_percent_response > 0
            and sirasgn_pidm             = pnPidm
            and ssbsect_camp_code        = psCamp
            and ssbsect_term_code        = psTerm
            and ssbsect_ptrm_code        = psPtrm;

  --Para obtener funciones de no docencia
  cursor cuDetalle(psTerm  varchar2,
                   pnPidm  number) is
         select sirnist_nist_code                       nistCode,
                pk_Catalogo.funcion(sirnist_nist_code)  nistDesc,
                sirnist_tops_code                       topsCode,
                nvl(sum(sirnist_nist_workload),0)       nistWork
           from sirnist
          where sirnist_term_code    = psTerm
            and sirnist_pidm         = pnPidm
          group by sirnist_nist_code,
                   sirnist_nist_code,
                   sirnist_tops_code;

  begin
      for regDif in cuMateriasDiferentes loop
          vnMatDif := regDif.subjCrse;
      end loop;

      htp.p('<tr><td>
      <table border="0" width="100%" cellpadding="0 cellspacing="0">
      <tr><th align="left" colspan="3">Materias diferentes</th>
          <th align="left">'||vnMatDif||'</th>
          </tr>
      <tr><th align="left" colspan="3">Horas docencia</th>
          <th align="left">'||vnTotalFd||'</th>
          </tr>'
      );

      for regDet in cuDetalle(psTerm, pnPidm) loop
          vnTotalFnd := vnTotalFnd + regDet.nistWork;

          htp.p('<tr>
          <td valign="top" align="left" width="20%">'||regDet.nistCode||'</td>
          <td valign="top" align="left" width="50%">'||regDet.nistDesc||'</td>
          <td valign="top" align="left" width="20%">'||regDet.topsCode||'</td>
          <td valign="top" align="left" width="10%">' ||regDet.nistWork||'</td>
          </tr>'
          );
      end loop;

      vnTotal := vnTotalFd + vnTotalFnd;

      htp.p('<tr>
      <th align="left" colspan="3">Total M&oacute;dulos docentes</th>
      <th align="left">'||vnTotal||'</th>
      </tr>
      </table>
      </td>
      <td colspan="'||(vnColumnas-1)||'">
      </td></tr>
      <tr><td></td>'
      );

      for vnI in 1..(vnColumnas-1)  loop
          htp.p('<td width="6.6%"></td>');
      end loop;

      htp.p('</tr>');

      vnTotalFd  := 0;
      vnTotalFnd := 0;
      vnTotal    := 0;

  end detalleFaculty;

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
          FOR vnCOKIES IN 1..ckCount LOOP
              IF    ckNOMBRES(vnCOKIES) = 'psUnive' THEN
                    vsUnive := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psPeriM' THEN
                    vsPerio := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                    vsFacu  := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psCate' THEN
                    vsCate  := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psTipoN' THEN
                    vsTipo  := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psPtrm' THEN
                    vsPtrm  := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                    vsSeccion := ckValores(vnCOKIES);

              ELSIF ckNOMBRES(vnCOKIES) = 'psSede' THEN
                    vsSede    := ckValores(vnCOKIES);

              END IF;
          END LOOP;
      END IF;

      -- Las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := ' ';
      tabColumna(2)  := '<b>NRC</b>';
      tabColumna(3)  := '<b>D&Iacute;as</b>';
      tabColumna(4)  := '<b>Sesi&oacute;n</b>';
      tabColumna(5)  := '<b>Horario</b>';
      tabColumna(6)  := '<b>Materia</b>';
      tabColumna(7)  := '<b>Curso</b>';
      tabColumna(8)  := '<b>Escuela</b>';
      tabColumna(9)  := '<b>Horas semanales</b>';
      tabColumna(10) := '<b>Tipo de curso</b>';
      tabColumna(11) := '<b>Inscritos</b>';

      Pk_Sisrepimp.vgsSaltoImp := 'SALTO';

      WHILE (INSTR(vsPerio, '/') > 0 ) LOOP
             FOR regRep IN cuReporte(vsUnive, SUBSTR(vsPerio, 1, INSTR(vsPerio,'/')-1), vsFacu, vsCate, vsTipo, vsPtrm, vsSede) LOOP
                 IF vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
                    vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR
                    vsCollCode IS NULL OR vsCollCode <> regRep.collSede OR
                    vsID       IS NULL OR regRep.ID  <> vsID  THEN

                    IF vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
                       vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR
                       vsCollCode IS NULL OR vsCollCode <> regRep.collSede THEN
                       vsSinHeadrs := NULL;
                    END IF;

                    IF vsID IS NOT NULL THEN
                       detalleFaculty(vnPidm, vsCampCode, vsTermCode, vsPtrmCode);
                    END IF;

                    Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,vgsInicoPag,'0', psSubtitulo=>'Periodo '||regRep.termCode, psUsuario=>vgsUSR, psSeccion=>vsSeccion, psUniversidad=>regRep.campCode,psDetalle=>detalle(regRep.ID,regRep.Docente, regRep.Tipo_profesor,regRep.DescPerfil,regRep.descSede),psSinPiePag=>'P',psSinLogo=>'P',psTituloSinFr=>'P',psSinHeaders=>vsSinHeadrs);
                    vgsInicoPag := 'SALTO';
                    vsSinHeadrs := 'H';
                 END IF;

                 IF vsMatCurAnt IS NULL OR vsMatCurAnt <> regRep.NRC||regRep.Materia||regRep.Curso THEN
                    vnInscritos := regRep.Inscritos;
                 ELSE
                    vnInscritos := NULL;
                 END IF;

                 htp.p('
                 <tr>
                 <td></td>
                 <td valign="top">'||regRep.NRC       ||'</td>
                 <td valign="top">'||regRep.Dias      ||'</td>
                 <td valign="top">'||regRep.Sesion    ||'</td>
                 <td valign="top">'||regRep.Horario   ||'</td>
                 <td valign="top">'||regRep.Materia   ||'</td>
                 <td valign="top">'||regRep.Curso     ||'</td>
                 <td valign="top">'||regRep.Escuela   ||'</td>
                 <td valign="top">'||regRep.Horas_sem ||'</td>
                 <td valign="top">'||regRep.Tipo_curso||'</td>
                 <td valign="top">'||vnInscritos      ||'</td>
                 </tr>'
                 );

                 vnPidm      := regRep.Pidm;
                 vsID        := regRep.ID;
                 vsCampCode  := regRep.campCode;
                 vsTermCode  := regRep.termCode;
                 vsCollCode  := regRep.collSede;
                 vsPtrmCode  := regRep.ptrmCode;
                 vsTipoDoc   := regRep.Tipo_profesor;
                 vnTotalFd   := vnTotalFd + NVL(regRep.Horas_sem,0);
                 vsMatCurAnt := regRep.NRC||regRep.Materia||regRep.Curso;
                 vnExists    := 1;
             END LOOP;

             vsPerio := SUBSTR(vsPerio, instr(vsPerio,'/')+1 );
      END LOOP ;

      IF vnExists = 0 THEN
          htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
         detalleFaculty(vnPidm, vsCampCode, vsTermCode, vsPtrmCode);

         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>vgsUSR, psSeccion=>vsSeccion, psSinPiePag=>'P',psSinLogo=>'P');
      END IF;

      htp.p(
      '</table>
      <br/><br/>
      </body></html>'
      );

  EXCEPTION
      WHEN OTHERS THEN
           htp.p(SQLERRM);

  END PWRNOMP;
/


DROP PUBLIC SYNONYM PWRNOMP;

CREATE PUBLIC SYNONYM PWRNOMP FOR BANINST1.PWRNOMP;


GRANT EXECUTE ON BANINST1.PWRNOMP TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRNOMP TO WWW2_USER;
DROP PROCEDURE BANINST1.PWROCUP;

CREATE OR REPLACE PROCEDURE BANINST1.PWROCUP(psReclDesc VARCHAR2 DEFAULT 'REPORTE DOMINO',
                                             psEdifCode VARCHAR2 DEFAULT '000001',
                                             psFechaRep VARCHAR2 DEFAULT '27/07/2011'
                                            ) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de ocupacin de salones
                por da (domino).

********************************************************************************
***             versin: v.3                                                 ***
*******************************************************************************/

  -- declaracin de variables:
  tabColumna   PK_sisRepImp.tipoTabla    := PK_sisRepImp.tipoTabla(1);
  vsEdifCode   STVBLDG.STVBLDG_CODE%TYPE := NULL;
  vsEdifDesc   STVBLDG.STVBLDG_DESC%TYPE := NULL;
  vsFechaRep   VARCHAR2(10)              := NULL;
  vsDiaSemana  VARCHAR2(9)               := NULL;
  vsDia        VARCHAR2(1)               := NULL;
  vnExists     INTEGER                   := 0;
  vnHoraIni    INTEGER                   := 0;
  vnHoraFin    INTEGER                   := 0;

  vnHoraMax    CONSTANT INTEGER          := 2157;
  cnIncremento CONSTANT INTEGER          := 30;
  csDDMMYYY    CONSTANT VARCHAR2(10)     := 'DD/MM/YYYY';
  csEsp        CONSTANT VARCHAR2(1)      := ' ';

  -- obtiene los salones (ocupados y desocupados) de un edificio
  --cusalones
  CURSOR cuSalones IS
         SELECT SWTRDEF_ROOM_NUMBER AS roomCode,
                SWTRDEF_DESC        AS roomDesc
           FROM SWTRDEF
          ORDER BY SWTRDEF_ROOM_NUMBER;


  -- obtiene la descripcin del edificio
  --descedificio
  function descEdificio return varchar2 is

  vsEdif stvbldg.stvbldg_desc%type := null;

  csEdifCode constant stvbldg.stvbldg_code%type := vsEdifCode;

  begin
      begin
          select stvbldg_desc
            into vsEdif
            from stvbldg
           where stvbldg_code = csEdifCode;
      exception
          when others then
               null;
      end;

      return vsEdif;
  end descEdificio;

  --existendatos
  function existenCursos return number is

  vnExists number(4) := null;

  cn1 constant number(1) := 1;

  begin
      select count(cn1)
        into vnExists
        from twrosdc;

      return vnExists;

  end existenCursos;

  -- registra salones de clase
  --insertsalones
  procedure insertSalones is

  csEdifCode  constant stvbldg.stvbldg_code%type := vsEdifCode;
  csAC        constant varchar2(2) := 'AC';
  csC         constant varchar2(1) := 'C';
  csO         constant varchar2(1) := 'O';

  begin
      insert into swtrdef
      (swtrdef_room_number,
       swtrdef_desc
      )
      select sl.slbrdef_room_number,
             sl.slbrdef_desc
        from slbrdef sl
       where sl.slbrdef_term_code_eff = (select max(b.slbrdef_term_code_eff)
                                           from slbrdef b
                                          where b.slbrdef_room_number  = sl.slbrdef_room_number
                                            and b.slbrdef_room_number is not null
                                            and b.slbrdef_priority    is not null
                                        )
         and sl.slbrdef_room_number is not null
         and sl.slbrdef_priority    is not null
         and sl.slbrdef_rmst_code    = csAC
         and sl.slbrdef_room_type   in (csC,csO)
         and sl.slbrdef_bldg_code    = csEdifCode;

  end insertSalones;

  -- muestra el ttulo "sala" en el encabezado de los salones:
  --titulo
  procedure titulo is

  begin
      htp.p(
      '<table border="1" bordercolor="#cccccc">
              <tr><th bgcolor="#dddddd">
                      </th>
                  <th bgcolor="#bbffff">
                      SALA
                      </th>
                  </tr>
              <tr><th bgcolor="#88ddef">
                      HORA
                      </th>
      ');

      -- muestra en el encabezado horizontal los nombres de los salones:
      for regRom in cuSalones loop
          htp.p(
          '<th align="center" bgcolor="#bbffff" title="'||regRom.roomDesc||'">'||regRom.roomCode||'</th>
          ');
      end loop;

      htp.p('</tr>');
  end titulo;

  -- guarda en tabla temporal informacin de clases:
  --insertclases
  procedure insertClases is

  csEdifCode  constant stvbldg.stvbldg_code%type := vsEdifCode;
  csFechaRep  constant date                      := to_date(vsFechaRep, csDDMMYYY);
  csCLAS      constant varchar2(4)               := 'CLAS';
  csDia       constant varchar2(1)               := vsDia;

  begin
      insert into twrosdc
      (twrosdc_crn,
       twrosdc_term_code,
       twrosdc_hora_inicio,
       twrosdc_hora_fin,
       twrosdc_dias_semana,
       twrosdc_edificio_code,
       twrosdc_room_code,
       twrosdc_tipo
      )
      select
       ssrmeet_crn,
       ssrmeet_term_code,
       ssrmeet_begin_time,
       ssrmeet_end_time,
       ssrmeet_sun_day||ssrmeet_mon_day||ssrmeet_tue_day||ssrmeet_wed_day||ssrmeet_thu_day||ssrmeet_fri_day||ssrmeet_sat_day,
       csEdifCode,
       ssrmeet_room_code,
       csCLAS
        from ssrmeet
       where exists (select null
                       from ssbsect
                      where ssbsect_crn       = ssrmeet_crn
                        and ssbsect_term_code = ssrmeet_term_code
                    )
         and ssrmeet_room_code         in (select swtrdef_room_number
                                             from swtrdef
                                          )
         and csDia                     in (nvl(ssrmeet_sun_day,csEsp),
                                           nvl(ssrmeet_mon_day,csEsp),
                                           nvl(ssrmeet_tue_day,csEsp),
                                           nvl(ssrmeet_wed_day,csEsp),
                                           nvl(ssrmeet_thu_day,csEsp),
                                           nvl(ssrmeet_fri_day,csEsp),
                                           nvl(ssrmeet_sat_day,csEsp)
                                          )
         and trunc(ssrmeet_start_date) <= csFechaRep
         and trunc(ssrmeet_end_date)   >= csFechaRep
         and ssrmeet_bldg_code          = csEdifCode;
  end insertClases;

  -- guarda en tabla temporal informacin de eventos:
  --inserteventos
  procedure insertEventos is

  csEdifCode  constant stvbldg.stvbldg_code%type := vsEdifCode;
  csFechaRep  constant date                      := to_date(vsFechaRep, csDDMMYYY);
  csEVEN      constant varchar2(4)               := 'EVEN';
  csDia       constant varchar2(1)               := vsDia;

  begin
      insert into twrosdc
      (twrosdc_crn,
       twrosdc_term_code,
       twrosdc_hora_inicio,
       twrosdc_hora_fin,
       twrosdc_dias_semana,
       twrosdc_edificio_code,
       twrosdc_room_code,
       twrosdc_tipo
      )
      select
       ssrmeet_crn,
       ssrmeet_term_code,
       ssrmeet_begin_time,
       ssrmeet_end_time,
       ssrmeet_sun_day||ssrmeet_mon_day||ssrmeet_tue_day||ssrmeet_wed_day||ssrmeet_thu_day||ssrmeet_fri_day||ssrmeet_sat_day,
       csEdifCode,
       ssrmeet_room_code,
       csEVEN
        from ssrmeet
       where exists (select null
                       from slbevnt
                      where slbevnt_crn = ssrmeet_crn
                    )
         and ssrmeet_room_code         in (select swtrdef_room_number
                                             from swtrdef
                                          )
         and csDia                     in (nvl(ssrmeet_sun_day,csEsp),
                                           nvl(ssrmeet_mon_day,csEsp),
                                           nvl(ssrmeet_tue_day,csEsp),
                                           nvl(ssrmeet_wed_day,csEsp),
                                           nvl(ssrmeet_thu_day,csEsp),
                                           nvl(ssrmeet_fri_day,csEsp),
                                           nvl(ssrmeet_sat_day,csEsp)
                                          )
         and trunc(ssrmeet_start_date) <= csFechaRep
         and trunc(ssrmeet_end_date)   >= csFechaRep
         and ssrmeet_bldg_code          = csEdifCode;
  end insertEventos;

  -- obtiene los cursos programados
  --cursos
  procedure cursos(psRoom varchar2) is

  cn0        constant number(1)   := 0;
  cnHoraIni  constant number(4)   := vnHoraIni+10;
  cnHorafin  constant number(4)   := vnHoraFin-10;
  csDia      constant varchar2(1) := vsDia;

  --cucursos
  cursor cuCursos is
         select distinct twrosdc_crn         as osdcCrnn,
                         twrosdc_term_code   as osdcTerm,
                         twrosdc_dias_semana as osdcDias
           from twrosdc
          --where instr(twrosdc_dias_semana,csdia) > cn0
          where (
                   (cnHoraIni between twrosdc_hora_inicio and twrosdc_hora_fin)
                 or
                   (cnHorafin between twrosdc_hora_inicio and twrosdc_hora_fin)
                )
            and twrosdc_room_code = psRoom;

  -- obtiene el cdigo de escuela de la clase
  --getcollcodeclas
  function getCollCodeCLAS(psTerm varchar2,
                           psCrnn varchar2
                          ) return varchar2 is

  vsCollCode ssbovrr.ssbovrr_coll_code%type := null;

  begin
     begin

        select decode(ssbovrr_coll_code, null, scbcrse_coll_code, ssbovrr_coll_code)
          into vsCollCode
          from scbcrse a,
               ssbsect,
               ssbovrr
         where a.scbcrse_subj_code = ssbsect_subj_code
           and a.scbcrse_crse_numb = ssbsect_crse_numb
           and a.scbcrse_eff_term  = (select max(b.scbcrse_eff_term)
                                        from scbcrse b
                                       where b.scbcrse_subj_code = a.scbcrse_subj_code
                                         and b.scbcrse_crse_numb = a.scbcrse_crse_numb
                                     )
           and ssbsect_term_code   = ssbovrr_term_code(+)
           and ssbsect_crn         = ssbovrr_crn(+)
           and ssbsect_crn         = psCrnn
           and ssbsect_term_code   = psTerm;

     exception
        when no_data_found then
             null;
        when others then
             null;

     end;

     return vsCollCode;

  end getCollCodeCLAS;

  -- obtiene el cdigo de escuela del evento:
  --getcollcodeeven
  function getCollCodeEVEN(psCrnn varchar2) return varchar2 is

  vsCollCode slbevnt.slbevnt_coll_code%type := null;

  begin
     begin
        select slbevnt_coll_code
          into vsCollCode
          from slbevnt
         where slbevnt_crn = psCrnn;

     exception
        when no_data_found then
             null;
        when others then
             null;

     end;

     return vsCollCode;

  end getCollCodeEVEN;

  begin
      for regCrn in cuCursos loop
          htp.p(
          getCollCodeCLAS(regCrn.osdcTerm, regCrn.osdcCrnn)||csEsp||
          getCollCodeEVEN(regCrn.osdcCrnn)||csEsp
          ||' -'||regCrn.osdcDias||'- '||csEsp||
          regCrn.osdcCrnn
          );
      end loop;
  end cursos;

  procedure salta is

  begin
      if pk_login.f_validaciondeacceso(pk_login.vgsusr) then return; end if;
  end salta;

  BEGIN
      -- obtiene los valores de las cookies para asignar los valores del filtro del query:
      vsEdifCode := psEdifCode;--pk_objhtml.getvaluecookie('psedifcode');
      vsFechaRep := psFechaRep;--pk_objhtml.getvaluecookie('psfecharep');

      vsDia       := SUBSTR('MTWRFSU',TO_CHAR(TO_DATE(vsFechaRep,'DD/MM/YYYY'),'D'),1);
      vsDiaSemana := RTRIM(TO_CHAR(TO_DATE(vsFechaRep,'DD/MM/YYYY'),'Day'),' ');

      htp.p('vsEdifCode='||vsEdifCode||'<br>');
      htp.p('vsFechaRep='||vsFechaRep||'<br>');
      htp.p('vsDia='     ||vsDia     ||'<br>');

      -- obtiene la descripcin del edificio
      vsEdifDesc := descEdificio();

      -- guarda en tabla temporal informacin de los salones:
      insertSalones;

      -- guarda en tabla temporal informacin de clases y eventos:
      insertClases;
      insertEventos;

      vnExists := existenCursos;

      -- muestra el encabezado del reporte:
      IF vnExists > 0 THEN
         PK_sisRepImp.P_EncabezadoDeReporte
         (psReclDesc, 0, tabColumna, null, '1',
          psSubtitulo  =>'Edificio: &nbsp;'||vsEdifCode||' - '||vsEdifDesc||'<br>'||'Fecha: &nbsp;'||vsDiaSemana||' - '||vsFechaRep,
          psUsuario    =>PK_Login.vgsUSR,
          psUniversidad=>'UFT'
         );

         htp.p('</table>');


      -- muestra el ttulo "sala" en el encabezado de los salones:
      titulo;

      -- establece los lmites de los horarios a desplegar (07:00 a 22:00 hrs):
      vnHoraIni := 700;

      -- compara horas para procesar los crn's:
      WHILE vnHoraIni < vnHoraMax LOOP

            -- incrementa el horario en media hora:
            IF (SUBSTR(TO_CHAR(vnHoraIni + cnIncremento,'9999'),4,2) >= '60') THEN
               vnHoraFin := vnHoraIni + 70;
            ELSE
               vnHoraFin := vnHoraIni + 30;
            END IF;

            -- muestra los intervalos de los horarios:
            htp.p('<tr><th valign="top" bgcolor="#88ddef">'||SUBSTR(TO_CHAR(vnHoraIni,'0009'),2,2)||':'||SUBSTR(TO_CHAR(vnHoraIni,'0009'),4,2)||'-'
                                                           ||SUBSTR(TO_CHAR(vnHoraFin,'0009'),2,2)||':'||SUBSTR(TO_CHAR(vnHoraFin,'0009'),4,2)||'</th>');

            -- manipula la informacin de los crn's

            FOR regRom IN cuSalones LOOP
                -- alnea la informacin de cada celda del detalle:
                htp.p('<td valign="top" align="center">');

                cursos(regRom.roomCode);
            END LOOP;

            htp.p('</td></tr>');

            vnHoraIni := vnHoraFin;

      END LOOP;

      -- distribuye la informacin a lo ancho de la pgina:
      htp.p('</table>');

      END IF;

      IF vnExists > 0 THEN
         htp.p('<table width="100%" border="0">');

         -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
         PK_sisRepImp.vgsSaltoImp := 'Imprime';

         -- omite el encabezado del reporte pero agrega el salto de pgina:
         PK_sisRepImp.P_EncabezadoDeReporte(psReclDesc, 0, tabColumna, 'PIE', '0', psUsuario=>PK_Login.vgsUSR );
      ELSE
         htp.p('<tr><th><font color="#ff0000">'||PK_sisRepImp.vgsResultado||'</font></th></tr>');
      END IF;

      htp.p(
      '</table><br/>
      </body></html>'
      );

      -- limpia tablas temporales:
      DELETE TWROSDC;
      DELETE SWTRDEF;

      COMMIT;

  EXCEPTION
      WHEN OTHERS THEN
           htp.p(SQLERRM);

  END PWROCUP;
/


DROP PUBLIC SYNONYM PWROCUP;

CREATE PUBLIC SYNONYM PWROCUP FOR BANINST1.PWROCUP;


GRANT EXECUTE ON BANINST1.PWROCUP TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWROCUP TO WWW2_USER;
DROP PROCEDURE BANINST1.PWROPOR;

CREATE OR REPLACE PROCEDURE BANINST1.PWROPOR ( psReclDesc  VARCHAR2 ) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de oportunidades.
     propsito: obtener el nmero de oportunidades que ha tenido el alumno
                para cursar una materia.
        mdulo: registro curricular - uft.
         autor: hmr - horacio martnez ramrez.
         fecha: 03/11/2011.
         
          nota: antes de enviar a produccin se deben eliminar los comentarios.
*******************************************************************************/

  vnExists      INTEGER      := 0;
  vnColumnas    INTEGER      := 16;
  vgsInicioPag  VARCHAR2(30) := NULL;         -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vnIdRenglon   INTEGER      := 1;
  tabColumna    PK_sisRepImp.tipoTabla := PK_sisRepImp.tipoTabla(1);

  vsTerm        SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE  DEFAULT NULL;
  vsEscu        SIRDPCL.SIRDPCL_COLL_CODE%TYPE        DEFAULT NULL;
  vnOportInsc   NUMBER       := 0;
  vnOportAnt    NUMBER       := 0;
  vnTotalOport  NUMBER       := 0;


  -- cursor principal que obtiene la informacin de los alumnos:    (materias anteriores-hmr)
  CURSOR cuReporte ( psTerm  VARCHAR2  DEFAULT NULL,
                     psEscu  VARCHAR2  DEFAULT NULL ) IS

         SELECT DISTINCT SPRIDEN_ID                                          ID,
                SPBPERS_NAME_SUFFIX                                          RUT,
                SGBSTDN_PIDM                                                 PIDM,                -- hmr
                UPPER(REPLACE(REPLACE(SPRIDEN_LAST_NAME,'*',' '),'  ',' '))  APELLIDOS,
                UPPER(REPLACE(REPLACE(SPRIDEN_FIRST_NAME||' '||
                                      SPRIDEN_MI,'   ',' ' ),'  ',' '))      NOMBRE,
                SGBSTDN_TERM_CODE_ADMIT                                      PERIODO_ADMISION,
                SGBSTDN_PROGRAM_1                                            PROGRAMA,
                SGBSTDN_COLL_CODE_1                                          ESCUELA,
                PROM1.PROMEDIO1                                              PROMEDIO_201110,
                PROM2.PROMEDIO2                                              PROMEDIO_201125,
                N.SHRTCKN_CRN                                                CRN,
                N.SHRTCKN_SUBJ_CODE                                          SUBJ,
                N.SHRTCKN_CRSE_NUMB                                          CRSE,
                N.SHRTCKN_TERM_CODE                                          PERIODO,
                G.SHRTCKG_GRDE_CODE_FINAL                                    CALIFICACION,
                G.SHRTCKG_CREDIT_HOURS                                       CREDITOS,
                OPORTUNIDADES.MATOCUP                                        OPORTUNIDADES        -- lnea original
--              decode(oportunidades.matocup,null,1,
--                                           oportunidades.matocup+1)        oportunidades        -- hmr
           FROM SHRTCKN N,     -->  'institutional course term maintenance repeating table'
                SHRTCKG G,     -->  'institutional courses grade repeating table'
                SHRTCKL L,     -->  'institutional course maintenance level applied repeating table'
                SHRGRDE R,     -->  'grading code maintenance table'
                SGBSTDN S,     -->  'student base table'
                SPRIDEN,       -->  'person identification/name repeating table'
                SPBPERS,       -->  'basic person base table'
                (SELECT SHRTGPA_PIDM          P1PIDM,
                        SHRTGPA_TERM_CODE     P1PERIODO,
                        ROUND(SHRTGPA_GPA,2)  PROMEDIO1
                   FROM SHRTGPA
                  WHERE SHRTGPA_TERM_CODE = psTerm
                  and SHRTGPA_TERM_CODE in (select STVTERM_CODE
                                            from STVTERM
                                            where STVTERM_TRMT_CODE = 'A'))     PROM1,
                (SELECT SHRTGPA_PIDM          P2PIDM,
                        SHRTGPA_TERM_CODE     P2PERIODO, 
                        ROUND(SHRTGPA_GPA,2)  PROMEDIO2
                   FROM SHRTGPA
                  WHERE SHRTGPA_TERM_CODE = psTerm
                  and SHRTGPA_TERM_CODE in (select STVTERM_CODE
                                            from STVTERM
                                            where STVTERM_TRMT_CODE = 'S'))     PROM2,        --'201125'
------------------------>
/*              (select a.swvhiac_pidm           pidm,         -- tabla no tiene crn (hace falta agruparlo)
                        a.swvhiac_levl_code      nivel,
                        a.swvhiac_subj           subj,
                        a.swvhiac_crse           crse,
                        count(a.swvhiac_calif)   matocup
                   from swvhiac a
--                  where nvl(a.swvhiac_credit_hours,0) > 0                     -- activar hmr  (hay crditos: 0)
--                    and instr(a.swvhiac_calif,',')    > 0                     -- activar hmr  (hay calif. literales: ac)
--                    and a.swvhiac_passed_ind          = 'n'                   -- activar hmr
                 -- and swvhiac_term_code in('201110','201125')
/*                    and not exists (select 1
                                      from swvhiac c
                                     where c.swvhiac_pidm       = a.swvhiac_pidm
                                       and c.swvhiac_levl_code  = a.swvhiac_levl_code
                                       and c.swvhiac_crse       = a.swvhiac_crse
                                       and c.swvhiac_subj       = a.swvhiac_subj
                                       and c.swvhiac_passed_ind = 'y')
                  group by a.swvhiac_pidm,
                           a.swvhiac_levl_code,
                           a.swvhiac_crse,
                           a.swvhiac_subj)               oportunidades
*/
-- nuevo query:
                (SELECT A.SWVHIAC_PIDM           PIDM,         -- tabla no tiene crn (hace falta agruparlo)
                        K.SHRTCKN_CRN            CRN,
                        A.SWVHIAC_TERM_CODE      PERIODO,
                        A.SWVHIAC_LEVL_CODE      NIVEL,
                        A.SWVHIAC_SUBJ           SUBJ,
                        A.SWVHIAC_CRSE           CRSE,
                        COUNT(A.SWVHIAC_CALIF)   MATOCUP
                   FROM SWVHIAC A,
                        SHRTCKN K
--                  where a.swvhiac_pidm = '1087'
                  WHERE A.SWVHIAC_PIDM      = K.SHRTCKN_PIDM
                    AND A.SWVHIAC_TERM_CODE = K.SHRTCKN_TERM_CODE
                    AND A.SWVHIAC_SUBJ      = K.SHRTCKN_SUBJ_CODE
                    AND A.SWVHIAC_CRSE      = K.SHRTCKN_CRSE_NUMB
--                    and nvl(a.swvhiac_credit_hours,0) > 0                     -- activar hmr  (hay crditos: 0)
--                    and instr(a.swvhiac_calif,',')    > 0                     -- activar hmr  (hay calif. literales: ac)
--                    and a.swvhiac_passed_ind          = 'n'                   -- activar hmr
                 -- and swvhiac_term_code in('201110','201125')
/*                    and not exists (select 1
                                      from swvhiac c
                                     where c.swvhiac_pidm       = a.swvhiac_pidm
                                       and c.swvhiac_levl_code  = a.swvhiac_levl_code
                                       and c.swvhiac_crse       = a.swvhiac_crse
                                       and c.swvhiac_subj       = a.swvhiac_subj
                                       and c.swvhiac_passed_ind = 'y')
*/                GROUP BY A.SWVHIAC_PIDM,
                           K.SHRTCKN_CRN,
                           A.SWVHIAC_TERM_CODE,
                           A.SWVHIAC_LEVL_CODE,
                           A.SWVHIAC_SUBJ,
                           A.SWVHIAC_CRSE
                  ORDER BY A.SWVHIAC_PIDM,
                           K.SHRTCKN_CRN,
                           A.SWVHIAC_SUBJ,
                           A.SWVHIAC_CRSE)                OPORTUNIDADES         -- ok
 --<
          WHERE S.SGBSTDN_PIDM             = N.SHRTCKN_PIDM
            AND S.SGBSTDN_PIDM             = SPRIDEN_PIDM
--            and n.shrtckn_pidm             = inscritas.sfrstcr_pidm        -- lineas de prueba
--            and n.shrtckn_subj_code        = inscritas.ssbsect_subj_code   -- lineas de prueba
--            and n.shrtckn_crse_numb        = inscritas.ssbsect_crse_numb   -- lineas de prueba
            AND N.SHRTCKN_PIDM             = OPORTUNIDADES.PIDM(+)
            AND N.SHRTCKN_SUBJ_CODE        = OPORTUNIDADES.SUBJ(+)
            AND N.SHRTCKN_CRSE_NUMB        = OPORTUNIDADES.CRSE(+)
            AND S.SGBSTDN_PIDM             = PROM1.P1PIDM(+)
            AND S.SGBSTDN_PIDM             = PROM2.P2PIDM(+)
         -- and s.sgbstdn_levl_code        = oportunidades.nivel             -- anterior
         -- and n.shrtckn_term_code        = oportunidades.periodo           -- anterior
            AND S.SGBSTDN_PIDM             = SPBPERS_PIDM
--            and n.shrtckn_term_code       in ('201125','201110')             -- linea original
--            and n.shrtckn_term_code        = psterm    --'201175'  --('201125','201110')     --cancelada: 06-dic-2011  mac
            AND S.SGBSTDN_TERM_CODE_EFF    = (SELECT MAX (SS.SGBSTDN_TERM_CODE_EFF)
                                                FROM SGBSTDN SS                        
                                               WHERE SGBSTDN_PIDM = N.SHRTCKN_PIDM
                                                 AND SGBSTDN_TERM_CODE_EFF <= psTerm)   -- mac  <
            AND S.SGBSTDN_STST_CODE        = 'AS'                                       -- mac
            AND G.SHRTCKG_PIDM             = N.SHRTCKN_PIDM
            AND G.SHRTCKG_TERM_CODE        = N.SHRTCKN_TERM_CODE
            AND G.SHRTCKG_TCKN_SEQ_NO      = N.SHRTCKN_SEQ_NO
            AND G.SHRTCKG_SEQ_NO           = (SELECT MAX (G1.SHRTCKG_SEQ_NO)
                                                FROM SHRTCKG G1
                                               WHERE G1.SHRTCKG_PIDM        = G.SHRTCKG_PIDM
                                                 AND G1.SHRTCKG_TERM_CODE   = G.SHRTCKG_TERM_CODE
                                                 AND G1.SHRTCKG_TCKN_SEQ_NO = G.SHRTCKG_TCKN_SEQ_NO)
            AND L.SHRTCKL_PIDM             = N.SHRTCKN_PIDM
            AND L.SHRTCKL_TERM_CODE        = N.SHRTCKN_TERM_CODE
            AND L.SHRTCKL_TCKN_SEQ_NO      = N.SHRTCKN_SEQ_NO
            AND L.SHRTCKL_PRIMARY_LEVL_IND = 'Y'
            AND R.SHRGRDE_CODE             = G.SHRTCKG_GRDE_CODE_FINAL
            AND R.SHRGRDE_LEVL_CODE        = L.SHRTCKL_LEVL_CODE
            AND SPRIDEN_CHANGE_IND        IS NULL
            --and (s.sgbstdn_term_code_admit = psterm or psterm is null)        -- cancelada: 06-dic-2011  mac --se vuelve a poner jajajaja 18-abr-2012 aigui
            AND (S.SGBSTDN_COLL_CODE_1     = psEscu OR psEscu IS NULL)
            and G.SHRTCKG_GRDE_CODE_FINAL <> 'NV'
            and (N.SHRTCKN_TERM_CODE = psterm or psterm is null)
          ORDER BY SPRIDEN_ID, SGBSTDN_PROGRAM_1, N.SHRTCKN_CRN;


  -- cursor adicional para materias inscritas:
  CURSOR cuMatInsc ( psTerm   VARCHAR2,
                     pnPidm   NUMBER,
                     psCRN    VARCHAR2 ) IS

         SELECT F.SFRSTCR_CRN        -- cuenta_ins
           FROM SFRSTCR F,
                SSBSECT B
          WHERE F.SFRSTCR_TERM_CODE  = psTerm      --'201125'
            AND F.SFRSTCR_PIDM       = pnPidm      --6169       --10172
            AND F.SFRSTCR_CRN        = psCRN       --26009      --'25008'
            AND F.SFRSTCR_CRN        = B.SSBSECT_CRN
            AND F.SFRSTCR_TERM_CODE  = B.SSBSECT_TERM_CODE
            AND F.SFRSTCR_RSTS_CODE IN ('RW','RE');
/*            and not exists (select 1                                            -- nueva sentencia
                              from shrtckn k
                             where k.shrtckn_pidm      = f.sfrstcr_pidm
                               and k.shrtckn_term_code = f.sfrstcr_term_code
                               and k.shrtckn_crn       = f.sfrstcr_crn);
*/

  -- cursor adicional para materias anteriores:
  -- prueba:
/*
  cursor cumatant ( psterm   varchar2,
                    pnpidm   number,
                    pscrn    varchar2 ) is

         select shrtckn_crn        -- cuenta_ant
           from shrtckn
          where shrtckn_pidm       = pnpidm        --6169  --10172   --6169
            and shrtckn_crn        = pscrn
            and shrtckn_term_code <> '201125';     --'25008'    --'26009'
--          and shrtckn_term_code  < psterm;       --'201125';
*/

  -------------------------------------------------
  -- inicia bloque principal que genera el reporte
  -------------------------------------------------

   BEGIN

      -- valida que el usuario tenga acceso a la base de datos:
      IF pk_login.f_ValidaciondeAcceso(pk_login.vgsUsr) THEN RETURN; END IF;

      -- obtiene los valores de las cookies para asignar los valores del filtro del query:
      vsTerm := pk_ObjHtml.getValueCookie('psTerm');
      vsEscu := pk_ObjHtml.getValueCookie('psEscu');

      -- determina el largo de la tabla:
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      -- define los encabezados de columnas:
      tabColumna(1)  := '<center> ID';
      tabColumna(2)  := '<center> RUT';
      tabColumna(3)  := '<center> Apellidos';
      tabColumna(4)  := '<center> Nombre';
      tabColumna(5)  := '<center> Periodo de admisi&oacute;n';
      tabColumna(6)  := '<center> Programa';
      tabColumna(7)  := '<center> Escuela';
      tabColumna(8)  := '<center> Promedio Anual';
      tabColumna(9)  := '<center> Promedio Semestral';
      tabColumna(10) := '<center> CRN';
      tabColumna(11) := '<center> SUBJ';
      tabColumna(12) := '<center> CRSE';
      tabColumna(13) := '<center> Periodo';
      tabColumna(14) := '<center> Calificaci&oacute;n';
      tabColumna(15) := '<center> Cr&eacute;ditos';
      tabColumna(16) := '<center> Oportunidades';

      -- mensaje (periodo):
--      htp.p('periodo: '||vsterm||' -> ejecucin sin decode'||'<br>');

      -- manipula la informacin obtenida por el cursor:
      FOR regRep IN cuReporte (vsTerm, vsEscu) LOOP

          IF vnExists = 0 THEN

             -- muestra el encabezado segn el periodo y programa seleccionados:
             IF vsEscu IS NOT NULL THEN
                pk_sisRepImp.p_EncabezadodeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                   psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||pk_Catalogo.PERIODO(vsTerm)||'<br>'||'Escuela: &nbsp;'||vsEscu||' - '||pk_Catalogo.COLEGIO(vsEscu),
                                                   psUniversidad => 'UFT');
             ELSE
                pk_sisRepImp.p_EncabezadodeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                   psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||pk_Catalogo.PERIODO(vsTerm)||'<br>'||'Escuela: &nbsp;'||'Todas ',
                                                   psUniversidad => 'UFT');
             END IF;

             vgsInicioPag := 'SALTO';

          END IF;

      --> inscritas - hmr:
--          for regmatinsc in cumatinsc (regrep.periodo, regrep.pidm, regrep.crn) loop    --anterior
          for regMatInsc in cuMatInsc (vsTerm, regrep.PIDM, regrep.CRN) loop    --anterior
--          for regmatinsc in cumatinsc (regrep.periodo, regrep.pidm) loop

              vnOportInsc := vnOportInsc + 1;

          END LOOP;

          vnTotalOport := regrep.OPORTUNIDADES + vnOportInsc;   -- ok
--          vntotaloport := vnoportinsc;
--          vntotaloport := regrep.oportunidades;


   --> anteriores - hmr:
/*          for regmatant in cumatant (regrep.periodo, regrep.pidm, regrep.crn) loop
              vnoportant := vnoportant + 1;
          end loop;
*/--      vntotaloport := vntotaloport + vnoportant;


          -- arma el detalle del reporte:
          htp.p('<tr> <td valign="top" align="left">'   ||regRep.ID               ||'</td>
                      <td valign="top" align="left">'   ||regRep.RUT              ||'</td>
                      <td valign="top" align="left">'   ||regRep.APELLIDOS        ||'</td>
                      <td valign="top" align="left">'   ||regRep.NOMBRE           ||'</td>
                      <td valign="top" align="center">' ||regRep.PERIODO_ADMISION ||'</td>
                      <td valign="top" align="left">'   ||regRep.PROGRAMA         ||'</td>
                      <td valign="top" align="center">' ||regRep.ESCUELA          ||'</td>
                      <td valign="top" align="center">' ||regRep.PROMEDIO_201110  ||'</td>
                      <td valign="top" align="center">' ||regRep.PROMEDIO_201125  ||'</td>
                      <td valign="top" align="center">' ||regRep.CRN              ||'</td>
                      <td valign="top" align="center">' ||regRep.SUBJ             ||'</td>
                      <td valign="top" align="center">' ||regRep.CRSE             ||'</td>
                      <td valign="top" align="center">' ||regRep.PERIODO          ||'</td>
                      <td valign="top" align="center">' ||regRep.CALIFICACION     ||'</td>
                      <td valign="top" align="center">' ||regRep.CREDITOS         ||'</td>
                      <td valign="top" align="center">' ||vnTotalOport            ||'</td>
                </tr>');

    --          <!--  <td valign="top" align="center">' ||regrep.oportunidades    ||'</td>   -->
    --                <td valign="top" align="center">' ||vntotaloport            ||'</td>

          vnExists     := 1;
          vnIdRenglon  := vnIdRenglon + 1;

          vnOportInsc  := 0;  -- hmr
          vnOportAnt   := 0;  -- hmr
          vnTotalOport := 0;  -- hmr

      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||pk_sisRepImp.vgsResultado||'</font></th></tr>');
      ELSE
         -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
         pk_sisrepimp.vgsSaltoImp := 'Imprime';

         -- omite el encabezado del reporte pero se agrega el salto de pgina:
         pk_sisRepImp.p_EncabezadodeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario => pk_login.vgsUsr);
      END IF;

      htp.p('</table><br/></body></html>');

   EXCEPTION
      WHEN OTHERS THEN
           htp.p(SQLERRM);

   END PWROPOR;
/


DROP PUBLIC SYNONYM PWROPOR;

CREATE PUBLIC SYNONYM PWROPOR FOR BANINST1.PWROPOR;


GRANT EXECUTE ON BANINST1.PWROPOR TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWROPOR TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWROPOR TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWROPOR TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWROPOR TO WWW2_USER;
DROP PROCEDURE BANINST1.PWROSAL;

CREATE OR REPLACE PROCEDURE BANINST1.PWROSAL ( psReclDesc   VARCHAR2 ) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de ocupacin de salones
                por da (domino).
     propsito: obtener informacin de las clases y eventos que estn asignados,
                en un horario y fecha especficos, a cada una de las salas de
                los edificios de la universidad.
        mdulo: programacin acadmica - uft.
         autor: hmr - horacio martnez ramrez.
         fecha: 25/07/2011 (v.4).

  modificacin: 04/08/2011 - hmr
                colocacin del hipervnculo en cada celda para visualizar el
                "tooltip" (informacin adicional del crn), se elabor un
                "tooltip" para clases y otro para eventos.

*******************************************************************************/


  -- declaracin de variables:
  tabColumna   PK_sisRepImp.tipoTabla    := PK_sisRepImp.tipoTabla(1);
  vsEdifCode   STVBLDG.STVBLDG_CODE%TYPE := NULL;
  vsEdifDesc   STVBLDG.STVBLDG_DESC%TYPE := NULL;
  vsFechaRep   VARCHAR2(10)              := NULL;
  vsDiaSemana  VARCHAR2(9)               := NULL;
  vsDia        VARCHAR2(1)               := NULL;
  vnExists     INTEGER                   := 0;
  vnHoraIni    INTEGER                   := 0;
  vnHoraFin    INTEGER                   := 0;
  vnClas_Even  NUMBER                    := 0;

  vnHoraMax    CONSTANT INTEGER          := 3000;
  cnIncremento CONSTANT INTEGER          := 50;
  csDDMMYYY    CONSTANT VARCHAR2(10)     := 'DD/MM/YYYY';
  csEsp        CONSTANT VARCHAR2(1)      := ' ';


  -- obtiene los salones (ocupados y desocupados) de un edificio:
  CURSOR cuSalones IS
         SELECT SWTRDEF_ROOM_NUMBER   AS roomCode,
                SWTRDEF_DESC          AS roomDesc
           FROM SWTRDEF
          ORDER BY SWTRDEF_ROOM_NUMBER;


  -- obtiene la descripcin del edificio:
  function descEdificio return varchar2 is

    vsEdif stvbldg.stvbldg_desc%type := null;

    csEdifCode constant stvbldg.stvbldg_code%type := vsEdifCode;

  begin

     begin
        select stvbldg_desc
          into vsEdif
          from stvbldg
         where stvbldg_code = csEdifCode;

     exception
        when others then
             null;

     end;

     return vsEdif;

  end descEdificio;


  -- verifica que exista informacin en tabla temporal:
  function existenCursos return number is

  vnExists number(4) := null;

  cn1 constant number(1) := 1;

  begin
      select count(cn1)
        into vnExists
        from twrosdc;

      return vnExists;

  end existenCursos;


  -- retorna el da de bsqueda:
  function getDia return varchar2 is

  vsDay varchar2(1) := null;

  csDiaSemana constant varchar2(2) := substr(upper(to_char(to_date(vsFechaRep,'DD/MM/YYYY'),'Day')),1,2);

  begin
      select decode(csDiaSemana,'LU','M',
                                'MA','T',
                                'MI','W',
                                'JU','R',
                                'VI','F',
                                'S','S',
                                'DO','U',
                                NULL
                    )
        into vsDay
        from dual;

      return vsDay;

  end getDia;


  -- registra los salones de clase:
  procedure insertSalones is

  csEdifCode  constant stvbldg.stvbldg_code%type := vsEdifCode;
  csAC        constant varchar2(2) := 'AC';
  csC         constant varchar2(1) := 'C';
  csO         constant varchar2(1) := 'O';

  begin
      insert into swtrdef
             (swtrdef_room_number,
              swtrdef_desc
             )
             select sl.slbrdef_room_number,
                    sl.slbrdef_desc
               from slbrdef sl
              where sl.slbrdef_term_code_eff = (select max(b.slbrdef_term_code_eff)
                                                  from slbrdef b
                                                 where b.slbrdef_room_number  = sl.slbrdef_room_number
                                                   and b.slbrdef_bldg_code    = sl.slbrdef_bldg_code
                                                   and b.slbrdef_room_number is not null
                                                   and b.slbrdef_priority    is not null
                                               )
                and sl.slbrdef_room_number is not null
                and sl.slbrdef_priority    is not null
                and sl.slbrdef_rmst_code    = csAC
                and sl.slbrdef_room_type   in (csC, csO)
                and sl.slbrdef_bldg_code    = csEdifCode;

  end insertSalones;


  -- determina los ttulos del detalle (sala y hora):
  procedure p_Titulo is

  begin
      htp.p('<table border="1" bordercolor="#cccccc">
                    <tr><th bgcolor="#dddddd">
                        </th>
                        <th bgcolor="#bbffff">
                         SALA
                        </th>
                    </tr>
                    <tr><th bgcolor="#88ddef">
                         HORA
                        </th>
            ');

      -- muestra en el encabezado horizontal los nombres de los salones:
      for regRom in cuSalones loop

          htp.p('<th align="center" bgcolor="#bbffff" title="'||regRom.roomDesc||'">'||regRom.roomCode||'</th>');

      end loop;

      htp.p('</tr>');

  end p_Titulo;


  -- guarda en tabla temporal la informacin de clases:
  procedure insertClases is

  csEdifCode  constant stvbldg.stvbldg_code%type := vsEdifCode;
  csFechaRep  constant date                      := to_date(vsFechaRep, csDDMMYYY);
  csCLAS      constant varchar2(4)               := 'CLAS';
  csDia       constant varchar2(1)               := vsDia;

  begin
      insert into twrosdc
             (twrosdc_crn,
              twrosdc_term_code,
              twrosdc_hora_inicio,
              twrosdc_hora_fin,
              twrosdc_dias_semana,
              twrosdc_edificio_code,
              twrosdc_room_code,
              twrosdc_tipo
             )
             select
              ssrmeet_crn,
              ssrmeet_term_code,
              ssrmeet_begin_time,
              ssrmeet_end_time,
              ssrmeet_sun_day||ssrmeet_mon_day||ssrmeet_tue_day||ssrmeet_wed_day||ssrmeet_thu_day||ssrmeet_fri_day||ssrmeet_sat_day,
              csEdifCode,
              ssrmeet_room_code,
              csCLAS
               from ssrmeet
              where exists (select null
                              from ssbsect
                             where ssbsect_crn       = ssrmeet_crn
                               and ssbsect_term_code = ssrmeet_term_code
                            )
                and ssrmeet_room_code         in (select swtrdef_room_number
                                                    from swtrdef
                                                  )
                and csDia                     in (nvl(ssrmeet_sun_day,csEsp),
                                                  nvl(ssrmeet_mon_day,csEsp),
                                                  nvl(ssrmeet_tue_day,csEsp),
                                                  nvl(ssrmeet_wed_day,csEsp),
                                                  nvl(ssrmeet_thu_day,csEsp),
                                                  nvl(ssrmeet_fri_day,csEsp),
                                                  nvl(ssrmeet_sat_day,csEsp)
                                                  )
                and trunc(ssrmeet_start_date) <= csFechaRep
                and trunc(ssrmeet_end_date)   >= csFechaRep
                and ssrmeet_bldg_code          = csEdifCode
              order by ssrmeet_begin_time;

  end insertClases;


  -- guarda en tabla temporal la informacin de eventos:
  procedure insertEventos is

  csEdifCode  constant stvbldg.stvbldg_code%type := vsEdifCode;
  csFechaRep  constant date                      := to_date(vsFechaRep, csDDMMYYY);
  csEVEN      constant varchar2(4)               := 'EVEN';
  csDia       constant varchar2(1)               := vsDia;

  begin
      insert into twrosdc
             (twrosdc_crn,
              twrosdc_term_code,
              twrosdc_hora_inicio,
              twrosdc_hora_fin,
              twrosdc_dias_semana,
              twrosdc_edificio_code,
              twrosdc_room_code,
              twrosdc_tipo
             )
             select
              ssrmeet_crn,
              ssrmeet_term_code,
              ssrmeet_begin_time,
              ssrmeet_end_time,
              ssrmeet_sun_day||ssrmeet_mon_day||ssrmeet_tue_day||ssrmeet_wed_day||ssrmeet_thu_day||ssrmeet_fri_day||ssrmeet_sat_day,
              csEdifCode,
              ssrmeet_room_code,
              csEVEN
               from ssrmeet
              where exists (select null
                              from slbevnt
                             where slbevnt_crn = ssrmeet_crn
                            )
                and ssrmeet_room_code         in (select swtrdef_room_number
                                                    from swtrdef
                                                  )
                and csDia                     in (nvl(ssrmeet_sun_day,csEsp),
                                                  nvl(ssrmeet_mon_day,csEsp),
                                                  nvl(ssrmeet_tue_day,csEsp),
                                                  nvl(ssrmeet_wed_day,csEsp),
                                                  nvl(ssrmeet_thu_day,csEsp),
                                                  nvl(ssrmeet_fri_day,csEsp),
                                                  nvl(ssrmeet_sat_day,csEsp)
                                                  )
                and trunc(ssrmeet_start_date) <= csFechaRep
                and trunc(ssrmeet_end_date)   >= csFechaRep
                and ssrmeet_bldg_code          = csEdifCode
              order by ssrmeet_begin_time;

  end insertEventos;


  -- obtiene informacin para el tooltip de clases:
  procedure P_ToolTipCLAS ( psCrnn   varchar2,
                            psHini   varchar2 ) is

    cursor cuToolTipCLAS is

           select distinct s.ssrmeet_crn                                     as Crn,
                  substr(to_char(s.ssrmeet_begin_time,'0009'),2,2)||':'||
                  substr(to_char(s.ssrmeet_begin_time,'0009'),4,2)           as Hini,
                  substr(to_char(s.ssrmeet_end_time,'0009'),2,2)||':'||
                  substr(to_char(s.ssrmeet_end_time,'0009'),4,2)             as Hfin,
                  b.ssbsect_crse_numb                                        as Crse,
                  (select distinct upper(c.scbcrse_title)
                     from scbcrse c
                    where c.scbcrse_subj_code = b.ssbsect_subj_code
                      and c.scbcrse_crse_numb = b.ssbsect_crse_numb)         as Title,
                  (select replace(p.spriden_first_name||' '||p.spriden_last_name,'*',' ')
                     from spriden p,
                          sirasgn n
                    where p.spriden_pidm        = n.sirasgn_pidm
                      and p.spriden_change_ind is null
                      and n.sirasgn_crn         = i.sirasgn_crn
                      and n.sirasgn_term_code   = i.sirasgn_term_code
                      and n.sirasgn_primary_ind = 'Y')                       as Docen
             from ssrmeet s,
                  ssbsect b,
                  sirasgn i
            where s.ssrmeet_crn        = pscrnn
              and s.ssrmeet_begin_time = pshini
              and s.ssrmeet_term_code  = b.ssbsect_term_code
              and s.ssrmeet_crn        = b.ssbsect_crn
              and s.ssrmeet_term_code  = i.sirasgn_term_code(+)
              and s.ssrmeet_crn        = i.sirasgn_crn(+);

  begin

     for regInf in cuToolTipCLAS loop

         htp.p(' ');
         htp.p('&nbsp; &nbsp;CRN: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '||regInf.Crn||' &nbsp;');
         htp.p('&nbsp; &nbsp;Hora Inicio: &nbsp; '||regInf.Hini||' hrs. &nbsp;');
         htp.p('&nbsp; &nbsp;Hora Fin: &nbsp; &nbsp; &nbsp; '||regInf.Hfin||' hrs. &nbsp;');
         htp.p('&nbsp; &nbsp;CRSE: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'||regInf.Crse||' &nbsp;');
         htp.p('&nbsp; &nbsp;T&iacute;tulo: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'||regInf.Title||' &nbsp;');
         htp.p('&nbsp; &nbsp;Docente: &nbsp; &nbsp; &nbsp; '||regInf.Docen||' &nbsp;');

     end loop;

  end P_ToolTipCLAS;


  -- obtiene informacin para el tooltip de eventos:
  procedure P_ToolTipEVEN ( psCrn    varchar2,
                            psHini   varchar2 ) is

    cursor cuToolTipEVEN is

           select distinct s.ssrmeet_crn                                     as Crn,
                  substr(to_char(s.ssrmeet_begin_time,'0009'),2,2)||':'||
                  substr(to_char(s.ssrmeet_begin_time,'0009'),4,2)           as Hini,
                  substr(to_char(s.ssrmeet_end_time,'0009'),2,2)||':'||
                  substr(to_char(s.ssrmeet_end_time,'0009'),4,2)             as Hfin,
                  upper(b.slbevnt_desc)                                      as Descr
             from ssrmeet s,
                  sirasgn i,
                  slbevnt b
            where s.ssrmeet_crn        = pscrn
              and s.ssrmeet_begin_time = pshini
              and s.ssrmeet_term_code  = i.sirasgn_term_code(+)
              and s.ssrmeet_crn        = i.sirasgn_crn(+)
              and s.ssrmeet_crn        = b.slbevnt_crn;

  begin

     for regInf in cuToolTipEVEN loop

         htp.p(' ');
         htp.p('&nbsp; &nbsp;CRN: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '||regInf.Crn||' &nbsp;');
         htp.p('&nbsp; &nbsp;Hora Inicio: &nbsp; '||regInf.Hini||' hrs. &nbsp;');
         htp.p('&nbsp; &nbsp;Hora Fin: &nbsp; &nbsp; &nbsp; '||regInf.Hfin||' hrs. &nbsp;');
         htp.p('&nbsp; &nbsp;Descripci&oacute;n: &nbsp;'||regInf.Descr||' &nbsp;');

     end loop;

  end P_ToolTipEVEN;


  -- obtiene los cursos programados:
  procedure cursos ( psRoom   varchar2 ) is

    cn0        constant number(1)   := 0;
    cnHoraIni  constant number(4)   := vnHoraIni+1;
    cnHoraFin  constant number(4)   := vnHoraFin-1;
    csDia      constant varchar2(1) := vsDia;
    vsCollDescCLAS    varchar2(60)  := '';

    cursor cuCursos is
           select distinct twrosdc_crn    as osdcCrnn,
                  twrosdc_term_code       as osdcTerm,
                  twrosdc_dias_semana     as osdcDias,
                  twrosdc_hora_inicio     as osdcHini
             from twrosdc
            where instr(twrosdc_dias_semana, csDia) > cn0
              and (
                     (cnhoraini between twrosdc_hora_inicio and twrosdc_hora_fin)
                   or
                     (cnhorafin between twrosdc_hora_inicio and twrosdc_hora_fin)
                   )
              and twrosdc_room_code = psRoom
            order by twrosdc_hora_inicio;


    -- obtiene el cdigo de escuela de la clase:
    function getCollCodeCLAS ( psTerm  varchar2,
                               psCrn   varchar2 ) return varchar2 is

      vsCollCode ssbovrr.ssbovrr_coll_code%type := null;

    begin
       begin

          select decode(ssbovrr_coll_code, null, scbcrse_coll_code, ssbovrr_coll_code)
            into vsCollCode
            from scbcrse a,
                 ssbsect,
                 ssbovrr
           where a.scbcrse_subj_code = ssbsect_subj_code
             and a.scbcrse_crse_numb = ssbsect_crse_numb
             and a.scbcrse_eff_term  = (select max(b.scbcrse_eff_term)
                                          from scbcrse b
                                         where b.scbcrse_subj_code = a.scbcrse_subj_code
                                           and b.scbcrse_crse_numb = a.scbcrse_crse_numb
                                        )
             and ssbsect_term_code   = ssbovrr_term_code(+)
             and ssbsect_crn         = ssbovrr_crn(+)
             and ssbsect_crn         = psCrn
             and ssbsect_term_code   = psTerm;

       exception
          when no_data_found then
               null;
          when others then
               null;
       end;

       return vsCollCode;

    end getCollCodeCLAS;


    -- obtiene el cdigo de escuela del evento:
    function getCollCodeEVEN ( psCrn   varchar2 ) return varchar2 is

      vsCollCode slbevnt.slbevnt_coll_code%type := null;

    begin
       begin
          select slbevnt_coll_code
            into vsCollCode
            from slbevnt
           where slbevnt_crn = psCrn;

       exception
          when no_data_found then
               null;
          when others then
               null;
       end;

       return vsCollCode;

    end getCollCodeEVEN;


  -- determina si el crn es de clase o de evento:
  function Clase_Evento ( psCrn   varchar2,
                          psTerm  varchar2 ) return varchar2 is

  -- si encuentra registros es una clase, de lo contrario es un evento:
  begin
     select 1
       into vnClas_Even
       from ssbsect
      where ssbsect_crn       = psCrn
        and ssbsect_term_code = psTerm;

     return vnClas_Even;

  exception
     when no_data_found then
          vnClas_Even := 0;
          return vnClas_Even;
     when others then
          vnClas_Even := 0;
          return vnClas_Even;

  end Clase_Evento;


  -- despliega la informacin de la clase o del evento:
  begin

      for regCrn in cuCursos loop

          -- determina si es clase o evento:
          if Clase_Evento(regcrn.osdccrnn,regcrn.osdcterm) > 0 then    -- aplica cuando es clase:

             htp.p('<a href="#"><font title="&nbsp;Informaci&oacute;n general de la CLASE: ');

             -- obtiene datos del crn para ventana del tooltip:
             P_ToolTipCLAS (regcrn.osdccrnn, regcrn.osdchini);

             -- muestra el hipervculo:
             htp.p('">'||getCollCodeCLAS(regcrn.osdcterm, regcrn.osdccrnn)||csesp||
                         getCollCodeEVEN(regcrn.osdccrnn)||csesp||
                         regcrn.osdccrnn||
                   '</font></a>');

          else                                                        -- aplica cuando es evento:

             htp.p('<a href="#"><font title="&nbsp;Informaci&oacute;n general del EVENTO: ');

             -- obtiene datos del crn para ventana del tooltip:
             P_ToolTipEVEN (regcrn.osdccrnn, regcrn.osdchini);

             -- muestra el hipervculo:
             htp.p('">'||getCollCodeCLAS(regcrn.osdcterm, regcrn.osdccrnn)||csesp||
                         getCollCodeEVEN(regcrn.osdccrnn)||csesp||
                         regcrn.osdccrnn||
                   '</font></a>');

          end if;

      end loop;

  end cursos;


  -------------------------------------------------
  -- inicia bloque principal que genera el reporte
  -------------------------------------------------
  BEGIN

      -- valida que el usuario tenga acceso a la base de datos:
      IF pk_login.f_ValidaciondeAcceso(pk_login.vgsusr) THEN RETURN; END IF;

      -- obtiene los valores de las cookies para asignar los valores del filtro del query:
      vsEdifCode  := pk_objhtml.getvaluecookie('psEdifi');
      vsFechaRep  := pk_objhtml.getvaluecookie('psFecha');

      vsDia       := getDia();
      vsDiaSemana := RTRIM(TO_CHAR(TO_DATE(vsFechaRep,'DD/MM/YYYY'),'Day'),' ');

      -- obtiene la descripcin del edificio:
      vsEdifDesc := descEdificio();

      -- guarda en tabla temporal informacin de los salones:
      insertSalones;

      -- guarda en tabla temporal informacin de clases y eventos:
      insertClases;
      insertEventos;

      vnExists := existenCursos;

      -- muestra el encabezado del reporte:
      IF vnExists > 0 THEN
         PK_sisRepImp.P_EncabezadoDeReporte ( psReclDesc, 0, tabColumna, null, '1',
                                              psSubtitulo   => 'Edificio: &nbsp;'||vsEdifCode||' - '||vsEdifDesc||'<br>'||'Fecha: &nbsp;'||vsDiaSemana||' - '||vsFechaRep,
                                              psUsuario     => PK_Login.vgsUSR,
                                              psUniversidad => 'UFT'
                                             );

         htp.p('</table>');

      -- muestra los ttulos del detalle (sala y hora):
      p_Titulo;

      -- establece el inicio de los horarios (07:00 am):
      vnHoraIni := 700;

      -- compara horas para procesar los crn's:
      WHILE vnHoraIni < vnHoraMax LOOP

            -- incrementa el horario en media hora:
            IF (SUBSTR(TO_CHAR(vnHoraIni + cnIncremento,'9999'),4,2) >= '60') THEN
               vnHoraFin := vnHoraIni + 70;
            ELSE
               vnHoraFin := vnHoraIni + 30;
            END IF;

            -- muestra los intervalos de los horarios:
            htp.p('<tr><th valign="top" bgcolor="#88ddef">'||SUBSTR(TO_CHAR(vnHoraIni,'0009'),2,2)||':'||SUBSTR(TO_CHAR(vnHoraIni,'0009'),4,2)||'-'
                                                           ||SUBSTR(TO_CHAR(vnHoraFin,'0009'),2,2)||':'||SUBSTR(TO_CHAR(vnHoraFin,'0009'),4,2)||
                  '</th>');

            -- manipula la informacin de los crn's:
            FOR regRom IN cuSalones LOOP

                -- alnea la informacin de cada celda del detalle:
                htp.p('<td valign="top" align="center">');

                cursos(regRom.roomCode);

            END LOOP;

            htp.p('</td></tr>');

            vnHoraIni := vnHoraFin;

      END LOOP;

      -- distribuye la informacin a lo ancho de la pgina:
      htp.p('</table>');

      END IF;

      -- establece el pie de reporte:
      IF vnExists > 0 THEN
         htp.p('<table width="100%" border="0">');

         -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
         PK_sisRepImp.vgsSaltoImp := 'Imprime';

         -- omite el encabezado del reporte pero agrega el salto de pgina:
         PK_sisRepImp.P_EncabezadoDeReporte(psReclDesc, 0, tabColumna, 'PIE', '0', psUsuario=>PK_Login.vgsUSR );

      ELSE
         htp.p('<tr><th><font color="#ff0000">'||PK_sisRepImp.vgsResultado||'</font></th></tr>');

      END IF;

      htp.p('</table><br/>
             </body></html>'
            );

      -- limpia tablas temporales:
      DELETE TWROSDC;
      DELETE SWTRDEF;

      COMMIT;

  EXCEPTION
      WHEN OTHERS THEN
           htp.p(SQLERRM);

  END PWROSAL;
/


DROP PUBLIC SYNONYM PWROSAL;

CREATE PUBLIC SYNONYM PWROSAL FOR BANINST1.PWROSAL;


GRANT EXECUTE ON BANINST1.PWROSAL TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWROSAL TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRPARM;

CREATE OR REPLACE PROCEDURE BANINST1.PWRPARM (psReporte      VARCHAR2,
                            psCollcode     VARCHAR2 DEFAULT NULL,
                            psReturnUrl    VARCHAR2 DEFAULT NULL,
                            psReturnTex    VARCHAR2 DEFAULT NULL)
IS
   vsDesc   SWBRECL.SWBRECL_DESC%TYPE := NULL;
   vsRecm   SWBRECL.SWBRECL_RECMCODE%TYPE := NULL;
   vnPidm   SPRIDEN.SPRIDEN_PIDM%TYPE := NULL;
BEGIN
 --  IF NOT twbkwbis.f_validuser (vnPidm) THEN RETURN; END IF;
   IF PK_Login.F_ValidacionDeAcceso (PK_Login.vgsUSR) THEN RETURN; END IF;

     SELECT SWBRECL_DESC, MIN (SWBRECL_RECMCODE)
       INTO vsDesc, vsRecm
       FROM SWBRECL
      WHERE SWBRECL_NOMBRE = psReporte
   GROUP BY SWBRECL_DESC;

   bwckfrmt.p_open_doc (psReporte);

   twbkwbis.P_DispInfo (psReporte, 'INSTRUCCIONES');

   HTP.p ('<br/>');

   PK_SisRepMnu.P_Reporte (psReporte,
                           vsDesc,
                           psReporte,
                           NULL,
                           psCollcode,
                           'SIU');

   HTP.p ('<br/>');

   IF psReturnUrl IS NOT NULL AND psReturnTex IS NOT NULL
   THEN
      HTP.
       p (
            '<table border="0" cellpadding="1" cellspacing="1" width="100%">
          <tr><td width="22%"></td>
              <td width="78%">
              <a href="'
         || psReturnUrl
         || '" onMouseOver="window.status='''
         || psReturnTex
         || '''; return true;"  onMouseOut="window.status=''''; return true;" class="submenulinktext2">'
         || psReturnTex
         || '</a>
              </td>
          </table><br/><br/>
         ');
   END IF;

   twbkwbis.P_CloseDoc;

   HTP.p ('<br/><br/><br/><br/>');
END PWRPARM;
/


DROP PUBLIC SYNONYM PWRPARM;

CREATE PUBLIC SYNONYM PWRPARM FOR BANINST1.PWRPARM;


GRANT EXECUTE ON BANINST1.PWRPARM TO WWW_USER;
DROP PROCEDURE BANINST1.PWRPGAC;

CREATE OR REPLACE PROCEDURE BANINST1.PWRPGAC(psReclDesc VARCHAR2) IS

/*
        Nombre: REPORTE DE PROGRAMACIN ACADMICA
         Fecha: 12/05/2006.
         Autor: VBZ

  Modificacin: 26/08/2008
                GEPC
                *Para obtener la columna "Tipo de Docente", se debe incluir en la validacin el valor del parmetro del periodo, ya que actualmente
                 despliega el ultimo status obtenido del docente, lo cual es incorrecto. Anexo un ejemplo.

                 Ej: para el 200810, indica que el Id 00014009 tiene Planta con pago (este dato es del 200860) cuando en realidad debera desplegar que es Honorarios (que es el dato de 200810).


  Modificacin: 13/marzo/2009
                MAHH
                Se agrega campo de categoria


  Modificacin: 02/07/2008
                CCR
                Se agrego parametro parte periodo


  Modificacin: 11/11/2009
                EAMM
                Se agrego la funcionalidad de multi opciones en los parametros de periodo y parte periodo

  Modificacin: 24/03/2010
                GEPC
                * En el filtro de parte de periodo se corique el filtro: "psPtrm IS NULL" por "psPtrm='/'"

  Modificacin: 21 ENE 2011
                JCCR
               * Valor del campo meetCatg, Se Modifico proceso PWAISSBSECT  para obtener nuevo valor en campo SWRPGAC_SESS_CODE




*/

  vnExists    INTEGER                := 0;
  vnColumnas  INTEGER                := 35;
  tabColumna  Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vsCampCode  VARCHAR2(6)            := NULL;
  vsTermCode  VARCHAR2(1000)         := NULL;
  vsTerm      VARCHAR2(8)            := NULL;
  vsCollCode  VARCHAR2(3)            := NULL;
  vsSubjCode  VARCHAR2(4)            := NULL;
  vsSstsCode  VARCHAR2(2)            := NULL;
  vsPtrmCode  VARCHAR2(1000)         := NULL;
  vsBldgCode  VARCHAR2(50)           := NULL;
  vsStarDate  VARCHAR2(50)           := NULL;
  vsEnddDate  VARCHAR2(50)           := NULL;
  vsFstpCode  VARCHAR2(50)           := NULL;
  vsInicoPag  VARCHAR2(10)           := NULL;
  vsXlstType  VARCHAR2(2)            := NULL;
  vsFattCode  VARCHAR2(10)           := NULL;
  vsSeccion   VARCHAR2(3)            := NULL;
  vnIngresado VARCHAR2(300);
  vnIngresadoDef VARCHAR2(300);

  csAC      CONSTANT VARCHAR2(2)  := 'AC';
  csEsp     CONSTANT VARCHAR2(1)  := ' ';
  csM       CONSTANT VARCHAR2(1)  := 'M';
  csT       CONSTANT VARCHAR2(1)  := 'T';
  csW       CONSTANT VARCHAR2(1)  := 'W';
  csR       CONSTANT VARCHAR2(1)  := 'R';
  csF       CONSTANT VARCHAR2(1)  := 'F';
  csS       CONSTANT VARCHAR2(1)  := 'S';
  csP       CONSTANT VARCHAR2(1)  := 'P';
  csLu      CONSTANT VARCHAR2(2)  := 'Lu';
  csMa      CONSTANT VARCHAR2(2)  := 'Ma';
  csMi      CONSTANT VARCHAR2(2)  := 'Mi';
  csJu      CONSTANT VARCHAR2(2)  := 'Ju';
  csVi      CONSTANT VARCHAR2(2)  := 'Vi';
  csSa      CONSTANT VARCHAR2(2)  := 'Sa';
  cs2p      CONSTANT VARCHAR2(1)  := ':';
  cs1       CONSTANT VARCHAR2(1)  := '1';
  cs00      CONSTANT VARCHAR2(2)  := '00';
  csAst     CONSTANT VARCHAR2(1)  := '*';
  csSlh     CONSTANT VARCHAR2(1)  := '/';
  csEne     CONSTANT VARCHAR2(1)  := '';
  csTil     CONSTANT VARCHAR2(8)  := '&ntilde;';
  csMas     CONSTANT VARCHAR2(6)  := 'Master';
  csSml     CONSTANT VARCHAR2(10) := 'Simultneo';
  csInd     CONSTANT VARCHAR2(13) := 'Independiente';
  csPeriodo CONSTANT VARCHAR2(8)  := 'Periodo ';

  CURSOR cuReporte IS
         SELECT SWRPGAC_TERM_CODE        AS termCode,
                SWRPGAC_CAMP_CODE        AS campCode,
                SWRPGAC_CRN              AS sectCrnn,
                Pk_Catalogo.STATUS_1(SWRPGAC_SSTS_CODE) AS sstsCode,
                Pk_Catalogo.SCHDTYPE(SWRPGAC_SCHD_CODE) AS schdCode,
                Pk_Catalogo.INSTMETH(SWRPGAC_INSM_CODE) AS insmCode,
                SWRPGAC_PTRM_CODE        AS ptrmCode,
                SWRPGAC_SUBJ_CODE        AS subjCode,
                SWRPGAC_CRSE_NUMB        AS crseNumb,
                SWRPGAC_TITLE            AS crseTitl,
                SWRPGAC_CONT_HR_LOW      AS contHrLw,
                SWRPGAC_CREDIT_HR_LOW    AS credHrLw,
                SWRPGAC_SEQ_NUMB         AS seqqNumb,
                SWRPGAC_MAX_ENRL         AS maxxEnrl,
                SWRPGAC_ENRL             AS sectEnrl,
                Pk_Catalogo.COLEGIO(SWRPGAC_COLL_CODE) AS collCode,
                FWRHORS_HRS_WEEK         AS hrssWeek,
                FWRHORS_MON_DAY          AS meetMonn,
                FWRHORS_TUE_DAY          AS meetTuee,
                FWRHORS_WED_DAY          AS meetWedd,
                FWRHORS_THU_DAY          AS meetThuu,
                FWRHORS_FRI_DAY          AS meetFrii,
                FWRHORS_SAT_DAY          AS meetSatt,
                FWRHORS_BEGIN_TIME       AS begnTime,
                FWRHORS_END_TIME         AS enddTime,
                FWRHORS_BLDG_CODE        AS bldgCode,
                FWRHORS_ROOM_CODE        AS roomCode,
                FWRHORS_PERCENT_RESPONSE AS prcnResp,
                Pk_Catalogo.Tipo(FWRHORS_FSTP_CODE) AS fstpCode,
                SWRPGAC_SESS_CODE        AS meetCatg,
                Pk_Catalogo.Categoria(FWRHOR_FCTG_CODE) AS fctgCode,
                SPRIDEN_ID               AS idenIDdd,
                REPLACE(REPLACE(SPRIDEN_LAST_NAME||csEsp||
                SPRIDEN_FIRST_NAME||csEsp||SPRIDEN_MI,csEne,csTil),csAst,csEsp) AS idenName,
                FWRXLST_XLST_GROUP                                              AS xlstGrup,
                DECODE(FWRXLST_TYPE ,csM,csMas,csS,csSml,csInd)                 AS xlstType
           FROM SPRIDEN,
                FWRHORS,
                SWRPGAC,
                FWRXLST
          WHERE FWRHORS_PIDM        = SPRIDEN_PIDM(+)
            AND SPRIDEN_CHANGE_IND IS NULL
            AND SWRPGAC_TERM_CODE   = FWRHORS_TERM_CODE(+)
            AND SWRPGAC_CRN         = FWRHORS_CRN(+)
            AND SWRPGAC_TERM_CODE   = FWRXLST_TERM_CODE(+)
            AND SWRPGAC_CRN         = FWRXLST_CRN(+)
            AND (FWRXLST_TYPE       = vsXlstType OR vsXlstType IS NULL)
            AND (FWRHORS_FSTP_CODE  = vsFstpCode OR vsFstpCode IS NULL)
            AND (
                   (vsFattCode IS NULL)
                 OR
                   (
                       (vsFattCode IS NOT NULL)
                    AND
                       EXISTS (SELECT NULL
                                 FROM SIRATTR A
                                WHERE A.SIRATTR_TERM_CODE_EFF = (SELECT MAX(B.SIRATTR_TERM_CODE_EFF)
                                                                   FROM SIRATTR B
                                                                  WHERE B.SIRATTR_PIDM = SPRIDEN_PIDM
                                                                )
                                  AND A.SIRATTR_PIDM          = SPRIDEN_PIDM
                                  AND A.SIRATTR_FATT_CODE     = vsFattCode
                              )
                   )
                )
          ORDER BY SWRPGAC_TERM_CODE DESC, SWRPGAC_COLL_CODE,FWRXLST_XLST_GROUP,SWRPGAC_SUBJ_CODE;

     cursor cuIngresado(psTerm varchar2,psCrn varchar2) is select SSRSRDF_RDEF_CODE as SSRSRDF_CODE, STVRDEF_DESC
                 from SSRSRDF,STVRDEF
                    where
                       SSRSRDF_TERM_CODE =psTerm
                  and SSRSRDF_CRN=psCrn
                  and SSRSRDF_RDEF_CODE=STVRDEF_CODE;

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.

      vsTermCode := NVL(pk_objHtml.getValueCookie('psPerio'),csSlh);
      vsCollCode := pk_objHtml.getValueCookie('psFacu');
      vsSubjCode := pk_objHtml.getValueCookie('psSubjc');
      vsFstpCode := pk_objHtml.getValueCookie('psType');
      vsSstsCode := pk_objHtml.getValueCookie('psStat1');
      vsBldgCode := pk_objHtml.getValueCookie('psEdifi');
      vsXlstType := pk_objHtml.getValueCookie('psTipol');
      vsFattCode := pk_objHtml.getValueCookie('psAtbs');
      vsStarDate := pk_objHtml.getValueCookie('psHrDe');
      vsEnddDate := pk_objHtml.getValueCookie('psHrA');
      vsSeccion  := pk_objHtml.getValueCookie('cookSeccion');
      vsPtrmCode := NVL(pk_objHtml.getValueCookie('psPtrm'),csSlh);

      WHILE INSTR(vsTermCode, csSlh) > 0  LOOP
            vsTerm := SUBSTR(vsTermCode, 1, INSTR(vsTermCode,csSlh)-1);

            PWAISSBSECT(vsCampCode,vsTerm,vsCollCode,vsSubjCode,vsSstsCode,vsPtrmCode);

            vsTermCode := SUBSTR(vsTermCode, INSTR(vsTermCode,csSlh)+1);
      END LOOP ;

      INSERT INTO FWRHORS
      (FWRHORS_PIDM,       FWRHORS_TERM_CODE, FWRHORS_CRN,       FWRHORS_CATAGORY,
       FWRHORS_HRS_WEEK,   FWRHORS_MON_DAY,   FWRHORS_TUE_DAY,   FWRHORS_WED_DAY,
       FWRHORS_THU_DAY,    FWRHORS_FRI_DAY,   FWRHORS_SAT_DAY,   FWRHORS_BEGIN_TIME,
       FWRHORS_END_TIME,   FWRHORS_BLDG_CODE, FWRHORS_ROOM_CODE, FWRHORS_PERCENT_RESPONSE,
       FWRHORS_FSTP_CODE,  FWRHOR_FCTG_CODE
       )
      SELECT
       sirasg.asgnPidm,    sirasg.termCode,   sirasg.meetCrnn,   sirasg.meetCatg,
       sirasg.hrssWeek,    sirasg.meetMonn,   sirasg.meetTuee,   sirasg.meetWedd,
       sirasg.meetThuu,    sirasg.meetFrii,   sirasg.meetSatt,   sirasg.begnTime,
       sirasg.enddTime,    sirasg.bldgCode,   sirasg.roomCode,   sirasg.prcnResp,
       (SELECT A.SIBINST_FSTP_CODE
          FROM SIBINST A
         WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(B.SIBINST_TERM_CODE_EFF)
                                          FROM SIBINST B
                                         WHERE B.SIBINST_PIDM           = sirasg.asgnPidm
                                           AND B.SIBINST_TERM_CODE_EFF <= sirasg.termCode
                                        )
           AND A.SIBINST_FCST_CODE = csAC
           AND A.SIBINST_PIDM      = sirasg.asgnPidm
       ) fstpCode,
       (SELECT A.SIBINST_FCTG_CODE
          FROM SIBINST A
         WHERE SIBINST_TERM_CODE_EFF = (SELECT MAX(B.SIBINST_TERM_CODE_EFF)
                                          FROM SIBINST B
                                         WHERE B.SIBINST_PIDM           = sirasg.asgnPidm
                                           AND B.SIBINST_TERM_CODE_EFF <= sirasg.termCode
                                        )
           AND A.SIBINST_FCST_CODE = csAC
           AND A.SIBINST_PIDM      = sirasg.asgnPidm
       ) fctgCode
         FROM (SELECT SIRASGN_PIDM                                        asgnPidm,
                      SSRMEET_TERM_CODE                                   termCode,
                      SSRMEET_CRN                                         meetCrnn,
                      SSRMEET_CATAGORY                                    meetCatg,
                      SUM(NVL(SSRMEET_HRS_WEEK,0))                        hrssWeek,
                      DECODE(SSRMEET_MON_DAY, csM, csLu, SSRMEET_MON_DAY) meetMonn,
                      DECODE(SSRMEET_TUE_DAY, csT, csMa, SSRMEET_TUE_DAY) meetTuee,
                      DECODE(SSRMEET_WED_DAY, csW, csMi, SSRMEET_WED_DAY) meetWedd,
                      DECODE(SSRMEET_THU_DAY, csR, csJu, SSRMEET_THU_DAY) meetThuu,
                      DECODE(SSRMEET_FRI_DAY, csF, csVi, SSRMEET_FRI_DAY) meetFrii,
                      DECODE(SSRMEET_SAT_DAY, csS, csSa, SSRMEET_SAT_DAY) meetSatt,
                      SUBSTR(SSRMEET_BEGIN_TIME,1,2)||cs2p||
                      NVL(SUBSTR(SSRMEET_BEGIN_TIME,3,2),cs00)            begnTime,
                      SUBSTR(SSRMEET_END_TIME,1,2)||cs2p||
                      NVL(SUBSTR(SSRMEET_END_TIME,3,2),cs00)              enddTime,
                      SSRMEET_BLDG_CODE                                   bldgCode,
                      SSRMEET_ROOM_CODE                                   roomCode,
                      SIRASGN_PERCENT_RESPONSE                            prcnResp
                 FROM SSRMEET,
                      SIRASGN
                WHERE SSRMEET_TERM_CODE = SIRASGN_TERM_CODE(+)
                  AND SSRMEET_CRN       = SIRASGN_CRN(+)
                  AND SSRMEET_CATAGORY  = SIRASGN_CATEGORY(+)
                  AND (SSRMEET_BLDG_CODE = vsBldgCode OR vsBldgCode IS NULL)
                  AND (SSRMEET_CRN,SSRMEET_TERM_CODE) IN (SELECT SWRPGAC_CRN,SWRPGAC_TERM_CODE
                                                            FROM SWRPGAC
                                                         )
                 GROUP BY SIRASGN_PIDM,
                          SSRMEET_TERM_CODE,
                          SSRMEET_CRN,
                          SSRMEET_CATAGORY,
                          DECODE(SSRMEET_MON_DAY, csM, csLu, SSRMEET_MON_DAY),
                          DECODE(SSRMEET_TUE_DAY, csT, csMa, SSRMEET_TUE_DAY),
                          DECODE(SSRMEET_WED_DAY, csW, csMi, SSRMEET_WED_DAY),
                          DECODE(SSRMEET_THU_DAY, csR, csJu, SSRMEET_THU_DAY),
                          DECODE(SSRMEET_FRI_DAY, csF, csVi, SSRMEET_FRI_DAY),
                          DECODE(SSRMEET_SAT_DAY, csS, csSa, SSRMEET_SAT_DAY),
                          SUBSTR(SSRMEET_BEGIN_TIME,1,2)||cs2p||
                          NVL(SUBSTR(SSRMEET_BEGIN_TIME,3,2),cs00),
                          SUBSTR(SSRMEET_END_TIME,1,2)||cs2p||
                          NVL(SUBSTR(SSRMEET_END_TIME,3,2),cs00),
                          SSRMEET_BLDG_CODE,
                          SSRMEET_ROOM_CODE,
                          SIRASGN_PERCENT_RESPONSE
              ) sirasg
        WHERE (sirasg.begnTime >= vsStarDate OR vsStarDate IS NULL)
          AND (sirasg.enddTime <= vsEnddDate OR vsEnddDate IS NULL);

      INSERT INTO FWRXLST
      (FWRXLST_CRN,FWRXLST_TERM_CODE,FWRXLST_XLST_GROUP,FWRXLST_TYPE)
      SELECT SSRXLST_CRN,
             SSRXLST_TERM_CODE,
             SSRXLST_XLST_GROUP,
             (SELECT SWRXLST_TYPE
                FROM SWRXLST
               WHERE SWRXLST_TERM_CODE  = SSRXLST_TERM_CODE
                 AND SWRXLST_CRN        = SSRXLST_CRN
                 AND SWRXLST_XLST_GROUP = SSRXLST_XLST_GROUP
             )
        FROM SSRXLST
       WHERE (SSRXLST_CRN,SSRXLST_TERM_CODE) IN (SELECT SWRPGAC_CRN,SWRPGAC_TERM_CODE
                                                   FROM SWRPGAC
                                                 );

      vsCampCode := NULL;
      vsTermCode := NULL;

      -- Las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := 'Escuela';
      tabColumna(2)  := 'NRC';
      tabColumna(3)  := 'Secci&oacute;n';
      tabColumna(4)  := 'Sesi&oacute;n';
      tabColumna(5)  := 'Materia';
      tabColumna(6)  := 'Curso';
      tabColumna(7)  := 'Nombre materia';
      tabColumna(8)  := 'Tipo de curso';
      tabColumna(9)  := 'Tipo de horario';
      tabColumna(10) := 'M&eacute;todo de instrucci&oacute;n';
      tabColumna(11) := 'Status';
      tabColumna(12) := 'Parte del periodo';
      tabColumna(13) := 'Horas semanales';
      tabColumna(14) := 'Cr&eacute;ditos';
      tabColumna(15) := 'Lista cruzada';
      tabColumna(16) := 'ID';
      tabColumna(17) := 'Docente';
      tabColumna(18) := 'Tipo de docente';
      tabColumna(19) := 'Categora';
      tabColumna(20) := csLu;
      tabColumna(21) := csMa;
      tabColumna(22) := csMi;
      tabColumna(23) := csJu;
      tabColumna(24) := csVi;
      tabColumna(25) := csSa;
      tabColumna(26) := 'Hora inicio';
      tabColumna(27) := 'Hora fin';
      tabColumna(28) := 'Horas programadas';
      tabColumna(29) := 'Edificio';
      tabColumna(30) := 'Sal&oacute;n';
      tabColumna(31) := 'Cupo';
      tabColumna(32) := 'No. inscritos';
      tabColumna(33) := '% de responsabilidad';
      tabColumna(34) := 'C&oacute;digo Ingresado';
      tabColumna(35) := 'Descripci&oacute;n Ingresado';

      FOR regRep IN cuReporte LOOP
          IF (vnExists = 0 OR vsTermCode <> regRep.termCode) THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicoPag,cs1,psSubtitulo=>csPeriodo||regRep.termCode,psUsuario=>pk_login.vgsUSR,psSeccion=>vsSeccion, psSinPiePag=>csP,psSinLogo=>csP);
             vsInicoPag := 'SALTO';
          END IF;

                    vnIngresado:=null;
                    vnIngresadoDef:=null;
                 for regdet in cuIngresado(regRep.termCode,regRep.sectCrnn) loop
                        vnIngresado:=regdet.SSRSRDF_CODE||'/';
                        vnIngresadoDef:=regdet.STVRDEF_DESC||'/';
                 end loop;

                select substr(vnIngresado,1,length(vnIngresado)-1),substr(vnIngresadoDef,1,length(vnIngresadoDef)-1)
                  into vnIngresado,vnIngresadoDef
                 from dual;

          htp.p(
          '<tr>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.collCode||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.sectCrnn||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.seqqNumb||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.meetCatg||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.subjCode||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.crseNumb||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.crseTitl||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.xlstType||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.schdCode||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.insmCode||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.sstsCode||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.ptrmCode||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.contHrLw||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.credHrLw||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.xlstGrup||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.idenIDdd||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.idenName||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.fstpCode||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.fctgCode||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.meetMonn||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.meetTuee||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.meetWedd||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.meetThuu||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.meetFrii||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.meetSatt||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.begnTime||'</td>
          <td class="tdfont7" valign="top" align="center">'||regRep.enddTime||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.hrssWeek||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.bldgCode||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.roomCode||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.maxxEnrl||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.sectEnrl||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||regRep.prcnResp||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||vnIngresado||'</td>
          <td class="tdfont7" valign="top" align="left">'  ||vnIngresadoDef||'</td>
          </tr>'
          );

          vnExists   := 1;
          vsCampCode := regRep.campCode;
          vsTermCode := regRep.termCode;

      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR, psSeccion=>vsSeccion,psSinPiePag=>'P',psSinLogo=>'P');
      END IF;

      htp.p('</table><br></body></html>');

      ROLLBACK;

 -- EXCEPTION
   --   WHEN OTHERS THEN
 --          htp.p(SQLERRM);
  END PWRPGAC;
/


DROP PUBLIC SYNONYM PWRPGAC;

CREATE PUBLIC SYNONYM PWRPGAC FOR BANINST1.PWRPGAC;


GRANT EXECUTE ON BANINST1.PWRPGAC TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRPGAC TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRPING;

CREATE OR REPLACE PROCEDURE BANINST1.PWRPING (psReclDesc   VARCHAR2)  IS

/**************************************************************
           tarea:  procedimiento que genera el reporte de puntajes de ingreso
          mdulo:  admisiones
           autor:  horacio martnez ramrez - hmr
           fecha:  10/feb/2011
**************************************************************/

  vnExists       INTEGER  := 0;
  vnColumnas     INTEGER  := 14;
  vgsInicioPag   VARCHAR2(30)  := NULL;           -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vnIdRenglon    INTEGER  := 1;
  vsTerm         SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsProgr        SARADAP.SARADAP_PROGRAM_1%TYPE DEFAULT NULL;


  CURSOR cuReporte ( psTerm    VARCHAR2  DEFAULT NULL,
                     psProgr   VARCHAR2  DEFAULT NULL)  IS

     SELECT SR.SORLCUR_PROGRAM                                                             CARRERA,
            ( SELECT COUNT(DISTINCT(SO.SORLCUR_PIDM))
                FROM SORLCUR SO
               WHERE SO.SORLCUR_TERM_CODE = SR.SORLCUR_TERM_CODE
                 AND SO.SORLCUR_TERM_CODE = SO.SORLCUR_TERM_CODE_ADMIT
                 AND SO.SORLCUR_PROGRAM = SR.SORLCUR_PROGRAM
                 AND SO.SORLCUR_ADMT_CODE = 'AD'
                 AND SO.SORLCUR_CACT_CODE = 'ACTIVE' )                                        TOT_ING_PSU,
            BANINST1.F_PTJE_PROM_PSU (SR.SORLCUR_TERM_CODE, SR.SORLCUR_PROGRAM, 'PROM')    PP_PROM_PSU,
            BANINST1.F_PTJE_PROM_PSU (SR.SORLCUR_TERM_CODE, SR.SORLCUR_PROGRAM, 'MIN')     PP_MIN_PSU,
            BANINST1.F_PTJE_PROM_PSU (SR.SORLCUR_TERM_CODE, SR.SORLCUR_PROGRAM, 'MAX')     PP_MAX_PSU,
            BANINST1.F_PROM_PUNTAJES (SR.SORLCUR_TERM_CODE, SR.SORLCUR_PROGRAM, 'PSLC' )   PROM_BS_PSLC,
            BANINST1.F_PROM_PUNTAJES (SR.SORLCUR_TERM_CODE, SR.SORLCUR_PROGRAM, 'PSMA' )   PROM_BS_PSMA,
            BANINST1.F_PROM_PUNTAJES (SR.SORLCUR_TERM_CODE, SR.SORLCUR_PROGRAM, 'PSCI' )   PROM_BS_PSCI,
            BANINST1.F_PROM_PUNTAJES (SR.SORLCUR_TERM_CODE, SR.SORLCUR_PROGRAM, 'PSHC' )   PROM_BS_PSHC,
            BANINST1.F_PROM_PUNTAJES (SR.SORLCUR_TERM_CODE, SR.SORLCUR_PROGRAM, 'NEM' )    PROM_BS_NEM,
            BANINST1.F_PROM_PUNTAJES (SR.SORLCUR_TERM_CODE, SR.SORLCUR_PROGRAM, 'NEME' )   PROM_BS_NEME,
            BANINST1.F_PTJE_INGRESO (SR.SORLCUR_TERM_CODE, SR.SORLCUR_PROGRAM, 'PROM')     PTJE_ING_PROM,
            BANINST1.F_PTJE_INGRESO (SR.SORLCUR_TERM_CODE, SR.SORLCUR_PROGRAM, 'MIN')      PTJE_IMG_MIN,
            BANINST1.F_PTJE_INGRESO (SR.SORLCUR_TERM_CODE, SR.SORLCUR_PROGRAM, 'MAX')      PTJE_IMG_MAX
       FROM SORLCUR SR
      WHERE SR.SORLCUR_TERM_CODE = psTerm
        AND SR.SORLCUR_TERM_CODE = SR.SORLCUR_TERM_CODE_ADMIT
        AND SR.SORLCUR_ADMT_CODE = 'AD'
        AND SR.SORLCUR_CACT_CODE = 'ACTIVE'
        AND (SR.SORLCUR_PROGRAM = psProgr OR psProgr IS NULL)
      GROUP BY SR.SORLCUR_PROGRAM, SR.SORLCUR_TERM_CODE
      ORDER BY SR.SORLCUR_PROGRAM;

  BEGIN

     -- valida que el usuario pertenezca a la base de datos:
     IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

     -- son buscados los valores de las cookies para asignar los valores del filtro del query:
     vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
     vsProgr := pk_ObjHtml.getValueCookie('psProgr');

     -- se determina el largo de la tabla:
     FOR vnI IN 1..vnColumnas LOOP
         tabColumna.EXTEND(vnI);
         tabColumna(vnI) := NULL;
     END LOOP;

     tabColumna(1)  := '<center> Carrera';
     tabColumna(2)  := '<center> Puntaje <br> promedio PSU <br> Total ingresados PSU';
     tabColumna(3)  := '<center> Puntaje <br> promedio PSU <br> Prom. PSU';
     tabColumna(4)  := '<center> Puntaje <br> promedio PSU <br> Min. PSU';
     tabColumna(5)  := '<center> Puntaje <br> promedio PSU <br> Max. PSU';
     tabColumna(6)  := '<center> Promedios batera <br> de seleccin <br> PSLC';
     tabColumna(7)  := '<center> Promedios batera <br> de seleccin <br> PSMA';
     tabColumna(8)  := '<center> Promedios batera <br> de seleccin <br> PSCI';
     tabColumna(9)  := '<center> Promedios batera <br> de seleccin <br> PSHC';
     tabColumna(10) := '<center> Promedios batera <br> de seleccin <br> Prom. NEM';
     tabColumna(11) := '<center> Promedios batera <br> de seleccin <br> Ptje. NEM ';
     tabColumna(12) := '<center> Puntaje de ingreso <br> Prom.';
     tabColumna(13) := '<center> Puntaje de ingreso <br> Min.';
     tabColumna(14) := '<center> Puntaje de ingreso <br> Max.';


     FOR regRep IN cuReporte (vsTerm, vsProgr) LOOP

         IF vnExists = 0 THEN
            Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||'  '||Pk_Catalogo.PERIODO(vsTerm), psUniversidad=>'UFT');
            vgsInicioPag := 'SALTO';
         END IF;

         HTP.P('<tr> <td valign="top" align="left">'   ||regRep.CARRERA       ||'</td>
                     <td valign="top" align="center">' ||regRep.TOT_ING_PSU   ||'</td>
                     <td valign="top" align="center">' ||regRep.PP_PROM_PSU   ||'</td>
                     <td valign="top" align="center">' ||regRep.PP_MIN_PSU    ||'</td>
                     <td valign="top" align="center">' ||regRep.PP_MAX_PSU    ||'</td>
                     <td valign="top" align="center">' ||regRep.PROM_BS_PSLC  ||'</td>
                     <td valign="top" align="center">' ||regRep.PROM_BS_PSMA  ||'</td>
                     <td valign="top" align="center">' ||regRep.PROM_BS_PSCI  ||'</td>
                     <td valign="top" align="center">' ||regRep.PROM_BS_PSHC  ||'</td>
                     <td valign="top" align="center">' ||regRep.PROM_BS_NEM   ||'</td>
                     <td valign="top" align="center">' ||regRep.PROM_BS_NEME  ||'</td>
                     <td valign="top" align="center">' ||regRep.PTJE_ING_PROM ||'</td>
                     <td valign="top" align="center">' ||regRep.PTJE_IMG_MIN  ||'</td>
                     <td valign="top" align="center">' ||regRep.PTJE_IMG_MAX  ||'</td>
               </tr>');

         vnExists    := 1;
         vnIdRenglon := vnIdRenglon + 1;

     END LOOP;

     IF vnExists = 0 THEN
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
     ELSE
        -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pgina:
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR);
     END IF;

     htp.p('</table><br/></body></html>');

  EXCEPTION
     WHEN OTHERS THEN
          htp.p(SQLERRM);

  END PWRPING;
/


DROP PUBLIC SYNONYM PWRPING;

CREATE PUBLIC SYNONYM PWRPING FOR BANINST1.PWRPING;


GRANT EXECUTE ON BANINST1.PWRPING TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRPING TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRPOBJ;

CREATE OR REPLACE PROCEDURE BANINST1.PWRPOBJ ( psReclDesc   VARCHAR2 ) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de privilegios por objeto.
     propsito: obtener informacin de los privilegios y usuarios que tiene
                asignado cada objeto (formas) de la aplicacin.
        mdulo: auditora - uft.
         autor: hmr - horacio martnez ramrez.
         fecha: 01/06/2011.
*******************************************************************************/

  vnExists      INTEGER := 0;
  vnColumnas    INTEGER := 4;
  vgsInicioPag  VARCHAR2(30) := NULL;           -- bandera que al tener el valor "imprime", no colocar el salto de pgina para impresin
  tabColumna    Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vnIdRenglon   INTEGER := 1;
  vsObjeto      GWRPRIV.GWRPRIV_OBJECT%TYPE DEFAULT NULL;

  CURSOR cuReporte ( psObj  VARCHAR2  DEFAULT  NULL ) IS

         SELECT GWRPRIV_USERID        usuario,
                UPPER(GURIDEN_DESC)   nombre,
                GWRPRIV_OBJECT        objeto,
                GWRPRIV_ROLE          rol
           FROM GWRPRIV, GURIDEN
          WHERE GWRPRIV_USERID = GURIDEN_USER_ID (+)
--          and exists ( select 1                                          -- verificar, tabla vaca
--                         from gurusri
--                        where gurusri_vpdi_user_id = gwrpriv_userid )
            AND ( GWRPRIV_OBJECT = psObj or psObj IS NULL )
          ORDER BY GWRPRIV_USERID, GURIDEN_DESC;


BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsObjeto := pk_ObjHtml.getValueCookie('psObj');

   -- determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   -- define los encabezados de columnas:
   tabColumna(1) := '<center> Usuario';
   tabColumna(2) := '<center> Nombre';
   tabColumna(3) := '<center> Objeto';
   tabColumna(4) := '<center> Role';


   FOR regRep IN cuReporte (vsObjeto) LOOP

       IF vnExists = 0 THEN

          -- muestra el encabezado segn el objeto seleccionado:
          IF vsObjeto IS NOT NULL THEN
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Objeto: '||vsObjeto, psUniversidad=>'UFT');
          ELSE
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Objeto: '||'Todos', psUniversidad=>'UFT');
          END IF;

       END IF;

       -- despliega los valores para cada registro:
       htp.p('<tr> <td valign="top">' ||regRep.USUARIO ||'</td>
                   <td valign="top">' ||regRep.NOMBRE  ||'</td>
                   <td valign="top">' ||regRep.OBJETO  ||'</td>
                   <td valign="top">' ||regRep.ROL     ||'</td>
              </tr>');

       vnExists    := 1;
       vnIdRenglon := vnIdRenglon + 1;

   END LOOP;

   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- omite el encabezado del reporte pero se agrega el salto de pgina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR);
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRPOBJ;
/


DROP PUBLIC SYNONYM PWRPOBJ;

CREATE PUBLIC SYNONYM PWRPOBJ FOR BANINST1.PWRPOBJ;


GRANT EXECUTE ON BANINST1.PWRPOBJ TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRPOBJ TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRPOST;

CREATE OR REPLACE PROCEDURE BANINST1.PWRPOST (psReclDesc   VARCHAR2)  IS

/**************************************************************
           tarea:  procedimiento que genera el reporte
                   de postulaciones
          mdulo:  admisiones
           autor:  horacio martnez ramrez - hmr
           fecha:  20/ene/2011
**************************************************************/

  vnExists       INTEGER := 0;
  vnColumnas     INTEGER := 35;
  vgsInicioPag   VARCHAR2(30) := NULL;           -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vnIdRenglon    INTEGER := 1;
  vsTerm         SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsProgr        SARADAP.SARADAP_PROGRAM_1%TYPE DEFAULT NULL;


  CURSOR cuReporte ( psTerm    VARCHAR2  DEFAULT NULL,
                     psProgr   VARCHAR2  DEFAULT NULL )  IS


     SELECT RUT_SIN_DV,
            DIGITO_VERIF,
            ID,
            APELLIDOS,
            NOMBRE,
            ORIGEN_POSTUL,
            TIPO_ADMISION,
            DESC_TIPO_ADMISION,
            PREFERENCIA,
            CARRERA,
            DESC_CARRERA,
            NUM_POSTULACIONES,
            DECISION,
            CARR_MATRIC_CODE,
            UPPER(PK_CATALOGO.PROGRAMA(CARR_MATRIC_CODE))   CARR_MATRIC_DESC,
            ANO_EGRESO,
            COLEGIO,
            REGION_COL,
            COMUNA_COL,
            DESC_COMUNA_COL,
            DEPEND_COL,
            TEL_FIJO,
            TEL_MOVIL,
            E_MAIL,
            ANO_PSU,
            PSLC,
            PSMA,
            PSCI,
            PSHC,
            NEM,
            --aigui 20120427: se agrega columna PEM para IHERNANDEZ
            PEM,
            NEME,
            PUNT_PSU_PROM,
            PUNT_UFT,
            BECA_AUT,
            BECA_COL
       FROM (SELECT SUBSTR(F_GET_RUT(SA.SARADAP_PIDM), 1, LENGTH(F_GET_RUT(SA.SARADAP_PIDM))-2)       RUT_SIN_DV,
                    SUBSTR(F_GET_RUT(SA.SARADAP_PIDM), LENGTH(F_GET_RUT(SA.SARADAP_PIDM)))            DIGITO_VERIF,
                    F_GET_RUT(SA.SARADAP_PIDM)                                                        RUT,
                    SP.SPRIDEN_ID                                                                     ID,
                    UPPER(REPLACE (REPLACE(SP.SPRIDEN_LAST_NAME, '*', ' '), '  ', ' ' ) )             APELLIDOS,
                    UPPER(REPLACE (REPLACE(SP.SPRIDEN_FIRST_NAME||' '||
                                           SP.SPRIDEN_MI, '   ', ' ' ), '  ', ' ' ) )                 NOMBRE,
                    SABIDEN.SAVHEAD_ADD_DATE_TRUNC                                                    FEC_POSTUL,
                    (SELECT SARQUAN_ANSWER
                       FROM SARQUAN
                      WHERE SARQUAN_PIDM = SA.SARADAP_PIDM
                        AND SARQUAN_TERM_CODE_ENTRY = psTerm
                        AND SARQUAN_SEQNO = 1
                        AND SARQUAN_APPL_NO = SA.SARADAP_APPL_NO )                                    ORIGEN_POSTUL,
                    SA.SARADAP_ADMT_CODE                                                              TIPO_ADMISION,
                    UPPER(ST.STVADMT_DESC)                                                            DESC_TIPO_ADMISION,
                    SA.SARADAP_APPL_PREFERENCE                                                        PREFERENCIA,
                    SA.SARADAP_PROGRAM_1                                                              CARRERA,
                    UPPER(PK_CATALOGO.PROGRAMA(SA.SARADAP_PROGRAM_1))                                 DESC_CARRERA,
                    (SELECT COUNT(DISTINCT(SARADAP_APPL_NO))
                       FROM SARADAP
                      WHERE SARADAP_PIDM = SA.SARADAP_PIDM
                        AND SARADAP_TERM_CODE_ENTRY = psTerm)                                         NUM_POSTULACIONES,
                    (SELECT DISTINCT(SARAPPD_APDC_CODE)
                       FROM SARAPPD A
                      WHERE A.SARAPPD_PIDM = SA.SARADAP_PIDM
                        AND A.SARAPPD_TERM_CODE_ENTRY = SA.SARADAP_TERM_CODE_ENTRY
                        AND A.SARAPPD_APPL_NO = SA.SARADAP_APPL_NO
                        AND A.SARAPPD_SEQ_NO = (SELECT MAX(SARAPPD_SEQ_NO)
                                                  FROM SARAPPD
                                                 WHERE SARAPPD_PIDM = A.SARAPPD_PIDM
                                                   AND SARAPPD_APPL_NO = SA.SARADAP_APPL_NO) )        DECISION,
                    (SELECT SGBSTDN_PROGRAM_1
                       FROM SGBSTDN
                      WHERE SGBSTDN_PIDM IN (SELECT TWBCNTR_PIDM
                                               FROM TWBCNTR
                                              WHERE TWBCNTR_PIDM = SA.SARADAP_PIDM
                                                AND TWBCNTR_TERM_CODE = SA.SARADAP_TERM_CODE_ENTRY
                                                AND TWBCNTR_STATUS_IND = 'A'
                                                and not exists (select 1
                    from twbretr
                    where twbretr_cntr_num = twbcntr_num))
                        AND SGBSTDN_TERM_CODE_EFF = SA.SARADAP_TERM_CODE_ENTRY )                      CARR_MATRIC_CODE,
                    NVL(SUBSTR(TO_CHAR(CH.SORHSCH_GRADUATION_DATE, 'DD/MM/YYYY'),7,10), NULL)         ANO_EGRESO,
                    UPPER(PK_CATALOGO.PREPARATORIA(CH.SORHSCH_SBGI_CODE))                             COLEGIO,
                    (SELECT SOBSBGI_STAT_CODE FROM SOBSBGI
                      WHERE SOBSBGI_SBGI_CODE = CH.SORHSCH_SBGI_CODE)                                 REGION_COL,
                    (SELECT SOBSBGI_CNTY_CODE FROM SOBSBGI
                      WHERE SOBSBGI_SBGI_CODE = CH.SORHSCH_SBGI_CODE)                                 COMUNA_COL,
                    (SELECT SUBSTR(STVCNTY_DESC, 7) FROM STVCNTY
                      WHERE STVCNTY_CODE = (SELECT SOBSBGI_CNTY_CODE
                                              FROM SOBSBGI
                                             WHERE SOBSBGI_SBGI_CODE = CH.SORHSCH_SBGI_CODE) )        DESC_COMUNA_COL,
                    (SELECT UPPER(ST.STVBCHR_DESC)
                       FROM SORBCHR HR, STVBCHR ST
                      WHERE HR.SORBCHR_BCHR_CODE <> 'L'
                        AND HR.SORBCHR_BCHR_CODE = ST.STVBCHR_CODE
                        AND HR.SORBCHR_SBGI_CODE = CH.SORHSCH_SBGI_CODE )                             DEPEND_COL,
                    (SELECT DECODE(LE.SPRTELE_PHONE_AREA, NULL, '', '('||LE.SPRTELE_PHONE_AREA||') ' )||
                             LE.SPRTELE_PHONE_NUMBER||
                             DECODE( LE.SPRTELE_PHONE_EXT, NULL, '', (' EXT. '||LE.SPRTELE_PHONE_EXT) )
                       FROM SPRTELE LE
                      WHERE LE.SPRTELE_SEQNO = (SELECT MAX(SPRTELE_SEQNO) FROM SPRTELE
                                                 WHERE SPRTELE_TELE_CODE = 'TFPA'
                                                   AND LE.SPRTELE_PIDM = SPRTELE_PIDM
                                                   AND LE.SPRTELE_SEQNO = SPRTELE_SEQNO)
                        AND SP.SPRIDEN_PIDM = LE.SPRTELE_PIDM
                        AND ROWNUM = 1 )                                                              TEL_FIJO,
                    (SELECT '('||NVL(LE.SPRTELE_PHONE_AREA, ' 0 ')||') '||LE.SPRTELE_PHONE_NUMBER
                       FROM SPRTELE LE
                      WHERE LE.SPRTELE_SEQNO = (SELECT MIN(SPRTELE_SEQNO) FROM SPRTELE
                                                 WHERE SPRTELE_TELE_CODE = 'TMPA'
                                                   AND LE.SPRTELE_PIDM = SPRTELE_PIDM
                                                   AND LE.SPRTELE_SEQNO = SPRTELE_SEQNO)
                        AND SP.SPRIDEN_PIDM = LE.SPRTELE_PIDM
                        AND ROWNUM = 1 )                                                              TEL_MOVIL,
                    BANINST1.PK_DESCRIPCIONES.F_GETMAIL(SA.SARADAP_PIDM)                              E_MAIL,
                    (SELECT NVL(SUBSTR(TO_CHAR(MAX(SORTEST_TEST_DATE),'DD/MM/YYYY'),7,10), NULL)
                       FROM SORTEST
                      WHERE SORTEST_PIDM = SA.SARADAP_PIDM)                                           ANO_PSU,
                    F_PUNTAJE (SA.SARADAP_PIDM, 'PSLC')                                               PSLC,
                    F_PUNTAJE (SA.SARADAP_PIDM, 'PSMA')                                               PSMA,
                    F_PUNTAJE (SA.SARADAP_PIDM, 'PSCI')                                               PSCI,
                    F_PUNTAJE (SA.SARADAP_PIDM, 'PSHC')                                               PSHC,
                    F_PUNTAJE (SA.SARADAP_PIDM, 'NEM')                                                NEM,
                    --aigui 20120427: se agrega columna PEM para IHERNANDEZ
                    F_PUNTAJE (SA.SARADAP_PIDM, 'PEM')                                                PEM,
                    F_PUNTAJE (SA.SARADAP_PIDM, 'NEME')                                               NEME,
                    F_PROMEDIO_PSU (SA.SARADAP_PIDM)                                                  PUNT_PSU_PROM,
                    F_PONDERADO (SA.SARADAP_PIDM, SARADAP_PROGRAM_1)                                  PUNT_UFT,
                    F_BECAAUT (SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1 )                        BECA_AUT,
                    F_BECACOL (SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1 )                        BECA_COL
               FROM SPRIDEN  SP,
                    SARADAP  SA,
                    SORHSCH  CH,
                    SPBPERS  SB,
                    STVADMT  ST,
                    (SELECT SAVHEAD_ADD_DATE_TRUNC, SAVHEAD_AIDM, SABIDEN_PIDM
                       FROM SAVHEAD AD, SABIDEN EN
                      WHERE AD.SAVHEAD_AIDM = EN.SABIDEN_AIDM
                        AND AD.SAVHEAD_APPL_SEQNO = (SELECT MAX(SAVHEAD_APPL_SEQNO)
                                                       FROM SAVHEAD
                                                      WHERE SAVHEAD_AIDM = EN.SABIDEN_AIDM) ) SABIDEN,
                    SGBSTDN  DN
              WHERE SP.SPRIDEN_CHANGE_IND IS NULL
                AND SP.SPRIDEN_PIDM = SA.SARADAP_PIDM(+)
                AND SA.SARADAP_PIDM = CH.SORHSCH_PIDM(+)
                AND SA.SARADAP_PIDM = SB.SPBPERS_PIDM(+)
                AND SA.SARADAP_PIDM = DN.SGBSTDN_PIDM(+)
                AND SA.SARADAP_TERM_CODE_ENTRY = psTerm
                AND (SA.SARADAP_PROGRAM_1 = psProgr OR psProgr IS NULL)
                AND SA.SARADAP_ADMT_CODE = ST.STVADMT_CODE
                AND SA.SARADAP_PIDM = SABIDEN_PIDM(+) )
      ORDER BY RUT, NOMBRE, CARRERA;


   BEGIN

      -- valida que el usuario pertenezca a la base de datos:
      IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      -- son buscados los valores de las cookies para asignar los valores del filtro del query:
      vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
      vsProgr := pk_ObjHtml.getValueCookie('psProgr');

      -- se determina el largo de la tabla:
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := '<center> RUT';
      tabColumna(2)  := '<center> D.V.';
      tabColumna(3)  := '<center> ID';
      tabColumna(4)  := '<center> Apellidos';
      tabColumna(5)  := '<center> Nombre';
      tabColumna(6)  := '<center> Origen <br> de <br> postulacin';
      tabColumna(7)  := '<center> Tipo de <br> admisin <br> Cdigo';
      tabColumna(8)  := '<center> Tipo de <br> admisin <br> Descripcin';
      tabColumna(9)  := '<center> Preferencia';
      tabColumna(10) := '<center> Carrera de <br> postulacin <br> Cdigo';
      tabColumna(11) := '<center> Carrera de <br> postulacin <br> Descripcin';
      tabcolumna(12) := '<center> Nmero <br> de <br> postulaciones';
      tabColumna(13) := '<center> Decisin';
      tabColumna(14) := '<center> Carrera matriculada Cdigo';
      tabColumna(15) := '<center> Carrera matriculada Descripcin';
      tabColumna(16) := '<center> Ao Egreso E.M.';
      tabColumna(17) := '<center> Colegio';
      tabColumna(18) := '<center> Regin colegio';
      tabColumna(19) := '<center> Comuna colegio <br> Cdigo';
      tabColumna(20) := '<center> Comuna colegio <br> Descripcin ';
      tabColumna(21) := '<center> Dependencia colegio';
      tabColumna(22) := '<center> Telfono fijo';
      tabColumna(23) := '<center> Telfono mvil';
      tabColumna(24) := '<center> E-mail';
      tabColumna(25) := '<center> Ao PSU';
      tabColumna(26) := '<center> PSLC';
      tabColumna(27) := '<center> PSMA';
      tabColumna(28) := '<center> PSCI';
      tabColumna(29) := '<center> PSHC';
      --aigui 20120427: se elimina la columna NEM y se agrega la coluna PEM
      --a petiticin de IHERNANDEZ
      --tabColumna(28) := '<center> NEM';
      tabColumna(28) := '<center> PEM';
      tabColumna(31) := '<center> NEM equivalente';
      tabColumna(32) := '<center> Punt. PSU <br>promedio<br>(PSLC+PSMA)/2';
      tabColumna(33) := '<center> Punt. UFT <br>(clculo ponderado)';
      tabColumna(34) := '<center> % Beca automtica<br>PSU';
      tabColumna(35) := '<center> % Beca colegio<br>origen';


      FOR regRep IN cuReporte (vsTerm, vsProgr) LOOP

          IF vnExists = 0 THEN
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||'  '||Pk_Catalogo.PERIODO(vsTerm), psUniversidad=>'UFT');
             vgsInicioPag := 'SALTO';
          END IF;

          HTP.P('<tr> <td valign="top" align="left">'   ||regRep.RUT_SIN_DV         ||'</td>
                      <td valign="top" align="center">' ||regRep.DIGITO_VERIF       ||'</td>
                      <td valign="top" align="left">'   ||regRep.ID                 ||'</td>
                      <td valign="top" align="left">'   ||regRep.APELLIDOS          ||'</td>
                      <td valign="top" align="left">'   ||regRep.NOMBRE             ||'</td>
                      <td valign="top" align="center">' ||regRep.ORIGEN_POSTUL      ||'</td>
                      <td valign="top" align="center">' ||regrep.TIPO_ADMISION      ||'</td>
                      <td valign="top" align="left">'   ||regrep.DESC_TIPO_ADMISION ||'</td>
                      <td valign="top" align="center">' ||regrep.PREFERENCIA        ||'</td>
                      <td valign="top" align="left">'   ||regrep.CARRERA            ||'</td>
                      <td valign="top" align="left">'   ||regrep.DESC_CARRERA       ||'</td>
                      <td valign="top" align="center">' ||regrep.NUM_POSTULACIONES  ||'</td>
                      <td valign="top" align="center">' ||regrep.DECISION           ||'</td>
                      <td valign="top" align="left">'   ||regrep.CARR_MATRIC_CODE   ||'</td>
                      <td valign="top" align="left">'   ||regrep.CARR_MATRIC_DESC   ||'</td>
                      <td valign="top" align="center">' ||regrep.ANO_EGRESO         ||'</td>
                      <td valign="top" align="left">'   ||regrep.COLEGIO            ||'</td>
                      <td valign="top" align="center">' ||regrep.REGION_COL         ||'</td>
                      <td valign="top" align="center">' ||regrep.COMUNA_COL         ||'</td>
                      <td valign="top" align="leftr">'  ||regrep.DESC_COMUNA_COL    ||'</td>
                      <td valign="top" align="left">'   ||regrep.DEPEND_COL         ||'</td>
                      <td valign="top" align="rigth">'  ||regrep.TEL_FIJO           ||'</td>
                      <td valign="top" align="rigth">'  ||regrep.TEL_MOVIL          ||'</td>
                      <td valign="top" align="left">'   ||regrep.E_MAIL             ||'</td>
                      <td valign="top" align="center">' ||regrep.ANO_PSU            ||'</td>
                      <td valign="top" align="center">' ||regrep.PSLC               ||'</td>
                      <td valign="top" align="center">' ||regrep.PSMA               ||'</td>
                      <td valign="top" align="center">' ||regrep.PSCI               ||'</td>
                      <td valign="top" align="center">' ||regrep.PSHC               ||'</td>
                      <td valign="top" align="center">'
                      --aigui 20120427: se elimina la columna NEM y se Agrega PEM
                      /*||regRep.NEM               ||'</td>
                    <td valign="top" align="center">' */||regRep.PEM               ||'</td>
                      <td valign="top" align="center">' ||regrep.NEME               ||'</td>
                      <td valign="top" align="center">' ||regrep.PUNT_PSU_PROM      ||'</td>
                      <td valign="top" align="center">' ||regrep.PUNT_UFT           ||'</td>
                      <td valign="top" align="center">' ||regrep.BECA_AUT           ||'</td>
                      <td valign="top" align="center">' ||regrep.BECA_COL           ||'</td>
                </tr>');

          vnExists    := 1;
          vnIdRenglon := vnIdRenglon + 1;

      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pgina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
      END IF;

      htp.p('</table><br/></body></html>');

   EXCEPTION
      WHEN OTHERS THEN
           htp.p(SQLERRM);

   END PWRPOST;
/


DROP PUBLIC SYNONYM PWRPOST;

CREATE PUBLIC SYNONYM PWRPOST FOR BANINST1.PWRPOST;


GRANT EXECUTE ON BANINST1.PWRPOST TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRPOST TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRPPCD;

CREATE OR REPLACE PROCEDURE BANINST1.PWRPPCD(psReclDesc VARCHAR2,
                                  psSiu      VARCHAR2 DEFAULT NULL) IS

/**************************************************************
           tarea:  obtiene el promedio por curso del docente del seprad
          mdulo:  resultados del sistema de evaluacin de la prctica docente (seprad)
           autor:  horacio martnez ramrez - hmr
           fecha:  05/nov/2010
**************************************************************/

  global_pidm SPRIDEN.SPRIDEN_PIDM%TYPE;

  TYPE reg_Prom IS RECORD (rTeqaCode    VARCHAR2(40),
                           rTeqaDesc    VARCHAR2(500),
                           rQcodCode    VARCHAR2(40),
                           rQcodDesc    VARCHAR2(500),
                           rMedia       NUMBER,
                           rDesvi       NUMBER,
                           rCrn         NUMBER,
                           rContestaron INTEGER,
                           rContestaro2 INTEGER,
                           rTitle       VARCHAR2(300),
                           rInscritos   INTEGER,
                           rMedCat      NUMBER,
                           rDesCat      NUMBER,
                           rMedColl     NUMBER,
                           rDesColl     NUMBER,
                           rConColl     INTEGER,
                           rInsColl     INTEGER,
                           rGruColl     INTEGER,
                           rMedCatColl  NUMBER,
                           rDesCatColl  NUMBER,
                           rVppMedCrn   NUMBER,
                           rVppDesCrn   NUMBER,
                           rMediaCero   INTEGER,
                           rMedZero     INTEGER);

  TYPE tableProm IS TABLE OF reg_Prom INDEX BY BINARY_INTEGER;

  tabPromCrn   tableProm;
  vsDireSic    VARCHAR2(1)    := NULL;
  vsId         VARCHAR2(10)   := NULL;
  vsNombre     VARCHAR2(300)  := NULL;
  vsPtrm       VARCHAR2(5000) := NULL;
  vsPtr2       VARCHAR2(5000) := NULL;
  vsPper       VARCHAR2(6)    := NULL;
  vsTerm       VARCHAR2(6)    := NULL;
  vsEncu       VARCHAR2(30)   := NULL;
  vsColl       VARCHAR2(3)    := NULL;
  vsUniv       VARCHAR2(5)    := NULL;
  vsLongCeld2  VARCHAR2(100)  := ' style="width:120.0px" ';
  vsLongCelda  VARCHAR2(100)  := ' style="width:60.0px" ';
  vsStyRight   VARCHAR2(100)  := NULL;
  vsStyLeft    VARCHAR2(100)  := NULL;
  vnPidm       NUMBER         := NULL;
  vnPromProfM  NUMBER         := 0;
  vnPromProfD  NUMBER         := 0;
  vnPromCollM  NUMBER         := 0;
  vnPromCollD  NUMBER         := 0;
  vnRow        INTEGER        := 0;
  vnTab        INTEGER        := 0;
  vnRowColl    INTEGER        := 0;
  vnRollado    INTEGER        := 0;
  vnEvaluaron  INTEGER        := 0;
  vnNoEvaluado INTEGER        := 0;
  vnInscritos  INTEGER        := 0;
  vnVppPromed  INTEGER        := 0;
  vnCursos     INTEGER        := 0;

  cn0   CONSTANT NUMBER(1)   := 0;
  cn1   CONSTANT NUMBER(1)   := 1;
  cn2   CONSTANT NUMBER(1)   := 2;
  cn19  CONSTANT NUMBER(2)   := 19;
  cn16  CONSTANT NUMBER(2)   := 16;
  csI   CONSTANT VARCHAR2(1) := 'I';
  csL   CONSTANT VARCHAR2(1) := 'L';
  csShl CONSTANT VARCHAR2(1) := '/';

  CURSOR cuPromedio(psTerm VARCHAR2,
                    psColl VARCHAR2,
                    pnPidm NUMBER,
                    psCamp VARCHAR2,
                    psEncu VARCHAR2,
                    psPtrm VARCHAR2 DEFAULT NULL
                   ) IS
         SELECT SWRSEPR_TEQA_CODE                        teqaCode,
                pk_Seprad1.F_TeqaDesc(SWRSEPR_TEQA_CODE) teqaDesc,
                SWRSEPR_QCOD_CODE                        qcodCode,
                pk_Seprad1.F_QcodDesc(SWRSEPR_QCOD_CODE) qcodDesc,
                SWRSEPR_CRN         Crn,
                SWRSEPR_MEDIA       Media,
                SWRSEPR_DESVIACION  Desviacion,
                DECODE((SELECT SUM(A.SWRSEPR_MEDIA)
                          FROM SWRSEPR A
                         WHERE A.SWRSEPR_TERM_CODE = B.SWRSEPR_TERM_CODE
                           AND A.SWRSEPR_COLL_CODE = B.SWRSEPR_COLL_CODE
                           AND A.SWRSEPR_PIDM      = B.SWRSEPR_PIDM
                           AND A.SWRSEPR_CAMP_CODE = B.SWRSEPR_CAMP_CODE
                           AND A.SWRSEPR_CRN       = B.SWRSEPR_CRN
                           AND A.SWRSEPR_TIPO_CRN IN (csI,csL)
                       ),cn0,cn0,
                SWRSEPR_CONTESTARON) Contestaron2,
                SWRSEPR_CONTESTARON Contestaron,
                SWRSEPR_TITLE       Title,
                SWRSEPR_INSCRITOS   Inscritos,
                DECODE(SWRSEPR_MEDIA,cn0,cn0,cn1) MediaCero
           FROM SWRSEPR B,SWROENC SWR
          WHERE SWRSEPR_TSSC_CODE = psEncu
            AND SWRSEPR_TERM_CODE = psTerm
            AND SWRSEPR_COLL_CODE = psColl
            AND SWRSEPR_PIDM      = pnPidm
            AND SWRSEPR_CAMP_CODE = psCamp
            AND SWRSEPR_TIPO_CRN IN (csI,csL)
            AND (INSTR(csShl||psPtrm,csShl||SWRSEPR_PTRM_CODE||csShl) > cn0 OR psPtrm = csShl OR psPtrm IS NULL)
            AND SWR.SWROENC_TSSC_CODE = SWRSEPR_TSSC_CODE
            AND SWR.SWROENC_QCOD_CODE = SWRSEPR_QCOD_CODE
          ORDER BY SWRSEPR_CRN,SWROENC_ORDEN;


  -- obtiene los crn's de los cursos del profesor
  function f_DatosCurso(pnOpcion integer) return varchar2 is

  vnVuelta   integer := 0;
  vnPosicion integer := 0;

  begin
      for vnI in 1..vnCursos loop
          vnPosicion := 1 + (cn19 * vnVuelta);

          htp.p('<td colspan="2" align="center" class="tdFont8" '||vsLongCeld2);

          if    pnOpcion = 0 then
                htp.prn(' style="border-bottom:none;">');
                htp.p(tabPromCrn(vnPosicion).rCrn);

          elsif pnOpcion = 1 then
                htp.prn('class="tdFont7" style="border-top:none;border-bottom:none;" valign="top">');
                htp.p(tabPromCrn(vnPosicion).rTitle);
          elsif pnOpcion = 2 then
                htp.prn(' style="border-top:none;border-bottom:none;">');
                htp.p(tabPromCrn(vnPosicion).rContestaron);

                if tabPromCrn(vnPosicion).rContestaro2 > 0 then
                   vnEvaluaron := vnEvaluaron + tabPromCrn(vnPosicion).rContestaron;
                else
                   vnNoEvaluado := 1 + vnNoEvaluado;
                end if;
          elsif pnOpcion = 3 then
                htp.prn(' style="border-top:none;border-bottom:none;">');
                htp.p(tabPromCrn(vnPosicion).rInscritos);

                if tabPromCrn(vnPosicion).rContestaro2 > 0 then
                   vnInscritos := vnInscritos + tabPromCrn(vnPosicion).rInscritos;
                end if;
          elsif pnOpcion = 4 then
                htp.prn(' style="border-top:none;">');
                htp.p('1');
          end if;

          htp.p('</td>');

          vnVuelta := vnVuelta + 1;
      end loop;

      if    pnOpcion = 0 then
            htp.p('<th rowspan="2" colspan="2" '||vsLongCeld2||' class="thFont8">'||'Profesor'||'</th>
                   <td rowspan="2" colspan="2" align="center" '||vsLongCeld2||' class="tdFont8">'||'Escuela o Facultad'||'</td>');
      elsif pnOpcion = 2 then
            htp.p('<td align="center" colspan="2" '||vsLongCeld2||' style="border-bottom:none;" class="tdFont8">'||vnEvaluaron||'</td>
                   <td align="center" colspan="2" '||vsLongCeld2||' style="border-bottom:none;" class="tdFont8">'||tabPromCrn(1).rConColl||'</td>');
      elsif pnOpcion = 3 then
            htp.p('<td align="center" colspan="2" '||vsLongCeld2||' style="border-top:none;border-bottom:none;" class="tdFont8">'||vnInscritos||'</td>
                   <td align="center" colspan="2" '||vsLongCeld2||' style="border-top:none;border-bottom:none;" class="tdFont8">'||tabPromCrn(1).rInsColl||'</td>');
      elsif pnOpcion = 4 then
            htp.p('<td align="center" colspan="2" '||vsLongCeld2||' style="border-top:none;" class="tdFont8">'||(vnCursos-vnNoEvaluado)||'</td>
                   <td align="center" colspan="2" '||vsLongCeld2||' style="border-top:none;" class="tdFont8">'||tabPromCrn(1).rGruColl||'</td>');
      end if;

      return null;
  end f_DatosCurso;

  -- media y desviacin por categora de evaluacin
  function f_MediaCategoria(pnCategoria INTEGER) return varchar2 is

  vnVuelta         integer := 0;
  vnPosicion       integer := 0;
  vnEvalua         integer := 0;
  vnMediaCategoria number  := 0;
  vnDesviCategoria number  := 0;

  begin
      for vnI in 1..vnCursos loop
          vnPosicion := pnCategoria + (cn19 * vnVuelta);

          htp.p('<th valign="top" '||vsLongCelda||' style="border-right:none;" class="thFont8">'||TO_CHAR(ROUND(tabPromCrn(vnPosicion).rMedCat,2),'90.99')||'</th>
                 <th valign="top" '||vsLongCelda||' style="border-left:none;"  class="thFont8">'||TO_CHAR(ROUND(tabPromCrn(vnPosicion).rDesCat,2),'90.99')||'</th>');

          vnMediaCategoria := vnMediaCategoria + tabPromCrn(vnPosicion).rMedCat * tabPromCrn(vnPosicion).rContestaron;
          vnDesviCategoria := vnDesviCategoria + tabPromCrn(vnPosicion).rDesCat * tabPromCrn(vnPosicion).rContestaron;

          if tabPromCrn(vnPosicion).rMedCat > 0 then
             vnEvalua := vnEvalua + tabPromCrn(vnPosicion).rContestaron;
          end if;

          vnVuelta := vnVuelta + 1;
      end loop;

      if vnMediaCategoria > 0 and vnEvalua > 0 then
         vnMediaCategoria := vnMediaCategoria/vnEvalua;
      end if;

      if vnDesviCategoria > 0 and vnEvalua > 0 then
         vnDesviCategoria := vnDesviCategoria/vnEvalua;
      end if;

      htp.p('<th valign="top" '||vsLongCelda||' style="border-right:none;" class="thFont8">'||TO_CHAR(ROUND(vnMediaCategoria,2),'90.99')||'</th>
             <th valign="top" '||vsLongCelda||' style="border-left:none;"  class="thFont8">'||TO_CHAR(ROUND(vnDesviCategoria,2),'90.99')||'</th>');

      return null;

  end f_MediaCategoria;

  -- media y desviacin por reactivo de la evaluacin
  function f_MediaReactivo(pnRectivo INTEGER) return varchar2 is

  vnVuelta        integer := 0;
  vnPosicion      integer := 0;
  vnEvalua        integer := 0;
  vnMediaPromedio number  := 0;
  vnDesviPromedio number  := 0;

  begin
      for vnI in 1..vnCursos loop
          vnPosicion  := pnRectivo + (cn19 * vnVuelta);

          htp.p('<td align="center" valign="top" '||vsLongCelda||' style="'||vsStyRight||'" class="tdFont8">'||TO_CHAR(ROUND(tabPromCrn(vnPosicion).rMedia,2),'90.99')||'</td>
                 <td align="center" valign="top" '||vsLongCelda||' style="'||vsStyLeft ||'" class="tdFont8">'||TO_CHAR(ROUND(tabPromCrn(vnPosicion).rDesvi,2),'90.99')||'</td>');

          tabPromCrn(vnI).rVppMedCrn := tabPromCrn(vnI).rVppMedCrn + tabPromCrn(vnPosicion).rMedia;
          tabPromCrn(vnI).rVppDesCrn := tabPromCrn(vnI).rVppDesCrn + tabPromCrn(vnPosicion).rDesvi;
          tabPromCrn(vnI).rMedZero   := tabPromCrn(vnI).rMedZero   + tabPromCrn(vnPosicion).rMediaCero;

          vnMediaPromedio := vnMediaPromedio + tabPromCrn(vnPosicion).rMedia * tabPromCrn(vnPosicion).rContestaron;
          vnDesviPromedio := vnDesviPromedio + tabPromCrn(vnPosicion).rDesvi * tabPromCrn(vnPosicion).rContestaron;

          if tabPromCrn(vnPosicion).rMedia > 0 then
             vnEvalua := vnEvalua + tabPromCrn(vnPosicion).rContestaron;
          end if;

          vnVuelta := vnVuelta + 1;
      end loop;

      if vnMediaPromedio > 0 and vnEvalua > 0 then
         vnMediaPromedio := vnMediaPromedio/vnEvalua;
      end if;

      if vnDesviPromedio > 0 and vnEvalua > 0 then
         vnDesviPromedio := vnDesviPromedio/vnEvalua;
      end if;

      vnPromProfM := vnPromProfM + vnMediaPromedio;
      vnPromProfD := vnPromProfD + vnDesviPromedio;

      if vnMediaPromedio > 0 then
         vnVppPromed := vnVppPromed + 1;
      end if;

      htp.p('<td align="center" valign="top" bgcolor="#efefef" '||vsLongCelda||' style="'||vsStyRight||'" class="tdFont8">' ||TO_CHAR(ROUND(vnMediaPromedio,2),'90.99')||'</td>
             <td align="center" valign="top" bgcolor="#efefef" '||vsLongCelda||' style="'||vsStyLeft ||'" class="tdFont8">'||TO_CHAR(ROUND(vnDesviPromedio,2),'90.99')||'</td>');

      return null;

  end f_MediaReactivo;

  -- presenta los reactivos de la encuesta
  procedure P_ReactivosEncuesta is

  vsTeqaCode   svrsdef.svrsdef_teqa_code%type := null;
  vnWidthTable integer       := 0;

  begin
      vnCursos     := vnRow/cn19;
      vnWidthTable := 370 + ( (vnCursos+4) * 60);

      htp.p('<table border="1" cellpadding="2" cellspacing="0" bordercolor="#cccccc" bgcolor="#ffffff" style="width:'||vnWidthTable||'.0px">
      <tr class="trTabSepara"><td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7">'||'CRN'||'</td>');
      htp.p(f_DatosCurso(0));

      htp.p('</tr><tr class="trTabSepara"><td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7" valign="top">'||'Materia'||'</td>');
      htp.p(f_DatosCurso(1));

      htp.p('</tr><tr class="trTabSepara"><td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7">'||'N&uacute;mero de evaluadores'||'</td>');
      htp.p(f_DatosCurso(2));

      htp.p('</tr><tr class="trTabSepara"><td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7">'||'N&uacute;mero de alumnos inscritos'||'</td>');
      htp.p(f_DatosCurso(3));

      htp.p('</tr><tr class="trTabSepara"><td colspan="2" align="right" style="border-left:none;border-top:none;border-bottom:none;" class="tdFont7">'||'N&uacute;mero de grupos'||'</td>');
      htp.p(f_DatosCurso(4));

      htp.p('</tr><tr class="trTabSepara"><td colspan="2" align="right" style="border-left:none;border-top:none;"></td>');

      for vnC in 1..(vnCursos+2) loop
          htp.p('<td align="center" class="tdFont7" valign="bottom" style="border-right:none;">'||'Promedio'||'</td>
                 <td align="center" class="tdFont7" valign="bottom" style="border-left:none;">' ||'Desviaci&oacute;n'||'</td>');
      end loop;

      htp.p('</tr>');

      for vnI in 1..vnRow loop
            if vnI = cn19 then
             vsStyRight := 'border-right:none;border-top:none;';
             vsStyLeft  := 'border-left:none;border-top:none;';
          else
             vsStyRight := 'border-right:none;border-top:none;border-bottom:none;';
             vsStyLeft  := 'border-left:none;border-top:none;border-bottom:none;';
          end if;

          -- es colocada la media por categora de evaluacin
          if vsTeqaCode <> tabPromCrn(vnI).rTeqaCode or vsTeqaCode is null then
             htp.p('<tr bgcolor="#efefef" class="trTabSepara"><th colspan="2" align="left" class="thFont7">'||tabPromCrn(vnI).rTeqaDesc||'</th>');
             htp.p(f_MediaCategoria(vnI));

             htp.p('<th valign="top" '||vsLongCelda||' style="border-right:none;" class="thFont8">'||TO_CHAR(ROUND(tabPromCrn(vnI).rMedCatColl,2),'90.99')||'</th>
                    <th valign="top" '||vsLongCelda||' style="border-left:none;" class="thFont8">'||TO_CHAR(ROUND(tabPromCrn(vnI).rDesCatColl,2),'90.99')||'</th>');

             htp.p('</tr>');
          end if;

          -- son colocados la descripcin de los reactivos
          htp.p('<tr class="trTabSepara">
                     <td style="width:20.0px" valign="top" align="right" class="tdFont7" style="border-right:none;">'||vnI||')</td>
                     <td style="width:350.0px" valign="top" class="tdFont7" style="border-left:none;">'||tabPromCrn(vnI).rQcodDesc||'</td>');

          -- es colocada la media y desviacin de los reactivos
          htp.p(f_MediaReactivo(vnI));

          vnPromCollM := vnPromCollM + tabPromCrn(vnI).rMedColl;
          vnPromCollD := vnPromCollD + tabPromCrn(vnI).rDesColl;

          -- media y desviacin por escuela
          htp.p('<td align="center" valign="top" '||vsLongCelda||' style="'||vsStyRight||'" class="tdFont8">'||TO_CHAR(ROUND(tabPromCrn(vnI).rMedColl,2),'90.99')||'</td>
                 <td align="center" valign="top" '||vsLongCelda||' style="'||vsStyLeft ||'"  class="tdFont8">'||TO_CHAR(ROUND(tabPromCrn(vnI).rDesColl,2),'90.99')||'</td>');

          htp.p('</tr>');

          -- es colocado el promedio de los reactivos
          if vnI = cn16 then
             htp.p('<tr bgcolor="#efefef" class="trTabSepara"><th colspan="2" class="thFont7" style="border-right:none;">'||'Valoraci&oacute;n Promedio del Profesor (VPP)'||'</th>');

             for vnJ in 1..vnCursos loop
                 if tabPromCrn(vnJ).rVppMedCrn > 0 then
                    tabPromCrn(vnJ).rVppMedCrn := tabPromCrn(vnJ).rVppMedCrn/tabPromCrn(vnJ).rMedZero;
                 end if;

                 if tabPromCrn(vnJ).rVppDesCrn > 0 then
                    tabPromCrn(vnJ).rVppDesCrn := tabPromCrn(vnJ).rVppDesCrn/tabPromCrn(vnJ).rMedZero;
                 end if;

                 -- promedio por crn
                 htp.p('<th valign="top" '||vsLongCelda||' style="border-left:none;border-right:none;" class="thFont8">'||TO_CHAR(ROUND(tabPromCrn(vnJ).rVppMedCrn,2),'90.99')||'</th>
                        <th valign="top" '||vsLongCelda||' style="border-left:none;border-right:none;" class="thFont8">'||TO_CHAR(ROUND(tabPromCrn(vnJ).rVppDesCrn,2),'90.99')||'</th>');
             end loop;

             if vnPromProfM > 0 then
                vnPromProfM := vnPromProfM/vnVppPromed;
             end if;

             if vnPromProfD > 0 then
                vnPromProfD := vnPromProfD/vnVppPromed;
             end if;

             -- promedio del profesor
             htp.p('<th valign="top" '||vsLongCelda||' style="border-right:none;" class="thFont8">'||TO_CHAR(ROUND(vnPromProfM,2),'90.99')||'</th>
                    <th valign="top" '||vsLongCelda||' style="border-left:none;"  class="thFont8">'||TO_CHAR(ROUND(vnPromProfD,2),'90.99')||'</th>');

             if vnPromCollM > 0 then
                vnPromCollM := vnPromCollM/cn16;
             end if;

             if vnPromCollD > 0 then
                vnPromCollD := vnPromCollD/cn16;
             end if;

             -- promedio de la escuela
             htp.p('<th valign="top" '||vsLongCelda||' style="border-right:none;" class="thFont8">'||TO_CHAR(ROUND(vnPromCollM,2),'90.99')||'</th>
                    <th valign="top" '||vsLongCelda||' style="border-left:none;"  class="thFont8">'||TO_CHAR(ROUND(vnPromCollD,2),'90.99')||'</th>');

             htp.p('</tr><tr class="trTabSepara"><td colspan="'||TO_CHAR( (vnCursos * 2) + 6)||'" bgcolor="#ffffff" style="border-right:none;border-left:none;"></td></tr>');
          END IF;

          vsTeqaCode := tabPromCrn(vnI).rTeqaCode;

          if vnI = cn19 then
             exit;
          end if;
      end loop;

      htp.p('</table>');
  exception
      when others then
           htp.p('ERROR'||sqlerrm);

  end P_ReactivosEncuesta;

  -- muestra la media y la desviacin por categora
  procedure P_MediaPorCategoria(psCategoria varchar2,
                                pnRegistros integer) is

  vnPreguntas number  := 0;
  vnMedia     number  := 0;
  vnDesvi     number  := 0;
  vnRenglon   integer := 0;
  vnReactivo  integer := 0;
  vnMedCero   integer := 0; --es un contador cuando una media es cero, en el caso de posgrado cuando todos los alumnos evaluaron un reactivo con no aplica

  begin
      for vnI in 1..pnRegistros loop
          vnReactivo := vnReactivo + 1;

          if tabPromCrn(vnI).rTeqaCode = psCategoria then
             vnPreguntas := vnPreguntas + 1;

             if vnPreguntas = 1 then
                vnRenglon := vnI;
             end if;

             -- las instrucciones son agregradas para contemplar la evaluacin de posgrado
             -- la media es igual a cero cuando todos los alumnos evaluaron con no aplica
             if tabPromCrn(vnI).rMedia = 0 then
                vnMedCero := vnMedCero + 1;
             end if;

             vnMedia := vnMedia + tabPromCrn(vnI).rMedia;
             vnDesvi := vnDesvi + tabPromCrn(vnI).rDesvi;
          end if;

          if vnReactivo = cn19 then
             if vnPreguntas > 0 and vnMedia > 0 then
                vnMedia := vnMedia/(vnPreguntas-vnMedCero);
             end if;

             if vnPreguntas > 0 and vnDesvi > 0 then
                vnDesvi := vnDesvi/(vnPreguntas-vnMedCero);
             end if;

             tabPromCrn(vnRenglon).rMedCat := vnMedia;
             tabPromCrn(vnRenglon).rDesCat := vnDesvi;

             vnReactivo  := 0;
             vnPreguntas := 0;
             vnMedia     := 0;
             vnDesvi     := 0;
             vnRenglon   := 0;
             vnMedCero   := 0;
          end if;
      end loop;
  end P_MediaPorCategoria;

  -- muestra la media y la desviacin por categora de la escuela
  procedure P_MediaPorCategoriaColl(psCategoria varchar2,
                                    pnRegistros integer) is

  vnPreguntas number  := 0;
  vnMedia     number  := 0;
  vnDesvi     number  := 0;
  vnRenglon   integer := 0;
  vnMedCero   integer := 0;

  begin
      for vnI IN 1..pnRegistros loop
          if tabPromCrn(vnI).rTeqaCode = psCategoria then
             vnPreguntas := vnPreguntas + 1;

             if vnPreguntas = 1 then
                vnRenglon := vnI;
             end if;

             if tabPromCrn(vnI).rMedColl = 0 then
                vnMedCero := vnMedCero + 1;
             end if;

             vnMedia     := vnMedia + tabPromCrn(vnI).rMedColl;
             vnDesvi     := vnDesvi + tabPromCrn(vnI).rDesColl;
          end if;
      end loop;

      if vnPreguntas > 0 and vnMedia > 0 then
         vnMedia := vnMedia/(vnPreguntas-vnMedCero);
      end if;

      if vnPreguntas > 0 and vnDesvi > 0 then
         vnDesvi := vnDesvi/(vnPreguntas-vnMedCero);
      end if;

      tabPromCrn(vnRenglon).rMedCatColl := vnMedia;
      tabPromCrn(vnRenglon).rDesCatColl := vnDesvi;

  end P_MediaPorCategoriaColl;

  BEGIN
      -- valida que el usuario pertenezca a la base de datos
      IF psSiu IS NULL THEN
         IF pk_login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;
      ELSE
         IF NOT twbkwbis.F_ValidUser(global_pidm) THEN
            RETURN;
         END IF;

         SELECT DECODE(COUNT(1),0,NULL,'D')
           INTO vsDireSic
           FROM SIRNIST A
          WHERE A.SIRNIST_PIDM      = global_pidm
            AND A.SIRNIST_TERM_CODE = (SELECT MAX(B.SIRNIST_TERM_CODE)
                                         FROM SIRNIST B
                                        WHERE B.SIRNIST_PIDM = global_pidm
                                      )
            AND A.SIRNIST_NIST_CODE IN ('DIRE','SICC');
      END IF;

      vsUniv := pk_objHtml.getValueCookie('psSprUn');
      vsEncu := pk_objHtml.getValueCookie('psSeprd');
      vsTerm := pk_objHtml.getValueCookie('psSprTP');
      vsColl := pk_objHtml.getValueCookie('psSColP');
      vnPidm := pk_objHtml.getValueCookie('psSprPd');
      vsPtrm := NVL(pk_objHtml.getValueCookie('psPtrmP'),'/');

      pk_Seprad1.P_IdNameProfesor(vnPidm, vsId, vsNombre);

      FOR regPro IN cuPromedio(vsTerm, vsColl, vnPidm, vsUniv, vsEncu, vsPtrm) LOOP
          IF vsDireSic IS NULL AND psSiu IS NOT NULL THEN
             SELECT COUNT(1)
               INTO vnRollado
               FROM SFRSTCR
              WHERE SFRSTCR_TERM_CODE = vsTerm
                AND SFRSTCR_CRN       = regPro.Crn
                AND SFRSTCR_GRDE_DATE IS NULL
                AND SFRSTCR_RSTS_CODE IN (SELECT STVRSTS_CODE FROM STVRSTS WHERE STVRSTS_GRADABLE_IND = 'Y');
          END IF;

          IF vnRollado = 0 THEN
             vnRow := vnRow + 1;

             tabPromCrn(vnRow).rTeqaCode    := regPro.teqaCode;
             tabPromCrn(vnRow).rTeqaDesc    := regPro.teqaDesc;
             tabPromCrn(vnRow).rQcodCode    := regPro.qcodCode;
             tabPromCrn(vnRow).rQcodDesc    := regPro.qcodDesc;
             tabPromCrn(vnRow).rCrn         := regPro.Crn;
             tabPromCrn(vnRow).rMedia       := regPro.Media;
             tabPromCrn(vnRow).rDesvi       := regPro.Desviacion;
             tabPromCrn(vnRow).rTitle       := regPro.Title;
             tabPromCrn(vnRow).rContestaron := regPro.Contestaron;
             tabPromCrn(vnRow).rContestaro2 := regPro.Contestaron2;
             tabPromCrn(vnRow).rInscritos   := regPro.Inscritos;
             tabPromCrn(vnRow).rVppMedCrn   := 0;
             tabPromCrn(vnRow).rVppDesCrn   := 0;
             tabPromCrn(vnRow).rMediaCero   := regPro.MediaCero;
             tabPromCrn(vnRow).rMedZero     := 0;
          END IF;

          vnRollado := 0;
      END LOOP;


      FOR regPreg IN pk_Seprad1.cuPreguntas LOOP
          P_MediaPorCategoria(regPreg.Categ, vnRow);
      END LOOP;

      -- promedios de la escuela
      FOR regMC IN PK_Seprad1.cuMediaEscuela(vsTerm, vsColl, vsUniv, vsEncu, vsPtrm) LOOP

          vnRowColl := vnRowColl + 1;

          tabPromCrn(vnRowColl).rMedColl := regMC.Media;
          tabPromCrn(vnRowColl).rDesColl := regMC.Desvi;
          tabPromCrn(vnRowColl).rConColl := regMC.Contestaron;
          tabPromCrn(vnRowColl).rInsColl := regMC.Inscritos;
          tabPromCrn(vnRowColl).rGruColl := regMC.Grupos;
      END LOOP;

      FOR regPreg IN pk_Seprad1.cuPreguntas LOOP
          P_MediaPorCategoriaColl(regPreg.Categ, vnRowColl);
      END LOOP;

      htp.p('<html><head><title>'||psReclDesc||' - '||psSiu||'</title>');

      -- la aplicacin no se guarda en el cache de la mquina
      PK_ObjHTML.P_NoCache;

      -- cdigo css
      PK_ObjHTML.P_CssTabs;

      htp.p('<script language="JavaScript"><!--');
      htp.p('function fImprimeReporte() {
      window.focus()
      print();
      }');
      htp.p('//--></script>');

      htp.p('</head><body bgcolor="#ffffff" class="bodyCeroR"><br/>');
      htp.p('<script language="javascript" src="kwacnls.js"></script><br/>');
      htp.p('<table border="1" cellpadding="2" cellspacing="1" bordercolor="#ffffff" bgcolor="#ffffff" width="100%">
      <tr class="trTabSepara">
          <td rowspan="4" width="10%" valign="top"><img src="/imagenes/logo_uft.jpg'||'" width="80" border="0"></td>
          <td colspan="2" align="left" valign="top" class="tdTitulo"><b>'||REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(psReclDesc,'~aacute','&aacute'),'~eacute','&eacute'),'~iacute','&iacute'),'~oacute','&oacute'),'~uacute','&uacute')||':</b>&nbsp;'||vsNombre||' '||vsId||' RUT: '||f_get_rut(vnPidm)||'</td>
          </tr>
      <tr class="trTabSepara"><td valign="top" width="70%">'||'Evaluaciones de la Escuela o Facultad'||': '||pk_Seprad1.F_CollDesc(vsColl)||' '||vsTerm||' '||pk_Seprad1.F_TermDesc(vsTerm)||'</td>
                              <td valign="top" width="30%" align="right">'||pK_Seprad1.F_Fecha||'</td></tr>
      <tr class="trTabSepara"><td colspan="2">'||
      pK_Seprad1.F_PtrmCodeDesc(vsTerm,
                                psColl=>vsColl,
                                pnPidm=>vnPidm,
                                psCamp=>vsUniv,
                                psPtrm=>vsPtrm,
                                psEncs=>vsEncu
                               )||'</td></tr>
      <tr class="trTabSepara"><td colspan="2"></td></tr>
      </table><br/>');

      P_ReactivosEncuesta;

      htp.p('<br/></body></html>');
  END PWRPPCD;
/


DROP PUBLIC SYNONYM PWRPPCD;

CREATE PUBLIC SYNONYM PWRPPCD FOR BANINST1.PWRPPCD;


GRANT EXECUTE ON BANINST1.PWRPPCD TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRPPCD TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRPRAS;

CREATE OR REPLACE PROCEDURE BANINST1.PWRPRAS(psReclDesc VARCHAR2) IS

/*
         Tarea: Reporte de Pre-requisitos de Asignatura
        Modulo: Historia Academica
         Fecha: 20/01/2011.
         Autor: JCCR


        27 ENE 2011
        JCCR
        *  Nuevos Alcances,  Parametro de Escuela, Periodo NO requerido, Ajuste Cursor de Detalle
        29 ENE 2011
        JCCR
        * Ajuste de Leyenda Cursos.
        9 MAY 2013
        * Se cambia el orden de la informaci?n

*/


ckNombres   owa_cookie.vc_arr;
ckValores   owa_cookie.vc_arr;
ckCount     INTEGER;
vgsUSR      VARCHAR2(500);
global_pidm SPRIDEN.SPRIDEN_PIDM%TYPE;

  tabColumna  Pk_Sisrepimp.tipoTabla    := Pk_Sisrepimp.tipoTabla(1);
  vsError     VARCHAR2(500)             := NULL;
  vsPeriodo   VARCHAR2(7)               := NULL;
  vsNivel     VARCHAR2(2)               := NULL;
  vnColumnas  CONSTANT   INTEGER        := 12;
  vnContador  INTEGER                   := 0;
  vsEscuela   VARCHAR2(4)               := NULL;

  CURSOR cuDetalle (psLevel  VARCHAR2, psTerm VARCHAR2, psColl VARCHAR2 ) IS
        SELECT  SCRRTST_SUBJ_CODE                   AS  MATERIA,
                SCRRTST_CRSE_NUMB                   AS  CURSO,
                SCBCRSE_TITLE                       AS  TITCURSO,
                SCRRTST_TERM_CODE_EFF               AS  PERIODO,
                SCRRTST_SUBJ_CODE_PREQ              AS  PMATERIA,
                SCRRTST_CRSE_NUMB_PREQ              AS  PCURSO,
                ( SELECT MAX(SCBCRSE_TITLE)
                    FROM SCBCRSE
                   WHERE SCBCRSE_SUBJ_CODE = SCRRTST_SUBJ_CODE_PREQ
                     AND SCBCRSE_CRSE_NUMB = SCRRTST_CRSE_NUMB_PREQ
                )                                   AS  PTITCURSO,
                SCRRTST_MIN_GRDE                    AS  PCALIF,
                NVL(SCRRTST_CONCURRENCY_IND,'')     AS  PSERIALIZA,
                SCRCORQ_SUBJ_CODE_CORQ              AS  CMATERIA,
                SCRCORQ_CRSE_NUMB_CORQ              AS  CCURSO,
                ( SELECT MAX(SCBCRSE_TITLE)
                    FROM SCBCRSE
                   WHERE SCBCRSE_SUBJ_CODE = SCRCORQ_SUBJ_CODE_CORQ
                     AND SCBCRSE_CRSE_NUMB = SCRCORQ_CRSE_NUMB_CORQ
                )                                   AS  CTITCURSO,
                SCRRTST_TERM_CODE_EFF               AS  FTERM
           FROM SCRRTST, SCBCRSE, SCRCORQ
        WHERE (SCRRTST_TERM_CODE_EFF >= psTerm OR psTerm IS NULL)
          AND SCRRTST_LEVL_CODE      =  psLevel
          AND SCBCRSE_SUBJ_CODE      =  SCRRTST_SUBJ_CODE
          AND SCBCRSE_CRSE_NUMB      =  SCRRTST_CRSE_NUMB
          AND SCBCRSE_EFF_TERM       =  SCRRTST_TERM_CODE_EFF
          AND (SCBCRSE_COLL_CODE     =  psColl OR psColl IS NULL)
          AND SCRRTST_SUBJ_CODE      =  SCRCORQ_SUBJ_CODE (+)
          AND SCRRTST_CRSE_NUMB      =  SCRCORQ_CRSE_NUMB (+)
--        ORDER BY SCRRTST_TERM_CODE_EFF, SCRRTST_SUBJ_CODE,
--                 SCRRTST_CRSE_NUMB  ; --orden anterior
        ORDER BY SCRRTST_SUBJ_CODE, SCRRTST_CRSE_NUMB, SCRRTST_SUBJ_CODE_PREQ,
                 SCRRTST_CRSE_NUMB_PREQ, SCRCORQ_SUBJ_CODE_CORQ, SCRCORQ_CRSE_NUMB_CORQ;


    function CabeceroTBL return varchar2 is
  begin

     return '<table border="0" cellpadding="2" cellspacing="1" bordercolor="#dddddd" bgcolor="#ffffff" width="100%">
                <tr class="trTabSepara">
                  <td rowspan="2" width="20%" valign="top"><img src="/wtlgifs/logo_uft.jpg" width="100" border="0"></td>
                  <td width="80%" align="center" valign="middle" class="tdTitulo"><b>UNIVERSIDAD FINIS TERRAE</td>
                </tr>
                <tr>
                  <td align="center" valign="middle" class="tdTitulo">'||REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(psReclDesc,'~aacute','&aacute'),'~eacute','&eacute'),'~iacute','&iacute'),'~oacute','&oacute'),'~uacute','&uacute')||'.</td>
                </tr>
              </table><br/>
                <table border="1" cellpadding="2" cellspacing="1"  bordercolor="#dddddd" bgcolor="#ffffff" width="100%">
                <tr  class="trSeparador">
                    <td rowspan="2" bgcolor="#efefef" style="text-align: center"><B>Materia</B></td>
                    <td rowspan="2" bgcolor="#efefef" style="text-align: center"><B>Curso</B></td>
                    <td rowspan="2" bgcolor="#efefef" style="text-align: center"><B>Titulo de Curso</B></td>
                    <td rowspan="2" bgcolor="#efefef" style="text-align: center"><B>Periodo</B></td>
                    <td colspan="5" bgcolor="#efefef" style="text-align: center"><B>Prerrequisitos</B></td>
                    <td colspan="3" bgcolor="#efefef" style="text-align: center"><B>Correquisitos</B></td>
                </tr>
                <tr  class="trSeparador">
                    <td bgcolor="#efefef" style="text-align: center"><B>Materia</B></td>
                    <td bgcolor="#efefef" style="text-align: center"><B>Curso</B></td>
                    <td bgcolor="#efefef" style="text-align: center"><B>Descripci?n de Curso</B></td>
                    <td bgcolor="#efefef" style="text-align: center"><B>Calificaci?n</B></td>
                    <td bgcolor="#efefef" style="text-align: center"><B>Seriaci?n</B></td>
                    <td bgcolor="#efefef" style="text-align: center"><B>Materia</B></td>
                    <td bgcolor="#efefef" style="text-align: center"><B>Curso</B></td>
                    <td bgcolor="#efefef" style="text-align: center"><B>Descripci?n de Curso</B></td>
                </tr>';

  end CabeceroTBL;


  BEGIN

      /* Check/update the user's web session */
    IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
    vsNivel   := pk_objHtml.getValueCookie('psNivel');
    vsPeriodo := pk_objHtml.getValueCookie('psPerio');
    vsEscuela := pk_objHtml.getValueCookie('psEscu');

    htp.p('<html><head><title>'||psReclDesc||'</title>');
    -- la aplicaci&oacute;n no se guarda en el cache de la maquina.
    PK_ObjHTML.P_NoCache;
    --c&oacute;digo css
    PK_ObjHTML.P_CssTabs;

    htp.p('      <style type="text/css"><!--
      body             {margin-left: 2pt; margin-right: 2pt; margin-top: 2pt;margin-bottom: 2pt;}
            body.bodyWait    {margin-left: 5pt; margin-right: 5pt; margin-top: 5pt;margin-bottom: 5pt;cursor:wait;}
      body.BodyNormal  {margin-left: 2pt; margin-right: 2pt; margin-top: 2pt;margin-bottom: 2pt;}

      table           {border-collapse:collapse;border:none;}
      tr              {height:20px;}
      tr.trSeparador  {height:8px;}
      tr.trSeparador5 {height:5px;}
      th {font-SIZE:10.0.0pt; font-family:Arial Narrow, verdana, helvetica, sans-serif;}
      th.th12 {font-SIZE:12.0pt; font-family:Arial Narrow, verdana, helvetica, sans-serif;}
      th.th06 {font-SIZE:06.0pt;  mso-bidi-font-SIZE:6.0pt;}
      th.th05 {font-SIZE:05.0pt;  mso-bidi-font-SIZE:5.0pt;}
      li {font-SIZE:10.0pt; font-family:Arial Narrow, verdana, helvetica, sans-serif;}
      td {font-SIZE:8.0pt; font-family:Arial Narrow, verdana, helvetica, sans-serif;}
      font.font10 {font-SIZE:10.0.0pt; font-family:Arial Narrow, verdana, helvetica, sans-serif;}
      td.tdTitulo {font-SIZE:14.0pt; }
      td.tdLabel  {font-size:11pt; background-color:#FFBA6B; font-weight:bold;}
      th.thTitulo {font-SIZE:14.0pt; }
      td.tdfont7 {font-SIZE:7.0pt;  mso-bidi-font-SIZE:7.0pt;}
      td.tdfont6 {font-SIZE:6.0pt;  mso-bidi-font-SIZE:6.0pt;}
      td.tdfont5 {font-SIZE:5.0pt;  mso-bidi-font-SIZE:5.0pt;}
      br.brNuevaPag   {page-break-before:always}
      --></style>');

    htp.p('<script language="JavaScript"><!--');
    htp.p('function fImprimeReporte() {
              window.focus()
              print();}');
    htp.p('//--></script>');
    htp.p('</head><body bgcolor="#ffffff" class="bodyCeroR">');
    htp.p('<script language="javascript" src="kwacnls.js"></script>');

    htp.p(CabeceroTBL);


      FOR regAsigna IN cuDetalle(vsNivel, vsPeriodo, vsEscuela)  LOOP

         vnContador   := vnContador + 1;
         IF ( vnContador > 30) THEN
             htp.p('</table><BR class="brNuevaPag"/></BR>');
             htp.p(CabeceroTBL);
             vnContador := 1;
         END IF;

         htp.p('<TR>');
         htp.p('<TD align="CENTER" valign="middle">'||regAsigna.MATERIA||'</TD>');
         htp.p('<TD align="CENTER" valign="middle">'||regAsigna.CURSO||'</TD>');
         htp.p('<TD align="LEFT" valign="middle">'||regAsigna.TITCURSO||'</TD>');
         htp.p('<TD align="CENTER" valign="middle">'||regAsigna.PERIODO||'</TD>');
         htp.p('<TD align="CENTER" valign="middle">'||regAsigna.PMATERIA||'</TD>');
         htp.p('<TD align="CENTER" valign="middle">'||regAsigna.PCURSO||'</TD>');
         htp.p('<TD align="LEFT" valign="middle">'||regAsigna.PTITCURSO||'</TD>');
         htp.p('<TD align="CENTER" valign="middle">'||regAsigna.PCALIF||'</TD>');
         htp.p('<TD align="CENTER" valign="middle">'||regAsigna.PSERIALIZA||'</TD>');
         htp.p('<TD align="CENTER" valign="middle">'||regAsigna.CMATERIA||'</TD>');
         htp.p('<TD align="CENTER" valign="middle">'||regAsigna.CCURSO||'</TD>');
         htp.p('<TD align="LEFT" valign="middle">'||regAsigna.CTITCURSO||'</TD>');
         htp.p('</TR>');

      END LOOP;

      IF (vnContador = 0) THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||PK_sisRepImp.vgsResultado||'</font></th></tr>');
      END IF;

      htp.p('</table></BR>');
      htp.p('</BODY></HTML>');

  EXCEPTION
      WHEN NO_DATA_FOUND THEN
          htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||PK_sisRepImp.vgsResultado||'</font></th></tr>');
          htp.p('</table></BR>');
      WHEN OTHERS THEN
            vsError := SUBSTR(SQLERRM,1,500);
          htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000"><P>GENERACION DE REPORTE DE PRE-REQUISITOS ASIGNATURA --> '||vsError||' </P></font></th></tr>');
          htp.p('</table></BR>');
  END PWRPRAS;
/


DROP PUBLIC SYNONYM PWRPRAS;

CREATE PUBLIC SYNONYM PWRPRAS FOR BANINST1.PWRPRAS;


GRANT EXECUTE ON BANINST1.PWRPRAS TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRPRAS TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRPRCL;

CREATE OR REPLACE PROCEDURE BANINST1.PWRPRCL(psReclDesc VARCHAR2) IS
vnRow        INTEGER                          := 0;
vnExists     INTEGER                          := 0;
vnColumnas   INTEGER                          := 6;
vnSaltoPag   INTEGER                          := 30; --la variables utilizada para determinar la cantidad de registros que tiene una tabla para dar un salto de pagina
tabColumna   Pk_Sisrepimp.tipoTabla          := Pk_Sisrepimp.tipoTabla(1);
tabSubColu   Pk_Sisrepimp.tipoTabla          := Pk_Sisrepimp.tipoTabla(1);
vsTipo       VARCHAR2(3)                      := NULL;  --objeto/usuario
vsUsuario    VARCHAR2(50)                     := NULL;
vsSeccion    VARCHAR2(3)                      := NULL;
vsdescripcion  VARCHAR2(3)                      := NULL;
CURSOR cUsuarios(psUser VARCHAR2 DEFAULT NULL) IS
select  GURUCLS_USERID Usuario,
GURIDEN_DESC   Nombre,
        guruobj_object Objeto,
        GUBOBJS_DESC   Descripcion,
        gurucls_class_code Clase,
        guruobj_role     Rol
from bansecr.guruobj a, bansecr.gurucls
,gubobjs s,  guriden g
where gurucls_class_code = guruobj_userid
and s.GUBOBJS_NAME = guruobj_object
     and g.GURIDEN_USER_ID = GURUCLS_USERID
     and (GURUCLS_USERID    = psUser OR psUser IS NULL)
     order by GURUCLS_USERID;

/*    select v.twvusuo_userid usuario,
           g.guriden_desc    nombre,
           v.twvusuo_object    objeto,
           s.gubobjs_desc    descripcion,
           v.twvusuo_class    clase,
           v.twvusuo_role     rol
from twvusuo v,
gubobjs s,
       guriden g
where (v.twvusuo_userid  = psuser or psuser is null)
and v.twvusuo_object   = s.gubobjs_name(+)
and v.twvusuo_userid   = g.guriden_user_id(+)
order by twvusuo_userid;
*/

  vgsUSR       VARCHAR2(500);
  ckCount      INTEGER;
  ckNombres    owa_cookie.vc_arr;
  ckValores    owa_cookie.vc_arr;
  vgsUsuario   VARCHAR2(300) := NULL;
  vgsInicoPag  VARCHAR2(10)  := NULL;       -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pagina para impresion

BEGIN
/* check/update the user's web session */
IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;
--son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
owa_cookie.get_all(ckNombres,ckValores,ckCount);
IF ckCount != 0 THEN
     FOR vnCOKIES IN 1..ckCount LOOP
             /*if cknombres(vncokies)    = 'psusuobj' then
           vstipo      := ckvalores(vncokies);*/
     IF ckNOMBRES(vnCOKIES) = 'psUser' THEN
           vsUsuario   := ckValores(vnCOKIES);
     ELSIF ckNOMBRES(vnCOKIES) = 'cookUsuario' THEN
vgsUsuario := ckValores(vnCOKIES);
             ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
           vsSeccion := ckValores(vnCOKIES);
END IF;
END LOOP;
END IF;
-- las instrucciones determinan el largo de la tabla
FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabSubColu.EXTEND(vnI);
          tabColumna(vnI) := NULL;
          tabSubColu(vnI) := NULL;
      END LOOP;

tabSubColu(1)  := 'Usuario ';
      tabSubColu(2)  := 'Nombre';
tabSubColu(3)  := 'Clase ';
      tabSubColu(4)  := 'Objeto';
      tabSubColu(5)  := 'Descripcion';
      tabSubColu(6)  := 'Role';

      --tabsubcolu(5)  := 'descripcion';
FOR regRep IN cUsuarios(vsUsuario) LOOP
    IF (vsUsuario IS NULL OR vsUsuario <> regRep.Usuario OR
        vnRow = 0 OR vnRow = 30) THEN
        --p_encabezadodereporte(psrecldesc,vncolumnas,tabcolumna,vgsinicopag,'0',psusuario => vgsusuario);
Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vgsInicoPag,'1','#000000',psUsuario=>vgsUSR,psSeccion=>vsSeccion);
vgsInicoPag := 'SALTO';
        vnRow := 0;
        -- el procedimiento muestra sub titulos del reporte
        --p_Columnas(vnColumnas,tabSubColu);
        IF tabSubColu IS NOT NULL THEN
                Pk_Sisrepimp.vgsColor := tabSubColu(1);
              END IF;

              htp.p('<tr bgcolor="'||Pk_Sisrepimp.vgsColor||'">');
              FOR vnI IN 1..vnColumnas LOOP
                htp.p('<th class="h3" align="left" valign="bottom" bgcolor="#b1c9e1">'||tabSubColu(vnI)||'</th>');  --"#ffcc99"
              END LOOP;
        htp.p('</tr>');
END IF;
-- imprime los registros
htp.p('<tr><td valign="top">'||regRep.Usuario||'</td>
<td valign="top">'||regRep.Nombre||'</td>
                    <td valign="top">'||regRep.Clase||'</td>
                    <td valign="top">'||regRep.Objeto||'</td>
                    <td valign="top">'||regRep.Descripcion||'</td>
                    <td valign="top">'||regRep.rol||'</td>');
vnExists := 1;
        vnRow    := vnRow + 1;
        vsUsuario     := regRep.Usuario;
END LOOP;
      -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pagina para impresion
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';
vgsInicoPag:= 'PIE';
-- es omitido el encabezado del reporte pero se agrega el salto de pagina
Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vgsInicoPag,'0', psUsuario=>vgsUSR, psSeccion=>vsSeccion);
      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      END IF;
      htp.p('</table></body></html>');
EXCEPTION
WHEN OTHERS THEN
           HTP.P(SQLERRM);
END PWRPRCL;
/


DROP PUBLIC SYNONYM PWRPRCL;

CREATE PUBLIC SYNONYM PWRPRCL FOR BANINST1.PWRPRCL;


GRANT EXECUTE ON BANINST1.PWRPRCL TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRPRCL TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRPRCL TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRPRCL TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRPRCL TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRPRER;

CREATE OR REPLACE PROCEDURE BANINST1.PWRPRER (psrecldesc VARCHAR2) IS

ckNombres    owa_cookie.vc_arr;
ckValores    owa_cookie.vc_arr;
ckCount      INTEGER;
vgsInicoPag  VARCHAR2(10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
vgsUSR       VARCHAR2(500);

      vnrow         INTEGER                := 0;
      vnexists      INTEGER                := 0;
      vncolumnas    INTEGER                := 8;
      vnregs        INTEGER                := 0;
      tabcolumna    pk_sisrepimp.tipotabla := pk_sisrepimp.tipotabla (1);
      vsperio       VARCHAR2 (20)          := NULL;
      vsuniv        VARCHAR2 (20)          := NULL;
      vsprogr       VARCHAR2 (20)          := NULL;
      vsEscu        VARCHAR2 (20)          := NULL;
      vsid          VARCHAR2 (20)          := NULL;
      vsseccion     VARCHAR2 (3)           := NULL;
      vsperiodo     VARCHAR2 (20)          := NULL;
      vsnrc         VARCHAR2 (1000)        := NULL;
      vsnrcpre      VARCHAR2 (1000)        := NULL;
      vsacredita    VARCHAR2 (1000)        := NULL;
      vsnrcacre     VARCHAR2 (1000)        := NULL;
      vsmateria     VARCHAR2 (1000)        := NULL;
      vsacedita     VARCHAR2 (1000)        := NULL;
      vsStyle       VARCHAR2 (70)          := NULL;

      CURSOR cureporte (
         puniv     VARCHAR2 DEFAULT NULL,
         pperio    VARCHAR2 DEFAULT NULL,
         pprogr    VARCHAR2 DEFAULT NULL,
         psEscu   VARCHAR2 DEFAULT NULL
      ) IS
         SELECT   sfrstcr_term_code periodo,
                  NVL (a.sgbstdn_camp_code, 'S/Unive') cveuniversidad,
                  NVL
                     (pk_catalogo.universidad (a.sgbstdn_camp_code),
                      'SIN UNIVERSIDAD'
                     ) descuniversidad,
                  a.sgbstdn_program_1 cveprograma,
                  pk_catalogo.programa (a.sgbstdn_program_1) descprograma,
                  spriden_pidm pidm, spriden_id ID,
                  pk_catalogo.nombre (spriden_pidm) nombre, sfrstcr_crn crn,
                  f_get_rut(spriden_pidm) rut,
                  ssbsect_subj_code subj, ssbsect_crse_numb curso,
                     ssbsect_subj_code
                  || ' '
                  || ssbsect_crse_numb
                  || ' '
                  || ssbsect_crn materia
             FROM sgbstdn a, spriden, sfrstcr, ssbsect
            WHERE sfrstcr_pidm = a.sgbstdn_pidm
              AND spriden_change_ind IS NULL
              AND a.sgbstdn_term_code_eff =
                     (SELECT MAX (b.sgbstdn_term_code_eff)
                        FROM sgbstdn b
                       WHERE b.sgbstdn_pidm = a.sgbstdn_pidm
                         AND b.sgbstdn_stst_code = 'AS'
                         AND b.sgbstdn_term_code_eff <= sfrstcr_term_code)
              AND sfrstcr_pidm = spriden_pidm
              AND sfrstcr_rsts_code IN ('RE', 'RW')
              AND sfrstcr_term_code = ssbsect_term_code
              AND sfrstcr_crn = ssbsect_crn
              AND (sfrstcr_term_code = pperio OR pperio IS NULL)
              AND (a.sgbstdn_camp_code = puniv OR puniv IS NULL)
              AND (a.sgbstdn_program_1 = pprogr OR pprogr IS NULL)
              AND (a.sgbstdn_coll_code_1 = psEscu OR psEscu IS NULL)
      --   AND spriden_pidm = 2573
         ORDER BY periodo DESC, descuniversidad, descprograma, nombre;

-- Cursor para obtener los NRC's prerrequisito utilizando la forma: SSAPREQ
      CURSOR cunrcpre (pperio VARCHAR2, pcrn VARCHAR2) IS
         SELECT    DECODE (ssrrtst_connector,
                           'A', 'AND',
                           'O', 'OR'
                          )
                || ' '
                || ssrrtst_lparen
                || ' '
                || ssrrtst_subj_code_preq
                || ' '
                || ssrrtst_crse_numb_preq
                || ' '
                || ssrrtst_test_score
                || ' '
                || ssrrtst_rparen prerrequisito,
                ssrrtst_subj_code_preq subject, ssrrtst_crse_numb_preq course
           FROM ssrrtst a
          WHERE ssrrtst_term_code = pperio AND ssrrtst_crn = pcrn;

--MCC CURSOR PARA SABER SI ACREDITO EL SUBJECT Y COURSE
      CURSOR cuacredita (ppidm NUMBER, pperio VARCHAR2, pcrn VARCHAR2) IS
         SELECT (CASE
                    WHEN f_calif (shrtckg_grde_code_final) = 'N' THEN    'No acreditada '
                                                                      || shrtckn_subj_code
                                                                      || ' '
                                                                      || shrtckn_crse_numb
                    ELSE    'Acreditada '
                         || ssrrtst_subj_code_preq
                         || ' '
                         || ssrrtst_crse_numb_preq
                 END
                ) resultado
           FROM shrtckn a, shrtckg, ssrrtst
          WHERE ssrrtst_term_code = pperio
            AND ssrrtst_crn = pcrn
            AND shrtckn_pidm = ppidm
            AND shrtckn_subj_code = ssrrtst_subj_code_preq
            AND shrtckn_crse_numb = ssrrtst_crse_numb_preq
            AND shrtckn_term_code =
                   (SELECT MAX (w.shrtckn_term_code)
                      FROM shrtckn w
                     WHERE w.shrtckn_pidm = a.shrtckn_pidm
                       AND w.shrtckn_subj_code = a.shrtckn_subj_code
                       AND w.shrtckn_crse_numb = a.shrtckn_crse_numb)
            AND shrtckg_pidm = shrtckn_pidm
            AND shrtckg_term_code = shrtckn_term_code
            AND shrtckg_tckn_seq_no = shrtckn_seq_no
            AND shrtckg_seq_no =
                   (SELECT MAX (shrtckg_seq_no)
                      FROM shrtckg
                     WHERE shrtckg_pidm = shrtckn_pidm
                       AND shrtckg_term_code = shrtckn_term_code
                       AND shrtckg_tckn_seq_no = shrtckn_seq_no);
--         UNION ALL
--         SELECT sortest_test_score
--           FROM sortest
--          WHERE sortest_test_score IS NOT NULL
--            AND sortest_pidm = ppidm
--            AND EXISTS (
--                   SELECT NULL
--                     FROM ssrrtst
--                    WHERE ssrrtst_term_code = pperio
--                      AND ssrrtst_crn = pcrn
--                      AND ssrrtst_tesc_code = sortest_tesc_code);
   BEGIN
/* Check/update the user's web session */
      IF PK_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

--son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckcount := 0;
      OWA_COOKIE.get_all (cknombres, ckvalores, ckcount);

      IF ckcount != 0 THEN
         FOR vncokies IN 1 .. ckcount LOOP
            IF cknombres (vncokies) = 'psUnive' THEN
               vsuniv := ckvalores (vncokies);
            ELSIF cknombres (vncokies) = 'psPerio' THEN
               vsperio := ckvalores (vncokies);
            ELSIF cknombres (vncokies) = 'psProgr' THEN
               vsprogr := ckvalores (vncokies);
            ELSIF cknombres (vncokies) = 'psEscu' THEN
               vsEscu := ckvalores (vncokies);

            ELSIF cknombres (vncokies) = 'cookSeccion' THEN
               vsseccion := ckvalores (vncokies);
            END IF;
         END LOOP;
      END IF;

-- las instrucciones determinan el largo de la tabla
      FOR vni IN 1 .. vncolumnas LOOP
         tabcolumna.EXTEND (vni);
         tabcolumna (vni) := NULL;
      END LOOP;

      tabcolumna (1) := 'Programa';
      tabcolumna (2) := 'Descripci&oacute;n';
      tabcolumna (3) := 'ID';
      tabcolumna (4) := 'RUT';
      tabcolumna (5) := 'Nombre';
      tabcolumna (6) := 'Materias inscritas';
      tabcolumna (7) := 'Prerrequisito';
      tabcolumna (8) := 'Acreditacin del prerrequisito';

      FOR regrep IN cureporte (vsuniv, vsperio, vsprogr, vsEscu) LOOP
         IF    vsperiodo IS NULL
            OR vsperiodo <> regrep.periodo
            OR vsuniv IS NULL
            OR vsuniv <> regrep.cveuniversidad
            OR vnrow = 30 THEN
            pk_sisrepimp.p_encabezadodereporte
                                      (psrecldesc,
                                       vncolumnas,
                                       tabcolumna,
                                       vgsinicopag,
                                       '1',
                                       pssubtitulo        =>    'Periodo '
                                                             || regrep.periodo,
                                       psusuario          => vgsusr,
                                       psseccion          => vsseccion,
                                       psuniversidad      => regrep.cveuniversidad
                                      );
            vgsinicopag := 'SALTO';
            --p_columnas (vncolumnas, tabsubcolu);
            vnrow := 0;
         END IF;







         IF    (vsId IS NULL) OR (vsId <> regrep.ID) THEN
               htp.p('<tr>
               <td valign="top" style="border-bottom:none;">'||regrep.cveprograma || '</td>
               <td valign="top" style="border-bottom:none;">'||regrep.descprograma|| '</td>
               <td valign="top" style="border-bottom:none;">'||regrep.ID          || '</td>
               <td valign="top" style="border-bottom:none;">'||regrep.RUT          || '</td>
               <td valign="top" style="border-bottom:none;">'||regrep.nombre      || '</td>
               <td valign="top">'||regrep.materia     || '</td>');

         vsnrcpre    := NULL;                    --cursor para obtener los NRC's prerrequisito
         FOR regpre IN cunrcpre (regrep.periodo, regrep.crn) LOOP
            IF vsnrcpre IS NULL THEN
               vsnrcpre := regpre.prerrequisito;
            ELSE
               vsnrcpre := vsnrcpre || ' ' || regpre.prerrequisito;
            END IF;
         end loop;
            htp.p('
               <td valign="top">'||vsnrcpre           || '</td>');
         --         cursor para saber si acredito el subject y course
         vsacredita:= NULL;
         FOR regacre IN cuacredita (regrep.pidm, regrep.periodo, regrep.crn) LOOP
            IF vsacredita IS NULL THEN
               vsacredita := regacre.resultado;
            ELSE
               vsacredita := vsacredita || ' ' || regacre.resultado;
            END IF;
         END LOOP;

           htp.p ('<td valign="top">'||vsacredita         || '</td></tr>');
         ELSIF vsId = regrep.ID THEN
--               IF vnrow = 0 AND vsperiodo IS NOT NULL THEN
--                  vsStyle := NULL;
--               ELSE
--
--               END IF;
               vsStyle := 'style="border-bottom:none;border-top:none;"';
               htp.p('<tr>
               <td valign="top" '||vsStyle||'></td>
               <td valign="top" '||vsStyle||'></td>
               <td valign="top" '||vsStyle||'></td>
               <td valign="top" '||vsStyle||'></td>
               <td valign="top" '||vsStyle||'></td>
               <td valign="top">'||regrep.materia||'</td>');


            vsnrcpre    := NULL;
            FOR regpre IN cunrcpre (regrep.periodo, regrep.crn) LOOP
            IF vsnrcpre IS NULL THEN
               vsnrcpre := regpre.prerrequisito;
            ELSE
               vsnrcpre := vsnrcpre || ' ' || regpre.prerrequisito;
            END IF;
            end loop;
               htp.p('<td valign="top">'||vsnrcpre     ||'</td>');
               vsacredita:= NULL;
            FOR regacre IN cuacredita (regrep.pidm, regrep.periodo, regrep.crn) LOOP
            IF vsacredita IS NULL THEN
               vsacredita := regacre.resultado;
            ELSE
               vsacredita := vsacredita || ' ' || regacre.resultado;
            END IF;
            END LOOP;

            htp.p(' <td valign="top">'||vsacredita     ||'</td></tr>');
         END IF;

         vsperiodo   := regrep.periodo;
         vsuniv      := regrep.cveuniversidad;
         vsId        := regrep.ID;
         vnexists    := 1;
         vnrow       := vnrow + 1;

      END LOOP;

--      HTP.p
--         (   '<tr>
--<td style="border-top:solid 1.0px #000000;"></td>
--<td style="border-top:solid 1.0px #000000;"></td>
--<td style="border-top:solid 1.0px #000000;"></td>
--<td style="border-top:solid 1.0px #000000;"></td>
--<td valign="top">'
--          || vsmateria
--          || '</td>
--<td valign="top">'
--          || vsnrcacre
--          || '</td>
--<td valign="top">'
--          || vsacedita
--          || '</td></tr>'
--         );
      -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
      pk_sisrepimp.vgssaltoimp := 'Imprime';
-- es omitido el encabezado del reporte pero se agrega el salto de pagina
      pk_sisrepimp.p_encabezadodereporte (psrecldesc,
                                          vncolumnas,
                                          tabcolumna,
                                          'PIE',
                                          '0',
                                          psusuario      => vgsusr,
                                          psseccion      => vsseccion
                                         );

      IF vnexists = 0 THEN
         HTP.p (   '<tr><th colspan="'
                || vncolumnas
                || '"><font color="#ff0000">'
                || pk_sisrepimp.vgsresultado
                || '</font></th></tr>'
               );
      END IF;

      HTP.p ('</table></body></html>');
   EXCEPTION
      WHEN OTHERS THEN
         HTP.p (SQLERRM);
   END PWRPRER;
/


DROP PUBLIC SYNONYM PWRPRER;

CREATE PUBLIC SYNONYM PWRPRER FOR BANINST1.PWRPRER;


GRANT EXECUTE ON BANINST1.PWRPRER TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRPRER TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRPRGE;

CREATE OR REPLACE PROCEDURE BANINST1.PWRPRGE (psReclDesc VARCHAR2, psSiu VARCHAR2 DEFAULT NULL)
IS
   /*
      Tarea: PROGRAMA DE ESTUDIOS
      Fecha: 19/01/2006.
     Modulo: Catlogo de cursos
      Autor: GEPC
   */
   ckNombres     OWA_COOKIE.vc_arr
/


DROP PUBLIC SYNONYM PWRPRGE;

CREATE PUBLIC SYNONYM PWRPRGE FOR BANINST1.PWRPRGE;


GRANT EXECUTE ON BANINST1.PWRPRGE TO WWW_USER;
DROP PROCEDURE BANINST1.PWRPRTC;

CREATE OR REPLACE PROCEDURE BANINST1.PWRPRTC(psReclDesc VARCHAR2) IS

/**************************************************************
           tarea:  procedimiento para el reporte de participacin por programa
         mdulo:  registro estudiantil
           autor:  horacio martnez ramrez - hmr
           fecha:  07/sep/2010
**************************************************************/

  ckNombres    owa_cookie.vc_arr;
  ckValores    owa_cookie.vc_arr;
  ckCount      INTEGER;
  vgsInicoPag  VARCHAR2(10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vgsUSR       VARCHAR2(500);
  vnRow      INTEGER                := 0;
  vnExists   INTEGER                := 0;
  vnColumnas INTEGER                := 9;
  tabColumna Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vsPerio    VARCHAR2(6)            := NULL;
  vsUniv     VARCHAR2(6)            := NULL;
  vsCampCode VARCHAR2(6)           := NULL;
  vsTermCode VARCHAR2(6)            := NULL;
  vsProgrEsp VARCHAR2(50)           := NULL;
  vsProgr    VARCHAR2(20)           := NULL;
  vsSeccion  VARCHAR2(3)            := NULL;
  vsEnca     VARCHAR2(1)            := NULL;
  vbEnca     BOOLEAN                := TRUE;

  CURSOR cuReporte(psUniv     VARCHAR2 DEFAULT NULL,
                            psPerio    VARCHAR2 DEFAULT NULL,
                            psProgrEsp VARCHAR2 DEFAULT NULL,
                            psProgr    VARCHAR2 DEFAULT NULL ) IS

         SELECT SPRIDEN_ID                                                               Id,
                    SPBPERS_NAME_SUFFIX                                                  Rut,
                    SPRIDEN_PIDM                                                         Pidm,
                    REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME,'*',' ')          Nombre,
                    SFRST.PERIODO                                                        termCode,
                    Pk_Catalogo.PROGESPE(A.SGRSATT_ATTS_CODE)                            Programa,
                    A.SGRSATT_ATTS_CODE                                                  ProgramaCode,
                   SGBSTDN_RATE_CODE                                                     SITE,
                   (SELECT Pk_Catalogo.Standar(SHRTTRM_ASTD_CODE_END_OF_TERM)
                       FROM SHRTTRM
                     WHERE SHRTTRM_ASTD_CODE_END_OF_TERM IS NOT NULL
                         AND SHRTTRM_TERM_CODE              = SFRST.PERIODO
                         AND SHRTTRM_PIDM                   = SFRST.PIDM
                )                                                                    Estandar,
                C.SGBSTDN_PROGRAM_1                                                  Carrera,
                Pk_Catalogo.PROGRAMA(C.SGBSTDN_PROGRAM_1)                            DesCarrera,
                C.SGBSTDN_CAMP_CODE                                                  campCode,
                DECODE(SPBPERS_SEX,'F','Femenino','M','Masculino','N','No definido') Sexo,
                TO_CHAR(SPBPERS_BIRTH_DATE,'dd/mm/yyyy')                             Fechanac
           FROM (SELECT DISTINCT SFRSTCR_PIDM PIDM,SFRSTCR_TERM_CODE                 PERIODO
                   FROM SFRSTCR
                  WHERE SFRSTCR_RSTS_CODE  IN ('RE','RW')
                ) SFRST,
                SPRIDEN,
                SGRSATT A,
                SGBSTDN C,
                SPBPERS
          WHERE SPRIDEN_CHANGE_IND      IS NULL
            AND SPRIDEN_PIDM             = SFRST.PIDM
            AND SPRIDEN_PIDM             = SPBPERS_PIDM
            AND EXISTS (SELECT NULL
                          FROM SFBETRM
                         WHERE SFBETRM_TERM_CODE = SFRST.PERIODO
                           AND SFBETRM_PIDM      = SFRST.PIDM
                           AND SFBETRM_ESTS_CODE = 'EL'
                       )
            AND A.SGRSATT_PIDM             = SFRST.PIDM
            AND A.SGRSATT_ATTS_CODE       IS NOT NULL
            AND (
                 (    A.SGRSATT_TERM_CODE_EFF  = (SELECT MAX(B.SGRSATT_TERM_CODE_EFF)
                                                    FROM SGRSATT B
                                                   WHERE B.SGRSATT_PIDM           = A.SGRSATT_PIDM
                                                     AND B.SGRSATT_ATTS_CODE     IS NOT NULL
                                                     AND B.SGRSATT_TERM_CODE_EFF <= SFRST.PERIODO
                                                 )
                  AND '999999' = (SELECT NVL(MIN(E.SGRSATT_TERM_CODE_EFF),'999999')
                                    FROM SGRSATT E
                                   WHERE E.SGRSATT_TERM_CODE_EFF > (SELECT MAX(F.SGRSATT_TERM_CODE_EFF)
                                                                      FROM SGRSATT F
                                                                     WHERE F.SGRSATT_PIDM       = A.SGRSATT_PIDM
                                                                       AND F.SGRSATT_ATTS_CODE IS NOT NULL
                                                                       AND F.SGRSATT_TERM_CODE_EFF <= SFRST.PERIODO
                                                                   )
                                     AND E.SGRSATT_PIDM = A.SGRSATT_PIDM
                                 )
                 )
                 OR
                 A.SGRSATT_TERM_CODE_EFF = (SELECT MAX(B.SGRSATT_TERM_CODE_EFF)
                                              FROM SGRSATT B
                                             WHERE B.SGRSATT_PIDM           = A.SGRSATT_PIDM
                                               AND B.SGRSATT_ATTS_CODE     IS NOT NULL
                                               AND B.SGRSATT_TERM_CODE_EFF  = SFRST.PERIODO
                                           )
                )
            AND C.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(D.SGBSTDN_TERM_CODE_EFF)
                                             FROM SGBSTDN D
                                            WHERE D.SGBSTDN_PIDM      = SFRST.PIDM
                                              AND D.SGBSTDN_STST_CODE = 'AS'
                                          )
            AND C.SGBSTDN_STST_CODE     = 'AS'
            AND C.SGBSTDN_PIDM          = SFRST.PIDM
            AND (C.SGBSTDN_CAMP_CODE = psUniv     OR psUniv     IS NULL)
            AND (C.SGBSTDN_PROGRAM_1 = psProgr    OR psProgr    IS NULL)
            AND (A.SGRSATT_ATTS_CODE = psProgrEsp OR psProgrEsp IS NULL)
            AND (SFRST.PERIODO       = psPerio    OR psPerio    IS NULL)
          ORDER BY PERIODO DESC, ProgramaCode, NOMBRE;

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      -- son buscadas los valores de las cookies para asignar los valores del filtro del query
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
          FOR vnCOKIES IN 1..ckCount LOOP
                IF ckNOMBRES(vnCOKIES) = 'psPerio' THEN
                    vsPerio := ckValores(vnCOKIES);

                   ELSIF ckNOMBRES(vnCOKIES) = 'psUnive' THEN
                            vsUniv  := ckValores(vnCOKIES);

                   ELSIF ckNOMBRES(vnCOKIES) = 'psProEs' THEN
                            vsProgrEsp := ckValores(vnCOKIES);

                   ELSIF ckNOMBRES(vnCOKIES) = 'psProgr' THEN
                            vsProgr := ckValores(vnCOKIES);

                   ELSIF ckNOMBRES(vnCOKIES) = 'psEnca' THEN
                            vsEnca := ckValores(vnCOKIES);

                   ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                            vsSeccion := ckValores(vnCOKIES);

                END IF;
          END LOOP;
      END IF;

      -- las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1) := 'Id';
      tabColumna(2) := 'Rut';
      tabColumna(3) := 'Nombre';
      tabColumna(4) := 'Programa';
      tabColumna(5) := 'Descripci&oacute;n del programa';
      tabColumna(6) := 'Sexo';
      tabColumna(7) := 'Fecha de nacimiento';
      tabColumna(8) := 'Programa especial';
      tabColumna(9) := 'Est&aacute;ndar acad&eacute;mico';

      FOR regRep IN cuReporte(vsUniv, vsPerio, vsProgrEsp, vsProgr) LOOP

          IF (vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
              vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR
              vnRow = 30) AND vbEnca THEN

              Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vgsInicoPag,'1',psSubtitulo=>'Periodo '||regRep.termCode||'<br/>'||pk_Catalogo.fStvSite(regRep.SITE),psUsuario=>vgsUSR,psSeccion=>vsSeccion,psUniversidad=>regRep.campCode);
              vgsInicoPag := 'SALTO';

              vnRow  := 0;
          END IF;

          IF vsEnca = 'N' THEN
              vbEnca := FALSE;
          END IF;

          htp.p('<tr> <td valign="top" align="left">' ||regRep.Id        ||'</td>
                          <td valign="top" align="left">' ||regRep.Rut       ||'</td>
                          <td valign="top" align="left">' ||regRep.Nombre    ||'</td>
                          <td valign="top" align="left">' ||regRep.Carrera   ||'</td>
                          <td valign="top" align="left">' ||regRep.DesCarrera||'</td>
                          <td valign="top" align="left">' ||regRep.Sexo        ||'</td>
                          <td valign="top" align="left">' ||regRep.Fechanac  ||'</td>
                          <td valign="top" align="left">' ||regRep.Programa  ||'</td>
                          <td valign="top" align="left">' ||regRep.Estandar   ||'</td> </tr>' );

          vnRow      := vnRow + 1;
          vnExists   := 1;
          vsTermCode := regRep.termCode;
          vsCampCode := regRep.campCode;
      END LOOP;

      IF vnExists = 0 THEN
          htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
          -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pagina para impresion
          Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

          -- es omitido el encabezado del reporte pero se agrega el salto de pagina
          Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>vgsUSR, psSeccion=>vsSeccion);
      END IF;

      htp.p('</table></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
               htp.p(SQLERRM);

  END PWRPRTC;
/


DROP PUBLIC SYNONYM PWRPRTC;

CREATE PUBLIC SYNONYM PWRPRTC FOR BANINST1.PWRPRTC;


GRANT EXECUTE ON BANINST1.PWRPRTC TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRPRTC TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRPUCO;

CREATE OR REPLACE PROCEDURE BANINST1.PWRPUCO ( psReclDesc   VARCHAR2 ) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de privilegios por usuario
                (clases y objetos sueltos).
     prop?sito: obtener informaci?n de los privilegios de usuarios sobre clases
                y objetos sueltos.
        m?dulo: auditor?a - uft.
         autor: hmr - horacio mart?nez ram?rez.
         fecha: 22/06/2011.
*******************************************************************************/

  vnExists      INTEGER := 0;
  vnColumnas    INTEGER := 4;
  vgsInicioPag  VARCHAR2(30) := NULL;           -- bandera que al tener el valor "imprime", no colocar? el salto de p?gina para impresi?n
  tabColumna    Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vnIdRenglon   INTEGER := 1;
  vsUsuario     GURUCLS.GURUCLS_USERID%TYPE DEFAULT NULL;
  vsNombre      GURIDEN.GURIDEN_DESC%TYPE DEFAULT NULL;

  CURSOR cuReporte ( psUser   VARCHAR2 DEFAULT NULL ) IS

         SELECT 'CLASE'              TIPO,
                GURUCLS_CLASS_CODE   CODIGO,
                NULL                 DESC_FORMA,
                NULL                 ROL
           FROM BANSECR.GURUCLS
          WHERE GURUCLS_USERID = psUser
         UNION
         SELECT 'FORMA'                 TIPO,
                RU.GURUOBJ_OBJECT       CODIGO,
                UPPER(BO.GUBOBJS_DESC)  DESC_FORMA,
                RU.GURUOBJ_ROLE         ROL
           FROM BANSECR.GURUOBJ RU,
                GUBOBJS BO
          WHERE RU.GURUOBJ_USERID = psUser
            AND BO.GUBOBJS_NAME   = RU.GURUOBJ_OBJECT;


---------------------------------------------------
-- bloque principal para la generaci?n del reporte
---------------------------------------------------

BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsUsuario := pk_ObjHtml.getValueCookie('psUser');

   -- obtiene el nombre del usuario:
   BEGIN
      SELECT GURIDEN_DESC
        INTO vsNombre
        FROM GURIDEN
       WHERE GURIDEN_USER_ID = vsUsuario;
   EXCEPTION
      WHEN OTHERS THEN
           vsNombre := NULL;
   END;

   -- determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   -- define los encabezados de columnas:
   tabColumna(1) := '<center> Tipo de objeto';
   tabColumna(2) := '<center> C&oacute;digo de la clase / C&oacute;digo de la forma';
   tabColumna(3) := '<center> Nombre de la forma';
   tabColumna(4) := '<center> Rol de la forma';

   -- manipula la informaci?n obtenida por el cursor:
   FOR regRep IN cuReporte (vsUsuario) LOOP

       IF vnExists = 0 THEN

          -- muestra el encabezado seg?n el objeto seleccionado:
          IF vsUsuario IS NOT NULL THEN
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Usuario: '||vsUsuario||' - '||vsNombre, psUniversidad=>'UFT');
          END IF;

       END IF;

       -- despliega los valores para cada registro:
       htp.p('<tr> <td valign="top">' || regRep.TIPO       ||'</td>
                   <td valign="top">' || regRep.CODIGO     ||'</td>
                   <td valign="top">' || regRep.DESC_FORMA ||'</td>
                   <td valign="top">' || regRep.ROL        ||'</td>
              </tr>');

       vnExists    := 1;
       vnIdRenglon := vnIdRenglon + 1;

   END LOOP;

   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- bandera que al tener el valor "imprime" no colocar? el salto de p?gina para impresi?n:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- omite el encabezado del reporte pero se agrega el salto de p?gina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR);
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRPUCO;
/


DROP PUBLIC SYNONYM PWRPUCO;

CREATE PUBLIC SYNONYM PWRPUCO FOR BANINST1.PWRPUCO;


GRANT EXECUTE ON BANINST1.PWRPUCO TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRPUCO TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRRCRB;

CREATE OR REPLACE PROCEDURE BANINST1.PWRRCRB (
	psReclDesc			VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:		PWRRCRB
OBJETIVO:			Reporte de Control de Boletas y pagars por reprogramacin
PARAMETROS:
psReclDesc			Variable estandar para la maquina de reportes custom
AUTOR:				Gilberto Velazquez Hernandez
FECHA:				20121009
******************************************************************************/

	--Numero de renglones
	vnRow				PLS_INTEGER := 0;
	--Bandera para mostrar si hubo datos
	vnExists			INTEGER := 0;
	--Numero de columnas
	vnColumnas			INTEGER := 7;
	--Numero de registros
	vnRegs				INTEGER := 0;
	--Arreglo (nested table) donde se guardan los encabezados de las columnas
	tabColumna			Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
	-- la variable es una bandera que al tener el valor "imprime" no colocara
	--el salto de pgina para impresion
	vsInicoPag			VARCHAR2(10) := NULL;
	--Nmero de renglones por pgina
	vnRegsPag			PLS_INTEGER := 4000;

	--Filtro de fecha de inicio
	vdIni				DATE;
	--Filtro de fecha de fin
	vdFin				DATE;
	--Filtro Periodo
	vsPerio				VARCHAR2(6);
	--Filtro de Operador
	vsOper				VARCHAR2(30);

	--El reporte en si, es una "babosada" :P
	CURSOR cuReporte(
		pdIni			DATE
		,pdFin			DATE
		,psOper			VARCHAR2
		,psPerio		VARCHAR2
	) IS
		SELECT
			TO_CHAR(TWBRPRG_RPRG_DATE,'DD/MM/YYYY')					AS Fecha
			,TWBRPRG_RPRG_USER										AS Operador
			,TWBRPRG_NUM											AS NumRepro
			,CASE UPPER(TWBRPRG_TYPE_IND)
				WHEN 'N' THEN 'Normal'
				WHEN 'F' THEN 'Por beneficio'
				WHEN 'T' THEN 'Por tesoreria'
				WHEN 'R' THEN 'Por retracto'
				WHEN 'C' THEN 'Congelacin'
				ELSE 'Otros'
			END														AS TipoRepro
			,TWBRPRG_CNTR_NUM										AS NumCntr
			,NVL(TWBRPRG_INVOICE_NUM,'N/D')							AS Boleta
			,NVL(TWBRPRG_PROM_NOTE_NUM,'N/D')						AS Pagare
		FROM
			TWBRPRG
			,TWBCNTR
		WHERE
			TWBCNTR_NUM = TWBRPRG_CNTR_NUM
			AND (pdIni IS NULL OR TWBRPRG_RPRG_DATE >= pdIni)
			AND (pdFin IS NULL OR TWBRPRG_RPRG_DATE < (pdFin + 1))
			AND (psOper IS NULL OR UPPER(psOper) = UPPER(TWBRPRG_RPRG_USER))
			AND (psPerio IS NULL OR TWBCNTR_TERM_CODE = psPerio)
		ORDER BY
			TWBRPRG_NUM;
BEGIN

	--Seguridad de GWAMNUR
	IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

	--Obtengo los parametros de fechas
	vdIni := TO_DATE(pk_objHtml.getValueCookie('psIni'),'DD/MM/YYYY');
	vdFin := TO_DATE(pk_objHtml.getValueCookie('psFin'),'DD/MM/YYYY');

	--Obtengo el operador
	vsOper := pk_objHtml.getValueCookie('psOper');
	--Obtengo el periodo
	vsPerio := pk_objHtml.getValueCookie('psPerio');
	--Obtengo el tipo de

	-- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
	tabColumna.EXTEND(vnColumnas);

	--Guardamos los encabezados en el arreglo de columnas
	tabColumna( 1) := 'Fecha';
	tabColumna( 2) := 'Operador';
	tabColumna( 3) := 'Num. Repro';
	tabColumna( 4) := 'Tipo Repro';
	tabColumna( 5) := 'Num. Contrato';
	tabColumna( 6) := 'Num. Boleta';
	tabColumna( 7) := 'Num. Pagare';

	--Inicializamos contador de renglones
	vnRow := 0;

	FOR regReporte IN cuReporte(vdIni, vdFin, vsOper, vsPerio) LOOP

		--Incremento el contador de renglones
		vnRow := vnRow + 1;
		vnExists := 1; --Bandera para indicar que hubo resultados

		--Si es el primer renglon de cada pgina...
		IF MOD(vnRow, vnRegsPag) = 1  THEN
			--imprimo el encabezado de reporte
			Pk_Sisrepimp.P_EncabezadoDeReporte(
				psReclDesc ,vnColumnas ,tabColumna
				,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
			);
			vsInicoPag := 'SALTO';
		END IF;

		--Comienzo a desplegar el renglon
		HTP.P('<tr>');
		HTP.P('<td>'||regReporte.Fecha||'</td>');
		HTP.P('<td>'||regReporte.Operador||'</td>');
		HTP.P('<td>'||regReporte.NumRepro||'</td>');
		HTP.P('<td>'||regReporte.TipoRepro||'</td>');
		HTP.P('<td>'||regReporte.NumCntr||'</td>');
		HTP.P('<td>'||regReporte.Boleta||'</td>');
		HTP.P('<td>'||regReporte.Pagare||'</td>');
		--Fin del renglon
		HTP.P('</tr>');

	END LOOP;

	IF vnExists = 0 THEN
		--Ojo esta linea lo que hace es imprimir
		--NO SE ENCONTRARON DATOS o un mensaje similar
		htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
	ELSE

		-- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
		Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

		-- es omitido el encabezado del reporte pero se agrega el salto de pagina
		Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
	END IF;

	--Fin de la pagina
	htp.p('</table><br/></body></html>');
EXCEPTION
	WHEN OTHERS THEN
		--pantallazo de error.
		pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
			'PWRRCRB', NULL);
END PWRRCRB;
/


DROP PUBLIC SYNONYM PWRRCRB;

CREATE PUBLIC SYNONYM PWRRCRB FOR BANINST1.PWRRCRB;


GRANT EXECUTE ON BANINST1.PWRRCRB TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRRCRB TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRRCRB TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRRCRB TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRREGL;

CREATE OR REPLACE PROCEDURE BANINST1.PWRREGL(psTerm VARCHAR2,
 psLevl VARCHAR2,
 pnSeqc INTEGER,
 psExlS VARCHAR2 DEFAULT NULL,
 psLett VARCHAR2 DEFAULT NULL) IS

/*
 Tarea: REPORTE DE REGLAS DE REPETICI?N
 Fecha: 13/07/2011
 Autor: MAC
 Modulo: Historia academica

*/

 vnRegs INTEGER := 0;
 vsOpciones VARCHAR2(50) := '"imprimir","excel",';
 vsAcciones VARCHAR2(200) := 'javascript:f_Imprimir();,javascript:f_Excel(),';
 vgsUSR VARCHAR2(500);
 vsRptC SHRTCKN.SHRTCKN_REPEAT_COURSE_IND%TYPE := NULL;
 vdActv SHRTCKN.SHRTCKN_ACTIVITY_DATE%TYPE := NULL;
 vsRptS SHRTCKN.SHRTCKN_REPEAT_SYS_IND%TYPE := NULL;
 vsGrde SHRTCKG.SHRTCKG_GRDE_CODE_FINAL%TYPE := NULL;

 cursor cuReglas IS
 SELECT SPRIDEN_ID Expd,
 SWNTCKN_PIDM Pidm,
 SWNTCKN_TERM_CODE Term,
 SWNTCKN_SEQ_NO SeqN,
 SWNTCKN_CRN Crnn,
 SWNTCKN_SUBJ_CODE Subj,
 SWNTCKN_CRSE_NUMB Crse,
 SWNTCKN_REPEAT_COURSE_IND RepC,
 SWNTCKN_ACTIVITY Acty,
 SWNTCKN_REPEAT_SYS_IND RepS
 FROM SWNTCKN,
 SPRIDEN
 WHERE SWNTCKN_PIDM = SPRIDEN_PIDM
 AND SPRIDEN_CHANGE_IND IS NULL
 AND SWNTCKN_TERM = psTerm
 AND SWNTCKN_LEVL_CODE = psLevl
 AND SWNTCKN_SEQ = pnSeqc
 AND (SUBSTR(SWNTCKN_SUBJ_CODE,1,1) = psLett OR psLett IS NULL)
 ORDER BY SPRIDEN_ID,
 SWNTCKN_SUBJ_CODE,
 SWNTCKN_CRSE_NUMB,
 SWNTCKN_TERM_CODE DESC;

 procedure p_ValorOriginal(psTerm varchar2,
 psSubj varchar2,
 psCrse varchar2,
 pnPidm number,
 pnSeqN number,
 psCrn varchar2) is

 begin
 vsRptC := NULL;
 vdActv := NULL;
 vsRptS := NULL;
 vsGrde := NULL;

 select shrtckn_repeat_course_ind RptC,
 shrtckn_activity_date Actv,
 shrtckn_repeat_sys_ind RptS,
 b.shrtckg_grde_code_final Grde
 into vsRptC, vdActv, vsRptS, vsGrde
 from shrtckn a,
 SHRTCKG b
 where a.shrtckn_pidm = b.shrtckg_pidm
 and a.shrtckn_seq_no = b.shrtckg_tckn_seq_no
 and a.shrtckn_term_code = b.shrtckg_term_code
 and b.shrtckg_seq_no = (select max(c.shrtckg_seq_no)
 from shrtckg c
 where c.shrtckg_term_code = a.shrtckn_term_code
 and c.shrtckg_pidm = a.shrtckn_pidm
 and c.shrtckg_tckn_seq_no = a.shrtckn_seq_no
 )
 and shrtckn_pidm = pnPidm
 and shrtckn_subj_code = psSubj
 and shrtckn_crse_numb = psCrse
 and shrtckn_seq_no = pnSeqN
 and shrtckn_crn = psCrn
 and shrtckn_term_code = psTerm;

 end p_ValorOriginal;

 BEGIN
 -- valida que el usuario pertenezca a la base de datos.
 IF PK_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

 IF psExlS IS NOT NULL THEN
 owa_util.mime_header('application/ms-excel',true);
 END IF;

 htp.p('
 <html><head><title>&nbsp;</title>
 ');

 pK_ObjHTML.P_CssTabs;

 PK_ObjHTML.P_NoCache;

 htp.p('<script language=''JavaScript''><!--
 javascript:window.history.forward(1);
 ');
 ----
 htp.p('function f_Imprimir() {
 window.focus()
 print();
 } //f_Imprimir;
 ');

 ----
 htp.p('function f_Excel(){
 window.status = "Excel...";
 document.frmReporte.submit();
 } //f_Excel');

 ----
 htp.p('function f_Clock(){
 document.body.className = "bodyCeroR";
 parent.f_QuitarReloj();
 } //f_Clock');

 htp.p('
 //--></script>
 </head><body bgcolor="#ffffff" class="bodyCursorW" onLoad="f_Clock();">
 <table border="0" cellpadding="0" cellspacing="0" width="20%">
 <tr><td>');

 pk_MenuAplicacion.P_MenuDinamico(vsOpciones, vsAcciones, vsOpciones);

 htp.p('
 </td></tr></table>
 <br/>
 <table border="1" cellpadding="2" cellspacing="1" width="100%" bordercolor="#eeeeee">
 <tr><td colspan="7"></td>
 <th colspan="3" bgcolor="#eeeeee">Valor original</th>
 <th colspan="3" bgcolor="#dddddd">Valor actual </th>
 </tr>
 <tr><th width="5%"></th>
 <th width="9%" bgcolor="#efefef">Expediente </th>
 <th width="8%" bgcolor="#efefef">Periodo </th>
 <th width="8%" bgcolor="#efefef">CRN </th>
 <th width="8%" bgcolor="#efefef">SUBJ </th>
 <th width="8%" bgcolor="#efefef">CRSE </th>
 <th width="9%" bgcolor="#efefef">GRDE </th>
 <th width="9%" bgcolor="#eeeeee">RepeatCourseInd</th>
 <th width="9%" bgcolor="#eeeeee">Activity </th>
 <th width="9%" bgcolor="#eeeeee">RepeatSysInd </th>
 <th width="9%" bgcolor="#dddddd">RepeatCourseInd</th>
 <th width="9%" bgcolor="#dddddd">Activity </th>
 <th width="9%" bgcolor="#dddddd">RepeatSysInd </th>
 </tr>
 ');

 FOR regRgl IN cuReglas LOOP
 vnRegs := vnRegs + 1;

 p_ValorOriginal(regRgl.Term,regRgl.Subj,regRgl.Crse,regRgl.Pidm,regRgl.SeqN,regRgl.Crnn);

 htp.p('
 <tr>
 <td valign="top" align="right">' ||vnRegs ||'</td>
 <td valign="top" align="right">' ||regRgl.Expd||'</td>
 <td valign="top" align="center">'||regRgl.Term||'</td>
 <td valign="top" align="center">'||regRgl.Crnn||'</td>
 <td valign="top" align="center">'||regRgl.Subj||'</td>
 <td valign="top" align="center">'||regRgl.Crse||'</td>
 <td valign="top" align="center">'||vsGrde ||'</td>
 <td valign="top" align="center" bgcolor="#eeeeee">'||regRgl.RepC||'</td>
 <td valign="top" align="center" bgcolor="#eeeeee">'||regRgl.Acty||'</td>
 <td valign="top" align="center" bgcolor="#eeeeee">'||regRgl.RepS||'</td>
 <td valign="top" align="center" bgcolor="#dddddd">'||vsRptC ||'</td>
 <td valign="top" align="center" bgcolor="#dddddd">'||vdActv ||'</td>
 <td valign="top" align="center" bgcolor="#dddddd">'||vsRptS ||'</td>
 </tr>
 ');

 END LOOP;

 htp.p('
 </table>
 <br/>
 <br/>

 <form name="frmReporte" action="PWRREGL" method="get">
 <input type="hidden" name="psTerm" value="'||psTerm||'"/>
 <input type="hidden" name="psLevl" value="'||psLevl||'"/>
 <input type="hidden" name="pnSeqc" value="'||pnSeqc||'"/>
 <input type="hidden" name="psExlS" value="'||pnSeqc||'"/>
 <input type="hidden" name="psLett" value="'||psLett||'"/>
 </form>

 </body>
 </html>
 ');
 END PWRREGL;
/


DROP PUBLIC SYNONYM PWRREGL;

CREATE PUBLIC SYNONYM PWRREGL FOR BANINST1.PWRREGL;


GRANT EXECUTE ON BANINST1.PWRREGL TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRREGL TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRRESM;

CREATE OR REPLACE PROCEDURE BANINST1.PWRRESM(psReclDesc VARCHAR2,
                                             psSiu      VARCHAR2 DEFAULT NULL) IS

/**************************************************************
           tarea:  resumen de las evaluaciones por escuela del seprad
          mdulo:  resultados del sistema de evaluacin de la prctica docente (seprad)
           autor:  horacio martnez ramrez - hmr
           fecha:  05/nov/2010
**************************************************************/

  global_pidm SPRIDEN.SPRIDEN_PIDM%TYPE;

  TYPE reg_Resu IS RECORD (rTeqaCode     VARCHAR2(40),
                           rTeqaDesc     VARCHAR2(500),
                           rQcodCode     VARCHAR2(40),
                           rQcodDesc     VARCHAR2(500),
                           rNombre       VARCHAR2(300),
                           rExpediente   VARCHAR2(10),
                           rRut          VARCHAR2(30),
                           rEvaluaron    INTEGER,
                           rInscritos    INTEGER,
                           rGrupos       INTEGER,
                           rMedia        NUMBER,
                           rDesvi        NUMBER,
                           rMediaReaColl NUMBER,
                           rDesviReaColl NUMBER,
                           rMedCat       NUMBER,
                           rDesCat       NUMBER,
                           rMedCatProm   NUMBER,
                           rMedCatColl   NUMBER,
                           rDesCatColl   NUMBER,
                           rProfesores   INTEGER);

  TYPE tableResu IS TABLE OF reg_Resu INDEX BY BINARY_INTEGER;

  tabResumen    tableResu;
  vgnRow        INTEGER        := 0;
  vgnEvaluaron  INTEGER        := 0;
  vgnInscritos  INTEGER        := 0;
  vgnGrupos     INTEGER        := 0;
  vgnPromCollMe NUMBER         := 0;
  vgnPromCollDe NUMBER         := 0;
  vsTerm        VARCHAR2(6)    := NULL;
  vsEncu        VARCHAR2(30)   := NULL;
  vsColl        VARCHAR2(3)    := NULL;
  vsUniv        VARCHAR2(5)    := NULL;
  vsPtrm        VARCHAR2(1000) := NULL;

  cn0          CONSTANT NUMBER(1)    := 0;
  cn1          CONSTANT NUMBER(1)    := 1;
  cn19         CONSTANT NUMBER(2)    := 19;
  cn16         CONSTANT NUMBER(2)    := 16;
  csI          CONSTANT VARCHAR2(1)  := 'I';
  csL          CONSTANT VARCHAR2(1)  := 'L';
  csShl        CONSTANT VARCHAR2(1)  := '/';

  vgsLongCelda CONSTANT VARCHAR2(60) := ' style="width:90.0px" ';
  vgsLongCeld2 CONSTANT VARCHAR2(60) := ' style="width:60.0px" ';

  CURSOR cuResumen(psTerm VARCHAR2,
                   psColl VARCHAR2,
                   psCamp VARCHAR2,
                   psEncu VARCHAR2,
                   psPtrm VARCHAR2 DEFAULT NULL
                  ) IS
         SELECT SWRSEPR_TEQA_CODE                                               teqaCode,
                SWRSEPR_QCOD_CODE                                               qcodCode,
                pk_Seprad1.F_TeqaDesc(SWRSEPR_TEQA_CODE)                        teqaDesc,
                pk_Seprad1.F_QcodDesc(SWRSEPR_QCOD_CODE)                        qcodDesc,
                SWRSEPR_PIDM                                                    Pidm,
                pk_Seprad1.F_IdProfesor(SWRSEPR_PIDM)                           Id,
                f_get_rut(SWRSEPR_PIDM)                                         Rut,
                pk_Seprad1.F_NameProfesor(SWRSEPR_PIDM)                         Nombre,
                SWROENC_ORDEN                                                   OrdenEnc,
                COUNT(SWRSEPR_CRN)                                              Grupo,
                SUM(SWRSEPR_CONTESTARON)                                        Evaluaron,
                SUM(SWRSEPR_INSCRITOS)                                          Inscritos,
                DECODE(SUM(SWRSEPR_MEDIA*SWRSEPR_CONTESTARON),cn0,cn0,SUM(SWRSEPR_MEDIA*SWRSEPR_CONTESTARON)/SUM(SWRSEPR_CONTESTARON)) Media
           FROM SWRSEPR B,SWROENC C
          WHERE (INSTR(csShl||psPtrm,csShl||SWRSEPR_PTRM_CODE||csShl) > cn0 OR psPtrm = csShl OR psPtrm IS NULL)
            AND (SWRSEPR_PIDM, SWRSEPR_CRN) IN (SELECT CONDICION.PIDM, CONDICION.CRN
                                                  FROM (SELECT SWRSEPR_PIDM PIDM,
                                                               SWRSEPR_CRN  CRN,
                                                               SUM(A.SWRSEPR_MEDIA),
                                                               COUNT(cn1)
                                                          FROM SWRSEPR A
                                                         WHERE A.SWRSEPR_TERM_CODE = psTerm
                                                           AND A.SWRSEPR_COLL_CODE = psColl
                                                           AND A.SWRSEPR_CAMP_CODE = psCamp
                                                           AND A.SWRSEPR_TIPO_CRN  IN (csL,csI)
                                                        HAVING SUM(A.SWRSEPR_MEDIA) > cn0
                                                         GROUP BY SWRSEPR_CRN,SWRSEPR_PIDM
                                                       ) CONDICION
                                               )
            AND C.SWROENC_TSSC_CODE  = SWRSEPR_TSSC_CODE
            AND C.SWROENC_QCOD_CODE  = SWRSEPR_QCOD_CODE
            AND SWRSEPR_TIPO_CRN    IN (csI,csL)
            AND SWRSEPR_COLL_CODE    = psColl
            AND SWRSEPR_CAMP_CODE    = psCamp
            AND SWRSEPR_TERM_CODE    = psTerm
            AND SWRSEPR_TSSC_CODE    = psEncu
          GROUP BY SWRSEPR_TEQA_CODE,
                   SWRSEPR_QCOD_CODE,
                   SWRSEPR_PIDM,
                   SWROENC_ORDEN
          ORDER BY Nombre,Id,SWROENC_ORDEN;

  -- muestra el listado de profesores evaluados
  procedure P_Profesores(pnProfesores integer) is

  vnVuelta   integer := 0;
  vnPosicion integer := 0;

  cursor cuEncabezado is
         select 0 Code,'Nombre del docente' Dess from dual union all
         select 1 Code,'Expediente' Dess from dual union all
         select 2 Code,'RUT'        Dess from dual union all
         select 3 Code,'N&uacute;mero de evaluadores' Dess from dual union all
         select 4 Code,'N&uacute;mero de alumnos inscritos' Dess from dual union all
         select 5 Code,'N&uacute;mero de grupos' Dess from dual order by 1;

  begin
      for regEnc in cuEncabezado loop
          vnVuelta   := 0;
          vnPosicion := 0;

          htp.p('<tr class="trTabSepara">
                     <td colspan="2" align="right" valign="top" class="tdFont7" style="border-left:none;border-top:none;border-bottom:none;">'||regEnc.Dess||'</td>');

          for vnI in 1..pnProfesores loop
              vnPosicion := 1 + (cn19 * vnVuelta);

              htp.p('<td align="center" valign="top" ');

              if    regEnc.Code = 0 then
                    htp.prn('style="border-left:none;border-bottom:none;" class="tdFont7">');
                    htp.p(tabResumen(vnPosicion).rNombre);

              elsif regEnc.Code = 1 then
                    htp.prn('style="border-left:none;border-top:none;border-bottom:none;" class="tdFont8">');
                    htp.p(tabResumen(vnPosicion).rExpediente);

              elsif regEnc.Code = 2 then
                    htp.prn('style="border-left:none;border-top:none;border-bottom:none;" class="tdFont8">');
                    htp.p(tabResumen(vnPosicion).rRut);

              elsif regEnc.Code = 3 then
                    htp.prn('style="border-left:none;border-top:none;border-bottom:none;" class="tdFont8">');
                    vgnEvaluaron := vgnEvaluaron + tabResumen(vnPosicion).rEvaluaron;

                    htp.p(tabResumen(vnPosicion).rEvaluaron);

              elsif regEnc.Code = 4 then
                    htp.prn('style="border-left:none;border-top:none;border-bottom:none;" class="tdFont8">');
                    vgnInscritos := vgnInscritos + tabResumen(vnPosicion).rInscritos;

                    htp.p(tabResumen(vnPosicion).rInscritos);

              elsif regEnc.Code = 5 then
                    htp.prn('style="border-left:none;border-top:none;" class="tdFont8">');
                    vgnGrupos := vgnGrupos + tabResumen(vnPosicion).rGrupos;

                    htp.p(tabResumen(vnPosicion).rGrupos);
              end if;

              htp.p('</td>');

              vnVuelta := vnVuelta + 1;
          end loop;

          if    regEnc.Code = 0 then
                htp.p('<td class="tdFont8" align="center" colspan="2" rowspan="3" valign="bottom">'||'Escuela o Facultad'||'</td>');
          elsif regEnc.Code = 3 then
                htp.p('<th class="tdFont8" colspan="2" valign="top" style="border-bottom:none;">'||vgnEvaluaron||'</th>');
          elsif regEnc.Code = 4 then
                htp.p('<th class="tdFont8" colspan="2" valign="top" style="border-bottom:none;border-top:none;">'||vgnInscritos||'</th>');
          elsif regEnc.Code = 5 then
                htp.p('<th class="tdFont8" colspan="2" valign="top" style="border-top:none;">'||vgnGrupos||'</th>');
          end if;

          htp.p('</tr>');
      end loop;

      htp.p('<tr><td colspan="2" style="border-top:none;border-left:none;"></td>');

      for vnI in 1..pnProfesores loop
          htp.p('<td align="center" class="tdFont7">'||f_Label(25)||'</td>');
      end loop;

      htp.p('<td align="center" class="tdFont7">'||'Promedio'||'</td>
             <td align="center" class="tdFont7">'||'Desviaci&oacute;n'||'</td></tr>');

  end P_Profesores;

  -- media y desviacin por reactivo de la evaluacin
  procedure P_MediaReactivo(pnRectivo    integer,
                            pnProfesores integer) is

  vnVuelta   integer       := 0;
  vnPosicion integer       := 0;
  vnMedCero  integer       := 0;    --es un contador cuando una media es cero, en el caso de posgrado cuando todos los alumnos evaluaron un reactivo con no aplica
  vsFormatM  varchar2(100) := null;
  vsFormatD  Varchar2(100) := null;

  begin
      if pnRectivo = cn19 then
         vsFormatM := 'border-top:none;';
      else
         vsFormatM := 'border-top:none;border-bottom:none;';
      end if;

      for vnI in 1..pnProfesores loop
          vnPosicion := pnRectivo + (cn19 * vnVuelta);

          htp.p('<td class="tdFont8" align="center" valign="top" style="'||vsFormatM||'" '||vgsLongCelda||'>'||TO_CHAR(ROUND(tabResumen(vnPosicion).rMedia,2),'90.99')||'</td>');

          if tabResumen(vnPosicion).rMedia = 0 then
             vnMedCero := vnMedCero + 1;
             tabResumen(vnI).rProfesores := tabResumen(vnI).rProfesores + 1;
          end if;

          tabResumen(vnI).rMedCatProm := tabResumen(vnI).rMedCatProm + tabResumen(vnPosicion).rMedia;

          vnVuelta := vnVuelta + 1;
      end loop;

      if pnRectivo = cn19 then
         vsFormatM := 'border-right:none;border-top:none;';
         vsFormatD := 'border-left:none; border-top:none;';
      else
         vsFormatM := 'border-right:none;border-bottom:none;border-top:none;';
         vsFormatD := 'border-left:none; border-bottom:none;border-top:none;';
      end if;

      if pnRectivo <= cn16 then
         vgnPromCollMe := vgnPromCollMe + tabResumen(pnRectivo).rMediaReaColl;
         vgnPromCollDe := vgnPromCollDe + tabResumen(pnRectivo).rDesviReaColl;
      end if;

      htp.p('<td class="tdFont8" align="center" valign="top" bgcolor="#efefef" style="'||vsFormatM||'" '||vgsLongCeld2||'>'||TO_CHAR(ROUND(tabResumen(pnRectivo).rMediaReaColl,2),'90.99')||'</td>');
      htp.p('<td class="tdFont8" align="center" valign="top" style="'||vsFormatD||'" '||vgsLongCeld2||'>'||TO_CHAR(ROUND(tabResumen(pnRectivo).rDesviReaColl,2),'90.99')||'</td>');

  end P_MediaReactivo;

  -- media y desviacin por reactivo de la evaluacin
  procedure P_CalculoMediaReactivoColl(pnRectivo    integer,
                                       pnProfesores integer) is

  vnVuelta     integer := 0;
  vnPosicion   integer := 0;
  vnMedCero    integer := 0;  -- es un contador cuando una media es cero, en el caso de posgrado cuando todos los alumnos evaluaron un reactivo con no aplica
  vnMedReaColl number  := 0;
  vnDesReaColl number  := 0;

  begin
      for vnI in 1..pnProfesores loop
          vnPosicion := pnRectivo + (cn19 * vnVuelta);

          vnVuelta := vnVuelta + 1;

          if tabResumen(vnPosicion).rMedia  = 0 then
             vnMedCero := vnMedCero + tabResumen(vnPosicion).rEvaluaron;
          end if;

          vnMedReaColl := vnMedReaColl + (tabResumen(vnPosicion).rMedia * tabResumen(vnPosicion).rEvaluaron);
      end loop;

      if vnMedReaColl > 0 and vgnEvaluaron > 0 then
         vnMedReaColl := vnMedReaColl/(vgnEvaluaron-vnMedCero);
      end if;

      vnVuelta   := 0;
      vnPosicion := 0;

      for vnI in 1..pnProfesores loop
          vnPosicion := pnRectivo + (cn19 * vnVuelta);

          vnVuelta := vnVuelta + 1;

          if tabResumen(vnPosicion).rMedia > 0 then
             vnDesReaColl := vnDesReaColl + POWER((tabResumen(vnPosicion).rMedia-vnMedReaColl),2) * tabResumen(vnPosicion).rEvaluaron;
          end if;
      end loop;

      if vnDesReaColl > 0 and vgnEvaluaron > 0 then
         vnDesReaColl := SQRT(vnDesReaColl/(vgnEvaluaron-vnMedCero));
      end if;

      tabResumen(pnRectivo).rMediaReaColl := vnMedReaColl;
      tabResumen(pnRectivo).rDesviReaColl := vnDesReaColl;

  end P_CalculoMediaReactivoColl;

  -- muestra la media y la desviacin por categora
  procedure P_MediaPorCategoria(psCategoria varchar2,
                                pnRegistros integer) is

  vnPreguntas number  := 0;
  vnMedia     number  := 0;
  vnDesvi     number  := 0;
  vnRenglon   integer := 0;
  vnReactivo  integer := 0;
  vnMedCero   integer := 0; -- es un contador cuando una media es cero, en el caso de posgrado cuando todos los alumnos evaluaron un reactivo con no aplica

  begin
      for vnI in 1..pnRegistros loop
          vnReactivo := vnReactivo + 1;

          if tabResumen(vnI).rTeqaCode = psCategoria then
             vnPreguntas := vnPreguntas + 1;

             if vnPreguntas = 1 then
                vnRenglon := vnI;
             end if;

             if tabResumen(vnI).rMedia = 0 then
                vnMedCero := vnMedCero + 1;
             end if;

             vnMedia := vnMedia + tabResumen(vnI).rMedia;
             vnDesvi := vnDesvi + tabResumen(vnI).rDesvi;
          end if;

          if vnReactivo = cn19 then
             if vnPreguntas > 0 and vnMedia > 0 then
                vnMedia := vnMedia/(vnPreguntas-vnMedCero);
             end if;

             if vnPreguntas > 0 and vnDesvi > 0 then
                vnDesvi := vnDesvi/(vnPreguntas-vnMedCero);
             end if;

             tabResumen(vnRenglon).rMedCat := vnMedia;
             tabResumen(vnRenglon).rDesCat := vnDesvi;

             vnReactivo  := 0;
             vnPreguntas := 0;
             vnMedia     := 0;
             vnDesvi     := 0;
             vnRenglon   := 0;
             vnMedCero   := 0;
          end if;
      end loop;

  exception
      when others then
           htp.p('BKP 001: '||sqlerrm);
  end P_MediaPorCategoria;

  -- media y desviacin por categora de evaluacin
  procedure P_MediaCategoria(pnCategoria  integer,
                             pnProfesores integer) is

  vnVuelta   integer := 0;
  vnPosicion integer := 0;

  begin
      for vnI in 1..pnProfesores loop
          vnPosicion := pnCategoria + (cn19 * vnVuelta);

          htp.p('<th valign="top" class="thFont8">'||TO_CHAR(ROUND(tabResumen(vnPosicion).rMedCat,2),'90.99')||'</th>');

          vnVuelta := vnVuelta + 1;
      end loop;

  end P_MediaCategoria;

  -- media y desviacin por categora de evaluacin
  procedure P_PromedioMedia(pnProfesores integer) is

  begin
      for vnI in 1..pnProfesores loop

          if tabResumen(vnI).rMedCatProm > 0 then
             tabResumen(vnI).rMedCatProm := tabResumen(vnI).rMedCatProm/(cn16-tabResumen(vnI).rProfesores);
          end if;

          htp.p('<th valign="top" class="thFont8" style="border-left:none;border-right:none;">'||TO_CHAR(ROUND(tabResumen(vnI).rMedCatProm,2),'90.99')||'</th>');

      end loop;

  end P_PromedioMedia;

  -- muestra la media y la desviacin por categora de la escuela
  procedure P_CalculoMedCatColl(psCategoria varchar2) is

  vnPreguntas number  := 0;
  vnMedia     number  := 0;
  vnDesvi     number  := 0;
  vnRenglon   integer := 0;
  vnMedCero   integer := 0; -- es un contador cuando una media es cero, en el caso de posgrado cuando todos los alumnos evaluaron un reactivo con no aplica

  begin
      for vnI in 1..cn19 loop
          if tabResumen(vnI).rTeqaCode = psCategoria then
             vnPreguntas := vnPreguntas + 1;

             if vnPreguntas = 1 then
                vnRenglon := vnI;
             end if;

             if tabResumen(vnI).rMedia  = 0 then
                vnMedCero := vnMedCero + 1;
             end if;

             vnMedia := vnMedia + tabResumen(vnI).rMediaReaColl;
             vnDesvi := vnDesvi + tabResumen(vnI).rDesviReaColl;
          end if;
      end loop;

      if vnPreguntas > 0 and vnMedia > 0 then
         vnMedia := vnMedia/(vnPreguntas-vnMedCero);
      end if;

      if vnPreguntas > 0 and vnDesvi > 0 then
         vnDesvi := vnDesvi/(vnPreguntas-vnMedCero);
      end if;

      tabResumen(vnRenglon).rMedCatColl := vnMedia;
      tabResumen(vnRenglon).rDesCatColl := vnDesvi;

  end P_CalculoMedCatColl;

  -- presenta los reactivos de la encuesta
  procedure P_ReactivosEncuesta is

  vsTeqaCode   svrsdef.svrsdef_teqa_code%type := null;
  vnProfesores integer := vgnRow/cn19;
  vnWidthTable integer := 0;

  begin
      vnWidthTable := 490 + (vnProfesores * 90);

      htp.p('<table border="1" cellpadding="2" cellspacing="0" bordercolor="#cccccc" bgcolor="#ffffff" style="width:'||vnWidthTable||'.0px">');

      -- en cabezado del reporte
      P_Profesores(vnProfesores);

      -- clculo de la media por reactivo de la escuela
      for vnI in 1..cn19 loop
          P_CalculoMediaReactivoColl(vnI, vgnRow/cn19);
      end loop;

      for regPreg in pk_Seprad1.cuPreguntas loop
          P_CalculoMedCatColl(regPreg.Categ);
      end loop;

      for vnI in 1..vgnRow loop
          if vsTeqaCode <> tabResumen(vnI).rTeqaCode or vsTeqaCode is null then
             htp.p('<tr bgcolor="#efefef" class="trTabSepara"><th colspan="2" align="left" class="thFont7">'||tabResumen(vnI).rTeqaDesc||'</th>');

             P_MediaCategoria(vnI, vnProfesores);

             htp.p('<th class="thFont8" style="border-right:none;">'||TO_CHAR(ROUND(tabResumen(vnI).rMedCatColl,2),'90.99')||'</th>
                    <th class="thFont8" style="border-left:none;">' ||TO_CHAR(ROUND(tabResumen(vnI).rDesCatColl,2),'90.99')||'</th></tr>');

          end if;

          htp.p('
          <tr class="trTabSepara">
              <td style="width:20.0px;" valign="top" align="right" style="border-right:none;" class="tdFont7">'||vnI||')</td>
              <td style="width:350.0px;" valign="top" align="left"  style="border-left:none;" class="tdFont7">'||tabResumen(vnI).rQcodDesc||'</td>');

          -- promedio de los reactivos
          P_MediaReactivo(vnI,vnProfesores);

          htp.p('</tr>');

          if vnI = cn16 then
             htp.p('<tr bgcolor="#efefef" class="trTabSepara"><th colspan="2" class="thFont7" style="border-right:none;">'||'Valoraci&oacute;n Promedio del Profesor (VPP)'||'</th>');

             P_PromedioMedia(vnProfesores);

             if vgnPromCollMe > 0 then
                vgnPromCollMe := vgnPromCollMe/cn16;
             end if;

             if vgnPromCollDe > 0 then
                vgnPromCollDe := vgnPromCollDe/cn16;
             end if;

             htp.p('<th class="thFont8" style="border-right:none;">'||TO_CHAR(ROUND(vgnPromCollMe,2),'90.99')||'</th>
                    <th class="thFont8" style="border-left:none;">' ||TO_CHAR(ROUND(vgnPromCollDe,2),'90.99')||'</th></tr>
             <tr><td colspan="'||TO_CHAR(vnProfesores + 4)||'" bgcolor="#ffffff" style="border-left:none;border-right:none;"></td></tr>');
          end if;

          vsTeqaCode := tabResumen(vnI).rTeqaCode;

          if vnI = cn19 then
             exit;
          end if;
      end loop;

      htp.p('</table>');
  end P_ReactivosEncuesta;

  BEGIN
      -- valida que el usuario pertenezca a la base de datos
      IF psSiu IS NULL THEN
         IF pk_login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;
      ELSE
         IF NOT twbkwbis.F_ValidUser(global_pidm) THEN
            RETURN;
         END IF;
      END IF;

      vsUniv := pk_objHtml.getValueCookie('psSprUn');
      vsEncu := pk_objHtml.getValueCookie('psSeprd');
      vsTerm := pk_objHtml.getValueCookie('psSprTD');
      vsColl := pk_objHtml.getValueCookie('psSprCo');
      vsPtrm := NVL(pk_objHtml.getValueCookie('psPtrmP'),'/');

      -- extrae los promedios
      FOR regRes IN cuResumen(vsTerm, vsColl, vsUniv, vsEncu, vsPtrm) LOOP
          vgnRow := vgnRow + 1;

          tabResumen(vgnRow).rTeqaCode     := regRes.teqaCode;
          tabResumen(vgnRow).rTeqaDesc     := regRes.teqaDesc;
          tabResumen(vgnRow).rQcodCode     := regRes.qcodCode;
          tabResumen(vgnRow).rQcodDesc     := regRes.qcodDesc;
          tabResumen(vgnRow).rNombre       := regRes.Nombre;
          tabResumen(vgnRow).rExpediente   := regRes.Id;
          tabResumen(vgnRow).rRut          := regRes.Rut;
          tabResumen(vgnRow).rEvaluaron    := regRes.Evaluaron;
          tabResumen(vgnRow).rInscritos    := regRes.Inscritos;
          tabResumen(vgnRow).rGrupos       := regRes.Grupo;
          tabResumen(vgnRow).rMedia        := regRes.Media;
          tabResumen(vgnRow).rDesvi        := 0;
          tabResumen(vgnRow).rMediaReaColl := NULL;
          tabResumen(vgnRow).rDesviReaColl := NULL;
          tabResumen(vgnRow).rMedCatProm   := 0;
          tabResumen(vgnRow).rProfesores   := 0;
      END LOOP;

      FOR regPreg IN pk_Seprad1.cuPreguntas LOOP
          P_MediaPorCategoria(regPreg.Categ, vgnRow);
      END LOOP;

      htp.p('<html><head><title>'||psReclDesc||'</title>');

      -- la aplicacin no se guarda en el cache de la mquina
      PK_ObjHTML.P_NoCache;

      -- cdigo css
      PK_ObjHTML.P_CssTabs;

      htp.p('<script language="JavaScript"><!--');
      htp.p('function fImprimeReporte() {
      window.focus()
      print();
      }');
      htp.p('//--></script>');

      htp.p('</head><body bgcolor="#ffffff" class="bodyCeroR"><br/>');
      htp.p('<script language="javascript" src="kwacnls.js"></script>');
      htp.p('<table border="0" cellpadding="2" cellspacing="1" bordercolor="#ffffff" bgcolor="#ffffff" width="100%">
      <tr class="trTabSepara">
          <td rowspan="4" width="10%" valign="top"><img src="/imagenes/logo_uft.jpg'||'" width="80" border="0"></td>
          <td colspan="2" align="left" valign="top" class="tdTitulo"><b>'||REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(psReclDesc,'~aacute','&aacute'),'~eacute','&eacute'),'~iacute','&iacute'),'~oacute','&oacute'),'~uacute','&uacute')||':</b>&nbsp;'||pk_Seprad1.F_CollDesc(vsColl)||'</td>
          </tr>
      <tr class="trTabSepara"><td valign="top" width="70%">'||vsTerm||' '||pk_Seprad1.F_TermDesc(vsTerm)||'</td>
                              <td valign="top" width="30%" align="right">'||pK_Seprad1.F_Fecha||'</td></tr>
      <tr class="trTabSepara"><td colspan="2">'||
      pK_Seprad1.F_PtrmCodeDesc(vsTerm,
                                psColl=>vsColl,
                                psCamp=>vsUniv,
                                psPtrm=>vsPtrm,
                                psEncs=>vsEncu
                               )||'</td></tr>
      <tr class="trTabSepara"><td colspan="2"></td></tr>
      </table><br/>');

      P_ReactivosEncuesta;

      htp.p('<br/></body></html>');
  EXCEPTION
      WHEN OTHERS THEN
           HTP.P(SQLERRM);
  END PWRRESM;
/


DROP PUBLIC SYNONYM PWRRESM;

CREATE PUBLIC SYNONYM PWRRESM FOR BANINST1.PWRRESM;


GRANT EXECUTE ON BANINST1.PWRRESM TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRRESM TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRRETN;

CREATE OR REPLACE PROCEDURE BANINST1.PWRRETN(psReclDesc VARCHAR2) IS

/*
        Nombre: REPORTE DE RETENCIONES
                (anterior P_INSCR03 copiado de Pk_Reporteinscripciones.P_INSCR03))
         Fecha: 14/07/2006
         Autor: VBZ

  MODIFICACIN: 25/08/2008
                GEPC
                * Se agrego el parametro "psHold" (Para filtar por tipo de retencin)

  MODIFICACIN: 15/04/2010
                GEPC
                * Se agrego el parametro "Sede" para filtrar el campo "SGBSTDN_RATE_CODE"

*/

  vnRow      INTEGER                := 0;
  vnExists   INTEGER                := 0;
  vnColumnas INTEGER                := 8;
  tabColumna Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vsPerio    VARCHAR2(10)           := NULL;
  vsUniv     VARCHAR2(20)           := NULL;
  vsProgr    VARCHAR2(20)           := NULL;
  vsSeccion  VARCHAR2(3)            := NULL;
  vsTermCode VARCHAR2(10)           := NULL;
  vsCampCode VARCHAR2(10)           := NULL;
  vsRateCode VARCHAR2(10)           := NULL;
  vsid       VARCHAR2(10)           := NULL;
  vsSede     VARCHAR2(10)           := NULL;
  vsHold     VARCHAR2(5)            := NULL;
  vsEnca     VARCHAR2(1)            := NULL;
  vsInicoPag VARCHAR2(10)           := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
  vbEnca     BOOLEAN                := TRUE;

  CURSOR cuReporte(--psTermCode VARCHAR2 DEFAULT NULL,
                   psCampCode VARCHAR2 DEFAULT NULL,
                   psProgCode VARCHAR2 DEFAULT NULL,
                   psHoldCode VARCHAR2 DEFAULT NULL
                  ) IS
         SELECT --SFBETRM_TERM_CODE                                           termCode,
                SGBSTDN_CAMP_CODE                                           campCode,
                SGBSTDN_PROGRAM_1                                           progCode,
                Pk_Catalogo.PROGRAMA(SGBSTDN_PROGRAM_1)                     progDesc,
                SPRIDEN_ID                                                  Id,
                REPLACE(SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME,'*',' ') Nombre,
                SPRHOLD_HLDD_CODE                                           hlddCode,
                Pk_Catalogo.RETENCION(SPRHOLD_HLDD_CODE)                    hlddDesc,
                SPRHOLD_REASON                                              reasDesc,
                SPRHOLD_TO_DATE                                             dateVenc
              --  NVL(A.SGBSTDN_RATE_CODE,'sin Sede')                         rateCode
           FROM SGBSTDN A,
                SPRIDEN,
                SPRHOLD
              --  SFBETRM,
                --STVTERM
          WHERE A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                             FROM SGBSTDN B
                                            WHERE B.SGBSTDN_PIDM           = A.SGBSTDN_PIDM
                                           )
            AND A.SGBSTDN_PIDM          = SPRHOLD_PIDM
            AND A.SGBSTDN_PIDM          = SPRIDEN_PIDM
            AND SPRIDEN_CHANGE_IND     IS NULL
            --AND SFBETRM_PIDM            = A.SGBSTDN_PIDM
            --AND SFBETRM_ESTS_CODE       = 'EL'
      --      AND A.SGBSTDN_STST_CODE     = 'AS'
            --AND STVTERM_CODE            = SFBETRM_TERM_CODE
--            AND EXISTS (SELECT NULL
--                          FROM SFRSTCR
--                         WHERE SFRSTCR_TERM_CODE = SFBETRM_TERM_CODE
--                           AND SFRSTCR_PIDM      = SFBETRM_PIDM
--                           AND SFRSTCR_RSTS_CODE IN ('RE','RW')
--                       )
            --AND (
              --   (TRUNC(SPRHOLD_FROM_DATE) BETWEEN TRUNC(STVTERM_START_DATE) AND TRUNC(STVTERM_END_DATE)) OR
                -- (TRUNC(SPRHOLD_TO_DATE)   BETWEEN TRUNC(STVTERM_START_DATE) AND TRUNC(STVTERM_END_DATE))
--                )
            AND (A.SGBSTDN_CAMP_CODE = psCampCode OR psCampCode IS NULL)
            AND (A.SGBSTDN_PROGRAM_1 = psProgCode OR psProgCode IS NULL)
            --AND (A.SGBSTDN_RATE_CODE = psRateCode OR psRateCode IS NULL)
  --          AND (STVTERM_TERM_CODE   = psTermCode OR psTermCode IS NULL)
            AND (SPRHOLD_HLDD_CODE   = psHoldCode OR psHoldCode IS NULL)
          ORDER BY campCode, SGBSTDN_PROGRAM_1, Nombre;

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      --vsPerio   := pk_ObjHtml.getValueCookie('psPerio');
      vsUniv    := pk_ObjHtml.getValueCookie('psUnive');
      vsProgr   := pk_ObjHtml.getValueCookie('psProgr');
      vsSeccion := pk_ObjHtml.getValueCookie('cookSeccion');
      vsEnca    := pk_ObjHtml.getValueCookie('psEnca');
      vsHold    := pk_ObjHtml.getValueCookie('psHold');
      --vsSede    := pk_ObjHtml.getValueCookie('psRate');

      -- las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1) := 'Programa';
      tabColumna(2) := 'Descripci&oacute;n';
      tabColumna(3) := 'ID';
      tabColumna(4) := 'Nombre';
      tabColumna(5) := 'Retenci&oacute;n';
      tabColumna(6) := 'Descripci&oacute;n';
      tabColumna(7) := 'Raz&oacute;n';
      tabColumna(8) := 'Fecha de vencimiento';

      FOR regRep IN cuReporte(vsUniv, vsProgr, vsHold) LOOP
          IF (
          --vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
             -- vsRateCode IS NULL OR vsRateCode <> regRep.rateCode OR
              vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR vnRow = 30) AND vbEnca THEN

             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicoPag,'1',psUsuario=>pk_login.vgsUSR,psSeccion=>vsSeccion,psUniversidad=>regRep.campCode);
             vsInicoPag := 'SALTO';

             vnRow  := 0;
          END IF;

          IF vsEnca = 'N' THEN
             vbEnca := FALSE;
          END IF;

          IF vsid = regRep.Id THEN
             regRep.progCode := NULL;
             regRep.progDesc := NULL;
             regRep.Id       := NULL;
             regRep.Nombre   := NULL;
          END IF;

          htp.p('<tr>
          <td valign="top">'||regRep.progCode||'</td>
          <td valign="top">'||regRep.progDesc||'</td>
          <td valign="top">'||regRep.Id      ||'</td>
          <td valign="top">'||regRep.Nombre  ||'</td>
          <td valign="top">'||regRep.hlddCode||'</td>
          <td valign="top">'||regRep.hlddDesc||'</td>
          <td valign="top">'||regRep.reasDesc||'</td>
          <td valign="top">'||regRep.dateVenc||'</td>
          </tr>');

          IF regRep.Id IS NOT NULL THEN
             vsid := regRep.Id;
          END IF;

          --vsTermCode := regRep.termCode;
          vsCampCode := regRep.campCode;
          --vsRateCode := regRep.rateCode;
          vnRow      := vnRow + 1;
          vnExists   := 1;
      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR, psSeccion=>vsSeccion);
      END IF;

      htp.p('</table><br/><br/></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           HTP.P(SQLERRM);

  END PWRRETN;
/


DROP PUBLIC SYNONYM PWRRETN;

CREATE PUBLIC SYNONYM PWRRETN FOR BANINST1.PWRRETN;


GRANT EXECUTE ON BANINST1.PWRRETN TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRRETN TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRRGCN;

CREATE OR REPLACE PROCEDURE BANINST1.PWRRGCN (
	psReclDesc			VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:		PWRRGCN
OBJETIVO:			Reporte Global de Contabilidad
PARAMETROS:
psReclDesc			Variable estandar para la maquina de reportes custom
AUTOR:				Gilberto Velazquez Hernandez
FECHA:				20121101
******************************************************************************/

	--La consulta que devuelve los datos del reporte...
	--Creo que esta vez si es importante explicar como rayos funciona el
	--query
	--El subquery Q1, es un query que su funcion es hacer que los movimientos
	--contables se muestren en dos renglones en lugar de uno, en uno se muestra
	--el monto al debe, y en el otro al haber por cuenta contable: Ejemplo
	--	CtaA	CtaB	Monto
	--	A		B		100
	--El query presenta el renglon asi
	--	Cta		Debe	Haber
	--	A		100
	--	B				100
	--Esto se logra duplicando los renglones de la tabla de contabilidad
	--mediante un producto cartesiano, con una tabla que solo tiene dos
	--renglones y una columna, Un renglon con el valor 'A', y el otro con 'B'
	--Despues las tres columnas se generan mediante Case, si el renglon es 'A'
	--se muestra la cuenta A, y se reporta el monto en el debe y un cero en el
	--haber, para el renglon B, se hace lo correspondiente
	--finalmente el query hace las sumas y el ordenamiento
	CURSOR cuDatos(
		pdFecha 		DATE
		,psPerio		VARCHAR2
		,psCntr			VARCHAR2
		,psCcts			VARCHAR2
	) IS
		SELECT
			Cntr
			,Cuenta
			,Centro
			,SUM(MontoDebe)								AS Debe
			,SUM(MontoHaber)							AS Haber
		FROM
			(SELECT
				TWBDOCU_CNTR_NUM						AS Cntr
				,(CASE Flag
					WHEN 'A' THEN TWRADMD_ACCOUNT_A
					WHEN 'B' THEN TWRADMD_ACCOUNT_B
				END)									AS Cuenta
				,(CASE Flag
					WHEN 'A' THEN TWRADMD_CCTS_CODE_A
					WHEN 'B' THEN TWRADMD_CCTS_CODE_B
				END)									AS Centro
				,(CASE Flag
					WHEN 'A' THEN TWRADMD_AMOUNT
					WHEN 'B' THEN 0
				END)									AS MontoDebe
				,(CASE Flag
					WHEN 'A' THEN 0
					WHEN 'B' THEN TWRADMD_AMOUNT
				END)									AS MontoHaber
			FROM
				TWRADMD
				,TWRDOMV
				,TWBDOCU
				,(SELECT 'A' AS Flag FROM DUAL
					UNION ALL SELECT 'B' AS Flag FROM DUAL
				) Cta
			WHERE
				TWBDOCU_SEQ_NUM = TWRDOMV_DOCU_SEQ_NUM
				AND TWRDOMV_DOCU_SEQ_NUM = TWRADMD_DOCU_SEQ_NUM
				AND TWRDOMV_MOVE_NUM = TWRADMD_MOVE_NUM
				AND TWRDOMV_MOVE_DATE < (pdFecha+1)
				AND (psCntr IS NULL OR TWBDOCU_CNTR_NUM = psCntr)
				AND (psPerio IS NULL OR TWBDOCU_TERM_CODE = psPerio)
			UNION SELECT --Esta es la contabilidad de las minutas de devolucion
				TWBCNTR_NUM								AS Cntr
				,(CASE Flag
					WHEN 'A' THEN TWRACRM_ACCOUNT_A
					WHEN 'B' THEN TWRACRM_ACCOUNT_B
				END)									AS Cuenta
				,(CASE Flag
					WHEN 'A' THEN TWRACRM_CCTS_CODE_A
					WHEN 'B' THEN TWRACRM_CCTS_CODE_B
				END)									AS Centro
				,(CASE Flag
					WHEN 'A' THEN TWRACRM_ACNT_AMOUNT
					WHEN 'B' THEN 0
				END)									AS MontoDebe
				,(CASE Flag
					WHEN 'A' THEN 0
					WHEN 'B' THEN TWRACRM_ACNT_AMOUNT
				END)									AS MontoHaber
			FROM
				TWRACRM
				,TWBMIDE
				,TWBCNTR
				,(SELECT 'A' AS Flag FROM DUAL
					UNION ALL SELECT 'B' AS Flag FROM DUAL
				) Cta
			WHERE
				TWRACRM_MIDE_NUM = TWBMIDE_NUM
				AND TWBMIDE_CNTR_NUM = TWBCNTR_NUM
				AND TWBMIDE_ISSUE_DATE < (pdFecha+1)
				AND (psCntr IS NULL OR TWBCNTR_NUM = psCntr)
				AND (psPerio IS NULL OR TWBCNTR_TERM_CODE = psPerio)
			) Q1
		WHERE
			(psCcts IS NULL or psCcts = Centro)
		GROUP BY
			Centro
			,Cntr
			,Cuenta
		ORDER BY
			Centro
			,Cntr
			,Cuenta;


	--Variables del reporte
	--Fecha de corte
	vdFecha				DATE;
	--Numero de contrato
	vsCntr				VARCHAR2(10);
	--Periodo
	vsPerio				VARCHAR2(6);
	--Centro de costos
	vsCcts				VARCHAR2(20);
	--Formato de numeros
	csFmt				VARCHAR2(20) := 'FM999999999999';


	--Variables para la presetacion
	--Numero de renglones
	vnRow				PLS_INTEGER := 0;
	--Bandera para mostrar si hubo datos
	vnExists			PLS_INTEGER := 0;
	--Numero de columnas
	vnColumnas			PLS_INTEGER := 6;
	--Numero de registros
	vnRegs				PLS_INTEGER := 0;
	--Arreglo (nested table) donde se guardan los encabezados de las columnas
	tabColumna			Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
	-- la variable es una bandera que al tener el valor "imprime" no colocara
	--el salto de pgina para impresion
	vsInicoPag			VARCHAR2(10) := NULL;
	--Nmero de renglones por pgina
	vnRegsPag			PLS_INTEGER := 1000; --Ver que valor se ajusta!?

	--No se que tan limpio sea una funcion "inline" dentro de un procedimiento
	--no me siento muy comodo usandola, pero tambien de aqui a que levanto una
	--funcin ...
	--Ah por cierto, la funcion me devuelve la descripcion de un centro
	--de costo :P
	FUNCTION f_ObtDescCcts(psCcts VARCHAR2) RETURN VARCHAR2 IS
		CURSOR cuCcts(psCcts VARCHAR2) IS
			SELECT
				TWVCCTS_DESC
			FROM
				TWVCCTS
			WHERE
				TWVCCTS_CODE = psCcts;

		vsDesc			TWVCCTS.TWVCCTS_DESC%TYPE;
	BEGIN
		OPEN cuCcts(psCcts);
		FETCH cuCcts INTO vsDesc;
		CLOSE cuCcts;
		RETURN vsDesc;
	END f_ObtDescCcts;

	FUNCTION f_ObtDescCta(psCta VARCHAR2) RETURN VARCHAR2 IS
		CURSOR cuCta(psCta VARCHAR2) IS
			SELECT
				TWVACNT_DESC
			FROM
				TWVACNT
			WHERE
				TWVACNT_ACCOUNT = psCta;

		vsDesc			TWVACNT.TWVACNT_DESC%TYPE;
	BEGIN
		OPEN cuCta(psCta);
		FETCH cuCta INTO vsDesc;
		CLOSE cuCta;
		RETURN vsDesc;
	END f_ObtDescCta;

BEGIN
	--Seguridad de GWAMNUR
	IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

	--Fecha, este es OBLIGATORIO!!!
	vdFecha := TO_DATE(pk_objHtml.getValueCookie('psFecha'),'DD/MM/YYYY');
	--Periodo:
	vsPerio := pk_objHtml.getValueCookie('psPerio');
	--Contrato
	vsCntr := pk_objHtml.getValueCookie('psCntr');
	--Centro de Costos
	vsCcts := pk_objHtml.getValueCookie('psCcts');

	-- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
	tabColumna.EXTEND(vnColumnas);

	--Guardamos los encabezados en el arreglo de columnas
	tabColumna( 1) := 'Centro Costo';
	tabColumna( 2) := 'Contrato';
	tabColumna( 3) := 'Cuenta';
	tabColumna( 4) := 'Desc. Cuenta';
	tabColumna( 5) := 'Monto Debe';
	tabColumna( 6) := 'Monto Haber';

	--Inicializamos contador de renglones
	vnRow := 0;

	FOR regReporte IN cuDatos(vdFecha ,vsPerio ,vsCntr ,vsCcts) LOOP

		--Incremento el contador de renglones
		vnRow := vnRow + 1;
		vnExists := 1; --Bandera para indicar que hubo resultados

		--Si es el primer renglon de cada pgina...
		IF vnRow = 1  THEN
			--imprimo el encabezado de reporte
			Pk_Sisrepimp.P_EncabezadoDeReporte(
				psReclDesc ,vnColumnas ,tabColumna
				,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
			);
			vsInicoPag := 'SALTO';
		END IF;

		--Comienzo a desplegar el renglon
		HTP.P('<tr>');
		HTP.P('<td>'||f_ObtDescCcts(regReporte.Centro)||'</td>');
		HTP.P('<td>'||regReporte.Cntr||'</td>');
		HTP.P('<td>'||regReporte.Cuenta||'</td>');
		HTP.P('<td>'||f_ObtDescCta(regReporte.Cuenta)||'</td>');
		HTP.P('<td style="text-align:right;">'||TO_CHAR(regReporte.Debe,csFmt) ||'</td>');
		HTP.P('<td style="text-align:right;">'||TO_CHAR(regReporte.Haber,csFmt) ||'</td>');
		--Fin del renglon
		HTP.P('</tr>');

	END LOOP;

	IF vnExists = 0 THEN
		--Ojo esta linea lo que hace es imprimir
		--NO SE ENCONTRARON DATOS o un mensaje similar
		htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
	ELSE

		-- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
		Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

		-- es omitido el encabezado del reporte pero se agrega el salto de pagina
		Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
	END IF;

	--Fin de la pagina
	htp.p('</table><br/></body></html>');
EXCEPTION
	WHEN OTHERS THEN
		--pantallazo de error.
		pk_UtilWeb.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
			'PWRRGCN', NULL);
END PWRRGCN;
/


DROP PUBLIC SYNONYM PWRRGCN;

CREATE PUBLIC SYNONYM PWRRGCN FOR BANINST1.PWRRGCN;


GRANT EXECUTE ON BANINST1.PWRRGCN TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRRGCN TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRRGCN TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRRGCN TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRRGMC;

CREATE OR REPLACE PROCEDURE BANINST1.PWRRGMC (
	psReclDesc			VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:		PWRRGMC
OBJETIVO:			Reporte Global de Montos por Contrato
PARAMETROS:
psReclDesc			Variable estandar para la maquina de reportes custom
AUTOR:				Gilberto Velazquez Hernandez
FECHA:				20121205
******************************************************************************/

	--Cursor para traer los acumulados por contrato, medio de pago y estatus
	--de documento
	--Ojo ya que es dependiente de la fecha, si hay varios movimientos para
	--un dia, se toma el ultimo de ese dia.
	CURSOR cuDatos(
		pdFecha 		DATE
		,psPerio		VARCHAR2
		,psCntr			VARCHAR2
		,psProg			VARCHAR2
	) IS
		SELECT
			TWBCNTR_NUM							AS Cntr
			,TWBCNTR_TERM_CODE					AS Perio
			,TWBCNTR_ORI_PROGRAM				AS Prog
			,TWBDOCU_PAYM_CODE					AS MP
			,DOMV1.TWRDOMV_STATUS_IND			AS Status
			,SUM(TWBDOCU_AMOUNT)				AS Monto
		FROM
			TWRDOMV DOMV1
			,TWBDOCU
			,TWBCNTR
		WHERE
			TWBDOCU_CNTR_NUM = TWBCNTR_NUM
			AND DOMV1.TWRDOMV_DOCU_SEQ_NUM = TWBDOCU_SEQ_NUM
			--Contratos validos
			AND TWBCNTR_STATUS_IND <> 'C'
			--Este filtro quita la basura y documentos descartados
			AND TWBDOCU_STATUS_IND NOT IN ('CA','RV')
			--El ultimo movimiento para el documento en ese dia.
			AND DOMV1.TWRDOMV_MOVE_NUM = (
				SELECT
					MAX(DOMV2.TWRDOMV_MOVE_NUM)
				FROM
					TWRDOMV DOMV2
				WHERE
					DOMV2.TWRDOMV_DOCU_SEQ_NUM = DOMV1.TWRDOMV_DOCU_SEQ_NUM
					AND DOMV2.TWRDOMV_MOVE_DATE < pdFecha + 1
			)
			AND (psProg IS NULL OR TWBCNTR_ORI_PROGRAM = psProg)
			AND (psPerio IS NULL OR TWBDOCU_TERM_CODE = psPerio)
			AND (psCntr IS NULL OR TWBCNTR_NUM = psCntr)
		GROUP BY
			TWBCNTR_NUM
			,TWBCNTR_TERM_CODE
			,TWBCNTR_ORI_PROGRAM
			,TWBDOCU_PAYM_CODE
			,DOMV1.TWRDOMV_STATUS_IND;


	--Variables del reporte
	--Fecha de corte
	vdFecha				DATE;
	--Numero de contrato
	vsCntr				VARCHAR2(10);
	--Periodo
	vsPerio				VARCHAR2(6);
	--Centro de costos
	vsProg				VARCHAR2(12);
	--Formato de numeros
	csFmt				VARCHAR2(20) := 'FM999999999999';


	--Variables para la presetacion
	--Numero de renglones
	vnRow				PLS_INTEGER := 0;
	--Bandera para mostrar si hubo datos
	vnExists			PLS_INTEGER := 0;
	--Numero de columnas
	vnColumnas			PLS_INTEGER := 9;
	--Numero de registros
	vnRegs				PLS_INTEGER := 0;
	--Arreglo (nested table) donde se guardan los encabezados de las columnas
	tabColumna			Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
	-- la variable es una bandera que al tener el valor "imprime" no colocara
	--el salto de pgina para impresion
	vsInicoPag			VARCHAR2(10) := NULL;
	--Nmero de renglones por pgina
	vnRegsPag			PLS_INTEGER := 10000; --Ver que valor se ajusta!?


BEGIN
	--Seguridad de GWAMNUR
	IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

	--Fecha, este es OBLIGATORIO!!!
	vdFecha := TO_DATE(pk_objHtml.getValueCookie('psFecha'),'DD/MM/YYYY');
	--Periodo:
	vsPerio := pk_objHtml.getValueCookie('psPerio');
	--Contrato
	vsCntr := pk_objHtml.getValueCookie('psCntr');
	--Programa
	vsProg := pk_objHtml.getValueCookie('psProg');

	-- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
	tabColumna.EXTEND(vnColumnas);

	--Guardamos los encabezados en el arreglo de columnas
	tabColumna( 1) := 'Num. Contrato';
	tabColumna( 2) := 'Periodo';
	tabColumna( 3) := 'Programa';
	tabColumna( 4) := 'Desc. Programa';
	tabColumna( 5) := 'Medio Pago';
	tabColumna( 6) := 'Desc. Medio Pago';
	tabColumna( 7) := 'Estado';
	tabColumna( 8) := 'Desc. Estado';
	tabColumna( 9) := 'Monto';

	--Inicializamos contador de renglones
	vnRow := 0;

	FOR regReporte IN cuDatos(vdFecha ,vsPerio ,vsCntr ,vsProg) LOOP

		--Incremento el contador de renglones
		vnRow := vnRow + 1;
		vnExists := 1; --Bandera para indicar que hubo resultados

		--Si es el primer renglon de cada pgina...
		IF vnRow = 1  THEN
			--imprimo el encabezado de reporte
			Pk_Sisrepimp.P_EncabezadoDeReporte(
				psReclDesc ,vnColumnas ,tabColumna
				,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
			);
			vsInicoPag := 'SALTO';
		END IF;

		--Comienzo a desplegar el renglon
		HTP.P('<tr>');
		HTP.P('<td>'||regReporte.Cntr||'</td>');
		HTP.P('<td>'||regReporte.Perio||'</td>');
		HTP.P('<td>'||regReporte.Prog||'</td>');
		HTP.P('<td>'||pk_Catalogo.Programa(regReporte.Prog)||'</td>');
		HTP.P('<td>'||regReporte.MP||'</td>');
		HTP.P('<td>'||pk_Matricula.f_ExisteMedioPago(regReporte.MP)||'</td>');
		HTP.P('<td>'||regReporte.Status||'</td>');
		HTP.P('<td>'||pk_Matricula.f_GetDocStatusDesc(regReporte.Status)||'</td>');
		HTP.P('<td style="text-align:right;">'||TO_CHAR(regReporte.Monto,csFmt) ||'</td>');
		--Fin del renglon
		HTP.P('</tr>');
		--Fin del renglon
		HTP.P('</tr>');

	END LOOP;

	IF vnExists = 0 THEN
		--Ojo esta linea lo que hace es imprimir
		--NO SE ENCONTRARON DATOS o un mensaje similar
		htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
	ELSE

		-- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
		Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

		-- es omitido el encabezado del reporte pero se agrega el salto de pagina
		Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
	END IF;

	--Fin de la pagina
	htp.p('</table><br/></body></html>');
EXCEPTION
	WHEN OTHERS THEN
		--pantallazo de error.
		pk_UtilWeb.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
			'PWRRGMC', NULL);
END PWRRGMC;
/


DROP PUBLIC SYNONYM PWRRGMC;

CREATE PUBLIC SYNONYM PWRRGMC FOR BANINST1.PWRRGMC;


GRANT EXECUTE ON BANINST1.PWRRGMC TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRRGMC TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRRGMC TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRRGMC TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRRHDM;

CREATE OR REPLACE PROCEDURE BANINST1.PWRRHDM(
	psReclDesc			VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:		PWRRHDM
OBJETIVO:			Reporte Historico de Documentos de Matricula
PARAMETROS:
psReclDesc			Variable estandar para la maquina de reportes custom
AUTOR:				Gilberto Velazquez Hernandez
FECHA:				20130317
******************************************************************************/

/******
Modificacion

Agregar dos fechas : corte de inicio y fin


*/



/******************************************************************************
Mis queridos compaeros:
Muy probablemente este es mi ultimo desarrollo que hago de cero en la oficina.
Alguien me haba comentado en la carrera que siempre en mis trabajos dejaba
mi esencia, una parte de mi, ser cierto? No lo se, decir que si seria engreido,
decir que no seria descortes; pero esta vez quiero que si sea asi y que sea
explicito.

Muchas veces nos topamos en pared con la palabra "tunning", afinacin,
rendimiento, etc. y siempre nos quejamos de que no hay nadie que nos diga que
o como se deben hacer las cosas. Este reporte es la antitesis de esto, quiero
explicarles como hice un desarrollo enfocado netamente hacia desempeo  y por
que tome las decisiones que tome para hacerlo.

Este reporte consiste en obtener una fotografa de la situacin del mdulo
de matrcula hasta un dia dado; La parte funcional la pueden consultar con
Ara, Marce o Socorro.

Como podrn suponer, el nico filtro obligatorio es dicha fecha, generalmente
las fechas no estan indizadas por lo que la costumbre nos diria que no hay
forma de evitar el FULL TABLE SCAN; Como bien saben, si ponemos los filtros con
la estrategia habitual de (psPerio IS NULL OR TABLA_TERM_CODE = psPerio)
perdemos la habilidad de aprovechar esos indices.

Sin embargo existe una forma de hacer que la base de datos tome el mejor explain
plan en base a los parmetros que nosotros especifiquemos: construir el query
al vuelo y ejecutarlo con sql dinmico; ahora me imagino que me diran que no
debemos usar eso debido a que se reparsea por el uso de literales, quien les
dijo que ibamos a usar literales jojojojo.

******************************************************************************/

	--El primer paso es definir nuestro query base, con todos sus joins y
	--filtros obligatorios, dentro de una variable VARCHAR2.
	--Query Principal
	vsQuery				VARCHAR2(4000) :=
'SELECT
	TWBDOCU_SEQ_NUM								AS NumSeqDoc
	,TWBDOCU_TERM_CODE							AS Perio
	,TWBDOCU_CNTR_NUM							AS Cntr
	,TWBDOCU_PAYM_CODE							AS MP
	,TWBDOCU_AMOUNT								AS Monto
	,TWBDOCU_NOM_AMOUNT							AS MontoNom
	,TWBDOCU_EXPIRATION_DATE					AS FechaVig
	,TWBDOCU_DOCU_NUM							AS NumDocu
	,TWBDOCU_BANK_CODE							AS Banco
	,TWBDOCU_CTYP_CODE							AS TipoTarjeta
	,TWBDOCU_PLCE_CODE							AS Plaza
	,TWBDOCU_CURR_ACNT							AS CuentaCorriente
	,TWBDOCU_ENTRY_DATE							AS FechaCaptura
	,TWBDOCU_ENTRY_USER							AS UsuarioCaptura
	,DOMV1.TWRDOMV_STATUS_IND					AS Status
	,DOMV1.TWRDOMV_MOVE_DATE					AS FechaStatus
	,DOMV1.TWRDOMV_USER							AS UsuarioStatus
FROM
	TWBDOCU
	,TWRDOMV DOMV1
    ,TWBCNTR
WHERE
    TWBCNTR_NUM = TWBDOCU_CNTR_NUM
	AND DOMV1.TWRDOMV_DOCU_SEQ_NUM = TWBDOCU_SEQ_NUM
	AND DOMV1.TWRDOMV_MOVE_NUM = (
		SELECT
			MAX(DOMV2.TWRDOMV_MOVE_NUM)
		FROM
			TWRDOMV DOMV2
		WHERE
			DOMV2.TWRDOMV_DOCU_SEQ_NUM = DOMV1.TWRDOMV_DOCU_SEQ_NUM
			AND DOMV2.TWRDOMV_MOVE_DATE < :pdFechaFin + 1
			AND DOMV2.TWRDOMV_MOVE_DATE >= :pdFechaIni
	)';
	--Noten que aqui puse una fecha contra un "parametro", los parametros
	--deben ir denotados con un dos puntos (:) a su izquierda.
	--Respecto a por que no use truncs en la fecha les comparto el razonamiento:
	--Cuando alimentamos a la maquina de reportes, generalmente especificamos
	--solo fechas en el formato 'DD/MM/YYYY', cuando Oracle convierte esa cadena
	--a fecha, pone su hora a las 00:00:00 de ese dia, al sumarle uno lo mueve
	--al dia siguiente, por lo que todo lo que este antes (menor que) esa nueva
	--fecha ES UN HECHO que cumple con el filtro:
	--Ej: tengo un dato 14/02/2013 15:56:34, al yo establecer el filtro a
	--14/02/2013, oracle lo convertira a 14/02/2013 00:00:00, al sumarle uno
	--ser 15/02/2013 00:00:00 que es evidentemente una fecha superior a la del
	--dato, por lo que el operador "<" dara verdadero y el dato sera mostrado


	--Se debe definir un tipo de registro con exactamente las mismas columnas
	--que la consulta (por lo menos el tipo de datos debe ser el mismo).
	--Despues de haber creado dicho tipo, se tiene que crear un tipo de tabla
	--anidada (arreglo) para dichos registros y declarar una variable de ese
	--tipo para guardar TODOS los registros que me devuelva el cursor

	--Tipos y Tablas para guardar la salida
	TYPE t_Reg IS RECORD(
		NumSeqDoc			TWBDOCU.TWBDOCU_SEQ_NUM%TYPE
		,Perio				TWBDOCU.TWBDOCU_TERM_CODE%TYPE
		,Cntr				TWBDOCU.TWBDOCU_CNTR_NUM%TYPE
		,MP					TWBDOCU.TWBDOCU_PAYM_CODE%TYPE
		,Monto				TWBDOCU.TWBDOCU_PAYM_CODE%TYPE
		,MontoNom			TWBDOCU.TWBDOCU_NOM_AMOUNT%TYPE
		,FechaVig			TWBDOCU.TWBDOCU_EXPIRATION_DATE%TYPE
		,NumDocu			TWBDOCU.TWBDOCU_DOCU_NUM%TYPE
		,Banco				TWBDOCU.TWBDOCU_BANK_CODE%TYPE
		,TipoTarjeta		TWBDOCU.TWBDOCU_CTYP_CODE%TYPE
		,Plaza				TWBDOCU.TWBDOCU_PLCE_CODE%TYPE
		,CuentaCorriente	TWBDOCU.TWBDOCU_CURR_ACNT%TYPE
		,FechaCaptura		TWBDOCU.TWBDOCU_ENTRY_DATE%TYPE
		,UsuarioCaptura		TWBDOCU.TWBDOCU_ENTRY_USER%TYPE
		,Status				TWRDOMV.TWRDOMV_STATUS_IND%TYPE
		,FechaStatus		TWRDOMV.TWRDOMV_MOVE_DATE%TYPE
		,UsuarioStatus		TWRDOMV.TWRDOMV_USER%TYPE
	);
	TYPE t_TblReg IS TABLE OF t_Reg;
	vtReg				t_TblReg;

	--Estas variables me van a permitir el uso de sql dinamico; el sql dinamico
	--se ejecuta a travs del paquete DBMS_SQL, se requiere una variable entera
	--para guardar la referencia a nuestro cursor (esto es similar a los
	--apuntadores), otra variable entera para guardar el numero de ejecucin al
	--momento de ejecutar el query del cursor, asi como un tipo de cursor por
	--referencia debil, y una variable de ese tipo (para manipularlo como cursor
	--de pl estandar.

	--Numero para guardar la referencia al cursor
	vnNumCur			INTEGER;
	--Numero para la ejecucion del cursor
	vnExec				INTEGER;
	--Cursor por referencia para guardar la salida
	TYPE RefCur IS REF CURSOR;
	vcCursor			RefCur;

	--Variables del reporte
	--Fecha de corte
	vdFechaIni				DATE;

	vdFechaFin				DATE;
	--Ao del contrato
	vsYear				VARCHAR2(4);
	--Numero de contrato
	vsCntr				VARCHAR2(10);
	--Id del alumno
	vsId				VARCHAR2(9);
	vnPidm				NUMBER(10);
	--Medio de Pago
	vsMP				VARCHAR2(3);
	--Estado del documento
	vsStatus			VARCHAR2(2);

	--Numero de documento
	vsNumDoc			VARCHAR2(25);

	--Formato de numeros
	csFmt				VARCHAR2(20) := 'FM999999999999';
	csDate				VARCHAR2(20) := 'DD/MM/YYYY';

	--Variables para la presetacion
	--Numero de renglones
	vnRow				PLS_INTEGER := 0;
	--Bandera para mostrar si hubo datos
	vnExists			PLS_INTEGER := 0;
	--Numero de columnas
	vnColumnas			PLS_INTEGER := 21;
	--Numero de registros
	vnRegs				PLS_INTEGER := 0;
	--Arreglo (nested table) donde se guardan los encabezados de las columnas
	tabColumna			Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
	-- la variable es una bandera que al tener el valor "imprime" no colocara
	--el salto de pgina para impresion
	vsInicoPag			VARCHAR2(10) := NULL;
	--Nmero de renglones por pgina
	vnRegsPag			PLS_INTEGER := 10000; --Ver que valor se ajusta!?
	--Contador comun y corriente
    vsTipoCntr VARCHAR2(15);

BEGIN

	--Estas lineas no tienen nada de extraordinario, es la seguridad del
	--menu de aplicaciones y la lectura de los parametros que son
	--almacenados como cookies en el lado del cliente y son enviadas al servidor
	--cada vez que el cliente hace una peticin.

	--Seguridad de GWAMNUR
	IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

	--Fecha, este es OBLIGATORIO!!!
	--md-01
	vdFechaIni := TO_DATE(pk_objHtml.getValueCookie('psIniFe'),'DD/MM/YYYY');
	vdFechaFin := TO_DATE(pk_objHtml.getValueCookie('psFinFe'),'DD/MM/YYYY');

	--Periodo:
	vsYear := pk_objHtml.getValueCookie('psYear');
	--Contrato
	vsCntr := pk_objHtml.getValueCookie('psCntr');
	--Id del alumno
	vsId := pk_objHtml.getValueCookie('psId');
	--Medio de pago:
	vsMP := pk_ObjHtml.getValueCookie ('psPago');
	--Estado del documento
	vsStatus := pk_ObjHtml.getValueCookie ('psTaDoc');
	--Numero del documento
	vsNumDoc := pk_ObjHtml.getValueCookie ('psNumDo');
    --md-01
    vsTipoCntr := pk_ObjHtml.getValueCookie ('psTCntr');

	-- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
	tabColumna.EXTEND(vnColumnas);

	--Guardamos los encabezados en el arreglo de columnas
	tabColumna( 1) := 'Periodo';
	tabColumna( 2) := 'Num. Contrato';
	tabColumna( 3) := 'Medio Pago';
	tabColumna( 4) := 'Desc. Medio Pago';
	tabColumna( 5) := 'Monto';
	tabColumna( 6) := 'Monto Nominal';
	tabColumna( 7) := 'Fecha Vigencia';
	tabColumna( 8) := 'Num. Doc./Cuota';
	tabColumna( 9) := 'Banco';
	tabColumna(10) := 'Desc. Banco';
	tabColumna(11) := 'Tarjeta';
	tabColumna(12) := 'Desc. Tarjeta';
	tabColumna(13) := 'Plaza';
	tabColumna(14) := 'Desc. Plaza';
	tabColumna(15) := 'Cuenta Corriente';
	tabColumna(16) := 'Fecha Entrada';
	tabColumna(17) := 'Usuario Entrada';
	tabColumna(18) := 'Estado Ult. Mov';
	tabColumna(19) := 'Desc. Estado';
	tabColumna(20) := 'Fecha Ult. Mov';
	tabColumna(21) := 'Usuario Ult. Mov';

	--Aqui viene la parte interesante, una vez que ya lei todos mis parmetros
	--ya se con que filtros cuento y con cuales no, asi que me basta agregar
	--a mi query aquellos filtros con los que si cuento.
	--Tengan cuidado de que la cadena debe quedar coherente, es decir no se
	--coman los espacios y mantengan las palabras separadas, por ello todas
	--las clausulas que estoy agregando tienen un espacio al principio.


	--ya que tengo mis parametros construyo el query con los filtros
	--requeridos
	--ojo que todas las cadenas empiezan con un espacio
	--Ao no nulo
	IF vsYear IS NOT NULL THEN
		vsQuery := vsQuery || ' AND TWBDOCU_TERM_CODE LIKE :psYear';
	END IF;

	--Si se dan cuenta la clausula ya no fue
	--(psYear IS NULL OR TWBDOCU_TERM_CODE LIKE :psYear)
	--no la agreguen asi, de entrada seria programacin jarocha (si estan dentro
	--del IF es obvio que el parametro tiene valor, y a parte no permitirian
	--que se creara un explain plan adecuado con este filtro.
	--Otra cosa, si se dan cuenta puse LIKE y un parametro, pero no puse los
	--signos de porcentaje, esos se indicarn posteriormente.

	--Numero de contrato no nulo
	IF vsCntr IS NOT NULL THEN
		vsQuery := vsQuery || ' AND TWBDOCU_CNTR_NUM = :psCntr';
	END IF;

	--Id del alumno no es nulo
	IF vsId IS NOT NULL THEN
		vsQuery := vsQuery || ' AND TWBDOCU_PIDM = :pnPidm';
	END IF;

	--Medio de Pago no nulo
	IF vsMP IS NOT NULL THEN
		vsQuery := vsQuery || ' AND TWBDOCU_PAYM_CODE = :psMP';
	END IF;

	--Estado no nulo
	IF vsStatus IS NOT NULL THEN
		vsQuery := vsQuery || ' AND TWBDOCU_STATUS_IND = :psStatus';
	END IF;

	--Numero de documento no nulo:
	IF vsNumDoc IS NOT NULL THEN
		vsQuery := vsQuery || ' AND TWBDOCU_DOCU_NUM LIKE :psNumDoc';
	END IF;

	--md-01

    ---Tipo de contrato

    IF vsTipoCntr = 'POSTGRADO' THEN
      vsQuery := vsQuery || ' AND TWBCNTR_TYPE_CODE = ''CFC'' ';
    END IF;

	IF vsTipoCntr = 'PREGRADO' THEN
        vsQuery := vsQuery || ' AND TWBCNTR_TYPE_CODE IS NULL ';
    END IF;

    --Agrego mi clausula de ordenamiento
	vsQuery := vsQuery || ' ORDER BY TWBDOCU_SEQ_NUM ASC';

	--En estos momentos ya tengo mi query armado con los filtros que si tengo;
	--ojo que aun no le he especificado el valor de los filtros, esto es
	--equivalente al uso de variables en lugar de literales


	--Para empezar a usar SQL dinamico tiene que abrir un cursor, la diferencia
	--con lo que venimos haciendo es que aqui no hay query, solo se abre el
	--cursor, lo cual me entrega un numero de cursor, una referencia numerica
	--al mismo

	--Ahora que ya asigne abro mi cursor dinamico
	vnNumCur := DBMS_SQL.OPEN_CURSOR;

	--Ahora, le indico a la maquina de sql que "parsee", interprete mi sentencia
	--con esto estara cargado en memoria mi query, pero aun no se ejecuta

	--Parseamos el query
    --DBMS_OUTPUT.PUT_LINE(vsQuery);
	DBMS_SQL.PARSE(vnNumCur, vsQuery, DBMS_SQL.NATIVE);

	--Aqui se asignan las variables bind, es decir aqui es donde le asignamos
	--un valor a nuestros parametros (insisto, seguimos sin usar literales)
	--Los tipos de dato de sus valores deben coincidir con los tipos de dato
	--de los parametros, aqui se ponen los parametros sin los dos puntos (:)

	--Asginamos las variables de bind
	DBMS_SQL.BIND_VARIABLE(vnNumCur, 'pdFechaFin', vdFechaFin);
DBMS_SQL.BIND_VARIABLE(vnNumCur, 'pdFechaIni', vdFechaIni);


	--Solo agreguen las variables de bind que vayan a usar, no mas, no menos,
	--de lo contrario les marcara error.

	--Ojo que en el siguiente parametro agrego los signos de porcetaje en
	--base a como los uso.
	--Ao no nulo
	IF vsYear IS NOT NULL THEN
		DBMS_SQL.BIND_VARIABLE(vnNumCur, 'psYear', vsYear||'%');
	END IF;

	--Numero de contrato no nulo
	IF vsCntr IS NOT NULL THEN
		DBMS_SQL.BIND_VARIABLE(vnNumCur, 'psCntr', vsCntr);
	END IF;

	--Id del alumno no es nulo
	IF vsId IS NOT NULL THEN
		vnPidm := f_Get_Pidm(vsId);
		DBMS_SQL.BIND_VARIABLE(vnNumCur, 'pnPidm', vnPidm);
	END IF;

	--Medio de Pago no nulo
	IF vsMP IS NOT NULL THEN
		DBMS_SQL.BIND_VARIABLE(vnNumCur, 'psMP', vsMP);
	END IF;

	--Estado no nulo
	IF vsStatus IS NOT NULL THEN
		DBMS_SQL.BIND_VARIABLE(vnNumCur, 'psStatus', vsStatus);
	END IF;

	--Numero de documento no nulo:
	IF vsNumDoc IS NOT NULL THEN
		DBMS_SQL.BIND_VARIABLE(vnNumCur, 'psNumDoc', '%'||vsNumDoc||'%');
	END IF;
  /*
        --Tipo de contrato
    IF vsTipoCntr IS NOT NULL THEN
        DBMS_SQL.BIND_VARIABLE(vnNumCur, 'psTCntr', vsTipoCntr);
    END IF;

*/
	--Ya que estan asignadas todas mis variables de bind, ejecuto el cursor
	--del lado de sql, es el equivalente al OPEN cuFulado(Detal);

	--Ejecutamos el cursor
	vnExec := DBMS_SQL.EXECUTE(vnNumCur);

	--Este es el punto fino, DBMS_SQL permite la manipulacin completamente
	--dinmica de como extraemos los datos del cursor, muy al estilo como lo
	--hariamos en java o .net, sin embargo para esta aplicacin no requerimos
	--tal control, por lo que podemos hacer que nuestro quuery/cursor/sql
	--dinamico (como lo quieran llamar) se comporte como un cursor mas estandar
	--de pl y lo podamos manipular a gusto con instrucciones mas simples;
	--para ello usamos la funcin TO_RefCursor, que me devuelve una referencia
	--pl al cursor

	--Lo transformamos a sql dinamico nativo de pl
	vcCursor := DBMS_SQL.TO_REFCURSOR(vnNumCur);

	--vcCursor es una variable de tipo REF CURSOR por lo que en este momento
	--se comporta casi igual a un cursor clasico, asi que puedo hacer FETCH
	--y CLOSE sobre el

	--Aqui el cursor esta abierto y listo para manipularlo con pl estandard
	FETCH vcCursor BULK COLLECT INTO vtReg;
	CLOSE vcCursor;

	--Algo muy importante, y que no me canso de decir: no hay nada mas lento
	--que un disco duro, y otra cosa no tan lenta pero que sigue siendo lenta
	--son los viajes de red, asi que en la medida de lo posible reduzcan sus
	--lecturas al disco duro y sus viajes de red, la forma mas sensata de
	--hacerlo es usando bulk collect, que jala todos los datos de un golpe
	--(y con el mnimo de viajes de red requeridos...)
	--Ahora me diran que eso es muy agresivo con memoria, si, es cierto, pero
	--la memoria reacciona en 1, y la red y el disco duro en 1000, asi que
	--la decisin es obvia; por memoria solo debiesen preocuparse cuando jalen
	--cantidades de dato enormes (por ejemplo un select * from --tbraccd en la
	--rua ) o cuando este proceso tenga una concurrencia muy pero muy alta, es
	--decir que 1000 usuarios esten ejecutando el proceso al mismo tiempo
	--literalmente

	--Lo que sigue es la generacin estandar de un reporte comun y coriente,
	--noten como la unica diferencia es el uso de la coleccin de pl en lugar
	--de un for con un cursor

	--Inicializamos contador de renglones
	vnRow := 0;

	--Comienzo a recorrer la salida
	FOR vni IN 1..vtReg.COUNT LOOP

		--Incremento el contador de renglones
		vnRow := vnRow + 1;
		vnExists := 1; --Bandera para indicar que hubo resultados

		--Si es el primer renglon de cada pgina...
		IF vnRow = 1  THEN
			--imprimo el encabezado de reporte
			Pk_Sisrepimp.P_EncabezadoDeReporte(
				psReclDesc ,vnColumnas ,tabColumna
				,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
			);
			vsInicoPag := 'SALTO';
		END IF;

		--Comienzo a desplegar el renglon
		HTP.P('<tr>');
		HTP.P('<td>'||vtReg(vni).Perio||'</td>');
		HTP.P('<td>'||vtReg(vni).Cntr||'</td>');
		HTP.P('<td>'||vtReg(vni).MP||'</td>');
		HTP.P('<td>'||pk_Matricula.f_ExisteMedioPago(vtReg(vni).MP)||'</td>');
		HTP.P('<td style="text-align:right;">'||TO_CHAR(vtReg(vni).Monto,csFmt) ||'</td>');
		HTP.P('<td style="text-align:right;">'||TO_CHAR(vtReg(vni).MontoNom,csFmt) ||'</td>');
		HTP.P('<td>'||TO_CHAR(vtReg(vni).FechaVig,csDate) ||'</td>');
		HTP.P('<td>'||vtReg(vni).NumDocu||'</td>');
		HTP.P('<td>'||vtReg(vni).Banco||'</td>');
		HTP.P('<td>'||pk_Matricula.f_ExisteBanco(vtReg(vni).Banco)||'</td>');
		HTP.P('<td>'||vtReg(vni).TipoTarjeta||'</td>');
		HTP.P('<td>'||pk_Matricula.f_ExisteBanco(vtReg(vni).TipoTarjeta)||'</td>');
		HTP.P('<td>'||vtReg(vni).Plaza||'</td>');
		HTP.P('<td>'||pk_Matricula.f_ExistePlaza(vtReg(vni).Plaza)||'</td>');
		HTP.P('<td>'||vtReg(vni).CuentaCorriente||'</td>');
		HTP.P('<td>'||TO_CHAR(vtReg(vni).FechaCaptura,csDate) ||'</td>');
		HTP.P('<td>'||vtReg(vni).UsuarioCaptura||'</td>');
		HTP.P('<td>'||vtReg(vni).Status||'</td>');
		HTP.P('<td>'||pk_Matricula.f_GetDocStatusDesc(vtReg(vni).Status)||'</td>');
		HTP.P('<td>'||TO_CHAR(vtReg(vni).FechaStatus,csDate) ||'</td>');
		HTP.P('<td>'||vtReg(vni).UsuarioStatus||'</td>');
		HTP.P('</tr>');

	END LOOP;

	IF vnExists = 0 THEN
		--Ojo esta linea lo que hace es imprimir
		--NO SE ENCONTRARON DATOS o un mensaje similar
		htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
	ELSE

		-- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
		Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

		-- es omitido el encabezado del reporte pero se agrega el salto de pagina
		Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
	END IF;

	--Fin de la pagina
	htp.p('</table><br/></body></html>');

	--Mis estimados: si se dan cuenta no fue mucha ciencia (o si??) la
	--estrategia que segui en este reporte, sin embargo, para llegar a esto
	--si me tuve que documentar bastante durante mucho tiempo; google en ingles
	--y las experiencias de otros programadores son sus mejores amigos.

	--Generalmente nos topamos con situaciones semejantes (mas no iguales) que
	--en otras partes del globo ya se han topado, entonces hay que buscar si
	--eso ya ha sido resuelto antes, ojo que tambien todo lo que vemos tiene
	--que pasar por ojo critico y adaptarse a nuestras necesidades: no siempre
	--la solucin mas directa es la mejor ni la mas rebuscada la mas eficiente,
	--esta en ustedes encontrar un punto medio.

	--No se queden con lo que les dice equis o ye, busquen alla afuera, sean
	--incredulos de entrada, no sean pasivos ni complacientes, y siempre
	--aspiren a mejorar sus conocimientos para hacer un mejor trabajo y para
	--ayudarse los unos a los otros
	--Los quiero mucho y gracias por sus enseanzas, su apoyo y todos los
	--momentos que compartieron conmigo
	--Gil.

EXCEPTION
	WHEN OTHERS THEN
		--pantallazo de error.
        --htp.p(vsQuery);
		pk_UtilWeb.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
			'PWRRHDM', NULL);




END PWRRHDM;
/


DROP PUBLIC SYNONYM PWRRHDM;

CREATE PUBLIC SYNONYM PWRRHDM FOR BANINST1.PWRRHDM;


GRANT EXECUTE ON BANINST1.PWRRHDM TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRRHDM TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRRHDM TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRRHDM TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRRPGL;

CREATE OR REPLACE PROCEDURE BANINST1.PWRRPGL (
	psReclDesc			VARCHAR2
) IS
/******************************************************************************
PROCEDIMIENTO:		PWRRPGL
OBJETIVO:			Reporte de Reprogramacion: Global
PARAMETROS:
psReclDesc			Variable estandar para la maquina de reportes custom
AUTOR:				Gilberto Velazquez Hernandez
FECHA:				20120515
******************************************************************************/

	--Numero de renglones
	vnRow				PLS_INTEGER := 0;
	--Bandera para mostrar si hubo datos
	vnExists			INTEGER := 0;
	--Numero de columnas
	vnColumnas			INTEGER := 13;
	--Numero de registros
	vnRegs				INTEGER := 0;
	--Arreglo (nested table) donde se guardan los encabezados de las columnas
	tabColumna			Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
	-- la variable es una bandera que al tener el valor "imprime" no colocara
	--el salto de pgina para impresion
	vsInicoPag			VARCHAR2(10) := NULL;
	--Nmero de renglones por pgina
	vnRegsPag			PLS_INTEGER := 5000;

	--Filtro de Fecha
	vdFechaIni			DATE;
	vdFechaFin			DATE;

	--Filtro de Reprogramador
	vsOper				VARCHAR2(30);
	--Filtro de Contrato
	vsCntr				VARCHAR2(10);

	CURSOR cuReporte(
		pdFechaIni		DATE
		,pdFechaFin		DATE
		,psOper			VARCHAR2
		,psCntr			VARCHAR2
	) IS
		SELECT
			TWBRPRG_NUM								AS NumRepro
			,TWBRPRG_RPRG_USER						AS UserRepro
			,TWBRPRG_RPRG_DATE						AS Fecha
			,SPRIDEN_ID								AS Id
			,SPRIDEN_LAST_NAME
				||' '||SPRIDEN_FIRST_NAME			AS NombreAlumno
			,TWBRPRG_CNTR_NUM						AS NumCntr
			,NVL(
				TWBRPRG_FOLK_RUT
				,TWBCNTR_RUT
			)										AS RutApo
			,pk_MatApoderado.f_NombreCompleto(
				NVL(
					TWBRPRG_FOLK_RUT
					,TWBCNTR_RUT
				)
			)										AS NombreApoderado
			,(CASE UPPER(TWBRPRG_TYPE_IND)
				WHEN 'N' THEN 'Normal'
				WHEN 'F' THEN 'Por beneficio'
				WHEN 'T' THEN 'Por tesoreria'
				WHEN 'R' THEN 'Por retracto'
				WHEN 'C' THEN 'Congelacin'
				ELSE 'Otros'
			END)									AS TipoRepro
			,(SELECT
				NVL(SUM(TWBDOCU_AMOUNT),0)
			FROM
				TWBDOCU
				,TWRRPOD
			WHERE
				TWBDOCU_SEQ_NUM = TWRRPOD_DOCU_SEQ_NUM
				AND TWRRPOD_RPRG_NUM = TWBRPRG_NUM
			)										AS MontoRepr
			,(SELECT
				NVL(SUM(TWBDOCU_AMOUNT),0)
			FROM
				TWBDOCU
				,TWRRPPD
			WHERE
				TWBDOCU_SEQ_NUM = TWRRPPD_DOCU_SEQ_NUM
				AND TWRRPPD_RPRG_NUM = TWBRPRG_NUM
			)										AS MontoDia
			,(SELECT
				NVL(SUM(TWBDOCU_AMOUNT),0)
			FROM
				TWBDOCU
				,TWRRPND
			WHERE
				TWBDOCU_SEQ_NUM = TWRRPND_DOCU_SEQ_NUM
				AND TWRRPND_RPRG_NUM = TWBRPRG_NUM
			)										AS MontoPlan
			,TWBRPRG_COMMENT						AS Comentario
		FROM
			TWBRPRG
			,TWBCNTR
			,SPRIDEN
		WHERE
			TWBCNTR_NUM = TWBRPRG_CNTR_NUM
			AND SPRIDEN_PIDM = TWBCNTR_PIDM
			AND SPRIDEN_CHANGE_IND IS NULL
			AND (pdFechaIni IS NULL OR (pdFechaIni <= TWBRPRG_RPRG_DATE))
			AND (pdFechaFin IS NULL OR (pdFechaFin+1 > TWBRPRG_RPRG_DATE))
			AND (vsOper IS NULL OR vsOper = TWBRPRG_RPRG_USER)
			AND (vsCntr IS NULL OR vsCntr = TWBRPRG_CNTR_NUM)
		ORDER BY
			TWBRPRG_NUM;

BEGIN

	--Seguridad de GWAMNUR
	IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

	--Obtengo la fecha del reporte
	vdFechaIni := TO_DATE(pk_objHtml.getValueCookie('pdIni'),'DD/MM/YYYY');
	vdFechaFin := TO_DATE(pk_objHtml.getValueCookie('pdFin'),'DD/MM/YYYY');

	--Obtengo el usuario para el que se desea el reporte
	vsOper := pk_objHtml.getValueCookie('psOper');

	--Obtengo el numero de contrato del que se desea el reporte
	vsCntr := pk_objHtml.getValueCookie('psCntr');

	-- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
	tabColumna.EXTEND(vnColumnas);

	--Guardamos los encabezados en el arreglo de columnas
	tabColumna( 1) := 'Reprogramacion';
	tabColumna( 2) := 'Reprogramador';
	tabColumna( 3) := 'Fecha';
	tabColumna( 4) := 'Id';
	tabColumna( 5) := 'Nombre Alumno';
	tabColumna( 6) := 'Contrato';
	tabColumna( 7) := 'RUT Apoderado';
	tabColumna( 8) := 'Nombre Apoderado';
	tabColumna( 9) := 'Tipo de Repro.';
	tabColumna(10) := 'Monto Reprogramado';
	tabColumna(11) := 'Monto Beneficios, Rebajas y Abonos al Dia';
	tabColumna(12) := 'Monto Plan de Pagos';
	tabColumna(13) := 'Glosa';

	--Inicializamos contador de renglones
	vnRow := 0;

	FOR regReporte IN cuReporte(vdFechaIni, vdFechaFin, vsOper, vsCntr) LOOP

		--Incremento el contador de renglones
		vnRow := vnRow + 1;
		vnExists := 1; --Bandera para indicar que hubo resultados

		--Si es el primer renglon de cada pgina...
		IF MOD(vnRow, vnRegsPag) = 1  THEN
			--imprimo el encabezado de reporte
			Pk_Sisrepimp.P_EncabezadoDeReporte(
				psReclDesc ,vnColumnas ,tabColumna
				,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
			);
			vsInicoPag := 'SALTO';
		END IF;

		--Comienzo a desplegar el renglon
		HTP.P('<tr>');
		HTP.P('<td>'||regReporte.NumRepro||'</td>');
		HTP.P('<td>'||regReporte.UserRepro||'</td>');
		HTP.P('<td>'||TO_CHAR(regReporte.Fecha ,'DD/MM/YYYY')||'</td>');
		HTP.P('<td>'||regReporte.Id||'</td>');
		HTP.P('<td>'||regReporte.NombreAlumno||'</td>');
		HTP.P('<td>'||regReporte.NumCntr||'</td>');
		HTP.P('<td>'||regReporte.RutApo ||'</td>');
		HTP.P('<td>'||regReporte.NombreApoderado ||'</td>');
		HTP.P('<td>'||regReporte.TipoRepro ||'</td>');
		HTP.P('<td>'||TO_CHAR(regReporte.MontoRepr ,'999999999') ||'</td>');
		HTP.P('<td>'||TO_CHAR(regReporte.MontoDia ,'999999999') ||'</td>');
		HTP.P('<td>'||TO_CHAR(regReporte.MontoPlan ,'999999999') ||'</td>');
		HTP.P('<td>'||regReporte.Comentario ||'</td>');
		--Fin del renglon
		HTP.P('</tr>');

	END LOOP;

	IF vnExists = 0 THEN
		--Ojo esta linea lo que hace es imprimir
		--NO SE ENCONTRARON DATOS o un mensaje similar
		htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
	ELSE

		-- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
		Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

		-- es omitido el encabezado del reporte pero se agrega el salto de pagina
		Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
	END IF;

	--Fin de la pagina
	htp.p('</table><br/></body></html>');
EXCEPTION
	WHEN OTHERS THEN
		--pantallazo de error.
		pk_ObjHTML.p_ReporteError(sqlcode,replace(sqlerrm,'"','\"'),
			'PWRRPGL', NULL);
END PWRRPGL;
/


DROP PUBLIC SYNONYM PWRRPGL;

CREATE PUBLIC SYNONYM PWRRPGL FOR BANINST1.PWRRPGL;


GRANT EXECUTE ON BANINST1.PWRRPGL TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRRPGL TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRRPGL TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRRPGL TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRRUSU;

CREATE OR REPLACE PROCEDURE BANINST1.PWRRUSU(psReclDesc VARCHAR2) IS

/**************************************************************
           tarea:  procedimiento para el reporte de usuario por reportes
         mdulo:  auditora
           autor:  horacio martnez ramrez - hmr
           fecha:  14/sep/2010
**************************************************************/

  ckNombres    owa_cookie.vc_arr;
  ckValores    owa_cookie.vc_arr;
  ckCount      INTEGER;
  vgsInicoPag  VARCHAR2(10) := NULL;    -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vgsUSR       VARCHAR2(500);
  vnRow      INTEGER                := 0;
  vnColumnas INTEGER                := 5;
  vnExists   INTEGER                := 0;
  tabColumna PK_sisRepImp.tipoTabla := PK_sisRepImp.tipoTabla(1);
  vsUnive    VARCHAR2(4)            := NULL;
  vsUnive2   VARCHAR2(4)            := NULL;
  vsUserR    VARCHAR2(30)           := NULL;
  vsModul    VARCHAR2(5)            := NULL;
  vsRepor    VARCHAR2(20)           := NULL;
  vsSeccion  VARCHAR2(3)            := NULL;

  vsUsuario  VARCHAR2(30)           := NULL;
  vsModulo   VARCHAR2(300)          := NULL;
  vsInstan   VARCHAR2(30)           := NULL;
  vbEnca     BOOLEAN                := TRUE;
  vsEnca     VARCHAR2(1)            := NULL;

  CURSOR cuReporte( psUser  VARCHAR2 DEFAULT NULL,
                             psModl  VARCHAR2 DEFAULT NULL,
                             psRepr  VARCHAR2 DEFAULT NULL) IS
         SELECT SWRUSUR_USUARIO   Usuario,
                    SWBRECM_DESC      Modulo,
                    SWBRECL_DESC      Reporte
           FROM SWRUSUR,
                    SWBRECL,
                    SWBRECM
          WHERE SWBRECL_NOMBRE   = SWRUSUR_REPORT_NAME
              AND SWRUSUR_RECMCODE = SWBRECL_RECMCODE
              AND SWBRECM_CODE     = SWBRECL_RECMCODE
              AND (SWRUSUR_USUARIO   = psUser OR psUser IS NULL)
              AND (SWBRECM_CODE      = psModl OR psModl IS NULL)
              AND (SWBRECL_NOMBRE    = psRepr OR psRepr IS NULL)
           ORDER BY SWRUSUR_USUARIO,
                         SWBRECL_RECMCODE,
                         SWBRECL_DESC;

  BEGIN
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      -- son buscados los valores de las cookies para asignar los valores del filtro del query
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
          FOR vnCOKIES IN 1..ckCount LOOP
             IF ckNOMBRES(vnCOKIES) = 'psUserR' THEN
                   vsUserR := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psModul' THEN
                   vsModul := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psRepor' THEN
                   vsRepor := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psEnca' THEN
                   vsEnca := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                   vsSeccion := ckValores(vnCOKIES);

             END IF;
          END LOOP;
      END IF;

      vsSeccion := '6';

      -- las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
            tabColumna.EXTEND(vnI);
            tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1) := 'Usuario';
      tabColumna(2) := 'M&oacute;dulo';
      tabColumna(3) := 'Reporte';
      tabColumna(4) := 'Instancia';

      SELECT UNIQUE NAME
         INTO vsInstan
        FROM GV$DATABASE;

      FOR regRep IN cuReporte(vsUserR,vsModul,vsRepor) LOOP

          IF (vnRow = 0 OR vnRow = 25) AND vbEnca THEN

             Pk_Sisrepimp.P_EncabezadoDeReporte (psReclDesc, vnColumnas, tabColumna, vgsInicoPag, '1', psUsuario=>vgsUSR, psSeccion=>vsSeccion);

             vgsInicoPag := 'SALTO';
             vnRow := 0;
          END IF;

          IF vsEnca = 'N' THEN
              vbEnca := FALSE;
          END IF;

          IF vsUsuario IS NULL OR vsUsuario<>regRep.Usuario THEN
              vsUsuario := regRep.Usuario;
          ELSE
              vsUsuario := NULL;
          END IF;

          IF vsModulo IS NULL OR vsModulo<>regRep.Modulo THEN
              vsModulo := regRep.Modulo;
          ELSE
              vsModulo := NULL;
          END IF;

          htp.p('<tr><td width="20%" valign="top" align="left">'||vsUsuario||'</td>
                         <td width="30%" valign="top" align="left">'||vsModulo||'</td>
                         <td width="30%" valign="top" align="left">'||regRep.Reporte||'</td>
                         <td width="10%" valign="top" align="left">'||vsInstan||'</td></tr>');

          vsUsuario  := regRep.Usuario;
          vsModulo  := regRep.Modulo;
          vnExists   := 1;
          vnRow     := vnRow + 1;
      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||PK_sisRepImp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pgina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>vgsUSR, psSeccion=>vsSeccion);
      END IF;

      htp.p('</table><br/><br/></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           HTP.P(SQLERRM);

  END PWRRUSU;
/


DROP PUBLIC SYNONYM PWRRUSU;

CREATE PUBLIC SYNONYM PWRRUSU FOR BANINST1.PWRRUSU;


GRANT EXECUTE ON BANINST1.PWRRUSU TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRRUSU TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRSAAD;

CREATE OR REPLACE PROCEDURE BANINST1.PWRSAAD ( psReclDesc   VARCHAR2 ) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de sntesis de antecedentes
                acadmicos de docentes (planta y honorarios).
     propsito: obtener informacin en relacin a los grados acadmicos
                que tienen los docentes activos en un periodo determinado.
        mdulo: profesores - uft.
         autor: hmr - horacio martnez ramrez.
         fecha: 06/05/2011.

  modificacin: hmr - 27/05/2011.
                se ajust el query para obtener todos los docentes activos en
                el periodo selecionado y para determinar el periodo desde el
                cual pertenecen a uft.
*******************************************************************************/

  vnExists       INTEGER := 0;
  vnColumnas     INTEGER := 27;
  vgsInicioPag   VARCHAR2(30) := NULL;           -- bandera que al tener el valor "imprime", no colocar el salto de pgina para impresin
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vnIdRenglon    INTEGER := 1;
  vsTerm         SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsEscu         SIRDPCL.SIRDPCL_COLL_CODE%TYPE DEFAULT NULL;


  CURSOR cuReporte ( psTerm   VARCHAR2 DEFAULT NULL,
                     psEscu   VARCHAR2 DEFAULT NULL ) IS

         SELECT UPPER(PK_CATALOGO.COLEGIO(ESC_SEDE.CVE_ESCUELA))                    ESCUELA,
                F_GET_RUT(SP.SPRIDEN_PIDM)                                          RUT,
                SP.SPRIDEN_ID                                                       ID,
                UPPER(REPLACE(SP.SPRIDEN_LAST_NAME,'*',' * '))                      APELLIDOS,
                UPPER(REPLACE(SP.SPRIDEN_FIRST_NAME,'  ',' '))                      NOMBRES,
                TO_CHAR(TRUNC(SB.SPBPERS_BIRTH_DATE),'DD/MM/YYYY')                  FEC_NACIM,
                ( SELECT UPPER(STVCITZ_DESC)
                    FROM STVCITZ
                   WHERE STVCITZ_CODE = SB.SPBPERS_CITZ_CODE )                      NACIONALIDAD,
                ( SELECT NVL(MIN(SIBINST_TERM_CODE_EFF),'')
                    FROM SIBINST
                   WHERE SIBINST_TERM_CODE_EFF = (
                                        SELECT MAX(SIBINST_TERM_CODE_EFF)
                                          FROM SIBINST
                                         WHERE SIBINST_PIDM = SP.SPRIDEN_PIDM
                                           AND SIBINST_TERM_CODE_EFF <= psTerm) )   PERTENECE_UFT,
                ( SELECT UPPER(STVFSTP_DESC)
                    FROM STVFSTP
                   WHERE STVFSTP_CODE = ST.SIBINST_FSTP_CODE )                      TIPO_PERSONAL,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'LICENC', 'INSTITUCION')         INST_LICEN,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'LICENC', 'PAIS')                PAIS_LICEN,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'LICENC', 'FECHA')               FECHA_LICEN,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'TPROF', 'INSTITUCION')          INST_TPROF,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'TPROF', 'PAIS')                 PAIS_TPROF,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'TPROF', 'FECHA')                FECHA_TPROF,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'PTIT', 'INSTITUCION')           INST_PTIT,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'PTIT', 'PAIS')                  PAIS_PTIT,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'PTIT', 'FECHA')                 FECHA_PTIT,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'DIPLOM', 'INSTITUCION')         INST_DIPLOM,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'DIPLOM', 'PAIS')                PAIS_DIPLOM,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'DIPLOM', 'FECHA')               FECHA_DIPLOM,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'MAGIS', 'INSTITUCION')          INST_MAGIS,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'MAGIS', 'PAIS')                 PAIS_MAGIS,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'MAGIS', 'FECHA')                FECHA_MAGIS,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'DOCTOR', 'INSTITUCION')         INST_DOCTOR,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'DOCTOR', 'PAIS')                PAIS_DOCTOR,
                BANINST1.FWRCOLL (SP.SPRIDEN_PIDM, 'DOCTOR', 'FECHA')               FECHA_DOCTOR
           FROM SIBINST ST,
                SPRADDR SD,
                SPBPERS SB,
                SPRIDEN SP,
                ( SELECT SIRDPCL_PIDM      AS PIDM,
                         SIRDPCL_COLL_CODE AS CVE_ESCUELA,
                         SIRDPCL_DEPT_CODE AS DEPT_SEDE
                    FROM SIRDPCL A
                   WHERE SIRDPCL_HOME_IND = 'Y'
                     AND SIRDPCL_TERM_CODE_EFF = (SELECT MAX(SI.SIRDPCL_TERM_CODE_EFF)
                                                    FROM SIRDPCL SI
                                                   WHERE SI.SIRDPCL_PIDM = A.SIRDPCL_PIDM) ) ESC_SEDE
          WHERE ST.SIBINST_TERM_CODE_EFF = (SELECT MAX(SB.SIBINST_TERM_CODE_EFF)
                                              FROM SIBINST SB
                                             WHERE SB.SIBINST_PIDM = ST.SIBINST_PIDM
                                               AND SB.SIBINST_TERM_CODE_EFF <= psTerm)
            AND ST.SIBINST_FCST_CODE  = 'AC'
            AND ST.SIBINST_PIDM       = SD.SPRADDR_PIDM(+)
            AND SD.SPRADDR_STATUS_IND IS NULL
            AND ST.SIBINST_PIDM       = SB.SPBPERS_PIDM(+)
            AND ST.SIBINST_PIDM       = ESC_SEDE.PIDM(+)
            AND ST.SIBINST_PIDM       = SP.SPRIDEN_PIDM
            AND SPRIDEN_CHANGE_IND    IS NULL
            AND (ESC_SEDE.CVE_ESCUELA = psEscu OR psEscu IS NULL)
          ORDER BY ESCUELA, APELLIDOS;

  BEGIN

     -- valida que el usuario tenga acceso a la base de datos:
     IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

     -- obtiene los valores de las cookies para asignar los valores del filtro del query:
     vsTerm := pk_ObjHtml.getValueCookie('psTerm');
     vsEscu := pk_ObjHtml.getValueCookie('psEscu');

     -- determina el largo de la tabla:
     FOR vnI IN 1..vnColumnas LOOP
         tabColumna.EXTEND(vnI);
         tabColumna(vnI) := NULL;
     END LOOP;

     tabColumna(1)  := '<center> Escuela';
     tabColumna(2)  := '<center> RUT';
     tabColumna(3)  := '<center> ID';
     tabColumna(4)  := '<center> Apellidos';
     tabColumna(5)  := '<center> Nombres';
     tabColumna(6)  := '<center> Fecha <br>de nacimiento';
     tabColumna(7)  := '<center> Nacionalidad';
     tabColumna(8)  := '<center> Pertenece<br>a UFT desde';
     tabColumna(9)  := '<center> Tipo <br>de <br>Personal';
     tabColumna(10) := '<center> LICENCIATURA<br>Institucin <br>Ttulo /<br>Licenciatura';
     tabColumna(11) := '<center> LICENCIATURA<br>Pas <br>donde lo obtuvo';
     tabColumna(12) := '<center> LICENCIATURA<br>Fecha <br>en que lo obtuvo';
     tabColumna(13) := '<center> TTULO PROFESIONAL<br>Institucin <br>Ttulo /<br>Licenciatura';
     tabColumna(14) := '<center> TTULO PROFESIONAL<br>Pas <br>donde lo obtuvo';
     tabColumna(15) := '<center> TTULO PROFESIONAL<br>Fecha <br>en que lo obtuvo';
     tabColumna(16) := '<center> POSTTULO<br>Institucin <br>Ttulo /<br>Licenciatura';
     tabColumna(17) := '<center> POSTTULO<br>Pas <br>donde lo obtuvo';
     tabColumna(18) := '<center> POSTTULO<br>Fecha <br>en que lo obtuvo';
     tabColumna(19) := '<center> DIPLOMA<br>Institucin <br>Ttulo /<br>Licenciatura';
     tabColumna(20) := '<center> DIPLOMA<br>Pas <br>donde lo obtuvo';
     tabColumna(21) := '<center> DIPLOMA<br>Fecha <br>en que lo obtuvo';
     tabColumna(22) := '<center> MAGISTER<br>Institucin <br>Ttulo /<br>Licenciatura';
     tabColumna(23) := '<center> MAGISTER<br>Pas <br>donde lo obtuvo';
     tabColumna(24) := '<center> MAGISTER<br>Fecha <br>en que lo obtuvo';
     tabColumna(25) := '<center> DOCTORADO<br>Institucin <br>Ttulo /<br>Licenciatura';
     tabColumna(26) := '<center> DOCTORADO<br>Pas <br>donde lo obtuvo';
     tabColumna(27) := '<center> DOCTORADO<br>Fecha <br>en que lo obtuvo';

     FOR regRep IN cuReporte (vsTerm, vsEscu) LOOP

         IF vnExists = 0 THEN

            -- muestra el encabezado segn la escuela seleccionada:
            IF vsEscu IS NOT NULL THEN
               Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||', &nbsp&nbsp&nbsp'||'Escuela: '||vsEscu||' - '||Pk_Catalogo.Colegio(vsEscu), psUniversidad=>'UFT');
            ELSE
               Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||', &nbsp&nbsp&nbsp'||'Escuela: '||'Todas', psUniversidad=>'UFT');
            END IF;

         END IF;

         HTP.P('<tr> <td valign="top" align="left">'   ||regRep.ESCUELA       ||'</td>
                     <td valign="top" align="left">'   ||regRep.RUT           ||'</td>
                     <td valign="top" align="center">' ||regRep.ID            ||'</td>
                     <td valign="top" align="left">'   ||regRep.APELLIDOS     ||'</td>
                     <td valign="top" align="left">'   ||regRep.NOMBRES       ||'</td>
                     <td valign="top" align="center">' ||regRep.FEC_NACIM     ||'</td>
                     <td valign="top" align="left">'   ||regRep.NACIONALIDAD  ||'</td>
                     <td valign="top" align="center">' ||regRep.PERTENECE_UFT ||'</td>
                     <td valign="top" align="left">'   ||regRep.TIPO_PERSONAL ||'</td>
                     <td valign="top" align="left">'   ||regRep.INST_LICEN    ||'</td>
                     <td valign="top" align="left">'   ||regRep.PAIS_LICEN    ||'</td>
                     <td valign="top" align="center">' ||regRep.FECHA_LICEN   ||'</td>
                     <td valign="top" align="left">'   ||regRep.INST_TPROF    ||'</td>
                     <td valign="top" align="left">'   ||regRep.PAIS_TPROF    ||'</td>
                     <td valign="top" align="center">' ||regRep.FECHA_TPROF   ||'</td>
                     <td valign="top" align="left">'   ||regRep.INST_PTIT     ||'</td>
                     <td valign="top" align="left">'   ||regRep.PAIS_PTIT     ||'</td>
                     <td valign="top" align="center">' ||regRep.FECHA_PTIT    ||'</td>
                     <td valign="top" align="left">'   ||regRep.INST_DIPLOM   ||'</td>
                     <td valign="top" align="left">'   ||regRep.PAIS_DIPLOM   ||'</td>
                     <td valign="top" align="center">' ||regRep.FECHA_DIPLOM  ||'</td>
                     <td valign="top" align="left">'   ||regRep.INST_MAGIS    ||'</td>
                     <td valign="top" align="left">'   ||regRep.PAIS_MAGIS    ||'</td>
                     <td valign="top" align="center">' ||regRep.FECHA_MAGIS   ||'</td>
                     <td valign="top" align="left">'   ||regRep.INST_DOCTOR   ||'</td>
                     <td valign="top" align="left">'   ||regRep.PAIS_DOCTOR   ||'</td>
                     <td valign="top" align="center">' ||regRep.FECHA_DOCTOR  ||'</td>
               </tr>');

         vnExists    := 1;
         vnIdRenglon := vnIdRenglon + 1;

     END LOOP;

     IF vnExists = 0 THEN
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
     ELSE
        -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- omite el encabezado del reporte pero se agrega el salto de pgina:
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR);
     END IF;

     htp.p('</table><br/></body></html>');

  EXCEPTION
     WHEN OTHERS THEN
          htp.p(SQLERRM);

  END PWRSAAD;
/


DROP PUBLIC SYNONYM PWRSAAD;

CREATE PUBLIC SYNONYM PWRSAAD FOR BANINST1.PWRSAAD;


GRANT EXECUTE ON BANINST1.PWRSAAD TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRSAAD TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRSACD;

CREATE OR REPLACE PROCEDURE BANINST1.PWRSACD(psReclDesc VARCHAR2) IS

/*
         Tarea: REPORTE: Reporte Situacin Academica
         Fecha: 28/02/2011.
         Autor: MAC


*/

  vnRow         INTEGER                            := 0;
  vnRows        INTEGER                            := 0;
  vnExists      INTEGER                            := 0;
  vnColumnas    INTEGER                            := 19;
  vnReprobadas  INTEGER                            := 0;
  vnMatRep      INTEGER                            := 0;
  tabColumna    Pk_Sisrepimp.tipoTabla             := Pk_Sisrepimp.tipoTabla(1);
  tabSubColu    Pk_Sisrepimp.tipoTabla             := Pk_Sisrepimp.tipoTabla(1);
  tabPeriodo    Pk_Sisrepimp.tipoTabla             := Pk_Sisrepimp.tipoTabla(1);
  vsPerio       SIBINST.SIBINST_TERM_CODE_EFF%TYPE := NULL;
  vsUniv        VARCHAR2(20)                       := NULL;
  vsEscu        SGBSTDN.SGBSTDN_PROGRAM_1%TYPE  := NULL;
  vsSeccion     VARCHAR2(3)                        := NULL;
  vsTermCode    VARCHAR2(6)                        := NULL;
  vsCampCode    VARCHAR2(6)                        := NULL;
  vsRateCode    VARCHAR2(10)                       := NULL;
  vsNrc         VARCHAR2(4000)                     := NULL;
  vsID          VARCHAR2(20)                       := NULL;
  vsNivel       VARCHAR2(2)                        := NULL;
  vsPromshat    SHRTGPA.SHRTGPA_GPA%TYPE           := NULL;
  vsEstandar    STVASTD.STVASTD_DESC%TYPE          := NULL;
  vsSobEstandar STVASTD.STVASTD_DESC%TYPE          := NULL;
  vsSubj        VARCHAR2(6)                        := NULL;
  vsCrse        VARCHAR2(6)                        := NULL;
  vsEnca        VARCHAR2(2)                        := NULL;
  vsPtrm        VARCHAR2(2)                        := NULL;
  vsSede        VARCHAR2(10)                       := NULL;
  vsNextTerm    VARCHAR2(6)                        := NULL;
  vsTermAnt     VARCHAR2(6)                        := NULL;
  vsInicoPag    VARCHAR2(10)                       := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
  vbEnca        BOOLEAN                            := TRUE;

  TYPE reg_Reprobadas IS RECORD(rTerm   SHRTCKN.SHRTCKN_TERM_CODE%TYPE,
                                rCrn    SHRTCKN.SHRTCKN_CRN%TYPE,
                                rSubj   SHRTCKN.SHRTCKN_SUBJ_CODE%TYPE,
                                rCrse   SHRTCKN.SHRTCKN_CRSE_NUMB%TYPE,
                                rTitle  SHRTCKN.SHRTCKN_CRSE_TITLE%TYPE,
                                rCarga  VARCHAR2(10),
                                rLimite INTEGER,
                                rCalifi VARCHAR2(10)
                               );

  TYPE tableReprobadas IS TABLE OF reg_Reprobadas INDEX BY BINARY_INTEGER;

  tabRepr tableReprobadas;

  CURSOR cuReporte(psPerio VARCHAR2 DEFAULT NULL,
                   psUniv  VARCHAR2 DEFAULT NULL,
                   psEscu VARCHAR2 DEFAULT NULL
                  ) IS
         WITH
            QRY_TEM AS(SELECT TEM.SGBSTDN_TERM_CODE_EFF,
            TEM.SGBSTDN_PIDM
            FROM SGBSTDN TEM
            )
         SELECT SSBSECT_TERM_CODE                             termCode,
                SSBSECT_CAMP_CODE                             campCode,
                A.SGBSTDN_LEVL_CODE                           NIVEL,
                A.SGBSTDN_PROGRAM_1                           CVEPROGRAMA,
                PK_CATALOGO.PROGRAMA(A.SGBSTDN_PROGRAM_1)     DESCPROGRAMA,
                f_get_rut(A.SGBSTDN_PIDM)                     RUT,
                SPRIDEN_ID                                    ID,
                A.SGBSTDN_PIDM                                PIDM,
                SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME    NOMBRE,
                A.SGBSTDN_STST_CODE                           CVESTATUS,
                PK_CATALOGO.STASTST(A.SGBSTDN_STST_CODE)      DESCSTATUS,
                NVL(SGBSTDN_RATE_CODE,'sin Sede')             rateCode,
                COUNT(SSBSECT_CRN)                            MATERIAS
           FROM SGBSTDN A,
                SSBSECT,
                SPRIDEN,
                SFRSTCR
          WHERE SPRIDEN_CHANGE_IND     IS NULL
            AND SGBSTDN_PIDM            = SPRIDEN_PIDM
            AND A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(B.SGBSTDN_TERM_CODE_EFF)
                                                        FROM QRY_TEM B
                                                        WHERE B.SGBSTDN_PIDM= A.SGBSTDN_PIDM
                                                            AND B.SGBSTDN_TERM_CODE_EFF <= SSBSECT_TERM_CODE)
            AND EXISTS (SELECT NULL
                          FROM SWVHIAC A
                         WHERE SWVHIAC_PIDM                = SPRIDEN_PIDM
                           AND SWVHIAC_PASSED_IND          = 'N'
                           AND (SWVHIAC_CALIF = 'OU' OR SWVHIAC_CALIF = 'AD' OR SWVHIAC_CALIF = 'P' OR (SWVHIAC_QUALITY_POINTS >= 3 AND SWVHIAC_QUALITY_POINTS < 4))
                           AND NVL(SWVHIAC_CREDIT_HOURS,0) > 0
                           /*AND NOT EXISTS (SELECT NULL
                                             FROM SWVHIAC T
                                            WHERE T.SWVHIAC_PIDM       = A.SWVHIAC_PIDM
                                              AND T.SWVHIAC_LEVL_CODE  = A.SWVHIAC_LEVL_CODE
                                              AND T.SWVHIAC_CRSE       = A.SWVHIAC_CRSE
                                              AND T.SWVHIAC_SUBJ       = A.SWVHIAC_SUBJ
                                              AND T.SWVHIAC_LEVL_CODE  = A.SWVHIAC_LEVL_CODE
                                              AND T.SWVHIAC_PASSED_IND = 'Y'
                                          )*/
                       )
            AND SFRSTCR_PIDM       = SGBSTDN_PIDM
            AND SFRSTCR_CRN        = SSBSECT_CRN
            AND SFRSTCR_TERM_CODE  = SSBSECT_TERM_CODE
            --AND SFRSTCR_PIDM = 4815
            AND SFRSTCR_RSTS_CODE IN ('RE','RW')
            AND (SSBSECT_TERM_CODE   = psPerio OR psPerio IS NULL)
            AND (SSBSECT_CAMP_CODE   = psUniv  OR psUniv  IS NULL)
            AND (A.SGBSTDN_COLL_CODE_1 = psEscu OR psEscu IS NULL)
          GROUP BY SSBSECT_TERM_CODE,
                   SSBSECT_CAMP_CODE,
                   A.SGBSTDN_LEVL_CODE,
                   A.SGBSTDN_PROGRAM_1,
                   SPRIDEN_ID,
                   A.SGBSTDN_PIDM,
                   A.SGBSTDN_STST_CODE,
                   A.SGBSTDN_TERM_CODE_EFF,
                   SPRIDEN_LAST_NAME||' '||SPRIDEN_FIRST_NAME,
                   SGBSTDN_RATE_CODE
          ORDER BY termCode DESC, rateCode, DESCPROGRAMA, NOMBRE;

   -- Obtiene las materias reprobadas
   CURSOR cuMateriasReprobadas(pPidm  VARCHAR2,
                               pNivel VARCHAR2) IS
          SELECT SHRTCKN_TERM_CODE     TERM,
                 SHRTCKN_CRN           CRN,
                 SHRTCKN_SUBJ_CODE     SUBJ,
                 SHRTCKN_CRSE_NUMB     CRSE,
                 SHRTCKN_CRSE_TITLE    MATERIA,
                 SFBETRM_MHRS_OVER CARGA,
                 (SELECT MAX(COUNT(SWVHIAC_CALIF)) MatOcup
                    FROM SWVHIAC A
                   WHERE SWVHIAC_PIDM                = pPidm
                     AND SWVHIAC_PASSED_IND          = 'N'
                     AND (SWVHIAC_CALIF = 'OU' OR SWVHIAC_CALIF = 'AD' OR SWVHIAC_CALIF = 'P' OR (SWVHIAC_QUALITY_POINTS < 4))
                     AND SWVHIAC_CALIF <> 'AC'
                     AND NVL(SWVHIAC_CREDIT_HOURS,0) > 0
                     AND SWVHIAC_CRSE                = SHRTCKN_CRSE_NUMB
                     AND SWVHIAC_SUBJ                = SHRTCKN_SUBJ_CODE
                     AND SWVHIAC_LEVL_CODE           = pNivel
                    /* AND NOT EXISTS (SELECT NULL
                                       FROM SWVHIAC T
                                      WHERE T.SWVHIAC_PIDM       = A.SWVHIAC_PIDM
                                        AND T.SWVHIAC_LEVL_CODE  = A.SWVHIAC_LEVL_CODE
                                        AND T.SWVHIAC_CRSE       = A.SWVHIAC_CRSE
                                        AND T.SWVHIAC_SUBJ       = A.SWVHIAC_SUBJ
                                        AND T.SWVHIAC_LEVL_CODE  = A.SWVHIAC_LEVL_CODE
                                        AND T.SWVHIAC_PASSED_IND = 'Y'
                                    )*/
                   GROUP BY A.SWVHIAC_CRSE, A.SWVHIAC_SUBJ
                  HAVING COUNT(SWVHIAC_CALIF) > 0
                 ) LIMITE,
                 NVL((SELECT max(SWVHIAC_CALIF)
                        FROM SWVHIAC A
                       WHERE SWVHIAC_PIDM                = pPidm
                         AND SWVHIAC_PASSED_IND          = 'N'
                         AND (SWVHIAC_CALIF = 'OU' OR SWVHIAC_CALIF = 'AD' OR SWVHIAC_CALIF = 'P' OR (SWVHIAC_QUALITY_POINTS < 4))
                         AND SWVHIAC_CALIF <> 'AC'
                         AND NVL(SWVHIAC_CREDIT_HOURS,0) > 0
                         AND SWVHIAC_CRSE                = SHRTCKN_CRSE_NUMB
                         AND SWVHIAC_SUBJ                = SHRTCKN_SUBJ_CODE
                         AND SWVHIAC_TERM_CODE           = SHRTCKN_TERM_CODE
                         AND SWVHIAC_LEVL_CODE           = pNivel
                        /* AND NOT EXISTS (SELECT NULL
                                           FROM SWVHIAC T
                                          WHERE T.SWVHIAC_PIDM       = A.SWVHIAC_PIDM
                                            AND T.SWVHIAC_LEVL_CODE  = A.SWVHIAC_LEVL_CODE
                                            AND T.SWVHIAC_CRSE       = A.SWVHIAC_CRSE
                                            AND T.SWVHIAC_SUBJ       = A.SWVHIAC_SUBJ
                                            AND T.SWVHIAC_LEVL_CODE  = A.SWVHIAC_LEVL_CODE
                                            AND T.SWVHIAC_PASSED_IND = 'Y'
                                        )*/
                     ),0) Calificacion
            FROM SHRTCKN,
                 SFBETRM
           WHERE SHRTCKN_TERM_CODE       = SFBETRM_TERM_CODE(+)
             AND SHRTCKN_PIDM            = SFBETRM_PIDM(+)
             AND EXISTS (SELECT NULL
                           FROM SWVHIAC A
                          WHERE SWVHIAC_PIDM                = pPidm
                            AND SWVHIAC_SUBJ                = SHRTCKN_SUBJ_CODE
                            AND SWVHIAC_CRSE                = SHRTCKN_CRSE_NUMB
                            AND SWVHIAC_TERM_CODE           = SHRTCKN_TERM_CODE
                            AND SWVHIAC_PASSED_IND          = 'N'
                            AND (SWVHIAC_CALIF = 'OU' OR SWVHIAC_CALIF = 'AD' OR SWVHIAC_CALIF = 'P' OR (SWVHIAC_QUALITY_POINTS < 4))
                            AND SWVHIAC_CALIF <> 'AC'
                            AND NVL(SWVHIAC_CREDIT_HOURS,0) > 0
                            AND SWVHIAC_LEVL_CODE           = pNivel
                           /* AND NOT EXISTS (SELECT NULL
                                              FROM SWVHIAC T
                                             WHERE T.SWVHIAC_PIDM       = A.SWVHIAC_PIDM
                                               AND T.SWVHIAC_LEVL_CODE  = A.SWVHIAC_LEVL_CODE
                                               AND T.SWVHIAC_CRSE       = A.SWVHIAC_CRSE
                                               AND T.SWVHIAC_SUBJ       = A.SWVHIAC_SUBJ
                                               AND T.SWVHIAC_LEVL_CODE  = A.SWVHIAC_LEVL_CODE
                                               AND T.SWVHIAC_PASSED_IND = 'Y'
                                           )*/
                        )
             AND SHRTCKN_PIDM = pPidm
           ORDER BY SUBJ, CRSE, SHRTCKN_TERM_CODE DESC;

  --Promedio de acuerdo al periodo que le pasan como parametro
  CURSOR cuPROMSHAT(psNivel VARCHAR2,
                    pnPidm  NUMBER,
                    psTerm  VARCHAR2) IS
         SELECT A.SHRTGPA_PIDM             PIDM,
                A.SHRTGPA_TERM_CODE     PERIODO,
                ROUND(SHRTGPA_GPA, 2)             PROMEDIO
           FROM SHRTGPA A
          WHERE A.SHRTGPA_TERM_CODE    = psTerm
            AND A.SHRTGPA_GPA_TYPE_IND = 'I'
            AND A.SHRTGPA_LEVL_CODE    = psNivel
            AND A.SHRTGPA_PIDM         = pnPidm;

  BEGIN
      /* Check/update the user's web session */
      IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      vsPerio   := pk_ObjHtml.getValueCookie('psPerio');
      vsUniv    := pk_ObjHtml.getValueCookie('psUnive');
      vsEscu   := pk_ObjHtml.getValueCookie('psEscu');
      vsSeccion := pk_ObjHtml.getValueCookie('cookSeccion');


      -- las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
          tabSubColu.EXTEND(vnI);
          tabSubColu(vnI) := NULL;
      END LOOP;

      tabSubColu(1)  := 'Programa';
      tabSubColu(2)  := 'Descripci&oacute;n';
      tabSubColu(3)  := 'ID';
      tabSubColu(4)  := 'Nombre';
      tabSubColu(5)  := 'RUT';
      tabSubColu(6)  := 'Status del alumno';
      tabSubColu(7)  := 'Promedio ponderado del periodo';
      tabSubColu(8)  := 'Promedio ponderado del periodo anterior';
      tabSubColu(9)  := 'Est&aacute;ndar acad&eacute;mico';
      tabSubColu(10)  := 'Sobrepaso Est&aacute;ndar acad&eacute;mico';
      tabSubColu(11) := 'Materias reprobadas y OU (en HA)';
      tabSubColu(12)  := 'Materias reprobadas y OU';






      FOR regRep IN cuReporte(vsPerio, vsUniv, vsEscu) LOOP
          vsPromshat    := NULL;
          vnReprobadas  := 0;
          vnMatRep      := 0;
          vsSubj        := NULL;
          vsCrse        := NULL;
          vsEstandar    := NULL;
          vsSobEstandar := NULL;
          vsNextTerm    := NULL;

          --QUERY PARA DETERMINAR EL PERIDO ANTERIOR SEMESTRAL
          SELECT (CASE
                  WHEN SUBSTR(regRep.termCode,5,2) = '75' THEN
                       TO_CHAR(TO_NUMBER(SUBSTR(regRep.termCode,1,4) + 1))||'25'
                  WHEN SUBSTR(regRep.termCode,5,2) = '25' THEN
                       SUBSTR(regRep.termCode,1,4)||'75'
                 END
                 )
            INTO vsNextTerm
            FROM DUAL;

            select MAX(SHRTGPA_TERM_CODE) INTO vsTermAnt FROM SHRTGPA
            WHERE SHRTGPA_PIDM = regRep.pidm
            AND SHRTGPA_TERM_CODE < vsPerio;



          FOR regRepa IN cuPROMSHAT (regRep.Nivel, regRep.Pidm,regRep.termCode) LOOP
              vsPromshat := regRepa.Promedio;
          END LOOP;

          --Estado acadmico
          vsEstandar    := F_EstandarAdemico(regRep.Pidm, regRep.termCode);

          --Sobrepaso Estado acadmico
          vsSobEstandar := F_SobrepasoEstandarAdemico(regRep.Pidm, vsNextTerm);

          --materias reprobadas
          FOR regDat IN cuMateriasReprobadas(regRep.Pidm,regRep.NIVEL) LOOP
              vnReprobadas := 1 + vnReprobadas;

              tabRepr(vnReprobadas).rTerm   := regDat.TERM;
              tabRepr(vnReprobadas).rCrn    := regDat.Crn;
              tabRepr(vnReprobadas).rSubj   := regDat.Subj;
              tabRepr(vnReprobadas).rCrse   := regDat.Crse;
              tabRepr(vnReprobadas).rTitle  := regDat.Materia;
              tabRepr(vnReprobadas).rCarga  := regDat.Carga;
              tabRepr(vnReprobadas).rLimite := regDat.Limite;
              tabRepr(vnReprobadas).rCalifi := regDat.Calificacion;

              IF vsSubj IS NULL OR (vsSubj||vsCrse<>regDat.Subj||regDat.Crse) THEN
                 vnMatRep := vnMatRep + 1;
              END IF;

              vsSubj := regDat.Subj;
              vsCrse := regDat.Crse;
          END LOOP;

          vnRows := 1;

          -- las instrucciones determinan el contenido de la tabla
          FOR vnI IN 1..8 LOOP
              tabPeriodo.EXTEND(vnI);
              tabPeriodo(vnI) := NULL;

              vnRows := vnRows - 1;
          END LOOP;

          tabPeriodo(1) := 'NRC';
          tabPeriodo(2) := 'Materia';
          tabPeriodo(3) := 'Curso';
          tabPeriodo(4) := 'Titulo materia';
          tabPeriodo(5) := 'Carga acad&eacute;mica permitida';
          tabPeriodo(6) := 'N&uacute;mero de oportunidades utilizadas';
          tabPeriodo(7) := 'Periodo';
          tabPeriodo(8) := 'Calificaci&oacute;n';

          vnRows := 0;

          IF (vsTermCode IS NULL OR vsTermCode <> regRep.termCode OR
              vsCampCode IS NULL OR vsCampCode <> regRep.campCode OR
              vsRateCode IS NULL OR vsRateCode <> regRep.rateCode OR
              vnRow = 10) AND vbEnca THEN

              Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicoPag,'1',psSubtitulo=>'Periodo '||regRep.termCode,psUsuario=>pk_login.vgsUSR,psSeccion=>vsSeccion,psUniversidad=>regRep.campCode);
              vsInicoPag := 'SALTO';

              -- Titulos principales
              htp.p('<tr bgcolor="#efefef">');

              FOR vnI IN 1..12 LOOP
                  IF    vnI IN (2,4) THEN
                        htp.p('<th valign="bottom" align="left" width="12%" rowspan="2">'||tabSubColu(vnI)||'</th>');
                  ELSIF vnI IN (5,8) THEN
                        htp.p('<th valign="bottom" align="left" width="4.5%" rowspan="2">'||tabSubColu(vnI)||'</th>');
                  ELSIF vnI IN (12) THEN
                        htp.p('<th valign="bottom" colspan="8">'||tabSubColu(vnI)||'</th>');
                  ELSE
                        htp.p('<th valign="bottom" align="left" width="7.5%" rowspan="2">'||tabSubColu(vnI)||'</th>');
                  END IF;
              END LOOP;

              -- Titulos secundarios
              htp.p('</tr><tr bgcolor="#efefef">');
              FOR vnI IN 1..1 LOOP
                  FOR vnJ IN 1..8 LOOP
                      IF vnJ IN (4) THEN
                         htp.p('<th width="12%">'||tabPeriodo(vnJ)||'</th>');
                      ELSE
                         htp.p('<th width="5%">'||tabPeriodo(vnJ)||'</th>');
                      END IF;
                  END LOOP;
              END LOOP;

              htp.p('</tr>');

              vnRow := 0;
          END IF;

          IF vsEnca = 'N' THEN
             vbEnca := FALSE;
          END IF;

          htp.p('<tr>
          <td valign="top" rowspan="'||vnReprobadas||'">'||regRep.CvePrograma ||'</td>
          <td valign="top" rowspan="'||vnReprobadas||'">'||regRep.DescPrograma||'</td>
          <td valign="top" rowspan="'||vnReprobadas||'">'||regRep.ID          ||'</td>
          <td valign="top" rowspan="'||vnReprobadas||'">'||regRep.Nombre      ||'</td>
          <td valign="top" rowspan="'||vnReprobadas||'">'||regRep.RUT         ||'</td>
          <td valign="top" rowspan="'||vnReprobadas||'">'||regRep.DescStatus  ||'</td>
          <td valign="top" rowspan="'||vnReprobadas||'">'||vsPromshat         ||'</td>
          <td valign="top" rowspan="'||vnReprobadas||'">'||FWAPRTG(regRep.Pidm, vsTermAnt,'G', regRep.Nivel)||'</td>
          <td valign="top" rowspan="'||vnReprobadas||'">'||vsEstandar         ||'</td>
          <td valign="top" rowspan="'||vnReprobadas||'">'||vsSobEstandar      ||'</td>
          <td valign="top" rowspan="'||vnReprobadas||'">'||vnMatRep           ||'</td>'
          );

          FOR vnI IN 1..vnReprobadas LOOP
              htp.p(
              '<td valign="top" align="center">'||tabRepr(vnI).rCrn   ||'</td>
               <td valign="top" align="center">'||tabRepr(vnI).rSubj  ||'</td>
               <td valign="top" align="center">'||tabRepr(vnI).rCrse  ||'</td>
               <td valign="top" align="left">'  ||tabRepr(vnI).rTitle ||'</td>
               <td valign="top" align="center">'||tabRepr(vnI).rCarga ||'</td>
               <td valign="top" align="center">'||tabRepr(vnI).rLimite||'</td>
               <td valign="top" align="center">'||tabRepr(vnI).rTerm  ||'</td>
               <td valign="top" align="center">'||tabRepr(vnI).rCalifi||'</td>
              </tr>'
              );
          END LOOP;

          IF vnReprobadas = 0 THEN
             htp.p('<td colspan="8"></td></tr>');
          END IF;

          vnExists   := 1;
          vnRow      := vnRow + 1;
          vsTermCode := regRep.termCode;
          vsCampCode := regRep.campCode;
          vsRateCode := regRep.rateCode;
      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      ELSE
         -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

         -- es omitido el encabezado del reporte pero se agrega el salto de pagina
         Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR, psSeccion=>vsSeccion);
      END IF;

      htp.p('</table><br><br></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           HTP.P(SQLERRM);

  END PWRSACD;
/


DROP PUBLIC SYNONYM PWRSACD;

CREATE PUBLIC SYNONYM PWRSACD FOR BANINST1.PWRSACD;


GRANT EXECUTE ON BANINST1.PWRSACD TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRSACD TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRSAEM;

CREATE OR REPLACE PROCEDURE BANINST1.PWRSAEM(psReclDesc VARCHAR2) IS

/*
         Tarea: REPORTE DE SALONES CON EMPALME
        Modulo: Programacin academica
         Fecha: 19/01/2006.
         Autor: GEPC

  Modificacin: 07/11/2008
                AMR
                * Verificar el parametro Periodo pues no funciona


                07/05/2009
                GEPC
                     Problema: Te comento que an no ha quedado resuelto el problema de empalmes
                               de salones entre campus UAX y UAP ya que compartimos descripciones
                               iguales de los edificios y salones.
                               Emit el reporte de salones con empalme, tom el CRN 30078 de la UAP y el
                               CRN 40119 de la UAX, elimin el saln 2203 que ambos tenan
                               registrados, lo elimin del CRN 40119 y lo volv a cargar
                               pero  me sigue causando conflicto. Adjunto la pantalla para su revisin.
                     SOLUCION: FUE AGREGADO EL FILTRO "psUnive" en el cursor "cu2Reporte"


*/
vgsUSR          VARCHAR2(500);
ckCount         INTEGER;
ckNombres       owa_cookie.vc_arr;
ckValores       owa_cookie.vc_arr;
vgsInicioPag    VARCHAR2(10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion

  vnExists        INTEGER                          := 0;
  vnColumnas      INTEGER                          := 21;
  tabColumna      Pk_Sisrepimp.tipoTabla           := Pk_Sisrepimp.tipoTabla(1);
  vsPerio         VARCHAR2(100)                    := NULL;
  vsFacu          VARCHAR2(100)                    := NULL;
  vsSeccion       VARCHAR2(3)                      := NULL;

  CURSOR cuReporte(psTerm     VARCHAR2 DEFAULT NULL,
                   psFacu     VARCHAR2 DEFAULT NULL  ) IS
         SELECT SE.SSBSECT_TERM_CODE                                PERIODO,
                NVL(SSBSECT_CAMP_CODE,'S/Univ')                     UNIVERSIDAD,
                Pk_Catalogo.COLEGIO(SCBCRSE_COLL_CODE)              ESCUELA,
                SSRMEET_BLDG_CODE                                   EDIFICIO,
                SSRMEET_ROOM_CODE                                   SALON,
                SSBSECT_CRN                                         NRC,
                SCBCRSE_SUBJ_CODE                                   MATERIA,
                SCBCRSE_CRSE_NUMB                                   CURSO,
                SCBCRSE_TITLE                                       NOMBRE,
                SSBSECT_PTRM_CODE||' '||SSBSECT_PTRM_START_DATE||' '||SSBSECT_PTRM_END_DATE||' '||SSBSECT_PTRM_WEEKS PARPER,
                DECODE(SSRMEET_MON_DAY, 'M', 'Lu', SSRMEET_MON_DAY) LU,
                DECODE(SSRMEET_TUE_DAY, 'T', 'Ma', SSRMEET_TUE_DAY) MA,
                DECODE(SSRMEET_WED_DAY, 'W', 'Mi', SSRMEET_WED_DAY) MI,
                DECODE(SSRMEET_THU_DAY, 'R', 'Ju', SSRMEET_THU_DAY) JU,
                DECODE(SSRMEET_FRI_DAY, 'F', 'Vi', SSRMEET_FRI_DAY) VI,
                DECODE(SSRMEET_SAT_DAY, 'S', 'Sa', SSRMEET_SAT_DAY) SA,
                DECODE(SSRMEET_SUN_DAY, 'U', 'Do', SSRMEET_SUN_DAY) DI,
                SUBSTR(SSRMEET_BEGIN_TIME,1,2)||':'||
                NVL(SUBSTR(SSRMEET_BEGIN_TIME,3,2),'00')            Inicio,
                SUBSTR(SSRMEET_END_TIME,1,2)||':'||
                NVL(SUBSTR(SSRMEET_END_TIME,3,2),'00')              Fin,
                SSRXLST_XLST_GROUP                                  LISTA_CRUZADA,
                DECODE(SWRXLST_TYPE,'M','Master','S','Simultneo','Independiente') TIPO_LISTA,
                Pk_Catalogo.STATUS_1(SSBSECT_SSTS_CODE)             STATUS,
                NULL AS EMPALME
           FROM SSBSECT SE,
                SCBCRSE,
                SSRMEET SR,
                SWRXLST,
                SSRXLST
          WHERE SCBCRSE_EFF_TERM  = (SELECT MAX(SCBCRSE_EFF_TERM)
                                       FROM SCBCRSE A
                                      WHERE A.SCBCRSE_EFF_TERM  <= SE.SSBSECT_TERM_CODE
                                        AND A.SCBCRSE_SUBJ_CODE  = SE.SSBSECT_SUBJ_CODE
                                        AND A.SCBCRSE_CRSE_NUMB  = SE.SSBSECT_CRSE_NUMB)
            AND EXISTS (SELECT SS.SSRMEET_CRN
                          FROM SSBSECT SB,
                               SSRMEET SS
                          WHERE SS.SSRMEET_CRN       <> SR.SSRMEET_CRN
                            AND SS.SSRMEET_TERM_CODE  = SR.SSRMEET_TERM_CODE
                            AND SB.SSBSECT_CRN        = SS.SSRMEET_CRN
                            AND SB.SSBSECT_TERM_CODE  = SS.SSRMEET_TERM_CODE
                            AND (SS.SSRMEET_MON_DAY   = SR.SSRMEET_MON_DAY OR
                                 SS.SSRMEET_SUN_DAY   = SR.SSRMEET_SUN_DAY OR
                                 SS.SSRMEET_TUE_DAY   = SR.SSRMEET_TUE_DAY OR
                                 SS.SSRMEET_WED_DAY   = SR.SSRMEET_WED_DAY OR
                                 SS.SSRMEET_THU_DAY   = SR.SSRMEET_THU_DAY OR
                                 SS.SSRMEET_FRI_DAY   = SR.SSRMEET_FRI_DAY OR
                                 SS.SSRMEET_SAT_DAY   = SR.SSRMEET_SAT_DAY)
                             AND SS.SSRMEET_ROOM_CODE  = SR.SSRMEET_ROOM_CODE
                             AND (SS.SSRMEET_START_DATE BETWEEN SR.SSRMEET_START_DATE AND SR.SSRMEET_END_DATE OR
                                  SS.SSRMEET_END_DATE BETWEEN SR.SSRMEET_START_DATE AND SR.SSRMEET_END_DATE)
                             AND (SS.SSRMEET_BEGIN_TIME BETWEEN SR.SSRMEET_BEGIN_TIME AND SR.SSRMEET_END_TIME OR
                                  SS.SSRMEET_END_TIME BETWEEN SR.SSRMEET_BEGIN_TIME AND SR.SSRMEET_END_TIME)
                              AND SS.SSRMEET_BLDG_CODE  = SR.SSRMEET_BLDG_CODE)
            AND SSBSECT_SUBJ_CODE = SCBCRSE_SUBJ_CODE
            AND SSBSECT_CRSE_NUMB = SCBCRSE_CRSE_NUMB
            AND SSBSECT_TERM_CODE = SSRMEET_TERM_CODE
            AND SSBSECT_CRN       = SSRMEET_CRN
            AND SSBSECT_TERM_CODE = SSRXLST_TERM_CODE(+)
            AND SSBSECT_CRN       = SSRXLST_CRN(+)
            AND SSRXLST_TERM_CODE = SWRXLST_TERM_CODE(+)
            AND SSRXLST_CRN       = SWRXLST_CRN(+)
            AND SSRXLST_XLST_GROUP = SWRXLST_XLST_GROUP(+)
            AND NOT EXISTS (SELECT NULL
                              FROM SWRXLST
                             WHERE SWRXLST_TERM_CODE = SSBSECT_TERM_CODE
                               AND SWRXLST_CRN       = SSBSECT_CRN
                               AND SWRXLST_TYPE      = 'S')
            AND (INSTR(psTerm,SSBSECT_TERM_CODE) > 0 OR psTerm IS NULL)
            AND (SCBCRSE_COLL_CODE   = psFacu  OR psFacu IS NULL)
          ORDER BY PERIODO DESC, UNIVERSIDAD, ESCUELA, NOMBRE;

  /* CURSOR QUE VERIFICA QUE CLASE NO SE EMPALME CON OTRAS */
  CURSOR cu2Reporte (psTerCod VARCHAR2,
                     psCrn    VARCHAR2) IS
         SELECT DISTINCT A.SSRMEET_CRN CRN_EMPALME
           FROM SSRMEET A, (SELECT SSRMEET_TERM_CODE,
                                   SSBSECT_CRN,
                                   SSRMEET_START_DATE,
                                   SSRMEET_END_DATE,
                                   SSRMEET_SUN_DAY,
                                   SSRMEET_MON_DAY,
                                   SSRMEET_TUE_DAY,
                                   SSRMEET_WED_DAY,
                                   SSRMEET_THU_DAY,
                                   SSRMEET_FRI_DAY,
                                   SSRMEET_SAT_DAY,
                                   SSRMEET_BEGIN_TIME,
                                   SSRMEET_END_TIME,
                                   SSRMEET_ROOM_CODE,
                                   SSRMEET_BLDG_CODE,
                                   SSBSECT_CAMP_CODE
                              FROM SSBSECT, SSRMEET
                             WHERE SSBSECT_TERM_CODE = psTerCod
                               AND SSBSECT_CRN       = psCrn
                               AND SSRMEET_TERM_CODE = SSBSECT_TERM_CODE
                               AND SSRMEET_CRN       = SSBSECT_CRN
                           ) B
          WHERE A.SSRMEET_TERM_CODE = B.SSRMEET_TERM_CODE
            AND A.SSRMEET_CRN NOT IN B.SSBSECT_CRN
            AND NOT EXISTS (SELECT NULL
                              FROM SWRXLST
                             WHERE SWRXLST_TERM_CODE = A.SSRMEET_TERM_CODE
                               AND SWRXLST_CRN       = A.SSRMEET_CRN
                               AND SWRXLST_TYPE      = 'S')
            AND (A.SSRMEET_MON_DAY   = B.SSRMEET_MON_DAY OR
                 A.SSRMEET_SUN_DAY   = B.SSRMEET_SUN_DAY OR
                 A.SSRMEET_TUE_DAY   = B.SSRMEET_TUE_DAY OR
                 A.SSRMEET_WED_DAY   = B.SSRMEET_WED_DAY OR
                 A.SSRMEET_THU_DAY   = B.SSRMEET_THU_DAY OR
                 A.SSRMEET_FRI_DAY   = B.SSRMEET_FRI_DAY OR
                 A.SSRMEET_SAT_DAY   = B.SSRMEET_SAT_DAY)
            AND A.SSRMEET_ROOM_CODE  = B.SSRMEET_ROOM_CODE
            AND (A.SSRMEET_START_DATE BETWEEN B.SSRMEET_START_DATE AND B.SSRMEET_END_DATE OR
                 A.SSRMEET_END_DATE BETWEEN B.SSRMEET_START_DATE AND B.SSRMEET_END_DATE)
            AND (A.SSRMEET_BEGIN_TIME BETWEEN B.SSRMEET_BEGIN_TIME AND B.SSRMEET_END_TIME OR
                 A.SSRMEET_END_TIME BETWEEN B.SSRMEET_BEGIN_TIME AND B.SSRMEET_END_TIME)
            AND A.SSRMEET_BLDG_CODE = B.SSRMEET_BLDG_CODE
            AND EXISTS (SELECT NULL
                          FROM SSBSECT C
                         WHERE C.SSBSECT_TERM_CODE = A.SSRMEET_TERM_CODE
                           AND C.SSBSECT_CRN       = A.SSRMEET_CRN

                       );

  BEGIN
      /* Check/update the user's web session */
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);


      IF ckCount != 0 THEN
         FOR vnCOKIES IN 1..ckCount LOOP

             IF ckNOMBRES(vnCOKIES) = 'psPeriM' THEN
                 vsPerio := ckValores(vnCOKIES);
             ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                 vsFacu := ckValores(vnCOKIES);
             ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                 vsSeccion := ckValores(vnCOKIES);
             END IF;
         END LOOP;
      END IF;

    -- Las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := 'Periodo';
      tabColumna(2)  := 'Escuela';
      tabColumna(3)  := 'Edificio';
      tabColumna(4)  := 'Saln';
      tabColumna(5)  := 'NRC';
      tabColumna(6)  := 'Materia';
      tabColumna(7)  := 'Curso';
      tabColumna(8)  := 'Nombre materia';
      tabColumna(9)  := 'Parte Periodo';
      tabColumna(10) := 'Lu';
      tabColumna(11) := 'Ma';
      tabColumna(12) := 'Mi';
      tabColumna(13) := 'Ju';
      tabColumna(14) := 'Vi';
      tabColumna(15) := 'Sa';
      tabColumna(16) := 'Hora inicio';
      tabColumna(17) := 'Hora fin';
      tabColumna(18) := 'Lista cruzada';
      tabColumna(19) := 'Tipo de curso';
      tabColumna(20) := 'Status';
      tabColumna(21) := 'NRC empalme';

      FOR regRep IN cuReporte(vsPerio, vsFacu) LOOP
          IF vnExists = 0 THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,vgsInicioPag,'1',psSubtitulo=>'Periodo '||regRep.Periodo,psUsuario=>vgsUSR,psSeccion=>vsSeccion, psSinLogo=>'sin');
             vgsInicioPag := 'SALTO';
          END IF;

          htp.p('<tr>
          <td valign="top" align="left">'  ||regRep.Periodo ||'</td>
          <td valign="top" align="left">'  ||regRep.Escuela ||'</td>
          <td valign="top" align="left">'  ||regRep.Edificio||'</td>
          <td valign="top" align="left">'  ||regRep.Salon   ||'</td>
          <td valign="top" align="left">'  ||regRep.NRC     ||'</td>
          <td valign="top" align="left">'  ||regRep.Materia ||'</td>
          <td valign="top" align="left">'  ||regRep.Curso   ||'</td>
          <td valign="top" align="left">'  ||regRep.Nombre  ||'</td>
          <td valign="top" align="left">'  ||regRep.ParPer  ||'</td>
          <td valign="top" align="center">'||regRep.Lu      ||'</td>
          <td valign="top" align="center">'||regRep.Ma      ||'</td>
          <td valign="top" align="center">'||regRep.Mi      ||'</td>
          <td valign="top" align="center">'||regRep.Ju      ||'</td>
          <td valign="top" align="center">'||regRep.Vi      ||'</td>
          <td valign="top" align="center">'||regRep.Sa      ||'</td>
          <td valign="top" align="center">'||regRep.Inicio       ||'</td>
          <td valign="top" align="center">'||regRep.Fin          ||'</td>
          <td valign="top" align="left">'  ||regRep.Lista_cruzada||'</td>
          <td valign="top" align="left">'  ||regRep.Tipo_lista   ||'</td>
          <td valign="top" align="left">'  ||regRep.Status       ||'</td>
          <td valign="top" align="left">');

          FOR regEmp IN cu2Reporte (regRep.periodo,regRep.nrc) LOOP
              htp.p(regEmp.CRN_EMPALME || '<br>');
          END LOOP;

          htp.p('</td></tr>');

          vnExists := 1;

      END LOOP;

      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      END IF;

      htp.p('</table><br/></body></html>');

  EXCEPTION
      WHEN OTHERS THEN
           htp.p( SQLERRM);
  END PWRSAEM;
/


DROP PUBLIC SYNONYM PWRSAEM;

CREATE PUBLIC SYNONYM PWRSAEM FOR BANINST1.PWRSAEM;


GRANT EXECUTE ON BANINST1.PWRSAEM TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRSAEM TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRSCAE;

CREATE OR REPLACE PROCEDURE BANINST1.PWRSCAE(psReclDesc   VARCHAR2) IS

/******************************************************************************
   NAME:       PWRSCAE
   PURPOSE: Ejecutar reporte Postulantes Superiores CAE

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        17/12/2013   AGM       1. Created this procedure.

   NOTES:
      Object Name:     PWRSCAE
      Date and Time:   17/12/2013, 01:26:50 p.m., and 17/12/2013 01:26:50 p.m.

******************************************************************************/
    --Numero de renglones
    vnRow                PLS_INTEGER := 0;
    --Bandera para mostrar si hubo datos
    vnExists            INTEGER := 0;
    --Numero de columnas
    vnColumnas            INTEGER := 6;
    --Numero de registros
    vnRegs                INTEGER := 0;
    --Arreglo (nested table) donde se guardan los encabezados de las columnas
    tabColumna            Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla();
    -- la variable es una bandera que al tener el valor "imprime" no colocara
    --el salto de pgina para impresion
    vsInicoPag            VARCHAR2(10) := NULL;
    --Nmero de renglones por pgina
    vnRegsPag            PLS_INTEGER := 100;

    --Filtro de Fecha
    vdFecha                DATE;

    --Perodo de busqueda
    vsPeriodo VARCHAR2(30) := NULL;

    CURSOR cuReporte(
        psPerio VARCHAR2  DEFAULT NULL
    ) IS
        SELECT DISTINCT
            SPBPERS_PIDM PIDM,
            TWBPCAS_RUT||'-'||TWBPCAS_RUT_DV RUT,
            TWBPCAS_LAST_NAME_FATH,
            TWBPCAS_LAST_NAME_MOTH,
            TWBPCAS_FIRST_NAME,
            TWBPCAS_NOMBRE_IES_RESPALDO
        FROM TWBPCAS, SGBSTDN, SPBPERS
        WHERE SPBPERS_NAME_SUFFIX = TWBPCAS_RUT||'-'||TWBPCAS_RUT_DV
        AND SGBSTDN_PIDM = SPBPERS_PIDM
        AND TWBPCAS_YEAR = SUBSTR(psPerio,1,4);

BEGIN

    --Seguridad de GWAMNUR
    IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

    --Obtengo la fecha del reporte
    vdFecha := TO_DATE(SYSDATE,'DD/MM/YYYY');

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsPeriodo   := pk_objHtml.getValueCookie('psPerio');
--    htp.p('<br>');
--    htp.p('vsPeriodo:'||vsPeriodo);

    -- Redimensiono el arreglo (tabla anidada) de encabezados de columnas
    tabColumna.EXTEND(vnColumnas);

    --Guardamos los encabezados en el arreglo de columnas
    tabColumna( 1) := '<center> PIDM';
    tabColumna( 2) := '<center> RUT';
    tabColumna( 3) := '<center> Paterno';
    tabColumna( 4) := '<center> Materno';
    tabColumna( 5) := '<center> Nombre';
    tabColumna( 6) := '<center> Respaldo';
--    tabColumna( 7) := 'Cargados';
--    tabColumna( 8) := 'No Cargados';

    --Inicializamos contador de renglones
    vnRow := 0;

    FOR regReporte IN cuReporte(vsPeriodo) LOOP

        --Incremento el contador de renglones
        vnRow := vnRow + 1;
        vnExists := 1; --Bandera para indicar que hubo resultados

        --Si es el primer renglon de cada pgina...
        IF MOD(vnRow, vnRegsPag) = 1  THEN
            --imprimo el encabezado de reporte
            Pk_Sisrepimp.P_EncabezadoDeReporte(
                psReclDesc ,vnColumnas ,tabColumna
                ,vsInicoPag ,'1' ,psUsuario=>pk_login.vgsUSR
            );
            vsInicoPag := 'SALTO';
        END IF;

        --Comienzo a desplegar el renglon
        HTP.P('<tr>');
        HTP.P('<td align=center>'||regReporte.PIDM||'</td>');
        HTP.P('<td align=center>'||regReporte.RUT||'</td>');
        HTP.P('<td>'||regReporte.TWBPCAS_LAST_NAME_FATH||'</td>');
        HTP.P('<td>'||regReporte.TWBPCAS_LAST_NAME_MOTH||'</td>');
        HTP.P('<td>'||regReporte.TWBPCAS_FIRST_NAME||'</td>');
        HTP.P('<td>'||regReporte.TWBPCAS_NOMBRE_IES_RESPALDO||'</td>');
--        HTP.P('<td>'||regReporte.NumOk ||'</td>');
--        HTP.P('<td>'||regReporte.NumErr ||'</td>');
        --Fin del renglon
        HTP.P('</tr>');

    END LOOP;

    IF vnExists = 0 THEN
        --Ojo esta linea lo que hace es imprimir
        --NO SE ENCONTRARON DATOS o un mensaje similar
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
    ELSE

        -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pagina
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
    END IF;

    --Fin de la pagina
    htp.p('</table><br/></body></html>');
   EXCEPTION
     WHEN NO_DATA_FOUND THEN
       NULL;
     WHEN OTHERS THEN
       -- Consider logging the error and then re-raise
       RAISE;
END PWRSCAE;
/


DROP PUBLIC SYNONYM PWRSCAE;

CREATE PUBLIC SYNONYM PWRSCAE FOR BANINST1.PWRSCAE;


GRANT EXECUTE ON BANINST1.PWRSCAE TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRSCCA;

CREATE OR REPLACE PROCEDURE BANINST1.PWRSCCA (psReclDesc   VARCHAR2)  IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de seguimiento de call
                center.
     propsito: obtener informacin de postulantes para que el call center
                pueda dar seguimiento al proceso de admisin.
                se generan dos reportes diferentes pero muy similares.
        mdulo: admisiones - uft.
         autor: hmr - horacio martnez ramrez.
         fecha: 24/06/2011.
*******************************************************************************/

  vnExists      INTEGER := 0;
  vnColumnas    INTEGER := 9;
  vgsInicioPag  VARCHAR2(30) := NULL;           -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  tabColumna    Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vnIdRenglon   INTEGER := 1;
  vsTerm        SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsProgr       SARADAP.SARADAP_PROGRAM_1%TYPE DEFAULT NULL;
  csParam       CONSTANT  VARCHAR2(7) := 'psDatCo';
  vsDatCont     VARCHAR2(50) := NULL;
  vnDato        INTEGER      := 0;

  CURSOR cuReporte ( psTerm   VARCHAR2  DEFAULT NULL,
                     psProgr  VARCHAR2  DEFAULT NULL ) IS

         SELECT DISTINCT(F_GET_RUT(SP.SPRIDEN_PIDM))                                                   RUT,
                UPPER(REPLACE(REPLACE(REPLACE(LTRIM(RTRIM(
                      SP.SPRIDEN_LAST_NAME,' '),' '),'*',' * '),'   ',' '),'  ',' '))                  APELLIDOS,
                UPPER(REPLACE(REPLACE(LTRIM(RTRIM(
                     (SP.SPRIDEN_FIRST_NAME||' '||SP.SPRIDEN_MI),' '),' '),'   ',' '),'  ',' '))       NOMBRE,
                SA.SARADAP_APPL_PREFERENCE                                                             PREFERENCIA,
                F_PONDERADO (SA.SARADAP_PIDM, SA.SARADAP_PROGRAM_1)                                    PUNT_UFT,
                UPPER(Pk_Catalogo.ResAdmi(
                       (SELECT DISTINCT(SARAPPD_APDC_CODE)
                          FROM SARAPPD A
                         WHERE A.SARAPPD_PIDM = SA.SARADAP_PIDM
                           AND A.SARAPPD_TERM_CODE_ENTRY = SA.SARADAP_TERM_CODE_ENTRY
                           AND A.SARAPPD_APPL_NO = SA.SARADAP_APPL_NO
                           AND A.SARAPPD_SEQ_NO = (
                                          SELECT MAX(SARAPPD_SEQ_NO)
                                            FROM SARAPPD
                                           WHERE SARAPPD_PIDM = A.SARAPPD_PIDM
                                             AND SARAPPD_APPL_NO = (
                                                           SELECT MAX(SARAPPD_APPL_NO)
                                                             FROM SARAPPD
                                                            WHERE SARAPPD_PIDM = A.SARAPPD_PIDM) ) ))) DECISION,
                UPPER(PK_CATALOGO.PREPARATORIA(CH.SORHSCH_SBGI_CODE))                                  COLEGIO,
                F_BECAAUT (SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1)                              BECA_AUT,
                F_BECACOL (SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1)                              BECA_COL,
                ( SELECT DECODE(LE.SPRTELE_PHONE_AREA, NULL, '', '('||LE.SPRTELE_PHONE_AREA||') ' )||
                         LE.SPRTELE_PHONE_NUMBER||
                         DECODE( LE.SPRTELE_PHONE_EXT, NULL, '', (' EXT. '||LE.SPRTELE_PHONE_EXT) )
                    FROM SPRTELE LE
                   WHERE LE.SPRTELE_SEQNO = (SELECT MAX(SPRTELE_SEQNO) FROM SPRTELE
                                              WHERE SPRTELE_TELE_CODE = 'TFPA'
                                                AND LE.SPRTELE_PIDM = SPRTELE_PIDM
                                                AND LE.SPRTELE_SEQNO = SPRTELE_SEQNO)
                     AND SP.SPRIDEN_PIDM = LE.SPRTELE_PIDM
                     AND ROWNUM = 1 )                                                                  TEL_FIJO,
                ( SELECT '('||NVL(LE.SPRTELE_PHONE_AREA,' 0 ')||') '||LE.SPRTELE_PHONE_NUMBER
                    FROM SPRTELE LE
                   WHERE LE.SPRTELE_SEQNO = (SELECT MIN(SPRTELE_SEQNO)
                                               FROM SPRTELE
                                              WHERE SPRTELE_TELE_CODE = 'TMPA'
                                                AND LE.SPRTELE_PIDM = SPRTELE_PIDM
                                                AND LE.SPRTELE_SEQNO = SPRTELE_SEQNO)
                    AND SP.SPRIDEN_PIDM = LE.SPRTELE_PIDM
                    AND ROWNUM = 1 )                                                                   TEL_MOVIL,
                BANINST1.PK_DESCRIPCIONES.F_GETMAIL (SP.SPRIDEN_PIDM)                                  E_MAIL
           FROM SPRIDEN  SP,
                SARADAP  SA,
                SORHSCH  CH,
                SWBEPSU  SU,
                SPBPERS  SB,
                SGBSTDN  DN
          WHERE SP.SPRIDEN_CHANGE_IND IS NULL
            AND SP.SPRIDEN_PIDM = SA.SARADAP_PIDM
            AND SA.SARADAP_ADMT_CODE = 'AD'
            AND DN.SGBSTDN_PIDM NOT IN ( SELECT DISTINCT(TR.TWBCNTR_PIDM)
                                           FROM TWBCNTR TR
                                          WHERE TR.TWBCNTR_PIDM = SA.SARADAP_PIDM
                                            AND TR.TWBCNTR_STATUS_IND = 'A'
                                            AND TR.TWBCNTR_TERM_CODE = psTerm
                                            AND TR.TWBCNTR_ACTIVITY_DATE = (SELECT MAX(TWBCNTR_ACTIVITY_DATE)
                                                                              FROM TWBCNTR
                                                                             WHERE TWBCNTR_PIDM = TR.TWBCNTR_PIDM)
                                            and not exists (select 1
                                            from twbretr
                                            where twbretr_cntr_num = twbcntr_num))
            AND (SELECT DISTINCT(SARAPPD_APDC_CODE)
                          FROM SARAPPD A
                         WHERE A.SARAPPD_PIDM = SA.SARADAP_PIDM
                           AND A.SARAPPD_TERM_CODE_ENTRY = SA.SARADAP_TERM_CODE_ENTRY
                           AND A.SARAPPD_APPL_NO = SA.SARADAP_APPL_NO
                           AND A.SARAPPD_SEQ_NO = (
                                          SELECT MAX(SARAPPD_SEQ_NO)
                                            FROM SARAPPD
                                           WHERE SARAPPD_PIDM = A.SARAPPD_PIDM
                                             AND SARAPPD_APPL_NO = (
                                                           SELECT MAX(SARAPPD_APPL_NO)
                                                             FROM SARAPPD
                                                            WHERE SARAPPD_PIDM = A.SARAPPD_PIDM))) = 'AC'
            AND SA.SARADAP_PIDM = CH.SORHSCH_PIDM(+)
            AND SA.SARADAP_PIDM = SB.SPBPERS_PIDM(+)
            AND SA.SARADAP_TERM_CODE_ENTRY = psTerm
            AND SA.SARADAP_PIDM = DN.SGBSTDN_PIDM(+)
            AND (SA.SARADAP_PROGRAM_1 = psProgr OR psProgr IS NULL)
            AND SB.SPBPERS_NAME_SUFFIX = SU.SWBEPSU_RUT(+)
          ORDER BY PREFERENCIA, APELLIDOS;


---------------------------------------------------
-- bloque principal para la generacin del reporte
---------------------------------------------------
BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
   vsProgr := pk_ObjHtml.getValueCookie('psProgr');
   vnDato  := pk_objHtml.getValueCookie('psDatCo');

   -- obtiene el valor del parmetro de datos de contacto:
   BEGIN
      SELECT GWBTIPO_DESC
        INTO vsDatCont
        FROM GWBTIPO
       WHERE GWBTIPO_CODE = csParam
         AND TO_NUMBER(GWBTIPO_TYPE) = vnDato;

   EXCEPTION
      WHEN OTHERS THEN NULL;

   END;

   -- valida el tipo de reporte que ejecutar:
   IF vsDatCont IS NULL THEN

      -- determina el largo de la tabla:
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      -- define los encabezados de columnas:
      tabColumna(1)  := '<center> RUT';
      tabColumna(2)  := '<center> Apellidos';
      tabColumna(3)  := '<center> Nombre';
      tabColumna(4)  := '<center> Preferencia';
      tabColumna(5)  := '<center> Punt. UFT<br>(C&aacute;lculo<br>ponderado)';
      tabColumna(6)  := '<center> Decisi&oacute;n';
      tabColumna(7)  := '<center> Colegio';
      tabColumna(8)  := '<center> % Beca<br>autom&aacute;tica<br>PSU';
      tabColumna(9)  := '<center> % Beca<br>colegio<br>origen';

      -- manipula la informacin obtenida por el cursor:
      FOR regRep IN cuReporte (vsTerm, vsProgr) LOOP

          IF vnExists = 0 THEN
             -- muestra el encabezado segn el programa seleccionado:
             IF vsProgr IS NOT NULL THEN
                Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||' - '||Pk_Catalogo.Periodo(vsTerm)||'<br>'||'Programa: '||vsProgr||' - '||Pk_Catalogo.Programa(vsProgr), psUniversidad=>'UFT');
             ELSE
                Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||' - '||Pk_Catalogo.Periodo(vsTerm)||'<br>'||'Programa: '||'Todos', psUniversidad=>'UFT');
             END IF;
          END IF;

          -- despliega los valores para cada registro:
          htp.p('<tr> <td valign="top" align="left">'   ||regRep.RUT          ||'</td>
                      <td valign="top" align="left">'   ||regRep.APELLIDOS    ||'</td>
                      <td valign="top" align="left">'   ||regRep.NOMBRE       ||'</td>
                      <td valign="top" align="center">' ||regrep.PREFERENCIA  ||'</td>
                      <td valign="top" align="center">' ||regrep.PUNT_UFT     ||'</td>
                      <td valign="top" align="left">'   ||regrep.DECISION     ||'</td>
                      <td valign="top" align="left">'   ||regrep.COLEGIO      ||'</td>
                      <td valign="top" align="center">' ||regrep.BECA_AUT     ||'</td>
                      <td valign="top" align="center">' ||regrep.BECA_COL     ||'</td>
                </tr>');

          vnExists    := 1;
          vnIdRenglon := vnIdRenglon + 1;

      END LOOP;

   ELSE
      vnColumnas := 12;

      -- determina el largo de la tabla:
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      -- define los encabezados de las columnas:
      tabColumna(1)  := '<center> RUT';
      tabColumna(2)  := '<center> Apellidos';
      tabColumna(3)  := '<center> Nombre';
      tabColumna(4)  := '<center> Preferencia';
      tabColumna(5)  := '<center> Punt. UFT<br>(Clculo<br>ponderado)';
      tabColumna(6)  := '<center> Decisi&oacute;n';
      tabColumna(7)  := '<center> Colegio';
      tabColumna(8)  := '<center> % Beca<br>autom&aacute;tica<br>PSU';
      tabColumna(9)  := '<center> % Beca<br>colegio<br>origen';
      tabColumna(10) := '<center> TFPA<br>(Tel&eacute;fono Fijo<br>Particular)';
      tabColumna(11) := '<center> TMPA<br>(Tel&eacute;fono M&oacute;vil<br>Particular)';
      tabColumna(12) := '<center> Correo electr&oacute;nico';

      -- manipula la informacin obtenida por el cursor:
      FOR regRep IN cuReporte (vsTerm, vsProgr) LOOP

          IF vnExists = 0 THEN
             -- muestra el encabezado segn el programa seleccionado:
             IF vsProgr IS NOT NULL THEN
                Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc||' (Datos de contacto)', vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||' - '||Pk_Catalogo.Periodo(vsTerm)||'<br>'||'Programa: '||vsProgr||' - '||Pk_Catalogo.Programa(vsProgr), psUniversidad=>'UFT');
             ELSE
                Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc||' (Datos de contacto)', vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||' - '||Pk_Catalogo.Periodo(vsTerm)||'<br>'||'Programa: '||'Todos', psUniversidad=>'UFT');
             END IF;
          END IF;

          -- despliega los valores para cada registro:
          htp.p('<tr> <td valign="top" align="left">'   ||regRep.RUT          ||'</td>
                      <td valign="top" align="left">'   ||regRep.APELLIDOS    ||'</td>
                      <td valign="top" align="left">'   ||regRep.NOMBRE       ||'</td>
                      <td valign="top" align="center">' ||regrep.PREFERENCIA  ||'</td>
                      <td valign="top" align="center">' ||regrep.PUNT_UFT     ||'</td>
                      <td valign="top" align="left">'   ||regrep.DECISION     ||'</td>
                      <td valign="top" align="left">'   ||regrep.COLEGIO      ||'</td>
                      <td valign="top" align="center">' ||regrep.BECA_AUT     ||'</td>
                      <td valign="top" align="center">' ||regrep.BECA_COL     ||'</td>
                      <td valign="top" align="center">' ||regrep.TEL_FIJO     ||'</td>
                      <td valign="top" align="center">' ||regrep.TEL_MOVIL    ||'</td>
                      <td valign="top" align="left">'   ||regrep.E_MAIL       ||'</td>
                </tr>');

          vnExists    := 1;
          vnIdRenglon := vnIdRenglon + 1;

      END LOOP;

   END IF;


   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- es omitido el encabezado del reporte pero se agrega el salto de pgina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRSCCA;
/


DROP PUBLIC SYNONYM PWRSCCA;

CREATE PUBLIC SYNONYM PWRSCCA FOR BANINST1.PWRSCCA;


GRANT EXECUTE ON BANINST1.PWRSCCA TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRSCCA TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRSCCP;

CREATE OR REPLACE PROCEDURE BANINST1.PWRSCCP (psReclDesc   VARCHAR2)  IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de seguimiento de call
                center - postulantes presenciales.
     propsito: obtener informacin de los postulantes presenciales para que
                el call center pueda dar seguimiento al proceso de admisin.
        mdulo: admisiones - uft.
         autor: hmr - horacio martnez ramrez.
         fecha: 24/06/2011.
*******************************************************************************/

  vnExists      INTEGER := 0;
  vnColumnas    INTEGER := 12;
  vgsInicioPag  VARCHAR2(30) := NULL;           -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  tabColumna    Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vnIdRenglon   INTEGER := 1;
  vsTerm        SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsProgr       SARADAP.SARADAP_PROGRAM_1%TYPE DEFAULT NULL;

  CURSOR cuReporte ( psTerm   VARCHAR2  DEFAULT NULL,
                     psProgr  VARCHAR2  DEFAULT NULL ) IS

         SELECT DISTINCT(F_GET_RUT(SP.SPRIDEN_PIDM))                                                   RUT,
                UPPER(REPLACE(REPLACE(REPLACE(LTRIM(RTRIM(
                      SP.SPRIDEN_LAST_NAME,' '),' '),'*',' * '),'   ',' '),'  ',' '))                  APELLIDOS,
                UPPER(REPLACE(REPLACE(LTRIM(RTRIM(
                     (SP.SPRIDEN_FIRST_NAME||' '||SP.SPRIDEN_MI),' '),' '),'   ',' '),'  ',' '))       NOMBRE,
                SA.SARADAP_APPL_PREFERENCE                                                             PREFERENCIA,
                F_PONDERADO (SA.SARADAP_PIDM, SA.SARADAP_PROGRAM_1)                                    PUNT_UFT,
                UPPER(Pk_Catalogo.ResAdmi(
                       (SELECT DISTINCT(SARAPPD_APDC_CODE)
                          FROM SARAPPD A
                         WHERE A.SARAPPD_PIDM = SA.SARADAP_PIDM
                           AND A.SARAPPD_TERM_CODE_ENTRY = SA.SARADAP_TERM_CODE_ENTRY
                           AND A.SARAPPD_APPL_NO = SA.SARADAP_APPL_NO
                           AND A.SARAPPD_SEQ_NO = (
                                          SELECT MAX(SARAPPD_SEQ_NO)
                                            FROM SARAPPD
                                           WHERE SARAPPD_PIDM = A.SARAPPD_PIDM
                                             AND SARAPPD_APPL_NO = (
                                                           SELECT MAX(SARAPPD_APPL_NO)
                                                             FROM SARAPPD
                                                            WHERE SARAPPD_PIDM = A.SARAPPD_PIDM) ) ))) DECISION,
                UPPER(PK_CATALOGO.PREPARATORIA(CH.SORHSCH_SBGI_CODE))                                  COLEGIO,
                F_BECAAUT (SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1)                              BECA_AUT,
                F_BECACOL (SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1)                              BECA_COL,
                (SELECT DECODE(LE.SPRTELE_PHONE_AREA, NULL, '', '('||LE.SPRTELE_PHONE_AREA||') ' )||
                        LE.SPRTELE_PHONE_NUMBER||
                        DECODE( LE.SPRTELE_PHONE_EXT, NULL, '', (' EXT. '||LE.SPRTELE_PHONE_EXT) )
                   FROM SPRTELE LE
                  WHERE LE.SPRTELE_SEQNO = (SELECT MAX(SPRTELE_SEQNO) FROM SPRTELE
                                             WHERE SPRTELE_TELE_CODE = 'TFPA'
                                               AND LE.SPRTELE_PIDM = SPRTELE_PIDM
                                               AND LE.SPRTELE_SEQNO = SPRTELE_SEQNO)
                    AND SP.SPRIDEN_PIDM = LE.SPRTELE_PIDM
                    AND ROWNUM = 1 )                                                                   TEL_FIJO,
                (SELECT '('||NVL(LE.SPRTELE_PHONE_AREA,' 0 ')||') '||LE.SPRTELE_PHONE_NUMBER
                   FROM SPRTELE LE
                  WHERE LE.SPRTELE_SEQNO = (SELECT MIN(SPRTELE_SEQNO) FROM SPRTELE
                                             WHERE SPRTELE_TELE_CODE = 'TMPA'
                                               AND LE.SPRTELE_PIDM = SPRTELE_PIDM
                                               AND LE.SPRTELE_SEQNO = SPRTELE_SEQNO)
                    AND SP.SPRIDEN_PIDM = LE.SPRTELE_PIDM
                    AND ROWNUM = 1 )                                                                   TEL_MOVIL,
                BANINST1.PK_DESCRIPCIONES.F_GETMAIL (SP.SPRIDEN_PIDM)                                  E_MAIL
           FROM SPRIDEN  SP,
                SARADAP  SA,
                SORHSCH  CH,
                SWBEPSU  SU,
                SPBPERS  SB,
                SGBSTDN  DN
          WHERE SP.SPRIDEN_CHANGE_IND IS NULL
            AND SP.SPRIDEN_PIDM = SA.SARADAP_PIDM
            AND SA.SARADAP_ADMT_CODE = 'AD'
            AND DN.SGBSTDN_PIDM NOT IN ( SELECT DISTINCT(TR.TWBCNTR_PIDM)
                                           FROM TWBCNTR TR
                                          WHERE TR.TWBCNTR_PIDM = SA.SARADAP_PIDM
                                            AND TR.TWBCNTR_STATUS_IND = 'A'
                                            AND TR.TWBCNTR_TERM_CODE = psTerm
                                            AND TR.TWBCNTR_ACTIVITY_DATE = (SELECT MAX(TWBCNTR_ACTIVITY_DATE)
                                                                              FROM TWBCNTR
                                                                             WHERE TWBCNTR_PIDM = TR.TWBCNTR_PIDM)
                                            and not exists (select 1
                                            from twbretr
                                            where twbretr_cntr_num = twbcntr_num))
            AND (SELECT DISTINCT(SARAPPD_APDC_CODE)
                          FROM SARAPPD A
                         WHERE A.SARAPPD_PIDM = SA.SARADAP_PIDM
                           AND A.SARAPPD_TERM_CODE_ENTRY = SA.SARADAP_TERM_CODE_ENTRY
                           AND A.SARAPPD_APPL_NO = SA.SARADAP_APPL_NO
                           AND A.SARAPPD_SEQ_NO = (
                                          SELECT MAX(SARAPPD_SEQ_NO)
                                            FROM SARAPPD
                                           WHERE SARAPPD_PIDM = A.SARAPPD_PIDM
                                             AND SARAPPD_APPL_NO = (
                                                           SELECT MAX(SARAPPD_APPL_NO)
                                                             FROM SARAPPD
                                                            WHERE SARAPPD_PIDM = A.SARAPPD_PIDM))) = 'AC'
            AND SA.SARADAP_PIDM = CH.SORHSCH_PIDM(+)
            AND SA.SARADAP_PIDM = SB.SPBPERS_PIDM(+)
            AND SA.SARADAP_TERM_CODE_ENTRY = psTerm
            AND SA.SARADAP_PIDM = DN.SGBSTDN_PIDM(+)
            AND (SA.SARADAP_PROGRAM_1 = psProgr OR psProgr IS NULL)
            AND SB.SPBPERS_NAME_SUFFIX = SU.SWBEPSU_RUT(+)
          ORDER BY PREFERENCIA, APELLIDOS;


---------------------------------------------------
-- bloque principal para la generacin del reporte
---------------------------------------------------
BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
   vsProgr := pk_ObjHtml.getValueCookie('psProgr');

   -- determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   -- define los encabezados de columnas:
   tabColumna(1)  := '<center> RUT';
   tabColumna(2)  := '<center> Apellidos';
   tabColumna(3)  := '<center> Nombre';
   tabColumna(4)  := '<center> Preferencia';
   tabColumna(5)  := '<center> Punt. UFT<br>(C&aacute;lculo<br>ponderado)';
   tabColumna(6)  := '<center> Decisi&oacute;n';
   tabColumna(7)  := '<center> Colegio';
   tabColumna(8)  := '<center> % Beca<br>autom&aacute;tica<br>PSU';
   tabColumna(9)  := '<center> % Beca<br>colegio<br>origen';
   tabColumna(10) := '<center> TFPA<br>(Tel&eacute;fono Fijo<br>Particular)';
   tabColumna(11) := '<center> TMPA<br>(Tel&eacute;fono M&oacute;vil<br>Particular)';
   tabColumna(12) := '<center> Correo electr&oacute;nico';

   -- manipula la informacin obtenida por el cursor:
   FOR regRep IN cuReporte (vsTerm, vsProgr) LOOP

       IF vnExists = 0 THEN

          -- muestra el encabezado segn la escuela seleccionada:
          IF vsProgr IS NOT NULL THEN
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||' - '||Pk_Catalogo.Periodo(vsTerm)||'<br>'||'Programa: '||vsProgr||' - '||Pk_Catalogo.Programa(vsProgr), psUniversidad=>'UFT');
          ELSE
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||' - '||Pk_Catalogo.Periodo(vsTerm)||'<br>'||'Programa: '||'Todos', psUniversidad=>'UFT');
          END IF;

       END IF;

       -- despliega los valores para cada registro:
       htp.p('<tr> <td valign="top" align="left">'   ||regRep.RUT          ||'</td>
                   <td valign="top" align="left">'   ||regRep.APELLIDOS    ||'</td>
                   <td valign="top" align="left">'   ||regRep.NOMBRE       ||'</td>
                   <td valign="top" align="center">' ||regrep.PREFERENCIA  ||'</td>
                   <td valign="top" align="center">' ||regrep.PUNT_UFT     ||'</td>
                   <td valign="top" align="left">'   ||regrep.DECISION     ||'</td>
                   <td valign="top" align="left">'   ||regrep.COLEGIO      ||'</td>
                   <td valign="top" align="center">' ||regrep.BECA_AUT     ||'</td>
                   <td valign="top" align="center">' ||regrep.BECA_COL     ||'</td>
                   <td valign="top" align="center">' ||regrep.TEL_FIJO     ||'</td>
                   <td valign="top" align="center">' ||regrep.TEL_MOVIL    ||'</td>
                   <td valign="top" align="left">'   ||regrep.E_MAIL       ||'</td>
             </tr>');

       vnExists    := 1;
       vnIdRenglon := vnIdRenglon + 1;

   END LOOP;

   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- es omitido el encabezado del reporte pero se agrega el salto de pgina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRSCCP;
/


DROP PUBLIC SYNONYM PWRSCCP;

CREATE PUBLIC SYNONYM PWRSCCP FOR BANINST1.PWRSCCP;


GRANT EXECUTE ON BANINST1.PWRSCCP TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRSCCP TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRSEDM;

CREATE OR REPLACE PROCEDURE BANINST1.PWRSEDM (psReclDesc   VARCHAR2) IS

/*  _____________________________________________________________________
   *                             HISTORIA                               *
   *                                                                    *
   * Elaboro     : J. Alberto Lopez Valle  (JALV)                       *
   * Email       : alvalle007@hotmail.com                               *
   * Para        : Integer                                              *
   * Fecha Elab. : 11/Ene/2012                                          *
   * Objetivo    : Pocedimiento que Genera el Reporte de Resultados     *
   *               Postulaciones obteniendo la informacin de las       *
   *               postulaciones de los alumnos no matriculados, para   *
   *               que los directores puedan darle seguimiento a las    *
   *               solicitudes.                                         *
   * Modificado  : Si                                                   *
   * Modifico    : J. Alberto Lopez Valle  (JALV)                       *
   * Proposito   : Correccion                                           *
   * Ult. modif. : 13/Ene/2012                                          *
   * Objetivo    : Mostrar informacion de Retractos                     *
   *                                                                    *
   * Tabs. Usadas:  SPRIDEN      Consulta.                              *
   *                SARADAP      Consulta.                              *
   *                SWVTAVI      Consulta.                              *
   *                SORHSCH      Consulta.                              *
   *                SWBEPSU      Consulta.                              *
   *                SPBPERS      Consulta.                              *
   *                SGBSTDN      Consulta.                              *
   *                TWBCNTR      Consulta.                              *
   *                                                                    *
   * Parametros                                                         *
   *    Entrada  : psReclDesc   Descripcion de Reclutamiento.           *
   *                                                                    *
   *    Salida   : N/A                                                  *
   *____________________________________________________________________*
*/


  -- Declaracin de Variables:
  vnExists       INTEGER      := 0;
  vnColumnas     INTEGER      := 20;
  vgsInicioPag   VARCHAR2(19) := NULL;         -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vnIdRenglon    INTEGER      := 1;
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);

  vsTerm         SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsProgr        SARADAP.SARADAP_PROGRAM_1%TYPE       DEFAULT NULL;
  vsViaAd        SWVTAVI.SWVTAVI_RTYP_CODE%TYPE       DEFAULT NULL; -- Nuevo Parametro JALV


  -- Obtiene la Informacin de los Alumnos:
  CURSOR cuReporte ( psTerm    VARCHAR2  DEFAULT NULL,
                     psProgr   VARCHAR2  DEFAULT NULL,
                     psViaAd   VARCHAR2  DEFAULT NULL) IS

     SELECT DISTINCT F_GET_RUT(SP.SPRIDEN_PIDM)                                                      RUT,
            SP.SPRIDEN_ID                                                                            ID,
            UPPER(REPLACE(REPLACE(SP.SPRIDEN_LAST_NAME, '*', ' '), '  ', ' ' ))                      APELLIDOS,
            UPPER(REPLACE(REPLACE(SP.SPRIDEN_FIRST_NAME||' '||SP.SPRIDEN_MI,'   ', ' '), '  ', ' ')) NOMBRE,
            DECODE((SELECT COUNT(*) FROM SGBSTDN
                     WHERE SGBSTDN_PIDM = SA.SARADAP_PIDM
                       AND SGBSTDN_TERM_CODE_EFF = psTerm), 0, NULL, 'INGRESADO')                    REGISTRO_ALUMNO,
            (SELECT SGBSTDN_PROGRAM_1 FROM SGBSTDN
              WHERE SGBSTDN_PIDM = SA.SARADAP_PIDM
                AND SGBSTDN_TERM_CODE_EFF = psTerm)                                                  CARRERA_REG_ALUM,
            SA.SARADAP_PROGRAM_1                                                                     CARRERA_POSTUL,
            TO_CHAR(TRUNC(SA.SARADAP_APPL_DATE),'DD/MM/YYYY')                                        FEC_POSTUL,
            SA.SARADAP_ADMT_CODE                                                                     TIPO_ADMISION,
            SWVTAVI_RTYP_CODE                                                                        VIA,
            SA.SARADAP_APPL_PREFERENCE                                                               PREFERENCIA,
                          (SELECT DISTINCT(SARAPPD_APDC_CODE)
               FROM SARAPPD A
              WHERE A.SARAPPD_PIDM = SA.SARADAP_PIDM
                AND A.SARAPPD_TERM_CODE_ENTRY = SA.SARADAP_TERM_CODE_ENTRY
                AND A.SARAPPD_APPL_NO = SA.SARADAP_APPL_NO
                AND A.SARAPPD_SEQ_NO = ( SELECT MAX(SARAPPD_SEQ_NO)
                                           FROM SARAPPD
                                          WHERE SARAPPD_PIDM = A.SARAPPD_PIDM
                                            AND SARAPPD_APPL_NO = SA.SARADAP_APPL_NO
                                            AND SARAPPD_TERM_CODE_ENTRY = SA.SARADAP_TERM_CODE_ENTRY) )              DECISION,
            BANINST1.F_PONDERADOA (SA.SARADAP_PIDM, SA.SARADAP_PROGRAM_1)                            PUNT_UFTA,
            F_BECAAUT (SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1)                                BECA_AUTA,
            F_BECACOL (SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1)                                BECA_COL,
            F_BECAREG (SA.SARADAP_PIDM, psTerm,SORHSCH_SBGI_CODE )                                   BECA_REG,
            F_BECAPOS (SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1)                                BECA_POS,
            TW.TWBCNTR_NUM                                                                          NUM_CNTR,
            TW.TWBCNTR_ORI_PROGRAM                                                                  CARRERA,
            (SELECT  twbretr_comm
             FROM    TWBRETR
             WHERE   twbretr_cntr_num = TW.twbcntr_num)                                             RAZ_RETR
       FROM SPRIDEN  SP,
            SARADAP  SA,
            SWVTAVI  VI,
            SORHSCH  CH,
            SWBEPSU  SU,
            SPBPERS  SB,
            SGBSTDN  DN,
            TWBCNTR  TW
      WHERE SP.SPRIDEN_CHANGE_IND IS NULL
        AND SP.SPRIDEN_PIDM = SA.SARADAP_PIDM
        AND SA.SARADAP_PIDM = CH.SORHSCH_PIDM(+)
        AND SA.SARADAP_PIDM = SB.SPBPERS_PIDM(+)
        AND SA.SARADAP_TERM_CODE_ENTRY = psTerm
        AND SA.SARADAP_PIDM = DN.SGBSTDN_PIDM(+)
        and SA.SARADAP_PIDM = TW.TWBCNTR_PIDM(+)
        and SA.SARADAP_TERM_CODE_ENTRY = TW.TWBCNTR_TERM_CODE(+)
        and SA.SARADAP_PROGRAM_1 = TW.TWBCNTR_ORI_PROGRAM(+)
        and SA.saradap_admt_code = SWVTAVI_ADMT_CODE
        and (swvtavi_rtyp_code = psViaAd OR psViaAd IS NULL)
        AND SA.SARADAP_TERM_CODE_ENTRY = VI.SWVTAVI_TERM_CODE
        AND (SA.SARADAP_PROGRAM_1 = psProgr OR psProgr IS NULL)
        AND SB.SPBPERS_NAME_SUFFIX = SU.SWBEPSU_RUT(+)
      ORDER BY F_GET_RUT(SP.SPRIDEN_PIDM), SARADAP_PROGRAM_1;

---------------------------------------------------
-- Bloque Principal Para La Generacin Del Reporte
---------------------------------------------------
BEGIN

   -- Valida que el Usuario tenga Acceso a la Base de Datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- Obtiene los Valores de las Cookies para Asignar los Valores del Filtro del Query:
   vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
   vsProgr := pk_ObjHtml.getValueCookie('psProgr');
   vsViaAd := pk_ObjHtml.getValueCookie('psViaAd');

   -- Determina el Largo de la Tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   -- Define los Encabezados de las Columnas:
   tabColumna(1)  := '<center> ID';
   tabColumna(2)  := '<center> RUT';
   tabColumna(3)  := '<center> Apellidos';
   tabColumna(4)  := '<center> Nombre';
   tabColumna(5)  := '<center> Registro <br> de <br> Alumno';
   tabColumna(6)  := '<center> Carrera Registro Alumno';
   tabColumna(7)  := '<center> Carrera <br>de <br> Postulaci&oacute;n';
   tabColumna(8)  := '<center> Fecha <br>de <br> Postulaci&oacute;n';
   tabColumna(9)  := '<center> Tipo <br>de <br>  Admisi&oacute;n';
   tabColumna(10) := '<center> V&iacutea <br>de Admisi&oacute;n';
   tabColumna(11) := '<center> Preferencia';
   tabColumna(12) := '<center> Decisi&oacute;n';
   tabColumna(13) := '<center> C&aacute;lculo Ponderado UFT';
   tabColumna(14) := '<center> Beca Autom&aacute;tica PSU';
   tabColumna(15) := '<center> Beca Colegio Origen';
   tabColumna(16) := '<center> Beca Regi&oacute;n';
   tabColumna(17) := '<center> Beca Postula';
   tabColumna(18) := '<center> Matr&iacute;cula N contrato';
   tabColumna(19) := '<center> Programa de la Matr&iacute;cula Contrato';
   tabColumna(20) := '<center> Raz&oacute;n Retracto';

   -- Manipula la Informacin Obtenida por el Cursor:
   FOR regRep IN cuReporte (vsTerm, vsProgr,vsViaAd) LOOP

       IF vnExists = 0 THEN

          -- Muestra el Encabezado segn el Periodo y Programa Seleccionados:
          IF vsProgr IS NOT NULL THEN
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||'<br>'||'Programa: &nbsp;'||vsProgr||' - '||Pk_Catalogo.Programa(vsProgr),
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
          ELSE
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||'<br>'||'Programa: &nbsp;'||'Todos ',
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
          END IF;

       END IF;

       -- Muestra los Valores para cada Registro:
       HTP.P('<tr> <td valign="top" align="left">'   ||regRep.ID                ||'</td>
                   <td valign="top" align="left">'   ||regRep.RUT               ||'</td>
                   <td valign="top" align="left">'   ||regRep.NOMBRE            ||'</td>
                   <td valign="top" align="left">'   ||regRep.APELLIDOS         ||'</td>
                   <td valign="top" align="left">'   ||regRep.REGISTRO_ALUMNO   ||'</td>
                   <td valign="top" align="left">'   ||regRep.CARRERA_REG_ALUM  ||'</td>
                   <td valign="top" align="left">'   ||regRep.CARRERA_POSTUL    ||'</td>
                   <td valign="top" align="center">' ||regRep.FEC_POSTUL        ||'</td>
                   <td valign="top" align="center">' ||regRep.TIPO_ADMISION     ||'</td>
                   <td valign="top" align="center">' ||regRep.VIA               ||'</td>
                   <td valign="top" align="center">' ||regRep.PREFERENCIA       ||'</td>
                   <td valign="top" align="center">' ||regRep.DECISION          ||'</td>
                   <td valign="top" align="center">' ||regRep.PUNT_UFTA         ||'</td>
                   <td valign="top" align="center">' ||regRep.BECA_AUTA         ||'</td>
                   <td valign="top" align="center">' ||regRep.BECA_COL          ||'</td>
                   <td valign="top" align="center">' ||regRep.BECA_REG          ||'</td>
                   <td valign="top" align="center">' ||regRep.BECA_POS          ||'</td>
                   <td valign="top" align="center">' ||regRep.NUM_CNTR          ||'</td>
                   <td valign="top" align="center">' ||regRep.CARRERA           ||'</td>
                   <td valign="top" align="center">' ||regRep.RAZ_RETR          ||'</td>
             </tr>');

       vnExists    := 1;
       vnIdRenglon := vnIdRenglon + 1;

   END LOOP;

   -- Muestra el pie de Reporte:
   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- Bandera que al tener el Valor "imprime" no colocar el Salto de Pgina para Impresin:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- Omite el Encabezado del Reporte pero se Agrega el Salto de Pgina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRSEDM;
/


DROP PUBLIC SYNONYM PWRSEDM;

CREATE PUBLIC SYNONYM PWRSEDM FOR BANINST1.PWRSEDM;


GRANT EXECUTE ON BANINST1.PWRSEDM TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRSEDM TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRSEGD;

CREATE OR REPLACE PROCEDURE BANINST1.PWRSEGD (psReclDesc   VARCHAR2)  IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de seguimiento
                de directores.
     propsito: obtener informacin de las postulaciones en cada carrera,
                para que el director pueda dar seguimiento al proceso de
                admisin, (alumnos no matriculados).
        mdulo: admisiones - uft.
         autor: hmr - horacio martnez ramrez.
         fecha: 24/06/2011.
*******************************************************************************/

  vnExists      INTEGER := 0;
  vnColumnas    INTEGER := 19;
  vgsInicioPag  VARCHAR2(30) := NULL;           -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  tabColumna    Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vnIdRenglon   INTEGER := 1;
  vsTerm        SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsProgr       SARADAP.SARADAP_PROGRAM_1%TYPE DEFAULT NULL;
  vsApdc        SARAPPD.SARAPPD_APDC_CODE%TYPE DEFAULT NULL;

  CURSOR cuReporte ( psTerm   VARCHAR2  DEFAULT NULL,
                     psProgr  VARCHAR2  DEFAULT NULL,
                     psApdc   VARCHAR2  DEFAULT NULL ) IS

         SELECT F_GET_RUT(SP.SPRIDEN_PIDM)                                                             RUT,
                SP.SPRIDEN_ID                                                                          ID,
                UPPER(REPLACE(REPLACE(SP.SPRIDEN_LAST_NAME,'*',' * '),'  ',' ' ))                      APELLIDOS,
                UPPER(REPLACE(SP.SPRIDEN_FIRST_NAME||' '||SP.SPRIDEN_MI,'  ',' '))                     NOMBRE,
                UPPER(Pk_Catalogo.Admision(SA.SARADAP_ADMT_CODE))                                      TIPO_ADMISION,
                UPPER(Pk_Catalogo.ResAdmi(
                       (SELECT DISTINCT(SARAPPD_APDC_CODE)
                          FROM SARAPPD A
                         WHERE A.SARAPPD_PIDM = SA.SARADAP_PIDM
                           AND A.SARAPPD_TERM_CODE_ENTRY = SA.SARADAP_TERM_CODE_ENTRY
                           AND A.SARAPPD_APPL_NO = SA.SARADAP_APPL_NO
                           AND A.SARAPPD_SEQ_NO = (
                                          SELECT MAX(SARAPPD_SEQ_NO)
                                            FROM SARAPPD
                                           WHERE SARAPPD_PIDM = A.SARAPPD_PIDM
                                             AND SARAPPD_APPL_NO = (
                                                           SELECT MAX(SARAPPD_APPL_NO)
                                                             FROM SARAPPD
                                                            WHERE SARAPPD_PIDM = A.SARAPPD_PIDM) ) ))) DECISION,
                F_PONDERADO (SA.SARADAP_PIDM, SA.SARADAP_PROGRAM_1)                                    PUNT_UFT,
                F_PROMEDIO_PSU (SA.SARADAP_PIDM)                                                       PUNT_PSU_PROM,
                F_PUNTAJE (SA.SARADAP_PIDM, 'NEME')                                                    NEME,
                F_PUNTAJE (SA.SARADAP_PIDM, 'PSLC')                                                    PSLC,
                F_PUNTAJE (SA.SARADAP_PIDM, 'PSMA')                                                    PSMA,
                F_PUNTAJE (SA.SARADAP_PIDM, 'PSCI')                                                    PSCI,
                F_PUNTAJE (SA.SARADAP_PIDM, 'PSHC')                                                    PSHC,
                F_BECAAUT (SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1)                              BECA_AUT,
                F_BECACOL (SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1)                              BECA_COL,
                NVL(SUBSTR(TO_CHAR(CH.SORHSCH_GRADUATION_DATE,'DD/MM/YYYY'),7,10), NULL)               ANO_EGRESO,
                UPPER(PK_CATALOGO.PREPARATORIA(CH.SORHSCH_SBGI_CODE))                                  COLEGIO,
                SA.SARADAP_APPL_PREFERENCE                                                             PREFERENCIA,
                ( SELECT COUNT(DISTINCT(SARADAP_APPL_NO))
                    FROM SARADAP
                   WHERE SARADAP_PIDM = SA.SARADAP_PIDM
                     AND SARADAP_TERM_CODE_ENTRY = psTerm )                                            NUM_POSTULACIONES
           FROM SPRIDEN  SP,
                SARADAP  SA,
                SORHSCH  CH,
                SWBEPSU  SU,
                SPBPERS  SB,
                SGBSTDN  DN
          WHERE SP.SPRIDEN_CHANGE_IND IS NULL
            AND SP.SPRIDEN_PIDM = SA.SARADAP_PIDM
            AND DN.SGBSTDN_PIDM NOT IN ( SELECT DISTINCT(TR.TWBCNTR_PIDM)
                                           FROM TWBCNTR TR
                                          WHERE TR.TWBCNTR_PIDM = SA.SARADAP_PIDM
                                            AND TR.TWBCNTR_STATUS_IND = 'A'
                                            AND TR.TWBCNTR_TERM_CODE = psTerm
                                            AND TR.TWBCNTR_ACTIVITY_DATE = (SELECT MAX(TWBCNTR_ACTIVITY_DATE)
                                                                              FROM TWBCNTR
                                                                             WHERE TWBCNTR_PIDM = TR.TWBCNTR_PIDM)
                                            and not exists (select 1
                                            from twbretr
                                            where twbretr_cntr_num = twbcntr_num))
            AND SA.SARADAP_PIDM = CH.SORHSCH_PIDM(+)
            AND SA.SARADAP_PIDM = SB.SPBPERS_PIDM(+)
            AND SA.SARADAP_TERM_CODE_ENTRY = psTerm
            AND SA.SARADAP_PIDM = DN.SGBSTDN_PIDM(+)
            AND (SA.SARADAP_PROGRAM_1 = psProgr OR psProgr IS NULL)
            AND ( (SELECT DISTINCT(SARAPPD_APDC_CODE)
                          FROM SARAPPD A
                         WHERE A.SARAPPD_PIDM = SA.SARADAP_PIDM
                           AND A.SARAPPD_TERM_CODE_ENTRY = SA.SARADAP_TERM_CODE_ENTRY
                           AND A.SARAPPD_APPL_NO = SA.SARADAP_APPL_NO
                           AND A.SARAPPD_SEQ_NO = (
                                          SELECT MAX(SARAPPD_SEQ_NO)
                                            FROM SARAPPD
                                           WHERE SARAPPD_PIDM = A.SARAPPD_PIDM
                                             AND SARAPPD_APPL_NO = (
                                                           SELECT MAX(SARAPPD_APPL_NO)
                                                             FROM SARAPPD
                                                            WHERE SARAPPD_PIDM = A.SARAPPD_PIDM) )) = psApdc OR psApdc IS NULL )
            AND SB.SPBPERS_NAME_SUFFIX = SU.SWBEPSU_RUT(+)
          ORDER BY DECISION, TO_NUMBER(REPLACE(PUNT_UFT,',','.'),'9999.99'), APELLIDOS;


---------------------------------------------------
-- bloque principal para la generacin del reporte
---------------------------------------------------
BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
   vsProgr := pk_ObjHtml.getValueCookie('psProgr');
   vsApdc  := pk_ObjHtml.getValueCookie('psApdc');

   -- determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   -- define los encabezados de columnas:
   tabColumna(1)  := '<center> RUT';
   tabColumna(2)  := '<center> ID';
   tabColumna(3)  := '<center> Apellidos';
   tabColumna(4)  := '<center> Nombre';
   tabColumna(5)  := '<center> Tipo de admisi&oacute;n';
   tabColumna(6)  := '<center> Decisi&oacute;n';
   tabColumna(7)  := '<center> Punt. UFT<br>(C&aacute;lculo<br>ponderado)';
   tabColumna(8)  := '<center> Punt. PSU<br>Promedio<br>(PSLC+PSMA)/2';
   tabColumna(9)  := '<center> NEM<br>equivalente';
   tabColumna(10) := '<center> &nbsp pslc &nbsp';
   tabColumna(11) := '<center> &nbsp psma &nbsp';
   tabColumna(12) := '<center> &nbsp psci &nbsp';
   tabColumna(13) := '<center> &nbsp pshc &nbsp';
   tabColumna(14) := '<center> % Beca<br>autom&aacute;tica<br>PSU';
   tabColumna(15) := '<center> % Beca<br>colegio<br>origen';
   tabColumna(16) := '<center> Ao de<br>egreso<br>E.M.';
   tabColumna(17) := '<center> Colegio';
   tabColumna(18) := '<center> Preferencia';
   tabcolumna(19) := '<center> N&uacute;mero de<br>postulaciones';

   -- manipula la informacin obtenida por el cursor:
   FOR regRep IN cuReporte (vsTerm, vsProgr, vsApdc) LOOP

       IF vnExists = 0 THEN

          -- muestra el encabezado segn el programa y desicin seleccionados:
          IF vsProgr IS NOT NULL THEN
             IF vsApdc IS NOT NULL THEN
                Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||' - '||Pk_Catalogo.Periodo(vsTerm)||'<br>'||'Programa: '||vsProgr||' - '||Pk_Catalogo.Programa(vsProgr)||', &nbsp &nbsp '||'Desicin: '||vsApdc||' - '||Pk_Catalogo.ResAdmi(vsApdc), psUniversidad=>'UFT');
             ELSE
                Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||' - '||Pk_Catalogo.Periodo(vsTerm)||'<br>'||'Programa: '||vsProgr||' - '||Pk_Catalogo.Programa(vsProgr)||', &nbsp &nbsp '||'Desicin: '||'Todas', psUniversidad=>'UFT');
             END IF;
          ELSE
             IF vsApdc IS NOT NULL THEN
                Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||' - '||Pk_Catalogo.Periodo(vsTerm)||'<br>'||'Programa: '||'Todos, &nbsp &nbsp '||'Desicin: '||vsApdc||' - '||Pk_Catalogo.ResAdmi(vsApdc), psUniversidad=>'UFT');
             ELSE
                Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||' - '||Pk_Catalogo.Periodo(vsTerm)||'<br>'||'Programa: '||'Todos, &nbsp &nbsp '||'Desicin: '||'Todas', psUniversidad=>'UFT');
             END IF;
          END IF;

       END IF;

       -- despliega los valores para cada registro:
       htp.p('<tr> <td valign="top" align="left">'   ||regRep.RUT               ||'</td>
                   <td valign="top" align="left">'   ||regRep.ID                ||'</td>
                   <td valign="top" align="left">'   ||regRep.APELLIDOS         ||'</td>
                   <td valign="top" align="left">'   ||regRep.NOMBRE            ||'</td>
                   <td valign="top" align="left">'   ||regrep.TIPO_ADMISION     ||'</td>
                   <td valign="top" align="left">'   ||regrep.DECISION          ||'</td>
                   <td valign="top" align="center">' ||regrep.PUNT_UFT          ||'</td>
                   <td valign="top" align="center">' ||regrep.PUNT_PSU_PROM     ||'</td>
                   <td valign="top" align="center">' ||regrep.NEME              ||'</td>
                   <td valign="top" align="center">' ||regrep.PSLC              ||'</td>
                   <td valign="top" align="center">' ||regrep.PSMA              ||'</td>
                   <td valign="top" align="center">' ||regrep.PSCI              ||'</td>
                   <td valign="top" align="center">' ||regrep.PSHC              ||'</td>
                   <td valign="top" align="center">' ||regrep.BECA_AUT          ||'</td>
                   <td valign="top" align="center">' ||regrep.BECA_COL          ||'</td>
                   <td valign="top" align="center">' ||regrep.ANO_EGRESO        ||'</td>
                   <td valign="top" align="left">'   ||regrep.COLEGIO           ||'</td>
                   <td valign="top" align="center">' ||regrep.PREFERENCIA       ||'</td>
                   <td valign="top" align="center">' ||regrep.NUM_POSTULACIONES ||'</td>
             </tr>');

       vnExists    := 1;
       vnIdRenglon := vnIdRenglon + 1;

   END LOOP;

   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- es omitido el encabezado del reporte pero se agrega el salto de pgina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRSEGD;
/


DROP PUBLIC SYNONYM PWRSEGD;

CREATE PUBLIC SYNONYM PWRSEGD FOR BANINST1.PWRSEGD;


GRANT EXECUTE ON BANINST1.PWRSEGD TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRSEGD TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRSEGM;

CREATE OR REPLACE PROCEDURE BANINST1.PWRSEGM (psReclDesc   VARCHAR2)  IS

/**************************************************************
           tarea:  procedimiento que genera el reporte de matriculados
          mdulo:  admisiones
           autor:  horacio martnez ramrez - hmr
           fecha:  04/ene/2010
**************************************************************/

  vnExists       INTEGER  := 0;
  vnColumnas     INTEGER  := 29;
  vgsInicioPag   VARCHAR2(30)  := NULL;           -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vnIdRenglon    INTEGER  := 1;
  vsTerm         SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsProgr        SARADAP.SARADAP_PROGRAM_1%TYPE DEFAULT NULL;


  CURSOR cuReporte ( psTerm   VARCHAR2  DEFAULT NULL,
                     psProgr  VARCHAR2  DEFAULT NULL )  IS

     SELECT F_GET_RUT(SP.SPRIDEN_PIDM)                                                               RUT,
            SP.SPRIDEN_ID                                                                            ID,
            UPPER(REPLACE(REPLACE(SP.SPRIDEN_LAST_NAME, '*', ' '), '  ', ' ' ))                          APELLIDOS,
            UPPER(REPLACE(REPLACE(SP.SPRIDEN_FIRST_NAME||' '||SP.SPRIDEN_MI,'   ', ' ' ), '  ', ' ' ))   NOMBRE,
            SARADAP_PROGRAM_1                                                                        CARRERA,
            TRUNC(SP.SPRIDEN_ACTIVITY_DATE)                                                          FEC_POSTUL,
            SA.SARADAP_ADMT_CODE                                                                     TIPO_ADMISION,
            SA.SARADAP_APPL_PREFERENCE                                                               PREFERENCIA,
            (SELECT MAX(SARAPPD_APPL_NO)
               FROM SARAPPD
              WHERE SARAPPD_PIDM = SA.SARADAP_PIDM
                AND SARAPPD_TERM_CODE_ENTRY = psTerm)                                                NUM_POSTUL,
            (SELECT DISTINCT(SARAPPD_APDC_CODE)
               FROM SARAPPD A
              WHERE A.SARAPPD_PIDM = SA.SARADAP_PIDM
                AND A.SARAPPD_TERM_CODE_ENTRY = SA.SARADAP_TERM_CODE_ENTRY
                AND A.SARAPPD_APPL_NO = SA.SARADAP_APPL_NO
                AND A.SARAPPD_SEQ_NO = (SELECT MAX(SARAPPD_SEQ_NO)
                                          FROM SARAPPD
                                         WHERE SARAPPD_PIDM = A.SARAPPD_PIDM
                                           AND SARAPPD_APPL_NO = SA.SARADAP_APPL_NO) )               DECISION,
            NVL(SUBSTR(TO_CHAR(CH.SORHSCH_GRADUATION_DATE,'DD/MM/YYYY'),7,10), NULL)                 ANO_EGRESO,
            UPPER(PK_CATALOGO.PREPARATORIA(CH.SORHSCH_SBGI_CODE))                                    COLEGIO,
            (SELECT SOBSBGI_STAT_CODE FROM SOBSBGI
              WHERE SOBSBGI_SBGI_CODE = CH.SORHSCH_SBGI_CODE)                                        REGION_COL,
            (SELECT SOBSBGI_CNTY_CODE FROM SOBSBGI
              WHERE SOBSBGI_SBGI_CODE = CH.SORHSCH_SBGI_CODE)                                        COMUNA_COL,
            (SELECT UPPER(ST.STVBCHR_DESC)
               FROM SORBCHR HR, STVBCHR ST
              WHERE HR.SORBCHR_BCHR_CODE = ST.STVBCHR_CODE
                AND HR.SORBCHR_SBGI_CODE = CH.SORHSCH_SBGI_CODE )                                    DEPEND_COL,
            (SELECT '('||NVL(LE.SPRTELE_PHONE_AREA,' 0 ')||') '||LE.SPRTELE_PHONE_NUMBER
               FROM SPRTELE LE
              WHERE LE.SPRTELE_SEQNO = (SELECT MAX(SPRTELE_SEQNO) FROM SPRTELE
                                         WHERE SPRTELE_TELE_CODE = 'TFPA'
                                           AND LE.SPRTELE_PIDM = SPRTELE_PIDM
                                           AND LE.SPRTELE_SEQNO = SPRTELE_SEQNO)
                AND SP.SPRIDEN_PIDM = LE.SPRTELE_PIDM
                AND ROWNUM = 1 )                                                                     TEL_FIJO,
            (SELECT LE.SPRTELE_PHONE_NUMBER
               FROM SPRTELE LE
              WHERE LE.SPRTELE_SEQNO = (SELECT MIN(SPRTELE_SEQNO) FROM SPRTELE
                                         WHERE SPRTELE_TELE_CODE = 'TMPA'
                                           AND LE.SPRTELE_PIDM = SPRTELE_PIDM
                                           AND LE.SPRTELE_SEQNO = SPRTELE_SEQNO)
                AND SP.SPRIDEN_PIDM = LE.SPRTELE_PIDM
                AND ROWNUM = 1 )                                                                     TEL_MOVIL,
            BANINST1.PK_DESCRIPCIONES.F_GETMAIL(SP.SPRIDEN_PIDM)                                     E_MAIL,
            NVL(SUBSTR(TO_CHAR(SU.SWBEPSU_ACTIVITY_DATE,'DD/MM/YYYY'),7,10), NULL)                   ANO_PSU,
            F_PUNTAJE(SA.SARADAP_PIDM, 'PSLC')                                                       PSLC,
            F_PUNTAJE(SA.SARADAP_PIDM, 'PSMA')                                                       PSMA,
            F_PUNTAJE(SA.SARADAP_PIDM, 'PSCI')                                                       PSCI,
            F_PUNTAJE(SA.SARADAP_PIDM, 'PSHC')                                                       PSHC,
            F_PUNTAJE(SA.SARADAP_PIDM, 'NEM')                                                        NEM,
            F_PUNTAJE(SA.SARADAP_PIDM, 'NEME')                                                       NEME,
            F_PROMEDIO_PSU(SP.SPRIDEN_PIDM)                                                          PUNT_PSU_PROM,
            F_PONDERADO(SA.SARADAP_PIDM, SA.SARADAP_PROGRAM_1)                                       PUNT_UFT,
            F_BECAAUT(SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1 )                                BECA_AUT,
            F_BECACOL(SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1 )                                BECA_COL
       FROM SPRIDEN  SP,
            SARADAP  SA,
            SORHSCH  CH,
            SARAPPD  PD,
            SWBEPSU  SU,
            SPBPERS  SB
      WHERE SP.SPRIDEN_CHANGE_IND IS NULL
            AND SP.SPRIDEN_PIDM = SA.SARADAP_PIDM(+)
            AND SA.SARADAP_PIDM IN (SELECT DISTINCT (TBRACCD_PIDM)                    -- para alumnos matriculados
                                          FROM TBRACCD
                                         WHERE TBRACCD_TERM_CODE = psTerm)
            AND SA.SARADAP_PIDM = CH.SORHSCH_PIDM(+)
            AND SA.SARADAP_PIDM = SB.SPBPERS_PIDM
            AND SA.SARADAP_PIDM = PD.SARAPPD_PIDM(+)
            AND SA.SARADAP_TERM_CODE_ENTRY = psTerm
            AND SA.SARADAP_TERM_CODE_ENTRY = PD.SARAPPD_TERM_CODE_ENTRY
            AND SA.SARADAP_APPL_NO = (SELECT MAX(SARADAP_APPL_NO)
                                        FROM SARADAP
                                       WHERE SARADAP_PIDM = SP.SPRIDEN_PIDM)
            AND SA.SARADAP_APPL_NO = PD.SARAPPD_APPL_NO
            AND PD.SARAPPD_SEQ_NO = (SELECT MAX(SARAPPD_SEQ_NO)
                                       FROM SARAPPD
                                      WHERE SARAPPD_PIDM = SP.SPRIDEN_PIDM)
            AND (SA.SARADAP_PROGRAM_1 = psProgr OR psProgr IS NULL)
            AND SB.SPBPERS_NAME_SUFFIX = SU.SWBEPSU_RUT(+)
      ORDER BY SARADAP_PROGRAM_1, PD.SARAPPD_APDC_CODE, SA.SARADAP_ADMT_CODE, SP.SPRIDEN_ID;


  BEGIN

     -- valida que el usuario pertenezca a la base de datos:
     IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

     -- son buscados los valores de las cookies para asignar los valores del filtro del query:
     vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
     vsProgr := pk_ObjHtml.getValueCookie('psProgr');

     -- se determina el largo de la tabla:
     FOR vnI IN 1..vnColumnas LOOP
         tabColumna.EXTEND(vnI);
         tabColumna(vnI) := NULL;
     END LOOP;

     tabColumna(1)  := '<center> RUT';
     tabColumna(2)  := '<center> ID';
     tabColumna(3)  := '<center> Apellidos';
     tabColumna(4)  := '<center> Nombre';
     tabColumna(5)  := '<center> Carrera';
     tabColumna(6)  := '<center> Fecha de postulacin';
     tabColumna(7)  := '<center> Tipo de admisin';
     tabColumna(8)  := '<center> Preferencia';
     tabColumna(9)  := '<center> Nmero de postulaciones';
     tabColumna(10) := '<center> Decisin';
     tabColumna(11) := '<center> Ao egreso E.M.';
     tabColumna(12) := '<center> Colegio';
     tabColumna(13) := '<center> Regin colegio';
     tabColumna(14) := '<center> Comuna colegio';
     tabColumna(15) := '<center> Dependencia colegio';
     tabColumna(16) := '<center> Telfono fijo';
     tabColumna(17) := '<center> Telfono mvil';
     tabColumna(18) := '<center> E-mail';
     tabColumna(19) := '<center> Ao PSU';
     tabColumna(20) := '<center> PSLC';
     tabColumna(21) := '<center> PSMA';
     tabColumna(22) := '<center> PSCI';
     tabColumna(23) := '<center> PSHC';
     tabColumna(24) := '<center> NEM';
     tabColumna(25) := '<center> NEM equivalente';
     tabColumna(26) := '<center> Punt. PSU promedio (PSLC+PSMA)/2';
     tabColumna(27) := '<center> Punt. UFT (Clculo ponderado)';
     tabColumna(28) := '<center> Beca automtica PSU <br> ( % )';
     tabColumna(29) := '<center> Beca colegio origen <br> ( % )';


     FOR regRep IN cuReporte (vsTerm, vsProgr) LOOP

         IF vnExists = 0 THEN
            Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||'  '||Pk_Catalogo.PERIODO(vsTerm), psUniversidad=>'UFT');
            vgsInicioPag := 'SALTO';
         END IF;

         HTP.P('<tr> <td valign="top" align="center">' ||regRep.RUT           ||'</td>
                     <td valign="top" align="center">' ||regRep.ID            ||'</td>
                     <td valign="top" align="left">'   ||regRep.APELLIDOS     ||'</td>
                     <td valign="top" align="left">'   ||regRep.NOMBRE        ||'</td>
                     <td valign="top" align="left">'   ||regRep.CARRERA       ||'</td>
                     <td valign="top" align="center">' ||regRep.FEC_POSTUL    ||'</td>
                     <td valign="top" align="center">' ||regrep.TIPO_ADMISION ||'</td>
                     <td valign="top" align="center">' ||regrep.PREFERENCIA   ||'</td>
                     <td valign="top" align="center">' ||regrep.NUM_POSTUL    ||'</td>
                     <td valign="top" align="center">' ||regrep.DECISION      ||'</td>
                     <td valign="top" align="center">' ||regrep.ANO_EGRESO    ||'</td>
                     <td valign="top" align="left">'   ||regrep.COLEGIO       ||'</td>
                     <td valign="top" align="center">' ||regrep.REGION_COL    ||'</td>
                     <td valign="top" align="center">' ||regrep.COMUNA_COL    ||'</td>
                     <td valign="top" align="left">'   ||regrep.DEPEND_COL    ||'</td>
                     <td valign="top" align="left">'   ||regrep.TEL_FIJO      ||'</td>
                     <td valign="top" align="left">'   ||regrep.TEL_MOVIL     ||'</td>
                     <td valign="top" align="left">'   ||regrep.E_MAIL        ||'</td>
                     <td valign="top" align="center">' ||regrep.ANO_PSU       ||'</td>
                     <td valign="top" align="center">' ||regrep.PSLC          ||'</td>
                     <td valign="top" align="center">' ||regrep.PSMA          ||'</td>
                     <td valign="top" align="center">' ||regrep.PSCI          ||'</td>
                     <td valign="top" align="center">' ||regrep.PSHC          ||'</td>
                     <td valign="top" align="center">' ||regrep.NEM           ||'</td>
                     <td valign="top" align="center">' ||regrep.NEME          ||'</td>
                     <td valign="top" align="center">' ||regrep.PUNT_PSU_PROM ||'</td>
                     <td valign="top" align="center">' ||regrep.PUNT_UFT      ||'</td>
                     <td valign="top" align="center">' ||regrep.BECA_AUT      ||'</td>
                     <td valign="top" align="center">' ||regrep.BECA_COL      ||'</td>
             </tr>');

         vnExists    := 1;
         vnIdRenglon := vnIdRenglon + 1;

     END LOOP;

     IF vnExists = 0 THEN
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
     ELSE
        -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pgina:
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
     END IF;

     htp.p('</table><br/></body></html>');

  EXCEPTION
     WHEN OTHERS THEN
          htp.p(SQLERRM);

  END PWRSEGM;
/


DROP PUBLIC SYNONYM PWRSEGM;

CREATE PUBLIC SYNONYM PWRSEGM FOR BANINST1.PWRSEGM;


GRANT EXECUTE ON BANINST1.PWRSEGM TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRSEGM TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRSEGP;

CREATE OR REPLACE PROCEDURE BANINST1.PWRSEGP (psReclDesc   VARCHAR2) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de decisin y seguimiento
                de directores.
     propsito: obtener informacin de las postulaciones de los alumnos no
                matriculados, para que los directores puedan darle seguimiento
                a las solicitudes
        mdulo: admisiones - uft.
         autor: hmr - horacio martnez ramrez.
         fecha: 13/01/2011.

  modificacin: hmr - 15/07/2011.
                se ajust la obtencin del tipo de desicin para que fuera
                idntica a la del reporte de postulaciones.

  modificacin: hmr - 08/09/2011.
                se condicion la obtencin de la dependencia del colegio con
                el ao del periodo selecionado para que no se obtenga ms de
                un regisro.
*******************************************************************************/

  -- declaracin de variables:
  vnExists       INTEGER      := 0;
  vnColumnas     INTEGER      := 43;
  vgsInicioPag   VARCHAR2(30) := NULL;         -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vnIdRenglon    INTEGER      := 1;
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);

  vsTerm         SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsProgr        SARADAP.SARADAP_PROGRAM_1%TYPE       DEFAULT NULL;
  vsPropsu_ant  VARCHAR2(50) := NULL;
  vsPropsu_act  VARCHAR2(50) := NULL;
  vnTermAnt VARCHAR2(6) := NULL;
  vnTermAct VARCHAR2(6) := NULL;
  vnAnoEje   VARCHAR2(4) := NULL;

  -- obtiene la informacin de los alumnos:
  CURSOR cuReporte ( psTerm    VARCHAR2  DEFAULT NULL,
                     psProgr   VARCHAR2  DEFAULT NULL ) IS

     SELECT DISTINCT F_GET_RUT(SP.SPRIDEN_PIDM)                                                      RUT,
            SP.SPRIDEN_ID                                                                            ID,
            UPPER(REPLACE(REPLACE(SP.SPRIDEN_LAST_NAME, '*', ' '), '  ', ' ' ))                      APELLIDOS,
            UPPER(REPLACE(REPLACE(SP.SPRIDEN_FIRST_NAME||' '||SP.SPRIDEN_MI,'   ', ' '), '  ', ' ')) NOMBRE,
            DECODE((SELECT COUNT(*) FROM SGBSTDN
                     WHERE SGBSTDN_PIDM = SA.SARADAP_PIDM
                       AND SGBSTDN_TERM_CODE_EFF = psTerm), 0, NULL, 'INGRESADO')                    REGISTRO_ALUMNO,
            (SELECT SGBSTDN_PROGRAM_1 FROM SGBSTDN
              WHERE SGBSTDN_PIDM = SA.SARADAP_PIDM
                AND SGBSTDN_TERM_CODE_EFF = psTerm)                                                  CARRERA_REG_ALUM,
            SA.SARADAP_PROGRAM_1                                                                     CARRERA_POSTUL,
            TO_CHAR(TRUNC(SA.SARADAP_APPL_DATE),'DD/MM/YYYY')                                        FEC_POSTUL,
            SA.SARADAP_ADMT_CODE                                                                     TIPO_ADMISION,
            SWVTAVI_RTYP_CODE         VIA,
            SA.SARADAP_APPL_PREFERENCE                                                               PREFERENCIA,
            (SELECT COUNT(DISTINCT(SARADAP_APPL_NO))
               FROM SARADAP
              WHERE SARADAP_PIDM = SA.SARADAP_PIDM
                AND SARADAP_TERM_CODE_ENTRY = psTerm)                                                NUM_POSTULACIONES,
            (SELECT DISTINCT(SARAPPD_APDC_CODE)
               FROM SARAPPD A
              WHERE A.SARAPPD_PIDM = SA.SARADAP_PIDM
                AND A.SARAPPD_TERM_CODE_ENTRY = SA.SARADAP_TERM_CODE_ENTRY
                AND A.SARAPPD_APPL_NO = SA.SARADAP_APPL_NO
                AND A.SARAPPD_SEQ_NO = ( SELECT MAX(SARAPPD_SEQ_NO)
                                           FROM SARAPPD
                                          WHERE SARAPPD_PIDM = A.SARAPPD_PIDM
                                            AND SARAPPD_APPL_NO = SA.SARADAP_APPL_NO) )              DECISION,
            NVL(SUBSTR(TO_CHAR(CH.SORHSCH_GRADUATION_DATE,'DD/MM/YYYY'),7,10), NULL)                 ANO_EGRESO,
            UPPER(PK_CATALOGO.PREPARATORIA (CH.SORHSCH_SBGI_CODE))                                   COLEGIO,
            (SELECT SOBSBGI_STAT_CODE FROM SOBSBGI
              WHERE SOBSBGI_SBGI_CODE = CH.SORHSCH_SBGI_CODE)                                        REGION_COL,
            (SELECT SOBSBGI_CNTY_CODE FROM SOBSBGI
              WHERE SOBSBGI_SBGI_CODE = CH.SORHSCH_SBGI_CODE)                                        COMUNA_COL,
            (SELECT UPPER(ST.STVBCHR_DESC)
               FROM SORBCHR HR, STVBCHR ST
              WHERE HR.SORBCHR_BCHR_CODE <> 'L'
                AND HR.SORBCHR_DEMO_YEAR = SUBSTR(psTerm, 1, 4)                 -- lnea hmr
                AND HR.SORBCHR_BCHR_CODE = ST.STVBCHR_CODE
                AND HR.SORBCHR_SBGI_CODE = CH.SORHSCH_SBGI_CODE)                                     DEPEND_COL,
            (SELECT DECODE(LE.SPRTELE_PHONE_AREA, NULL, '', '('||LE.SPRTELE_PHONE_AREA||') ' )||
                    LE.SPRTELE_PHONE_NUMBER||
                    DECODE( LE.SPRTELE_PHONE_EXT, NULL, '', (' EXT. '||LE.SPRTELE_PHONE_EXT) )
               FROM SPRTELE LE
              WHERE LE.SPRTELE_SEQNO = (SELECT MAX(SPRTELE_SEQNO)
                                          FROM SPRTELE
                                         WHERE SPRTELE_TELE_CODE = 'TFPA'
                                           AND LE.SPRTELE_PIDM = SPRTELE_PIDM
                                           AND LE.SPRTELE_SEQNO = SPRTELE_SEQNO)
                AND SP.SPRIDEN_PIDM = LE.SPRTELE_PIDM
                AND ROWNUM = 1)                                                                      TEL_FIJO,
            (SELECT '('||NVL(LE.SPRTELE_PHONE_AREA,' 0 ')||') '||LE.SPRTELE_PHONE_NUMBER
               FROM SPRTELE LE
              WHERE LE.SPRTELE_SEQNO = (SELECT MIN(SPRTELE_SEQNO)
                                          FROM SPRTELE
                                         WHERE SPRTELE_TELE_CODE = 'TMPA'
                                           AND LE.SPRTELE_PIDM = SPRTELE_PIDM
                                           AND LE.SPRTELE_SEQNO = SPRTELE_SEQNO)
                AND SP.SPRIDEN_PIDM = LE.SPRTELE_PIDM
                AND ROWNUM = 1)                                                                      TEL_MOVIL,
            BANINST1.PK_DESCRIPCIONES.F_GETMAIL (SP.SPRIDEN_PIDM)                                    E_MAIL,
            --NVL(SUBSTR(TO_CHAR(SU.SWBEPSU_ACTIVITY_DATE,'DD/MM/YYYY'),7,10), NULL)                   ANO_PSU,
            F_PUNTAJES (SA.SARADAP_PIDM, 'PRAN',1,vnTermAct,null)    PRAN,
            F_PUNTAJES (SA.SARADAP_PIDM, 'PEM',1,vnTermAct,null)      PEM,
            F_PUNTAJES (SA.SARADAP_PIDM, 'NEME',1,vnTermAct,null)    NEME,
            DECODE(SA.SARADAP_PROGRAM_1, 'LC-ACTU-10',F_PUNTAJES (SA.SARADAP_PIDM, 'PETE',1,vnTermAct,null),'LC-PRMC-10',F_PUNTAJES (SA.SARADAP_PIDM, 'PEPR',1,vnTermAct,null),NULL) PUNT_ESP,
            (select  stvterm_acyr_code from  stvterm where stvterm_code=psTerm) ANO_PSU,
            F_PUNTAJES (SA.SARADAP_PIDM, 'PSLC',1,vnTermAct,null)     PSLC,
            F_PUNTAJES (SA.SARADAP_PIDM, 'PSMA',1,vnTermAct,null)   PSMA,
            F_PUNTAJES (SA.SARADAP_PIDM, 'PSCI',1,vnTermAct,null)     PSCI,
            F_PUNTAJES (SA.SARADAP_PIDM, 'PSHC',1,vnTermAct,null)    PSHC,
            --F_PROMEDIO_PSU (SA.SARADAP_PIDM)                                                       PUNT_PSU_PROM,
            F_PONDERADOS (SA.SARADAP_PIDM, SA.SARADAP_PROGRAM_1,1,vnTermAct,null)    PUNT_UFTA,
            (select  stvterm_acyr_code from  stvterm where stvterm_code=psTerm)-1         ANO_PSU_ANT,
            F_PUNTAJES (SA.SARADAP_PIDM, 'PSLC',2,null,vnTermAnt)     PSLC_ANT,
            F_PUNTAJES (SA.SARADAP_PIDM, 'PSMA',2,null,vnTermAnt)   PSMA_ANT,
            F_PUNTAJES (SA.SARADAP_PIDM, 'PSCI',2,null,vnTermAnt)     PSCI_ANT,
            F_PUNTAJES (SA.SARADAP_PIDM, 'PSHC',2,null,vnTermAnt)    PSHC_ANT,
            F_PONDERADOS (SA.SARADAP_PIDM, SA.SARADAP_PROGRAM_1,2,null,vnTermAnt)    PUNT_UFTA_ANT,
            F_BECAAUT (SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1)                                BECA_AUTA,
            F_BECACOL (SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1)                                BECA_COL,
            F_BECAREG (SA.SARADAP_PIDM, psTerm,SORHSCH_SBGI_CODE )                              BECA_REG,
            F_BECAPOS (SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1)                                BECA_POS,
            SP.SPRIDEN_PIDM                                                     PIDM,
            SA.SARADAP_APPL_NO                                               APPL_NO
            --F_PUNTAJES (SA.SARADAP_PIDM, 'NEM',1,vnTermAct,null)          NEM
       FROM SPRIDEN  SP,
            SARADAP  SA,
            SWVTAVI  VI,
            SORHSCH  CH,
            SWBEPSU  SU,
            SPBPERS  SB,
            SGBSTDN  DN
      WHERE SP.SPRIDEN_CHANGE_IND IS NULL
        AND SP.SPRIDEN_PIDM = SA.SARADAP_PIDM
        AND DN.SGBSTDN_PIDM NOT IN ( SELECT DISTINCT(TR.TWBCNTR_PIDM)
                                       FROM TWBCNTR TR
                                      WHERE TR.TWBCNTR_PIDM = SA.SARADAP_PIDM
                                        AND TR.TWBCNTR_STATUS_IND = 'A'
                                        AND TR.TWBCNTR_TERM_CODE = psTerm
                                        AND TR.TWBCNTR_ACTIVITY_DATE = (SELECT MAX(TWBCNTR_ACTIVITY_DATE)
                                                                          FROM TWBCNTR
                                                                         WHERE TWBCNTR_PIDM = TR.TWBCNTR_PIDM)
                                        and not exists (select 1
                                            from twbretr
                                            where twbretr_cntr_num = twbcntr_num))
        AND SA.SARADAP_PIDM = CH.SORHSCH_PIDM(+)
        AND SA.SARADAP_PIDM = SB.SPBPERS_PIDM(+)
        AND SA.SARADAP_TERM_CODE_ENTRY = psTerm
        AND SA.SARADAP_PIDM = DN.SGBSTDN_PIDM(+)
        and sa.saradap_admt_code = SWVTAVI_ADMT_CODE
        AND SA.SARADAP_TERM_CODE_ENTRY = VI.SWVTAVI_TERM_CODE
        AND (SA.SARADAP_PROGRAM_1 = psProgr OR psProgr IS NULL)
        AND SB.SPBPERS_NAME_SUFFIX = SU.SWBEPSU_RUT(+)
      ORDER BY F_GET_RUT(SP.SPRIDEN_PIDM), SARADAP_PROGRAM_1;


---------------------------------------------------
-- bloque principal para la generacin del reporte
---------------------------------------------------
BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
   vsProgr := pk_ObjHtml.getValueCookie('psProgr');

   -- determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   -- define los encabezados de las columnas:
   tabColumna(1)  := '<center> RUT';
   tabColumna(2)  := '<center> ID';
   tabColumna(3)  := '<center> Apellidos';
   tabColumna(4)  := '<center> Nombre';
   tabColumna(5)  := '<center> Registro <br> de <br> alumno';
   tabColumna(6)  := '<center> Carrera registro alumno';
   --tabColumna(7)  := '<center> Carrera <br>de <br> postulaci&oacute;n';
   tabColumna(7)  := '<center> Programa';
   tabColumna(8)  := '<center> Fecha <br>de <br> Solicitud';
   tabColumna(9)  := '<center> Tipo <br>de <br>  admisi&oacute;n';
   tabColumna(10)  := '<center> V&iacutea <br>de Admisi&oacute;n';
   tabColumna(11) := '<center> Preferencia';
   tabcolumna(12) := '<center> N&uacute;mero <br>de postulaciones';
   tabColumna(13) := '<center> Decisi&oacute;n';
   tabColumna(14) := '<center> Ao Egreso E.M.';
   tabColumna(15) := '<center> Colegio';
   tabColumna(16) := '<center> Regi&oacute;n colegio';
   tabColumna(17) := '<center> Comuna colegio';
   tabColumna(18) := '<center> Dependencia colegio';
   tabColumna(19) := '<center> Tel&eacute;fono fijo';
   tabColumna(20) := '<center> Tel&eacute;fono mvil';
   tabColumna(21) := '<center> E-mail';
   tabColumna(22) := '<center> PRAN';
   tabColumna(23) := '<center> NEM';
   tabColumna(24) := '<center> NEM equivalente';
   tabColumna(25) := '<center> Puntaje Especial';
   tabColumna(26) := '<center> Ao PSU ant';
   tabColumna(27) := '<center> PSLC ant';
   tabColumna(28) := '<center> PSMA ant';
   tabColumna(29) := '<center> PSCI ant';
   tabColumna(30) := '<center> PSHC ant ';
   tabColumna(31) := '<center> Punt. PSU Promedio (PSLC+PSMA)/2 ant';
   tabColumna(32) := '<center> Punt. UFT (C&aacute;lculo ponderado) ant';
   --
   tabColumna(33) := '<center> Ao PSU act';
   tabColumna(34) := '<center> PSLC act';
   tabColumna(35) := '<center> PSMA act';
   tabColumna(36) := '<center> PSCI act';
   tabColumna(37) := '<center> PSHC act ';
   tabColumna(38) := '<center> Punt. PSU Promedio (PSLC+PSMA)/2 act';
   tabColumna(39) := '<center> Punt. UFT (C&aacute;lculo ponderado) act';
   --
   tabColumna(40) := '<center> % Beca autom&aacute;tica PSU';
   tabColumna(41) := '<center> % Beca colegio origen';
   tabColumna(42) := '<center> % Beca Regi&oacute;n';
   tabColumna(43) := '<center> % Beca Postula';

   -- idetermina los parmetros con los cuales obtendr los puntajes anteriores y actuales

       begin
        select  stvterm_acyr_code
           into  vnAnoEje
        from  stvterm
        where
            stvterm_code=vsTerm;
        exception
        when no_data_found then
            vnAnoEje:=substr(vsTerm,1,4);
        when others then
            vnAnoEje:=substr(vsTerm,1,4);
    end;

   begin
        select  swvcpsu_term_code_previous,swvcpsu_term_code_present
           into  vnTermAnt,vnTermAct
        from  swvcpsu
        where
            swvcpsu_acyr_code=vnAnoEje;
        exception
        when no_data_found then
            vnTermAnt:=vsTerm;
            vnTermAct:=vsTerm;
        when others then
            vnTermAnt:=vsTerm;
            vnTermAct:=vsTerm;
   end;


   FOR regRep IN cuReporte (vsTerm, vsProgr) LOOP

       IF vnExists = 0 THEN

          -- muestra el encabezado segn el periodo y programa seleccionados:
          IF vsProgr IS NOT NULL THEN
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||'<br>'||'Programa: &nbsp;'||vsProgr||' - '||Pk_Catalogo.Programa(vsProgr),
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
          ELSE
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||'<br>'||'Programa: &nbsp;'||'Todos ',
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
          END IF;

       END IF;

       SELECT
              CASE
                        WHEN ROUND((TO_NUMBER(REPLACE(nvl(regRep.PSLC_ANT,0) , ',', '.'))+TO_NUMBER(REPLACE(nvl(regRep.PSMA_ANT,0) , ',', '.')))/2,2) = 0
                           THEN null
                        WHEN ROUND((TO_NUMBER(REPLACE(nvl(regRep.PSLC_ANT,0) , ',', '.'))+TO_NUMBER(REPLACE(nvl(regRep.PSMA_ANT,0) , ',', '.')))/2,2) <> 0
                          THEN
                              replace(ROUND((TO_NUMBER(REPLACE(nvl(regRep.PSLC_ANT,0) , ',', '.'))+TO_NUMBER(REPLACE(nvl(regRep.PSMA_ANT,0) , ',', '.')))/2,2),'.',',')
              END,
              CASE
                        WHEN ROUND((TO_NUMBER(REPLACE(nvl(regRep.PSLC,0) , ',', '.'))+TO_NUMBER(REPLACE(nvl(regRep.PSMA,0) , ',', '.')))/2,2) = 0
                           THEN null
                        WHEN ROUND((TO_NUMBER(REPLACE(nvl(regRep.PSLC,0) , ',', '.'))+TO_NUMBER(REPLACE(nvl(regRep.PSMA,0) , ',', '.')))/2,2) <> 0
                          THEN
                              replace(ROUND((TO_NUMBER(REPLACE(nvl(regRep.PSLC,0) , ',', '.'))+TO_NUMBER(REPLACE(nvl(regRep.PSMA,0) , ',', '.')))/2,2),'.',',')
              END
            into vsPropsu_ant,vsPropsu_act
       from dual;


       -- muestra los valores para cada registro:
       HTP.P('<tr> <td valign="top" align="left">'   ||regRep.RUT               ||'</td>
                   <td valign="top" align="left">'   ||regRep.ID                ||'</td>
                   <td valign="top" align="left">'   ||regRep.APELLIDOS         ||'</td>
                   <td valign="top" align="left">'   ||regRep.NOMBRE            ||'</td>
                   <td valign="top" align="left">'   ||regRep.REGISTRO_ALUMNO   ||'</td>
                   <td valign="top" align="left">'   ||regRep.CARRERA_REG_ALUM  ||'</td>
                   <td valign="top" align="left">'   ||regRep.CARRERA_POSTUL    ||'</td>
                   <td valign="top" align="center">' ||regRep.FEC_POSTUL        ||'</td>
                   <td valign="top" align="center">' ||regRep.TIPO_ADMISION     ||'</td>
                   <td valign="top" align="center">' ||regRep.VIA       ||'</td>
                   <td valign="top" align="center">' ||regRep.PREFERENCIA       ||'</td>
                   <td valign="top" align="center">' ||regRep.NUM_POSTULACIONES ||'</td>
                   <td valign="top" align="center">' ||regRep.DECISION       ||'</td>
                   <td valign="top" align="center">' ||regRep.ANO_EGRESO        ||'</td>
                   <td valign="top" align="left">'   ||regRep.COLEGIO           ||'</td>
                   <td valign="top" align="center">' ||regRep.REGION_COL        ||'</td>
                   <td valign="top" align="center">' ||regRep.COMUNA_COL        ||'</td>
                   <td valign="top" align="left">'   ||regRep.DEPEND_COL        ||'</td>
                   <td valign="top" align="rigth">'  ||regRep.TEL_FIJO          ||'</td>
                   <td valign="top" align="rigth">'  ||regRep.TEL_MOVIL         ||'</td>
                   <td valign="top" align="left">'   ||regRep.E_MAIL            ||'</td>
                   <td valign="top" align="center">' ||regRep.PRAN              ||'</td>
                   <td valign="top" align="center">' ||regRep.PEM               ||'</td>
                   <td valign="top" align="center">' ||regRep.NEME              ||'</td>
                   <td valign="top" align="center">' ||regRep.PUNT_ESP          ||'</td>
                   <td valign="top" align="center">' ||regRep.ANO_PSU_ANT           ||'</td>
                   <td valign="top" align="center">' ||regRep.PSLC_ANT              ||'</td>
                   <td valign="top" align="center">' ||regRep.PSMA_ANT              ||'</td>
                   <td valign="top" align="center">' ||regRep.PSCI_ANT              ||'</td>
                   <td valign="top" align="center">' ||regRep.PSHC_ANT              ||'</td>
                   <td valign="top" align="center">' ||vsPropsu_ant                     ||'</td>
                   <td valign="top" align="center">' ||regRep.PUNT_UFTA_ANT          ||'</td>
                   <td valign="top" align="center">' ||regRep.ANO_PSU           ||'</td>
                   <td valign="top" align="center">' ||regRep.PSLC              ||'</td>
                   <td valign="top" align="center">' ||regRep.PSMA              ||'</td>
                   <td valign="top" align="center">' ||regRep.PSCI              ||'</td>
                   <td valign="top" align="center">' ||regRep.PSHC              ||'</td>
                   <td valign="top" align="center">' ||vsPropsu_act              ||'</td>
                   <td valign="top" align="center">' ||regRep.PUNT_UFTA        ||'</td>
                   <td valign="top" align="center">' ||regRep.BECA_AUTA        ||'</td>
                   <td valign="top" align="center">' ||regRep.BECA_COL          ||'</td>
                   <td valign="top" align="center">' ||regRep.BECA_REG          ||'</td>
                   <td valign="top" align="center">' ||regRep.BECA_POS          ||'</td>
             </tr>');

       vnExists    := 1;
       vnIdRenglon := vnIdRenglon + 1;

   END LOOP;

   -- muestra el pie de reporte:
   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- omite el encabezado del reporte pero se agrega el salto de pgina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRSEGP;
/


DROP PUBLIC SYNONYM PWRSEGP;

CREATE PUBLIC SYNONYM PWRSEGP FOR BANINST1.PWRSEGP;


GRANT EXECUTE ON BANINST1.PWRSEGP TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRSEGP TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRSEG2;

CREATE OR REPLACE PROCEDURE BANINST1.PWRSEG2 (psReclDesc   VARCHAR2) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de decisin y seguimiento
                de directores.
     propsito: obtener informacin de las postulaciones de los alumnos no
                matriculados, para que los directores puedan darle seguimiento
                a las solicitudes
        mdulo: admisiones - uft.
         autor: hmr - horacio martnez ramrez.
         fecha: 13/01/2011.

  modificacin: hmr - 15/07/2011.
                se ajust la obtencin del tipo de desicin para que fuera
                idntica a la del reporte de postulaciones.

  modificacin: hmr - 08/09/2011.
                se condicion la obtencin de la dependencia del colegio con
                el ao del periodo selecionado para que no se obtenga ms de
                un regisro.
*******************************************************************************/

  -- declaracin de variables:
  vnExists       INTEGER      := 0;
  vnColumnas     INTEGER      := 35;
  vgsInicioPag   VARCHAR2(30) := NULL;         -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vnIdRenglon    INTEGER      := 1;
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);

  vsTerm         SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsProgr        SARADAP.SARADAP_PROGRAM_1%TYPE       DEFAULT NULL;

  -- obtiene la informacin de los alumnos:
  CURSOR cuReporte ( psTerm    VARCHAR2  DEFAULT NULL,
                     psProgr   VARCHAR2  DEFAULT NULL ) IS

     SELECT DISTINCT F_GET_RUT(SP.SPRIDEN_PIDM)                                                      RUT,
            SP.SPRIDEN_ID                                                                            ID,
            UPPER(REPLACE(REPLACE(SP.SPRIDEN_LAST_NAME, '*', ' '), '  ', ' ' ))                      APELLIDOS,
            UPPER(REPLACE(REPLACE(SP.SPRIDEN_FIRST_NAME||' '||SP.SPRIDEN_MI,'   ', ' '), '  ', ' ')) NOMBRE,
            DECODE((SELECT COUNT(*) FROM SGBSTDN
                     WHERE SGBSTDN_PIDM = SA.SARADAP_PIDM
                       AND SGBSTDN_TERM_CODE_EFF = psTerm), 0, NULL, 'INGRESADO')                    REGISTRO_ALUMNO,
            (SELECT SGBSTDN_PROGRAM_1 FROM SGBSTDN
              WHERE SGBSTDN_PIDM = SA.SARADAP_PIDM
                AND SGBSTDN_TERM_CODE_EFF = psTerm
                AND ROWNUM=1)                                                  CARRERA_REG_ALUM,
            SA.SARADAP_PROGRAM_1                                                                     CARRERA_POSTUL,
            TO_CHAR(TRUNC(SA.SARADAP_APPL_DATE),'DD/MM/YYYY')                                        FEC_POSTUL,
            SA.SARADAP_ADMT_CODE                                                                     TIPO_ADMISION,
            SWVTAVI_RTYP_CODE         VIA,
            SA.SARADAP_APPL_PREFERENCE                                                               PREFERENCIA,
            (SELECT COUNT(DISTINCT(SARADAP_APPL_NO))
               FROM SARADAP
              WHERE SARADAP_PIDM = SA.SARADAP_PIDM
                AND SARADAP_TERM_CODE_ENTRY = psTerm)                                                NUM_POSTULACIONES,
            (SELECT DISTINCT(SARAPPD_APDC_CODE)
               FROM SARAPPD A
              WHERE A.SARAPPD_PIDM = SA.SARADAP_PIDM
                AND A.SARAPPD_TERM_CODE_ENTRY = SA.SARADAP_TERM_CODE_ENTRY
                AND A.SARAPPD_APPL_NO = SA.SARADAP_APPL_NO
                AND ROWNUM=1
                AND A.SARAPPD_SEQ_NO = ( SELECT MAX(SARAPPD_SEQ_NO)
                                           FROM SARAPPD
                                          WHERE SARAPPD_PIDM = A.SARAPPD_PIDM
                                            AND SARAPPD_APPL_NO = SA.SARADAP_APPL_NO) )              DECISION,
            NVL(SUBSTR(TO_CHAR(CH.SORHSCH_GRADUATION_DATE,'DD/MM/YYYY'),7,10), NULL)                 ANO_EGRESO,
            UPPER(PK_CATALOGO.PREPARATORIA (CH.SORHSCH_SBGI_CODE))                                   COLEGIO,
            (SELECT SOBSBGI_STAT_CODE FROM SOBSBGI
              WHERE SOBSBGI_SBGI_CODE = CH.SORHSCH_SBGI_CODE)                                        REGION_COL,
            (SELECT SOBSBGI_CNTY_CODE FROM SOBSBGI
              WHERE SOBSBGI_SBGI_CODE = CH.SORHSCH_SBGI_CODE)                                        COMUNA_COL,
            (SELECT UPPER(ST.STVBCHR_DESC)
               FROM SORBCHR HR, STVBCHR ST
              WHERE HR.SORBCHR_BCHR_CODE <> 'L'
                AND HR.SORBCHR_DEMO_YEAR = SUBSTR(psTerm, 1, 4)                 -- lnea hmr
                AND HR.SORBCHR_BCHR_CODE = ST.STVBCHR_CODE
                AND HR.SORBCHR_SBGI_CODE = CH.SORHSCH_SBGI_CODE)                                     DEPEND_COL,
            (SELECT DECODE(LE.SPRTELE_PHONE_AREA, NULL, '', '('||LE.SPRTELE_PHONE_AREA||') ' )||
                    LE.SPRTELE_PHONE_NUMBER||
                    DECODE( LE.SPRTELE_PHONE_EXT, NULL, '', (' EXT. '||LE.SPRTELE_PHONE_EXT) )
               FROM SPRTELE LE
              WHERE LE.SPRTELE_SEQNO = (SELECT MAX(SPRTELE_SEQNO)
                                          FROM SPRTELE
                                         WHERE SPRTELE_TELE_CODE = 'TFPA'
                                           AND LE.SPRTELE_PIDM = SPRTELE_PIDM
                                           AND LE.SPRTELE_SEQNO = SPRTELE_SEQNO)
                AND SP.SPRIDEN_PIDM = LE.SPRTELE_PIDM
                AND ROWNUM = 1)                                                                      TEL_FIJO,
            (SELECT '('||NVL(LE.SPRTELE_PHONE_AREA,' 0 ')||') '||LE.SPRTELE_PHONE_NUMBER
               FROM SPRTELE LE
              WHERE LE.SPRTELE_SEQNO = (SELECT MIN(SPRTELE_SEQNO)
                                          FROM SPRTELE
                                         WHERE SPRTELE_TELE_CODE = 'TMPA'
                                           AND LE.SPRTELE_PIDM = SPRTELE_PIDM
                                           AND LE.SPRTELE_SEQNO = SPRTELE_SEQNO)
                AND SP.SPRIDEN_PIDM = LE.SPRTELE_PIDM
                AND ROWNUM = 1)                                                                      TEL_MOVIL,
            BANINST1.PK_DESCRIPCIONES.F_GETMAIL (SP.SPRIDEN_PIDM)                                    E_MAIL,
            NVL(SUBSTR(TO_CHAR(SU.SWBEPSU_ACTIVITY_DATE,'DD/MM/YYYY'),7,10), NULL)                   ANO_PSU,
            F_PUNTAJE (SA.SARADAP_PIDM, 'PSLC')                                                      PSLC,
            F_PUNTAJE (SA.SARADAP_PIDM, 'PSMA')                                                      PSMA,
            F_PUNTAJE (SA.SARADAP_PIDM, 'PSCI')                                                      PSCI,
            F_PUNTAJE (SA.SARADAP_PIDM, 'PSHC')                                                      PSHC,
            F_PUNTAJE (SA.SARADAP_PIDM, 'NEM')                                                       NEM,
            --aigui 20120427: se agrega columna PEM para IHERNANDEZ
            F_PUNTAJE (SA.SARADAP_PIDM, 'PEM')                                                       PEM,
            F_PUNTAJE (SA.SARADAP_PIDM, 'NEME')                                                      NEME,
            F_PROMEDIO_PSU (SA.SARADAP_PIDM)                                                         PUNT_PSU_PROM,
            BANINST1.F_PONDERADOA (SA.SARADAP_PIDM, SA.SARADAP_PROGRAM_1)                                      PUNT_UFTA,
            F_BECAAUT (SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1)                                BECA_AUTA,
            F_BECACOL (SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1)                                BECA_COL,
            F_BECAREG (SA.SARADAP_PIDM, psTerm,SORHSCH_SBGI_CODE )                              BECA_REG,
            F_BECAPOS (SA.SARADAP_PIDM, psTerm, SA.SARADAP_PROGRAM_1)                                BECA_POS,
            DECODE(SA.SARADAP_PROGRAM_1, 'LC-ACTU-13',F_PUNTAJE (SA.SARADAP_PIDM, 'PETE'),NULL) PUNT_ESP,
            --f_PtjPondSel(SA.SARADAP_PIDM, SA.SARADAP_TERM_CODE_ENTRY, SA.SARADAP_APPL_NO, SA.SARAPPD_SEQ_NO)            PtjPondSel
            (select nvl(substr(SARQUAN_ANSWER, 1, 3)||','||substr(SARQUAN_ANSWER, 4, 2), null)
            from SARQUAN
            where SARQUAN_PIDM = SA.SARADAP_PIDM
              and SARQUAN_TERM_CODE_ENTRY = SA.SARADAP_TERM_CODE_ENTRY
              and SARQUAN_APPL_NO = SA.SARADAP_APPL_NO
              AND ROWNUM=1
              and SARQUAN_ADMR_CODE = 'PPON')                                                 PtjPondSel
       FROM SPRIDEN  SP,
            SARADAP  SA,
            SWVTAVI  VI,
            SORHSCH  CH,
            SWBEPSU  SU,
            SPBPERS  SB,
            SGBSTDN  DN
      WHERE SP.SPRIDEN_CHANGE_IND IS NULL
        AND SP.SPRIDEN_PIDM = SA.SARADAP_PIDM
        AND DN.SGBSTDN_PIDM NOT IN ( SELECT DISTINCT(TR.TWBCNTR_PIDM)
                                       FROM TWBCNTR TR
                                      WHERE TR.TWBCNTR_PIDM = SA.SARADAP_PIDM
                                        AND TR.TWBCNTR_STATUS_IND = 'A'
                                        AND TR.TWBCNTR_TERM_CODE = psTerm
                                        AND TR.TWBCNTR_ACTIVITY_DATE = (SELECT MAX(TWBCNTR_ACTIVITY_DATE)
                                                                          FROM TWBCNTR
                                                                         WHERE TWBCNTR_PIDM = TR.TWBCNTR_PIDM)
                                        and not exists (select 1
                                            from twbretr
                                            where twbretr_cntr_num = twbcntr_num))
        AND SA.SARADAP_PIDM = CH.SORHSCH_PIDM(+)
        AND SA.SARADAP_PIDM = SB.SPBPERS_PIDM(+)
        AND SA.SARADAP_TERM_CODE_ENTRY = psTerm
        AND SA.SARADAP_PIDM = DN.SGBSTDN_PIDM(+)
        and sa.saradap_admt_code = SWVTAVI_ADMT_CODE
        AND SA.SARADAP_TERM_CODE_ENTRY = VI.SWVTAVI_TERM_CODE
        AND (SA.SARADAP_PROGRAM_1 = psProgr OR psProgr IS NULL)
        AND SB.SPBPERS_NAME_SUFFIX = SU.SWBEPSU_RUT(+)
      ORDER BY F_GET_RUT(SP.SPRIDEN_PIDM), SARADAP_PROGRAM_1;

---------------------------------------------------
-- bloque principal para la generacin del reporte
---------------------------------------------------
BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
   vsProgr := pk_ObjHtml.getValueCookie('psProgr');

   -- determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   -- define los encabezados de las columnas:
   tabColumna(1)  := '<center> RUT';
   tabColumna(2)  := '<center> ID';
   tabColumna(3)  := '<center> Apellidos';
   tabColumna(4)  := '<center> Nombre';
   tabColumna(5)  := '<center> Registro <br> de <br> alumno';
   tabColumna(6)  := '<center> Carrera registro alumno';
   tabColumna(7)  := '<center> Carrera <br>de <br> postulaci&oacute;n';
   tabColumna(8)  := '<center> Fecha <br>de <br> postulaci&oacute;n';
   tabColumna(9)  := '<center> Tipo <br>de <br>  admisi&oacute;n';
   tabColumna(10)  := '<center> V&iacutea <br>de Admisi&oacute;n';
   tabColumna(11) := '<center> Preferencia';
   tabcolumna(12) := '<center> N&uacute;mero <br>de postulaciones';
   tabColumna(13) := '<center> Decisi&oacute;n';
   tabColumna(14) := '<center> Ao Egreso E.M.';
   tabColumna(15) := '<center> Colegio';
   tabColumna(16) := '<center> Regi&oacute;n colegio';
   tabColumna(17) := '<center> Comuna colegio';
   tabColumna(18) := '<center> Dependencia colegio';
   tabColumna(19) := '<center> Tel&eacute;fono fijo';
   tabColumna(20) := '<center> Tel&eacute;fono mvil';
   tabColumna(21) := '<center> E-mail';
   tabColumna(22) := '<center> Ao PSU';
   tabColumna(23) := '<center> PSLC';
   tabColumna(24) := '<center> PSMA';
   tabColumna(25) := '<center> PSCI';
   tabColumna(26) := '<center> PSHC';
   tabColumna(27) := '<center> Puntaje Especial';
   --aigui 20120427: se elimina la columna NEM y se agrega la coluna PEM
   --a petiticin de IHERNANDEZ
   --tabColumna(28) := '<center> NEM';
   tabColumna(28) := '<center> NEM';
   tabColumna(29) := '<center> NEM equivalente';
   tabColumna(30) := '<center> Punt. PSU Promedio (PSLC+PSMA)/2';
   --tabColumna(31) := '<center> Punt. UFT (C&aacute;lculo ponderado)';
   tabColumna(31) := '<center> Ptj Pond Seleccin';
   tabColumna(32) := '<center> % Beca autom&aacute;tica PSU';
   tabColumna(33) := '<center> % Beca colegio origen';
   tabColumna(34) := '<center> % Beca Regi&oacute;n';
   tabColumna(35) := '<center> % Beca Postula';
   --tabColumna(36) := '<center> Ptj Pond Seleccin';

   -- manipula la informacin obtenida por el cursor:
   FOR regRep IN cuReporte (vsTerm, vsProgr) LOOP

       IF vnExists = 0 THEN

          -- muestra el encabezado segn el periodo y programa seleccionados:
          IF vsProgr IS NOT NULL THEN
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||'<br>'||'Programa: &nbsp;'||vsProgr||' - '||Pk_Catalogo.Programa(vsProgr),
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
          ELSE
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||'<br>'||'Programa: &nbsp;'||'Todos ',
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
          END IF;

       END IF;

       -- muestra los valores para cada registro:
       HTP.P('<tr> <td valign="top" align="left">'   ||regRep.RUT               ||'</td>
                   <td valign="top" align="left">'   ||regRep.ID                ||'</td>
                   <td valign="top" align="left">'   ||regRep.APELLIDOS         ||'</td>
                   <td valign="top" align="left">'   ||regRep.NOMBRE            ||'</td>
                   <td valign="top" align="left">'   ||regRep.REGISTRO_ALUMNO   ||'</td>
                   <td valign="top" align="left">'   ||regRep.CARRERA_REG_ALUM  ||'</td>
                   <td valign="top" align="left">'   ||regRep.CARRERA_POSTUL    ||'</td>
                   <td valign="top" align="center">' ||regRep.FEC_POSTUL        ||'</td>
                   <td valign="top" align="center">' ||regRep.TIPO_ADMISION     ||'</td>
                   <td valign="top" align="center">' ||regRep.VIA       ||'</td>
                   <td valign="top" align="center">' ||regRep.PREFERENCIA       ||'</td>
                   <td valign="top" align="center">' ||regRep.NUM_POSTULACIONES ||'</td>
                   <td valign="top" align="center">' ||regRep.DECISION          ||'</td>
                   <td valign="top" align="center">' ||regRep.ANO_EGRESO        ||'</td>
                   <td valign="top" align="left">'   ||regRep.COLEGIO           ||'</td>
                   <td valign="top" align="center">' ||regRep.REGION_COL        ||'</td>
                   <td valign="top" align="center">' ||regRep.COMUNA_COL        ||'</td>
                   <td valign="top" align="left">'   ||regRep.DEPEND_COL        ||'</td>
                   <td valign="top" align="rigth">'  ||regRep.TEL_FIJO          ||'</td>
                   <td valign="top" align="rigth">'  ||regRep.TEL_MOVIL         ||'</td>
                   <td valign="top" align="left">'   ||regRep.E_MAIL            ||'</td>
                   <td valign="top" align="center">' ||regRep.ANO_PSU           ||'</td>
                   <td valign="top" align="center">' ||regRep.PSLC              ||'</td>
                   <td valign="top" align="center">' ||regRep.PSMA              ||'</td>
                   <td valign="top" align="center">' ||regRep.PSCI              ||'</td>
                   <td valign="top" align="center">' ||regRep.PSHC              ||'</td>
                   <td valign="top" align="center">' ||regRep.PUNT_ESP          ||'</td>
                   <td valign="top" align="center">'
                   --aigui 20120427: se elimina la columna NEM y se Agrega PEM
                   /*||regRep.NEM               ||'</td>
                   <td valign="top" align="center">' */||regRep.PEM             ||'</td>
                   <td valign="top" align="center">' ||regRep.NEME              ||'</td>
                   <td valign="top" align="center">' ||regRep.PUNT_PSU_PROM     ||'</td>'||
                   --<td valign="top" align="center">' ||regRep.PUNT_UFTA         ||'</td>
                   '<td valign="top" align="center">' ||regRep.PtjPondSel        ||'</td>
                   <td valign="top" align="center">' ||regRep.BECA_AUTA         ||'</td>
                   <td valign="top" align="center">' ||regRep.BECA_COL          ||'</td>
                   <td valign="top" align="center">' ||regRep.BECA_REG          ||'</td>
                   <td valign="top" align="center">' ||regRep.BECA_POS          ||'</td>
             </tr>');

       vnExists    := 1;
       vnIdRenglon := vnIdRenglon + 1;

   END LOOP;

   -- muestra el pie de reporte:
   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- omite el encabezado del reporte pero se agrega el salto de pgina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRSEG2;
/


DROP PUBLIC SYNONYM PWRSEG2;

CREATE PUBLIC SYNONYM PWRSEG2 FOR BANINST1.PWRSEG2;


GRANT EXECUTE ON BANINST1.PWRSEG2 TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRSEG2 TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRSEG2 TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRSEG2 TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRSEG2 TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRSEPA;

CREATE OR REPLACE PROCEDURE BANINST1.PWRSEPA (psReclDesc VARCHAR2,
                                              psPidm     VARCHAR2 DEFAULT NULL,
                                              psTerm     VARCHAR2 DEFAULT NULL,
                                              psVia      VARCHAR2 DEFAULT NULL,
                                              psCohor    VARCHAR2 DEFAULT NULL,
                                              psEscu    VARCHAR2 DEFAULT NULL,
                                              psAccion   VARCHAR2 DEFAULT NULL) IS


   /*******************************************************************************
   tarea: procedimiento que genera el reporte para seguimiento de estudiantes de primer ao
   mdulo: admisiones - uft.
   autor: RRA- Pablo Serratos
   fecha: 14/08/2013.
   *******************************************************************************/

  -- declaracin de variables:
  vnExists       INTEGER      := 0;
  vnColumnas     INTEGER      := 24;
  -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vgsInicioPag   VARCHAR2(30) := NULL;
  vnIdRenglon    INTEGER      := 1;
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);

   vsTerm        VARCHAR2(30) := NULL;
   vsVia         VARCHAR2(30) := NULL;
   vsCohor       VARCHAR2(30) := NULL;
   vsEscu        VARCHAR2(30) := NULL;

   vsAst         VARCHAR2(1) := '*';
   vsEsp         VARCHAR2(1) := ' ';
   vsA           VARCHAR2(4) := CHR(39)||'A'||CHR(39);
   vsAl          VARCHAR2(4) := 'A';
   vsNivIng      VARCHAR2(20) := 'Niveles de Ingles';
   vn2           NUMBER := 2;
   vn1           NUMBER := 1;
   vn0           NUMBER := 0;


   vsCO07V VARCHAR2(15) := 'LI-INCO-07V';
   vsCO00V VARCHAR2(15) := 'LI-INCO-00V';
   vsCO02V VARCHAR2(15) := 'LI-INCO-02V';
   vsRE01V VARCHAR2(15) := 'LI-DERE-01V';
   vsRE00V VARCHAR2(15) := 'LI-DERE-00V';
   vsMC04  VARCHAR2(15) := 'LI-PRMC-04';
   vsME07  VARCHAR2(15) := 'LI-EDME-07';
   vsME00  VARCHAR2(15) := 'LI-EDME-00';
   vsRE11V VARCHAR2(15) := 'LC-DERE-11V';
   vsMC11  VARCHAR2(15) := 'LC-PRMC-11';
   vsMC10  VARCHAR2(15) := 'LC-PRMC-10';
   vsMC08  VARCHAR2(15) := 'LC-PRMC-08';
   vsME11A VARCHAR2(15) := 'LC-EDME-11A';
   vsME11  VARCHAR2(15) := 'LC-EDME-11';


  -- obtiene la informacin de los alumnos:
  CURSOR cuReporte (psTerm     VARCHAR2  DEFAULT NULL,
                    psVia      VARCHAR2  DEFAULT NULL,
                    psCohorte  VARCHAR2  DEFAULT NULL,
                    psEscu  VARCHAR2  DEFAULT NULL) IS
SELECT  SPRIDEN_ID                                        id,
        SPBPERS_NAME_SUFFIX                               rut,
        INITCAP(SPRIDEN_FIRST_NAME)                       nombre,
        INITCAP(REPLACE(SPRIDEN_LAST_NAME,vsAst,vsEsp))   apellidos,
        SGBSTDN_TERM_CODE_ADMIT                           prdoIngreso,
        SGBSTDN_PROGRAM_1                                 programa,
        pk_catalogo.Programa(SGBSTDN_PROGRAM_1) descr,
        --SGBSTDN_COLL_CODE_1                               escuela,
        (SELECT MAX(STVCOLL_DESC)
           FROM STVCOLL
          WHERE  STVCOLL_CODE = S.SGBSTDN_COLL_CODE_1)    escuela,
        TWBCNTR_NUM                                       noContrato ,
        (SELECT NVL(STVADMT_DESC,'SIN DESCRIPCIN')
           FROM STVADMT
          WHERE STVADMT_CODE = SWVTAVI_ADMT_CODE)         viaAdmision,
        (SELECT NVL(STVRTYP_DESC,'SIN DESCRIPCIN')
           FROM STVRTYP
          WHERE STVRTYP_CODE = SWVTAVI_RTYP_CODE)         tipoAdmision,
        BANINST1.Periodos(S.SGBSTDN_PIDM,
                          psTerm,S.SGBSTDN_LEVL_CODE)     periodos,
        BANINST1.Convalidados(
         psTerm,SGBSTDN_PIDM,
         psVia, psCohorte, psEscu)                        noAsigConv,
         BANINST1.Homologados(
         psTerm,SGBSTDN_PIDM,
         psVia, psCohorte, psEscu)                        noAsigHomo,
        BANINST1.Inscritas(SGBSTDN_PIDM,psTerm)           noAsigInsc,
        vsNivIng                                          nivelIngAp,
        BANINST1.promedioIngles(TO_CHAR(SGBSTDN_PIDM),
                                SUBSTR(psTerm,1,4))       PromedioIngles,
        PK_CATALOGO.STASTST (SGBSTDN_STST_CODE)           Status,
        (SELECT STVSTYP_DESC
           FROM STVSTYP
          WHERE STVSTYP_CODE = SGBSTDN_STYP_CODE) AS      tipoAlumno,
        (SELECT TRUNC(SHRTGPA_GPA ,vn2) PGPA
           FROM SHRTGPA
          WHERE (SHRTGPA_TERM_CODE = psTerm
                 OR psTerm IS NULL)
             AND SHRTGPA_PIDM = S.SGBSTDN_PIDM
             AND SHRTGPA_LEVL_CODE =
                 S.SGBSTDN_LEVL_CODE)                     pPeriodo,
        (SELECT ROUND
                 (DECODE(
                   SUM(SHRTGPA_QUALITY_POINTS), vn0, vn0,
                   SUM(SHRTGPA_QUALITY_POINTS) /
                   SUM(SHRTGPA_GPA_HOURS)),vn2)
           FROM SHRTGPA
          WHERE SHRTGPA_PIDM = SGBSTDN_PIDM)              promedioACumulado,
        MAX(TRIM(LEADING '0' FROM SGBUSER_SUDE_CODE))     porcentajeAvance,
       (SELECT MAX(SORTEST_TEST_SCORE)
          FROM SORTEST
         WHERE SORTEST_TESC_CODE       = 'PEM'
           AND SORTEST_PIDM            = SGBSTDN_PIDM
           AND SUBSTR(SORTEST_TERM_CODE_ENTRY,1,4) =
               SUBSTR(psTerm,1,4) )                       PEM,
         (SELECT MAX(SORTEST_TEST_SCORE)
          FROM SORTEST
         WHERE SORTEST_TESC_CODE       = 'PRAN'
           AND SORTEST_PIDM            = SGBSTDN_PIDM
           AND SUBSTR(SORTEST_TERM_CODE_ENTRY,1,4) =
               SUBSTR(psTerm,1,4) )                       PRAN,
       MAX(
       (SELECT SUBSTR(SARQUAN_ANSWER,1,3)||','||SUBSTR(SARQUAN_ANSWER,4,2)
          FROM SARQUAN G
         WHERE G.SARQUAN_ADMR_CODE = 'PPON'
           AND G.SARQUAN_PIDM      = S.SGBSTDN_PIDM
           AND G.SARQUAN_PIDM      = A.SARADAP_PIDM
           AND G.SARQUAN_TERM_CODE_ENTRY = A.SARADAP_TERM_CODE_ENTRY
           AND A.SARADAP_APPL_NO   = (SELECT MAX(Y.SARADAP_APPL_NO)
                                        FROM SARADAP Y
                                       WHERE S.SGBSTDN_PIDM          = Y.SARADAP_PIDM
                                         AND S.SGBSTDN_TERM_CODE_EFF = Y. SARADAP_TERM_CODE_ENTRY
                                         AND S.SGBSTDN_PROGRAM_1     = Y.SARADAP_PROGRAM_1)
           AND G.SARQUAN_TERM_CODE_ENTRY = S.SGBSTDN_TERM_CODE_EFF
           AND SARQUAN_APPL_NO     = A.SARADAP_APPL_NO
           AND ROWNUM              = 1)  ) PPON
   FROM SPRIDEN,
        SPBPERS,
        SGBSTDN S,
        TWBCNTR,
        SWVTAVI,
        SARADAP A,
        SHRTCKN N,
        SHRTCKG G,
        SGBUSER U,
        SGRCHRT Z,
        SARAATT
  WHERE SPRIDEN_CHANGE_IND IS NULL
    AND TWBCNTR_STATUS_IND = vsAl
    AND SGBSTDN_TERM_CODE_ADMIT  = psTerm
    AND (SWVTAVI_RTYP_CODE = psVia OR psVia IS NULL)
    AND (SGRCHRT_CHRT_CODE  = psCohorte OR psCohorte IS NULL)
    AND (S.SGBSTDN_COLL_CODE_1 = psEscu OR psEscu IS NULL)
    AND SARADAP_PROGRAM_1 NOT IN (
        vsCO07V, vsCO00V, vsCO02V, vsRE01V, vsRE00V,
        vsMC04, vsME07, vsME00, vsRE11V, vsMC11,
        vsMC10, vsMC08, vsME11A,vsME11)
    AND (
          G.SHRTCKG_SEQ_NO IS NULL
        OR
          G.SHRTCKG_SEQ_NO =
           (SELECT MAX (G1.SHRTCKG_SEQ_NO)
              FROM SHRTCKG G1
             WHERE G1.SHRTCKG_PIDM = G.SHRTCKG_PIDM
               AND G1.SHRTCKG_TERM_CODE = G.SHRTCKG_TERM_CODE
               AND G1.SHRTCKG_TCKN_SEQ_NO = G.SHRTCKG_TCKN_SEQ_NO)
           )
    AND S.SGBSTDN_TERM_CODE_EFF =
           (SELECT max (SS.SGBSTDN_TERM_CODE_EFF)
              FROM SGBSTDN SS
             WHERE SGBSTDN_PIDM = SPRIDEN_PIDM)
    AND A.SARADAP_APPL_NO =
           (SELECT MAX(B.SARADAP_APPL_NO)
              FROM SARADAP B
             WHERE B.SARADAP_PROGRAM_1 = S.SGBSTDN_PROGRAM_1
               AND B.SARADAP_PIDM = S.SGBSTDN_PIDM
               AND SARADAP_TERM_CODE_ENTRY = psTerm)
    AND(
        Z.SGRCHRT_TERM_CODE_EFF IS NULL
        OR
          Z.SGRCHRT_TERM_CODE_EFF =
                    (SELECT MAX(C.SGRCHRT_TERM_CODE_EFF)
                       FROM SGRCHRT C
                      WHERE C.SGRCHRT_PIDM = S.SGBSTDN_PIDM
                        AND C.SGRCHRT_TERM_CODE_EFF <= psTerm)
       )
    AND SARAATT_TERM_CODE = TWBCNTR_TERM_CODE
    AND SARAATT_PIDM = TWBCNTR_PIDM
    AND S.SGBSTDN_PIDM       = SPRIDEN_PIDM
    AND S.SGBSTDN_PIDM       = SPBPERS_PIDM
    AND S.SGBSTDN_PIDM       = TWBCNTR_PIDM
    AND TWBCNTR_TERM_CODE    = SARADAP_TERM_CODE_ENTRY
    AND SWVTAVI_ADMT_CODE    = S.SGBSTDN_ADMT_CODE
    AND SWVTAVI_TERM_CODE    = SARADAP_TERM_CODE_ENTRY
    AND S.SGBSTDN_PIDM       = SARADAP_PIDM
    AND S.SGBSTDN_PROGRAM_1  = SARADAP_PROGRAM_1
    AND S.SGBSTDN_PIDM       = SHRTCKG_PIDM(+)
    AND S.SGBSTDN_PIDM       = SGBUSER_PIDM(+)
    AND S.SGBSTDN_PIDM        = SGRCHRT_PIDM(+)
    AND G.SHRTCKG_PIDM        = N.SHRTCKN_PIDM(+)
    AND G.SHRTCKG_TERM_CODE   = N.SHRTCKN_TERM_CODE(+)
    AND G.SHRTCKG_TCKN_SEQ_NO = N.SHRTCKN_SEQ_NO(+)
  GROUP BY SPRIDEN_ID,
        S.SGBSTDN_PIDM,
        S.SGBSTDN_LEVL_CODE,
        SPBPERS_NAME_SUFFIX,
        SPRIDEN_FIRST_NAME,
        SPRIDEN_LAST_NAME,
        SGBSTDN_TERM_CODE_ADMIT,
        SGBSTDN_PROGRAM_1,
        SGBSTDN_COLL_CODE_1,
        TWBCNTR_NUM,
        SGBSTDN_STST_CODE,
        SGBSTDN_STST_CODE,
        SGBSTDN_STYP_CODE,
        SWVTAVI_RTYP_CODE,
        SWVTAVI_ADMT_CODE
    ORDER BY SPRIDEN_ID;

   --cdigo java script
   --js
   PROCEDURE js
   IS
   BEGIN

      HTP.P ('

              <script type="text/javascript">
               function fLovMate(psRep,psPidm, psTerm,psVia,psCohor,psEscu) {
window.open("PWRSEPD?psRep=" + psRep+"&psPIDM=" + psPidm+"&psTerm=" + psTerm+"&psVia=" + psVia+"&psCohor=" + psCohor+"&psEscu=" + psEscu,"DocumentoID","toolbar=no,status=no,scrollbars=yes,top=50,left=50,height=550,width=550");
           } //fLovMate
           </script>
        ');
          END js;



---------------------------------------------------
-- bloque principal para la generacin del reporte
---------------------------------------------------
BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsTerm   := pk_ObjHtml.getValueCookie('psTerm');
   vsVia    := pk_ObjHtml.getValueCookie('psVia');
   vsCohor  := pk_ObjHtml.getValueCookie('psCohor');
   vsEscu   := pk_ObjHtml.getValueCookie('psEscu');
   --vsProgr

   -- determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   -- define los encabezados de las columnas:
   tabColumna(1)  := '<left> ID';
   tabColumna(2)  := '<left> RUT';
   tabColumna(3)  := '<left> Nombre';
   tabColumna(4)  := '<left> Apellidos';
   tabColumna(5)  := '<left> Periodo de<br>Ingreso';
   tabColumna(6)  := '<left> Escuela';
   tabColumna(7)  := '<left> Nombre Carrera';
   tabColumna(8)  := '<left> Programa';
   tabColumna(9)  := '<left> Numero de<br>contrato';
   tabColumna(10)  := '<left> Tipo de<br>Admisin';
   tabColumna(11)  := '<left> Va de<br>Admisin';
   tabColumna(12) := '<left> Perodo-GPA';
   tabColumna(13) := '<left> N asignaturas<br>Convalidadas';
   tabColumna(14) := '<left> N asignaturas<br>Homologadas';
   tabColumna(15) := '<left> N asignaturas<br>Inscritas';
   tabColumna(16) := '<left> Nivel de Ingls<br>Aprobado';
   tabColumna(17) := '<left> Materias Ingls<br>al Periodo';
   tabColumna(18) := '<left> Status del<br>Alumno';
   tabColumna(19) := '<left> Tipo de<br>Alumno';
   tabColumna(20) := '<left> Promedio<br>Acumulado';
   tabColumna(21) := '<left> Porcentaje de<br>Avance';
   tabColumna(22) := '<left> PEM';
   tabColumna(23) := '<left> PRAN';
   tabColumna(24) := '<left> Puntaje Ponderado <br> de Seleccin';

   FOR regRep IN cuReporte (vsTerm,vsVia,vsCohor,vsEscu) LOOP

       IF vnExists = 0 THEN
          -- muestra el encabezado segn el periodo y programa seleccionados:
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)/*||'<br>'||'Escuela: &nbsp;'||vsEscu||' - '||Pk_Catalogo.Colegio(vsEscu)*/,
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
       END IF;

       IF vsVia IS NULL THEN
         vsVia := 'NULL';
       END IF;

       IF vsCohor IS NULL  THEN
         vsCohor := 'NULL';
       END IF;

       IF vsEscu IS NULL THEN
         vsEscu := 'NULL';
       END IF;


       HTP.P('<tr> <td valign="top" align="center">'  ||regRep.id ||'</td>
                   <td valign="top" align="center">'   ||regRep.rut ||'</td>
                   <td valign="top" align="center">'   ||regRep.nombre ||'</td>
                   <td valign="top" align="center">'   ||regRep.apellidos ||'</td>
                   <td valign="top" align="center">'   ||regRep.prdoIngreso ||'</td>
                   <td valign="top" align="center">'   ||regRep.escuela ||'</td>
                   <td valign="top" align="center">'   ||regRep.descr ||'</td>
                   <td valign="top" align="center">'   ||regRep.programa ||'</td>
                   <td valign="top" align="center">'  ||regRep.noContrato ||'</td>
                   <td valign="top" align="center">'  ||regRep.viaAdmision ||'</td>
                   <td valign="top" align="center">'  ||regRep.tipoAdmision ||'</td>
                   <td valign="top" align="center">'  ||regRep.periodos ||'</td>
                   <td valign="top" align="center">
                    <a href="javascript:fLovMate(''C'','''
                   || F_GET_PIDM (regRep.id)
                   || ''','''
                   || vsTerm
                   || ''','''
                   || vsVia
                   || ''','''
                   || vsCohor
                   || ''','''
                   || vsEscu
                   || ''')">'
                   || regRep.noAsigConv
                   || '</a></td>
                   <td valign="top" align="center">
                   <a href="javascript:fLovMate(''H'','''
                   || F_GET_PIDM (regRep.id)
                   || ''','''
                   || vsTerm
                   || ''','''
                   || vsVia
                   || ''','''
                   || vsCohor
                   || ''','''
                   || vsEscu
                   || ''')">'
                   || regRep.noAsigHomo
                   || '</a></td>
                   <td valign="top" align="center">
                   <a href="javascript:fLovMate(''IN'','''
                   || F_GET_PIDM (regRep.id)
                   || ''','''
                   || vsTerm
                   || ''','''
                   || vsVia
                   || ''','''
                   || vsCohor
                   || ''','''
                   || vsEscu
                   || ''')">'
                   || regRep.noAsigInsc
                   || '</a></td>
                   <td valign="top" align="center">
                    <a href="javascript:fLovMate(''A'','''
                   || F_GET_PIDM (regRep.id)
                   || ''','''
                   || vsTerm
                   || ''','''
                   || vsVia
                   || ''','''
                   || vsCohor
                   || ''','''
                   || vsEscu
                   || ''')">'
                   || regRep.nivelIngAp
                   || '</a></td>
                   <td valign="top" align="center">
                    <a href="javascript:fLovMate(''P'','''
                   || F_GET_PIDM (regRep.id)
                   || ''','''
                   || vsTerm
                   || ''','''
                   || vsVia
                   || ''','''
                   || vsCohor
                   || ''','''
                   || vsEscu
                   || ''')">'
                   || regRep.PromedioIngles
                   || '</td>
                   <td valign="top" align="center">'  ||regRep.status ||'</td>
                   <td valign="top" align="center">'  ||regRep.tipoAlumno ||'</td>
                   <td valign="top" align="center">'  ||regRep.promedioACumulado ||'</td>
                   <td valign="top" align="center">'  ||regRep.porcentajeAvance ||'</td>
                   <td valign="top" align="center">'  ||regRep.PEM ||'</td>
                   <td valign="top" align="center">'  ||regRep.PRAN ||'</td>
                   <td valign="top" align="center">'  ||regRep.PPON ||'</td>
             </tr>');

       vnExists    := 1;
       vnIdRenglon := vnIdRenglon + 1;
   -- END IF;
   END LOOP;
      --cdigo java script
      js;

   -- muestra el pie de reporte:
   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- omite el encabezado del reporte pero se agrega el salto de pgina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRSEPA;
/


DROP PUBLIC SYNONYM PWRSEPA;

CREATE PUBLIC SYNONYM PWRSEPA FOR BANINST1.PWRSEPA;


GRANT EXECUTE ON BANINST1.PWRSEPA TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRSEPD;

CREATE OR REPLACE PROCEDURE BANINST1.PWRSEPD (psRep      VARCHAR2 DEFAULT NULL,
                                              psPidm     VARCHAR2 DEFAULT NULL,
                                              psTerm     VARCHAR2 DEFAULT NULL,
                                              psVia      VARCHAR2 DEFAULT NULL,
                                              psCohor    VARCHAR2 DEFAULT NULL,
                                              psEscu     VARCHAR2 DEFAULT NULL) IS


   /*******************************************************************************
   tarea: procedimiento que genera el reporte para seguimiento de estudiantes de primer ao
   mdulo: admisiones - uft.
   autor: RRA- Pablo Serratos
   fecha: 14/08/2013.
   *******************************************************************************/

    psAccion  VARCHAR2(100) ;
    vsPidm    VARCHAR2(100) ;
    vsTerm    VARCHAR2(100) ;
    vsVia     VARCHAR2(100);
    vsCohor   VARCHAR2(100) ;
    vsEscu    VARCHAR2(100) ;


   /** Entity record type*/
   TYPE ADV_CRSE_REC IS RECORD (
     R_CODE        SWVHIAC.SWVHIAC_SUBJ%TYPE,
     R_DESC        SWVHIAC.SWVHIAC_CRSE%TYPE);

   /** Entity cursor variable type*/
   TYPE ADV_CRSE_SET IS TABLE OF  ADV_CRSE_REC;
   ADV_CRSE_ITEMS ADV_CRSE_SET;


   /** Entity record type*/
   TYPE ADV_MAT_REC IS RECORD (
     R_CODE        SHRTCKN.SHRTCKN_CRSE_TITLE%TYPE,
     R_DESC        SHRTCKG.SHRTCKG_GRDE_CODE_FINAL%TYPE);

   /** Entity cursor variable type*/
   TYPE ADV_MAT_SET IS TABLE OF  ADV_MAT_REC;
   ADV_MAT_ITEMS ADV_MAT_SET;

   /** Entity record type*/
   TYPE ADV_CRN_REC IS RECORD (
     R_CRN        SHRTCKN.SHRTCKN_CRN%TYPE,
     R_SUB        SHRTCKN.SHRTCKN_SUBJ_CODE%TYPE,
     R_CRS        SHRTCKN.SHRTCKN_CRSE_NUMB%TYPE);

   /** Entity cursor variable type*/
   TYPE ADV_CRN_SET IS TABLE OF  ADV_CRN_REC;
   ADV_CRN_ITEMS ADV_CRN_SET;

   vsSubj    VARCHAR2(5) := CHR(39)||'CCL'||CHR(39);
   vsCaAC    VARCHAR2(4) := CHR(39)||'AC'||CHR(39);
   vsCalN    VARCHAR2(4) := CHR(39)||'N'||CHR(39);

   vsCr01    VARCHAR2(6) := CHR(39)||'IN01'||CHR(39);
   vsCr02    VARCHAR2(6) := CHR(39)||'IN02'||CHR(39);
   vsCr03    VARCHAR2(6) := CHR(39)||'IN03'||CHR(39);
   vsCr3A    VARCHAR2(7) := CHR(39)||'IN03A'||CHR(39);
   vsCr4B    VARCHAR2(7) := CHR(39)||'IN04B'||CHR(39);
   vsCr4C    VARCHAR2(7) := CHR(39)||'IN04C'||CHR(39);
   vsCr4D    VARCHAR2(7) := CHR(39)||'IN04D'||CHR(39);
   vsCr4E    VARCHAR2(7) := CHR(39)||'IN04E'||CHR(39);
   vsCr4F    VARCHAR2(7) := CHR(39)||'IN04F'||CHR(39);
   vsCr4G    VARCHAR2(7) := CHR(39)||'IN04G'||CHR(39);
   vsCr4H    VARCHAR2(7) := CHR(39)||'IN04H'||CHR(39);

   vsINCO07V VARCHAR2(15) := CHR(39)||'LI-INCO-07V'||CHR(39);
   vsINCO00V VARCHAR2(15) := CHR(39)||'LI-INCO-00V'||CHR(39);
   vsINCO02V VARCHAR2(15) := CHR(39)||'LI-INCO-02V'||CHR(39);
   vsDERE01V VARCHAR2(15) := CHR(39)||'LI-DERE-01V'||CHR(39);
   vsDERE00V VARCHAR2(15) := CHR(39)||'LI-DERE-00V'||CHR(39);
   vsPRMC04  VARCHAR2(15) := CHR(39)||'LI-PRMC-04'||CHR(39);
   vsEDME07  VARCHAR2(15) := CHR(39)||'LI-EDME-07'||CHR(39);
   vsEDME00  VARCHAR2(15) := CHR(39)||'LI-EDME-00'||CHR(39);
   vsDERE11V VARCHAR2(15) := CHR(39)||'LC-DERE-11V'||CHR(39);
   vsPRMC11  VARCHAR2(15) := CHR(39)||'LC-PRMC-11'||CHR(39);
   vsPRMC10  VARCHAR2(15) := CHR(39)||'LC-PRMC-10'||CHR(39);
   vsPRMC08  VARCHAR2(15) := CHR(39)||'LC-PRMC-08'||CHR(39);
   vsEDME11A VARCHAR2(15) := CHR(39)||'LC-EDME-11A'||CHR(39);
   vsEDME11  VARCHAR2(15) := CHR(39)||'LC-EDME-11'||CHR(39);

   vsGraG    VARCHAR2(3) := CHR(39)||'G'||CHR(39);
   vsGraX    VARCHAR2(3) := CHR(39)||'X'||CHR(39);

   vsC           VARCHAR2(4) := CHR(39)||'C'||CHR(39);
   vsH           VARCHAR2(4) := CHR(39)||'H'||CHR(39);
   vsAst         VARCHAR2(1) := '*';
   vsEsp         VARCHAR2(1) := ' ';
   vsA           VARCHAR2(4) := CHR(39)||'A'||CHR(39);
   vsAl          VARCHAR2(4) := 'A';
   vsNivIng      VARCHAR2(20) := 'Niveles de Ingles';

   BEGIN

    -- valida que el usuario tenga acceso a la base de datos:
    IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

     -- META tags de Banner
     -- la aplicacin no se guarda en el cache de la maquina.
     PK_ObjHTML.P_NoCache;


     psAccion     := psRep;
     vsPidm    := psPIDM;
     vsTerm    := psTerm;
     vsVia     := psVia;
     vsCohor   := psCohor;
     vsEscu    := psEscu;

    IF psTerm  = 'NULL' THEN
     vsTerm := 'NULL';
    ELSE
     vsTerm := CHR(39)||psTerm||CHR(39);
    END IF;

    IF psVia  = 'NULL' THEN
     vsVia := 'NULL';
    ELSE
     vsVia := CHR(39)||psVia||CHR(39);
    END IF;

    IF psCohor = 'NULL' THEN
     vsCohor := 'NULL';
    ELSE
     vsCohor := CHR(39)||psCohor||CHR(39);
    END IF;

    IF psEscu = 'NULL' THEN
     vsEscu := 'NULL';
    ELSE
     vsEscu := CHR(39)||psEscu||CHR(39);
    END IF;

    HTP.P('
        <html>
            <head>
                <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
                <LINK REL="stylesheet" HREF="/css/web_defaultapp.css" TYPE="text/css">

 <style>
  body.bodyCeroR { margin-left: 2pt; margin-right: 2pt; margin-top: 0pt; margin-bottom: 0pt;}
  td.Estilo2 { font-family: Arial, Helvetica, sans-serif; font-size: 10px; text-align: justify;}
  tr.Estilo3 { font-family: Arial, Helvetica, sans-serif; font-size: 12px; text-align: center;}
  tr.Estilo4 { font-family: Arial, Helvetica, sans-serif; font-size: 12px; text-align: justify}
  tr.Estilo5 { font-family: Arial, Helvetica, sans-serif; font-size: 12px; line-height: 1; text-align: justify;}
  td.Estilo6 { font-family: Arial, Helvetica, sans-serif; line-height: 1; font-size: 12px; text-align: right;}
  td.Estilo11 { border-color: black; border-style: inset; border-width: 12px; font-family: Arial, Helvetica, sans-serif; font-size: 10px; text-align: justify;}
  td.Estilo12 { border-color: black; border-style: inset; border-width: 2px; font-family: Arial, Helvetica, sans-serif; font-size: 10px; text-align: right;}
  tr.Estilo21 { font-family: Arial, Helvetica, sans-serif; font-size: 12px; line-height: 1; text-align: justify;}
  td.Estilo22 { font-family: Arial, Helvetica, sans-serif; font-size: 10px; text-align: right;}
  td.Estilo61{ font-family: Arial, Helvetica, sans-serif; line-height: 1; font-size: 15px; text-align: justify;}
  H1.SaltoDePagina  { PAGE-BREAK-BEFORE: always }
  td.tdLabel  {font-size:11pt; background-color:#FFBA6B; font-weight:bold;}

  a.boton{
        font-size:10px;
        font-family:Verdana,Helvetica;
        font-weight:bold;
        color:white;
        background:#638cb5;
        border:0px;
        width:80px;
        height:19px;
       }
 a:hover.button{
 color:#638c11;
 }

     </style>

    </head>
    <DIV class="pagebodydiv">
    <body>
        <div class="headerwrapperdiv">
        <form name="forma">
          <br><br><br><br><br><br>
');
           --convalidadas
        IF psAccion = 'C' THEN
--                 AND U.SGBUSER_TERM_CODE =
--                        (SELECT MAX (uu.SGBUSER_TERM_CODE)
--                           FROM SGBUSER UU
--                          WHERE UU.SGBUSER_PIDM = U.SGBUSER_PIDM)

--HTP.P('SELECT  N.SHRTCKN_CRN,
--                      N.SHRTCKN_SUBJ_CODE,
--                      N.SHRTCKN_CRSE_NUMB
--                FROM SPRIDEN,
--                     SPBPERS,
--                     SGBSTDN S,
--                     TWBCNTR,
--                     SWVTAVI,
--                     SARADAP A,
--                     SHRTCKN N,
--                     SHRTCKG G,
--                     SGBUSER U,
--                     SGRCHRT Z,
--                     SARAATT
--               WHERE SPRIDEN_CHANGE_IND IS NULL
--                 AND TWBCNTR_STATUS_IND      = '||vsA||'
--                 AND SGBSTDN_TERM_CODE_ADMIT = '||vsTerm||'
--                 AND S.SGBSTDN_PIDM     = '||psPidm||'
--                 AND SHRTCKG_GMOD_CODE  = '||vsC||'
--                 AND (SARADAP_ADMT_CODE = '||vsVia||' OR '||vsVia||' IS NULL)
--                 AND (SGRCHRT_CHRT_CODE  =  '||vsCohor||' OR '||vsCohor||' IS NULL)
--                 AND (S.SGBSTDN_COLL_CODE_1 = '||vsEscu||' OR '||vsEscu||' IS NULL)
--                 AND SARADAP_PROGRAM_1 NOT IN ('
--                      ||vsINCO07V||','||vsINCO00V||','||vsINCO02V||','
--                      ||vsDERE01V||','||vsDERE00V||','||vsPRMC04 ||','||vsEDME07||','
--                      ||vsEDME00 ||','||vsDERE11V||','||vsPRMC11 ||','||vsPRMC10||','
--                      ||vsPRMC08 ||','||vsEDME11A||','||vsEDME11||')
--                 AND (
--                        G.SHRTCKG_SEQ_NO IS NULL
--                       OR
--                        G.SHRTCKG_SEQ_NO =
--                         (SELECT MAX (G1.SHRTCKG_SEQ_NO)
--                            FROM SHRTCKG G1
--                           WHERE G1.SHRTCKG_PIDM = G.SHRTCKG_PIDM
--                             AND G1.SHRTCKG_TERM_CODE = G.SHRTCKG_TERM_CODE
--                             AND G1.SHRTCKG_TCKN_SEQ_NO = G.SHRTCKG_TCKN_SEQ_NO)
--                     )
--                 AND S.SGBSTDN_TERM_CODE_EFF =
--                        (SELECT max (SS.SGBSTDN_TERM_CODE_EFF)
--                           FROM SGBSTDN SS
--                          WHERE SGBSTDN_PIDM = SPRIDEN_PIDM)
--
--                 AND A.SARADAP_APPL_NO =
--                        (SELECT MAX(B.SARADAP_APPL_NO)
--                           FROM SARADAP B
--                          WHERE S.SGBSTDN_PROGRAM_1     = B.SARADAP_PROGRAM_1
--                            AND S.SGBSTDN_PIDM          = B.SARADAP_PIDM
--                            AND B.SARADAP_TERM_CODE_ENTRY = '||vsTerm||'
--                            )
--                 AND(
--                      Z.SGRCHRT_TERM_CODE_EFF IS NULL
--                     OR
--                      Z.SGRCHRT_TERM_CODE_EFF =
--                        (SELECT MAX(C.SGRCHRT_TERM_CODE_EFF)
--                           FROM SGRCHRT C
--                          WHERE C.SGRCHRT_PIDM = A.SARADAP_PIDM
--                            AND C.SGRCHRT_TERM_CODE_EFF <= '||vsTerm||')
--                     )
--                 AND TO_NUMBER(SHRTCKG_TERM_CODE) >= TO_NUMBER('||vsTerm||')
--                 AND SARAATT_TERM_CODE = TWBCNTR_TERM_CODE
--                 AND SARAATT_PIDM = TWBCNTR_PIDM
--                 AND S.SGBSTDN_PIDM        = SPRIDEN_PIDM
--                 AND S.SGBSTDN_PIDM        = SPBPERS_PIDM
--                 AND S.SGBSTDN_PIDM        = TWBCNTR_PIDM
--                 AND TWBCNTR_TERM_CODE     = SARADAP_TERM_CODE_ENTRY
--                 AND SWVTAVI_ADMT_CODE    = S.SGBSTDN_ADMT_CODE
--                 AND SWVTAVI_TERM_CODE    = SARADAP_TERM_CODE_ENTRY
--                 AND S.SGBSTDN_PIDM        = SARADAP_PIDM
--                 AND S.SGBSTDN_PROGRAM_1   = SARADAP_PROGRAM_1
--                 AND S.SGBSTDN_PIDM       = SHRTCKG_PIDM(+)
--                 AND S.SGBSTDN_PIDM       = SGBUSER_PIDM(+)
--                 AND S.SGBSTDN_PIDM        = SGRCHRT_PIDM(+)
--                 AND G.SHRTCKG_PIDM        = N.SHRTCKN_PIDM(+)
--                 AND G.SHRTCKG_TERM_CODE   = N.SHRTCKN_TERM_CODE(+)
--                 AND G.SHRTCKG_TCKN_SEQ_NO = N.SHRTCKN_SEQ_NO(+)
--           ORDER BY N.SHRTCKN_SUBJ_CODE, N.SHRTCKN_CRSE_NUMB');


           EXECUTE IMMEDIATE
              'SELECT DISTINCT N.SHRTCKN_CRN,
                      N.SHRTCKN_SUBJ_CODE,
                      N.SHRTCKN_CRSE_NUMB
                FROM SPRIDEN,
                     SPBPERS,
                     SGBSTDN S,
                     TWBCNTR,
                     SWVTAVI,
                     SARADAP A,
                     SHRTCKN N,
                     SHRTCKG G,
                     SGBUSER U,
                     SGRCHRT Z,
                     SARAATT
               WHERE SPRIDEN_CHANGE_IND IS NULL
                 AND TWBCNTR_STATUS_IND      = '||vsA||'
                 AND SGBSTDN_TERM_CODE_ADMIT = '||vsTerm||'
                 AND S.SGBSTDN_PIDM     = '||psPidm||'
                 AND SHRTCKG_GMOD_CODE  = '||vsC||'
                 AND (SARADAP_ADMT_CODE = '||vsVia||' OR '||vsVia||' IS NULL)
                 AND (SGRCHRT_CHRT_CODE  =  '||vsCohor||' OR '||vsCohor||' IS NULL)
                 AND (S.SGBSTDN_COLL_CODE_1 = '||vsEscu||' OR '||vsEscu||' IS NULL)
                 AND SARADAP_PROGRAM_1 NOT IN ('
                      ||vsINCO07V||','||vsINCO00V||','||vsINCO02V||','
                      ||vsDERE01V||','||vsDERE00V||','||vsPRMC04 ||','||vsEDME07||','
                      ||vsEDME00 ||','||vsDERE11V||','||vsPRMC11 ||','||vsPRMC10||','
                      ||vsPRMC08 ||','||vsEDME11A||','||vsEDME11||')
                 AND (
                        G.SHRTCKG_SEQ_NO IS NULL
                       OR
                        G.SHRTCKG_SEQ_NO =
                         (SELECT MAX (G1.SHRTCKG_SEQ_NO)
                            FROM SHRTCKG G1
                           WHERE G1.SHRTCKG_PIDM = G.SHRTCKG_PIDM
                             AND G1.SHRTCKG_TERM_CODE = G.SHRTCKG_TERM_CODE
                             AND G1.SHRTCKG_TCKN_SEQ_NO = G.SHRTCKG_TCKN_SEQ_NO)
                     )
                 AND S.SGBSTDN_TERM_CODE_EFF =
                        (SELECT max (SS.SGBSTDN_TERM_CODE_EFF)
                           FROM SGBSTDN SS
                          WHERE SGBSTDN_PIDM = SPRIDEN_PIDM)

                 AND A.SARADAP_APPL_NO =
                        (SELECT MAX(B.SARADAP_APPL_NO)
                           FROM SARADAP B
                          WHERE S.SGBSTDN_PROGRAM_1     = B.SARADAP_PROGRAM_1
                            AND S.SGBSTDN_PIDM          = B.SARADAP_PIDM
                            AND B.SARADAP_TERM_CODE_ENTRY = '||vsTerm||'
                            )
                 AND(
                     Z.SGRCHRT_TERM_CODE_EFF IS NULL
                     OR
                       Z.SGRCHRT_TERM_CODE_EFF =
                                 (SELECT MAX(C.SGRCHRT_TERM_CODE_EFF)
                                    FROM SGRCHRT C
                                   WHERE C.SGRCHRT_PIDM = S.SGBSTDN_PIDM
                                     AND C.SGRCHRT_TERM_CODE_EFF <= '||vsTerm||')
                    )
                 AND TO_NUMBER(SHRTCKG_TERM_CODE) >= TO_NUMBER('||vsTerm||')
                 AND SARAATT_TERM_CODE = TWBCNTR_TERM_CODE
                 AND SARAATT_PIDM = TWBCNTR_PIDM
                 AND S.SGBSTDN_PIDM        = SPRIDEN_PIDM
                 AND S.SGBSTDN_PIDM        = SPBPERS_PIDM
                 AND S.SGBSTDN_PIDM        = TWBCNTR_PIDM
                 AND TWBCNTR_TERM_CODE     = SARADAP_TERM_CODE_ENTRY
                 AND SWVTAVI_ADMT_CODE    = S.SGBSTDN_ADMT_CODE
                 AND SWVTAVI_TERM_CODE    = SARADAP_TERM_CODE_ENTRY
                 AND S.SGBSTDN_PIDM        = SARADAP_PIDM
                 AND S.SGBSTDN_PROGRAM_1   = SARADAP_PROGRAM_1
                 AND S.SGBSTDN_PIDM       = SHRTCKG_PIDM(+)
                 AND S.SGBSTDN_PIDM       = SGBUSER_PIDM(+)
                 AND S.SGBSTDN_PIDM        = SGRCHRT_PIDM(+)
                 AND G.SHRTCKG_PIDM        = N.SHRTCKN_PIDM(+)
                 AND G.SHRTCKG_TERM_CODE   = N.SHRTCKN_TERM_CODE(+)
                 AND G.SHRTCKG_TCKN_SEQ_NO = N.SHRTCKN_SEQ_NO(+)
           ORDER BY N.SHRTCKN_SUBJ_CODE, N.SHRTCKN_CRSE_NUMB' BULK COLLECT
           INTO ADV_CRN_ITEMS;
        END IF;
          --Homologadas

--                 AND U.SGBUSER_TERM_CODE =
--                        (SELECT MAX (uu.SGBUSER_TERM_CODE)
--                           FROM SGBUSER UU
--                          WHERE UU.SGBUSER_PIDM = U.SGBUSER_PIDM)

        IF psAccion = 'H' THEN
           EXECUTE IMMEDIATE
              'SELECT DISTINCT N.SHRTCKN_CRN,
                      N.SHRTCKN_SUBJ_CODE,
                      N.SHRTCKN_CRSE_NUMB
                FROM SPRIDEN,
                     SPBPERS,
                     SGBSTDN S,
                     TWBCNTR,
                     SWVTAVI,
                     SARADAP A,
                     SHRTCKN N,
                     SHRTCKG G,
                     SGBUSER U,
                     SGRCHRT Z,
                     SARAATT
               WHERE SPRIDEN_CHANGE_IND IS NULL
                 AND S.SGBSTDN_PIDM     = '||psPidm||'
                 AND SHRTCKG_GMOD_CODE  = '||vsH||'
                 AND SARADAP_TERM_CODE_ENTRY = '||vsTerm||'
                 AND TWBCNTR_STATUS_IND      = '||vsA||'
                 AND (SARADAP_ADMT_CODE = '||vsVia||' OR '||vsVia||' IS NULL)
                 AND (S.SGBSTDN_COLL_CODE_1 = '||vsEscu||' OR '||vsEscu||' IS NULL)
                 AND (SGRCHRT_CHRT_CODE  =  '||vsCohor||' OR '||vsCohor||' IS NULL)
                 AND SARADAP_PROGRAM_1 NOT IN ('
                      ||vsINCO07V||','||vsINCO00V||','||vsINCO02V||','
                      ||vsDERE01V||','||vsDERE00V||','||vsPRMC04 ||','||vsEDME07||','
                      ||vsEDME00 ||','||vsDERE11V||','||vsPRMC11 ||','||vsPRMC10||','
                      ||vsPRMC08 ||','||vsEDME11A||','||vsEDME11||')
                 AND (
                        G.SHRTCKG_SEQ_NO IS NULL
                       OR
                        G.SHRTCKG_SEQ_NO =
                         (SELECT MAX (G1.SHRTCKG_SEQ_NO)
                            FROM SHRTCKG G1
                           WHERE G1.SHRTCKG_PIDM = G.SHRTCKG_PIDM
                             AND G1.SHRTCKG_TERM_CODE = G.SHRTCKG_TERM_CODE
                             AND G1.SHRTCKG_TCKN_SEQ_NO = G.SHRTCKG_TCKN_SEQ_NO)
                     )
                 AND S.SGBSTDN_TERM_CODE_EFF =
                        (SELECT max (SS.SGBSTDN_TERM_CODE_EFF)
                           FROM SGBSTDN SS
                          WHERE SGBSTDN_PIDM = SPRIDEN_PIDM)

                 AND A.SARADAP_APPL_NO =
                        (SELECT MAX(B.SARADAP_APPL_NO)
                           FROM SARADAP B
                          WHERE S.SGBSTDN_PROGRAM_1     = B.SARADAP_PROGRAM_1
                            AND S.SGBSTDN_PIDM          = B.SARADAP_PIDM
                            AND B.SARADAP_TERM_CODE_ENTRY = '||vsTerm||'
                            )
                 AND(
                     Z.SGRCHRT_TERM_CODE_EFF IS NULL
                     OR
                       Z.SGRCHRT_TERM_CODE_EFF =
                                 (SELECT MAX(C.SGRCHRT_TERM_CODE_EFF)
                                    FROM SGRCHRT C
                                   WHERE C.SGRCHRT_PIDM = S.SGBSTDN_PIDM
                                     AND C.SGRCHRT_TERM_CODE_EFF <= '||vsTerm||')
                    )
                 AND SARAATT_TERM_CODE = TWBCNTR_TERM_CODE
                 AND SARAATT_PIDM = TWBCNTR_PIDM
                 AND S.SGBSTDN_PIDM        = SPRIDEN_PIDM
                 AND S.SGBSTDN_PIDM        = SPBPERS_PIDM
                 AND S.SGBSTDN_PIDM        = TWBCNTR_PIDM
                 AND TWBCNTR_TERM_CODE     = SARADAP_TERM_CODE_ENTRY
                 AND SWVTAVI_ADMT_CODE    = S.SGBSTDN_ADMT_CODE
                 AND SWVTAVI_TERM_CODE    = SARADAP_TERM_CODE_ENTRY
                 AND S.SGBSTDN_PIDM        = SARADAP_PIDM
                 AND S.SGBSTDN_PROGRAM_1   = SARADAP_PROGRAM_1
                 AND S.SGBSTDN_PIDM       = SHRTCKG_PIDM(+)
                 AND S.SGBSTDN_PIDM       = SGBUSER_PIDM(+)
                 AND S.SGBSTDN_PIDM        = SGRCHRT_PIDM(+)
                 AND G.SHRTCKG_PIDM        = N.SHRTCKN_PIDM(+)
                 AND G.SHRTCKG_TERM_CODE   = N.SHRTCKN_TERM_CODE(+)
                 AND G.SHRTCKG_TCKN_SEQ_NO = N.SHRTCKN_SEQ_NO(+)
           ORDER BY N.SHRTCKN_SUBJ_CODE, N.SHRTCKN_CRSE_NUMB' BULK COLLECT
           INTO ADV_CRN_ITEMS;
        END IF;

        IF psAccion = 'IN' THEN
           EXECUTE IMMEDIATE
            'SELECT DISTINCT SHRTCKN_CRN,
                    SSBSECT_SUBJ_CODE,
                    SSBSECT_CRSE_NUMB
               FROM SFRSTCR,
                    SSBSECT,
                    SGRCHRT Z
              WHERE SFRSTCR_PIDM       = '||psPidm||'
                AND SFRSTCR_TERM_CODE  = '||vsTerm||'
                AND (SGRCHRT_CHRT_CODE = '||vsCohor||' OR '||vsCohor||' IS NULL)
                AND Z.SGRCHRT_TERM_CODE_EFF =
                                (SELECT MAX(C.SGRCHRT_TERM_CODE_EFF)
                                   FROM SGRCHRT C
                                  WHERE C.SGRCHRT_PIDM = A.SARADAP_PIDM
                                    AND C.SGRCHRT_TERM_CODE_EFF <= '||vsTerm||')
                AND SSBSECT_PIDM = SFRSTCR_PIDM
                AND SSBSECT_PIDM = SGRCHRT_PIDM
                AND SSBSECT_TERM_CODE = SFRSTCR_TERM_CODE
                AND SSBSECT_CRN = SFRSTCR_CRN
          ORDER BY SSBSECT_SUBJ_CODE, SSBSECT_CRSE_NUMB' BULK COLLECT
           INTO ADV_CRN_ITEMS;
        END IF;

--                      AND U.SGBUSER_TERM_CODE =
--                        (SELECT MAX (uu.SGBUSER_TERM_CODE)
--                           FROM SGBUSER UU
--                          WHERE UU.SGBUSER_PIDM = U.SGBUSER_PIDM)

          -- Nivel de Ingles Aprobado
        IF psAccion = 'A' THEN
           EXECUTE IMMEDIATE
              'SELECT DISTINCT N.SHRTCKN_SUBJ_CODE,N.SHRTCKN_CRSE_NUMB
                FROM SPRIDEN,
                     SPBPERS,
                     SGBSTDN S,
                     TWBCNTR,
                     SWVTAVI,
                     SARADAP A,
                     SHRGRDE R,
                     SHRTCKN N,
                     SHRTCKG G,
                     SGBUSER U,
                     SGRCHRT Z,
                     SARAATT
               WHERE SPRIDEN_CHANGE_IND IS NULL
                  AND S.SGBSTDN_PIDM     = '||psPidm||'
                  AND SARADAP_TERM_CODE_ENTRY = '||vsTerm||'
                 AND TWBCNTR_STATUS_IND = '||vsA||'
                 AND N.SHRTCKN_SUBJ_CODE = '||vsSubj||'
                 AND R.SHRGRDE_CODE = '||vsCaAC||'
                 AND (SARADAP_ADMT_CODE = '||vsVia||' OR '||vsVia||' IS NULL)
                 AND (S.SGBSTDN_COLL_CODE_1 = '||vsEscu||' OR '||vsEscu||' IS NULL)
                 AND (SGRCHRT_CHRT_CODE   = '||vsCohor||' OR '||vsCohor||' IS NULL)
                 AND N.SHRTCKN_CRSE_NUMB IN ('||vsCr01||', '||vsCr02||', '||vsCr03||', '
                                              ||vsCr3A||',' ||vsCr4B||','||vsCr4C||','
                                              ||vsCr4D||',' ||vsCr4E||','||vsCr4F||','
                                              ||vsCr4G||',' ||vsCr4H||')
                 AND G.SHRTCKG_GMOD_CODE IN ('||vsGraG||',' ||vsGraX||')
                 AND SARADAP_PROGRAM_1 NOT IN ('
                      ||vsINCO07V||','||vsINCO00V||','||vsINCO02V||','
                      ||vsDERE01V||','||vsDERE00V||','||vsPRMC04 ||','||vsEDME07||','
                      ||vsEDME00 ||','||vsDERE11V||','||vsPRMC11 ||','||vsPRMC10||','
                      ||vsPRMC08 ||','||vsEDME11A||','||vsEDME11||')
                 AND (
                        G.SHRTCKG_SEQ_NO IS NULL
                       OR
                        G.SHRTCKG_SEQ_NO =
                         (SELECT MAX (G1.SHRTCKG_SEQ_NO)
                            FROM SHRTCKG G1
                           WHERE G1.SHRTCKG_PIDM = G.SHRTCKG_PIDM
                             AND G1.SHRTCKG_TERM_CODE = G.SHRTCKG_TERM_CODE
                             AND G1.SHRTCKG_TCKN_SEQ_NO = G.SHRTCKG_TCKN_SEQ_NO)
                     )
                 AND S.SGBSTDN_TERM_CODE_EFF =
                        (SELECT max (SS.SGBSTDN_TERM_CODE_EFF)
                           FROM SGBSTDN SS
                          WHERE SGBSTDN_PIDM = SPRIDEN_PIDM)

                 AND A.SARADAP_APPL_NO =
                        (SELECT MAX(B.SARADAP_APPL_NO)
                           FROM SARADAP B
                          WHERE S.SGBSTDN_PROGRAM_1     = B.SARADAP_PROGRAM_1
                            AND S.SGBSTDN_PIDM          = B.SARADAP_PIDM
                            AND B.SARADAP_TERM_CODE_ENTRY = '||vsTerm||'
                            )
                 AND(
                     Z.SGRCHRT_TERM_CODE_EFF IS NULL
                     OR
                       Z.SGRCHRT_TERM_CODE_EFF =
                                 (SELECT MAX(C.SGRCHRT_TERM_CODE_EFF)
                                    FROM SGRCHRT C
                                   WHERE C.SGRCHRT_PIDM = S.SGBSTDN_PIDM
                                     AND C.SGRCHRT_TERM_CODE_EFF <= '||vsTerm||')
                    )
                 AND SARAATT_TERM_CODE = TWBCNTR_TERM_CODE
                 AND SARAATT_PIDM = TWBCNTR_PIDM
                 AND S.SGBSTDN_PIDM        = SPRIDEN_PIDM
                 AND S.SGBSTDN_PIDM        = SPBPERS_PIDM
                 AND S.SGBSTDN_PIDM        = TWBCNTR_PIDM
                 AND TWBCNTR_TERM_CODE     = SARADAP_TERM_CODE_ENTRY
                 AND SWVTAVI_ADMT_CODE    = S.SGBSTDN_ADMT_CODE
                 AND SWVTAVI_TERM_CODE    = SARADAP_TERM_CODE_ENTRY
                 AND S.SGBSTDN_PIDM        = SARADAP_PIDM
                 AND S.SGBSTDN_PROGRAM_1   = SARADAP_PROGRAM_1
                 AND S.SGBSTDN_PIDM       = SHRTCKG_PIDM(+)
                 AND S.SGBSTDN_PIDM       = SGBUSER_PIDM(+)
                 AND S.SGBSTDN_PIDM        = SGRCHRT_PIDM(+)
                 AND G.SHRTCKG_PIDM        = N.SHRTCKN_PIDM(+)
                 AND G.SHRTCKG_TERM_CODE   = N.SHRTCKN_TERM_CODE(+)
                 AND G.SHRTCKG_TCKN_SEQ_NO = N.SHRTCKN_SEQ_NO(+)
                 AND R.SHRGRDE_CODE        = G.SHRTCKG_GRDE_CODE_FINAL
           ORDER BY N.SHRTCKN_SUBJ_CODE,N.SHRTCKN_CRSE_NUMB' BULK COLLECT
             INTO ADV_CRSE_ITEMS;

        END IF;

     IF psAccion = 'C' OR psAccion = 'H' OR psAccion = 'IN' THEN
        HTP.P('
          <table border="0" cellpadding="0" bordercolor="#651612" bgcolor="#B0B0FF" cellspacing="0" width="100%" align="center">
            <tr>
              <td>
               <br/>
               <table border="0" width="100%" cellpadding="2" cellspacing="1" bgcolor="#B0B0FF" bordercolor="#0A75A3" align="center">
                 <tr>');
                 IF psAccion = 'C' THEN
                    HTP.P('<th colspan="3">Asignaturas Convalidadas</th>');
                 END IF;
                 IF psAccion = 'H' THEN
                    HTP.P('<th colspan="3">Asignaturas Homologadas</th>');
                 END IF;
                 IF psAccion = 'IN' THEN
                    HTP.P('<th colspan="3">Asignaturas Inscritas</th>');
                 END IF;
        HTP.P('</tr>
                <tr>
                  <th width="33%" align="center"><b>CRN</b></th>
                  <th width="33%" align="center"><b>SUBJ</b></th>
                  <th width="34%" align="center"><b>CRSE</b></th>
               </tr>
              ');
            BEGIN
               IF ADV_CRN_ITEMS IS NOT NULL THEN
                   IF ADV_CRN_ITEMS.COUNT > 0 THEN
                       FOR I IN ADV_CRN_ITEMS.FIRST..ADV_CRN_ITEMS.LAST LOOP
                           HTP.P('
                             <tr>
                               <td align="center">'||ADV_CRN_ITEMS(I).R_CRN||'</td>
                               <td align="center">'||ADV_CRN_ITEMS(I).R_SUB||'</td>
                               <td align="center">'||ADV_CRN_ITEMS(I).R_CRS||'</td>
                            </tr>
                           ');
                       END LOOP;
                   END IF;
               END IF;
            EXCEPTION WHEN others THEN
               HTP.P('<tr>
                        <th colspan="3">SIN DATOS</th>
                      </tr>
                <tr>
                    <td scope="col" colspan="3" align="center">
                        <input type="button" value="Cerrar" class="boton" onclick="window.close();">
                    </td>
                </tr>  ');
            END;
         HTP.P('
                <tr>
                    <td scope="col" colspan="3" align="center">
                        <input type="button" value="Cerrar" class="boton" onclick="window.close();">
                    </td>
                </tr>
              </table>
              <br/>
            </td>
          </tr>
        </table>



        ');
     END IF;

        --Prom Ingles  Aprobado
        IF psAccion = 'P' THEN

--                        AND U.SGBUSER_TERM_CODE =
--                        (SELECT MAX (uu.SGBUSER_TERM_CODE)
--                           FROM SGBUSER UU
--                          WHERE UU.SGBUSER_PIDM = U.SGBUSER_PIDM)


--


--                 AND Z.SGRCHRT_TERM_CODE_EFF =
--                                 (SELECT MAX(C.SGRCHRT_TERM_CODE_EFF)
--                                    FROM SGRCHRT C
--                                   WHERE C.SGRCHRT_PIDM = A.SARADAP_PIDM
--                                     AND C.SGRCHRT_TERM_CODE_EFF <= '||vsTerm||')

           EXECUTE IMMEDIATE
              'SELECT DISTINCT N.SHRTCKN_CRSE_TITLE,G.SHRTCKG_GRDE_CODE_FINAL
                FROM SPRIDEN,
                     SPBPERS,
                     SGBSTDN S,
                     TWBCNTR,
                     SWVTAVI,
                     SARADAP A,
                     SHRGRDE R,
                     SHRTCKN N,
                     SHRTCKG G,
                     SGBUSER U,
                     SGRCHRT Z
               WHERE SPRIDEN_CHANGE_IND IS NULL
                 AND N.SHRTCKN_SUBJ_CODE = '||vsSubj||'
                 AND N.SHRTCKN_CRSE_NUMB IN ('||vsCr01||', '||vsCr02||', '||vsCr03||', '
                                              ||vsCr3A||','||vsCr4B||','||vsCr4C||','
                                              ||vsCr4D||','||vsCr4E||','||vsCr4F||','
                                              ||vsCr4G||','||vsCr4H||')
                 AND SARADAP_PROGRAM_1 NOT IN ('
                      ||vsINCO07V||','||vsINCO00V||','||vsINCO02V||','
                      ||vsDERE01V||','||vsDERE00V||','||vsPRMC04 ||','||vsEDME07||','
                      ||vsEDME00 ||','||vsDERE11V||','||vsPRMC11 ||','||vsPRMC10||','
                      ||vsPRMC08 ||','||vsEDME11A||','||vsEDME11||')
                 AND N.SHRTCKN_PIDM = '||psPidm||'
                 AND TWBCNTR_STATUS_IND = '||vsA||'
                 AND SUBSTR(SARADAP_TERM_CODE_ENTRY,1,4) = SUBSTR('||vsTerm||',1,4)
                 AND G.SHRTCKG_GMOD_CODE  = '||vsCalN||'
                 AND (SARADAP_ADMT_CODE = '||vsVia||' OR '||vsVia||' IS NULL)
                 AND (S.SGBSTDN_COLL_CODE_1 = '||vsEscu||' OR '||vsEscu||' IS NULL)
                 AND (SGRCHRT_CHRT_CODE   = '||vsCohor||' OR '||vsCohor||' IS NULL)
                 AND S.SGBSTDN_TERM_CODE_EFF =
                        (SELECT max (SS.SGBSTDN_TERM_CODE_EFF)
                           FROM SGBSTDN SS
                          WHERE SGBSTDN_PIDM = SPRIDEN_PIDM)
                 AND G.SHRTCKG_SEQ_NO =
                        (SELECT MAX (G1.SHRTCKG_SEQ_NO)
                           FROM SHRTCKG G1
                          WHERE G1.SHRTCKG_PIDM = G.SHRTCKG_PIDM
                            AND G1.SHRTCKG_TERM_CODE = G.SHRTCKG_TERM_CODE
                            AND G1.SHRTCKG_TCKN_SEQ_NO = G.SHRTCKG_TCKN_SEQ_NO)
                 AND A.SARADAP_APPL_NO =
                        (SELECT MAX(B.SARADAP_APPL_NO)
                           FROM SARADAP B
                          WHERE S.SGBSTDN_PIDM          = B.SARADAP_PIDM
                            AND S.SGBSTDN_TERM_CODE_EFF = B.SARADAP_TERM_CODE_ENTRY
                            AND S.SGBSTDN_PROGRAM_1     = B.SARADAP_PROGRAM_1)
                 AND G.SHRTCKG_PIDM        = N.SHRTCKN_PIDM
                 AND G.SHRTCKG_TERM_CODE   = N.SHRTCKN_TERM_CODE
                 AND G.SHRTCKG_TCKN_SEQ_NO = N.SHRTCKN_SEQ_NO
                 AND S.SGBSTDN_PIDM      = SPRIDEN_PIDM
                 AND S.SGBSTDN_PIDM      = SPBPERS_PIDM
                 AND S.SGBSTDN_PIDM      = TWBCNTR_PIDM
                 AND TWBCNTR_TERM_CODE   = SARADAP_TERM_CODE_ENTRY
                 AND SWVTAVI_ADMT_CODE   = SARADAP_ADMT_CODE
                 AND SWVTAVI_TERM_CODE   = SARADAP_TERM_CODE_ENTRY
                 AND S.SGBSTDN_PIDM      = SARADAP_PIDM
                 AND S.SGBSTDN_PROGRAM_1 = SARADAP_PROGRAM_1
                 AND S.SGBSTDN_PIDM      = SHRTCKG_PIDM
                 AND S.SGBSTDN_PIDM      = SGBUSER_PIDM
                 AND S.SGBSTDN_PIDM      = SGRCHRT_PIDM
                 AND R.SHRGRDE_CODE = G.SHRTCKG_GRDE_CODE_FINAL
           ORDER BY N.SHRTCKN_CRSE_TITLE,G.SHRTCKG_GRDE_CODE_FINAL'   BULK COLLECT
           INTO ADV_MAT_ITEMS;
        END IF;



     IF psAccion = 'A' THEN
        HTP.P('
          <table border="0" cellpadding="0" bordercolor="#651612" bgcolor="#B0B0FF" cellspacing="0" width="100%" align="center">
            <tr>
              <td>
               <br/>
               <table border="0" width="100%" cellpadding="2" cellspacing="1" bgcolor="#B0B0FF" bordercolor="#0A75A3" align="center">
                <tr>
                   <th colspan="2">Nivel de Ingls Aprobado</th>
                </tr>
                <tr>
                  <th width="50%" align="center"><b>CRN</b></th>
                  <th width="50%" align="center"><b>SUBJ</b></th>
               </tr>
              ');

            BEGIN
               IF ADV_CRSE_ITEMS IS NOT NULL THEN
                   IF ADV_CRSE_ITEMS.COUNT > 0 THEN
                       FOR I IN ADV_CRSE_ITEMS.FIRST..ADV_CRSE_ITEMS.LAST LOOP
                           HTP.P('
                             <tr>
                               <td align="center">'||ADV_CRSE_ITEMS(I).R_CODE||'</td>
                               <td align="center"> '||ADV_CRSE_ITEMS(I).R_DESC||'</td>
                            </tr>
                           </tr>
                           ');
                       END LOOP;
                   END IF;
               END IF;
            EXCEPTION WHEN others THEN
               HTP.P('<tr>
                        <th colspan="2">SIN DATOS</th>
                      </tr>
                      <tr>
                    <td scope="col" colspan="2" align="center">
                        <input type="button" value="Cerrar" class="boton" onclick="window.close();">
                    </td>
                </tr>
                       ');
            END;
         HTP.P('
               <tr>
                    <td scope="col" colspan="2" align="center">
                        <input type="button" value="Cerrar" class="boton" onclick="window.close();">
                    </td>
                </tr>
              </table>
              <br/>
            </td>
          </tr>
        </table>
        ');
     END IF;

     IF psAccion = 'P' THEN
        HTP.P('
          <table border="0" cellpadding="0" bordercolor="#651612" bgcolor="#B0B0FF" cellspacing="0" width="100%" align="center">
            <tr>
              <td>
               <br/>
               <table border="0" width="100%" cellpadding="2" cellspacing="1" bgcolor="#B0B0FF" bordercolor="#0A75A3" align="center">
                <tr>
                     <th colspan="2">Promedio Ingls al Periodo</th>
                </tr>
                <tr>
                  <th width="50%" align="center"><b>CRN</b></th>
                  <th width="50%" align="center"><b>SUBJ</b></th>
               </tr>
              ');

            BEGIN
               IF ADV_MAT_ITEMS IS NOT NULL THEN
                   IF ADV_MAT_ITEMS.COUNT > 0 THEN
                       FOR I IN ADV_MAT_ITEMS.FIRST..ADV_MAT_ITEMS.LAST LOOP
                           HTP.P('
                             <tr>
                               <td align="center">'||ADV_MAT_ITEMS(I).R_CODE||'</td>
                               <td align="center">'||ADV_MAT_ITEMS(I).R_DESC||'</td>
                            </tr>
                           </tr>
                           ');
                       END LOOP;
                   END IF;
               END IF;
            EXCEPTION WHEN others THEN
               HTP.P('<tr>
                        <th colspan="2">SIN DATOS</th>
                      </tr>
                      <tr>
                    <td scope="col" colspan="2" align="center">
                        <input type="button" value="Cerrar" class="boton" onclick="window.close();">
                    </td>
                </tr>
                       ');
            END;
         HTP.P('
               <tr>
                    <td scope="col" colspan="2" align="center">
                        <input type="button" value="Cerrar" class="boton" onclick="window.close();">
                    </td>
                </tr>
              </table>
              <br/>
            </td>
          </tr>
        </table>



        ');
     END IF;

   EXCEPTION
       WHEN OTHERS THEN
       HTP.P('
          <table border="0" cellpadding="0" bordercolor="#651612" bgcolor="#B0B0FF" cellspacing="0" width="100%" align="center">
            <tr>
              <td>
               <br/>
               <table border="0" width="100%" cellpadding="2" cellspacing="1" bgcolor="#B0B0FF" bordercolor="#0A75A3" align="center">
                 <tr>
                   <th colspan="2">SIN DATOS</th>
                 </tr>
                <tr>
                    <td scope="col" colspan="2" align="center">
                        <input type="button" value="Cerrar" class="boton" onclick="window.close();">
                    </td>
                </tr>
              </table>
              <br/>
            </td>
          </tr>
        </table>
     </form>
    </dv>
    </body>
    </div>
</html>
    ');
END PWRSEPD;
/


DROP PUBLIC SYNONYM PWRSEPD;

CREATE PUBLIC SYNONYM PWRSEPD FOR BANINST1.PWRSEPD;


GRANT EXECUTE ON BANINST1.PWRSEPD TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRSINP;

CREATE OR REPLACE PROCEDURE BANINST1.PWRSINP (psReclDesc   VARCHAR2)  IS

/**************************************************************
           tarea:  procedimiento que genera el reporte de sntesis de postulaciones
          mdulo:  admisiones
           autor:  horacio martnez ramrez - hmr
           fecha:  27/ene/2011
**************************************************************/

  vnExists       INTEGER  := 0;
  vnColumnas     INTEGER  := 15;
  vgsInicioPag   VARCHAR2(30)  := NULL;           -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vnIdRenglon    INTEGER  := 1;
  vsTerm         SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsProgr        SARADAP.SARADAP_PROGRAM_1%TYPE DEFAULT NULL;


  CURSOR cuReporte ( psTerm   VARCHAR2  DEFAULT NULL,
                     psProgr  VARCHAR2  DEFAULT NULL )  IS

     SELECT DISTINCT(T.SWRPOST_PROGRAM_1)                          CARRERA,
            ( SELECT COUNT(*)
                FROM SWRPOST
               WHERE SWRPOST_PROGRAM_1 = T.SWRPOST_PROGRAM_1 )     POSTUL_TOTALES,
            ( SELECT COUNT(*)
                FROM SWRPOST
               WHERE SWRPOST_APDC_CODE = 'AC'
                 AND SWRPOST_PROGRAM_1 = T.SWRPOST_PROGRAM_1 )     POSTUL_ACEPTADAS,
            ( SELECT COUNT(*)
                FROM SWRPOST
               WHERE SWRPOST_APDC_CODE = 'PE'
                 AND SWRPOST_PROGRAM_1 = T.SWRPOST_PROGRAM_1 )     POSTUL_PENDIENTES,
            ( SELECT COUNT(*)
                FROM SWRPOST
               WHERE SWRPOST_APDC_CODE = 'IN'
                 AND SWRPOST_PROGRAM_1 = T.SWRPOST_PROGRAM_1 )     POSTUL_INGRESADAS,
            ( SELECT COUNT(*)
                FROM SWRPOST
               WHERE SWRPOST_APDC_CODE = 'RE'
                 AND SWRPOST_PROGRAM_1 = T.SWRPOST_PROGRAM_1 )     POSTUL_RECHAZADAS,
            ( SELECT COUNT(*)
                FROM SWRPOST
               WHERE SWRPOST_APDC_CODE IS NULL
                 AND SWRPOST_PROGRAM_1 = T.SWRPOST_PROGRAM_1 )     POSTUL_NULL,
            ( SELECT COUNT(*)
                FROM SWRPOST
               WHERE SWRPOST_APDC_CODE IN ('AC', 'IN')
                 AND SWRPOST_PROGRAM_1 = T.SWRPOST_PROGRAM_1 )     POSTUL_VALID_TOTALES,
            ( SELECT COUNT(*)
                FROM SWRPOST
               WHERE SWRPOST_APDC_CODE IN ('AC', 'IN')
                 AND SWRPOST_APPL_PREFERENCE = 1
                 AND SWRPOST_PROGRAM_1 = T.SWRPOST_PROGRAM_1 )     POSTUL_VALID_1A_PREF,
            ( SELECT COUNT(*)
                FROM SWRPOST
               WHERE SWRPOST_APDC_CODE IN ('AC', 'IN')
                 AND SWRPOST_APPL_PREFERENCE = 2
                 AND SWRPOST_PROGRAM_1 = T.SWRPOST_PROGRAM_1 )     POSTUL_VALID_2A_PREF,
            ( SELECT COUNT(*)
                FROM SWRPOST
               WHERE SWRPOST_APDC_CODE IN ('AC', 'IN')
                 AND SWRPOST_APPL_PREFERENCE = 3
                 AND SWRPOST_PROGRAM_1 = T.SWRPOST_PROGRAM_1 )     POSTUL_VALID_3A_PREF,
            ( SELECT COUNT(*)
                FROM SWRPOST
               WHERE SWRPOST_APDC_CODE IN ('AC', 'IN')
                 AND SWRPOST_APPL_PREFERENCE IS NULL
                 AND SWRPOST_PROGRAM_1 = T.SWRPOST_PROGRAM_1 )     POSTUL_VALID_PREF_NULL,
            ( SELECT COUNT(*)
                FROM SWRPOST
               WHERE SWRPOST_APDC_CODE IN ('AC', 'IN')
                 AND SWRPOST_ADMT_CODE = 'AD'
                 AND SWRPOST_PROGRAM_1 = T.SWRPOST_PROGRAM_1 )     POSTUL_VALID_ADM_REG,
            ( SELECT COUNT(*)
                FROM SWRPOST
               WHERE SWRPOST_APDC_CODE IN ('AC', 'IN')
                 AND SWRPOST_ADMT_CODE <> 'AD'
                 AND SWRPOST_PROGRAM_1 = T.SWRPOST_PROGRAM_1 )     POSTUL_VALID_ADM_ESP,
            ( SELECT COUNT(*)
                FROM SWRPOST
               WHERE SWRPOST_APDC_CODE IN ('AC', 'IN')
                 AND SWRPOST_APPL_PREFERENCE = 1
                 AND SWRPOST_PROGRAM_1 = T.SWRPOST_PROGRAM_1 )     POSTUL_VALID_PREF_1_TOTALES,
            ( SELECT COUNT(*)
                FROM SWRPOST
               WHERE SWRPOST_APDC_CODE IN ('AC', 'IN')
                 AND SWRPOST_APPL_PREFERENCE = 1
                 AND SWRPOST_ADMT_CODE = 'AD'
                 AND SWRPOST_PROGRAM_1 = T.SWRPOST_PROGRAM_1 )     POSTUL_VALID_PREF_1_ADM_REG,
            ( SELECT COUNT(*)
                FROM SWRPOST
               WHERE SWRPOST_APDC_CODE IN ('AC', 'IN')
                 AND SWRPOST_APPL_PREFERENCE = 1
                 AND SWRPOST_ADMT_CODE <> 'AD'
                 AND SWRPOST_PROGRAM_1 = T.SWRPOST_PROGRAM_1 )     POSTUL_VALID_PREF_1_ADM_ESP
       FROM SWRPOST T
      WHERE (T.SWRPOST_PROGRAM_1 = psProgr OR psProgr IS NULL)
      GROUP BY T.SWRPOST_PROGRAM_1
      ORDER BY T.SWRPOST_PROGRAM_1;


  BEGIN

     -- valida que el usuario pertenezca a la base de datos:
     IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

     -- son buscados los valores de las cookies para asignar los valores del filtro del query:
     vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
     vsProgr := pk_ObjHtml.getValueCookie('psProgr');

     -- vaca la tabla temporal:
     DELETE SWRPOST;
     COMMIT;

     -- inserta en la tabla temporal parte de la informacin del reporte de postulaciones:
     INSERT INTO SWRPOST
                 ( SELECT SP.SPRIDEN_ID                                                                ID,
                          SA.SARADAP_PROGRAM_1                                                         CARRERA,
                          ( SELECT DISTINCT(SARAPPD_APDC_CODE)
                              FROM SARAPPD A
                             WHERE A.SARAPPD_PIDM = SA.SARADAP_PIDM
                               AND A.SARAPPD_TERM_CODE_ENTRY = SA.SARADAP_TERM_CODE_ENTRY
                               AND A.SARAPPD_APPL_NO = SA.SARADAP_APPL_NO
                               AND A.SARAPPD_SEQ_NO = (SELECT MAX(SARAPPD_SEQ_NO)
                                                         FROM SARAPPD
                                                        WHERE SARAPPD_PIDM = A.SARAPPD_PIDM
                                                          AND SARAPPD_APPL_NO = SA.SARADAP_APPL_NO) )  DECISION,
                          SA.SARADAP_ADMT_CODE                                                         TIPO_ADMISION,
                          SA.SARADAP_APPL_PREFERENCE                                                   PREFERENCIA
                     FROM SPRIDEN  SP,
                          SARADAP  SA,
                          SORHSCH  CH,
                          SPBPERS  SB,
                          STVADMT  ST,
                          SGBSTDN  DN
                    WHERE SP.SPRIDEN_CHANGE_IND IS NULL
                      AND SP.SPRIDEN_PIDM = SA.SARADAP_PIDM(+)
                      AND SA.SARADAP_PIDM = CH.SORHSCH_PIDM(+)
                      AND SA.SARADAP_PIDM = SB.SPBPERS_PIDM(+)
                      AND SA.SARADAP_PIDM = DN.SGBSTDN_PIDM(+)
                      AND SA.SARADAP_TERM_CODE_ENTRY = vsTerm
                      AND SA.SARADAP_ADMT_CODE = ST.STVADMT_CODE );

     -- se determina el largo de la tabla:
     FOR vnI IN 1..vnColumnas LOOP
         tabColumna.EXTEND(vnI);
         tabColumna(vnI) := NULL;
     END LOOP;

     tabColumna(1)  := '<center> Carrera';
     tabColumna(2)  := '<center> Postulaciones <br> totales';
     tabColumna(3)  := '<center> Postulaciones <br> aceptadas';
     tabColumna(4)  := '<center> Postulaciones <br> pendientes';
     tabColumna(5)  := '<center> Postulaciones <br> ingresadas';
     tabColumna(6)  := '<center> Postulaciones <br> rechazadas';
     tabColumna(7)  := '<center> Postulaciones <br> vlidas <br> totales';
     tabColumna(8)  := '<center> Postulaciones <br> vlidas <br> 1ra. preferencia';
     tabColumna(9)  := '<center> Postulaciones <br> vlidas <br> 2da. preferencia';
     tabColumna(10) := '<center> Postulaciones <br> vlidas <br> 3ra. preferencia';
     tabColumna(11) := '<center> Postulaciones <br> vlidas <br> admisin regular';
     tabColumna(12) := '<center> Postulaciones <br> vlidas <br> admisin especial';
     tabcolumna(13) := '<center> Postulaciones vlidas <br> en 1ra. preferencia <br> totales';
     tabColumna(14) := '<center> Postulaciones vlidas <br> en 1ra. preferencia <br> admisin regular';
     tabColumna(15) := '<center> Postulaciones vlidas <br> en 1ra. preferencia <br> admisin especial';


     FOR regRep IN cuReporte (vsTerm, vsProgr) LOOP

         IF vnExists = 0 THEN
            Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||'  '||Pk_Catalogo.PERIODO(vsTerm), psUniversidad=>'UFT');
            vgsInicioPag := 'SALTO';
         END IF;

         HTP.P('<tr> <td valign="top" align="left">'   ||regRep.CARRERA                     ||'</td>
                     <td valign="top" align="center">' ||regRep.POSTUL_TOTALES              ||'</td>
                     <td valign="top" align="center">' ||regRep.POSTUL_ACEPTADAS            ||'</td>
                     <td valign="top" align="center">' ||regRep.POSTUL_PENDIENTES           ||'</td>
                     <td valign="top" align="center">' ||regRep.POSTUL_INGRESADAS           ||'</td>
                     <td valign="top" align="center">' ||regRep.POSTUL_RECHAZADAS           ||'</td>
                     <td valign="top" align="center">' ||regRep.POSTUL_VALID_TOTALES        ||'</td>
                     <td valign="top" align="center">' ||regrep.POSTUL_VALID_1A_PREF        ||'</td>
                     <td valign="top" align="center">' ||regrep.POSTUL_VALID_2A_PREF        ||'</td>
                     <td valign="top" align="center">' ||regrep.POSTUL_VALID_3A_PREF        ||'</td>
                     <td valign="top" align="center">' ||regrep.POSTUL_VALID_ADM_REG        ||'</td>
                     <td valign="top" align="center">' ||regrep.POSTUL_VALID_ADM_ESP        ||'</td>
                     <td valign="top" align="center">' ||regrep.POSTUL_VALID_PREF_1_TOTALES ||'</td>
                     <td valign="top" align="center">' ||regrep.POSTUL_VALID_PREF_1_ADM_REG ||'</td>
                     <td valign="top" align="center">' ||regrep.POSTUL_VALID_PREF_1_ADM_ESP ||'</td>
                </tr>');

         vnExists    := 1;
         vnIdRenglon := vnIdRenglon + 1;

     END LOOP;

     IF vnExists = 0 THEN
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
     ELSE
        -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pgina:
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
     END IF;

     htp.p('</table><br/></body></html>');

     -- deshace la insercin de registros en la tabla temporal:
     ROLLBACK;

  EXCEPTION
     WHEN OTHERS THEN
          htp.p(SQLERRM);

  END PWRSINP;
/


DROP PUBLIC SYNONYM PWRSINP;

CREATE PUBLIC SYNONYM PWRSINP FOR BANINST1.PWRSINP;


GRANT EXECUTE ON BANINST1.PWRSINP TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRSINP TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRSODA;

CREATE OR REPLACE PROCEDURE BANINST1.PWRSODA (psReclDesc   VARCHAR2) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de solicitud soda
        mdulo: admisiones - uft.
         autor: hmr - socorro crdenas.
         fecha:17/07/2012.


*******************************************************************************/

  -- declaracin de variables:
  vnExists       INTEGER      := 0;
  vnColumnas     INTEGER      := 13;
  vgsInicioPag   VARCHAR2(30) := NULL;         -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vnIdRenglon    INTEGER      := 1;
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);

  vsTerm        SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE	DEFAULT NULL;
  vsEscu	SGBSTDN.SGBSTDN_COLL_CODE_1%TYPE	DEFAULT NULL;
  vsExped       SPRIDEN.SPRIDEN_ID%TYPE		DEFAULT NULL;

  -- obtiene la informacin de los alumnos:
  CURSOR cuReporte (	psTerm		VARCHAR2  DEFAULT NULL,
                        psEscu		VARCHAR2  DEFAULT NULL,
                        psExped		VARCHAR2  DEFAULT NULL ) IS
  SELECT  SPRIDEN_ID ID,
    SPBPERS_NAME_SUFFIX RUT,
    SPRIDEN_FIRST_NAME NOMBRES,
    SPRIDEN_LAST_NAME APELLIDOS,
    SGBSTDN_PROGRAM_1 PROGRAMA,
    SGBSTDN_COLL_CODE_1 ESCUELA,
    SGBSTDN_TERM_CODE_ADMIT PRDO_INGRESO,
    N.SHRTCKN_TERM_CODE PERIODO_NRC,
    N.SHRTCKN_CRN NRC,
    N.SHRTCKN_SUBJ_CODE MATERIA,
    N.SHRTCKN_CRSE_NUMB CURSO,
    decode(substr(G.SHRTCKG_GRDE_CODE_FINAL,1,1),'0',replace(G.SHRTCKG_GRDE_CODE_FINAL,',','.'),
                                                                                '1',replace(G.SHRTCKG_GRDE_CODE_FINAL,',','.'),
                                                                                '2',replace(G.SHRTCKG_GRDE_CODE_FINAL,',','.'),
                                                                                '3',replace(G.SHRTCKG_GRDE_CODE_FINAL,',','.'),
                                                                                '4',replace(G.SHRTCKG_GRDE_CODE_FINAL,',','.'),
                                                                                '5',replace(G.SHRTCKG_GRDE_CODE_FINAL,',','.'),
                                                                                '6',replace(G.SHRTCKG_GRDE_CODE_FINAL,',','.'),
                                                                                '7',replace(G.SHRTCKG_GRDE_CODE_FINAL,',','.'),
                                                                                '8',replace(G.SHRTCKG_GRDE_CODE_FINAL,',','.'),
                                                                                '9',replace(G.SHRTCKG_GRDE_CODE_FINAL,',','.'),
                                                                               G.SHRTCKG_GRDE_CODE_FINAL) CALIFICACION,
    N.SHRTCKN_CRSE_TITLE TITULO
   FROM SHRTCKN N, SHRTCKG G, SHRTCKL L, SGBSTDN S, SPRIDEN, SPBPERS
   WHERE
         SPRIDEN_ID=nvl(psExped,SPRIDEN_ID)
     AND S.SGBSTDN_TERM_CODE_ADMIT=psTerm
     AND s.SGBSTDN_COLL_CODE_1=nvl(psEscu,s.SGBSTDN_COLL_CODE_1)
     AND S.SGBSTDN_PIDM = N.SHRTCKN_PIDM
     AND S.SGBSTDN_PIDM = SPRIDEN_PIDM
     AND S.SGBSTDN_PIDM = SPBPERS_PIDM
     AND S.SGBSTDN_TERM_CODE_EFF =(SELECT MAX (SS.SGBSTDN_TERM_CODE_EFF)
                                         FROM SGBSTDN SS
                                        WHERE SGBSTDN_PIDM = N.SHRTCKN_PIDM)
     AND G.SHRTCKG_PIDM = N.SHRTCKN_PIDM
     AND G.SHRTCKG_TERM_CODE = N.SHRTCKN_TERM_CODE
     AND G.SHRTCKG_TCKN_SEQ_NO = N.SHRTCKN_SEQ_NO
     AND G.SHRTCKG_SEQ_NO =
                      (SELECT MAX (G1.SHRTCKG_SEQ_NO)
                         FROM SHRTCKG G1
                        WHERE G1.SHRTCKG_PIDM = G.SHRTCKG_PIDM
                          AND G1.SHRTCKG_TERM_CODE = G.SHRTCKG_TERM_CODE
                          AND G1.SHRTCKG_TCKN_SEQ_NO = G.SHRTCKG_TCKN_SEQ_NO)
     AND L.SHRTCKL_PIDM = N.SHRTCKN_PIDM
     AND L.SHRTCKL_TERM_CODE = N.SHRTCKN_TERM_CODE
     AND L.SHRTCKL_TCKN_SEQ_NO = N.SHRTCKN_SEQ_NO
     AND SPRIDEN_CHANGE_IND IS NULL;
---------------------------------------------------
-- bloque principal para la generacin del reporte
---------------------------------------------------
BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
   vsEscu := pk_ObjHtml.getValueCookie('psEscu');
   vsExped := pk_ObjHtml.getValueCookie('psExped');


   -- determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   -- define los encabezados de las columnas:
   tabColumna(1)  := '<left> ID';
   tabColumna(2)  := '<left> RUT';
   tabColumna(3)  := '<left> Nombres';
   tabColumna(4)  := '<left> Apellidos';
   tabColumna(5)  := '<left> Programa';
   tabColumna(6)  := '<leftr> Escuela';
   tabColumna(7)  := '<left> Periodo de Ingreso';
   tabColumna(8)  := '<left> Periodo NCR';
   tabColumna(9)  := '<left> NCR';
   tabColumna(10)  := '<left> Materia';
   tabColumna(11) := '<left>  Curso';
   tabcolumna(12) := '<left> Calificaci&oacuten';
   tabColumna(13) := '<left> T&iacutetulo';


   -- manipula la informacin obtenida por el cursor:
   FOR regRep IN cuReporte (vsTerm,vsEscu,vsExped) LOOP

       IF vnExists = 0 THEN

          -- muestra el encabezado segn el periodo y programa seleccionados:
          IF vsEscu IS NOT NULL THEN
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||'<br>'||'Escuela: &nbsp;'||vsEscu||' - '||Pk_Catalogo.Colegio(vsEscu),
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
          ELSE
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||'<br>'||'Escuela: &nbsp;'||'Todos ',
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
          END IF;

       END IF;

       -- muestra los valores para cada registro:
       HTP.P('<tr> <td valign="top" align="right">'   ||regRep.ID              ||'</td>
                   <td valign="top" align="left">'   ||regRep.RUT               ||'</td>
                   <td valign="top" align="left">'   ||regRep.Nombres        ||'</td>
                   <td valign="top" align="left">'   ||regRep.Apellidos           ||'</td>
                   <td valign="top" align="left">'   ||regRep.PROGRAMA		||'</td>
                   <td valign="top" align="left">'   ||regRep.ESCUELA		||'</td>
                   <td valign="top" align="right">'  ||regRep.PRDO_INGRESO      ||'</td>
		   <td valign="top" align="right">'  ||regRep.PERIODO_NRC ||'</td>
                   <td valign="top" align="right">' ||regRep.NRC        ||'</td>
                   <td valign="top" align="left">' ||regRep.MATERIA  ||'</td>
                   <td valign="top" align="left">' ||regRep.CURSO      ||'</td>
                   <td valign="top" align="left">' ||regRep.CALIFICACION  ||'</td>
                   <td valign="top" align="left">' ||regRep.TITULO ||'</td>
             </tr>');

       vnExists    := 1;
       vnIdRenglon := vnIdRenglon + 1;
   -- END IF;
   END LOOP;

   -- muestra el pie de reporte:
   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- omite el encabezado del reporte pero se agrega el salto de pgina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRSODA;
/


DROP PUBLIC SYNONYM PWRSODA;

CREATE PUBLIC SYNONYM PWRSODA FOR BANINST1.PWRSODA;


GRANT EXECUTE ON BANINST1.PWRSODA TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRSODA TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRSODA TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRSODA TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRTIBE;

CREATE OR REPLACE PROCEDURE BANINST1.PWRTIBE (psReclDesc   VARCHAR2) IS

/*******************************************************************************
         tarea: procedimiento que genera el reporte de tipo de beca
        mdulo: admisiones - uft.
         autor: hmr - socorro crdenas.
         fecha: 11/10/2012.


*******************************************************************************/

  -- declaracin de variables:
  vnExists       INTEGER      := 0;
  vnColumnas     INTEGER      := 18;
  vgsInicioPag   VARCHAR2(30) := NULL;         -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  vnIdRenglon    INTEGER      := 1;
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);

  vsTerm        SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE	DEFAULT NULL;
  vsEscu	     SGBSTDN.SGBSTDN_COLL_CODE_1%TYPE	DEFAULT NULL;
  vsExped       SPRIDEN.SPRIDEN_ID%TYPE		DEFAULT NULL;

  -- obtiene la informacin de los alumnos:
  CURSOR cuReporte (	psTerm		VARCHAR2  DEFAULT NULL,
                          psEscu		VARCHAR2  DEFAULT NULL,
                          psExped		VARCHAR2  DEFAULT NULL) IS
SELECT distinct PIDM,
            SPBPERS_NAME_SUFFIX						   RUT,
            SPRIDEN_ID							                ID ,
            SPRIDEN_LAST_NAME						     APELLIDOS,
            SPRIDEN_FIRST_NAME						     NOMBRE,
            (SELECT SPRTELE_PHONE_AREA|| '-'||SPRTELE_PHONE_NUMBER TELEFONO
              FROM SPRTELE
                WHERE SPRTELE_TELE_CODE = 'TFPA'
                and sprtele_pidm = s.sgbstdn_pidm
            and rownum = 1)							          TEL_CONTACTO,
            (SELECT GOREMAL_EMAIL_ADDRESS
            from goremal
            where goremal_emal_code = 'UFT'
            AND GOREMAL_PIDM = sgbstdn_PIDM
            AND ROWNUM= 1)							       EMAIL,
            SGBSTDN_TERM_CODE_ADMIT						PERIODO_ADMISION,
            --SGBSTDN_PROGRAM_1						CARRERA, --cambia a escuela
            SGBSTDN_COLL_CODE_1                                                  ESCUELA,
            (SELECT STVSTST_DESC FROM STVSTST
            WHERE STVSTST_CODE = SGBSTDN_STST_CODE)				ESTADO,
            (select stvstyp_desc from stvstyp
            where stvstyp_code = sgbstdn_styp_code)				TIPO_ALUMNO,
            BECAS.BECA							                BECA,
            BECAS.DBECA							               DBECA,
            (SELECT COUNT(N.SHRTCKN_CRN ) REPROBADAS
                  FROM SHRTCKN N, SHRTCKG G
                   WHERE G.SHRTCKG_PIDM = N.SHRTCKN_PIDM
                   AND G.SHRTCKG_TERM_CODE = N.SHRTCKN_TERM_CODE
                   AND G.SHRTCKG_TCKN_SEQ_NO = N.SHRTCKN_SEQ_NO
                   AND G.SHRTCKG_GRDE_CODE_FINAL <= '3.9'
                   and N.SHRTCKN_PIDM = sgbstdn_PIDM
                   AND (N.SHRTCKN_TERM_CODE = psTerm or psTerm is null)
                   and G.SHRTCKG_SEQ_NO =
                          (SELECT MAX (G1.SHRTCKG_SEQ_NO)
                             FROM SHRTCKG G1
                            WHERE G1.SHRTCKG_PIDM = G.SHRTCKG_PIDM
                              AND G1.SHRTCKG_TERM_CODE = G.SHRTCKG_TERM_CODE
                              AND G1.SHRTCKG_TCKN_SEQ_NO = G.SHRTCKG_TCKN_SEQ_NO))		REPROBADAS_PERIODO,
            (SELECT COUNT(1) from
          	(SELECT SWVHIAC_PIDM, SWVHIAC_SUBJ||''||SWVHIAC_CRSE curso, MAX(SWVHIAC_QUALITY_POINTS) CALIFICACION
          	FROM SWVHIAC
         GROUP BY SWVHIAC_PIDM, SWVHIAC_SUBJ||''||SWVHIAC_CRSE)
         where CALIFICACION < 4.0
         AND SWVHIAC_PIDM = SGBSTDN_PIDM)		REPROBADAS_HA,
            (SELECT SHRTGPA_GPA PGPA FROM SHRTGPA WHERE (SHRTGPA_TERM_CODE = psTerm or psTerm is null) and SHRTGPA_PIDM = S.SGBSTDN_PIDM
            AND SHRTGPA_LEVL_CODE = S.SGBSTDN_LEVL_CODE)						PPERIODO,
            (SELECT ROUND(DECODE(SUM(SHRTGPA_QUALITY_POINTS), 0, 0,SUM(SHRTGPA_QUALITY_POINTS) / SUM(SHRTGPA_GPA_HOURS)),2) FROM SHRTGPA
            WHERE SHRTGPA_PIDM = SGBSTDN_PIDM)							PROMEDIO_ACUMULADO,
            (SELECT SORTEST_TEST_SCORE FROM SORTEST,SWBPRCT
            WHERE SORTEST_TESC_CODE = SWBPRCT_TESC_CODE_POND
            AND SORTEST_PIDM = SGBSTDN_PIDM
            AND SWBPRCT_PROGRAM = SGBSTDN_PROGRAM_1
            AND (SORTEST_TERM_CODE_ENTRY = psTerm or psTerm is null)
            AND ROWNUM = 1)										PUNTAJE_PONDERADO_UFT,
            (SELECT SORTEST_TEST_SCORE FROM SORTEST
            WHERE SORTEST_TESC_CODE = 'PPSU'
            AND SORTEST_PIDM = SGBSTDN_PIDM
            AND (SORTEST_TERM_CODE_ENTRY = psTerm or psTerm is null))				PONDERADO_PSU
     FROM  SPRIDEN,    SPBPERS,     SGBSTDN S,
                (SELECT TWBDOCU_PIDM PIDM, TWBDOCU_DOCU_NUM BECA, NVL(TBBEXPT_DESC, TWVCRET_DESC) DBECA, TWBDOCU_AMOUNT
                FROM TWBDOCU, TBBEXPT,  (SELECT TWBDOCU_PIDM PIDM, TWBDOCU_TERM_CODE PERIODO,TWVCRET_DESC FROM TWBDOCU, TWVCRET, TWRCRAL
                WHERE TWRCRAL_DOCU_SEQ_NUM = TWBDOCU_SEQ_NUM
                AND TWRCRAL_CRET_CODE = TWVCRET_CODE)CREDITOS
                WHERE twbdocu_paym_code IN ('BEC', 'BMI', 'CAE', 'BFP')
                AND (TWBDOCU_TERM_CODE = psTerm or psTerm is null)
                AND TWBDOCU_TERM_CODE = TBBEXPT_TERM_CODE(+)
                AND TWBDOCU_PIDM = CREDITOS.PIDM(+)
                AND TWBDOCU_TERM_CODE = CREDITOS.PERIODO(+)
                AND TWBDOCU_DOCU_NUM = TBBEXPT_EXEMPTION_CODE(+)) BECAS
WHERE  s.sgbstdn_pidm      = becas.pidm(+)
AND SPRIDEN_CHANGE_IND IS NULL
AND SPRIDEN_ID                =nvl(psExped,SPRIDEN_ID)
--AND S.SGBSTDN_PROGRAM_1=nvl(psCarre,S.SGBSTDN_PROGRAM_1)
AND SGBSTDN_COLL_CODE_1 = nvl(psEscu, SGBSTDN_COLL_CODE_1)
AND S.SGBSTDN_PIDM = SPRIDEN_PIDM
AND S.SGBSTDN_PIDM = SPBPERS_PIDM
AND S.SGBSTDN_TERM_CODE_EFF =
                                          (SELECT MAX (SS.SGBSTDN_TERM_CODE_EFF)
                                             FROM SGBSTDN SS
                                            WHERE s.SGBSTDN_PIDM = SS.SGBSTDN_PIDM);

---------------------------------------------------
-- bloque principal para la generacin del reporte
---------------------------------------------------
BEGIN

   -- valida que el usuario tenga acceso a la base de datos:
   IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

   -- obtiene los valores de las cookies para asignar los valores del filtro del query:
   vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
   vsEscu:= pk_ObjHtml.getValueCookie('psEscu');
   vsExped := pk_ObjHtml.getValueCookie('psExped');


   -- determina el largo de la tabla:
   FOR vnI IN 1..vnColumnas LOOP
       tabColumna.EXTEND(vnI);
       tabColumna(vnI) := NULL;
   END LOOP;

   -- define los encabezados de las columnas:
   tabColumna(1)  := '<left> RUT';
   tabColumna(2)  := '<left> ID';
   tabColumna(3)  := '<left> Apellidos';
   tabColumna(4)  := '<left> Nombre';
   tabColumna(5)  := '<left> Telfono';
   tabColumna(6)  := '<leftr> Correo Electrnico';
   tabColumna(7)  := '<left> Periodo Admisin';
--   tabColumna(8)  := '<left> Carrera';
   tabColumna(8)  := '<left> Escuela';
   tabColumna(9)  := '<left> Estado';
   tabColumna(10) := '<left> Tipo de Alumno';
   tabColumna(11) := '<left> Beca';
   tabcolumna(12) := '<left> Descuento Beca';
   --tabColumna(13) := '<left> Monto';
   tabColumna(13) := '<left> Reprobadas del Periodo';
   tabColumna(14) := '<left> Reprobadas Historia Acadmica';
   tabColumna(15) := '<left> Promedio del Periodo';
   tabColumna(16) := '<left> Promedio Acumulado';
   tabColumna(17) := '<left> Puntaje Ponderado UFT';
   tabColumna(18) := '<left> Ponderado PSU';


   -- manipula la informacin obtenida por el cursor:
   FOR regRep IN cuReporte (vsTerm,vsEscu,vsExped) LOOP

       IF vnExists = 0 THEN

          -- muestra el encabezado segn el periodo y programa seleccionados:
          IF vsEscu IS NOT NULL THEN
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)/*||'<br>'||'Escuela: &nbsp;'||vsEscu||' - '||Pk_Catalogo.Colegio(vsEscu)*/,
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
          ELSE
             Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1',
                                                psSubtitulo   => 'Periodo: &nbsp;'||vsTerm||' - '||Pk_Catalogo.PERIODO(vsTerm)||'<br>'||'Escuela: &nbsp;'||'Todos ',
                                                psUniversidad => 'UFT');
             vgsInicioPag := 'SALTO';
          END IF;

       END IF;

       -- muestra los valores para cada registro:
       HTP.P('<tr> <td valign="top" align="right">'   ||regRep.RUT             ||'</td>
                   <td valign="top" align="left">'    ||regRep.ID               ||'</td>
                   <td valign="top" align="left">'   ||regRep.APELLIDOS        ||'</td>
                   <td valign="top" align="left">'   ||regRep.NOMBRE           ||'</td>
                   <td valign="top" align="left">'   ||regRep.TEL_CONTACTO		||'</td>
                   <td valign="top" align="left">'   ||regRep.EMAIL		||'</td>
                   <td valign="top" align="right">'   ||regRep.PERIODO_ADMISION      ||'</td>

		           <td valign="top" align="right">'  ||regRep.ESCUELA ||'</td>
                   <td valign="top" align="right">' ||regRep.ESTADO        ||'</td>
                   <td valign="top" align="right">' ||regRep.TIPO_ALUMNO  ||'</td>
                   <td valign="top" align="right">' ||regRep.BECA      ||'</td>
                   <td valign="top" align="right">' ||regRep.DBECA  ||'</td>
                   <td valign="top" align="right">' ||regRep.REPROBADAS_PERIODO ||'</td>
		           <td valign="top" align="right">' ||regRep.REPROBADAS_HA ||'</td>
		           <td valign="top" align="right">' ||regRep.PPERIODO ||'</td>
		           <td valign="top" align="right">' ||regRep.PROMEDIO_ACUMULADO ||'</td>
		           <td valign="top" align="right">' ||regRep.PUNTAJE_PONDERADO_UFT ||'</td>
		            <td valign="top" align="right">' ||regRep.PONDERADO_PSU ||'</td>
             </tr>');

       vnExists    := 1;
       vnIdRenglon := vnIdRenglon + 1;
   -- END IF;
   END LOOP;

   -- muestra el pie de reporte:
   IF vnExists = 0 THEN
      htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
      -- bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

      -- omite el encabezado del reporte pero se agrega el salto de pgina:
      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
   END IF;

   htp.p('</table><br/></body></html>');

EXCEPTION
   WHEN OTHERS THEN
        htp.p(SQLERRM);

END PWRTIBE;
/


DROP PUBLIC SYNONYM PWRTIBE;

CREATE PUBLIC SYNONYM PWRTIBE FOR BANINST1.PWRTIBE;


GRANT EXECUTE ON BANINST1.PWRTIBE TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRTMAI;

CREATE OR REPLACE PROCEDURE BANINST1.PWRTMAI(psReclDesc VARCHAR2) IS
/*
           Tarea: REPORTE DE MATERIAS INSCRITAS POR ESCUELA
           Fecha: 19/07/2010.
           Autor: MAC


*/

ckNombres   owa_cookie.vc_arr;
ckValores   owa_cookie.vc_arr;
ckCount     INTEGER;
vgsInicoPag VARCHAR2(10) := NULL; -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
vgsUSR      VARCHAR2(500);

  vnExists   INTEGER                := 0;
  vnColumnas INTEGER                := 3;
  tabColumna Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vsPerio    VARCHAR2(100)          := NULL;
  vsFacu     VARCHAR2(100)          := NULL;

  vsTipo     VARCHAR2(10)           := NULL;
  vsUnive    VARCHAR2(10)           := NULL;
  vsSeccion  VARCHAR2(3)            := NULL;
  vsStatus   VARCHAR2(10)           := NULL;
  vsContrato VARCHAR2(10)           := NULL;
  vsDocente  VARCHAR2(10)           := NULL;
  vsTidoc    VARCHAR2(10)           := NULL;

  CURSOR cuReporte(psUnive VARCHAR2 DEFAULT NULL,
                   psTerm  VARCHAR2 DEFAULT NULL,
                   psFacu  VARCHAR2 DEFAULT NULL) IS

           SELECT  COUNT(DISTINCT(SFRSTCR_PIDM))     ALUMNOS_INSCRITOS,
               COUNT(DISTINCT(SGBSTDN_PIDM))     ALUMNOS_ACTIVOS,
               pk_catalogo.colegio(STVCOLL_CODE) ESCUELA
            FROM SGBSTDN S1,
            (SELECT SFRSTCR_PIDM, SFRSTCR_CRN, SFRSTCR_TERM_CODE FROM SFRSTCR
                WHERE SFRSTCR_RSTS_CODE IN ('RE','RW')) ALUMNOS,
            SMRPRLE,
            STVCOLL
           WHERE S1.SGBSTDN_PIDM = ALUMNOS.SFRSTCR_PIDM(+)
           AND S1.SGBSTDN_STST_CODE = 'AS'
           AND S1.SGBSTDN_TERM_CODE_EFF =
            (SELECT MAX(S2.SGBSTDN_TERM_CODE_EFF)
                    FROM SGBSTDN S2
                WHERE S2.SGBSTDN_PIDM = S1.SGBSTDN_PIDM)
           AND S1.SGBSTDN_PROGRAM_1 =    SMRPRLE_PROGRAM
           AND    SMRPRLE_COLL_CODE = STVCOLL_CODE
           AND (SMRPRLE_COLL_CODE = psFacu  OR psFacu IS NULL)
           AND (SFRSTCR_TERM_CODE = psTerm  OR psTerm IS NULL)
        GROUP BY STVCOLL_CODE;



  BEGIN
      /* Check/update the user's web session */
      IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;

      --son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
      owa_cookie.get_all(ckNombres,ckValores,ckCount);

      IF ckCount != 0 THEN
         FOR vnCOKIES IN 1..ckCount LOOP
             IF    ckNOMBRES(vnCOKIES) = 'psUnive' THEN
                   vsUnive := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psPerio' THEN
                   vsPerio := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psFacu' THEN
                   vsFacu := ckValores(vnCOKIES);


             ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
                   vsSeccion := ckValores(vnCOKIES);

             END IF;
         END LOOP;
      END IF;

      -- Las instrucciones determinan el largo de la tabla
      FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabColumna(vnI) := NULL;
      END LOOP;

      tabColumna(1)  := 'Escuela';
      tabColumna(2)  := 'Alumnos Activos';
      tabColumna(3)  := 'Total Inscritos';


      FOR regRep IN cuReporte(vsUnive, vsPerio, vsFacu) LOOP

          IF vnExists = 0 THEN
             Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,vgsInicoPag,'1', psUsuario=>vgsUSR, psSeccion=>vsSeccion, psSinLogo=>'sin');
             vgsInicoPag := 'SALTO';

          END IF;

          htp.p('<tr>
          <td valign="top">'||regRep.ESCUELA||'</td>
          <td valign="top">'||regRep.ALUMNOS_ACTIVOS||'</td>
          <td valign="top">'||regRep.ALUMNOS_INSCRITOS||'</td>
          </tr>');

          vnExists := 1;
      END LOOP;

--      -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
--      Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

--      -- es omitido el encabezado del reporte pero se agrega el salto de pagina
--      Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>vgsUSR, psSeccion=>vsSeccion);



      htp.p('</table><br/></body></html>');
EXCEPTION
WHEN OTHERS THEN htp.p( SQLERRM);

END PWRTMAI;
/


DROP PUBLIC SYNONYM PWRTMAI;

CREATE PUBLIC SYNONYM PWRTMAI FOR BANINST1.PWRTMAI;


GRANT EXECUTE ON BANINST1.PWRTMAI TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRTMAI TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRTPSU;

CREATE OR REPLACE PROCEDURE BANINST1.PWRTPSU (psReclDesc   VARCHAR2)  IS

/**************************************************************
           tarea:  procedimiento que genera el reporte de tramos psu
          mdulo:  admisiones
           autor:  horacio martnez ramrez - hmr
           fecha:  23/feb/2011
**************************************************************/

  vnExists       INTEGER  := 0;
  vnColumnas     INTEGER  := 18;
  vgsInicioPag   VARCHAR2(30)  := NULL;           -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin
  tabColumna     Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla(1);
  vnIdRenglon    INTEGER  := 1;
  vsTerm         SARAPPD.SARAPPD_TERM_CODE_ENTRY%TYPE DEFAULT NULL;
  vsProgr        SARADAP.SARADAP_PROGRAM_1%TYPE DEFAULT NULL;
  vsCarreraAnt   SARADAP.SARADAP_PROGRAM_1%TYPE DEFAULT NULL;

  vnSum1     NUMBER := 0;
  vnSum450   NUMBER := 0;
  vnSum475   NUMBER := 0;
  vnSum500   NUMBER := 0;
  vnSum525   NUMBER := 0;
  vnSum550   NUMBER := 0;
  vnSum575   NUMBER := 0;
  vnSum600   NUMBER := 0;
  vnSum625   NUMBER := 0;
  vnSum650   NUMBER := 0;
  vnSum675   NUMBER := 0;
  vnSum700   NUMBER := 0;
  vnSum725   NUMBER := 0;
  vnSum750   NUMBER := 0;
  vnSum775   NUMBER := 0;
  vnSum800   NUMBER := 0;
  vnTotal    NUMBER := 0;


  CURSOR cuReporte ( psTerm    VARCHAR2  DEFAULT NULL,
                     psProgr   VARCHAR2  DEFAULT NULL)  IS

     SELECT DISTINCT(S.SORLCUR_PIDM)                                     PIDM,
            S.SORLCUR_TERM_CODE                                          PERIODO,
            S.SORLCUR_PROGRAM                                            CARRERA,
            TO_NUMBER(REPLACE(T.SORTEST_TEST_SCORE, ',', '.'),'9999.9')  PUNTAJE
       FROM SORLCUR S, SORTEST T
      WHERE S.SORLCUR_PIDM = T.SORTEST_PIDM
        AND S.SORLCUR_TERM_CODE = psTerm
        AND S.SORLCUR_TERM_CODE = S.SORLCUR_TERM_CODE_ADMIT
        AND T.SORTEST_TESC_CODE = 'PPSU'
        AND S.SORLCUR_ADMT_CODE = 'AD'
        AND S.SORLCUR_CACT_CODE = 'ACTIVE'
        AND (S.SORLCUR_PROGRAM = psProgr or psProgr is null)
      ORDER BY S.SORLCUR_PROGRAM, S.SORLCUR_PIDM;

  BEGIN

     -- valida que el usuario pertenezca a la base de datos:
     IF Pk_Login.F_ValidacionDeAcceso(pk_login.vgsUSR) THEN RETURN; END IF;

     -- son buscados los valores de las cookies para asignar los valores del filtro del query:
     vsTerm  := pk_ObjHtml.getValueCookie('psTerm');
     vsProgr := pk_ObjHtml.getValueCookie('psProgr');

     -- se determina el largo de la tabla:
     FOR vnI IN 1..vnColumnas LOOP
         tabColumna.EXTEND(vnI);
         tabColumna(vnI) := NULL;
     END LOOP;

     tabColumna(1)  := '<center> Carrera';
     tabColumna(2)  := '<center> Puntaje <br> de 1 a 449,5';
     tabColumna(3)  := '<center> Puntaje <br> de 450 a 474,5';
     tabColumna(4)  := '<center> Puntaje <br> de 475 a 499,5';
     tabColumna(5)  := '<center> Puntaje <br> de 500 a 524,5';
     tabColumna(6)  := '<center> Puntaje <br> de 525 a 549,5';
     tabColumna(7)  := '<center> Puntaje <br> de 550 a 574,5';
     tabColumna(8)  := '<center> Puntaje <br> de 575 a 599,5';
     tabColumna(9)  := '<center> Puntaje <br> de 600 a 624,5';
     tabColumna(10) := '<center> Puntaje <br> de 625 a 649,5';
     tabColumna(11) := '<center> Puntaje <br> de 650 a 674,5';
     tabColumna(12) := '<center> Puntaje <br> de 675 a 699,5';
     tabColumna(13) := '<center> Puntaje <br> de 700 a 724,5';
     tabColumna(14) := '<center> Puntaje <br> de 725 a 749,5';
     tabColumna(15) := '<center> Puntaje <br> de 750 a 774,5';
     tabColumna(16) := '<center> Puntaje <br> de 775 a 799,5';
     tabColumna(17) := '<center> Puntaje <br> de 800 a 850';
     tabColumna(18) := '<center> Total';


     FOR regRep IN cuReporte (vsTerm, vsProgr) LOOP

         IF vnExists = 0 THEN
            Pk_Sisrepimp.p_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, vgsInicioPag, '1', psSubtitulo=>'Periodo: '||vsTerm||'  '||Pk_Catalogo.PERIODO(vsTerm), psUniversidad=>'UFT');
            vgsInicioPag := 'SALTO';

            vsCarreraAnt := regRep.CARRERA;

         END IF;

         IF (vsCarreraAnt = regRep.CARRERA) THEN

            -- selecciona el rango a incrementar:
            IF regRep.Puntaje >= 1 AND regRep.Puntaje <= 449.5 THEN
               vnSum1 := vnSum1 + 1;
            ELSIF regRep.Puntaje >= 450 AND regRep.Puntaje <= 474.5 THEN
               vnSum450 := vnSum450 + 1;
            ELSIF regRep.Puntaje >= 475 AND regRep.Puntaje <= 499.5 THEN
               vnSum475 := vnSum475 + 1;
            ELSIF regRep.Puntaje >= 500 AND regRep.Puntaje <= 524.5 THEN
               vnSum500 := vnSum500 + 1;
            ELSIF regRep.Puntaje >= 525 AND regRep.Puntaje <= 549.5 THEN
               vnSum525 := vnSum525 + 1;
            ELSIF regRep.Puntaje >= 550 AND regRep.Puntaje <= 574.5 THEN
               vnSum550 := vnSum550 + 1;
            ELSIF regRep.Puntaje >= 575 AND regRep.Puntaje <= 599.5 THEN
               vnSum575 := vnSum575 + 1;
            ELSIF regRep.Puntaje >= 600 AND regRep.Puntaje <= 624.5 THEN
               vnSum600 := vnSum600 + 1;
            ELSIF regRep.Puntaje >= 625 AND regRep.Puntaje <= 649.5 THEN
               vnSum625 := vnSum625 + 1;
            ELSIF regRep.Puntaje >= 650 AND regRep.Puntaje <= 674.5 THEN
               vnSum650 := vnSum650 + 1;
            ELSIF regRep.Puntaje >= 675 AND regRep.Puntaje <= 699.5 THEN
               vnSum675 := vnSum675 + 1;
            ELSIF regRep.Puntaje >= 700 AND regRep.Puntaje <= 724.5 THEN
               vnSum700 := vnSum700 + 1;
            ELSIF regRep.Puntaje >= 725 AND regRep.Puntaje <= 749.5 THEN
               vnSum725 := vnSum725 + 1;
            ELSIF regRep.Puntaje >= 750 AND regRep.Puntaje <= 774.5 THEN
               vnSum750 := vnSum750 + 1;
            ELSIF regRep.Puntaje >= 775 AND regRep.Puntaje <= 799.5 THEN
               vnSum775 := vnSum775 + 1;
            ELSIF regRep.Puntaje >= 800 AND regRep.Puntaje <= 850 THEN
               vnSum800 := vnSum800 + 1;
            END IF;

         ELSE
            vnTotal := vnSum1   + vnSum450 + vnSum475 + vnSum500 + vnSum525 + vnSum550 + vnSum575 + vnSum600 +
                       vnSum625 + vnSum650 + vnSum675 + vnSum700 + vnSum725 + vnSum750 + vnSum775 + vnSum800;

            HTP.P('<tr> <td valign="top" align="left">'   ||vsCarreraAnt ||'</td>
                        <td valign="top" align="center">' ||vnSum1       ||'</td>
                        <td valign="top" align="center">' ||vnSum450     ||'</td>
                        <td valign="top" align="center">' ||vnSum475     ||'</td>
                        <td valign="top" align="center">' ||vnSum500     ||'</td>
                        <td valign="top" align="center">' ||vnSum525     ||'</td>
                        <td valign="top" align="center">' ||vnSum550     ||'</td>
                        <td valign="top" align="center">' ||vnSum575     ||'</td>
                        <td valign="top" align="center">' ||vnSum600     ||'</td>
                        <td valign="top" align="center">' ||vnSum625     ||'</td>
                        <td valign="top" align="center">' ||vnSum650     ||'</td>
                        <td valign="top" align="center">' ||vnSum675     ||'</td>
                        <td valign="top" align="center">' ||vnSum700     ||'</td>
                        <td valign="top" align="center">' ||vnSum725     ||'</td>
                        <td valign="top" align="center">' ||vnSum750     ||'</td>
                        <td valign="top" align="center">' ||vnSum775     ||'</td>
                        <td valign="top" align="center">' ||vnSum800     ||'</td>
                        <td valign="top" align="center">' ||vnTotal      ||'</td>
                        </tr>');

            -- vaciado de variables:
            vnSum1     := 0;
            vnSum450   := 0;
            vnSum475   := 0;
            vnSum500   := 0;
            vnSum525   := 0;
            vnSum550   := 0;
            vnSum575   := 0;
            vnSum600   := 0;
            vnSum625   := 0;
            vnSum650   := 0;
            vnSum675   := 0;
            vnSum700   := 0;
            vnSum725   := 0;
            vnSum750   := 0;
            vnSum775   := 0;
            vnSum800   := 0;
            vnTotal    := 0;

            vsCarreraAnt := regRep.CARRERA;

            -- selecciona el rango a incrementar:
            IF regRep.Puntaje >= 1 AND regRep.Puntaje <= 449.5 THEN
               vnSum1 := vnSum1 + 1;
            ELSIF regRep.Puntaje >= 450 AND regRep.Puntaje <= 474.5 THEN
               vnSum450 := vnSum450 + 1;
            ELSIF regRep.Puntaje >= 475 AND regRep.Puntaje <= 499.5 THEN
               vnSum475 := vnSum475 + 1;
            ELSIF regRep.Puntaje >= 500 AND regRep.Puntaje <= 524.5 THEN
               vnSum500 := vnSum500 + 1;
            ELSIF regRep.Puntaje >= 525 AND regRep.Puntaje <= 549.5 THEN
               vnSum525 := vnSum525 + 1;
            ELSIF regRep.Puntaje >= 550 AND regRep.Puntaje <= 574.5 THEN
               vnSum550 := vnSum550 + 1;
            ELSIF regRep.Puntaje >= 575 AND regRep.Puntaje <= 599.5 THEN
               vnSum575 := vnSum575 + 1;
            ELSIF regRep.Puntaje >= 600 AND regRep.Puntaje <= 624.5 THEN
               vnSum600 := vnSum600 + 1;
            ELSIF regRep.Puntaje >= 625 AND regRep.Puntaje <= 649.5 THEN
               vnSum625 := vnSum625 + 1;
            ELSIF regRep.Puntaje >= 650 AND regRep.Puntaje <= 674.5 THEN
               vnSum650 := vnSum650 + 1;
            ELSIF regRep.Puntaje >= 675 AND regRep.Puntaje <= 699.5 THEN
               vnSum675 := vnSum675 + 1;
            ELSIF regRep.Puntaje >= 700 AND regRep.Puntaje <= 724.5 THEN
               vnSum700 := vnSum700 + 1;
            ELSIF regRep.Puntaje >= 725 AND regRep.Puntaje <= 749.5 THEN
               vnSum725 := vnSum725 + 1;
            ELSIF regRep.Puntaje >= 750 AND regRep.Puntaje <= 774.5 THEN
               vnSum750 := vnSum750 + 1;
            ELSIF regRep.Puntaje >= 775 AND regRep.Puntaje <= 799.5 THEN
               vnSum775 := vnSum775 + 1;
            ELSIF regRep.Puntaje >= 800 AND regRep.Puntaje <= 850 THEN
               vnSum800 := vnSum800 + 1;
            END IF;

         END IF;

         vnExists    := 1;
         vnIdRenglon := vnIdRenglon + 1;

     END LOOP;

     IF vnExists >= 1 THEN
        vnTotal := vnSum1   + vnSum450 + vnSum475 + vnSum500 + vnSum525 + vnSum550 + vnSum575 + vnSum600 +
                   vnSum625 + vnSum650 + vnSum675 + vnSum700 + vnSum725 + vnSum750 + vnSum775 + vnSum800;

        HTP.P('<tr> <td valign="top" align="left">'   ||vsCarreraAnt ||'</td>
                    <td valign="top" align="center">' ||vnSum1       ||'</td>
                    <td valign="top" align="center">' ||vnSum450     ||'</td>
                    <td valign="top" align="center">' ||vnSum475     ||'</td>
                    <td valign="top" align="center">' ||vnSum500     ||'</td>
                    <td valign="top" align="center">' ||vnSum525     ||'</td>
                    <td valign="top" align="center">' ||vnSum550     ||'</td>
                    <td valign="top" align="center">' ||vnSum575     ||'</td>
                    <td valign="top" align="center">' ||vnSum600     ||'</td>
                    <td valign="top" align="center">' ||vnSum625     ||'</td>
                    <td valign="top" align="center">' ||vnSum650     ||'</td>
                    <td valign="top" align="center">' ||vnSum675     ||'</td>
                    <td valign="top" align="center">' ||vnSum700     ||'</td>
                    <td valign="top" align="center">' ||vnSum725     ||'</td>
                    <td valign="top" align="center">' ||vnSum750     ||'</td>
                    <td valign="top" align="center">' ||vnSum775     ||'</td>
                    <td valign="top" align="center">' ||vnSum800     ||'</td>
                    <td valign="top" align="center">' ||vnTotal      ||'</td>
              </tr>');
     END IF;

     IF vnExists = 0 THEN
        htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
     ELSE
        -- la variable es una bandera que al tener el valor "imprime" no colocar el salto de pgina para impresin:
        Pk_Sisrepimp.vgsSaltoImp := 'Imprime';

        -- es omitido el encabezado del reporte pero se agrega el salto de pgina:
        Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas, tabColumna, 'PIE', '0', psUsuario=>pk_login.vgsUSR );
     END IF;

     htp.p('</table><br/></body></html>');

  EXCEPTION
     WHEN OTHERS THEN
          htp.p(SQLERRM);

  END PWRTPSU;
/


DROP PUBLIC SYNONYM PWRTPSU;

CREATE PUBLIC SYNONYM PWRTPSU FOR BANINST1.PWRTPSU;


GRANT EXECUTE ON BANINST1.PWRTPSU TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRTPSU TO WWW2_USER;
DROP PROCEDURE BANINST1.PWRUSCL;

CREATE OR REPLACE PROCEDURE BANINST1.PWRUSCL(psReclDesc VARCHAR2) IS
vnRow        INTEGER                          := 0;
vnExists     INTEGER                          := 0;
vnColumnas   INTEGER                          := 6;
vnSaltoPag   INTEGER                          := 30; --la variables utilizada para determinar la cantidad de registros que tiene una tabla para dar un salto de pagina
tabColumna   Pk_Sisrepimp.tipoTabla          := Pk_Sisrepimp.tipoTabla(1);
tabSubColu   Pk_Sisrepimp.tipoTabla          := Pk_Sisrepimp.tipoTabla(1);
vsDescripcion VARCHAR2(200)                   := NULL;
vsTipo        VARCHAR2(3)                     := NULL;  --objeto/usuario
vsObjeto      VARCHAR2(50)                    := NULL;
vsClase       VARCHAR2(50)                    := NULL;
vsSeccion     VARCHAR2(3)                     := NULL;

CURSOR cObjetos (psObjeto VARCHAR2 DEFAULT NULL,
psClase  VARCHAR2 DEFAULT NULL) IS

select  GURUCLS_USERID Usuario,
GURIDEN_DESC   Nombre,
        guruobj_object Objeto,
        GUBOBJS_DESC   Descripcion,
        gurucls_class_code Clase,
        guruobj_role     Rol
from bansecr.guruobj a, bansecr.gurucls
,gubobjs s,  guriden g
where gurucls_class_code = guruobj_userid
and s.GUBOBJS_NAME = guruobj_object
     and g.GURIDEN_USER_ID = GURUCLS_USERID
     and (guruobj_object    = psObjeto OR psObjeto IS NULL)
     and (gurucls_class_code =    psClase OR psClase IS NULL)
     order by gurucls_class_code;

/*    select v.twvusuo_userid usuario,
           g.guriden_desc    nombre,
           v.twvusuo_object    objeto,
           s.gubobjs_desc    descripcion,
           v.twvusuo_class    clase,
           v.twvusuo_role     rol
from twvusuo v,
gubobjs s,
       guriden g
where (v.twvusuo_object   = psobjeto or psobjeto is null)
and (v.twvusuo_class    = psclase)
and v.twvusuo_object    = s.gubobjs_name(+)
and v.twvusuo_userid    = g.guriden_user_id(+)
order by v.twvusuo_class;*/

  vgsUSR       VARCHAR2(500);
  ckCount      INTEGER;
  ckNombres    owa_cookie.vc_arr;
  ckValores    owa_cookie.vc_arr;
  vgsUsuario   VARCHAR2(300) := NULL;
  vgsInicoPag  VARCHAR2(10)  := NULL;       -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pagina para impresion

BEGIN
/* check/update the user's web session */
IF Pk_Login.F_ValidacionDeAcceso(vgsUSR) THEN RETURN; END IF;
--son buscadas los valores de las cookies para asignar los valores del filtro del query.
      ckCount := 0;
owa_cookie.get_all(ckNombres,ckValores,ckCount);
IF ckCount != 0 THEN
     FOR vnCOKIES IN 1..ckCount LOOP

             IF    ckNOMBRES(vnCOKIES) = 'psObj' THEN
           vsObjeto   := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'psClas' THEN
           vsClase   := ckValores(vnCOKIES);

     ELSIF ckNOMBRES(vnCOKIES) = 'cookUsuario' THEN
vgsUsuario := ckValores(vnCOKIES);

             ELSIF ckNOMBRES(vnCOKIES) = 'cookSeccion' THEN
           vsSeccion := ckValores(vnCOKIES);

END IF;

END LOOP;
END IF;
-- las instrucciones determinan el largo de la tabla
FOR vnI IN 1..vnColumnas LOOP
          tabColumna.EXTEND(vnI);
          tabSubColu.EXTEND(vnI);
          tabColumna(vnI) := NULL;
          tabSubColu(vnI) := NULL;
      END LOOP;

tabSubColu(1)  := 'Clase ';
      tabSubColu(2)  := 'Objeto';
      tabSubColu(3)  := 'Descripcion';
tabSubColu(4)  := 'Usuario ';
      tabSubColu(5)  := 'Nombre';
      tabSubColu(6)  := 'Role';

FOR regRep IN cObjetos(vsObjeto, vsClase) LOOP
    IF (vsClase IS NULL OR vsClase <> regRep.Clase   OR
        vnRow = 0 OR vnRow = 30) THEN
Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vgsInicoPag,'1','#000000',psUsuario=>vgsUSR,psSeccion=>vsSeccion);
vgsInicoPag := 'SALTO';
        vnRow := 0;
        -- el procedimiento muestra sub titulos del reporte
        --p_Columnas(vnColumnas,tabSubColu);
        IF tabSubColu IS NOT NULL THEN
                Pk_Sisrepimp.vgsColor := tabSubColu(1);
              END IF;

              htp.p('<tr bgcolor="'||Pk_Sisrepimp.vgsColor||'">');
              FOR vnI IN 1..vnColumnas LOOP
                htp.p('<th class="h3" align="left" valign="bottom" bgcolor="#b1c9e1">'||tabSubColu(vnI)||'</th>');  --"#ffcc99"
              END LOOP;
        htp.p('</tr>');
      END IF;
-- imprime los registros
htp.p('<tr><td valign="top">'||regRep.Clase||'</td>
<td valign="top">'||regRep.Objeto||'</td>
                    <td valign="top">'||regRep.Descripcion||'</td>
                    <td valign="top">'||regRep.Usuario||'</td>
                    <td valign="top">'||regRep.Nombre||'</td>
                    <td valign="top">'||regRep.Rol||'</td>');
vnExists := 1;
        vnRow    := vnRow + 1;
        vsClase := regRep.clase;
END LOOP;
      -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pagina para impresion
         Pk_Sisrepimp.vgsSaltoImp := 'Imprime';
vgsInicoPag:= 'PIE';
-- es omitido el encabezado del reporte pero se agrega el salto de pagina
Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vgsInicoPag,'0', psUsuario=>vgsUSR, psSeccion=>vsSeccion);
      IF vnExists = 0 THEN
         htp.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
      END IF;
      htp.p('</table></body></html>');
EXCEPTION
WHEN OTHERS THEN
           HTP.P(SQLERRM);
END PWRUSCL;
/


DROP PUBLIC SYNONYM PWRUSCL;

CREATE PUBLIC SYNONYM PWRUSCL FOR BANINST1.PWRUSCL;


GRANT EXECUTE ON BANINST1.PWRUSCL TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWRUSCL TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWRUSCL TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWRUSCL TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWRUSCL TO WWW2_USER;
DROP PROCEDURE BANINST1.PWSEQNU;

CREATE OR REPLACE PROCEDURE BANINST1.PWSEQNU (psReclDesc VARCHAR2)
IS
/******************************************************************************
PROCEDIMIENTO:          BANINST1.PWSEQNU
OBJETIVO:               Reporte de Nmeros de Secuencia no Utilizados en
                        Reprogramaciones, Tesorera y Congelaciones
AUTORES:                Guillermo Almazan Ibaez
FECHA:                  22/05/2012
******************************************************************************/

vnRow           INTEGER := 0;
vnExists        INTEGER := 0;
vnColumnas      INTEGER := 3;
tabColumna      Pk_Sisrepimp.tipoTabla := Pk_Sisrepimp.tipoTabla (1);
vsInicioPag     VARCHAR2 (10) := NULL;
vnLim           number;
vnConta         number := 1;
vnRepro         number;
vnLimRepro      number;
vnContaRepro    number := 1;
vnImprimeRepro  number;
vnTeso          number;
vnLimTeso       number;
vnContaTeso     number := 1;
vnImprimeTeso   number;
vnCong          number;
vnLimCong       number;
vnContaCong     number := 1;
vnImprimeCong   number;
BEGIN

   IF Pk_Login.F_ValidacionDeAcceso (pk_login.vgsUSR) THEN
	  RETURN;
   END IF;
  -- Nmero de columnas de la tabla --
   FOR vnI IN 1 .. vnColumnas
   LOOP
	  tabColumna.EXTEND (vnI);
      tabColumna (vnI) := NULL;
   END LOOP;
   /* Encabezado de las columnas */
   tabColumna (1) := 'Reprogramaciones';
   tabColumna (2) := 'Tesorera';
   tabColumna (3) := 'Congelaciones';
    select nvl(max(TWBRPRG_NUM),0)
    into vnLimRepro
    from twbrprg;
    
    vnLim := vnLimRepro;
    
    select nvl(max(TWBTESO_NUM),0)
    into vnLimTeso
    from twbteso;
    if vnLimTeso > vnLim then
        vnLim := vnLimTeso;
    end if;
    
    select nvl(max(TWBCONG_NUM),0)
    into vnLimCong
    from twbcong;
    
    if vnLimCong > vnLim then
        vnLim := vnLimCong;
    end if;
	  while vnConta <= vnLim LOOP
		  IF vnRow = 0 THEN
			 Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc,vnColumnas,tabColumna,vsInicioPag);
			 vsInicioPag := 'SALTO';
             vnRow  := 0;
		  END IF;
          /*Reprogramaciones*******************************************Inicio*/
          while (vnContaRepro <= vnLimRepro) loop
            select count(*)
            into vnRepro
            from TWBRPRG
            where TWBRPRG_NUM = vnContaRepro;
            if vnRepro = 0 then
                vnImprimeRepro := vnContaRepro;
                vnContaRepro := vnContaRepro + 1;
                goto tesoreria;
            end if;
            vnContaRepro := vnContaRepro + 1;
          end loop;
		  /*Reprogramaciones**********************************************Fin*/

          /*Tesorera**************************************************Inicio*/
          <<tesoreria>>
          while (vnContaTeso <= vnLimTeso) loop
            select count(*)
            into vnTeso
            from TWBTESO
            where TWBTESO_NUM = vnContaTeso;
            if vnTeso = 0 then
                vnImprimeTeso := vnContaTeso;
                vnContaTeso := vnContaTeso + 1;
                goto congelacion;
            end if;
            vnContaTeso := vnContaTeso + 1;
          end loop;
          /*Tesorera*****************************************************Fin*/

          /*Congelaciones**********************************************Inicio*/
          <<congelacion>>
          while (vnContaCong <= vnLimCong) loop
            select count(*)
            into vnCong
            from TWBCONG
            where TWBCONG_NUM = vnContaCong;
            if vnCong = 0 then
                vnImprimeCong := vnContaCong;
                vnContaCong := vnContaCong + 1;
                exit;
            end if;
            vnContaCong := vnContaCong + 1;
          end loop;
          /*Congelaciones*************************************************Fin*/
          
          if (vnImprimeRepro is not null) or (vnImprimeTeso is not null) or (vnImprimeCong is not null) then
            htp.p(
                    '<tr><td valign="top">'||vnImprimeRepro||'</td>
                         <td valign="top">'||vnImprimeTeso||'</td>
                         <td valign="top">'||vnImprimeCong||'</td>');
            vnImprimeRepro := null;
            vnImprimeTeso := null;
            vnImprimeCong := null;
          end if;
          vnExists := 1;
          vnRow := vnRow + 1;
          vnConta := vnConta + 1;
	  END LOOP;
   IF vnExists = 0
   THEN
	  HTP.p('<tr><th colspan="'||vnColumnas||'"><font color="#ff0000">'||Pk_Sisrepimp.vgsResultado||'</font></th></tr>');
   ELSE
	  -- la variable es una bandera que al tener el valor "imprime" no colocara el salto de pgina para impresion
	  Pk_Sisrepimp.vgsSaltoImp := 'Imprime';
	  -- es omitido el encabezado del reporte pero se agrega el salto de pagina
	  Pk_Sisrepimp.P_EncabezadoDeReporte(psReclDesc, vnColumnas,tabColumna,'PIE','0', psUsuario=>pk_login.vgsUSR);
   END IF;
   HTP.p ('</table><br/></body></html>');
EXCEPTION
   WHEN OTHERS
   THEN HTP.P (SQLERRM);
END PWSEQNU;
/


DROP PUBLIC SYNONYM PWSEQNU;

CREATE PUBLIC SYNONYM PWSEQNU FOR BANINST1.PWSEQNU;


GRANT EXECUTE ON BANINST1.PWSEQNU TO BAN_DEFAULT_M;

GRANT EXECUTE ON BANINST1.PWSEQNU TO BAN_DEFAULT_Q;

GRANT EXECUTE ON BANINST1.PWSEQNU TO BAN_DEFAULT_WEBPRIVS;

GRANT EXECUTE ON BANINST1.PWSEQNU TO WWW_USER;

GRANT EXECUTE ON BANINST1.PWSEQNU TO WWW2_USER;
